(function(B){typeof define=="function"&&define.amd?define(B):B()})((function(){"use strict";function _mergeNamespaces$2(B,$){return $.forEach(function(U){U&&typeof U!="string"&&!Array.isArray(U)&&Object.keys(U).forEach(function(F){if(F!=="default"&&!(F in B)){var V=Object.getOwnPropertyDescriptor(U,F);Object.defineProperty(B,F,V.get?V:{enumerable:!0,get:function(){return U[F]}})}})}),Object.freeze(B)}var e$2=Object.defineProperty,h$2=(B,$,U)=>$ in B?e$2(B,$,{enumerable:!0,configurable:!0,writable:!0,value:U}):B[$]=U,o$2=(B,$,U)=>h$2(B,typeof $!="symbol"?$+"":$,U);let _$2=class{constructor(){o$2(this,"_locking"),o$2(this,"_locks"),this._locking=Promise.resolve(),this._locks=0}isLocked(){return this._locks>0}lock(){this._locks+=1;let $;const U=new Promise(V=>$=()=>{this._locks-=1,V()}),F=this._locking.then(()=>$);return this._locking=this._locking.then(()=>U),F}};function assert$1(B,$){if(!B)throw new Error($)}const FLOAT32_MAX$1=34028234663852886e22,FLOAT32_MIN$1=-34028234663852886e22,UINT32_MAX$1=4294967295,INT32_MAX$1=2147483647,INT32_MIN$1=-2147483648;function assertInt32$1(B){if(typeof B!="number")throw new Error("invalid int 32: "+typeof B);if(!Number.isInteger(B)||B>INT32_MAX$1||B<INT32_MIN$1)throw new Error("invalid int 32: "+B)}function assertUInt32$1(B){if(typeof B!="number")throw new Error("invalid uint 32: "+typeof B);if(!Number.isInteger(B)||B>UINT32_MAX$1||B<0)throw new Error("invalid uint 32: "+B)}function assertFloat32$1(B){if(typeof B!="number")throw new Error("invalid float 32: "+typeof B);if(Number.isFinite(B)&&(B>FLOAT32_MAX$1||B<FLOAT32_MIN$1))throw new Error("invalid float 32: "+B)}const enumTypeSymbol$1=Symbol("@bufbuild/protobuf/enum-type");function getEnumType$1(B){const $=B[enumTypeSymbol$1];return assert$1($,"missing enum type on enum object"),$}function setEnumType$1(B,$,U,F){B[enumTypeSymbol$1]=makeEnumType$1($,U.map(V=>({no:V.no,name:V.name,localName:B[V.no]})))}function makeEnumType$1(B,$,U){const F=Object.create(null),V=Object.create(null),q=[];for(const j of $){const W=normalizeEnumValue$1(j);q.push(W),F[j.name]=W,V[j.no]=W}return{typeName:B,values:q,findName(j){return F[j]},findNumber(j){return V[j]}}}function makeEnum$1(B,$,U){const F={};for(const V of $){const q=normalizeEnumValue$1(V);F[q.localName]=q.no,F[q.no]=q.localName}return setEnumType$1(F,B,$),F}function normalizeEnumValue$1(B){return"localName"in B?B:Object.assign(Object.assign({},B),{localName:B.name})}let Message$1=class{equals($){return this.getType().runtime.util.equals(this.getType(),this,$)}clone(){return this.getType().runtime.util.clone(this)}fromBinary($,U){const F=this.getType(),V=F.runtime.bin,q=V.makeReadOptions(U);return V.readMessage(this,q.readerFactory($),$.byteLength,q),this}fromJson($,U){const F=this.getType(),V=F.runtime.json,q=V.makeReadOptions(U);return V.readMessage(F,$,q,this),this}fromJsonString($,U){let F;try{F=JSON.parse($)}catch(V){throw new Error("cannot decode ".concat(this.getType().typeName," from JSON: ").concat(V instanceof Error?V.message:String(V)))}return this.fromJson(F,U)}toBinary($){const U=this.getType(),F=U.runtime.bin,V=F.makeWriteOptions($),q=V.writerFactory();return F.writeMessage(this,q,V),q.finish()}toJson($){const U=this.getType(),F=U.runtime.json,V=F.makeWriteOptions($);return F.writeMessage(this,V)}toJsonString($){var U;const F=this.toJson($);return JSON.stringify(F,null,(U=$?.prettySpaces)!==null&&U!==void 0?U:0)}toJSON(){return this.toJson({emitDefaultValues:!0})}getType(){return Object.getPrototypeOf(this).constructor}};function makeMessageType$1(B,$,U,F){var V;const q=(V=F?.localName)!==null&&V!==void 0?V:$.substring($.lastIndexOf(".")+1),j={[q]:function(W){B.util.initFields(this),B.util.initPartial(W,this)}}[q];return Object.setPrototypeOf(j.prototype,new Message$1),Object.assign(j,{runtime:B,typeName:$,fields:B.util.newFieldList(U),fromBinary(W,K){return new j().fromBinary(W,K)},fromJson(W,K){return new j().fromJson(W,K)},fromJsonString(W,K){return new j().fromJsonString(W,K)},equals(W,K){return B.util.equals(j,W,K)}}),j}function varint64read$1(){let B=0,$=0;for(let F=0;F<28;F+=7){let V=this.buf[this.pos++];if(B|=(V&127)<<F,(V&128)==0)return this.assertBounds(),[B,$]}let U=this.buf[this.pos++];if(B|=(U&15)<<28,$=(U&112)>>4,(U&128)==0)return this.assertBounds(),[B,$];for(let F=3;F<=31;F+=7){let V=this.buf[this.pos++];if($|=(V&127)<<F,(V&128)==0)return this.assertBounds(),[B,$]}throw new Error("invalid varint")}function varint64write$1(B,$,U){for(let q=0;q<28;q=q+7){const j=B>>>q,W=!(!(j>>>7)&&$==0),K=(W?j|128:j)&255;if(U.push(K),!W)return}const F=B>>>28&15|($&7)<<4,V=$>>3!=0;if(U.push((V?F|128:F)&255),!!V){for(let q=3;q<31;q=q+7){const j=$>>>q,W=!!(j>>>7),K=(W?j|128:j)&255;if(U.push(K),!W)return}U.push($>>>31&1)}}const TWO_PWR_32_DBL$1=4294967296;function int64FromString$1(B){const $=B[0]==="-";$&&(B=B.slice(1));const U=1e6;let F=0,V=0;function q(j,W){const K=Number(B.slice(j,W));V*=U,F=F*U+K,F>=TWO_PWR_32_DBL$1&&(V=V+(F/TWO_PWR_32_DBL$1|0),F=F%TWO_PWR_32_DBL$1)}return q(-24,-18),q(-18,-12),q(-12,-6),q(-6),$?negate$1(F,V):newBits$1(F,V)}function int64ToString$1(B,$){let U=newBits$1(B,$);const F=U.hi&2147483648;F&&(U=negate$1(U.lo,U.hi));const V=uInt64ToString$1(U.lo,U.hi);return F?"-"+V:V}function uInt64ToString$1(B,$){if({lo:B,hi:$}=toUnsigned$1(B,$),$<=2097151)return String(TWO_PWR_32_DBL$1*$+B);const U=B&16777215,F=(B>>>24|$<<8)&16777215,V=$>>16&65535;let q=U+F*6777216+V*6710656,j=F+V*8147497,W=V*2;const K=1e7;return q>=K&&(j+=Math.floor(q/K),q%=K),j>=K&&(W+=Math.floor(j/K),j%=K),W.toString()+decimalFrom1e7WithLeadingZeros$1(j)+decimalFrom1e7WithLeadingZeros$1(q)}function toUnsigned$1(B,$){return{lo:B>>>0,hi:$>>>0}}function newBits$1(B,$){return{lo:B|0,hi:$|0}}function negate$1(B,$){return $=~$,B?B=~B+1:$+=1,newBits$1(B,$)}const decimalFrom1e7WithLeadingZeros$1=B=>{const $=String(B);return"0000000".slice($.length)+$};function varint32write$1(B,$){if(B>=0){for(;B>127;)$.push(B&127|128),B=B>>>7;$.push(B)}else{for(let U=0;U<9;U++)$.push(B&127|128),B=B>>7;$.push(1)}}function varint32read$1(){let B=this.buf[this.pos++],$=B&127;if((B&128)==0)return this.assertBounds(),$;if(B=this.buf[this.pos++],$|=(B&127)<<7,(B&128)==0)return this.assertBounds(),$;if(B=this.buf[this.pos++],$|=(B&127)<<14,(B&128)==0)return this.assertBounds(),$;if(B=this.buf[this.pos++],$|=(B&127)<<21,(B&128)==0)return this.assertBounds(),$;B=this.buf[this.pos++],$|=(B&15)<<28;for(let U=5;(B&128)!==0&&U<10;U++)B=this.buf[this.pos++];if((B&128)!=0)throw new Error("invalid varint");return this.assertBounds(),$>>>0}function makeInt64Support$1(){const B=new DataView(new ArrayBuffer(8));if(typeof BigInt=="function"&&typeof B.getBigInt64=="function"&&typeof B.getBigUint64=="function"&&typeof B.setBigInt64=="function"&&typeof B.setBigUint64=="function"&&(typeof process!="object"||typeof process.env!="object"||process.env.BUF_BIGINT_DISABLE!=="1")){const V=BigInt("-9223372036854775808"),q=BigInt("9223372036854775807"),j=BigInt("0"),W=BigInt("18446744073709551615");return{zero:BigInt(0),supported:!0,parse(K){const G=typeof K=="bigint"?K:BigInt(K);if(G>q||G<V)throw new Error("int64 invalid: ".concat(K));return G},uParse(K){const G=typeof K=="bigint"?K:BigInt(K);if(G>W||G<j)throw new Error("uint64 invalid: ".concat(K));return G},enc(K){return B.setBigInt64(0,this.parse(K),!0),{lo:B.getInt32(0,!0),hi:B.getInt32(4,!0)}},uEnc(K){return B.setBigInt64(0,this.uParse(K),!0),{lo:B.getInt32(0,!0),hi:B.getInt32(4,!0)}},dec(K,G){return B.setInt32(0,K,!0),B.setInt32(4,G,!0),B.getBigInt64(0,!0)},uDec(K,G){return B.setInt32(0,K,!0),B.setInt32(4,G,!0),B.getBigUint64(0,!0)}}}const U=V=>assert$1(/^-?[0-9]+$/.test(V),"int64 invalid: ".concat(V)),F=V=>assert$1(/^[0-9]+$/.test(V),"uint64 invalid: ".concat(V));return{zero:"0",supported:!1,parse(V){return typeof V!="string"&&(V=V.toString()),U(V),V},uParse(V){return typeof V!="string"&&(V=V.toString()),F(V),V},enc(V){return typeof V!="string"&&(V=V.toString()),U(V),int64FromString$1(V)},uEnc(V){return typeof V!="string"&&(V=V.toString()),F(V),int64FromString$1(V)},dec(V,q){return int64ToString$1(V,q)},uDec(V,q){return uInt64ToString$1(V,q)}}}const protoInt64$1=makeInt64Support$1();var ScalarType$1;(function(B){B[B.DOUBLE=1]="DOUBLE",B[B.FLOAT=2]="FLOAT",B[B.INT64=3]="INT64",B[B.UINT64=4]="UINT64",B[B.INT32=5]="INT32",B[B.FIXED64=6]="FIXED64",B[B.FIXED32=7]="FIXED32",B[B.BOOL=8]="BOOL",B[B.STRING=9]="STRING",B[B.BYTES=12]="BYTES",B[B.UINT32=13]="UINT32",B[B.SFIXED32=15]="SFIXED32",B[B.SFIXED64=16]="SFIXED64",B[B.SINT32=17]="SINT32",B[B.SINT64=18]="SINT64"})(ScalarType$1||(ScalarType$1={}));var LongType$1;(function(B){B[B.BIGINT=0]="BIGINT",B[B.STRING=1]="STRING"})(LongType$1||(LongType$1={}));function scalarEquals$1(B,$,U){if($===U)return!0;if(B==ScalarType$1.BYTES){if(!($ instanceof Uint8Array)||!(U instanceof Uint8Array)||$.length!==U.length)return!1;for(let F=0;F<$.length;F++)if($[F]!==U[F])return!1;return!0}switch(B){case ScalarType$1.UINT64:case ScalarType$1.FIXED64:case ScalarType$1.INT64:case ScalarType$1.SFIXED64:case ScalarType$1.SINT64:return $==U}return!1}function scalarZeroValue$1(B,$){switch(B){case ScalarType$1.BOOL:return!1;case ScalarType$1.UINT64:case ScalarType$1.FIXED64:case ScalarType$1.INT64:case ScalarType$1.SFIXED64:case ScalarType$1.SINT64:return $==0?protoInt64$1.zero:"0";case ScalarType$1.DOUBLE:case ScalarType$1.FLOAT:return 0;case ScalarType$1.BYTES:return new Uint8Array(0);case ScalarType$1.STRING:return"";default:return 0}}function isScalarZeroValue$1(B,$){switch(B){case ScalarType$1.BOOL:return $===!1;case ScalarType$1.STRING:return $==="";case ScalarType$1.BYTES:return $ instanceof Uint8Array&&!$.byteLength;default:return $==0}}var WireType$1;(function(B){B[B.Varint=0]="Varint",B[B.Bit64=1]="Bit64",B[B.LengthDelimited=2]="LengthDelimited",B[B.StartGroup=3]="StartGroup",B[B.EndGroup=4]="EndGroup",B[B.Bit32=5]="Bit32"})(WireType$1||(WireType$1={}));let BinaryWriter$1=class{constructor($){this.stack=[],this.textEncoder=$??new TextEncoder,this.chunks=[],this.buf=[]}finish(){this.chunks.push(new Uint8Array(this.buf));let $=0;for(let V=0;V<this.chunks.length;V++)$+=this.chunks[V].length;let U=new Uint8Array($),F=0;for(let V=0;V<this.chunks.length;V++)U.set(this.chunks[V],F),F+=this.chunks[V].length;return this.chunks=[],U}fork(){return this.stack.push({chunks:this.chunks,buf:this.buf}),this.chunks=[],this.buf=[],this}join(){let $=this.finish(),U=this.stack.pop();if(!U)throw new Error("invalid state, fork stack empty");return this.chunks=U.chunks,this.buf=U.buf,this.uint32($.byteLength),this.raw($)}tag($,U){return this.uint32(($<<3|U)>>>0)}raw($){return this.buf.length&&(this.chunks.push(new Uint8Array(this.buf)),this.buf=[]),this.chunks.push($),this}uint32($){for(assertUInt32$1($);$>127;)this.buf.push($&127|128),$=$>>>7;return this.buf.push($),this}int32($){return assertInt32$1($),varint32write$1($,this.buf),this}bool($){return this.buf.push($?1:0),this}bytes($){return this.uint32($.byteLength),this.raw($)}string($){let U=this.textEncoder.encode($);return this.uint32(U.byteLength),this.raw(U)}float($){assertFloat32$1($);let U=new Uint8Array(4);return new DataView(U.buffer).setFloat32(0,$,!0),this.raw(U)}double($){let U=new Uint8Array(8);return new DataView(U.buffer).setFloat64(0,$,!0),this.raw(U)}fixed32($){assertUInt32$1($);let U=new Uint8Array(4);return new DataView(U.buffer).setUint32(0,$,!0),this.raw(U)}sfixed32($){assertInt32$1($);let U=new Uint8Array(4);return new DataView(U.buffer).setInt32(0,$,!0),this.raw(U)}sint32($){return assertInt32$1($),$=($<<1^$>>31)>>>0,varint32write$1($,this.buf),this}sfixed64($){let U=new Uint8Array(8),F=new DataView(U.buffer),V=protoInt64$1.enc($);return F.setInt32(0,V.lo,!0),F.setInt32(4,V.hi,!0),this.raw(U)}fixed64($){let U=new Uint8Array(8),F=new DataView(U.buffer),V=protoInt64$1.uEnc($);return F.setInt32(0,V.lo,!0),F.setInt32(4,V.hi,!0),this.raw(U)}int64($){let U=protoInt64$1.enc($);return varint64write$1(U.lo,U.hi,this.buf),this}sint64($){let U=protoInt64$1.enc($),F=U.hi>>31,V=U.lo<<1^F,q=(U.hi<<1|U.lo>>>31)^F;return varint64write$1(V,q,this.buf),this}uint64($){let U=protoInt64$1.uEnc($);return varint64write$1(U.lo,U.hi,this.buf),this}},BinaryReader$1=class{constructor($,U){this.varint64=varint64read$1,this.uint32=varint32read$1,this.buf=$,this.len=$.length,this.pos=0,this.view=new DataView($.buffer,$.byteOffset,$.byteLength),this.textDecoder=U??new TextDecoder}tag(){let $=this.uint32(),U=$>>>3,F=$&7;if(U<=0||F<0||F>5)throw new Error("illegal tag: field no "+U+" wire type "+F);return[U,F]}skip($,U){let F=this.pos;switch($){case WireType$1.Varint:for(;this.buf[this.pos++]&128;);break;case WireType$1.Bit64:this.pos+=4;case WireType$1.Bit32:this.pos+=4;break;case WireType$1.LengthDelimited:let V=this.uint32();this.pos+=V;break;case WireType$1.StartGroup:for(;;){const[q,j]=this.tag();if(j===WireType$1.EndGroup){if(U!==void 0&&q!==U)throw new Error("invalid end group tag");break}this.skip(j,q)}break;default:throw new Error("cant skip wire type "+$)}return this.assertBounds(),this.buf.subarray(F,this.pos)}assertBounds(){if(this.pos>this.len)throw new RangeError("premature EOF")}int32(){return this.uint32()|0}sint32(){let $=this.uint32();return $>>>1^-($&1)}int64(){return protoInt64$1.dec(...this.varint64())}uint64(){return protoInt64$1.uDec(...this.varint64())}sint64(){let[$,U]=this.varint64(),F=-($&1);return $=($>>>1|(U&1)<<31)^F,U=U>>>1^F,protoInt64$1.dec($,U)}bool(){let[$,U]=this.varint64();return $!==0||U!==0}fixed32(){return this.view.getUint32((this.pos+=4)-4,!0)}sfixed32(){return this.view.getInt32((this.pos+=4)-4,!0)}fixed64(){return protoInt64$1.uDec(this.sfixed32(),this.sfixed32())}sfixed64(){return protoInt64$1.dec(this.sfixed32(),this.sfixed32())}float(){return this.view.getFloat32((this.pos+=4)-4,!0)}double(){return this.view.getFloat64((this.pos+=8)-8,!0)}bytes(){let $=this.uint32(),U=this.pos;return this.pos+=$,this.assertBounds(),this.buf.subarray(U,U+$)}string(){return this.textDecoder.decode(this.bytes())}};function makeExtension$1(B,$,U,F){let V;return{typeName:$,extendee:U,get field(){if(!V){const q=typeof F=="function"?F():F;q.name=$.split(".").pop(),q.jsonName="[".concat($,"]"),V=B.util.newFieldList([q]).list()[0]}return V},runtime:B}}function createExtensionContainer$1(B){const $=B.field.localName,U=Object.create(null);return U[$]=initExtensionField$1(B),[U,()=>U[$]]}function initExtensionField$1(B){const $=B.field;if($.repeated)return[];if($.default!==void 0)return $.default;switch($.kind){case"enum":return $.T.values[0].no;case"scalar":return scalarZeroValue$1($.T,$.L);case"message":const U=$.T,F=new U;return U.fieldWrapper?U.fieldWrapper.unwrapField(F):F;case"map":throw"map fields are not allowed to be extensions"}}function filterUnknownFields$1(B,$){if(!$.repeated&&($.kind=="enum"||$.kind=="scalar")){for(let U=B.length-1;U>=0;--U)if(B[U].no==$.no)return[B[U]];return[]}return B.filter(U=>U.no===$.no)}let encTable$1="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".split(""),decTable$1=[];for(let B=0;B<encTable$1.length;B++)decTable$1[encTable$1[B].charCodeAt(0)]=B;decTable$1[45]=encTable$1.indexOf("+"),decTable$1[95]=encTable$1.indexOf("/");const protoBase64$1={dec(B){let $=B.length*3/4;B[B.length-2]=="="?$-=2:B[B.length-1]=="="&&($-=1);let U=new Uint8Array($),F=0,V=0,q,j=0;for(let W=0;W<B.length;W++){if(q=decTable$1[B.charCodeAt(W)],q===void 0)switch(B[W]){case"=":V=0;case`
`:case"\r":case"	":case" ":continue;default:throw Error("invalid base64 string.")}switch(V){case 0:j=q,V=1;break;case 1:U[F++]=j<<2|(q&48)>>4,j=q,V=2;break;case 2:U[F++]=(j&15)<<4|(q&60)>>2,j=q,V=3;break;case 3:U[F++]=(j&3)<<6|q,V=0;break}}if(V==1)throw Error("invalid base64 string.");return U.subarray(0,F)},enc(B){let $="",U=0,F,V=0;for(let q=0;q<B.length;q++)switch(F=B[q],U){case 0:$+=encTable$1[F>>2],V=(F&3)<<4,U=1;break;case 1:$+=encTable$1[V|F>>4],V=(F&15)<<2,U=2;break;case 2:$+=encTable$1[V|F>>6],$+=encTable$1[F&63],U=0;break}return U&&($+=encTable$1[V],$+="=",U==1&&($+="=")),$}};function getExtension$1(B,$,U){assertExtendee$1($,B);const F=$.runtime.bin.makeReadOptions(U),V=filterUnknownFields$1(B.getType().runtime.bin.listUnknownFields(B),$.field),[q,j]=createExtensionContainer$1($);for(const W of V)$.runtime.bin.readField(q,F.readerFactory(W.data),$.field,W.wireType,F);return j()}function setExtension$1(B,$,U,F){assertExtendee$1($,B);const V=$.runtime.bin.makeReadOptions(F),q=$.runtime.bin.makeWriteOptions(F);if(hasExtension$1(B,$)){const G=B.getType().runtime.bin.listUnknownFields(B).filter(z=>z.no!=$.field.no);B.getType().runtime.bin.discardUnknownFields(B);for(const z of G)B.getType().runtime.bin.onUnknownField(B,z.no,z.wireType,z.data)}const j=q.writerFactory();let W=$.field;!W.opt&&!W.repeated&&(W.kind=="enum"||W.kind=="scalar")&&(W=Object.assign(Object.assign({},$.field),{opt:!0})),$.runtime.bin.writeField(W,U,j,q);const K=V.readerFactory(j.finish());for(;K.pos<K.len;){const[G,z]=K.tag(),H=K.skip(z,G);B.getType().runtime.bin.onUnknownField(B,G,z,H)}}function hasExtension$1(B,$){const U=B.getType();return $.extendee.typeName===U.typeName&&!!U.runtime.bin.listUnknownFields(B).find(F=>F.no==$.field.no)}function assertExtendee$1(B,$){assert$1(B.extendee.typeName==$.getType().typeName,"extension ".concat(B.typeName," can only be applied to message ").concat(B.extendee.typeName))}function isFieldSet$1(B,$){const U=B.localName;if(B.repeated)return $[U].length>0;if(B.oneof)return $[B.oneof.localName].case===U;switch(B.kind){case"enum":case"scalar":return B.opt||B.req?$[U]!==void 0:B.kind=="enum"?$[U]!==B.T.values[0].no:!isScalarZeroValue$1(B.T,$[U]);case"message":return $[U]!==void 0;case"map":return Object.keys($[U]).length>0}}function clearField$1(B,$){const U=B.localName,F=!B.opt&&!B.req;if(B.repeated)$[U]=[];else if(B.oneof)$[B.oneof.localName]={case:void 0};else switch(B.kind){case"map":$[U]={};break;case"enum":$[U]=F?B.T.values[0].no:void 0;break;case"scalar":$[U]=F?scalarZeroValue$1(B.T,B.L):void 0;break;case"message":$[U]=void 0;break}}function isMessage$1(B,$){if(B===null||typeof B!="object"||!Object.getOwnPropertyNames(Message$1.prototype).every(F=>F in B&&typeof B[F]=="function"))return!1;const U=B.getType();return U===null||typeof U!="function"||!("typeName"in U)||typeof U.typeName!="string"?!1:$===void 0?!0:U.typeName==$.typeName}function wrapField$1(B,$){return isMessage$1($)||!B.fieldWrapper?$:B.fieldWrapper.wrapField($)}ScalarType$1.DOUBLE,ScalarType$1.FLOAT,ScalarType$1.INT64,ScalarType$1.UINT64,ScalarType$1.INT32,ScalarType$1.UINT32,ScalarType$1.BOOL,ScalarType$1.STRING,ScalarType$1.BYTES;const jsonReadDefaults$1={ignoreUnknownFields:!1},jsonWriteDefaults$1={emitDefaultValues:!1,enumAsInteger:!1,useProtoFieldName:!1,prettySpaces:0};function makeReadOptions$1$1(B){return B?Object.assign(Object.assign({},jsonReadDefaults$1),B):jsonReadDefaults$1}function makeWriteOptions$1$1(B){return B?Object.assign(Object.assign({},jsonWriteDefaults$1),B):jsonWriteDefaults$1}const tokenNull$1=Symbol(),tokenIgnoredUnknownEnum$1=Symbol();function makeJsonFormat$1(){return{makeReadOptions:makeReadOptions$1$1,makeWriteOptions:makeWriteOptions$1$1,readMessage(B,$,U,F){if($==null||Array.isArray($)||typeof $!="object")throw new Error("cannot decode message ".concat(B.typeName," from JSON: ").concat(debugJsonValue$1($)));F=F??new B;const V=new Map,q=U.typeRegistry;for(const[j,W]of Object.entries($)){const K=B.fields.findJsonName(j);if(K){if(K.oneof){if(W===null&&K.kind=="scalar")continue;const G=V.get(K.oneof);if(G!==void 0)throw new Error("cannot decode message ".concat(B.typeName,' from JSON: multiple keys for oneof "').concat(K.oneof.name,'" present: "').concat(G,'", "').concat(j,'"'));V.set(K.oneof,j)}readField$1$1(F,W,K,U,B)}else{let G=!1;if(q?.findExtension&&j.startsWith("[")&&j.endsWith("]")){const z=q.findExtension(j.substring(1,j.length-1));if(z&&z.extendee.typeName==B.typeName){G=!0;const[H,Q]=createExtensionContainer$1(z);readField$1$1(H,W,z.field,U,z),setExtension$1(F,z,Q(),U)}}if(!G&&!U.ignoreUnknownFields)throw new Error("cannot decode message ".concat(B.typeName,' from JSON: key "').concat(j,'" is unknown'))}}return F},writeMessage(B,$){const U=B.getType(),F={};let V;try{for(V of U.fields.byNumber()){if(!isFieldSet$1(V,B)){if(V.req)throw"required field not set";if(!$.emitDefaultValues||!canEmitFieldDefaultValue$1(V))continue}const j=V.oneof?B[V.oneof.localName].value:B[V.localName],W=writeField$1$1(V,j,$);W!==void 0&&(F[$.useProtoFieldName?V.name:V.jsonName]=W)}const q=$.typeRegistry;if(q?.findExtensionFor)for(const j of U.runtime.bin.listUnknownFields(B)){const W=q.findExtensionFor(U.typeName,j.no);if(W&&hasExtension$1(B,W)){const K=getExtension$1(B,W,$),G=writeField$1$1(W.field,K,$);G!==void 0&&(F[W.field.jsonName]=G)}}}catch(q){const j=V?"cannot encode field ".concat(U.typeName,".").concat(V.name," to JSON"):"cannot encode message ".concat(U.typeName," to JSON"),W=q instanceof Error?q.message:String(q);throw new Error(j+(W.length>0?": ".concat(W):""))}return F},readScalar(B,$,U){return readScalar$1$1(B,$,U??LongType$1.BIGINT,!0)},writeScalar(B,$,U){if($!==void 0&&(U||isScalarZeroValue$1(B,$)))return writeScalar$1$1(B,$)},debug:debugJsonValue$1}}function debugJsonValue$1(B){if(B===null)return"null";switch(typeof B){case"object":return Array.isArray(B)?"array":"object";case"string":return B.length>100?"string":'"'.concat(B.split('"').join('\\"'),'"');default:return String(B)}}function readField$1$1(B,$,U,F,V){let q=U.localName;if(U.repeated){if(assert$1(U.kind!="map"),$===null)return;if(!Array.isArray($))throw new Error("cannot decode field ".concat(V.typeName,".").concat(U.name," from JSON: ").concat(debugJsonValue$1($)));const j=B[q];for(const W of $){if(W===null)throw new Error("cannot decode field ".concat(V.typeName,".").concat(U.name," from JSON: ").concat(debugJsonValue$1(W)));switch(U.kind){case"message":j.push(U.T.fromJson(W,F));break;case"enum":const K=readEnum$1(U.T,W,F.ignoreUnknownFields,!0);K!==tokenIgnoredUnknownEnum$1&&j.push(K);break;case"scalar":try{j.push(readScalar$1$1(U.T,W,U.L,!0))}catch(G){let z="cannot decode field ".concat(V.typeName,".").concat(U.name," from JSON: ").concat(debugJsonValue$1(W));throw G instanceof Error&&G.message.length>0&&(z+=": ".concat(G.message)),new Error(z)}break}}}else if(U.kind=="map"){if($===null)return;if(typeof $!="object"||Array.isArray($))throw new Error("cannot decode field ".concat(V.typeName,".").concat(U.name," from JSON: ").concat(debugJsonValue$1($)));const j=B[q];for(const[W,K]of Object.entries($)){if(K===null)throw new Error("cannot decode field ".concat(V.typeName,".").concat(U.name," from JSON: map value null"));let G;try{G=readMapKey$1(U.K,W)}catch(z){let H="cannot decode map key for field ".concat(V.typeName,".").concat(U.name," from JSON: ").concat(debugJsonValue$1($));throw z instanceof Error&&z.message.length>0&&(H+=": ".concat(z.message)),new Error(H)}switch(U.V.kind){case"message":j[G]=U.V.T.fromJson(K,F);break;case"enum":const z=readEnum$1(U.V.T,K,F.ignoreUnknownFields,!0);z!==tokenIgnoredUnknownEnum$1&&(j[G]=z);break;case"scalar":try{j[G]=readScalar$1$1(U.V.T,K,LongType$1.BIGINT,!0)}catch(H){let Q="cannot decode map value for field ".concat(V.typeName,".").concat(U.name," from JSON: ").concat(debugJsonValue$1($));throw H instanceof Error&&H.message.length>0&&(Q+=": ".concat(H.message)),new Error(Q)}break}}}else switch(U.oneof&&(B=B[U.oneof.localName]={case:q},q="value"),U.kind){case"message":const j=U.T;if($===null&&j.typeName!="google.protobuf.Value")return;let W=B[q];isMessage$1(W)?W.fromJson($,F):(B[q]=W=j.fromJson($,F),j.fieldWrapper&&!U.oneof&&(B[q]=j.fieldWrapper.unwrapField(W)));break;case"enum":const K=readEnum$1(U.T,$,F.ignoreUnknownFields,!1);switch(K){case tokenNull$1:clearField$1(U,B);break;case tokenIgnoredUnknownEnum$1:break;default:B[q]=K;break}break;case"scalar":try{const G=readScalar$1$1(U.T,$,U.L,!1);switch(G){case tokenNull$1:clearField$1(U,B);break;default:B[q]=G;break}}catch(G){let z="cannot decode field ".concat(V.typeName,".").concat(U.name," from JSON: ").concat(debugJsonValue$1($));throw G instanceof Error&&G.message.length>0&&(z+=": ".concat(G.message)),new Error(z)}break}}function readMapKey$1(B,$){if(B===ScalarType$1.BOOL)switch($){case"true":$=!0;break;case"false":$=!1;break}return readScalar$1$1(B,$,LongType$1.BIGINT,!0).toString()}function readScalar$1$1(B,$,U,F){if($===null)return F?scalarZeroValue$1(B,U):tokenNull$1;switch(B){case ScalarType$1.DOUBLE:case ScalarType$1.FLOAT:if($==="NaN")return Number.NaN;if($==="Infinity")return Number.POSITIVE_INFINITY;if($==="-Infinity")return Number.NEGATIVE_INFINITY;if($===""||typeof $=="string"&&$.trim().length!==$.length||typeof $!="string"&&typeof $!="number")break;const V=Number($);if(Number.isNaN(V)||!Number.isFinite(V))break;return B==ScalarType$1.FLOAT&&assertFloat32$1(V),V;case ScalarType$1.INT32:case ScalarType$1.FIXED32:case ScalarType$1.SFIXED32:case ScalarType$1.SINT32:case ScalarType$1.UINT32:let q;if(typeof $=="number"?q=$:typeof $=="string"&&$.length>0&&$.trim().length===$.length&&(q=Number($)),q===void 0)break;return B==ScalarType$1.UINT32||B==ScalarType$1.FIXED32?assertUInt32$1(q):assertInt32$1(q),q;case ScalarType$1.INT64:case ScalarType$1.SFIXED64:case ScalarType$1.SINT64:if(typeof $!="number"&&typeof $!="string")break;const j=protoInt64$1.parse($);return U?j.toString():j;case ScalarType$1.FIXED64:case ScalarType$1.UINT64:if(typeof $!="number"&&typeof $!="string")break;const W=protoInt64$1.uParse($);return U?W.toString():W;case ScalarType$1.BOOL:if(typeof $!="boolean")break;return $;case ScalarType$1.STRING:if(typeof $!="string")break;try{encodeURIComponent($)}catch{throw new Error("invalid UTF8")}return $;case ScalarType$1.BYTES:if($==="")return new Uint8Array(0);if(typeof $!="string")break;return protoBase64$1.dec($)}throw new Error}function readEnum$1(B,$,U,F){if($===null)return B.typeName=="google.protobuf.NullValue"?0:F?B.values[0].no:tokenNull$1;switch(typeof $){case"number":if(Number.isInteger($))return $;break;case"string":const V=B.findName($);if(V!==void 0)return V.no;if(U)return tokenIgnoredUnknownEnum$1;break}throw new Error("cannot decode enum ".concat(B.typeName," from JSON: ").concat(debugJsonValue$1($)))}function canEmitFieldDefaultValue$1(B){return B.repeated||B.kind=="map"?!0:!(B.oneof||B.kind=="message"||B.opt||B.req)}function writeField$1$1(B,$,U){if(B.kind=="map"){assert$1(typeof $=="object"&&$!=null);const F={},V=Object.entries($);switch(B.V.kind){case"scalar":for(const[j,W]of V)F[j.toString()]=writeScalar$1$1(B.V.T,W);break;case"message":for(const[j,W]of V)F[j.toString()]=W.toJson(U);break;case"enum":const q=B.V.T;for(const[j,W]of V)F[j.toString()]=writeEnum$1(q,W,U.enumAsInteger);break}return U.emitDefaultValues||V.length>0?F:void 0}if(B.repeated){assert$1(Array.isArray($));const F=[];switch(B.kind){case"scalar":for(let V=0;V<$.length;V++)F.push(writeScalar$1$1(B.T,$[V]));break;case"enum":for(let V=0;V<$.length;V++)F.push(writeEnum$1(B.T,$[V],U.enumAsInteger));break;case"message":for(let V=0;V<$.length;V++)F.push($[V].toJson(U));break}return U.emitDefaultValues||F.length>0?F:void 0}switch(B.kind){case"scalar":return writeScalar$1$1(B.T,$);case"enum":return writeEnum$1(B.T,$,U.enumAsInteger);case"message":return wrapField$1(B.T,$).toJson(U)}}function writeEnum$1(B,$,U){var F;if(assert$1(typeof $=="number"),B.typeName=="google.protobuf.NullValue")return null;if(U)return $;const V=B.findNumber($);return(F=V?.name)!==null&&F!==void 0?F:$}function writeScalar$1$1(B,$){switch(B){case ScalarType$1.INT32:case ScalarType$1.SFIXED32:case ScalarType$1.SINT32:case ScalarType$1.FIXED32:case ScalarType$1.UINT32:return assert$1(typeof $=="number"),$;case ScalarType$1.FLOAT:case ScalarType$1.DOUBLE:return assert$1(typeof $=="number"),Number.isNaN($)?"NaN":$===Number.POSITIVE_INFINITY?"Infinity":$===Number.NEGATIVE_INFINITY?"-Infinity":$;case ScalarType$1.STRING:return assert$1(typeof $=="string"),$;case ScalarType$1.BOOL:return assert$1(typeof $=="boolean"),$;case ScalarType$1.UINT64:case ScalarType$1.FIXED64:case ScalarType$1.INT64:case ScalarType$1.SFIXED64:case ScalarType$1.SINT64:return assert$1(typeof $=="bigint"||typeof $=="string"||typeof $=="number"),$.toString();case ScalarType$1.BYTES:return assert$1($ instanceof Uint8Array),protoBase64$1.enc($)}}const unknownFieldsSymbol$1=Symbol("@bufbuild/protobuf/unknown-fields"),readDefaults$1={readUnknownFields:!0,readerFactory:B=>new BinaryReader$1(B)},writeDefaults$1={writeUnknownFields:!0,writerFactory:()=>new BinaryWriter$1};function makeReadOptions$2(B){return B?Object.assign(Object.assign({},readDefaults$1),B):readDefaults$1}function makeWriteOptions$2(B){return B?Object.assign(Object.assign({},writeDefaults$1),B):writeDefaults$1}function makeBinaryFormat$1(){return{makeReadOptions:makeReadOptions$2,makeWriteOptions:makeWriteOptions$2,listUnknownFields(B){var $;return($=B[unknownFieldsSymbol$1])!==null&&$!==void 0?$:[]},discardUnknownFields(B){delete B[unknownFieldsSymbol$1]},writeUnknownFields(B,$){const F=B[unknownFieldsSymbol$1];if(F)for(const V of F)$.tag(V.no,V.wireType).raw(V.data)},onUnknownField(B,$,U,F){const V=B;Array.isArray(V[unknownFieldsSymbol$1])||(V[unknownFieldsSymbol$1]=[]),V[unknownFieldsSymbol$1].push({no:$,wireType:U,data:F})},readMessage(B,$,U,F,V){const q=B.getType(),j=V?$.len:$.pos+U;let W,K;for(;$.pos<j&&([W,K]=$.tag(),!(V===!0&&K==WireType$1.EndGroup));){const G=q.fields.find(W);if(!G){const z=$.skip(K,W);F.readUnknownFields&&this.onUnknownField(B,W,K,z);continue}readField$2(B,$,G,K,F)}if(V&&(K!=WireType$1.EndGroup||W!==U))throw new Error("invalid end group tag")},readField:readField$2,writeMessage(B,$,U){const F=B.getType();for(const V of F.fields.byNumber()){if(!isFieldSet$1(V,B)){if(V.req)throw new Error("cannot encode field ".concat(F.typeName,".").concat(V.name," to binary: required field not set"));continue}const q=V.oneof?B[V.oneof.localName].value:B[V.localName];writeField$2(V,q,$,U)}return U.writeUnknownFields&&this.writeUnknownFields(B,$),$},writeField(B,$,U,F){$!==void 0&&writeField$2(B,$,U,F)}}}function readField$2(B,$,U,F,V){let{repeated:q,localName:j}=U;switch(U.oneof&&(B=B[U.oneof.localName],B.case!=j&&delete B.value,B.case=j,j="value"),U.kind){case"scalar":case"enum":const W=U.kind=="enum"?ScalarType$1.INT32:U.T;let K=readScalar$2;if(U.kind=="scalar"&&U.L>0&&(K=readScalarLTString$1),q){let Q=B[j];if(F==WireType$1.LengthDelimited&&W!=ScalarType$1.STRING&&W!=ScalarType$1.BYTES){let X=$.uint32()+$.pos;for(;$.pos<X;)Q.push(K($,W))}else Q.push(K($,W))}else B[j]=K($,W);break;case"message":const G=U.T;q?B[j].push(readMessageField$1($,new G,V,U)):isMessage$1(B[j])?readMessageField$1($,B[j],V,U):(B[j]=readMessageField$1($,new G,V,U),G.fieldWrapper&&!U.oneof&&!U.repeated&&(B[j]=G.fieldWrapper.unwrapField(B[j])));break;case"map":let[z,H]=readMapEntry$1(U,$,V);B[j][z]=H;break}}function readMessageField$1(B,$,U,F){const V=$.getType().runtime.bin,q=F?.delimited;return V.readMessage($,B,q?F.no:B.uint32(),U,q),$}function readMapEntry$1(B,$,U){const F=$.uint32(),V=$.pos+F;let q,j;for(;$.pos<V;){const[W]=$.tag();switch(W){case 1:q=readScalar$2($,B.K);break;case 2:switch(B.V.kind){case"scalar":j=readScalar$2($,B.V.T);break;case"enum":j=$.int32();break;case"message":j=readMessageField$1($,new B.V.T,U,void 0);break}break}}if(q===void 0&&(q=scalarZeroValue$1(B.K,LongType$1.BIGINT)),typeof q!="string"&&typeof q!="number"&&(q=q.toString()),j===void 0)switch(B.V.kind){case"scalar":j=scalarZeroValue$1(B.V.T,LongType$1.BIGINT);break;case"enum":j=B.V.T.values[0].no;break;case"message":j=new B.V.T;break}return[q,j]}function readScalarLTString$1(B,$){const U=readScalar$2(B,$);return typeof U=="bigint"?U.toString():U}function readScalar$2(B,$){switch($){case ScalarType$1.STRING:return B.string();case ScalarType$1.BOOL:return B.bool();case ScalarType$1.DOUBLE:return B.double();case ScalarType$1.FLOAT:return B.float();case ScalarType$1.INT32:return B.int32();case ScalarType$1.INT64:return B.int64();case ScalarType$1.UINT64:return B.uint64();case ScalarType$1.FIXED64:return B.fixed64();case ScalarType$1.BYTES:return B.bytes();case ScalarType$1.FIXED32:return B.fixed32();case ScalarType$1.SFIXED32:return B.sfixed32();case ScalarType$1.SFIXED64:return B.sfixed64();case ScalarType$1.SINT64:return B.sint64();case ScalarType$1.UINT32:return B.uint32();case ScalarType$1.SINT32:return B.sint32()}}function writeField$2(B,$,U,F){assert$1($!==void 0);const V=B.repeated;switch(B.kind){case"scalar":case"enum":let q=B.kind=="enum"?ScalarType$1.INT32:B.T;if(V)if(assert$1(Array.isArray($)),B.packed)writePacked$1(U,q,B.no,$);else for(const j of $)writeScalar$2(U,q,B.no,j);else writeScalar$2(U,q,B.no,$);break;case"message":if(V){assert$1(Array.isArray($));for(const j of $)writeMessageField$1(U,F,B,j)}else writeMessageField$1(U,F,B,$);break;case"map":assert$1(typeof $=="object"&&$!=null);for(const[j,W]of Object.entries($))writeMapEntry$1(U,F,B,j,W);break}}function writeMapEntry$1(B,$,U,F,V){B.tag(U.no,WireType$1.LengthDelimited),B.fork();let q=F;switch(U.K){case ScalarType$1.INT32:case ScalarType$1.FIXED32:case ScalarType$1.UINT32:case ScalarType$1.SFIXED32:case ScalarType$1.SINT32:q=Number.parseInt(F);break;case ScalarType$1.BOOL:assert$1(F=="true"||F=="false"),q=F=="true";break}switch(writeScalar$2(B,U.K,1,q),U.V.kind){case"scalar":writeScalar$2(B,U.V.T,2,V);break;case"enum":writeScalar$2(B,ScalarType$1.INT32,2,V);break;case"message":assert$1(V!==void 0),B.tag(2,WireType$1.LengthDelimited).bytes(V.toBinary($));break}B.join()}function writeMessageField$1(B,$,U,F){const V=wrapField$1(U.T,F);U.delimited?B.tag(U.no,WireType$1.StartGroup).raw(V.toBinary($)).tag(U.no,WireType$1.EndGroup):B.tag(U.no,WireType$1.LengthDelimited).bytes(V.toBinary($))}function writeScalar$2(B,$,U,F){assert$1(F!==void 0);let[V,q]=scalarTypeInfo$1($);B.tag(U,V)[q](F)}function writePacked$1(B,$,U,F){if(!F.length)return;B.tag(U,WireType$1.LengthDelimited).fork();let[,V]=scalarTypeInfo$1($);for(let q=0;q<F.length;q++)B[V](F[q]);B.join()}function scalarTypeInfo$1(B){let $=WireType$1.Varint;switch(B){case ScalarType$1.BYTES:case ScalarType$1.STRING:$=WireType$1.LengthDelimited;break;case ScalarType$1.DOUBLE:case ScalarType$1.FIXED64:case ScalarType$1.SFIXED64:$=WireType$1.Bit64;break;case ScalarType$1.FIXED32:case ScalarType$1.SFIXED32:case ScalarType$1.FLOAT:$=WireType$1.Bit32;break}const U=ScalarType$1[B].toLowerCase();return[$,U]}function makeUtilCommon$1(){return{setEnumType:setEnumType$1,initPartial(B,$){if(B===void 0)return;const U=$.getType();for(const F of U.fields.byMember()){const V=F.localName,q=$,j=B;if(j[V]!=null)switch(F.kind){case"oneof":const W=j[V].case;if(W===void 0)continue;const K=F.findField(W);let G=j[V].value;K&&K.kind=="message"&&!isMessage$1(G,K.T)?G=new K.T(G):K&&K.kind==="scalar"&&K.T===ScalarType$1.BYTES&&(G=toU8Arr$1(G)),q[V]={case:W,value:G};break;case"scalar":case"enum":let z=j[V];F.T===ScalarType$1.BYTES&&(z=F.repeated?z.map(toU8Arr$1):toU8Arr$1(z)),q[V]=z;break;case"map":switch(F.V.kind){case"scalar":case"enum":if(F.V.T===ScalarType$1.BYTES)for(const[Y,X]of Object.entries(j[V]))q[V][Y]=toU8Arr$1(X);else Object.assign(q[V],j[V]);break;case"message":const Q=F.V.T;for(const Y of Object.keys(j[V])){let X=j[V][Y];Q.fieldWrapper||(X=new Q(X)),q[V][Y]=X}break}break;case"message":const H=F.T;if(F.repeated)q[V]=j[V].map(Q=>isMessage$1(Q,H)?Q:new H(Q));else{const Q=j[V];H.fieldWrapper?H.typeName==="google.protobuf.BytesValue"?q[V]=toU8Arr$1(Q):q[V]=Q:q[V]=isMessage$1(Q,H)?Q:new H(Q)}break}}},equals(B,$,U){return $===U?!0:!$||!U?!1:B.fields.byMember().every(F=>{const V=$[F.localName],q=U[F.localName];if(F.repeated){if(V.length!==q.length)return!1;switch(F.kind){case"message":return V.every((j,W)=>F.T.equals(j,q[W]));case"scalar":return V.every((j,W)=>scalarEquals$1(F.T,j,q[W]));case"enum":return V.every((j,W)=>scalarEquals$1(ScalarType$1.INT32,j,q[W]))}throw new Error("repeated cannot contain ".concat(F.kind))}switch(F.kind){case"message":return F.T.equals(V,q);case"enum":return scalarEquals$1(ScalarType$1.INT32,V,q);case"scalar":return scalarEquals$1(F.T,V,q);case"oneof":if(V.case!==q.case)return!1;const j=F.findField(V.case);if(j===void 0)return!0;switch(j.kind){case"message":return j.T.equals(V.value,q.value);case"enum":return scalarEquals$1(ScalarType$1.INT32,V.value,q.value);case"scalar":return scalarEquals$1(j.T,V.value,q.value)}throw new Error("oneof cannot contain ".concat(j.kind));case"map":const W=Object.keys(V).concat(Object.keys(q));switch(F.V.kind){case"message":const K=F.V.T;return W.every(z=>K.equals(V[z],q[z]));case"enum":return W.every(z=>scalarEquals$1(ScalarType$1.INT32,V[z],q[z]));case"scalar":const G=F.V.T;return W.every(z=>scalarEquals$1(G,V[z],q[z]))}break}})},clone(B){const $=B.getType(),U=new $,F=U;for(const V of $.fields.byMember()){const q=B[V.localName];let j;if(V.repeated)j=q.map(cloneSingularField$1);else if(V.kind=="map"){j=F[V.localName];for(const[W,K]of Object.entries(q))j[W]=cloneSingularField$1(K)}else V.kind=="oneof"?j=V.findField(q.case)?{case:q.case,value:cloneSingularField$1(q.value)}:{case:void 0}:j=cloneSingularField$1(q);F[V.localName]=j}for(const V of $.runtime.bin.listUnknownFields(B))$.runtime.bin.onUnknownField(F,V.no,V.wireType,V.data);return U}}}function cloneSingularField$1(B){if(B===void 0)return B;if(isMessage$1(B))return B.clone();if(B instanceof Uint8Array){const $=new Uint8Array(B.byteLength);return $.set(B),$}return B}function toU8Arr$1(B){return B instanceof Uint8Array?B:new Uint8Array(B)}function makeProtoRuntime$1(B,$,U){return{syntax:B,json:makeJsonFormat$1(),bin:makeBinaryFormat$1(),util:Object.assign(Object.assign({},makeUtilCommon$1()),{newFieldList:$,initFields:U}),makeMessageType(F,V,q){return makeMessageType$1(this,F,V,q)},makeEnum:makeEnum$1,makeEnumType:makeEnumType$1,getEnumType:getEnumType$1,makeExtension(F,V,q){return makeExtension$1(this,F,V,q)}}}let InternalFieldList$1=class{constructor($,U){this._fields=$,this._normalizer=U}findJsonName($){if(!this.jsonNames){const U={};for(const F of this.list())U[F.jsonName]=U[F.name]=F;this.jsonNames=U}return this.jsonNames[$]}find($){if(!this.numbers){const U={};for(const F of this.list())U[F.no]=F;this.numbers=U}return this.numbers[$]}list(){return this.all||(this.all=this._normalizer(this._fields)),this.all}byNumber(){return this.numbersAsc||(this.numbersAsc=this.list().concat().sort(($,U)=>$.no-U.no)),this.numbersAsc}byMember(){if(!this.members){this.members=[];const $=this.members;let U;for(const F of this.list())F.oneof?F.oneof!==U&&(U=F.oneof,$.push(U)):$.push(F)}return this.members}};function localFieldName$1(B,$){const U=protoCamelCase$1(B);return $?U:safeObjectProperty$1(safeMessageProperty$1(U))}function localOneofName$1(B){return localFieldName$1(B,!1)}const fieldJsonName$1=protoCamelCase$1;function protoCamelCase$1(B){let $=!1;const U=[];for(let F=0;F<B.length;F++){let V=B.charAt(F);switch(V){case"_":$=!0;break;case"0":case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":U.push(V),$=!1;break;default:$&&($=!1,V=V.toUpperCase()),U.push(V);break}}return U.join("")}const reservedObjectProperties$1=new Set(["constructor","toString","toJSON","valueOf"]),reservedMessageProperties$1=new Set(["getType","clone","equals","fromBinary","fromJson","fromJsonString","toBinary","toJson","toJsonString","toObject"]),fallback$1=B=>"".concat(B,"$"),safeMessageProperty$1=B=>reservedMessageProperties$1.has(B)?fallback$1(B):B,safeObjectProperty$1=B=>reservedObjectProperties$1.has(B)?fallback$1(B):B;let InternalOneofInfo$1=class{constructor($){this.kind="oneof",this.repeated=!1,this.packed=!1,this.opt=!1,this.req=!1,this.default=void 0,this.fields=[],this.name=$,this.localName=localOneofName$1($)}addField($){assert$1($.oneof===this,"field ".concat($.name," not one of ").concat(this.name)),this.fields.push($)}findField($){if(!this._lookup){this._lookup=Object.create(null);for(let U=0;U<this.fields.length;U++)this._lookup[this.fields[U].localName]=this.fields[U]}return this._lookup[$]}};function normalizeFieldInfos$1(B,$){var U,F,V,q,j,W;const K=[];let G;for(const z of typeof B=="function"?B():B){const H=z;if(H.localName=localFieldName$1(z.name,z.oneof!==void 0),H.jsonName=(U=z.jsonName)!==null&&U!==void 0?U:fieldJsonName$1(z.name),H.repeated=(F=z.repeated)!==null&&F!==void 0?F:!1,z.kind=="scalar"&&(H.L=(V=z.L)!==null&&V!==void 0?V:LongType$1.BIGINT),H.delimited=(q=z.delimited)!==null&&q!==void 0?q:!1,H.req=(j=z.req)!==null&&j!==void 0?j:!1,H.opt=(W=z.opt)!==null&&W!==void 0?W:!1,z.packed===void 0&&(H.packed=z.kind=="enum"||z.kind=="scalar"&&z.T!=ScalarType$1.BYTES&&z.T!=ScalarType$1.STRING),z.oneof!==void 0){const Q=typeof z.oneof=="string"?z.oneof:z.oneof.name;(!G||G.name!=Q)&&(G=new InternalOneofInfo$1(Q)),H.oneof=G,G.addField(H)}K.push(H)}return K}const proto3$1=makeProtoRuntime$1("proto3",B=>new InternalFieldList$1(B,$=>normalizeFieldInfos$1($)),B=>{for(const $ of B.getType().fields.byMember()){if($.opt)continue;const U=$.localName,F=B;if($.repeated){F[U]=[];continue}switch($.kind){case"oneof":F[U]={case:void 0};break;case"enum":F[U]=0;break;case"map":F[U]={};break;case"scalar":F[U]=scalarZeroValue$1($.T,$.L);break}}});let Timestamp$1=class Ue extends Message$1{constructor($){super(),this.seconds=protoInt64$1.zero,this.nanos=0,proto3$1.util.initPartial($,this)}fromJson($,U){if(typeof $!="string")throw new Error("cannot decode google.protobuf.Timestamp from JSON: ".concat(proto3$1.json.debug($)));const F=$.match(/^([0-9]{4})-([0-9]{2})-([0-9]{2})T([0-9]{2}):([0-9]{2}):([0-9]{2})(?:Z|\.([0-9]{3,9})Z|([+-][0-9][0-9]:[0-9][0-9]))$/);if(!F)throw new Error("cannot decode google.protobuf.Timestamp from JSON: invalid RFC 3339 string");const V=Date.parse(F[1]+"-"+F[2]+"-"+F[3]+"T"+F[4]+":"+F[5]+":"+F[6]+(F[8]?F[8]:"Z"));if(Number.isNaN(V))throw new Error("cannot decode google.protobuf.Timestamp from JSON: invalid RFC 3339 string");if(V<Date.parse("0001-01-01T00:00:00Z")||V>Date.parse("9999-12-31T23:59:59Z"))throw new Error("cannot decode message google.protobuf.Timestamp from JSON: must be from 0001-01-01T00:00:00Z to 9999-12-31T23:59:59Z inclusive");return this.seconds=protoInt64$1.parse(V/1e3),this.nanos=0,F[7]&&(this.nanos=parseInt("1"+F[7]+"0".repeat(9-F[7].length))-1e9),this}toJson($){const U=Number(this.seconds)*1e3;if(U<Date.parse("0001-01-01T00:00:00Z")||U>Date.parse("9999-12-31T23:59:59Z"))throw new Error("cannot encode google.protobuf.Timestamp to JSON: must be from 0001-01-01T00:00:00Z to 9999-12-31T23:59:59Z inclusive");if(this.nanos<0)throw new Error("cannot encode google.protobuf.Timestamp to JSON: nanos must not be negative");let F="Z";if(this.nanos>0){const V=(this.nanos+1e9).toString().substring(1);V.substring(3)==="000000"?F="."+V.substring(0,3)+"Z":V.substring(6)==="000"?F="."+V.substring(0,6)+"Z":F="."+V+"Z"}return new Date(U).toISOString().replace(".000Z",F)}toDate(){return new Date(Number(this.seconds)*1e3+Math.ceil(this.nanos/1e6))}static now(){return Ue.fromDate(new Date)}static fromDate($){const U=$.getTime();return new Ue({seconds:protoInt64$1.parse(Math.floor(U/1e3)),nanos:U%1e3*1e6})}static fromBinary($,U){return new Ue().fromBinary($,U)}static fromJson($,U){return new Ue().fromJson($,U)}static fromJsonString($,U){return new Ue().fromJsonString($,U)}static equals($,U){return proto3$1.util.equals(Ue,$,U)}};Timestamp$1.runtime=proto3$1,Timestamp$1.typeName="google.protobuf.Timestamp",Timestamp$1.fields=proto3$1.util.newFieldList(()=>[{no:1,name:"seconds",kind:"scalar",T:3},{no:2,name:"nanos",kind:"scalar",T:5}]);const MetricsBatch$1=proto3$1.makeMessageType("livekit.MetricsBatch",()=>[{no:1,name:"timestamp_ms",kind:"scalar",T:3},{no:2,name:"normalized_timestamp",kind:"message",T:Timestamp$1},{no:3,name:"str_data",kind:"scalar",T:9,repeated:!0},{no:4,name:"time_series",kind:"message",T:TimeSeriesMetric$1,repeated:!0},{no:5,name:"events",kind:"message",T:EventMetric$1,repeated:!0}]),TimeSeriesMetric$1=proto3$1.makeMessageType("livekit.TimeSeriesMetric",()=>[{no:1,name:"label",kind:"scalar",T:13},{no:2,name:"participant_identity",kind:"scalar",T:13},{no:3,name:"track_sid",kind:"scalar",T:13},{no:4,name:"samples",kind:"message",T:MetricSample$1,repeated:!0},{no:5,name:"rid",kind:"scalar",T:13}]),MetricSample$1=proto3$1.makeMessageType("livekit.MetricSample",()=>[{no:1,name:"timestamp_ms",kind:"scalar",T:3},{no:2,name:"normalized_timestamp",kind:"message",T:Timestamp$1},{no:3,name:"value",kind:"scalar",T:2}]),EventMetric$1=proto3$1.makeMessageType("livekit.EventMetric",()=>[{no:1,name:"label",kind:"scalar",T:13},{no:2,name:"participant_identity",kind:"scalar",T:13},{no:3,name:"track_sid",kind:"scalar",T:13},{no:4,name:"start_timestamp_ms",kind:"scalar",T:3},{no:5,name:"end_timestamp_ms",kind:"scalar",T:3,opt:!0},{no:6,name:"normalized_start_timestamp",kind:"message",T:Timestamp$1},{no:7,name:"normalized_end_timestamp",kind:"message",T:Timestamp$1,opt:!0},{no:8,name:"metadata",kind:"scalar",T:9},{no:9,name:"rid",kind:"scalar",T:13}]),BackupCodecPolicy$1$1=proto3$1.makeEnum("livekit.BackupCodecPolicy",[{no:0,name:"PREFER_REGRESSION"},{no:1,name:"SIMULCAST"},{no:2,name:"REGRESSION"}]),TrackType$1=proto3$1.makeEnum("livekit.TrackType",[{no:0,name:"AUDIO"},{no:1,name:"VIDEO"},{no:2,name:"DATA"}]),TrackSource$1=proto3$1.makeEnum("livekit.TrackSource",[{no:0,name:"UNKNOWN"},{no:1,name:"CAMERA"},{no:2,name:"MICROPHONE"},{no:3,name:"SCREEN_SHARE"},{no:4,name:"SCREEN_SHARE_AUDIO"}]),VideoQuality$1$1=proto3$1.makeEnum("livekit.VideoQuality",[{no:0,name:"LOW"},{no:1,name:"MEDIUM"},{no:2,name:"HIGH"},{no:3,name:"OFF"}]),ConnectionQuality$1$1=proto3$1.makeEnum("livekit.ConnectionQuality",[{no:0,name:"POOR"},{no:1,name:"GOOD"},{no:2,name:"EXCELLENT"},{no:3,name:"LOST"}]),ClientConfigSetting$1=proto3$1.makeEnum("livekit.ClientConfigSetting",[{no:0,name:"UNSET"},{no:1,name:"DISABLED"},{no:2,name:"ENABLED"}]),DisconnectReason$1=proto3$1.makeEnum("livekit.DisconnectReason",[{no:0,name:"UNKNOWN_REASON"},{no:1,name:"CLIENT_INITIATED"},{no:2,name:"DUPLICATE_IDENTITY"},{no:3,name:"SERVER_SHUTDOWN"},{no:4,name:"PARTICIPANT_REMOVED"},{no:5,name:"ROOM_DELETED"},{no:6,name:"STATE_MISMATCH"},{no:7,name:"JOIN_FAILURE"},{no:8,name:"MIGRATION"},{no:9,name:"SIGNAL_CLOSE"},{no:10,name:"ROOM_CLOSED"},{no:11,name:"USER_UNAVAILABLE"},{no:12,name:"USER_REJECTED"},{no:13,name:"SIP_TRUNK_FAILURE"}]),ReconnectReason$1=proto3$1.makeEnum("livekit.ReconnectReason",[{no:0,name:"RR_UNKNOWN"},{no:1,name:"RR_SIGNAL_DISCONNECTED"},{no:2,name:"RR_PUBLISHER_FAILED"},{no:3,name:"RR_SUBSCRIBER_FAILED"},{no:4,name:"RR_SWITCH_CANDIDATE"}]),SubscriptionError$1=proto3$1.makeEnum("livekit.SubscriptionError",[{no:0,name:"SE_UNKNOWN"},{no:1,name:"SE_CODEC_UNSUPPORTED"},{no:2,name:"SE_TRACK_NOTFOUND"}]),AudioTrackFeature$1=proto3$1.makeEnum("livekit.AudioTrackFeature",[{no:0,name:"TF_STEREO"},{no:1,name:"TF_NO_DTX"},{no:2,name:"TF_AUTO_GAIN_CONTROL"},{no:3,name:"TF_ECHO_CANCELLATION"},{no:4,name:"TF_NOISE_SUPPRESSION"},{no:5,name:"TF_ENHANCED_NOISE_CANCELLATION"}]),Room$1$1=proto3$1.makeMessageType("livekit.Room",()=>[{no:1,name:"sid",kind:"scalar",T:9},{no:2,name:"name",kind:"scalar",T:9},{no:3,name:"empty_timeout",kind:"scalar",T:13},{no:14,name:"departure_timeout",kind:"scalar",T:13},{no:4,name:"max_participants",kind:"scalar",T:13},{no:5,name:"creation_time",kind:"scalar",T:3},{no:15,name:"creation_time_ms",kind:"scalar",T:3},{no:6,name:"turn_password",kind:"scalar",T:9},{no:7,name:"enabled_codecs",kind:"message",T:Codec$1,repeated:!0},{no:8,name:"metadata",kind:"scalar",T:9},{no:9,name:"num_participants",kind:"scalar",T:13},{no:11,name:"num_publishers",kind:"scalar",T:13},{no:10,name:"active_recording",kind:"scalar",T:8},{no:13,name:"version",kind:"message",T:TimedVersion$1}]),Codec$1=proto3$1.makeMessageType("livekit.Codec",()=>[{no:1,name:"mime",kind:"scalar",T:9},{no:2,name:"fmtp_line",kind:"scalar",T:9}]),ParticipantPermission$1=proto3$1.makeMessageType("livekit.ParticipantPermission",()=>[{no:1,name:"can_subscribe",kind:"scalar",T:8},{no:2,name:"can_publish",kind:"scalar",T:8},{no:3,name:"can_publish_data",kind:"scalar",T:8},{no:9,name:"can_publish_sources",kind:"enum",T:proto3$1.getEnumType(TrackSource$1),repeated:!0},{no:7,name:"hidden",kind:"scalar",T:8},{no:8,name:"recorder",kind:"scalar",T:8},{no:10,name:"can_update_metadata",kind:"scalar",T:8},{no:11,name:"agent",kind:"scalar",T:8},{no:12,name:"can_subscribe_metrics",kind:"scalar",T:8}]),ParticipantInfo$1=proto3$1.makeMessageType("livekit.ParticipantInfo",()=>[{no:1,name:"sid",kind:"scalar",T:9},{no:2,name:"identity",kind:"scalar",T:9},{no:3,name:"state",kind:"enum",T:proto3$1.getEnumType(ParticipantInfo_State$1)},{no:4,name:"tracks",kind:"message",T:TrackInfo$1,repeated:!0},{no:5,name:"metadata",kind:"scalar",T:9},{no:6,name:"joined_at",kind:"scalar",T:3},{no:17,name:"joined_at_ms",kind:"scalar",T:3},{no:9,name:"name",kind:"scalar",T:9},{no:10,name:"version",kind:"scalar",T:13},{no:11,name:"permission",kind:"message",T:ParticipantPermission$1},{no:12,name:"region",kind:"scalar",T:9},{no:13,name:"is_publisher",kind:"scalar",T:8},{no:14,name:"kind",kind:"enum",T:proto3$1.getEnumType(ParticipantInfo_Kind$1)},{no:15,name:"attributes",kind:"map",K:9,V:{kind:"scalar",T:9}},{no:16,name:"disconnect_reason",kind:"enum",T:proto3$1.getEnumType(DisconnectReason$1)},{no:18,name:"kind_details",kind:"enum",T:proto3$1.getEnumType(ParticipantInfo_KindDetail$1),repeated:!0}]),ParticipantInfo_State$1=proto3$1.makeEnum("livekit.ParticipantInfo.State",[{no:0,name:"JOINING"},{no:1,name:"JOINED"},{no:2,name:"ACTIVE"},{no:3,name:"DISCONNECTED"}]),ParticipantInfo_Kind$1=proto3$1.makeEnum("livekit.ParticipantInfo.Kind",[{no:0,name:"STANDARD"},{no:1,name:"INGRESS"},{no:2,name:"EGRESS"},{no:3,name:"SIP"},{no:4,name:"AGENT"}]),ParticipantInfo_KindDetail$1=proto3$1.makeEnum("livekit.ParticipantInfo.KindDetail",[{no:0,name:"CLOUD_AGENT"},{no:1,name:"FORWARDED"}]),Encryption_Type$1=proto3$1.makeEnum("livekit.Encryption.Type",[{no:0,name:"NONE"},{no:1,name:"GCM"},{no:2,name:"CUSTOM"}]),SimulcastCodecInfo$1=proto3$1.makeMessageType("livekit.SimulcastCodecInfo",()=>[{no:1,name:"mime_type",kind:"scalar",T:9},{no:2,name:"mid",kind:"scalar",T:9},{no:3,name:"cid",kind:"scalar",T:9},{no:4,name:"layers",kind:"message",T:VideoLayer$1,repeated:!0}]),TrackInfo$1=proto3$1.makeMessageType("livekit.TrackInfo",()=>[{no:1,name:"sid",kind:"scalar",T:9},{no:2,name:"type",kind:"enum",T:proto3$1.getEnumType(TrackType$1)},{no:3,name:"name",kind:"scalar",T:9},{no:4,name:"muted",kind:"scalar",T:8},{no:5,name:"width",kind:"scalar",T:13},{no:6,name:"height",kind:"scalar",T:13},{no:7,name:"simulcast",kind:"scalar",T:8},{no:8,name:"disable_dtx",kind:"scalar",T:8},{no:9,name:"source",kind:"enum",T:proto3$1.getEnumType(TrackSource$1)},{no:10,name:"layers",kind:"message",T:VideoLayer$1,repeated:!0},{no:11,name:"mime_type",kind:"scalar",T:9},{no:12,name:"mid",kind:"scalar",T:9},{no:13,name:"codecs",kind:"message",T:SimulcastCodecInfo$1,repeated:!0},{no:14,name:"stereo",kind:"scalar",T:8},{no:15,name:"disable_red",kind:"scalar",T:8},{no:16,name:"encryption",kind:"enum",T:proto3$1.getEnumType(Encryption_Type$1)},{no:17,name:"stream",kind:"scalar",T:9},{no:18,name:"version",kind:"message",T:TimedVersion$1},{no:19,name:"audio_features",kind:"enum",T:proto3$1.getEnumType(AudioTrackFeature$1),repeated:!0},{no:20,name:"backup_codec_policy",kind:"enum",T:proto3$1.getEnumType(BackupCodecPolicy$1$1)}]),VideoLayer$1=proto3$1.makeMessageType("livekit.VideoLayer",()=>[{no:1,name:"quality",kind:"enum",T:proto3$1.getEnumType(VideoQuality$1$1)},{no:2,name:"width",kind:"scalar",T:13},{no:3,name:"height",kind:"scalar",T:13},{no:4,name:"bitrate",kind:"scalar",T:13},{no:5,name:"ssrc",kind:"scalar",T:13}]),DataPacket$1=proto3$1.makeMessageType("livekit.DataPacket",()=>[{no:1,name:"kind",kind:"enum",T:proto3$1.getEnumType(DataPacket_Kind$1)},{no:4,name:"participant_identity",kind:"scalar",T:9},{no:5,name:"destination_identities",kind:"scalar",T:9,repeated:!0},{no:2,name:"user",kind:"message",T:UserPacket$1,oneof:"value"},{no:3,name:"speaker",kind:"message",T:ActiveSpeakerUpdate$1,oneof:"value"},{no:6,name:"sip_dtmf",kind:"message",T:SipDTMF$1,oneof:"value"},{no:7,name:"transcription",kind:"message",T:Transcription$1,oneof:"value"},{no:8,name:"metrics",kind:"message",T:MetricsBatch$1,oneof:"value"},{no:9,name:"chat_message",kind:"message",T:ChatMessage$1,oneof:"value"},{no:10,name:"rpc_request",kind:"message",T:RpcRequest$1,oneof:"value"},{no:11,name:"rpc_ack",kind:"message",T:RpcAck$1,oneof:"value"},{no:12,name:"rpc_response",kind:"message",T:RpcResponse$1,oneof:"value"},{no:13,name:"stream_header",kind:"message",T:DataStream_Header$1,oneof:"value"},{no:14,name:"stream_chunk",kind:"message",T:DataStream_Chunk$1,oneof:"value"},{no:15,name:"stream_trailer",kind:"message",T:DataStream_Trailer$1,oneof:"value"}]),DataPacket_Kind$1=proto3$1.makeEnum("livekit.DataPacket.Kind",[{no:0,name:"RELIABLE"},{no:1,name:"LOSSY"}]),ActiveSpeakerUpdate$1=proto3$1.makeMessageType("livekit.ActiveSpeakerUpdate",()=>[{no:1,name:"speakers",kind:"message",T:SpeakerInfo$1,repeated:!0}]),SpeakerInfo$1=proto3$1.makeMessageType("livekit.SpeakerInfo",()=>[{no:1,name:"sid",kind:"scalar",T:9},{no:2,name:"level",kind:"scalar",T:2},{no:3,name:"active",kind:"scalar",T:8}]),UserPacket$1=proto3$1.makeMessageType("livekit.UserPacket",()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:5,name:"participant_identity",kind:"scalar",T:9},{no:2,name:"payload",kind:"scalar",T:12},{no:3,name:"destination_sids",kind:"scalar",T:9,repeated:!0},{no:6,name:"destination_identities",kind:"scalar",T:9,repeated:!0},{no:4,name:"topic",kind:"scalar",T:9,opt:!0},{no:8,name:"id",kind:"scalar",T:9,opt:!0},{no:9,name:"start_time",kind:"scalar",T:4,opt:!0},{no:10,name:"end_time",kind:"scalar",T:4,opt:!0},{no:11,name:"nonce",kind:"scalar",T:12}]),SipDTMF$1=proto3$1.makeMessageType("livekit.SipDTMF",()=>[{no:3,name:"code",kind:"scalar",T:13},{no:4,name:"digit",kind:"scalar",T:9}]),Transcription$1=proto3$1.makeMessageType("livekit.Transcription",()=>[{no:2,name:"transcribed_participant_identity",kind:"scalar",T:9},{no:3,name:"track_id",kind:"scalar",T:9},{no:4,name:"segments",kind:"message",T:TranscriptionSegment$1,repeated:!0}]),TranscriptionSegment$1=proto3$1.makeMessageType("livekit.TranscriptionSegment",()=>[{no:1,name:"id",kind:"scalar",T:9},{no:2,name:"text",kind:"scalar",T:9},{no:3,name:"start_time",kind:"scalar",T:4},{no:4,name:"end_time",kind:"scalar",T:4},{no:5,name:"final",kind:"scalar",T:8},{no:6,name:"language",kind:"scalar",T:9}]),ChatMessage$1=proto3$1.makeMessageType("livekit.ChatMessage",()=>[{no:1,name:"id",kind:"scalar",T:9},{no:2,name:"timestamp",kind:"scalar",T:3},{no:3,name:"edit_timestamp",kind:"scalar",T:3,opt:!0},{no:4,name:"message",kind:"scalar",T:9},{no:5,name:"deleted",kind:"scalar",T:8},{no:6,name:"generated",kind:"scalar",T:8}]),RpcRequest$1=proto3$1.makeMessageType("livekit.RpcRequest",()=>[{no:1,name:"id",kind:"scalar",T:9},{no:2,name:"method",kind:"scalar",T:9},{no:3,name:"payload",kind:"scalar",T:9},{no:4,name:"response_timeout_ms",kind:"scalar",T:13},{no:5,name:"version",kind:"scalar",T:13}]),RpcAck$1=proto3$1.makeMessageType("livekit.RpcAck",()=>[{no:1,name:"request_id",kind:"scalar",T:9}]),RpcResponse$1=proto3$1.makeMessageType("livekit.RpcResponse",()=>[{no:1,name:"request_id",kind:"scalar",T:9},{no:2,name:"payload",kind:"scalar",T:9,oneof:"value"},{no:3,name:"error",kind:"message",T:RpcError$1$1,oneof:"value"}]),RpcError$1$1=proto3$1.makeMessageType("livekit.RpcError",()=>[{no:1,name:"code",kind:"scalar",T:13},{no:2,name:"message",kind:"scalar",T:9},{no:3,name:"data",kind:"scalar",T:9}]),ParticipantTracks$1=proto3$1.makeMessageType("livekit.ParticipantTracks",()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:2,name:"track_sids",kind:"scalar",T:9,repeated:!0}]),ServerInfo$1=proto3$1.makeMessageType("livekit.ServerInfo",()=>[{no:1,name:"edition",kind:"enum",T:proto3$1.getEnumType(ServerInfo_Edition$1)},{no:2,name:"version",kind:"scalar",T:9},{no:3,name:"protocol",kind:"scalar",T:5},{no:4,name:"region",kind:"scalar",T:9},{no:5,name:"node_id",kind:"scalar",T:9},{no:6,name:"debug_info",kind:"scalar",T:9},{no:7,name:"agent_protocol",kind:"scalar",T:5}]),ServerInfo_Edition$1=proto3$1.makeEnum("livekit.ServerInfo.Edition",[{no:0,name:"Standard"},{no:1,name:"Cloud"}]),ClientInfo$1=proto3$1.makeMessageType("livekit.ClientInfo",()=>[{no:1,name:"sdk",kind:"enum",T:proto3$1.getEnumType(ClientInfo_SDK$1)},{no:2,name:"version",kind:"scalar",T:9},{no:3,name:"protocol",kind:"scalar",T:5},{no:4,name:"os",kind:"scalar",T:9},{no:5,name:"os_version",kind:"scalar",T:9},{no:6,name:"device_model",kind:"scalar",T:9},{no:7,name:"browser",kind:"scalar",T:9},{no:8,name:"browser_version",kind:"scalar",T:9},{no:9,name:"address",kind:"scalar",T:9},{no:10,name:"network",kind:"scalar",T:9},{no:11,name:"other_sdks",kind:"scalar",T:9}]),ClientInfo_SDK$1=proto3$1.makeEnum("livekit.ClientInfo.SDK",[{no:0,name:"UNKNOWN"},{no:1,name:"JS"},{no:2,name:"SWIFT"},{no:3,name:"ANDROID"},{no:4,name:"FLUTTER"},{no:5,name:"GO"},{no:6,name:"UNITY"},{no:7,name:"REACT_NATIVE"},{no:8,name:"RUST"},{no:9,name:"PYTHON"},{no:10,name:"CPP"},{no:11,name:"UNITY_WEB"},{no:12,name:"NODE"}]),ClientConfiguration$1=proto3$1.makeMessageType("livekit.ClientConfiguration",()=>[{no:1,name:"video",kind:"message",T:VideoConfiguration$1},{no:2,name:"screen",kind:"message",T:VideoConfiguration$1},{no:3,name:"resume_connection",kind:"enum",T:proto3$1.getEnumType(ClientConfigSetting$1)},{no:4,name:"disabled_codecs",kind:"message",T:DisabledCodecs$1},{no:5,name:"force_relay",kind:"enum",T:proto3$1.getEnumType(ClientConfigSetting$1)}]),VideoConfiguration$1=proto3$1.makeMessageType("livekit.VideoConfiguration",()=>[{no:1,name:"hardware_encoder",kind:"enum",T:proto3$1.getEnumType(ClientConfigSetting$1)}]),DisabledCodecs$1=proto3$1.makeMessageType("livekit.DisabledCodecs",()=>[{no:1,name:"codecs",kind:"message",T:Codec$1,repeated:!0},{no:2,name:"publish",kind:"message",T:Codec$1,repeated:!0}]),TimedVersion$1=proto3$1.makeMessageType("livekit.TimedVersion",()=>[{no:1,name:"unix_micro",kind:"scalar",T:3},{no:2,name:"ticks",kind:"scalar",T:5}]),DataStream_OperationType$1=proto3$1.makeEnum("livekit.DataStream.OperationType",[{no:0,name:"CREATE"},{no:1,name:"UPDATE"},{no:2,name:"DELETE"},{no:3,name:"REACTION"}]),DataStream_TextHeader$1=proto3$1.makeMessageType("livekit.DataStream.TextHeader",()=>[{no:1,name:"operation_type",kind:"enum",T:proto3$1.getEnumType(DataStream_OperationType$1)},{no:2,name:"version",kind:"scalar",T:5},{no:3,name:"reply_to_stream_id",kind:"scalar",T:9},{no:4,name:"attached_stream_ids",kind:"scalar",T:9,repeated:!0},{no:5,name:"generated",kind:"scalar",T:8}],{localName:"DataStream_TextHeader"}),DataStream_ByteHeader$1=proto3$1.makeMessageType("livekit.DataStream.ByteHeader",()=>[{no:1,name:"name",kind:"scalar",T:9}],{localName:"DataStream_ByteHeader"}),DataStream_Header$1=proto3$1.makeMessageType("livekit.DataStream.Header",()=>[{no:1,name:"stream_id",kind:"scalar",T:9},{no:2,name:"timestamp",kind:"scalar",T:3},{no:3,name:"topic",kind:"scalar",T:9},{no:4,name:"mime_type",kind:"scalar",T:9},{no:5,name:"total_length",kind:"scalar",T:4,opt:!0},{no:7,name:"encryption_type",kind:"enum",T:proto3$1.getEnumType(Encryption_Type$1)},{no:8,name:"attributes",kind:"map",K:9,V:{kind:"scalar",T:9}},{no:9,name:"text_header",kind:"message",T:DataStream_TextHeader$1,oneof:"content_header"},{no:10,name:"byte_header",kind:"message",T:DataStream_ByteHeader$1,oneof:"content_header"}],{localName:"DataStream_Header"}),DataStream_Chunk$1=proto3$1.makeMessageType("livekit.DataStream.Chunk",()=>[{no:1,name:"stream_id",kind:"scalar",T:9},{no:2,name:"chunk_index",kind:"scalar",T:4},{no:3,name:"content",kind:"scalar",T:12},{no:4,name:"version",kind:"scalar",T:5},{no:5,name:"iv",kind:"scalar",T:12,opt:!0}],{localName:"DataStream_Chunk"}),DataStream_Trailer$1=proto3$1.makeMessageType("livekit.DataStream.Trailer",()=>[{no:1,name:"stream_id",kind:"scalar",T:9},{no:2,name:"reason",kind:"scalar",T:9},{no:3,name:"attributes",kind:"map",K:9,V:{kind:"scalar",T:9}}],{localName:"DataStream_Trailer"}),SignalTarget$1=proto3$1.makeEnum("livekit.SignalTarget",[{no:0,name:"PUBLISHER"},{no:1,name:"SUBSCRIBER"}]),StreamState$1=proto3$1.makeEnum("livekit.StreamState",[{no:0,name:"ACTIVE"},{no:1,name:"PAUSED"}]),CandidateProtocol$1=proto3$1.makeEnum("livekit.CandidateProtocol",[{no:0,name:"UDP"},{no:1,name:"TCP"},{no:2,name:"TLS"}]),SignalRequest$1=proto3$1.makeMessageType("livekit.SignalRequest",()=>[{no:1,name:"offer",kind:"message",T:SessionDescription$1,oneof:"message"},{no:2,name:"answer",kind:"message",T:SessionDescription$1,oneof:"message"},{no:3,name:"trickle",kind:"message",T:TrickleRequest$1,oneof:"message"},{no:4,name:"add_track",kind:"message",T:AddTrackRequest$1,oneof:"message"},{no:5,name:"mute",kind:"message",T:MuteTrackRequest$1,oneof:"message"},{no:6,name:"subscription",kind:"message",T:UpdateSubscription$1,oneof:"message"},{no:7,name:"track_setting",kind:"message",T:UpdateTrackSettings$1,oneof:"message"},{no:8,name:"leave",kind:"message",T:LeaveRequest$1,oneof:"message"},{no:10,name:"update_layers",kind:"message",T:UpdateVideoLayers$1,oneof:"message"},{no:11,name:"subscription_permission",kind:"message",T:SubscriptionPermission$1,oneof:"message"},{no:12,name:"sync_state",kind:"message",T:SyncState$1,oneof:"message"},{no:13,name:"simulate",kind:"message",T:SimulateScenario$1,oneof:"message"},{no:14,name:"ping",kind:"scalar",T:3,oneof:"message"},{no:15,name:"update_metadata",kind:"message",T:UpdateParticipantMetadata$1,oneof:"message"},{no:16,name:"ping_req",kind:"message",T:Ping$1,oneof:"message"},{no:17,name:"update_audio_track",kind:"message",T:UpdateLocalAudioTrack$1,oneof:"message"},{no:18,name:"update_video_track",kind:"message",T:UpdateLocalVideoTrack$1,oneof:"message"}]),SignalResponse$1=proto3$1.makeMessageType("livekit.SignalResponse",()=>[{no:1,name:"join",kind:"message",T:JoinResponse$1,oneof:"message"},{no:2,name:"answer",kind:"message",T:SessionDescription$1,oneof:"message"},{no:3,name:"offer",kind:"message",T:SessionDescription$1,oneof:"message"},{no:4,name:"trickle",kind:"message",T:TrickleRequest$1,oneof:"message"},{no:5,name:"update",kind:"message",T:ParticipantUpdate$1,oneof:"message"},{no:6,name:"track_published",kind:"message",T:TrackPublishedResponse$1,oneof:"message"},{no:8,name:"leave",kind:"message",T:LeaveRequest$1,oneof:"message"},{no:9,name:"mute",kind:"message",T:MuteTrackRequest$1,oneof:"message"},{no:10,name:"speakers_changed",kind:"message",T:SpeakersChanged$1,oneof:"message"},{no:11,name:"room_update",kind:"message",T:RoomUpdate$1,oneof:"message"},{no:12,name:"connection_quality",kind:"message",T:ConnectionQualityUpdate$1,oneof:"message"},{no:13,name:"stream_state_update",kind:"message",T:StreamStateUpdate$1,oneof:"message"},{no:14,name:"subscribed_quality_update",kind:"message",T:SubscribedQualityUpdate$1,oneof:"message"},{no:15,name:"subscription_permission_update",kind:"message",T:SubscriptionPermissionUpdate$1,oneof:"message"},{no:16,name:"refresh_token",kind:"scalar",T:9,oneof:"message"},{no:17,name:"track_unpublished",kind:"message",T:TrackUnpublishedResponse$1,oneof:"message"},{no:18,name:"pong",kind:"scalar",T:3,oneof:"message"},{no:19,name:"reconnect",kind:"message",T:ReconnectResponse$1,oneof:"message"},{no:20,name:"pong_resp",kind:"message",T:Pong$1,oneof:"message"},{no:21,name:"subscription_response",kind:"message",T:SubscriptionResponse$1,oneof:"message"},{no:22,name:"request_response",kind:"message",T:RequestResponse$1,oneof:"message"},{no:23,name:"track_subscribed",kind:"message",T:TrackSubscribed$1,oneof:"message"}]),SimulcastCodec$1=proto3$1.makeMessageType("livekit.SimulcastCodec",()=>[{no:1,name:"codec",kind:"scalar",T:9},{no:2,name:"cid",kind:"scalar",T:9}]),AddTrackRequest$1=proto3$1.makeMessageType("livekit.AddTrackRequest",()=>[{no:1,name:"cid",kind:"scalar",T:9},{no:2,name:"name",kind:"scalar",T:9},{no:3,name:"type",kind:"enum",T:proto3$1.getEnumType(TrackType$1)},{no:4,name:"width",kind:"scalar",T:13},{no:5,name:"height",kind:"scalar",T:13},{no:6,name:"muted",kind:"scalar",T:8},{no:7,name:"disable_dtx",kind:"scalar",T:8},{no:8,name:"source",kind:"enum",T:proto3$1.getEnumType(TrackSource$1)},{no:9,name:"layers",kind:"message",T:VideoLayer$1,repeated:!0},{no:10,name:"simulcast_codecs",kind:"message",T:SimulcastCodec$1,repeated:!0},{no:11,name:"sid",kind:"scalar",T:9},{no:12,name:"stereo",kind:"scalar",T:8},{no:13,name:"disable_red",kind:"scalar",T:8},{no:14,name:"encryption",kind:"enum",T:proto3$1.getEnumType(Encryption_Type$1)},{no:15,name:"stream",kind:"scalar",T:9},{no:16,name:"backup_codec_policy",kind:"enum",T:proto3$1.getEnumType(BackupCodecPolicy$1$1)}]),TrickleRequest$1=proto3$1.makeMessageType("livekit.TrickleRequest",()=>[{no:1,name:"candidateInit",kind:"scalar",T:9},{no:2,name:"target",kind:"enum",T:proto3$1.getEnumType(SignalTarget$1)},{no:3,name:"final",kind:"scalar",T:8}]),MuteTrackRequest$1=proto3$1.makeMessageType("livekit.MuteTrackRequest",()=>[{no:1,name:"sid",kind:"scalar",T:9},{no:2,name:"muted",kind:"scalar",T:8}]),JoinResponse$1=proto3$1.makeMessageType("livekit.JoinResponse",()=>[{no:1,name:"room",kind:"message",T:Room$1$1},{no:2,name:"participant",kind:"message",T:ParticipantInfo$1},{no:3,name:"other_participants",kind:"message",T:ParticipantInfo$1,repeated:!0},{no:4,name:"server_version",kind:"scalar",T:9},{no:5,name:"ice_servers",kind:"message",T:ICEServer$1,repeated:!0},{no:6,name:"subscriber_primary",kind:"scalar",T:8},{no:7,name:"alternative_url",kind:"scalar",T:9},{no:8,name:"client_configuration",kind:"message",T:ClientConfiguration$1},{no:9,name:"server_region",kind:"scalar",T:9},{no:10,name:"ping_timeout",kind:"scalar",T:5},{no:11,name:"ping_interval",kind:"scalar",T:5},{no:12,name:"server_info",kind:"message",T:ServerInfo$1},{no:13,name:"sif_trailer",kind:"scalar",T:12},{no:14,name:"enabled_publish_codecs",kind:"message",T:Codec$1,repeated:!0},{no:15,name:"fast_publish",kind:"scalar",T:8}]),ReconnectResponse$1=proto3$1.makeMessageType("livekit.ReconnectResponse",()=>[{no:1,name:"ice_servers",kind:"message",T:ICEServer$1,repeated:!0},{no:2,name:"client_configuration",kind:"message",T:ClientConfiguration$1}]),TrackPublishedResponse$1=proto3$1.makeMessageType("livekit.TrackPublishedResponse",()=>[{no:1,name:"cid",kind:"scalar",T:9},{no:2,name:"track",kind:"message",T:TrackInfo$1}]),TrackUnpublishedResponse$1=proto3$1.makeMessageType("livekit.TrackUnpublishedResponse",()=>[{no:1,name:"track_sid",kind:"scalar",T:9}]),SessionDescription$1=proto3$1.makeMessageType("livekit.SessionDescription",()=>[{no:1,name:"type",kind:"scalar",T:9},{no:2,name:"sdp",kind:"scalar",T:9}]),ParticipantUpdate$1=proto3$1.makeMessageType("livekit.ParticipantUpdate",()=>[{no:1,name:"participants",kind:"message",T:ParticipantInfo$1,repeated:!0}]),UpdateSubscription$1=proto3$1.makeMessageType("livekit.UpdateSubscription",()=>[{no:1,name:"track_sids",kind:"scalar",T:9,repeated:!0},{no:2,name:"subscribe",kind:"scalar",T:8},{no:3,name:"participant_tracks",kind:"message",T:ParticipantTracks$1,repeated:!0}]),UpdateTrackSettings$1=proto3$1.makeMessageType("livekit.UpdateTrackSettings",()=>[{no:1,name:"track_sids",kind:"scalar",T:9,repeated:!0},{no:3,name:"disabled",kind:"scalar",T:8},{no:4,name:"quality",kind:"enum",T:proto3$1.getEnumType(VideoQuality$1$1)},{no:5,name:"width",kind:"scalar",T:13},{no:6,name:"height",kind:"scalar",T:13},{no:7,name:"fps",kind:"scalar",T:13},{no:8,name:"priority",kind:"scalar",T:13}]),UpdateLocalAudioTrack$1=proto3$1.makeMessageType("livekit.UpdateLocalAudioTrack",()=>[{no:1,name:"track_sid",kind:"scalar",T:9},{no:2,name:"features",kind:"enum",T:proto3$1.getEnumType(AudioTrackFeature$1),repeated:!0}]),UpdateLocalVideoTrack$1=proto3$1.makeMessageType("livekit.UpdateLocalVideoTrack",()=>[{no:1,name:"track_sid",kind:"scalar",T:9},{no:2,name:"width",kind:"scalar",T:13},{no:3,name:"height",kind:"scalar",T:13}]),LeaveRequest$1=proto3$1.makeMessageType("livekit.LeaveRequest",()=>[{no:1,name:"can_reconnect",kind:"scalar",T:8},{no:2,name:"reason",kind:"enum",T:proto3$1.getEnumType(DisconnectReason$1)},{no:3,name:"action",kind:"enum",T:proto3$1.getEnumType(LeaveRequest_Action$1)},{no:4,name:"regions",kind:"message",T:RegionSettings$1}]),LeaveRequest_Action$1=proto3$1.makeEnum("livekit.LeaveRequest.Action",[{no:0,name:"DISCONNECT"},{no:1,name:"RESUME"},{no:2,name:"RECONNECT"}]),UpdateVideoLayers$1=proto3$1.makeMessageType("livekit.UpdateVideoLayers",()=>[{no:1,name:"track_sid",kind:"scalar",T:9},{no:2,name:"layers",kind:"message",T:VideoLayer$1,repeated:!0}]),UpdateParticipantMetadata$1=proto3$1.makeMessageType("livekit.UpdateParticipantMetadata",()=>[{no:1,name:"metadata",kind:"scalar",T:9},{no:2,name:"name",kind:"scalar",T:9},{no:3,name:"attributes",kind:"map",K:9,V:{kind:"scalar",T:9}},{no:4,name:"request_id",kind:"scalar",T:13}]),ICEServer$1=proto3$1.makeMessageType("livekit.ICEServer",()=>[{no:1,name:"urls",kind:"scalar",T:9,repeated:!0},{no:2,name:"username",kind:"scalar",T:9},{no:3,name:"credential",kind:"scalar",T:9}]),SpeakersChanged$1=proto3$1.makeMessageType("livekit.SpeakersChanged",()=>[{no:1,name:"speakers",kind:"message",T:SpeakerInfo$1,repeated:!0}]),RoomUpdate$1=proto3$1.makeMessageType("livekit.RoomUpdate",()=>[{no:1,name:"room",kind:"message",T:Room$1$1}]),ConnectionQualityInfo$1=proto3$1.makeMessageType("livekit.ConnectionQualityInfo",()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:2,name:"quality",kind:"enum",T:proto3$1.getEnumType(ConnectionQuality$1$1)},{no:3,name:"score",kind:"scalar",T:2}]),ConnectionQualityUpdate$1=proto3$1.makeMessageType("livekit.ConnectionQualityUpdate",()=>[{no:1,name:"updates",kind:"message",T:ConnectionQualityInfo$1,repeated:!0}]),StreamStateInfo$1=proto3$1.makeMessageType("livekit.StreamStateInfo",()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:2,name:"track_sid",kind:"scalar",T:9},{no:3,name:"state",kind:"enum",T:proto3$1.getEnumType(StreamState$1)}]),StreamStateUpdate$1=proto3$1.makeMessageType("livekit.StreamStateUpdate",()=>[{no:1,name:"stream_states",kind:"message",T:StreamStateInfo$1,repeated:!0}]),SubscribedQuality$1=proto3$1.makeMessageType("livekit.SubscribedQuality",()=>[{no:1,name:"quality",kind:"enum",T:proto3$1.getEnumType(VideoQuality$1$1)},{no:2,name:"enabled",kind:"scalar",T:8}]),SubscribedCodec$1=proto3$1.makeMessageType("livekit.SubscribedCodec",()=>[{no:1,name:"codec",kind:"scalar",T:9},{no:2,name:"qualities",kind:"message",T:SubscribedQuality$1,repeated:!0}]),SubscribedQualityUpdate$1=proto3$1.makeMessageType("livekit.SubscribedQualityUpdate",()=>[{no:1,name:"track_sid",kind:"scalar",T:9},{no:2,name:"subscribed_qualities",kind:"message",T:SubscribedQuality$1,repeated:!0},{no:3,name:"subscribed_codecs",kind:"message",T:SubscribedCodec$1,repeated:!0}]),TrackPermission$1=proto3$1.makeMessageType("livekit.TrackPermission",()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:2,name:"all_tracks",kind:"scalar",T:8},{no:3,name:"track_sids",kind:"scalar",T:9,repeated:!0},{no:4,name:"participant_identity",kind:"scalar",T:9}]),SubscriptionPermission$1=proto3$1.makeMessageType("livekit.SubscriptionPermission",()=>[{no:1,name:"all_participants",kind:"scalar",T:8},{no:2,name:"track_permissions",kind:"message",T:TrackPermission$1,repeated:!0}]),SubscriptionPermissionUpdate$1=proto3$1.makeMessageType("livekit.SubscriptionPermissionUpdate",()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:2,name:"track_sid",kind:"scalar",T:9},{no:3,name:"allowed",kind:"scalar",T:8}]),SyncState$1=proto3$1.makeMessageType("livekit.SyncState",()=>[{no:1,name:"answer",kind:"message",T:SessionDescription$1},{no:2,name:"subscription",kind:"message",T:UpdateSubscription$1},{no:3,name:"publish_tracks",kind:"message",T:TrackPublishedResponse$1,repeated:!0},{no:4,name:"data_channels",kind:"message",T:DataChannelInfo$1,repeated:!0},{no:5,name:"offer",kind:"message",T:SessionDescription$1},{no:6,name:"track_sids_disabled",kind:"scalar",T:9,repeated:!0}]),DataChannelInfo$1=proto3$1.makeMessageType("livekit.DataChannelInfo",()=>[{no:1,name:"label",kind:"scalar",T:9},{no:2,name:"id",kind:"scalar",T:13},{no:3,name:"target",kind:"enum",T:proto3$1.getEnumType(SignalTarget$1)}]),SimulateScenario$1=proto3$1.makeMessageType("livekit.SimulateScenario",()=>[{no:1,name:"speaker_update",kind:"scalar",T:5,oneof:"scenario"},{no:2,name:"node_failure",kind:"scalar",T:8,oneof:"scenario"},{no:3,name:"migration",kind:"scalar",T:8,oneof:"scenario"},{no:4,name:"server_leave",kind:"scalar",T:8,oneof:"scenario"},{no:5,name:"switch_candidate_protocol",kind:"enum",T:proto3$1.getEnumType(CandidateProtocol$1),oneof:"scenario"},{no:6,name:"subscriber_bandwidth",kind:"scalar",T:3,oneof:"scenario"},{no:7,name:"disconnect_signal_on_resume",kind:"scalar",T:8,oneof:"scenario"},{no:8,name:"disconnect_signal_on_resume_no_messages",kind:"scalar",T:8,oneof:"scenario"},{no:9,name:"leave_request_full_reconnect",kind:"scalar",T:8,oneof:"scenario"}]),Ping$1=proto3$1.makeMessageType("livekit.Ping",()=>[{no:1,name:"timestamp",kind:"scalar",T:3},{no:2,name:"rtt",kind:"scalar",T:3}]),Pong$1=proto3$1.makeMessageType("livekit.Pong",()=>[{no:1,name:"last_ping_timestamp",kind:"scalar",T:3},{no:2,name:"timestamp",kind:"scalar",T:3}]),RegionSettings$1=proto3$1.makeMessageType("livekit.RegionSettings",()=>[{no:1,name:"regions",kind:"message",T:RegionInfo$1,repeated:!0}]),RegionInfo$1=proto3$1.makeMessageType("livekit.RegionInfo",()=>[{no:1,name:"region",kind:"scalar",T:9},{no:2,name:"url",kind:"scalar",T:9},{no:3,name:"distance",kind:"scalar",T:3}]),SubscriptionResponse$1=proto3$1.makeMessageType("livekit.SubscriptionResponse",()=>[{no:1,name:"track_sid",kind:"scalar",T:9},{no:2,name:"err",kind:"enum",T:proto3$1.getEnumType(SubscriptionError$1)}]),RequestResponse$1=proto3$1.makeMessageType("livekit.RequestResponse",()=>[{no:1,name:"request_id",kind:"scalar",T:13},{no:2,name:"reason",kind:"enum",T:proto3$1.getEnumType(RequestResponse_Reason$1)},{no:3,name:"message",kind:"scalar",T:9}]),RequestResponse_Reason$1=proto3$1.makeEnum("livekit.RequestResponse.Reason",[{no:0,name:"OK"},{no:1,name:"NOT_FOUND"},{no:2,name:"NOT_ALLOWED"},{no:3,name:"LIMIT_EXCEEDED"}]),TrackSubscribed$1=proto3$1.makeMessageType("livekit.TrackSubscribed",()=>[{no:1,name:"track_sid",kind:"scalar",T:9}]);function getDefaultExportFromCjs$2(B){return B&&B.__esModule&&Object.prototype.hasOwnProperty.call(B,"default")?B.default:B}var loglevel$1$1={exports:{}},loglevel$2=loglevel$1$1.exports,hasRequiredLoglevel$1;function requireLoglevel$1(){return hasRequiredLoglevel$1||(hasRequiredLoglevel$1=1,(function(B){(function($,U){B.exports?B.exports=U():$.log=U()})(loglevel$2,function(){var $=function(){},U="undefined",F=typeof window!==U&&typeof window.navigator!==U&&/Trident\/|MSIE /.test(window.navigator.userAgent),V=["trace","debug","info","warn","error"],q={},j=null;function W(Z,ne){var ee=Z[ne];if(typeof ee.bind=="function")return ee.bind(Z);try{return Function.prototype.bind.call(ee,Z)}catch{return function(){return Function.prototype.apply.apply(ee,[Z,arguments])}}}function K(){console.log&&(console.log.apply?console.log.apply(console,arguments):Function.prototype.apply.apply(console.log,[console,arguments])),console.trace&&console.trace()}function G(Z){return Z==="debug"&&(Z="log"),typeof console===U?!1:Z==="trace"&&F?K:console[Z]!==void 0?W(console,Z):console.log!==void 0?W(console,"log"):$}function z(){for(var Z=this.getLevel(),ne=0;ne<V.length;ne++){var ee=V[ne];this[ee]=ne<Z?$:this.methodFactory(ee,Z,this.name)}if(this.log=this.debug,typeof console===U&&Z<this.levels.SILENT)return"No console available for logging"}function H(Z){return function(){typeof console!==U&&(z.call(this),this[Z].apply(this,arguments))}}function Q(Z,ne,ee){return G(Z)||H.apply(this,arguments)}function Y(Z,ne){var ee=this,ie,se,te,re="loglevel";typeof Z=="string"?re+=":"+Z:typeof Z=="symbol"&&(re=void 0);function ae(oe){var me=(V[oe]||"silent").toUpperCase();if(!(typeof window===U||!re)){try{window.localStorage[re]=me;return}catch{}try{window.document.cookie=encodeURIComponent(re)+"="+me+";"}catch{}}}function ce(){var oe;if(!(typeof window===U||!re)){try{oe=window.localStorage[re]}catch{}if(typeof oe===U)try{var me=window.document.cookie,be=encodeURIComponent(re),ge=me.indexOf(be+"=");ge!==-1&&(oe=/^([^;]+)/.exec(me.slice(ge+be.length+1))[1])}catch{}return ee.levels[oe]===void 0&&(oe=void 0),oe}}function le(){if(!(typeof window===U||!re)){try{window.localStorage.removeItem(re)}catch{}try{window.document.cookie=encodeURIComponent(re)+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC"}catch{}}}function de(oe){var me=oe;if(typeof me=="string"&&ee.levels[me.toUpperCase()]!==void 0&&(me=ee.levels[me.toUpperCase()]),typeof me=="number"&&me>=0&&me<=ee.levels.SILENT)return me;throw new TypeError("log.setLevel() called with invalid level: "+oe)}ee.name=Z,ee.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},ee.methodFactory=ne||Q,ee.getLevel=function(){return te??se??ie},ee.setLevel=function(oe,me){return te=de(oe),me!==!1&&ae(te),z.call(ee)},ee.setDefaultLevel=function(oe){se=de(oe),ce()||ee.setLevel(oe,!1)},ee.resetLevel=function(){te=null,le(),z.call(ee)},ee.enableAll=function(oe){ee.setLevel(ee.levels.TRACE,oe)},ee.disableAll=function(oe){ee.setLevel(ee.levels.SILENT,oe)},ee.rebuild=function(){if(j!==ee&&(ie=de(j.getLevel())),z.call(ee),j===ee)for(var oe in q)q[oe].rebuild()},ie=de(j?j.getLevel():"WARN");var ue=ce();ue!=null&&(te=de(ue)),z.call(ee)}j=new Y,j.getLogger=function(ne){if(typeof ne!="symbol"&&typeof ne!="string"||ne==="")throw new TypeError("You must supply a name when creating a logger.");var ee=q[ne];return ee||(ee=q[ne]=new Y(ne,j.methodFactory)),ee};var X=typeof window!==U?window.log:void 0;return j.noConflict=function(){return typeof window!==U&&window.log===j&&(window.log=X),j},j.getLoggers=function(){return q},j.default=j,j})})(loglevel$1$1)),loglevel$1$1.exports}var loglevelExports$1=requireLoglevel$1(),LogLevel$1;(function(B){B[B.trace=0]="trace",B[B.debug=1]="debug",B[B.info=2]="info",B[B.warn=3]="warn",B[B.error=4]="error",B[B.silent=5]="silent"})(LogLevel$1||(LogLevel$1={}));var LoggerNames$1;(function(B){B.Default="livekit",B.Room="livekit-room",B.Participant="livekit-participant",B.Track="livekit-track",B.Publication="livekit-track-publication",B.Engine="livekit-engine",B.Signal="livekit-signal",B.PCManager="livekit-pc-manager",B.PCTransport="livekit-pc-transport",B.E2EE="lk-e2ee"})(LoggerNames$1||(LoggerNames$1={}));let livekitLogger$1=loglevelExports$1.getLogger("livekit");Object.values(LoggerNames$1).map(B=>loglevelExports$1.getLogger(B)),livekitLogger$1.setDefaultLevel(LogLevel$1.info);function getLogger$1(B){const $=loglevelExports$1.getLogger(B);return $.setDefaultLevel(livekitLogger$1.getLevel()),$}const workerLogger$1=loglevelExports$1.getLogger("lk-e2ee"),maxRetryDelay$1=7e3,DEFAULT_RETRY_DELAYS_IN_MS$1=[0,300,4*300,9*300,16*300,maxRetryDelay$1,maxRetryDelay$1,maxRetryDelay$1,maxRetryDelay$1,maxRetryDelay$1];let DefaultReconnectPolicy$1=class{constructor($){this._retryDelays=$!==void 0?[...$]:DEFAULT_RETRY_DELAYS_IN_MS$1}nextRetryDelayInMs($){if($.retryCount>=this._retryDelays.length)return null;const U=this._retryDelays[$.retryCount];return $.retryCount<=1?U:U+Math.random()*1e3}};function __rest$1(B,$){var U={};for(var F in B)Object.prototype.hasOwnProperty.call(B,F)&&$.indexOf(F)<0&&(U[F]=B[F]);if(B!=null&&typeof Object.getOwnPropertySymbols=="function")for(var V=0,F=Object.getOwnPropertySymbols(B);V<F.length;V++)$.indexOf(F[V])<0&&Object.prototype.propertyIsEnumerable.call(B,F[V])&&(U[F[V]]=B[F[V]]);return U}function __awaiter$2(B,$,U,F){function V(q){return q instanceof U?q:new U(function(j){j(q)})}return new(U||(U=Promise))(function(q,j){function W(z){try{G(F.next(z))}catch(H){j(H)}}function K(z){try{G(F.throw(z))}catch(H){j(H)}}function G(z){z.done?q(z.value):V(z.value).then(W,K)}G((F=F.apply(B,$||[])).next())})}function __values$1(B){var $=typeof Symbol=="function"&&Symbol.iterator,U=$&&B[$],F=0;if(U)return U.call(B);if(B&&typeof B.length=="number")return{next:function(){return B&&F>=B.length&&(B=void 0),{value:B&&B[F++],done:!B}}};throw new TypeError($?"Object is not iterable.":"Symbol.iterator is not defined.")}function __asyncValues$1(B){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var $=B[Symbol.asyncIterator],U;return $?$.call(B):(B=typeof __values$1=="function"?__values$1(B):B[Symbol.iterator](),U={},F("next"),F("throw"),F("return"),U[Symbol.asyncIterator]=function(){return this},U);function F(q){U[q]=B[q]&&function(j){return new Promise(function(W,K){j=B[q](j),V(W,K,j.done,j.value)})}}function V(q,j,W,K){Promise.resolve(K).then(function(G){q({value:G,done:W})},j)}}typeof SuppressedError=="function"&&SuppressedError;var events$1={exports:{}},hasRequiredEvents$1;function requireEvents$1(){if(hasRequiredEvents$1)return events$1.exports;hasRequiredEvents$1=1;var B=typeof Reflect=="object"?Reflect:null,$=B&&typeof B.apply=="function"?B.apply:function(re,ae,ce){return Function.prototype.apply.call(re,ae,ce)},U;B&&typeof B.ownKeys=="function"?U=B.ownKeys:Object.getOwnPropertySymbols?U=function(re){return Object.getOwnPropertyNames(re).concat(Object.getOwnPropertySymbols(re))}:U=function(re){return Object.getOwnPropertyNames(re)};function F(te){console&&console.warn&&console.warn(te)}var V=Number.isNaN||function(re){return re!==re};function q(){q.init.call(this)}events$1.exports=q,events$1.exports.once=ee,q.EventEmitter=q,q.prototype._events=void 0,q.prototype._eventsCount=0,q.prototype._maxListeners=void 0;var j=10;function W(te){if(typeof te!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof te)}Object.defineProperty(q,"defaultMaxListeners",{enumerable:!0,get:function(){return j},set:function(te){if(typeof te!="number"||te<0||V(te))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+te+".");j=te}}),q.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},q.prototype.setMaxListeners=function(re){if(typeof re!="number"||re<0||V(re))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+re+".");return this._maxListeners=re,this};function K(te){return te._maxListeners===void 0?q.defaultMaxListeners:te._maxListeners}q.prototype.getMaxListeners=function(){return K(this)},q.prototype.emit=function(re){for(var ae=[],ce=1;ce<arguments.length;ce++)ae.push(arguments[ce]);var le=re==="error",de=this._events;if(de!==void 0)le=le&&de.error===void 0;else if(!le)return!1;if(le){var ue;if(ae.length>0&&(ue=ae[0]),ue instanceof Error)throw ue;var oe=new Error("Unhandled error."+(ue?" ("+ue.message+")":""));throw oe.context=ue,oe}var me=de[re];if(me===void 0)return!1;if(typeof me=="function")$(me,this,ae);else for(var be=me.length,ge=X(me,be),ce=0;ce<be;++ce)$(ge[ce],this,ae);return!0};function G(te,re,ae,ce){var le,de,ue;if(W(ae),de=te._events,de===void 0?(de=te._events=Object.create(null),te._eventsCount=0):(de.newListener!==void 0&&(te.emit("newListener",re,ae.listener?ae.listener:ae),de=te._events),ue=de[re]),ue===void 0)ue=de[re]=ae,++te._eventsCount;else if(typeof ue=="function"?ue=de[re]=ce?[ae,ue]:[ue,ae]:ce?ue.unshift(ae):ue.push(ae),le=K(te),le>0&&ue.length>le&&!ue.warned){ue.warned=!0;var oe=new Error("Possible EventEmitter memory leak detected. "+ue.length+" "+String(re)+" listeners added. Use emitter.setMaxListeners() to increase limit");oe.name="MaxListenersExceededWarning",oe.emitter=te,oe.type=re,oe.count=ue.length,F(oe)}return te}q.prototype.addListener=function(re,ae){return G(this,re,ae,!1)},q.prototype.on=q.prototype.addListener,q.prototype.prependListener=function(re,ae){return G(this,re,ae,!0)};function z(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function H(te,re,ae){var ce={fired:!1,wrapFn:void 0,target:te,type:re,listener:ae},le=z.bind(ce);return le.listener=ae,ce.wrapFn=le,le}q.prototype.once=function(re,ae){return W(ae),this.on(re,H(this,re,ae)),this},q.prototype.prependOnceListener=function(re,ae){return W(ae),this.prependListener(re,H(this,re,ae)),this},q.prototype.removeListener=function(re,ae){var ce,le,de,ue,oe;if(W(ae),le=this._events,le===void 0)return this;if(ce=le[re],ce===void 0)return this;if(ce===ae||ce.listener===ae)--this._eventsCount===0?this._events=Object.create(null):(delete le[re],le.removeListener&&this.emit("removeListener",re,ce.listener||ae));else if(typeof ce!="function"){for(de=-1,ue=ce.length-1;ue>=0;ue--)if(ce[ue]===ae||ce[ue].listener===ae){oe=ce[ue].listener,de=ue;break}if(de<0)return this;de===0?ce.shift():Z(ce,de),ce.length===1&&(le[re]=ce[0]),le.removeListener!==void 0&&this.emit("removeListener",re,oe||ae)}return this},q.prototype.off=q.prototype.removeListener,q.prototype.removeAllListeners=function(re){var ae,ce,le;if(ce=this._events,ce===void 0)return this;if(ce.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):ce[re]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete ce[re]),this;if(arguments.length===0){var de=Object.keys(ce),ue;for(le=0;le<de.length;++le)ue=de[le],ue!=="removeListener"&&this.removeAllListeners(ue);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(ae=ce[re],typeof ae=="function")this.removeListener(re,ae);else if(ae!==void 0)for(le=ae.length-1;le>=0;le--)this.removeListener(re,ae[le]);return this};function Q(te,re,ae){var ce=te._events;if(ce===void 0)return[];var le=ce[re];return le===void 0?[]:typeof le=="function"?ae?[le.listener||le]:[le]:ae?ne(le):X(le,le.length)}q.prototype.listeners=function(re){return Q(this,re,!0)},q.prototype.rawListeners=function(re){return Q(this,re,!1)},q.listenerCount=function(te,re){return typeof te.listenerCount=="function"?te.listenerCount(re):Y.call(te,re)},q.prototype.listenerCount=Y;function Y(te){var re=this._events;if(re!==void 0){var ae=re[te];if(typeof ae=="function")return 1;if(ae!==void 0)return ae.length}return 0}q.prototype.eventNames=function(){return this._eventsCount>0?U(this._events):[]};function X(te,re){for(var ae=new Array(re),ce=0;ce<re;++ce)ae[ce]=te[ce];return ae}function Z(te,re){for(;re+1<te.length;re++)te[re]=te[re+1];te.pop()}function ne(te){for(var re=new Array(te.length),ae=0;ae<re.length;++ae)re[ae]=te[ae].listener||te[ae];return re}function ee(te,re){return new Promise(function(ae,ce){function le(ue){te.removeListener(re,de),ce(ue)}function de(){typeof te.removeListener=="function"&&te.removeListener("error",le),ae([].slice.call(arguments))}se(te,re,de,{once:!0}),re!=="error"&&ie(te,le,{once:!0})})}function ie(te,re,ae){typeof te.on=="function"&&se(te,"error",re,ae)}function se(te,re,ae,ce){if(typeof te.on=="function")ce.once?te.once(re,ae):te.on(re,ae);else if(typeof te.addEventListener=="function")te.addEventListener(re,function le(de){ce.once&&te.removeEventListener(re,le),ae(de)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof te)}return events$1.exports}var eventsExports$1=requireEvents$1();let logDisabled_$1=!0,deprecationWarnings_$1=!0;function extractVersion$1(B,$,U){const F=B.match($);return F&&F.length>=U&&parseInt(F[U],10)}function wrapPeerConnectionEvent$1(B,$,U){if(!B.RTCPeerConnection)return;const F=B.RTCPeerConnection.prototype,V=F.addEventListener;F.addEventListener=function(j,W){if(j!==$)return V.apply(this,arguments);const K=G=>{const z=U(G);z&&(W.handleEvent?W.handleEvent(z):W(z))};return this._eventMap=this._eventMap||{},this._eventMap[$]||(this._eventMap[$]=new Map),this._eventMap[$].set(W,K),V.apply(this,[j,K])};const q=F.removeEventListener;F.removeEventListener=function(j,W){if(j!==$||!this._eventMap||!this._eventMap[$])return q.apply(this,arguments);if(!this._eventMap[$].has(W))return q.apply(this,arguments);const K=this._eventMap[$].get(W);return this._eventMap[$].delete(W),this._eventMap[$].size===0&&delete this._eventMap[$],Object.keys(this._eventMap).length===0&&delete this._eventMap,q.apply(this,[j,K])},Object.defineProperty(F,"on"+$,{get(){return this["_on"+$]},set(j){this["_on"+$]&&(this.removeEventListener($,this["_on"+$]),delete this["_on"+$]),j&&this.addEventListener($,this["_on"+$]=j)},enumerable:!0,configurable:!0})}function disableLog$1(B){return typeof B!="boolean"?new Error("Argument type: "+typeof B+". Please use a boolean."):(logDisabled_$1=B,B?"adapter.js logging disabled":"adapter.js logging enabled")}function disableWarnings$1(B){return typeof B!="boolean"?new Error("Argument type: "+typeof B+". Please use a boolean."):(deprecationWarnings_$1=!B,"adapter.js deprecation warnings "+(B?"disabled":"enabled"))}function log$1(){if(typeof window=="object"){if(logDisabled_$1)return;typeof console<"u"&&typeof console.log=="function"&&console.log.apply(console,arguments)}}function deprecated$1(B,$){deprecationWarnings_$1&&console.warn(B+" is deprecated, please use "+$+" instead.")}function detectBrowser$1(B){const $={browser:null,version:null};if(typeof B>"u"||!B.navigator||!B.navigator.userAgent)return $.browser="Not a browser.",$;const{navigator:U}=B;if(U.userAgentData&&U.userAgentData.brands){const F=U.userAgentData.brands.find(V=>V.brand==="Chromium");if(F)return{browser:"chrome",version:parseInt(F.version,10)}}if(U.mozGetUserMedia)$.browser="firefox",$.version=extractVersion$1(U.userAgent,/Firefox\/(\d+)\./,1);else if(U.webkitGetUserMedia||B.isSecureContext===!1&&B.webkitRTCPeerConnection)$.browser="chrome",$.version=extractVersion$1(U.userAgent,/Chrom(e|ium)\/(\d+)\./,2);else if(B.RTCPeerConnection&&U.userAgent.match(/AppleWebKit\/(\d+)\./))$.browser="safari",$.version=extractVersion$1(U.userAgent,/AppleWebKit\/(\d+)\./,1),$.supportsUnifiedPlan=B.RTCRtpTransceiver&&"currentDirection"in B.RTCRtpTransceiver.prototype;else return $.browser="Not a supported browser.",$;return $}function isObject$1(B){return Object.prototype.toString.call(B)==="[object Object]"}function compactObject$1(B){return isObject$1(B)?Object.keys(B).reduce(function($,U){const F=isObject$1(B[U]),V=F?compactObject$1(B[U]):B[U],q=F&&!Object.keys(V).length;return V===void 0||q?$:Object.assign($,{[U]:V})},{}):B}function walkStats$1(B,$,U){!$||U.has($.id)||(U.set($.id,$),Object.keys($).forEach(F=>{F.endsWith("Id")?walkStats$1(B,B.get($[F]),U):F.endsWith("Ids")&&$[F].forEach(V=>{walkStats$1(B,B.get(V),U)})}))}function filterStats$1(B,$,U){const F=U?"outbound-rtp":"inbound-rtp",V=new Map;if($===null)return V;const q=[];return B.forEach(j=>{j.type==="track"&&j.trackIdentifier===$.id&&q.push(j)}),q.forEach(j=>{B.forEach(W=>{W.type===F&&W.trackId===j.id&&walkStats$1(B,W,V)})}),V}const logging$1=log$1;function shimGetUserMedia$2$1(B,$){const U=B&&B.navigator;if(!U.mediaDevices)return;const F=function(W){if(typeof W!="object"||W.mandatory||W.optional)return W;const K={};return Object.keys(W).forEach(G=>{if(G==="require"||G==="advanced"||G==="mediaSource")return;const z=typeof W[G]=="object"?W[G]:{ideal:W[G]};z.exact!==void 0&&typeof z.exact=="number"&&(z.min=z.max=z.exact);const H=function(Q,Y){return Q?Q+Y.charAt(0).toUpperCase()+Y.slice(1):Y==="deviceId"?"sourceId":Y};if(z.ideal!==void 0){K.optional=K.optional||[];let Q={};typeof z.ideal=="number"?(Q[H("min",G)]=z.ideal,K.optional.push(Q),Q={},Q[H("max",G)]=z.ideal,K.optional.push(Q)):(Q[H("",G)]=z.ideal,K.optional.push(Q))}z.exact!==void 0&&typeof z.exact!="number"?(K.mandatory=K.mandatory||{},K.mandatory[H("",G)]=z.exact):["min","max"].forEach(Q=>{z[Q]!==void 0&&(K.mandatory=K.mandatory||{},K.mandatory[H(Q,G)]=z[Q])})}),W.advanced&&(K.optional=(K.optional||[]).concat(W.advanced)),K},V=function(W,K){if($.version>=61)return K(W);if(W=JSON.parse(JSON.stringify(W)),W&&typeof W.audio=="object"){const G=function(z,H,Q){H in z&&!(Q in z)&&(z[Q]=z[H],delete z[H])};W=JSON.parse(JSON.stringify(W)),G(W.audio,"autoGainControl","googAutoGainControl"),G(W.audio,"noiseSuppression","googNoiseSuppression"),W.audio=F(W.audio)}if(W&&typeof W.video=="object"){let G=W.video.facingMode;G=G&&(typeof G=="object"?G:{ideal:G});const z=$.version<66;if(G&&(G.exact==="user"||G.exact==="environment"||G.ideal==="user"||G.ideal==="environment")&&!(U.mediaDevices.getSupportedConstraints&&U.mediaDevices.getSupportedConstraints().facingMode&&!z)){delete W.video.facingMode;let H;if(G.exact==="environment"||G.ideal==="environment"?H=["back","rear"]:(G.exact==="user"||G.ideal==="user")&&(H=["front"]),H)return U.mediaDevices.enumerateDevices().then(Q=>{Q=Q.filter(X=>X.kind==="videoinput");let Y=Q.find(X=>H.some(Z=>X.label.toLowerCase().includes(Z)));return!Y&&Q.length&&H.includes("back")&&(Y=Q[Q.length-1]),Y&&(W.video.deviceId=G.exact?{exact:Y.deviceId}:{ideal:Y.deviceId}),W.video=F(W.video),logging$1("chrome: "+JSON.stringify(W)),K(W)})}W.video=F(W.video)}return logging$1("chrome: "+JSON.stringify(W)),K(W)},q=function(W){return $.version>=64?W:{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[W.name]||W.name,message:W.message,constraint:W.constraint||W.constraintName,toString(){return this.name+(this.message&&": ")+this.message}}},j=function(W,K,G){V(W,z=>{U.webkitGetUserMedia(z,K,H=>{G&&G(q(H))})})};if(U.getUserMedia=j.bind(U),U.mediaDevices.getUserMedia){const W=U.mediaDevices.getUserMedia.bind(U.mediaDevices);U.mediaDevices.getUserMedia=function(K){return V(K,G=>W(G).then(z=>{if(G.audio&&!z.getAudioTracks().length||G.video&&!z.getVideoTracks().length)throw z.getTracks().forEach(H=>{H.stop()}),new DOMException("","NotFoundError");return z},z=>Promise.reject(q(z))))}}}function shimMediaStream$1(B){B.MediaStream=B.MediaStream||B.webkitMediaStream}function shimOnTrack$1$1(B){if(typeof B=="object"&&B.RTCPeerConnection&&!("ontrack"in B.RTCPeerConnection.prototype)){Object.defineProperty(B.RTCPeerConnection.prototype,"ontrack",{get(){return this._ontrack},set(U){this._ontrack&&this.removeEventListener("track",this._ontrack),this.addEventListener("track",this._ontrack=U)},enumerable:!0,configurable:!0});const $=B.RTCPeerConnection.prototype.setRemoteDescription;B.RTCPeerConnection.prototype.setRemoteDescription=function(){return this._ontrackpoly||(this._ontrackpoly=F=>{F.stream.addEventListener("addtrack",V=>{let q;B.RTCPeerConnection.prototype.getReceivers?q=this.getReceivers().find(W=>W.track&&W.track.id===V.track.id):q={track:V.track};const j=new Event("track");j.track=V.track,j.receiver=q,j.transceiver={receiver:q},j.streams=[F.stream],this.dispatchEvent(j)}),F.stream.getTracks().forEach(V=>{let q;B.RTCPeerConnection.prototype.getReceivers?q=this.getReceivers().find(W=>W.track&&W.track.id===V.id):q={track:V};const j=new Event("track");j.track=V,j.receiver=q,j.transceiver={receiver:q},j.streams=[F.stream],this.dispatchEvent(j)})},this.addEventListener("addstream",this._ontrackpoly)),$.apply(this,arguments)}}else wrapPeerConnectionEvent$1(B,"track",$=>($.transceiver||Object.defineProperty($,"transceiver",{value:{receiver:$.receiver}}),$))}function shimGetSendersWithDtmf$1(B){if(typeof B=="object"&&B.RTCPeerConnection&&!("getSenders"in B.RTCPeerConnection.prototype)&&"createDTMFSender"in B.RTCPeerConnection.prototype){const $=function(V,q){return{track:q,get dtmf(){return this._dtmf===void 0&&(q.kind==="audio"?this._dtmf=V.createDTMFSender(q):this._dtmf=null),this._dtmf},_pc:V}};if(!B.RTCPeerConnection.prototype.getSenders){B.RTCPeerConnection.prototype.getSenders=function(){return this._senders=this._senders||[],this._senders.slice()};const V=B.RTCPeerConnection.prototype.addTrack;B.RTCPeerConnection.prototype.addTrack=function(W,K){let G=V.apply(this,arguments);return G||(G=$(this,W),this._senders.push(G)),G};const q=B.RTCPeerConnection.prototype.removeTrack;B.RTCPeerConnection.prototype.removeTrack=function(W){q.apply(this,arguments);const K=this._senders.indexOf(W);K!==-1&&this._senders.splice(K,1)}}const U=B.RTCPeerConnection.prototype.addStream;B.RTCPeerConnection.prototype.addStream=function(q){this._senders=this._senders||[],U.apply(this,[q]),q.getTracks().forEach(j=>{this._senders.push($(this,j))})};const F=B.RTCPeerConnection.prototype.removeStream;B.RTCPeerConnection.prototype.removeStream=function(q){this._senders=this._senders||[],F.apply(this,[q]),q.getTracks().forEach(j=>{const W=this._senders.find(K=>K.track===j);W&&this._senders.splice(this._senders.indexOf(W),1)})}}else if(typeof B=="object"&&B.RTCPeerConnection&&"getSenders"in B.RTCPeerConnection.prototype&&"createDTMFSender"in B.RTCPeerConnection.prototype&&B.RTCRtpSender&&!("dtmf"in B.RTCRtpSender.prototype)){const $=B.RTCPeerConnection.prototype.getSenders;B.RTCPeerConnection.prototype.getSenders=function(){const F=$.apply(this,[]);return F.forEach(V=>V._pc=this),F},Object.defineProperty(B.RTCRtpSender.prototype,"dtmf",{get(){return this._dtmf===void 0&&(this.track.kind==="audio"?this._dtmf=this._pc.createDTMFSender(this.track):this._dtmf=null),this._dtmf}})}}function shimSenderReceiverGetStats$1(B){if(!(typeof B=="object"&&B.RTCPeerConnection&&B.RTCRtpSender&&B.RTCRtpReceiver))return;if(!("getStats"in B.RTCRtpSender.prototype)){const U=B.RTCPeerConnection.prototype.getSenders;U&&(B.RTCPeerConnection.prototype.getSenders=function(){const q=U.apply(this,[]);return q.forEach(j=>j._pc=this),q});const F=B.RTCPeerConnection.prototype.addTrack;F&&(B.RTCPeerConnection.prototype.addTrack=function(){const q=F.apply(this,arguments);return q._pc=this,q}),B.RTCRtpSender.prototype.getStats=function(){const q=this;return this._pc.getStats().then(j=>filterStats$1(j,q.track,!0))}}if(!("getStats"in B.RTCRtpReceiver.prototype)){const U=B.RTCPeerConnection.prototype.getReceivers;U&&(B.RTCPeerConnection.prototype.getReceivers=function(){const V=U.apply(this,[]);return V.forEach(q=>q._pc=this),V}),wrapPeerConnectionEvent$1(B,"track",F=>(F.receiver._pc=F.srcElement,F)),B.RTCRtpReceiver.prototype.getStats=function(){const V=this;return this._pc.getStats().then(q=>filterStats$1(q,V.track,!1))}}if(!("getStats"in B.RTCRtpSender.prototype&&"getStats"in B.RTCRtpReceiver.prototype))return;const $=B.RTCPeerConnection.prototype.getStats;B.RTCPeerConnection.prototype.getStats=function(){if(arguments.length>0&&arguments[0]instanceof B.MediaStreamTrack){const F=arguments[0];let V,q,j;return this.getSenders().forEach(W=>{W.track===F&&(V?j=!0:V=W)}),this.getReceivers().forEach(W=>(W.track===F&&(q?j=!0:q=W),W.track===F)),j||V&&q?Promise.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError")):V?V.getStats():q?q.getStats():Promise.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return $.apply(this,arguments)}}function shimAddTrackRemoveTrackWithNative$1(B){B.RTCPeerConnection.prototype.getLocalStreams=function(){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},Object.keys(this._shimmedLocalStreams).map(j=>this._shimmedLocalStreams[j][0])};const $=B.RTCPeerConnection.prototype.addTrack;B.RTCPeerConnection.prototype.addTrack=function(j,W){if(!W)return $.apply(this,arguments);this._shimmedLocalStreams=this._shimmedLocalStreams||{};const K=$.apply(this,arguments);return this._shimmedLocalStreams[W.id]?this._shimmedLocalStreams[W.id].indexOf(K)===-1&&this._shimmedLocalStreams[W.id].push(K):this._shimmedLocalStreams[W.id]=[W,K],K};const U=B.RTCPeerConnection.prototype.addStream;B.RTCPeerConnection.prototype.addStream=function(j){this._shimmedLocalStreams=this._shimmedLocalStreams||{},j.getTracks().forEach(G=>{if(this.getSenders().find(H=>H.track===G))throw new DOMException("Track already exists.","InvalidAccessError")});const W=this.getSenders();U.apply(this,arguments);const K=this.getSenders().filter(G=>W.indexOf(G)===-1);this._shimmedLocalStreams[j.id]=[j].concat(K)};const F=B.RTCPeerConnection.prototype.removeStream;B.RTCPeerConnection.prototype.removeStream=function(j){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},delete this._shimmedLocalStreams[j.id],F.apply(this,arguments)};const V=B.RTCPeerConnection.prototype.removeTrack;B.RTCPeerConnection.prototype.removeTrack=function(j){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},j&&Object.keys(this._shimmedLocalStreams).forEach(W=>{const K=this._shimmedLocalStreams[W].indexOf(j);K!==-1&&this._shimmedLocalStreams[W].splice(K,1),this._shimmedLocalStreams[W].length===1&&delete this._shimmedLocalStreams[W]}),V.apply(this,arguments)}}function shimAddTrackRemoveTrack$1(B,$){if(!B.RTCPeerConnection)return;if(B.RTCPeerConnection.prototype.addTrack&&$.version>=65)return shimAddTrackRemoveTrackWithNative$1(B);const U=B.RTCPeerConnection.prototype.getLocalStreams;B.RTCPeerConnection.prototype.getLocalStreams=function(){const z=U.apply(this);return this._reverseStreams=this._reverseStreams||{},z.map(H=>this._reverseStreams[H.id])};const F=B.RTCPeerConnection.prototype.addStream;B.RTCPeerConnection.prototype.addStream=function(z){if(this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},z.getTracks().forEach(H=>{if(this.getSenders().find(Y=>Y.track===H))throw new DOMException("Track already exists.","InvalidAccessError")}),!this._reverseStreams[z.id]){const H=new B.MediaStream(z.getTracks());this._streams[z.id]=H,this._reverseStreams[H.id]=z,z=H}F.apply(this,[z])};const V=B.RTCPeerConnection.prototype.removeStream;B.RTCPeerConnection.prototype.removeStream=function(z){this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},V.apply(this,[this._streams[z.id]||z]),delete this._reverseStreams[this._streams[z.id]?this._streams[z.id].id:z.id],delete this._streams[z.id]},B.RTCPeerConnection.prototype.addTrack=function(z,H){if(this.signalingState==="closed")throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");const Q=[].slice.call(arguments,1);if(Q.length!==1||!Q[0].getTracks().find(Z=>Z===z))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");if(this.getSenders().find(Z=>Z.track===z))throw new DOMException("Track already exists.","InvalidAccessError");this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{};const X=this._streams[H.id];if(X)X.addTrack(z),Promise.resolve().then(()=>{this.dispatchEvent(new Event("negotiationneeded"))});else{const Z=new B.MediaStream([z]);this._streams[H.id]=Z,this._reverseStreams[Z.id]=H,this.addStream(Z)}return this.getSenders().find(Z=>Z.track===z)};function q(G,z){let H=z.sdp;return Object.keys(G._reverseStreams||[]).forEach(Q=>{const Y=G._reverseStreams[Q],X=G._streams[Y.id];H=H.replace(new RegExp(X.id,"g"),Y.id)}),new RTCSessionDescription({type:z.type,sdp:H})}function j(G,z){let H=z.sdp;return Object.keys(G._reverseStreams||[]).forEach(Q=>{const Y=G._reverseStreams[Q],X=G._streams[Y.id];H=H.replace(new RegExp(Y.id,"g"),X.id)}),new RTCSessionDescription({type:z.type,sdp:H})}["createOffer","createAnswer"].forEach(function(G){const z=B.RTCPeerConnection.prototype[G],H={[G](){const Q=arguments;return arguments.length&&typeof arguments[0]=="function"?z.apply(this,[X=>{const Z=q(this,X);Q[0].apply(null,[Z])},X=>{Q[1]&&Q[1].apply(null,X)},arguments[2]]):z.apply(this,arguments).then(X=>q(this,X))}};B.RTCPeerConnection.prototype[G]=H[G]});const W=B.RTCPeerConnection.prototype.setLocalDescription;B.RTCPeerConnection.prototype.setLocalDescription=function(){return!arguments.length||!arguments[0].type?W.apply(this,arguments):(arguments[0]=j(this,arguments[0]),W.apply(this,arguments))};const K=Object.getOwnPropertyDescriptor(B.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(B.RTCPeerConnection.prototype,"localDescription",{get(){const G=K.get.apply(this);return G.type===""?G:q(this,G)}}),B.RTCPeerConnection.prototype.removeTrack=function(z){if(this.signalingState==="closed")throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!z._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");if(!(z._pc===this))throw new DOMException("Sender was not created by this connection.","InvalidAccessError");this._streams=this._streams||{};let Q;Object.keys(this._streams).forEach(Y=>{this._streams[Y].getTracks().find(Z=>z.track===Z)&&(Q=this._streams[Y])}),Q&&(Q.getTracks().length===1?this.removeStream(this._reverseStreams[Q.id]):Q.removeTrack(z.track),this.dispatchEvent(new Event("negotiationneeded")))}}function shimPeerConnection$1$1(B,$){!B.RTCPeerConnection&&B.webkitRTCPeerConnection&&(B.RTCPeerConnection=B.webkitRTCPeerConnection),B.RTCPeerConnection&&$.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(U){const F=B.RTCPeerConnection.prototype[U],V={[U](){return arguments[0]=new(U==="addIceCandidate"?B.RTCIceCandidate:B.RTCSessionDescription)(arguments[0]),F.apply(this,arguments)}};B.RTCPeerConnection.prototype[U]=V[U]})}function fixNegotiationNeeded$1(B,$){wrapPeerConnectionEvent$1(B,"negotiationneeded",U=>{const F=U.target;if(!(($.version<72||F.getConfiguration&&F.getConfiguration().sdpSemantics==="plan-b")&&F.signalingState!=="stable"))return U})}var chromeShim$1=Object.freeze({__proto__:null,fixNegotiationNeeded:fixNegotiationNeeded$1,shimAddTrackRemoveTrack:shimAddTrackRemoveTrack$1,shimAddTrackRemoveTrackWithNative:shimAddTrackRemoveTrackWithNative$1,shimGetSendersWithDtmf:shimGetSendersWithDtmf$1,shimGetUserMedia:shimGetUserMedia$2$1,shimMediaStream:shimMediaStream$1,shimOnTrack:shimOnTrack$1$1,shimPeerConnection:shimPeerConnection$1$1,shimSenderReceiverGetStats:shimSenderReceiverGetStats$1});function shimGetUserMedia$1$1(B,$){const U=B&&B.navigator,F=B&&B.MediaStreamTrack;if(U.getUserMedia=function(V,q,j){deprecated$1("navigator.getUserMedia","navigator.mediaDevices.getUserMedia"),U.mediaDevices.getUserMedia(V).then(q,j)},!($.version>55&&"autoGainControl"in U.mediaDevices.getSupportedConstraints())){const V=function(j,W,K){W in j&&!(K in j)&&(j[K]=j[W],delete j[W])},q=U.mediaDevices.getUserMedia.bind(U.mediaDevices);if(U.mediaDevices.getUserMedia=function(j){return typeof j=="object"&&typeof j.audio=="object"&&(j=JSON.parse(JSON.stringify(j)),V(j.audio,"autoGainControl","mozAutoGainControl"),V(j.audio,"noiseSuppression","mozNoiseSuppression")),q(j)},F&&F.prototype.getSettings){const j=F.prototype.getSettings;F.prototype.getSettings=function(){const W=j.apply(this,arguments);return V(W,"mozAutoGainControl","autoGainControl"),V(W,"mozNoiseSuppression","noiseSuppression"),W}}if(F&&F.prototype.applyConstraints){const j=F.prototype.applyConstraints;F.prototype.applyConstraints=function(W){return this.kind==="audio"&&typeof W=="object"&&(W=JSON.parse(JSON.stringify(W)),V(W,"autoGainControl","mozAutoGainControl"),V(W,"noiseSuppression","mozNoiseSuppression")),j.apply(this,[W])}}}}function shimGetDisplayMedia$1(B,$){B.navigator.mediaDevices&&"getDisplayMedia"in B.navigator.mediaDevices||B.navigator.mediaDevices&&(B.navigator.mediaDevices.getDisplayMedia=function(F){if(!(F&&F.video)){const V=new DOMException("getDisplayMedia without video constraints is undefined");return V.name="NotFoundError",V.code=8,Promise.reject(V)}return F.video===!0?F.video={mediaSource:$}:F.video.mediaSource=$,B.navigator.mediaDevices.getUserMedia(F)})}function shimOnTrack$2(B){typeof B=="object"&&B.RTCTrackEvent&&"receiver"in B.RTCTrackEvent.prototype&&!("transceiver"in B.RTCTrackEvent.prototype)&&Object.defineProperty(B.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function shimPeerConnection$2(B,$){if(typeof B!="object"||!(B.RTCPeerConnection||B.mozRTCPeerConnection))return;!B.RTCPeerConnection&&B.mozRTCPeerConnection&&(B.RTCPeerConnection=B.mozRTCPeerConnection),$.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(V){const q=B.RTCPeerConnection.prototype[V],j={[V](){return arguments[0]=new(V==="addIceCandidate"?B.RTCIceCandidate:B.RTCSessionDescription)(arguments[0]),q.apply(this,arguments)}};B.RTCPeerConnection.prototype[V]=j[V]});const U={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},F=B.RTCPeerConnection.prototype.getStats;B.RTCPeerConnection.prototype.getStats=function(){const[q,j,W]=arguments;return F.apply(this,[q||null]).then(K=>{if($.version<53&&!j)try{K.forEach(G=>{G.type=U[G.type]||G.type})}catch(G){if(G.name!=="TypeError")throw G;K.forEach((z,H)=>{K.set(H,Object.assign({},z,{type:U[z.type]||z.type}))})}return K}).then(j,W)}}function shimSenderGetStats$1(B){if(!(typeof B=="object"&&B.RTCPeerConnection&&B.RTCRtpSender)||B.RTCRtpSender&&"getStats"in B.RTCRtpSender.prototype)return;const $=B.RTCPeerConnection.prototype.getSenders;$&&(B.RTCPeerConnection.prototype.getSenders=function(){const V=$.apply(this,[]);return V.forEach(q=>q._pc=this),V});const U=B.RTCPeerConnection.prototype.addTrack;U&&(B.RTCPeerConnection.prototype.addTrack=function(){const V=U.apply(this,arguments);return V._pc=this,V}),B.RTCRtpSender.prototype.getStats=function(){return this.track?this._pc.getStats(this.track):Promise.resolve(new Map)}}function shimReceiverGetStats$1(B){if(!(typeof B=="object"&&B.RTCPeerConnection&&B.RTCRtpSender)||B.RTCRtpSender&&"getStats"in B.RTCRtpReceiver.prototype)return;const $=B.RTCPeerConnection.prototype.getReceivers;$&&(B.RTCPeerConnection.prototype.getReceivers=function(){const F=$.apply(this,[]);return F.forEach(V=>V._pc=this),F}),wrapPeerConnectionEvent$1(B,"track",U=>(U.receiver._pc=U.srcElement,U)),B.RTCRtpReceiver.prototype.getStats=function(){return this._pc.getStats(this.track)}}function shimRemoveStream$1(B){!B.RTCPeerConnection||"removeStream"in B.RTCPeerConnection.prototype||(B.RTCPeerConnection.prototype.removeStream=function(U){deprecated$1("removeStream","removeTrack"),this.getSenders().forEach(F=>{F.track&&U.getTracks().includes(F.track)&&this.removeTrack(F)})})}function shimRTCDataChannel$1(B){B.DataChannel&&!B.RTCDataChannel&&(B.RTCDataChannel=B.DataChannel)}function shimAddTransceiver$1(B){if(!(typeof B=="object"&&B.RTCPeerConnection))return;const $=B.RTCPeerConnection.prototype.addTransceiver;$&&(B.RTCPeerConnection.prototype.addTransceiver=function(){this.setParametersPromises=[];let F=arguments[1]&&arguments[1].sendEncodings;F===void 0&&(F=[]),F=[...F];const V=F.length>0;V&&F.forEach(j=>{if("rid"in j&&!/^[a-z0-9]{0,16}$/i.test(j.rid))throw new TypeError("Invalid RID value provided.");if("scaleResolutionDownBy"in j&&!(parseFloat(j.scaleResolutionDownBy)>=1))throw new RangeError("scale_resolution_down_by must be >= 1.0");if("maxFramerate"in j&&!(parseFloat(j.maxFramerate)>=0))throw new RangeError("max_framerate must be >= 0.0")});const q=$.apply(this,arguments);if(V){const{sender:j}=q,W=j.getParameters();(!("encodings"in W)||W.encodings.length===1&&Object.keys(W.encodings[0]).length===0)&&(W.encodings=F,j.sendEncodings=F,this.setParametersPromises.push(j.setParameters(W).then(()=>{delete j.sendEncodings}).catch(()=>{delete j.sendEncodings})))}return q})}function shimGetParameters$1(B){if(!(typeof B=="object"&&B.RTCRtpSender))return;const $=B.RTCRtpSender.prototype.getParameters;$&&(B.RTCRtpSender.prototype.getParameters=function(){const F=$.apply(this,arguments);return"encodings"in F||(F.encodings=[].concat(this.sendEncodings||[{}])),F})}function shimCreateOffer$1(B){if(!(typeof B=="object"&&B.RTCPeerConnection))return;const $=B.RTCPeerConnection.prototype.createOffer;B.RTCPeerConnection.prototype.createOffer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then(()=>$.apply(this,arguments)).finally(()=>{this.setParametersPromises=[]}):$.apply(this,arguments)}}function shimCreateAnswer$1(B){if(!(typeof B=="object"&&B.RTCPeerConnection))return;const $=B.RTCPeerConnection.prototype.createAnswer;B.RTCPeerConnection.prototype.createAnswer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then(()=>$.apply(this,arguments)).finally(()=>{this.setParametersPromises=[]}):$.apply(this,arguments)}}var firefoxShim$1=Object.freeze({__proto__:null,shimAddTransceiver:shimAddTransceiver$1,shimCreateAnswer:shimCreateAnswer$1,shimCreateOffer:shimCreateOffer$1,shimGetDisplayMedia:shimGetDisplayMedia$1,shimGetParameters:shimGetParameters$1,shimGetUserMedia:shimGetUserMedia$1$1,shimOnTrack:shimOnTrack$2,shimPeerConnection:shimPeerConnection$2,shimRTCDataChannel:shimRTCDataChannel$1,shimReceiverGetStats:shimReceiverGetStats$1,shimRemoveStream:shimRemoveStream$1,shimSenderGetStats:shimSenderGetStats$1});function shimLocalStreamsAPI$1(B){if(!(typeof B!="object"||!B.RTCPeerConnection)){if("getLocalStreams"in B.RTCPeerConnection.prototype||(B.RTCPeerConnection.prototype.getLocalStreams=function(){return this._localStreams||(this._localStreams=[]),this._localStreams}),!("addStream"in B.RTCPeerConnection.prototype)){const $=B.RTCPeerConnection.prototype.addTrack;B.RTCPeerConnection.prototype.addStream=function(F){this._localStreams||(this._localStreams=[]),this._localStreams.includes(F)||this._localStreams.push(F),F.getAudioTracks().forEach(V=>$.call(this,V,F)),F.getVideoTracks().forEach(V=>$.call(this,V,F))},B.RTCPeerConnection.prototype.addTrack=function(F){for(var V=arguments.length,q=new Array(V>1?V-1:0),j=1;j<V;j++)q[j-1]=arguments[j];return q&&q.forEach(W=>{this._localStreams?this._localStreams.includes(W)||this._localStreams.push(W):this._localStreams=[W]}),$.apply(this,arguments)}}"removeStream"in B.RTCPeerConnection.prototype||(B.RTCPeerConnection.prototype.removeStream=function(U){this._localStreams||(this._localStreams=[]);const F=this._localStreams.indexOf(U);if(F===-1)return;this._localStreams.splice(F,1);const V=U.getTracks();this.getSenders().forEach(q=>{V.includes(q.track)&&this.removeTrack(q)})})}}function shimRemoteStreamsAPI$1(B){if(!(typeof B!="object"||!B.RTCPeerConnection)&&("getRemoteStreams"in B.RTCPeerConnection.prototype||(B.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}),!("onaddstream"in B.RTCPeerConnection.prototype))){Object.defineProperty(B.RTCPeerConnection.prototype,"onaddstream",{get(){return this._onaddstream},set(U){this._onaddstream&&(this.removeEventListener("addstream",this._onaddstream),this.removeEventListener("track",this._onaddstreampoly)),this.addEventListener("addstream",this._onaddstream=U),this.addEventListener("track",this._onaddstreampoly=F=>{F.streams.forEach(V=>{if(this._remoteStreams||(this._remoteStreams=[]),this._remoteStreams.includes(V))return;this._remoteStreams.push(V);const q=new Event("addstream");q.stream=V,this.dispatchEvent(q)})})}});const $=B.RTCPeerConnection.prototype.setRemoteDescription;B.RTCPeerConnection.prototype.setRemoteDescription=function(){const F=this;return this._onaddstreampoly||this.addEventListener("track",this._onaddstreampoly=function(V){V.streams.forEach(q=>{if(F._remoteStreams||(F._remoteStreams=[]),F._remoteStreams.indexOf(q)>=0)return;F._remoteStreams.push(q);const j=new Event("addstream");j.stream=q,F.dispatchEvent(j)})}),$.apply(F,arguments)}}}function shimCallbacksAPI$1(B){if(typeof B!="object"||!B.RTCPeerConnection)return;const $=B.RTCPeerConnection.prototype,U=$.createOffer,F=$.createAnswer,V=$.setLocalDescription,q=$.setRemoteDescription,j=$.addIceCandidate;$.createOffer=function(G,z){const H=arguments.length>=2?arguments[2]:arguments[0],Q=U.apply(this,[H]);return z?(Q.then(G,z),Promise.resolve()):Q},$.createAnswer=function(G,z){const H=arguments.length>=2?arguments[2]:arguments[0],Q=F.apply(this,[H]);return z?(Q.then(G,z),Promise.resolve()):Q};let W=function(K,G,z){const H=V.apply(this,[K]);return z?(H.then(G,z),Promise.resolve()):H};$.setLocalDescription=W,W=function(K,G,z){const H=q.apply(this,[K]);return z?(H.then(G,z),Promise.resolve()):H},$.setRemoteDescription=W,W=function(K,G,z){const H=j.apply(this,[K]);return z?(H.then(G,z),Promise.resolve()):H},$.addIceCandidate=W}function shimGetUserMedia$3(B){const $=B&&B.navigator;if($.mediaDevices&&$.mediaDevices.getUserMedia){const U=$.mediaDevices,F=U.getUserMedia.bind(U);$.mediaDevices.getUserMedia=V=>F(shimConstraints$1(V))}!$.getUserMedia&&$.mediaDevices&&$.mediaDevices.getUserMedia&&($.getUserMedia=function(F,V,q){$.mediaDevices.getUserMedia(F).then(V,q)}.bind($))}function shimConstraints$1(B){return B&&B.video!==void 0?Object.assign({},B,{video:compactObject$1(B.video)}):B}function shimRTCIceServerUrls$1(B){if(!B.RTCPeerConnection)return;const $=B.RTCPeerConnection;B.RTCPeerConnection=function(F,V){if(F&&F.iceServers){const q=[];for(let j=0;j<F.iceServers.length;j++){let W=F.iceServers[j];W.urls===void 0&&W.url?(deprecated$1("RTCIceServer.url","RTCIceServer.urls"),W=JSON.parse(JSON.stringify(W)),W.urls=W.url,delete W.url,q.push(W)):q.push(F.iceServers[j])}F.iceServers=q}return new $(F,V)},B.RTCPeerConnection.prototype=$.prototype,"generateCertificate"in $&&Object.defineProperty(B.RTCPeerConnection,"generateCertificate",{get(){return $.generateCertificate}})}function shimTrackEventTransceiver$1(B){typeof B=="object"&&B.RTCTrackEvent&&"receiver"in B.RTCTrackEvent.prototype&&!("transceiver"in B.RTCTrackEvent.prototype)&&Object.defineProperty(B.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function shimCreateOfferLegacy$1(B){const $=B.RTCPeerConnection.prototype.createOffer;B.RTCPeerConnection.prototype.createOffer=function(F){if(F){typeof F.offerToReceiveAudio<"u"&&(F.offerToReceiveAudio=!!F.offerToReceiveAudio);const V=this.getTransceivers().find(j=>j.receiver.track.kind==="audio");F.offerToReceiveAudio===!1&&V?V.direction==="sendrecv"?V.setDirection?V.setDirection("sendonly"):V.direction="sendonly":V.direction==="recvonly"&&(V.setDirection?V.setDirection("inactive"):V.direction="inactive"):F.offerToReceiveAudio===!0&&!V&&this.addTransceiver("audio",{direction:"recvonly"}),typeof F.offerToReceiveVideo<"u"&&(F.offerToReceiveVideo=!!F.offerToReceiveVideo);const q=this.getTransceivers().find(j=>j.receiver.track.kind==="video");F.offerToReceiveVideo===!1&&q?q.direction==="sendrecv"?q.setDirection?q.setDirection("sendonly"):q.direction="sendonly":q.direction==="recvonly"&&(q.setDirection?q.setDirection("inactive"):q.direction="inactive"):F.offerToReceiveVideo===!0&&!q&&this.addTransceiver("video",{direction:"recvonly"})}return $.apply(this,arguments)}}function shimAudioContext$1(B){typeof B!="object"||B.AudioContext||(B.AudioContext=B.webkitAudioContext)}var safariShim$1=Object.freeze({__proto__:null,shimAudioContext:shimAudioContext$1,shimCallbacksAPI:shimCallbacksAPI$1,shimConstraints:shimConstraints$1,shimCreateOfferLegacy:shimCreateOfferLegacy$1,shimGetUserMedia:shimGetUserMedia$3,shimLocalStreamsAPI:shimLocalStreamsAPI$1,shimRTCIceServerUrls:shimRTCIceServerUrls$1,shimRemoteStreamsAPI:shimRemoteStreamsAPI$1,shimTrackEventTransceiver:shimTrackEventTransceiver$1}),sdp$1$1={exports:{}},hasRequiredSdp$1;function requireSdp$1(){return hasRequiredSdp$1||(hasRequiredSdp$1=1,(function(B){const $={};$.generateIdentifier=function(){return Math.random().toString(36).substring(2,12)},$.localCName=$.generateIdentifier(),$.splitLines=function(U){return U.trim().split(`
`).map(F=>F.trim())},$.splitSections=function(U){return U.split(`
m=`).map((V,q)=>(q>0?"m="+V:V).trim()+`\r
`)},$.getDescription=function(U){const F=$.splitSections(U);return F&&F[0]},$.getMediaSections=function(U){const F=$.splitSections(U);return F.shift(),F},$.matchPrefix=function(U,F){return $.splitLines(U).filter(V=>V.indexOf(F)===0)},$.parseCandidate=function(U){let F;U.indexOf("a=candidate:")===0?F=U.substring(12).split(" "):F=U.substring(10).split(" ");const V={foundation:F[0],component:{1:"rtp",2:"rtcp"}[F[1]]||F[1],protocol:F[2].toLowerCase(),priority:parseInt(F[3],10),ip:F[4],address:F[4],port:parseInt(F[5],10),type:F[7]};for(let q=8;q<F.length;q+=2)switch(F[q]){case"raddr":V.relatedAddress=F[q+1];break;case"rport":V.relatedPort=parseInt(F[q+1],10);break;case"tcptype":V.tcpType=F[q+1];break;case"ufrag":V.ufrag=F[q+1],V.usernameFragment=F[q+1];break;default:V[F[q]]===void 0&&(V[F[q]]=F[q+1]);break}return V},$.writeCandidate=function(U){const F=[];F.push(U.foundation);const V=U.component;V==="rtp"?F.push(1):V==="rtcp"?F.push(2):F.push(V),F.push(U.protocol.toUpperCase()),F.push(U.priority),F.push(U.address||U.ip),F.push(U.port);const q=U.type;return F.push("typ"),F.push(q),q!=="host"&&U.relatedAddress&&U.relatedPort&&(F.push("raddr"),F.push(U.relatedAddress),F.push("rport"),F.push(U.relatedPort)),U.tcpType&&U.protocol.toLowerCase()==="tcp"&&(F.push("tcptype"),F.push(U.tcpType)),(U.usernameFragment||U.ufrag)&&(F.push("ufrag"),F.push(U.usernameFragment||U.ufrag)),"candidate:"+F.join(" ")},$.parseIceOptions=function(U){return U.substring(14).split(" ")},$.parseRtpMap=function(U){let F=U.substring(9).split(" ");const V={payloadType:parseInt(F.shift(),10)};return F=F[0].split("/"),V.name=F[0],V.clockRate=parseInt(F[1],10),V.channels=F.length===3?parseInt(F[2],10):1,V.numChannels=V.channels,V},$.writeRtpMap=function(U){let F=U.payloadType;U.preferredPayloadType!==void 0&&(F=U.preferredPayloadType);const V=U.channels||U.numChannels||1;return"a=rtpmap:"+F+" "+U.name+"/"+U.clockRate+(V!==1?"/"+V:"")+`\r
`},$.parseExtmap=function(U){const F=U.substring(9).split(" ");return{id:parseInt(F[0],10),direction:F[0].indexOf("/")>0?F[0].split("/")[1]:"sendrecv",uri:F[1],attributes:F.slice(2).join(" ")}},$.writeExtmap=function(U){return"a=extmap:"+(U.id||U.preferredId)+(U.direction&&U.direction!=="sendrecv"?"/"+U.direction:"")+" "+U.uri+(U.attributes?" "+U.attributes:"")+`\r
`},$.parseFmtp=function(U){const F={};let V;const q=U.substring(U.indexOf(" ")+1).split(";");for(let j=0;j<q.length;j++)V=q[j].trim().split("="),F[V[0].trim()]=V[1];return F},$.writeFmtp=function(U){let F="",V=U.payloadType;if(U.preferredPayloadType!==void 0&&(V=U.preferredPayloadType),U.parameters&&Object.keys(U.parameters).length){const q=[];Object.keys(U.parameters).forEach(j=>{U.parameters[j]!==void 0?q.push(j+"="+U.parameters[j]):q.push(j)}),F+="a=fmtp:"+V+" "+q.join(";")+`\r
`}return F},$.parseRtcpFb=function(U){const F=U.substring(U.indexOf(" ")+1).split(" ");return{type:F.shift(),parameter:F.join(" ")}},$.writeRtcpFb=function(U){let F="",V=U.payloadType;return U.preferredPayloadType!==void 0&&(V=U.preferredPayloadType),U.rtcpFeedback&&U.rtcpFeedback.length&&U.rtcpFeedback.forEach(q=>{F+="a=rtcp-fb:"+V+" "+q.type+(q.parameter&&q.parameter.length?" "+q.parameter:"")+`\r
`}),F},$.parseSsrcMedia=function(U){const F=U.indexOf(" "),V={ssrc:parseInt(U.substring(7,F),10)},q=U.indexOf(":",F);return q>-1?(V.attribute=U.substring(F+1,q),V.value=U.substring(q+1)):V.attribute=U.substring(F+1),V},$.parseSsrcGroup=function(U){const F=U.substring(13).split(" ");return{semantics:F.shift(),ssrcs:F.map(V=>parseInt(V,10))}},$.getMid=function(U){const F=$.matchPrefix(U,"a=mid:")[0];if(F)return F.substring(6)},$.parseFingerprint=function(U){const F=U.substring(14).split(" ");return{algorithm:F[0].toLowerCase(),value:F[1].toUpperCase()}},$.getDtlsParameters=function(U,F){return{role:"auto",fingerprints:$.matchPrefix(U+F,"a=fingerprint:").map($.parseFingerprint)}},$.writeDtlsParameters=function(U,F){let V="a=setup:"+F+`\r
`;return U.fingerprints.forEach(q=>{V+="a=fingerprint:"+q.algorithm+" "+q.value+`\r
`}),V},$.parseCryptoLine=function(U){const F=U.substring(9).split(" ");return{tag:parseInt(F[0],10),cryptoSuite:F[1],keyParams:F[2],sessionParams:F.slice(3)}},$.writeCryptoLine=function(U){return"a=crypto:"+U.tag+" "+U.cryptoSuite+" "+(typeof U.keyParams=="object"?$.writeCryptoKeyParams(U.keyParams):U.keyParams)+(U.sessionParams?" "+U.sessionParams.join(" "):"")+`\r
`},$.parseCryptoKeyParams=function(U){if(U.indexOf("inline:")!==0)return null;const F=U.substring(7).split("|");return{keyMethod:"inline",keySalt:F[0],lifeTime:F[1],mkiValue:F[2]?F[2].split(":")[0]:void 0,mkiLength:F[2]?F[2].split(":")[1]:void 0}},$.writeCryptoKeyParams=function(U){return U.keyMethod+":"+U.keySalt+(U.lifeTime?"|"+U.lifeTime:"")+(U.mkiValue&&U.mkiLength?"|"+U.mkiValue+":"+U.mkiLength:"")},$.getCryptoParameters=function(U,F){return $.matchPrefix(U+F,"a=crypto:").map($.parseCryptoLine)},$.getIceParameters=function(U,F){const V=$.matchPrefix(U+F,"a=ice-ufrag:")[0],q=$.matchPrefix(U+F,"a=ice-pwd:")[0];return V&&q?{usernameFragment:V.substring(12),password:q.substring(10)}:null},$.writeIceParameters=function(U){let F="a=ice-ufrag:"+U.usernameFragment+`\r
a=ice-pwd:`+U.password+`\r
`;return U.iceLite&&(F+=`a=ice-lite\r
`),F},$.parseRtpParameters=function(U){const F={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},q=$.splitLines(U)[0].split(" ");F.profile=q[2];for(let W=3;W<q.length;W++){const K=q[W],G=$.matchPrefix(U,"a=rtpmap:"+K+" ")[0];if(G){const z=$.parseRtpMap(G),H=$.matchPrefix(U,"a=fmtp:"+K+" ");switch(z.parameters=H.length?$.parseFmtp(H[0]):{},z.rtcpFeedback=$.matchPrefix(U,"a=rtcp-fb:"+K+" ").map($.parseRtcpFb),F.codecs.push(z),z.name.toUpperCase()){case"RED":case"ULPFEC":F.fecMechanisms.push(z.name.toUpperCase());break}}}$.matchPrefix(U,"a=extmap:").forEach(W=>{F.headerExtensions.push($.parseExtmap(W))});const j=$.matchPrefix(U,"a=rtcp-fb:* ").map($.parseRtcpFb);return F.codecs.forEach(W=>{j.forEach(K=>{W.rtcpFeedback.find(z=>z.type===K.type&&z.parameter===K.parameter)||W.rtcpFeedback.push(K)})}),F},$.writeRtpDescription=function(U,F){let V="";V+="m="+U+" ",V+=F.codecs.length>0?"9":"0",V+=" "+(F.profile||"UDP/TLS/RTP/SAVPF")+" ",V+=F.codecs.map(j=>j.preferredPayloadType!==void 0?j.preferredPayloadType:j.payloadType).join(" ")+`\r
`,V+=`c=IN IP4 0.0.0.0\r
`,V+=`a=rtcp:9 IN IP4 0.0.0.0\r
`,F.codecs.forEach(j=>{V+=$.writeRtpMap(j),V+=$.writeFmtp(j),V+=$.writeRtcpFb(j)});let q=0;return F.codecs.forEach(j=>{j.maxptime>q&&(q=j.maxptime)}),q>0&&(V+="a=maxptime:"+q+`\r
`),F.headerExtensions&&F.headerExtensions.forEach(j=>{V+=$.writeExtmap(j)}),V},$.parseRtpEncodingParameters=function(U){const F=[],V=$.parseRtpParameters(U),q=V.fecMechanisms.indexOf("RED")!==-1,j=V.fecMechanisms.indexOf("ULPFEC")!==-1,W=$.matchPrefix(U,"a=ssrc:").map(Q=>$.parseSsrcMedia(Q)).filter(Q=>Q.attribute==="cname"),K=W.length>0&&W[0].ssrc;let G;const z=$.matchPrefix(U,"a=ssrc-group:FID").map(Q=>Q.substring(17).split(" ").map(X=>parseInt(X,10)));z.length>0&&z[0].length>1&&z[0][0]===K&&(G=z[0][1]),V.codecs.forEach(Q=>{if(Q.name.toUpperCase()==="RTX"&&Q.parameters.apt){let Y={ssrc:K,codecPayloadType:parseInt(Q.parameters.apt,10)};K&&G&&(Y.rtx={ssrc:G}),F.push(Y),q&&(Y=JSON.parse(JSON.stringify(Y)),Y.fec={ssrc:K,mechanism:j?"red+ulpfec":"red"},F.push(Y))}}),F.length===0&&K&&F.push({ssrc:K});let H=$.matchPrefix(U,"b=");return H.length&&(H[0].indexOf("b=TIAS:")===0?H=parseInt(H[0].substring(7),10):H[0].indexOf("b=AS:")===0?H=parseInt(H[0].substring(5),10)*1e3*.95-2e3*8:H=void 0,F.forEach(Q=>{Q.maxBitrate=H})),F},$.parseRtcpParameters=function(U){const F={},V=$.matchPrefix(U,"a=ssrc:").map(W=>$.parseSsrcMedia(W)).filter(W=>W.attribute==="cname")[0];V&&(F.cname=V.value,F.ssrc=V.ssrc);const q=$.matchPrefix(U,"a=rtcp-rsize");F.reducedSize=q.length>0,F.compound=q.length===0;const j=$.matchPrefix(U,"a=rtcp-mux");return F.mux=j.length>0,F},$.writeRtcpParameters=function(U){let F="";return U.reducedSize&&(F+=`a=rtcp-rsize\r
`),U.mux&&(F+=`a=rtcp-mux\r
`),U.ssrc!==void 0&&U.cname&&(F+="a=ssrc:"+U.ssrc+" cname:"+U.cname+`\r
`),F},$.parseMsid=function(U){let F;const V=$.matchPrefix(U,"a=msid:");if(V.length===1)return F=V[0].substring(7).split(" "),{stream:F[0],track:F[1]};const q=$.matchPrefix(U,"a=ssrc:").map(j=>$.parseSsrcMedia(j)).filter(j=>j.attribute==="msid");if(q.length>0)return F=q[0].value.split(" "),{stream:F[0],track:F[1]}},$.parseSctpDescription=function(U){const F=$.parseMLine(U),V=$.matchPrefix(U,"a=max-message-size:");let q;V.length>0&&(q=parseInt(V[0].substring(19),10)),isNaN(q)&&(q=65536);const j=$.matchPrefix(U,"a=sctp-port:");if(j.length>0)return{port:parseInt(j[0].substring(12),10),protocol:F.fmt,maxMessageSize:q};const W=$.matchPrefix(U,"a=sctpmap:");if(W.length>0){const K=W[0].substring(10).split(" ");return{port:parseInt(K[0],10),protocol:K[1],maxMessageSize:q}}},$.writeSctpDescription=function(U,F){let V=[];return U.protocol!=="DTLS/SCTP"?V=["m="+U.kind+" 9 "+U.protocol+" "+F.protocol+`\r
`,`c=IN IP4 0.0.0.0\r
`,"a=sctp-port:"+F.port+`\r
`]:V=["m="+U.kind+" 9 "+U.protocol+" "+F.port+`\r
`,`c=IN IP4 0.0.0.0\r
`,"a=sctpmap:"+F.port+" "+F.protocol+` 65535\r
`],F.maxMessageSize!==void 0&&V.push("a=max-message-size:"+F.maxMessageSize+`\r
`),V.join("")},$.generateSessionId=function(){return Math.random().toString().substr(2,22)},$.writeSessionBoilerplate=function(U,F,V){let q;const j=F!==void 0?F:2;return U?q=U:q=$.generateSessionId(),`v=0\r
o=`+(V||"thisisadapterortc")+" "+q+" "+j+` IN IP4 127.0.0.1\r
s=-\r
t=0 0\r
`},$.getDirection=function(U,F){const V=$.splitLines(U);for(let q=0;q<V.length;q++)switch(V[q]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return V[q].substring(2)}return F?$.getDirection(F):"sendrecv"},$.getKind=function(U){return $.splitLines(U)[0].split(" ")[0].substring(2)},$.isRejected=function(U){return U.split(" ",2)[1]==="0"},$.parseMLine=function(U){const V=$.splitLines(U)[0].substring(2).split(" ");return{kind:V[0],port:parseInt(V[1],10),protocol:V[2],fmt:V.slice(3).join(" ")}},$.parseOLine=function(U){const V=$.matchPrefix(U,"o=")[0].substring(2).split(" ");return{username:V[0],sessionId:V[1],sessionVersion:parseInt(V[2],10),netType:V[3],addressType:V[4],address:V[5]}},$.isValidSDP=function(U){if(typeof U!="string"||U.length===0)return!1;const F=$.splitLines(U);for(let V=0;V<F.length;V++)if(F[V].length<2||F[V].charAt(1)!=="=")return!1;return!0},B.exports=$})(sdp$1$1)),sdp$1$1.exports}var sdpExports$1=requireSdp$1(),SDPUtils$1=getDefaultExportFromCjs$2(sdpExports$1),sdp$2=_mergeNamespaces$2({__proto__:null,default:SDPUtils$1},[sdpExports$1]);function shimRTCIceCandidate$1(B){if(!B.RTCIceCandidate||B.RTCIceCandidate&&"foundation"in B.RTCIceCandidate.prototype)return;const $=B.RTCIceCandidate;B.RTCIceCandidate=function(F){if(typeof F=="object"&&F.candidate&&F.candidate.indexOf("a=")===0&&(F=JSON.parse(JSON.stringify(F)),F.candidate=F.candidate.substring(2)),F.candidate&&F.candidate.length){const V=new $(F),q=SDPUtils$1.parseCandidate(F.candidate);for(const j in q)j in V||Object.defineProperty(V,j,{value:q[j]});return V.toJSON=function(){return{candidate:V.candidate,sdpMid:V.sdpMid,sdpMLineIndex:V.sdpMLineIndex,usernameFragment:V.usernameFragment}},V}return new $(F)},B.RTCIceCandidate.prototype=$.prototype,wrapPeerConnectionEvent$1(B,"icecandidate",U=>(U.candidate&&Object.defineProperty(U,"candidate",{value:new B.RTCIceCandidate(U.candidate),writable:"false"}),U))}function shimRTCIceCandidateRelayProtocol$1(B){!B.RTCIceCandidate||B.RTCIceCandidate&&"relayProtocol"in B.RTCIceCandidate.prototype||wrapPeerConnectionEvent$1(B,"icecandidate",$=>{if($.candidate){const U=SDPUtils$1.parseCandidate($.candidate.candidate);U.type==="relay"&&($.candidate.relayProtocol={0:"tls",1:"tcp",2:"udp"}[U.priority>>24])}return $})}function shimMaxMessageSize$1(B,$){if(!B.RTCPeerConnection)return;"sctp"in B.RTCPeerConnection.prototype||Object.defineProperty(B.RTCPeerConnection.prototype,"sctp",{get(){return typeof this._sctp>"u"?null:this._sctp}});const U=function(W){if(!W||!W.sdp)return!1;const K=SDPUtils$1.splitSections(W.sdp);return K.shift(),K.some(G=>{const z=SDPUtils$1.parseMLine(G);return z&&z.kind==="application"&&z.protocol.indexOf("SCTP")!==-1})},F=function(W){const K=W.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(K===null||K.length<2)return-1;const G=parseInt(K[1],10);return G!==G?-1:G},V=function(W){let K=65536;return $.browser==="firefox"&&($.version<57?W===-1?K=16384:K=2147483637:$.version<60?K=$.version===57?65535:65536:K=2147483637),K},q=function(W,K){let G=65536;$.browser==="firefox"&&$.version===57&&(G=65535);const z=SDPUtils$1.matchPrefix(W.sdp,"a=max-message-size:");return z.length>0?G=parseInt(z[0].substring(19),10):$.browser==="firefox"&&K!==-1&&(G=2147483637),G},j=B.RTCPeerConnection.prototype.setRemoteDescription;B.RTCPeerConnection.prototype.setRemoteDescription=function(){if(this._sctp=null,$.browser==="chrome"&&$.version>=76){const{sdpSemantics:K}=this.getConfiguration();K==="plan-b"&&Object.defineProperty(this,"sctp",{get(){return typeof this._sctp>"u"?null:this._sctp},enumerable:!0,configurable:!0})}if(U(arguments[0])){const K=F(arguments[0]),G=V(K),z=q(arguments[0],K);let H;G===0&&z===0?H=Number.POSITIVE_INFINITY:G===0||z===0?H=Math.max(G,z):H=Math.min(G,z);const Q={};Object.defineProperty(Q,"maxMessageSize",{get(){return H}}),this._sctp=Q}return j.apply(this,arguments)}}function shimSendThrowTypeError$1(B){if(!(B.RTCPeerConnection&&"createDataChannel"in B.RTCPeerConnection.prototype))return;function $(F,V){const q=F.send;F.send=function(){const W=arguments[0],K=W.length||W.size||W.byteLength;if(F.readyState==="open"&&V.sctp&&K>V.sctp.maxMessageSize)throw new TypeError("Message too large (can send a maximum of "+V.sctp.maxMessageSize+" bytes)");return q.apply(F,arguments)}}const U=B.RTCPeerConnection.prototype.createDataChannel;B.RTCPeerConnection.prototype.createDataChannel=function(){const V=U.apply(this,arguments);return $(V,this),V},wrapPeerConnectionEvent$1(B,"datachannel",F=>($(F.channel,F.target),F))}function shimConnectionState$1(B){if(!B.RTCPeerConnection||"connectionState"in B.RTCPeerConnection.prototype)return;const $=B.RTCPeerConnection.prototype;Object.defineProperty($,"connectionState",{get(){return{completed:"connected",checking:"connecting"}[this.iceConnectionState]||this.iceConnectionState},enumerable:!0,configurable:!0}),Object.defineProperty($,"onconnectionstatechange",{get(){return this._onconnectionstatechange||null},set(U){this._onconnectionstatechange&&(this.removeEventListener("connectionstatechange",this._onconnectionstatechange),delete this._onconnectionstatechange),U&&this.addEventListener("connectionstatechange",this._onconnectionstatechange=U)},enumerable:!0,configurable:!0}),["setLocalDescription","setRemoteDescription"].forEach(U=>{const F=$[U];$[U]=function(){return this._connectionstatechangepoly||(this._connectionstatechangepoly=V=>{const q=V.target;if(q._lastConnectionState!==q.connectionState){q._lastConnectionState=q.connectionState;const j=new Event("connectionstatechange",V);q.dispatchEvent(j)}return V},this.addEventListener("iceconnectionstatechange",this._connectionstatechangepoly)),F.apply(this,arguments)}})}function removeExtmapAllowMixed$1(B,$){if(!B.RTCPeerConnection||$.browser==="chrome"&&$.version>=71||$.browser==="safari"&&$.version>=605)return;const U=B.RTCPeerConnection.prototype.setRemoteDescription;B.RTCPeerConnection.prototype.setRemoteDescription=function(V){if(V&&V.sdp&&V.sdp.indexOf(`
a=extmap-allow-mixed`)!==-1){const q=V.sdp.split(`
`).filter(j=>j.trim()!=="a=extmap-allow-mixed").join(`
`);B.RTCSessionDescription&&V instanceof B.RTCSessionDescription?arguments[0]=new B.RTCSessionDescription({type:V.type,sdp:q}):V.sdp=q}return U.apply(this,arguments)}}function shimAddIceCandidateNullOrEmpty$1(B,$){if(!(B.RTCPeerConnection&&B.RTCPeerConnection.prototype))return;const U=B.RTCPeerConnection.prototype.addIceCandidate;!U||U.length===0||(B.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?($.browser==="chrome"&&$.version<78||$.browser==="firefox"&&$.version<68||$.browser==="safari")&&arguments[0]&&arguments[0].candidate===""?Promise.resolve():U.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())})}function shimParameterlessSetLocalDescription$1(B,$){if(!(B.RTCPeerConnection&&B.RTCPeerConnection.prototype))return;const U=B.RTCPeerConnection.prototype.setLocalDescription;!U||U.length===0||(B.RTCPeerConnection.prototype.setLocalDescription=function(){let V=arguments[0]||{};if(typeof V!="object"||V.type&&V.sdp)return U.apply(this,arguments);if(V={type:V.type,sdp:V.sdp},!V.type)switch(this.signalingState){case"stable":case"have-local-offer":case"have-remote-pranswer":V.type="offer";break;default:V.type="answer";break}return V.sdp||V.type!=="offer"&&V.type!=="answer"?U.apply(this,[V]):(V.type==="offer"?this.createOffer:this.createAnswer).apply(this).then(j=>U.apply(this,[j]))})}var commonShim$1=Object.freeze({__proto__:null,removeExtmapAllowMixed:removeExtmapAllowMixed$1,shimAddIceCandidateNullOrEmpty:shimAddIceCandidateNullOrEmpty$1,shimConnectionState:shimConnectionState$1,shimMaxMessageSize:shimMaxMessageSize$1,shimParameterlessSetLocalDescription:shimParameterlessSetLocalDescription$1,shimRTCIceCandidate:shimRTCIceCandidate$1,shimRTCIceCandidateRelayProtocol:shimRTCIceCandidateRelayProtocol$1,shimSendThrowTypeError:shimSendThrowTypeError$1});function adapterFactory$1(){let{window:B}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},$=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{shimChrome:!0,shimFirefox:!0,shimSafari:!0};const U=log$1,F=detectBrowser$1(B),V={browserDetails:F,commonShim:commonShim$1,extractVersion:extractVersion$1,disableLog:disableLog$1,disableWarnings:disableWarnings$1,sdp:sdp$2};switch(F.browser){case"chrome":if(!chromeShim$1||!shimPeerConnection$1$1||!$.shimChrome)return U("Chrome shim is not included in this adapter release."),V;if(F.version===null)return U("Chrome shim can not determine version, not shimming."),V;U("adapter.js shimming chrome."),V.browserShim=chromeShim$1,shimAddIceCandidateNullOrEmpty$1(B,F),shimParameterlessSetLocalDescription$1(B),shimGetUserMedia$2$1(B,F),shimMediaStream$1(B),shimPeerConnection$1$1(B,F),shimOnTrack$1$1(B),shimAddTrackRemoveTrack$1(B,F),shimGetSendersWithDtmf$1(B),shimSenderReceiverGetStats$1(B),fixNegotiationNeeded$1(B,F),shimRTCIceCandidate$1(B),shimRTCIceCandidateRelayProtocol$1(B),shimConnectionState$1(B),shimMaxMessageSize$1(B,F),shimSendThrowTypeError$1(B),removeExtmapAllowMixed$1(B,F);break;case"firefox":if(!firefoxShim$1||!shimPeerConnection$2||!$.shimFirefox)return U("Firefox shim is not included in this adapter release."),V;U("adapter.js shimming firefox."),V.browserShim=firefoxShim$1,shimAddIceCandidateNullOrEmpty$1(B,F),shimParameterlessSetLocalDescription$1(B),shimGetUserMedia$1$1(B,F),shimPeerConnection$2(B,F),shimOnTrack$2(B),shimRemoveStream$1(B),shimSenderGetStats$1(B),shimReceiverGetStats$1(B),shimRTCDataChannel$1(B),shimAddTransceiver$1(B),shimGetParameters$1(B),shimCreateOffer$1(B),shimCreateAnswer$1(B),shimRTCIceCandidate$1(B),shimConnectionState$1(B),shimMaxMessageSize$1(B,F),shimSendThrowTypeError$1(B);break;case"safari":if(!safariShim$1||!$.shimSafari)return U("Safari shim is not included in this adapter release."),V;U("adapter.js shimming safari."),V.browserShim=safariShim$1,shimAddIceCandidateNullOrEmpty$1(B,F),shimParameterlessSetLocalDescription$1(B),shimRTCIceServerUrls$1(B),shimCreateOfferLegacy$1(B),shimCallbacksAPI$1(B),shimLocalStreamsAPI$1(B),shimRemoteStreamsAPI$1(B),shimTrackEventTransceiver$1(B),shimGetUserMedia$3(B),shimAudioContext$1(B),shimRTCIceCandidate$1(B),shimRTCIceCandidateRelayProtocol$1(B),shimMaxMessageSize$1(B,F),shimSendThrowTypeError$1(B),removeExtmapAllowMixed$1(B,F);break;default:U("Unsupported browser!");break}return V}adapterFactory$1({window:typeof window>"u"?void 0:window});const DECRYPTION_FAILURE_TOLERANCE$1=10,E2EE_FLAG$1="lk_e2ee",SALT$1="LKFrameEncryptionKey",KEY_PROVIDER_DEFAULTS$1={sharedKey:!1,ratchetSalt:SALT$1,ratchetWindowSize:8,failureTolerance:DECRYPTION_FAILURE_TOLERANCE$1,keyringSize:16,allowKeyExtraction:!1};var KeyProviderEvent$1;(function(B){B.SetKey="setKey",B.RatchetRequest="ratchetRequest",B.KeyRatcheted="keyRatcheted"})(KeyProviderEvent$1||(KeyProviderEvent$1={}));var KeyHandlerEvent$1;(function(B){B.KeyRatcheted="keyRatcheted"})(KeyHandlerEvent$1||(KeyHandlerEvent$1={}));var EncryptionEvent$1;(function(B){B.ParticipantEncryptionStatusChanged="participantEncryptionStatusChanged",B.EncryptionError="encryptionError"})(EncryptionEvent$1||(EncryptionEvent$1={}));var CryptorEvent$1;(function(B){B.Error="cryptorError"})(CryptorEvent$1||(CryptorEvent$1={}));function isE2EESupported$1(){return isInsertableStreamSupported$1()||isScriptTransformSupported$1()}function isScriptTransformSupported$1(){return typeof window.RTCRtpScriptTransform<"u"}function isInsertableStreamSupported$1(){return typeof window.RTCRtpSender<"u"&&typeof window.RTCRtpSender.prototype.createEncodedStreams<"u"}let BaseKeyProvider$1=class extends eventsExports$1.EventEmitter{constructor(){let $=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};super(),this.onKeyRatcheted=(U,F)=>{livekitLogger$1.debug("key ratcheted event received",{material:U,keyIndex:F})},this.keyInfoMap=new Map,this.options=Object.assign(Object.assign({},KEY_PROVIDER_DEFAULTS$1),$),this.on(KeyProviderEvent$1.KeyRatcheted,this.onKeyRatcheted)}onSetEncryptionKey($,U,F){const V={key:$,participantIdentity:U,keyIndex:F};if(!this.options.sharedKey&&!U)throw new Error("participant identity needs to be passed for encryption key if sharedKey option is false");this.keyInfoMap.set("".concat(U??"shared","-").concat(F??0),V),this.emit(KeyProviderEvent$1.SetKey,V)}getKeys(){return Array.from(this.keyInfoMap.values())}getOptions(){return this.options}ratchetKey($,U){this.emit(KeyProviderEvent$1.RatchetRequest,$,U)}},LivekitError$1=class extends Error{constructor($,U){super(U||"an error has occured"),this.name="LiveKitError",this.code=$}};var ConnectionErrorReason$1;(function(B){B[B.NotAllowed=0]="NotAllowed",B[B.ServerUnreachable=1]="ServerUnreachable",B[B.InternalError=2]="InternalError",B[B.Cancelled=3]="Cancelled",B[B.LeaveRequest=4]="LeaveRequest"})(ConnectionErrorReason$1||(ConnectionErrorReason$1={}));let ConnectionError$1=class extends LivekitError$1{constructor($,U,F,V){super(1,$),this.name="ConnectionError",this.status=F,this.reason=U,this.context=V,this.reasonName=ConnectionErrorReason$1[U]}},DeviceUnsupportedError$1=class extends LivekitError$1{constructor($){super(21,$??"device is unsupported"),this.name="DeviceUnsupportedError"}},TrackInvalidError$1=class extends LivekitError$1{constructor($){super(20,$??"track is invalid"),this.name="TrackInvalidError"}},UnsupportedServer$1=class extends LivekitError$1{constructor($){super(10,$??"unsupported server"),this.name="UnsupportedServer"}},UnexpectedConnectionState$1=class extends LivekitError$1{constructor($){super(12,$??"unexpected connection state"),this.name="UnexpectedConnectionState"}},NegotiationError$1=class extends LivekitError$1{constructor($){super(13,$??"unable to negotiate"),this.name="NegotiationError"}},PublishTrackError$1=class extends LivekitError$1{constructor($,U){super(15,$),this.name="PublishTrackError",this.status=U}},SignalRequestError$1=class extends LivekitError$1{constructor($,U){super(15,$),this.reason=U,this.reasonName=typeof U=="string"?U:RequestResponse_Reason$1[U]}};var MediaDeviceFailure$1;(function(B){B.PermissionDenied="PermissionDenied",B.NotFound="NotFound",B.DeviceInUse="DeviceInUse",B.Other="Other"})(MediaDeviceFailure$1||(MediaDeviceFailure$1={})),(function(B){function $(U){if(U&&"name"in U)return U.name==="NotFoundError"||U.name==="DevicesNotFoundError"?B.NotFound:U.name==="NotAllowedError"||U.name==="PermissionDeniedError"?B.PermissionDenied:U.name==="NotReadableError"||U.name==="TrackStartError"?B.DeviceInUse:B.Other}B.getFailure=$})(MediaDeviceFailure$1||(MediaDeviceFailure$1={}));var CryptorErrorReason$1;(function(B){B[B.InvalidKey=0]="InvalidKey",B[B.MissingKey=1]="MissingKey",B[B.InternalError=2]="InternalError"})(CryptorErrorReason$1||(CryptorErrorReason$1={}));var RoomEvent$1;(function(B){B.Connected="connected",B.Reconnecting="reconnecting",B.SignalReconnecting="signalReconnecting",B.Reconnected="reconnected",B.Disconnected="disconnected",B.ConnectionStateChanged="connectionStateChanged",B.MediaDevicesChanged="mediaDevicesChanged",B.ParticipantConnected="participantConnected",B.ParticipantDisconnected="participantDisconnected",B.TrackPublished="trackPublished",B.TrackSubscribed="trackSubscribed",B.TrackSubscriptionFailed="trackSubscriptionFailed",B.TrackUnpublished="trackUnpublished",B.TrackUnsubscribed="trackUnsubscribed",B.TrackMuted="trackMuted",B.TrackUnmuted="trackUnmuted",B.LocalTrackPublished="localTrackPublished",B.LocalTrackUnpublished="localTrackUnpublished",B.LocalAudioSilenceDetected="localAudioSilenceDetected",B.ActiveSpeakersChanged="activeSpeakersChanged",B.ParticipantMetadataChanged="participantMetadataChanged",B.ParticipantNameChanged="participantNameChanged",B.ParticipantAttributesChanged="participantAttributesChanged",B.RoomMetadataChanged="roomMetadataChanged",B.DataReceived="dataReceived",B.SipDTMFReceived="sipDTMFReceived",B.TranscriptionReceived="transcriptionReceived",B.ConnectionQualityChanged="connectionQualityChanged",B.TrackStreamStateChanged="trackStreamStateChanged",B.TrackSubscriptionPermissionChanged="trackSubscriptionPermissionChanged",B.TrackSubscriptionStatusChanged="trackSubscriptionStatusChanged",B.AudioPlaybackStatusChanged="audioPlaybackChanged",B.VideoPlaybackStatusChanged="videoPlaybackChanged",B.MediaDevicesError="mediaDevicesError",B.ParticipantPermissionsChanged="participantPermissionsChanged",B.SignalConnected="signalConnected",B.RecordingStatusChanged="recordingStatusChanged",B.ParticipantEncryptionStatusChanged="participantEncryptionStatusChanged",B.EncryptionError="encryptionError",B.DCBufferStatusChanged="dcBufferStatusChanged",B.ActiveDeviceChanged="activeDeviceChanged",B.ChatMessage="chatMessage",B.LocalTrackSubscribed="localTrackSubscribed",B.MetricsReceived="metricsReceived"})(RoomEvent$1||(RoomEvent$1={}));var ParticipantEvent$1;(function(B){B.TrackPublished="trackPublished",B.TrackSubscribed="trackSubscribed",B.TrackSubscriptionFailed="trackSubscriptionFailed",B.TrackUnpublished="trackUnpublished",B.TrackUnsubscribed="trackUnsubscribed",B.TrackMuted="trackMuted",B.TrackUnmuted="trackUnmuted",B.LocalTrackPublished="localTrackPublished",B.LocalTrackUnpublished="localTrackUnpublished",B.ParticipantMetadataChanged="participantMetadataChanged",B.ParticipantNameChanged="participantNameChanged",B.DataReceived="dataReceived",B.SipDTMFReceived="sipDTMFReceived",B.TranscriptionReceived="transcriptionReceived",B.IsSpeakingChanged="isSpeakingChanged",B.ConnectionQualityChanged="connectionQualityChanged",B.TrackStreamStateChanged="trackStreamStateChanged",B.TrackSubscriptionPermissionChanged="trackSubscriptionPermissionChanged",B.TrackSubscriptionStatusChanged="trackSubscriptionStatusChanged",B.MediaDevicesError="mediaDevicesError",B.AudioStreamAcquired="audioStreamAcquired",B.ParticipantPermissionsChanged="participantPermissionsChanged",B.PCTrackAdded="pcTrackAdded",B.AttributesChanged="attributesChanged",B.LocalTrackSubscribed="localTrackSubscribed",B.ChatMessage="chatMessage"})(ParticipantEvent$1||(ParticipantEvent$1={}));var EngineEvent$1;(function(B){B.TransportsCreated="transportsCreated",B.Connected="connected",B.Disconnected="disconnected",B.Resuming="resuming",B.Resumed="resumed",B.Restarting="restarting",B.Restarted="restarted",B.SignalResumed="signalResumed",B.SignalRestarted="signalRestarted",B.Closing="closing",B.MediaTrackAdded="mediaTrackAdded",B.ActiveSpeakersUpdate="activeSpeakersUpdate",B.DataPacketReceived="dataPacketReceived",B.RTPVideoMapUpdate="rtpVideoMapUpdate",B.DCBufferStatusChanged="dcBufferStatusChanged",B.ParticipantUpdate="participantUpdate",B.RoomUpdate="roomUpdate",B.SpeakersChanged="speakersChanged",B.StreamStateChanged="streamStateChanged",B.ConnectionQualityUpdate="connectionQualityUpdate",B.SubscriptionError="subscriptionError",B.SubscriptionPermissionUpdate="subscriptionPermissionUpdate",B.RemoteMute="remoteMute",B.SubscribedQualityUpdate="subscribedQualityUpdate",B.LocalTrackUnpublished="localTrackUnpublished",B.LocalTrackSubscribed="localTrackSubscribed",B.Offline="offline",B.SignalRequestResponse="signalRequestResponse",B.SignalConnected="signalConnected"})(EngineEvent$1||(EngineEvent$1={}));var TrackEvent$1;(function(B){B.Message="message",B.Muted="muted",B.Unmuted="unmuted",B.Restarted="restarted",B.Ended="ended",B.Subscribed="subscribed",B.Unsubscribed="unsubscribed",B.UpdateSettings="updateSettings",B.UpdateSubscription="updateSubscription",B.AudioPlaybackStarted="audioPlaybackStarted",B.AudioPlaybackFailed="audioPlaybackFailed",B.AudioSilenceDetected="audioSilenceDetected",B.VisibilityChanged="visibilityChanged",B.VideoDimensionsChanged="videoDimensionsChanged",B.VideoPlaybackStarted="videoPlaybackStarted",B.VideoPlaybackFailed="videoPlaybackFailed",B.ElementAttached="elementAttached",B.ElementDetached="elementDetached",B.UpstreamPaused="upstreamPaused",B.UpstreamResumed="upstreamResumed",B.SubscriptionPermissionChanged="subscriptionPermissionChanged",B.SubscriptionStatusChanged="subscriptionStatusChanged",B.SubscriptionFailed="subscriptionFailed",B.TrackProcessorUpdate="trackProcessorUpdate",B.AudioTrackFeatureUpdate="audioTrackFeatureUpdate",B.TranscriptionReceived="transcriptionReceived",B.TimeSyncUpdate="timeSyncUpdate"})(TrackEvent$1||(TrackEvent$1={}));function cloneDeep$1(B){return typeof B>"u"?B:typeof structuredClone=="function"?structuredClone(B):JSON.parse(JSON.stringify(B))}const commonVersionIdentifier$1=/version\/(\d+(\.?_?\d+)+)/i;let browserDetails$1;function getBrowser$1(B){let $=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0;if(typeof navigator>"u")return;const U=navigator.userAgent.toLowerCase();if(browserDetails$1===void 0||$){const F=browsersList$1.find(V=>{let{test:q}=V;return q.test(U)});browserDetails$1=F?.describe(U)}return browserDetails$1}const browsersList$1=[{test:/firefox|iceweasel|fxios/i,describe(B){return{name:"Firefox",version:getMatch$1(/(?:firefox|iceweasel|fxios)[\s/](\d+(\.?_?\d+)+)/i,B),os:B.toLowerCase().includes("fxios")?"iOS":void 0,osVersion:getOSVersion$1(B)}}},{test:/chrom|crios|crmo/i,describe(B){return{name:"Chrome",version:getMatch$1(/(?:chrome|chromium|crios|crmo)\/(\d+(\.?_?\d+)+)/i,B),os:B.toLowerCase().includes("crios")?"iOS":void 0,osVersion:getOSVersion$1(B)}}},{test:/safari|applewebkit/i,describe(B){return{name:"Safari",version:getMatch$1(commonVersionIdentifier$1,B),os:B.includes("mobile/")?"iOS":"macOS",osVersion:getOSVersion$1(B)}}}];function getMatch$1(B,$){let U=arguments.length>2&&arguments[2]!==void 0?arguments[2]:1;const F=$.match(B);return F&&F.length>=U&&F[U]||""}function getOSVersion$1(B){return B.includes("mac os")?getMatch$1(/\(.+?(\d+_\d+(:?_\d+)?)/,B,1).replace(/_/g,"."):void 0}var version$1$1="2.11.3";const version$2=version$1$1,protocolVersion$1=15;let CriticalTimers$1=class{};CriticalTimers$1.setTimeout=function(){return setTimeout(...arguments)},CriticalTimers$1.setInterval=function(){return setInterval(...arguments)},CriticalTimers$1.clearTimeout=function(){return clearTimeout(...arguments)},CriticalTimers$1.clearInterval=function(){return clearInterval(...arguments)};const BACKGROUND_REACTION_DELAY$1=5e3,recycledElements$1=[];var VideoQuality$2;(function(B){B[B.LOW=0]="LOW",B[B.MEDIUM=1]="MEDIUM",B[B.HIGH=2]="HIGH"})(VideoQuality$2||(VideoQuality$2={}));let Track$1=class qe extends eventsExports$1.EventEmitter{constructor($,U){let F=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};var V;super(),this.attachedElements=[],this.isMuted=!1,this.streamState=qe.StreamState.Active,this.isInBackground=!1,this._currentBitrate=0,this.log=livekitLogger$1,this.appVisibilityChangedListener=()=>{this.backgroundTimeout&&clearTimeout(this.backgroundTimeout),document.visibilityState==="hidden"?this.backgroundTimeout=setTimeout(()=>this.handleAppVisibilityChanged(),BACKGROUND_REACTION_DELAY$1):this.handleAppVisibilityChanged()},this.log=getLogger$1((V=F.loggerName)!==null&&V!==void 0?V:LoggerNames$1.Track),this.loggerContextCb=F.loggerContextCb,this.setMaxListeners(100),this.kind=U,this._mediaStreamTrack=$,this._mediaStreamID=$.id,this.source=qe.Source.Unknown}get logContext(){var $;return Object.assign(Object.assign({},($=this.loggerContextCb)===null||$===void 0?void 0:$.call(this)),getLogContextFromTrack$1(this))}get currentBitrate(){return this._currentBitrate}get mediaStreamTrack(){return this._mediaStreamTrack}get mediaStreamID(){return this._mediaStreamID}attach($){let U="audio";this.kind===qe.Kind.Video&&(U="video"),this.attachedElements.length===0&&this.kind===qe.Kind.Video&&this.addAppVisibilityListener(),$||(U==="audio"&&(recycledElements$1.forEach(q=>{q.parentElement===null&&!$&&($=q)}),$&&recycledElements$1.splice(recycledElements$1.indexOf($),1)),$||($=document.createElement(U))),this.attachedElements.includes($)||this.attachedElements.push($),attachToElement$1(this.mediaStreamTrack,$);const F=$.srcObject.getTracks(),V=F.some(q=>q.kind==="audio");return $.play().then(()=>{this.emit(V?TrackEvent$1.AudioPlaybackStarted:TrackEvent$1.VideoPlaybackStarted)}).catch(q=>{q.name==="NotAllowedError"?this.emit(V?TrackEvent$1.AudioPlaybackFailed:TrackEvent$1.VideoPlaybackFailed,q):q.name==="AbortError"?livekitLogger$1.debug("".concat(V?"audio":"video"," playback aborted, likely due to new play request")):livekitLogger$1.warn("could not playback ".concat(V?"audio":"video"),q),V&&$&&F.some(j=>j.kind==="video")&&q.name==="NotAllowedError"&&($.muted=!0,$.play().catch(()=>{}))}),this.emit(TrackEvent$1.ElementAttached,$),$}detach($){try{if($){detachTrack$1(this.mediaStreamTrack,$);const F=this.attachedElements.indexOf($);return F>=0&&(this.attachedElements.splice(F,1),this.recycleElement($),this.emit(TrackEvent$1.ElementDetached,$)),$}const U=[];return this.attachedElements.forEach(F=>{detachTrack$1(this.mediaStreamTrack,F),U.push(F),this.recycleElement(F),this.emit(TrackEvent$1.ElementDetached,F)}),this.attachedElements=[],U}finally{this.attachedElements.length===0&&this.removeAppVisibilityListener()}}stop(){this.stopMonitor(),this._mediaStreamTrack.stop()}enable(){this._mediaStreamTrack.enabled=!0}disable(){this._mediaStreamTrack.enabled=!1}stopMonitor(){this.monitorInterval&&clearInterval(this.monitorInterval),this.timeSyncHandle&&cancelAnimationFrame(this.timeSyncHandle)}updateLoggerOptions($){$.loggerName&&(this.log=getLogger$1($.loggerName)),$.loggerContextCb&&(this.loggerContextCb=$.loggerContextCb)}recycleElement($){if($ instanceof HTMLAudioElement){let U=!0;$.pause(),recycledElements$1.forEach(F=>{F.parentElement||(U=!1)}),U&&recycledElements$1.push($)}}handleAppVisibilityChanged(){return __awaiter$2(this,void 0,void 0,function*(){this.isInBackground=document.visibilityState==="hidden",!this.isInBackground&&this.kind===qe.Kind.Video&&setTimeout(()=>this.attachedElements.forEach($=>$.play().catch(()=>{})),0)})}addAppVisibilityListener(){isWeb$1()?(this.isInBackground=document.visibilityState==="hidden",document.addEventListener("visibilitychange",this.appVisibilityChangedListener)):this.isInBackground=!1}removeAppVisibilityListener(){isWeb$1()&&document.removeEventListener("visibilitychange",this.appVisibilityChangedListener)}};function attachToElement$1(B,$){let U;$.srcObject instanceof MediaStream?U=$.srcObject:U=new MediaStream;let F;B.kind==="audio"?F=U.getAudioTracks():F=U.getVideoTracks(),F.includes(B)||(F.forEach(V=>{U.removeTrack(V)}),U.addTrack(B)),(!isSafari$1()||!($ instanceof HTMLVideoElement))&&($.autoplay=!0),$.muted=U.getAudioTracks().length===0,$ instanceof HTMLVideoElement&&($.playsInline=!0),$.srcObject!==U&&($.srcObject=U,(isSafari$1()||isFireFox$1())&&$ instanceof HTMLVideoElement&&setTimeout(()=>{$.srcObject=U,$.play().catch(()=>{})},0))}function detachTrack$1(B,$){if($.srcObject instanceof MediaStream){const U=$.srcObject;U.removeTrack(B),U.getTracks().length>0?$.srcObject=U:$.srcObject=null}}(function(B){let $;(function(G){G.Audio="audio",G.Video="video",G.Unknown="unknown"})($=B.Kind||(B.Kind={}));let U;(function(G){G.Camera="camera",G.Microphone="microphone",G.ScreenShare="screen_share",G.ScreenShareAudio="screen_share_audio",G.Unknown="unknown"})(U=B.Source||(B.Source={}));let F;(function(G){G.Active="active",G.Paused="paused",G.Unknown="unknown"})(F=B.StreamState||(B.StreamState={}));function V(G){switch(G){case $.Audio:return TrackType$1.AUDIO;case $.Video:return TrackType$1.VIDEO;default:return TrackType$1.DATA}}B.kindToProto=V;function q(G){switch(G){case TrackType$1.AUDIO:return $.Audio;case TrackType$1.VIDEO:return $.Video;default:return $.Unknown}}B.kindFromProto=q;function j(G){switch(G){case U.Camera:return TrackSource$1.CAMERA;case U.Microphone:return TrackSource$1.MICROPHONE;case U.ScreenShare:return TrackSource$1.SCREEN_SHARE;case U.ScreenShareAudio:return TrackSource$1.SCREEN_SHARE_AUDIO;default:return TrackSource$1.UNKNOWN}}B.sourceToProto=j;function W(G){switch(G){case TrackSource$1.CAMERA:return U.Camera;case TrackSource$1.MICROPHONE:return U.Microphone;case TrackSource$1.SCREEN_SHARE:return U.ScreenShare;case TrackSource$1.SCREEN_SHARE_AUDIO:return U.ScreenShareAudio;default:return U.Unknown}}B.sourceFromProto=W;function K(G){switch(G){case StreamState$1.ACTIVE:return F.Active;case StreamState$1.PAUSED:return F.Paused;default:return F.Unknown}}B.streamStateFromProto=K})(Track$1||(Track$1={}));let VideoPreset$1=class{constructor($,U,F,V,q){if(typeof $=="object")this.width=$.width,this.height=$.height,this.aspectRatio=$.aspectRatio,this.encoding={maxBitrate:$.maxBitrate,maxFramerate:$.maxFramerate,priority:$.priority};else if(U!==void 0&&F!==void 0)this.width=$,this.height=U,this.aspectRatio=$/U,this.encoding={maxBitrate:F,maxFramerate:V,priority:q};else throw new TypeError("Unsupported options: provide at least width, height and maxBitrate")}get resolution(){return{width:this.width,height:this.height,frameRate:this.encoding.maxFramerate,aspectRatio:this.aspectRatio}}};const backupCodecs$1=["vp8","h264"],videoCodecs$1=["vp8","h264","vp9","av1"];function isBackupCodec$1(B){return!!backupCodecs$1.find($=>$===B)}var BackupCodecPolicy$2;(function(B){B[B.PREFER_REGRESSION=0]="PREFER_REGRESSION",B[B.SIMULCAST=1]="SIMULCAST",B[B.REGRESSION=2]="REGRESSION"})(BackupCodecPolicy$2||(BackupCodecPolicy$2={}));var AudioPresets$1;(function(B){B.telephone={maxBitrate:12e3},B.speech={maxBitrate:24e3},B.music={maxBitrate:48e3},B.musicStereo={maxBitrate:64e3},B.musicHighQuality={maxBitrate:96e3},B.musicHighQualityStereo={maxBitrate:128e3}})(AudioPresets$1||(AudioPresets$1={}));const VideoPresets$1={h90:new VideoPreset$1(160,90,9e4,20),h180:new VideoPreset$1(320,180,16e4,20),h216:new VideoPreset$1(384,216,18e4,20),h360:new VideoPreset$1(640,360,45e4,20),h540:new VideoPreset$1(960,540,8e5,25),h720:new VideoPreset$1(1280,720,17e5,30),h1080:new VideoPreset$1(1920,1080,3e6,30),h1440:new VideoPreset$1(2560,1440,5e6,30),h2160:new VideoPreset$1(3840,2160,8e6,30)},VideoPresets43$1={h120:new VideoPreset$1(160,120,7e4,20),h180:new VideoPreset$1(240,180,125e3,20),h240:new VideoPreset$1(320,240,14e4,20),h360:new VideoPreset$1(480,360,33e4,20),h480:new VideoPreset$1(640,480,5e5,20),h540:new VideoPreset$1(720,540,6e5,25),h720:new VideoPreset$1(960,720,13e5,30),h1080:new VideoPreset$1(1440,1080,23e5,30),h1440:new VideoPreset$1(1920,1440,38e5,30)},ScreenSharePresets$1={h360fps3:new VideoPreset$1(640,360,2e5,3,"medium"),h360fps15:new VideoPreset$1(640,360,4e5,15,"medium"),h720fps5:new VideoPreset$1(1280,720,8e5,5,"medium"),h720fps15:new VideoPreset$1(1280,720,15e5,15,"medium"),h720fps30:new VideoPreset$1(1280,720,2e6,30,"medium"),h1080fps15:new VideoPreset$1(1920,1080,25e5,15,"medium"),h1080fps30:new VideoPreset$1(1920,1080,5e6,30,"medium"),original:new VideoPreset$1(0,0,7e6,30,"medium")},separator$1="|",ddExtensionURI$1="https://aomediacodec.github.io/av1-rtp-spec/#dependency-descriptor-rtp-header-extension";function unpackStreamId$1(B){const $=B.split(separator$1);return $.length>1?[$[0],B.substr($[0].length+1)]:[B,""]}function sleep$2(B){return __awaiter$2(this,void 0,void 0,function*(){return new Promise($=>CriticalTimers$1.setTimeout($,B))})}function supportsTransceiver$1(){return"addTransceiver"in RTCPeerConnection.prototype}function supportsAddTrack$1(){return"addTrack"in RTCPeerConnection.prototype}function supportsAV1$1(){if(!("getCapabilities"in RTCRtpSender)||isSafari$1())return!1;const B=RTCRtpSender.getCapabilities("video");let $=!1;if(B){for(const U of B.codecs)if(U.mimeType==="video/AV1"){$=!0;break}}return $}function supportsVP9$1(){if(!("getCapabilities"in RTCRtpSender)||isFireFox$1())return!1;if(isSafari$1()){const U=getBrowser$1();if(U?.version&&compareVersions$1(U.version,"16")<0)return!1}const B=RTCRtpSender.getCapabilities("video");let $=!1;if(B){for(const U of B.codecs)if(U.mimeType==="video/VP9"){$=!0;break}}return $}function isSVCCodec$1(B){return B==="av1"||B==="vp9"}function supportsSetSinkId$1(B){return document?(B||(B=document.createElement("audio")),"setSinkId"in B):!1}function isBrowserSupported$1(){return typeof RTCPeerConnection>"u"?!1:supportsTransceiver$1()||supportsAddTrack$1()}function isFireFox$1(){var B;return((B=getBrowser$1())===null||B===void 0?void 0:B.name)==="Firefox"}function isSafari$1(){var B;return((B=getBrowser$1())===null||B===void 0?void 0:B.name)==="Safari"}function isSafari17(){const B=getBrowser$1();return B?.name==="Safari"&&B.version.startsWith("17.")}function isMobile$1(){var B,$;return isWeb$1()?($=(B=navigator.userAgentData)===null||B===void 0?void 0:B.mobile)!==null&&$!==void 0?$:/Tablet|iPad|Mobile|Android|BlackBerry/.test(navigator.userAgent):!1}function isE2EESimulcastSupported$1(){const B=getBrowser$1(),$="17.2";if(B)return B.name!=="Safari"&&B.os!=="iOS"||B.os==="iOS"&&B.osVersion&&compareVersions$1($,B.osVersion)>=0?!0:B.name==="Safari"&&compareVersions$1($,B.version)>=0}function isWeb$1(){return typeof document<"u"}function isReactNative$1(){return navigator.product=="ReactNative"}function isCloud$1(B){return B.hostname.endsWith(".livekit.cloud")||B.hostname.endsWith(".livekit.run")}function getLKReactNativeInfo$1(){if(global&&global.LiveKitReactNativeGlobal)return global.LiveKitReactNativeGlobal}function getReactNativeOs$1(){if(!isReactNative$1())return;let B=getLKReactNativeInfo$1();if(B)return B.platform}function getDevicePixelRatio$1(){if(isWeb$1())return window.devicePixelRatio;if(isReactNative$1()){let B=getLKReactNativeInfo$1();if(B)return B.devicePixelRatio}return 1}function compareVersions$1(B,$){const U=B.split("."),F=$.split("."),V=Math.min(U.length,F.length);for(let q=0;q<V;++q){const j=parseInt(U[q],10),W=parseInt(F[q],10);if(j>W)return 1;if(j<W)return-1;if(q===V-1&&j===W)return 0}return B===""&&$!==""?-1:$===""?1:U.length==F.length?0:U.length<F.length?-1:1}function roDispatchCallback$1(B){for(const $ of B)$.target.handleResize($)}function ioDispatchCallback$1(B){for(const $ of B)$.target.handleVisibilityChanged($)}let resizeObserver$1=null;const getResizeObserver$1=()=>(resizeObserver$1||(resizeObserver$1=new ResizeObserver(roDispatchCallback$1)),resizeObserver$1);let intersectionObserver$1=null;const getIntersectionObserver$1=()=>(intersectionObserver$1||(intersectionObserver$1=new IntersectionObserver(ioDispatchCallback$1,{root:null,rootMargin:"0px"})),intersectionObserver$1);function getClientInfo$1(){var B;const $=new ClientInfo$1({sdk:ClientInfo_SDK$1.JS,protocol:protocolVersion$1,version:version$2});return isReactNative$1()&&($.os=(B=getReactNativeOs$1())!==null&&B!==void 0?B:""),$}function createDummyVideoStreamTrack$1(){let B=arguments.length>0&&arguments[0]!==void 0?arguments[0]:16,$=arguments.length>1&&arguments[1]!==void 0?arguments[1]:16,U=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1,F=arguments.length>3&&arguments[3]!==void 0?arguments[3]:!1;const V=document.createElement("canvas");V.width=B,V.height=$;const q=V.getContext("2d");q?.fillRect(0,0,V.width,V.height),F&&q&&(q.beginPath(),q.arc(B/2,$/2,50,0,Math.PI*2,!0),q.closePath(),q.fillStyle="grey",q.fill());const j=V.captureStream(),[W]=j.getTracks();if(!W)throw Error("Could not get empty media stream video track");return W.enabled=U,W}let emptyAudioStreamTrack$1;function getEmptyAudioStreamTrack$1(){if(!emptyAudioStreamTrack$1){const B=new AudioContext,$=B.createOscillator(),U=B.createGain();U.gain.setValueAtTime(0,0);const F=B.createMediaStreamDestination();if($.connect(U),U.connect(F),$.start(),[emptyAudioStreamTrack$1]=F.stream.getAudioTracks(),!emptyAudioStreamTrack$1)throw Error("Could not get empty media stream audio track");emptyAudioStreamTrack$1.enabled=!1}return emptyAudioStreamTrack$1.clone()}let Future$1=class{constructor($,U){this.onFinally=U,this.promise=new Promise((F,V)=>__awaiter$2(this,void 0,void 0,function*(){this.resolve=F,this.reject=V,$&&(yield $(F,V))})).finally(()=>{var F;return(F=this.onFinally)===null||F===void 0?void 0:F.call(this)})}};function isVideoCodec$1(B){return videoCodecs$1.includes(B)}function unwrapConstraint$1(B){if(typeof B=="string"||typeof B=="number")return B;if(Array.isArray(B))return B[0];if(B.exact)return Array.isArray(B.exact)?B.exact[0]:B.exact;if(B.ideal)return Array.isArray(B.ideal)?B.ideal[0]:B.ideal;throw Error("could not unwrap constraint")}function toWebsocketUrl$1(B){return B.startsWith("http")?B.replace(/^(http)/,"ws"):B}function toHttpUrl$1(B){return B.startsWith("ws")?B.replace(/^(ws)/,"http"):B}function extractTranscriptionSegments$1(B,$){return B.segments.map(U=>{let{id:F,text:V,language:q,startTime:j,endTime:W,final:K}=U;var G;const z=(G=$.get(F))!==null&&G!==void 0?G:Date.now(),H=Date.now();return K?$.delete(F):$.set(F,z),{id:F,text:V,startTime:Number.parseInt(j.toString()),endTime:Number.parseInt(W.toString()),final:K,language:q,firstReceivedTime:z,lastReceivedTime:H}})}function extractChatMessage$1(B){const{id:$,timestamp:U,message:F,editTimestamp:V}=B;return{id:$,timestamp:Number.parseInt(U.toString()),editTimestamp:V?Number.parseInt(V.toString()):void 0,message:F}}function getDisconnectReasonFromConnectionError$1(B){switch(B.reason){case ConnectionErrorReason$1.LeaveRequest:return B.context;case ConnectionErrorReason$1.Cancelled:return DisconnectReason$1.CLIENT_INITIATED;case ConnectionErrorReason$1.NotAllowed:return DisconnectReason$1.USER_REJECTED;case ConnectionErrorReason$1.ServerUnreachable:return DisconnectReason$1.JOIN_FAILURE;default:return DisconnectReason$1.UNKNOWN_REASON}}function bigIntToNumber$1(B){return B!==void 0?Number(B):void 0}function numberToBigInt$1(B){return B!==void 0?BigInt(B):void 0}function isLocalTrack$1(B){return!!B&&!(B instanceof MediaStreamTrack)&&B.isLocal}function isAudioTrack$1(B){return!!B&&B.kind==Track$1.Kind.Audio}function isVideoTrack$1(B){return!!B&&B.kind==Track$1.Kind.Video}function isLocalVideoTrack$1(B){return isLocalTrack$1(B)&&isVideoTrack$1(B)}function isLocalAudioTrack$1(B){return isLocalTrack$1(B)&&isAudioTrack$1(B)}function isRemoteTrack$1(B){return!!B&&!B.isLocal}function isRemotePub$1(B){return!!B&&!B.isLocal}function isRemoteVideoTrack$1(B){return isRemoteTrack$1(B)&&isVideoTrack$1(B)}function isLocalParticipant$1(B){return B.isLocal}function splitUtf8$1(B,$){const U=[];let F=new TextEncoder().encode(B);for(;F.length>$;){let V=$;for(;V>0;){const q=F[V];if(q!==void 0&&(q&192)!==128)break;V--}U.push(F.slice(0,V)),F=F.slice(V)}return F.length>0&&U.push(F),U}function mergeDefaultOptions$1(B,$,U){var F,V,q,j;const{optionsWithoutProcessor:W,audioProcessor:K,videoProcessor:G}=extractProcessorsFromOptions$1(B??{}),z=$?.processor,H=U?.processor,Q=W??{};return Q.audio===!0&&(Q.audio={}),Q.video===!0&&(Q.video={}),Q.audio&&(mergeObjectWithoutOverwriting$1(Q.audio,$),(F=(q=Q.audio).deviceId)!==null&&F!==void 0||(q.deviceId={ideal:"default"}),(K||z)&&(Q.audio.processor=K??z)),Q.video&&(mergeObjectWithoutOverwriting$1(Q.video,U),(V=(j=Q.video).deviceId)!==null&&V!==void 0||(j.deviceId={ideal:"default"}),(G||H)&&(Q.video.processor=G??H)),Q}function mergeObjectWithoutOverwriting$1(B,$){return Object.keys($).forEach(U=>{B[U]===void 0&&(B[U]=$[U])}),B}function constraintsForOptions$1(B){var $,U,F,V;const q={};if(B.video)if(typeof B.video=="object"){const j={},W=j,K=B.video;Object.keys(K).forEach(G=>{switch(G){case"resolution":mergeObjectWithoutOverwriting$1(W,K.resolution);break;default:W[G]=K[G]}}),q.video=j,($=(F=q.video).deviceId)!==null&&$!==void 0||(F.deviceId={ideal:"default"})}else q.video=B.video?{deviceId:{ideal:"default"}}:!1;else q.video=!1;return B.audio?typeof B.audio=="object"?(q.audio=B.audio,(U=(V=q.audio).deviceId)!==null&&U!==void 0||(V.deviceId={ideal:"default"})):q.audio={deviceId:{ideal:"default"}}:q.audio=!1,q}function detectSilence$1(B){return __awaiter$2(this,arguments,void 0,function($){let U=arguments.length>1&&arguments[1]!==void 0?arguments[1]:200;return(function*(){const F=getNewAudioContext$1();if(F){const V=F.createAnalyser();V.fftSize=2048;const q=V.frequencyBinCount,j=new Uint8Array(q);F.createMediaStreamSource(new MediaStream([$.mediaStreamTrack])).connect(V),yield sleep$2(U),V.getByteTimeDomainData(j);const K=j.some(G=>G!==128&&G!==0);return F.close(),!K}return!1})()})}function getNewAudioContext$1(){var B;const $=typeof window<"u"&&(window.AudioContext||window.webkitAudioContext);if($){const U=new $({latencyHint:"interactive"});if(U.state==="suspended"&&typeof window<"u"&&(!((B=window.document)===null||B===void 0)&&B.body)){const F=()=>__awaiter$2(this,void 0,void 0,function*(){var V;try{U.state==="suspended"&&(yield U.resume())}catch(q){console.warn("Error trying to auto-resume audio context",q)}(V=window.document.body)===null||V===void 0||V.removeEventListener("click",F)});window.document.body.addEventListener("click",F)}return U}}function sourceToKind$1(B){return B===Track$1.Source.Microphone?"audioinput":B===Track$1.Source.Camera?"videoinput":void 0}function screenCaptureToDisplayMediaStreamOptions$1(B){var $,U;let F=($=B.video)!==null&&$!==void 0?$:!0;return B.resolution&&B.resolution.width>0&&B.resolution.height>0&&(F=typeof F=="boolean"?{}:F,isSafari$1()?F=Object.assign(Object.assign({},F),{width:{max:B.resolution.width},height:{max:B.resolution.height},frameRate:B.resolution.frameRate}):F=Object.assign(Object.assign({},F),{width:{ideal:B.resolution.width},height:{ideal:B.resolution.height},frameRate:B.resolution.frameRate})),{audio:(U=B.audio)!==null&&U!==void 0?U:!1,video:F,controller:B.controller,selfBrowserSurface:B.selfBrowserSurface,surfaceSwitching:B.surfaceSwitching,systemAudio:B.systemAudio,preferCurrentTab:B.preferCurrentTab}}function mimeTypeToVideoCodecString$1(B){return B.split("/")[1].toLowerCase()}function getTrackPublicationInfo$1(B){const $=[];return B.forEach(U=>{U.track!==void 0&&$.push(new TrackPublishedResponse$1({cid:U.track.mediaStreamID,track:U.trackInfo}))}),$}function getLogContextFromTrack$1(B){return"mediaStreamTrack"in B?{trackID:B.sid,source:B.source,muted:B.isMuted,enabled:B.mediaStreamTrack.enabled,kind:B.kind,streamID:B.mediaStreamID,streamTrackID:B.mediaStreamTrack.id}:{trackID:B.trackSid,enabled:B.isEnabled,muted:B.isMuted,trackInfo:Object.assign({mimeType:B.mimeType,name:B.trackName,encrypted:B.isEncrypted,kind:B.kind,source:B.source},B.track?getLogContextFromTrack$1(B.track):{})}}function supportsSynchronizationSources$1(){return typeof RTCRtpReceiver<"u"&&"getSynchronizationSources"in RTCRtpReceiver}function diffAttributes$1(B,$){var U;B===void 0&&(B={}),$===void 0&&($={});const F=[...Object.keys($),...Object.keys(B)],V={};for(const q of F)B[q]!==$[q]&&(V[q]=(U=$[q])!==null&&U!==void 0?U:"");return V}function extractProcessorsFromOptions$1(B){const $=Object.assign({},B);let U,F;return typeof $.audio=="object"&&$.audio.processor&&(U=$.audio.processor,$.audio=Object.assign(Object.assign({},$.audio),{processor:void 0})),typeof $.video=="object"&&$.video.processor&&(F=$.video.processor,$.video=Object.assign(Object.assign({},$.video),{processor:void 0})),{audioProcessor:U,videoProcessor:F,optionsWithoutProcessor:cloneDeep$1($)}}function getTrackSourceFromProto$1(B){switch(B){case TrackSource$1.CAMERA:return Track$1.Source.Camera;case TrackSource$1.MICROPHONE:return Track$1.Source.Microphone;case TrackSource$1.SCREEN_SHARE:return Track$1.Source.ScreenShare;case TrackSource$1.SCREEN_SHARE_AUDIO:return Track$1.Source.ScreenShareAudio;default:return Track$1.Source.Unknown}}let E2EEManager$1=class extends eventsExports$1.EventEmitter{constructor($){super(),this.onWorkerMessage=U=>{var F,V;const{kind:q,data:j}=U.data;switch(q){case"error":livekitLogger$1.error(j.error.message),this.emit(EncryptionEvent$1.EncryptionError,j.error);break;case"initAck":j.enabled&&this.keyProvider.getKeys().forEach(W=>{this.postKey(W)});break;case"enable":if(j.enabled&&this.keyProvider.getKeys().forEach(W=>{this.postKey(W)}),this.encryptionEnabled!==j.enabled&&j.participantIdentity===((F=this.room)===null||F===void 0?void 0:F.localParticipant.identity))this.emit(EncryptionEvent$1.ParticipantEncryptionStatusChanged,j.enabled,this.room.localParticipant),this.encryptionEnabled=j.enabled;else if(j.participantIdentity){const W=(V=this.room)===null||V===void 0?void 0:V.getParticipantByIdentity(j.participantIdentity);if(!W)throw TypeError("couldn't set encryption status, participant not found".concat(j.participantIdentity));this.emit(EncryptionEvent$1.ParticipantEncryptionStatusChanged,j.enabled,W)}break;case"ratchetKey":this.keyProvider.emit(KeyProviderEvent$1.KeyRatcheted,j.material,j.keyIndex);break}},this.onWorkerError=U=>{livekitLogger$1.error("e2ee worker encountered an error:",{error:U.error}),this.emit(EncryptionEvent$1.EncryptionError,U.error)},this.keyProvider=$.keyProvider,this.worker=$.worker,this.encryptionEnabled=!1}setup($){if(!isE2EESupported$1())throw new DeviceUnsupportedError$1("tried to setup end-to-end encryption on an unsupported browser");if(livekitLogger$1.info("setting up e2ee"),$!==this.room){this.room=$,this.setupEventListeners($,this.keyProvider);const U={kind:"init",data:{keyProviderOptions:this.keyProvider.getOptions(),loglevel:workerLogger$1.getLevel()}};this.worker&&(livekitLogger$1.info("initializing worker",{worker:this.worker}),this.worker.onmessage=this.onWorkerMessage,this.worker.onerror=this.onWorkerError,this.worker.postMessage(U))}}setParticipantCryptorEnabled($,U){livekitLogger$1.debug("set e2ee to ".concat($," for participant ").concat(U)),this.postEnable($,U)}setSifTrailer($){!$||$.length===0?livekitLogger$1.warn("ignoring server sent trailer as it's empty"):this.postSifTrailer($)}setupEngine($){$.on(EngineEvent$1.RTPVideoMapUpdate,U=>{this.postRTPMap(U)})}setupEventListeners($,U){$.on(RoomEvent$1.TrackPublished,(F,V)=>this.setParticipantCryptorEnabled(F.trackInfo.encryption!==Encryption_Type$1.NONE,V.identity)),$.on(RoomEvent$1.ConnectionStateChanged,F=>{F===ConnectionState$1.Connected&&$.remoteParticipants.forEach(V=>{V.trackPublications.forEach(q=>{this.setParticipantCryptorEnabled(q.trackInfo.encryption!==Encryption_Type$1.NONE,V.identity)})})}).on(RoomEvent$1.TrackUnsubscribed,(F,V,q)=>{var j;const W={kind:"removeTransform",data:{participantIdentity:q.identity,trackId:F.mediaStreamID}};(j=this.worker)===null||j===void 0||j.postMessage(W)}).on(RoomEvent$1.TrackSubscribed,(F,V,q)=>{this.setupE2EEReceiver(F,q.identity,V.trackInfo)}).on(RoomEvent$1.SignalConnected,()=>{if(!this.room)throw new TypeError("expected room to be present on signal connect");U.getKeys().forEach(F=>{this.postKey(F)}),this.setParticipantCryptorEnabled(this.room.localParticipant.isE2EEEnabled,this.room.localParticipant.identity)}),$.localParticipant.on(ParticipantEvent$1.LocalTrackPublished,F=>__awaiter$2(this,void 0,void 0,function*(){this.setupE2EESender(F.track,F.track.sender)})),U.on(KeyProviderEvent$1.SetKey,F=>this.postKey(F)).on(KeyProviderEvent$1.RatchetRequest,(F,V)=>this.postRatchetRequest(F,V,U.getOptions().allowKeyExtraction))}postRatchetRequest($,U,F){if(!this.worker)throw Error("could not ratchet key, worker is missing");const V={kind:"ratchetRequest",data:{participantIdentity:$,keyIndex:U,extractable:F}};this.worker.postMessage(V)}postKey($){let{key:U,participantIdentity:F,keyIndex:V}=$;var q;if(!this.worker)throw Error("could not set key, worker is missing");const j={kind:"setKey",data:{participantIdentity:F,isPublisher:F===((q=this.room)===null||q===void 0?void 0:q.localParticipant.identity),key:U,keyIndex:V}};this.worker.postMessage(j)}postEnable($,U){if(this.worker){const F={kind:"enable",data:{enabled:$,participantIdentity:U}};this.worker.postMessage(F)}else throw new ReferenceError("failed to enable e2ee, worker is not ready")}postRTPMap($){var U;if(!this.worker)throw TypeError("could not post rtp map, worker is missing");if(!(!((U=this.room)===null||U===void 0)&&U.localParticipant.identity))throw TypeError("could not post rtp map, local participant identity is missing");const F={kind:"setRTPMap",data:{map:$,participantIdentity:this.room.localParticipant.identity}};this.worker.postMessage(F)}postSifTrailer($){if(!this.worker)throw Error("could not post SIF trailer, worker is missing");const U={kind:"setSifTrailer",data:{trailer:$}};this.worker.postMessage(U)}setupE2EEReceiver($,U,F){if($.receiver){if(!F?.mimeType||F.mimeType==="")throw new TypeError("MimeType missing from trackInfo, cannot set up E2EE cryptor");this.handleReceiver($.receiver,$.mediaStreamID,U,$.kind==="video"?mimeTypeToVideoCodecString$1(F.mimeType):void 0)}}setupE2EESender($,U){if(!isLocalTrack$1($)||!U){U||livekitLogger$1.warn("early return because sender is not ready");return}this.handleSender(U,$.mediaStreamID,void 0)}handleReceiver($,U,F,V){return __awaiter$2(this,void 0,void 0,function*(){if(this.worker){if(isScriptTransformSupported$1()){const q={kind:"decode",participantIdentity:F,trackId:U,codec:V};$.transform=new RTCRtpScriptTransform(this.worker,q)}else{if(E2EE_FLAG$1 in $&&V){const K={kind:"updateCodec",data:{trackId:U,codec:V,participantIdentity:F}};this.worker.postMessage(K);return}let q=$.writableStream,j=$.readableStream;if(!q||!j){const K=$.createEncodedStreams();$.writableStream=K.writable,q=K.writable,$.readableStream=K.readable,j=K.readable}const W={kind:"decode",data:{readableStream:j,writableStream:q,trackId:U,codec:V,participantIdentity:F}};this.worker.postMessage(W,[j,q])}$[E2EE_FLAG$1]=!0}})}handleSender($,U,F){var V;if(!(E2EE_FLAG$1 in $||!this.worker)){if(!(!((V=this.room)===null||V===void 0)&&V.localParticipant.identity)||this.room.localParticipant.identity==="")throw TypeError("local identity needs to be known in order to set up encrypted sender");if(isScriptTransformSupported$1()){livekitLogger$1.info("initialize script transform");const q={kind:"encode",participantIdentity:this.room.localParticipant.identity,trackId:U,codec:F};$.transform=new RTCRtpScriptTransform(this.worker,q)}else{livekitLogger$1.info("initialize encoded streams");const q=$.createEncodedStreams(),j={kind:"encode",data:{readableStream:q.readable,writableStream:q.writable,codec:F,trackId:U,participantIdentity:this.room.localParticipant.identity}};this.worker.postMessage(j,[q.readable,q.writable])}$[E2EE_FLAG$1]=!0}}};const defaultId$1="default";let DeviceManager$1=class Fe{constructor(){this._previousDevices=[]}static getInstance(){return this.instance===void 0&&(this.instance=new Fe),this.instance}get previousDevices(){return this._previousDevices}getDevices($){return __awaiter$2(this,arguments,void 0,function(U){var F=this;let V=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0;return(function*(){var q;if(((q=Fe.userMediaPromiseMap)===null||q===void 0?void 0:q.size)>0){livekitLogger$1.debug("awaiting getUserMedia promise");try{U?yield Fe.userMediaPromiseMap.get(U):yield Promise.all(Fe.userMediaPromiseMap.values())}catch{livekitLogger$1.warn("error waiting for media permissons")}}let j=yield navigator.mediaDevices.enumerateDevices();if(V&&!(isSafari$1()&&F.hasDeviceInUse(U))&&(j.filter(K=>K.kind===U).length===0||j.some(K=>{const G=K.label==="",z=U?K.kind===U:!0;return G&&z}))){const K={video:U!=="audioinput"&&U!=="audiooutput",audio:U!=="videoinput"&&{deviceId:{ideal:"default"}}},G=yield navigator.mediaDevices.getUserMedia(K);j=yield navigator.mediaDevices.enumerateDevices(),G.getTracks().forEach(z=>{z.stop()})}return F._previousDevices=j,U&&(j=j.filter(W=>W.kind===U)),j})()})}normalizeDeviceId($,U,F){return __awaiter$2(this,void 0,void 0,function*(){if(U!==defaultId$1)return U;const V=yield this.getDevices($),q=V.find(W=>W.deviceId===defaultId$1);if(!q){livekitLogger$1.warn("could not reliably determine default device");return}const j=V.find(W=>W.deviceId!==defaultId$1&&W.groupId===(F??q.groupId));if(!j){livekitLogger$1.warn("could not reliably determine default device");return}return j?.deviceId})}hasDeviceInUse($){return $?Fe.userMediaPromiseMap.has($):Fe.userMediaPromiseMap.size>0}};DeviceManager$1.mediaDeviceKinds=["audioinput","audiooutput","videoinput"],DeviceManager$1.userMediaPromiseMap=new Map;var QueueTaskStatus$1;(function(B){B[B.WAITING=0]="WAITING",B[B.RUNNING=1]="RUNNING",B[B.COMPLETED=2]="COMPLETED"})(QueueTaskStatus$1||(QueueTaskStatus$1={}));let AsyncQueue$1=class{constructor(){this.pendingTasks=new Map,this.taskMutex=new _$2,this.nextTaskIndex=0}run($){return __awaiter$2(this,void 0,void 0,function*(){const U={id:this.nextTaskIndex++,enqueuedAt:Date.now(),status:QueueTaskStatus$1.WAITING};this.pendingTasks.set(U.id,U);const F=yield this.taskMutex.lock();try{return U.executedAt=Date.now(),U.status=QueueTaskStatus$1.RUNNING,yield $()}finally{U.status=QueueTaskStatus$1.COMPLETED,this.pendingTasks.delete(U.id),F()}})}flush(){return __awaiter$2(this,void 0,void 0,function*(){return this.run(()=>__awaiter$2(this,void 0,void 0,function*(){}))})}snapshot(){return Array.from(this.pendingTasks.values())}};function createRtcUrl$1(B,$){const U=new URL(toWebsocketUrl$1(B));return $.forEach((F,V)=>{U.searchParams.set(V,F)}),appendUrlPath$1(U,"rtc")}function createValidateUrl$1(B){const $=new URL(toHttpUrl$1(B));return appendUrlPath$1($,"validate")}function ensureTrailingSlash$1(B){return B.endsWith("/")?B:"".concat(B,"/")}function appendUrlPath$1(B,$){return B.pathname="".concat(ensureTrailingSlash$1(B.pathname)).concat($),B.toString()}const passThroughQueueSignals$1=["syncState","trickle","offer","answer","simulate","leave"];function canPassThroughQueue$1(B){const $=passThroughQueueSignals$1.indexOf(B.case)>=0;return livekitLogger$1.trace("request allowed to bypass queue:",{canPass:$,req:B}),$}var SignalConnectionState$1;(function(B){B[B.CONNECTING=0]="CONNECTING",B[B.CONNECTED=1]="CONNECTED",B[B.RECONNECTING=2]="RECONNECTING",B[B.DISCONNECTING=3]="DISCONNECTING",B[B.DISCONNECTED=4]="DISCONNECTED"})(SignalConnectionState$1||(SignalConnectionState$1={}));let SignalClient$1=class{get currentState(){return this.state}get isDisconnected(){return this.state===SignalConnectionState$1.DISCONNECTING||this.state===SignalConnectionState$1.DISCONNECTED}get isEstablishingConnection(){return this.state===SignalConnectionState$1.CONNECTING||this.state===SignalConnectionState$1.RECONNECTING}getNextRequestId(){return this._requestId+=1,this._requestId}constructor(){let $=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1,U=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};var F;this.rtt=0,this.state=SignalConnectionState$1.DISCONNECTED,this.log=livekitLogger$1,this._requestId=0,this.resetCallbacks=()=>{this.onAnswer=void 0,this.onLeave=void 0,this.onLocalTrackPublished=void 0,this.onLocalTrackUnpublished=void 0,this.onNegotiateRequested=void 0,this.onOffer=void 0,this.onRemoteMuteChanged=void 0,this.onSubscribedQualityUpdate=void 0,this.onTokenRefresh=void 0,this.onTrickle=void 0,this.onClose=void 0},this.log=getLogger$1((F=U.loggerName)!==null&&F!==void 0?F:LoggerNames$1.Signal),this.loggerContextCb=U.loggerContextCb,this.useJSON=$,this.requestQueue=new AsyncQueue$1,this.queuedRequests=[],this.closingLock=new _$2,this.connectionLock=new _$2,this.state=SignalConnectionState$1.DISCONNECTED}get logContext(){var $,U;return(U=($=this.loggerContextCb)===null||$===void 0?void 0:$.call(this))!==null&&U!==void 0?U:{}}join($,U,F,V){return __awaiter$2(this,void 0,void 0,function*(){return this.state=SignalConnectionState$1.CONNECTING,this.options=F,yield this.connect($,U,F,V)})}reconnect($,U,F,V){return __awaiter$2(this,void 0,void 0,function*(){if(!this.options){this.log.warn("attempted to reconnect without signal options being set, ignoring",this.logContext);return}return this.state=SignalConnectionState$1.RECONNECTING,this.clearPingInterval(),yield this.connect($,U,Object.assign(Object.assign({},this.options),{reconnect:!0,sid:F,reconnectReason:V}))})}connect($,U,F,V){this.connectOptions=F;const q=getClientInfo$1(),j=createConnectionParams$1(U,q,F),W=createRtcUrl$1($,j),K=createValidateUrl$1(W);return new Promise((G,z)=>__awaiter$2(this,void 0,void 0,function*(){const H=yield this.connectionLock.lock();try{const Q=()=>__awaiter$2(this,void 0,void 0,function*(){this.close(),clearTimeout(Y),z(new ConnectionError$1("room connection has been cancelled (signal)",ConnectionErrorReason$1.Cancelled))}),Y=setTimeout(()=>{this.close(),z(new ConnectionError$1("room connection has timed out (signal)",ConnectionErrorReason$1.ServerUnreachable))},F.websocketTimeout);V?.aborted&&Q(),V?.addEventListener("abort",Q);const X=new URL(W);X.searchParams.has("access_token")&&X.searchParams.set("access_token","<redacted>"),this.log.debug("connecting to ".concat(X),Object.assign({reconnect:F.reconnect,reconnectReason:F.reconnectReason},this.logContext)),this.ws&&(yield this.close(!1)),this.ws=new WebSocket(W),this.ws.binaryType="arraybuffer",this.ws.onopen=()=>{clearTimeout(Y)},this.ws.onerror=Z=>__awaiter$2(this,void 0,void 0,function*(){if(this.state!==SignalConnectionState$1.CONNECTED){this.state=SignalConnectionState$1.DISCONNECTED,clearTimeout(Y);try{const ne=yield fetch(K);if(ne.status.toFixed(0).startsWith("4")){const ee=yield ne.text();z(new ConnectionError$1(ee,ConnectionErrorReason$1.NotAllowed,ne.status))}else z(new ConnectionError$1("Encountered unknown websocket error during connection: ".concat(Z.toString()),ConnectionErrorReason$1.InternalError,ne.status))}catch(ne){z(new ConnectionError$1(ne instanceof Error?ne.message:"server was not reachable",ConnectionErrorReason$1.ServerUnreachable))}return}this.handleWSError(Z)}),this.ws.onmessage=Z=>__awaiter$2(this,void 0,void 0,function*(){var ne,ee,ie;let se;if(typeof Z.data=="string"){const te=JSON.parse(Z.data);se=SignalResponse$1.fromJson(te,{ignoreUnknownFields:!0})}else if(Z.data instanceof ArrayBuffer)se=SignalResponse$1.fromBinary(new Uint8Array(Z.data));else{this.log.error("could not decode websocket message: ".concat(typeof Z.data),this.logContext);return}if(this.state!==SignalConnectionState$1.CONNECTED){let te=!1;if(((ne=se.message)===null||ne===void 0?void 0:ne.case)==="join"?(this.state=SignalConnectionState$1.CONNECTED,V?.removeEventListener("abort",Q),this.pingTimeoutDuration=se.message.value.pingTimeout,this.pingIntervalDuration=se.message.value.pingInterval,this.pingTimeoutDuration&&this.pingTimeoutDuration>0&&(this.log.debug("ping config",Object.assign(Object.assign({},this.logContext),{timeout:this.pingTimeoutDuration,interval:this.pingIntervalDuration})),this.startPingInterval()),G(se.message.value)):this.state===SignalConnectionState$1.RECONNECTING&&se.message.case!=="leave"?(this.state=SignalConnectionState$1.CONNECTED,V?.removeEventListener("abort",Q),this.startPingInterval(),((ee=se.message)===null||ee===void 0?void 0:ee.case)==="reconnect"?G(se.message.value):(this.log.debug("declaring signal reconnected without reconnect response received",this.logContext),G(void 0),te=!0)):this.isEstablishingConnection&&se.message.case==="leave"?z(new ConnectionError$1("Received leave request while trying to (re)connect",ConnectionErrorReason$1.LeaveRequest,void 0,se.message.value.reason)):F.reconnect||z(new ConnectionError$1("did not receive join response, got ".concat((ie=se.message)===null||ie===void 0?void 0:ie.case," instead"),ConnectionErrorReason$1.InternalError)),!te)return}this.signalLatency&&(yield sleep$2(this.signalLatency)),this.handleSignalResponse(se)}),this.ws.onclose=Z=>{this.isEstablishingConnection&&z(new ConnectionError$1("Websocket got closed during a (re)connection attempt",ConnectionErrorReason$1.InternalError)),this.log.warn("websocket closed",Object.assign(Object.assign({},this.logContext),{reason:Z.reason,code:Z.code,wasClean:Z.wasClean,state:this.state})),this.handleOnClose(Z.reason)}}finally{H()}}))}close(){return __awaiter$2(this,arguments,void 0,function(){var $=this;let U=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0;return(function*(){const F=yield $.closingLock.lock();try{if($.clearPingInterval(),U&&($.state=SignalConnectionState$1.DISCONNECTING),$.ws){$.ws.onmessage=null,$.ws.onopen=null,$.ws.onclose=null;const V=new Promise(q=>{$.ws?$.ws.onclose=()=>{q()}:q()});$.ws.readyState<$.ws.CLOSING&&($.ws.close(),yield Promise.race([V,sleep$2(250)])),$.ws=void 0}}finally{U&&($.state=SignalConnectionState$1.DISCONNECTED),F()}})()})}sendOffer($){this.log.debug("sending offer",Object.assign(Object.assign({},this.logContext),{offerSdp:$.sdp})),this.sendRequest({case:"offer",value:toProtoSessionDescription$1($)})}sendAnswer($){return this.log.debug("sending answer",Object.assign(Object.assign({},this.logContext),{answerSdp:$.sdp})),this.sendRequest({case:"answer",value:toProtoSessionDescription$1($)})}sendIceCandidate($,U){return this.log.debug("sending ice candidate",Object.assign(Object.assign({},this.logContext),{candidate:$})),this.sendRequest({case:"trickle",value:new TrickleRequest$1({candidateInit:JSON.stringify($),target:U})})}sendMuteTrack($,U){return this.sendRequest({case:"mute",value:new MuteTrackRequest$1({sid:$,muted:U})})}sendAddTrack($){return this.sendRequest({case:"addTrack",value:$})}sendUpdateLocalMetadata($,U){return __awaiter$2(this,arguments,void 0,function(F,V){var q=this;let j=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};return(function*(){const W=q.getNextRequestId();return yield q.sendRequest({case:"updateMetadata",value:new UpdateParticipantMetadata$1({requestId:W,metadata:F,name:V,attributes:j})}),W})()})}sendUpdateTrackSettings($){this.sendRequest({case:"trackSetting",value:$})}sendUpdateSubscription($){return this.sendRequest({case:"subscription",value:$})}sendSyncState($){return this.sendRequest({case:"syncState",value:$})}sendUpdateVideoLayers($,U){return this.sendRequest({case:"updateLayers",value:new UpdateVideoLayers$1({trackSid:$,layers:U})})}sendUpdateSubscriptionPermissions($,U){return this.sendRequest({case:"subscriptionPermission",value:new SubscriptionPermission$1({allParticipants:$,trackPermissions:U})})}sendSimulateScenario($){return this.sendRequest({case:"simulate",value:$})}sendPing(){return Promise.all([this.sendRequest({case:"ping",value:protoInt64$1.parse(Date.now())}),this.sendRequest({case:"pingReq",value:new Ping$1({timestamp:protoInt64$1.parse(Date.now()),rtt:protoInt64$1.parse(this.rtt)})})])}sendUpdateLocalAudioTrack($,U){return this.sendRequest({case:"updateAudioTrack",value:new UpdateLocalAudioTrack$1({trackSid:$,features:U})})}sendLeave(){return this.sendRequest({case:"leave",value:new LeaveRequest$1({reason:DisconnectReason$1.CLIENT_INITIATED,action:LeaveRequest_Action$1.DISCONNECT})})}sendRequest($){return __awaiter$2(this,arguments,void 0,function(U){var F=this;let V=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;return(function*(){if(!V&&!canPassThroughQueue$1(U)&&F.state===SignalConnectionState$1.RECONNECTING){F.queuedRequests.push(()=>__awaiter$2(F,void 0,void 0,function*(){yield this.sendRequest(U,!0)}));return}if(V||(yield F.requestQueue.flush()),F.signalLatency&&(yield sleep$2(F.signalLatency)),!F.ws||F.ws.readyState!==F.ws.OPEN){F.log.error("cannot send signal request before connected, type: ".concat(U?.case),F.logContext);return}const j=new SignalRequest$1({message:U});try{F.useJSON?F.ws.send(j.toJsonString()):F.ws.send(j.toBinary())}catch(W){F.log.error("error sending signal message",Object.assign(Object.assign({},F.logContext),{error:W}))}})()})}handleSignalResponse($){var U,F;const V=$.message;if(V==null){this.log.debug("received unsupported message",this.logContext);return}let q=!1;if(V.case==="answer"){const j=fromProtoSessionDescription$1(V.value);this.onAnswer&&this.onAnswer(j)}else if(V.case==="offer"){const j=fromProtoSessionDescription$1(V.value);this.onOffer&&this.onOffer(j)}else if(V.case==="trickle"){const j=JSON.parse(V.value.candidateInit);this.onTrickle&&this.onTrickle(j,V.value.target)}else V.case==="update"?this.onParticipantUpdate&&this.onParticipantUpdate((U=V.value.participants)!==null&&U!==void 0?U:[]):V.case==="trackPublished"?this.onLocalTrackPublished&&this.onLocalTrackPublished(V.value):V.case==="speakersChanged"?this.onSpeakersChanged&&this.onSpeakersChanged((F=V.value.speakers)!==null&&F!==void 0?F:[]):V.case==="leave"?this.onLeave&&this.onLeave(V.value):V.case==="mute"?this.onRemoteMuteChanged&&this.onRemoteMuteChanged(V.value.sid,V.value.muted):V.case==="roomUpdate"?this.onRoomUpdate&&V.value.room&&this.onRoomUpdate(V.value.room):V.case==="connectionQuality"?this.onConnectionQuality&&this.onConnectionQuality(V.value):V.case==="streamStateUpdate"?this.onStreamStateUpdate&&this.onStreamStateUpdate(V.value):V.case==="subscribedQualityUpdate"?this.onSubscribedQualityUpdate&&this.onSubscribedQualityUpdate(V.value):V.case==="subscriptionPermissionUpdate"?this.onSubscriptionPermissionUpdate&&this.onSubscriptionPermissionUpdate(V.value):V.case==="refreshToken"?this.onTokenRefresh&&this.onTokenRefresh(V.value):V.case==="trackUnpublished"?this.onLocalTrackUnpublished&&this.onLocalTrackUnpublished(V.value):V.case==="subscriptionResponse"?this.onSubscriptionError&&this.onSubscriptionError(V.value):V.case==="pong"||(V.case==="pongResp"?(this.rtt=Date.now()-Number.parseInt(V.value.lastPingTimestamp.toString()),this.resetPingTimeout(),q=!0):V.case==="requestResponse"?this.onRequestResponse&&this.onRequestResponse(V.value):V.case==="trackSubscribed"?this.onLocalTrackSubscribed&&this.onLocalTrackSubscribed(V.value.trackSid):this.log.debug("unsupported message",Object.assign(Object.assign({},this.logContext),{msgCase:V.case})));q||this.resetPingTimeout()}setReconnected(){for(;this.queuedRequests.length>0;){const $=this.queuedRequests.shift();$&&this.requestQueue.run($)}}handleOnClose($){return __awaiter$2(this,void 0,void 0,function*(){if(this.state===SignalConnectionState$1.DISCONNECTED)return;const U=this.onClose;yield this.close(),this.log.debug("websocket connection closed: ".concat($),Object.assign(Object.assign({},this.logContext),{reason:$})),U&&U($)})}handleWSError($){this.log.error("websocket error",Object.assign(Object.assign({},this.logContext),{error:$}))}resetPingTimeout(){if(this.clearPingTimeout(),!this.pingTimeoutDuration){this.log.warn("ping timeout duration not set",this.logContext);return}this.pingTimeout=CriticalTimers$1.setTimeout(()=>{this.log.warn("ping timeout triggered. last pong received at: ".concat(new Date(Date.now()-this.pingTimeoutDuration*1e3).toUTCString()),this.logContext),this.handleOnClose("ping timeout")},this.pingTimeoutDuration*1e3)}clearPingTimeout(){this.pingTimeout&&CriticalTimers$1.clearTimeout(this.pingTimeout)}startPingInterval(){if(this.clearPingInterval(),this.resetPingTimeout(),!this.pingIntervalDuration){this.log.warn("ping interval duration not set",this.logContext);return}this.log.debug("start ping interval",this.logContext),this.pingInterval=CriticalTimers$1.setInterval(()=>{this.sendPing()},this.pingIntervalDuration*1e3)}clearPingInterval(){this.log.debug("clearing ping interval",this.logContext),this.clearPingTimeout(),this.pingInterval&&CriticalTimers$1.clearInterval(this.pingInterval)}};function fromProtoSessionDescription$1(B){const $={type:"offer",sdp:B.sdp};switch(B.type){case"answer":case"offer":case"pranswer":case"rollback":$.type=B.type;break}return $}function toProtoSessionDescription$1(B){return new SessionDescription$1({sdp:B.sdp,type:B.type})}function createConnectionParams$1(B,$,U){var F;const V=new URLSearchParams;return V.set("access_token",B),U.reconnect&&(V.set("reconnect","1"),U.sid&&V.set("sid",U.sid)),V.set("auto_subscribe",U.autoSubscribe?"1":"0"),V.set("sdk",isReactNative$1()?"reactnative":"js"),V.set("version",$.version),V.set("protocol",$.protocol.toString()),$.deviceModel&&V.set("device_model",$.deviceModel),$.os&&V.set("os",$.os),$.osVersion&&V.set("os_version",$.osVersion),$.browser&&V.set("browser",$.browser),$.browserVersion&&V.set("browser_version",$.browserVersion),U.adaptiveStream&&V.set("adaptive_stream","1"),U.reconnectReason&&V.set("reconnect_reason",U.reconnectReason.toString()),!((F=navigator.connection)===null||F===void 0)&&F.type&&V.set("network",navigator.connection.type),V}var lib$1={},parser$1={},grammar$1={exports:{}},hasRequiredGrammar$1;function requireGrammar$1(){if(hasRequiredGrammar$1)return grammar$1.exports;hasRequiredGrammar$1=1;var B=grammar$1.exports={v:[{name:"version",reg:/^(\d*)$/}],o:[{name:"origin",reg:/^(\S*) (\d*) (\d*) (\S*) IP(\d) (\S*)/,names:["username","sessionId","sessionVersion","netType","ipVer","address"],format:"%s %s %d %s IP%d %s"}],s:[{name:"name"}],i:[{name:"description"}],u:[{name:"uri"}],e:[{name:"email"}],p:[{name:"phone"}],z:[{name:"timezones"}],r:[{name:"repeats"}],t:[{name:"timing",reg:/^(\d*) (\d*)/,names:["start","stop"],format:"%d %d"}],c:[{name:"connection",reg:/^IN IP(\d) (\S*)/,names:["version","ip"],format:"IN IP%d %s"}],b:[{push:"bandwidth",reg:/^(TIAS|AS|CT|RR|RS):(\d*)/,names:["type","limit"],format:"%s:%s"}],m:[{reg:/^(\w*) (\d*) ([\w/]*)(?: (.*))?/,names:["type","port","protocol","payloads"],format:"%s %d %s %s"}],a:[{push:"rtp",reg:/^rtpmap:(\d*) ([\w\-.]*)(?:\s*\/(\d*)(?:\s*\/(\S*))?)?/,names:["payload","codec","rate","encoding"],format:function($){return $.encoding?"rtpmap:%d %s/%s/%s":$.rate?"rtpmap:%d %s/%s":"rtpmap:%d %s"}},{push:"fmtp",reg:/^fmtp:(\d*) ([\S| ]*)/,names:["payload","config"],format:"fmtp:%d %s"},{name:"control",reg:/^control:(.*)/,format:"control:%s"},{name:"rtcp",reg:/^rtcp:(\d*)(?: (\S*) IP(\d) (\S*))?/,names:["port","netType","ipVer","address"],format:function($){return $.address!=null?"rtcp:%d %s IP%d %s":"rtcp:%d"}},{push:"rtcpFbTrrInt",reg:/^rtcp-fb:(\*|\d*) trr-int (\d*)/,names:["payload","value"],format:"rtcp-fb:%s trr-int %d"},{push:"rtcpFb",reg:/^rtcp-fb:(\*|\d*) ([\w-_]*)(?: ([\w-_]*))?/,names:["payload","type","subtype"],format:function($){return $.subtype!=null?"rtcp-fb:%s %s %s":"rtcp-fb:%s %s"}},{push:"ext",reg:/^extmap:(\d+)(?:\/(\w+))?(?: (urn:ietf:params:rtp-hdrext:encrypt))? (\S*)(?: (\S*))?/,names:["value","direction","encrypt-uri","uri","config"],format:function($){return"extmap:%d"+($.direction?"/%s":"%v")+($["encrypt-uri"]?" %s":"%v")+" %s"+($.config?" %s":"")}},{name:"extmapAllowMixed",reg:/^(extmap-allow-mixed)/},{push:"crypto",reg:/^crypto:(\d*) ([\w_]*) (\S*)(?: (\S*))?/,names:["id","suite","config","sessionConfig"],format:function($){return $.sessionConfig!=null?"crypto:%d %s %s %s":"crypto:%d %s %s"}},{name:"setup",reg:/^setup:(\w*)/,format:"setup:%s"},{name:"connectionType",reg:/^connection:(new|existing)/,format:"connection:%s"},{name:"mid",reg:/^mid:([^\s]*)/,format:"mid:%s"},{name:"msid",reg:/^msid:(.*)/,format:"msid:%s"},{name:"ptime",reg:/^ptime:(\d*(?:\.\d*)*)/,format:"ptime:%d"},{name:"maxptime",reg:/^maxptime:(\d*(?:\.\d*)*)/,format:"maxptime:%d"},{name:"direction",reg:/^(sendrecv|recvonly|sendonly|inactive)/},{name:"icelite",reg:/^(ice-lite)/},{name:"iceUfrag",reg:/^ice-ufrag:(\S*)/,format:"ice-ufrag:%s"},{name:"icePwd",reg:/^ice-pwd:(\S*)/,format:"ice-pwd:%s"},{name:"fingerprint",reg:/^fingerprint:(\S*) (\S*)/,names:["type","hash"],format:"fingerprint:%s %s"},{push:"candidates",reg:/^candidate:(\S*) (\d*) (\S*) (\d*) (\S*) (\d*) typ (\S*)(?: raddr (\S*) rport (\d*))?(?: tcptype (\S*))?(?: generation (\d*))?(?: network-id (\d*))?(?: network-cost (\d*))?/,names:["foundation","component","transport","priority","ip","port","type","raddr","rport","tcptype","generation","network-id","network-cost"],format:function($){var U="candidate:%s %d %s %d %s %d typ %s";return U+=$.raddr!=null?" raddr %s rport %d":"%v%v",U+=$.tcptype!=null?" tcptype %s":"%v",$.generation!=null&&(U+=" generation %d"),U+=$["network-id"]!=null?" network-id %d":"%v",U+=$["network-cost"]!=null?" network-cost %d":"%v",U}},{name:"endOfCandidates",reg:/^(end-of-candidates)/},{name:"remoteCandidates",reg:/^remote-candidates:(.*)/,format:"remote-candidates:%s"},{name:"iceOptions",reg:/^ice-options:(\S*)/,format:"ice-options:%s"},{push:"ssrcs",reg:/^ssrc:(\d*) ([\w_-]*)(?::(.*))?/,names:["id","attribute","value"],format:function($){var U="ssrc:%d";return $.attribute!=null&&(U+=" %s",$.value!=null&&(U+=":%s")),U}},{push:"ssrcGroups",reg:/^ssrc-group:([\x21\x23\x24\x25\x26\x27\x2A\x2B\x2D\x2E\w]*) (.*)/,names:["semantics","ssrcs"],format:"ssrc-group:%s %s"},{name:"msidSemantic",reg:/^msid-semantic:\s?(\w*) (\S*)/,names:["semantic","token"],format:"msid-semantic: %s %s"},{push:"groups",reg:/^group:(\w*) (.*)/,names:["type","mids"],format:"group:%s %s"},{name:"rtcpMux",reg:/^(rtcp-mux)/},{name:"rtcpRsize",reg:/^(rtcp-rsize)/},{name:"sctpmap",reg:/^sctpmap:([\w_/]*) (\S*)(?: (\S*))?/,names:["sctpmapNumber","app","maxMessageSize"],format:function($){return $.maxMessageSize!=null?"sctpmap:%s %s %s":"sctpmap:%s %s"}},{name:"xGoogleFlag",reg:/^x-google-flag:([^\s]*)/,format:"x-google-flag:%s"},{push:"rids",reg:/^rid:([\d\w]+) (\w+)(?: ([\S| ]*))?/,names:["id","direction","params"],format:function($){return $.params?"rid:%s %s %s":"rid:%s %s"}},{push:"imageattrs",reg:new RegExp("^imageattr:(\\d+|\\*)[\\s\\t]+(send|recv)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*)(?:[\\s\\t]+(recv|send)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*))?"),names:["pt","dir1","attrs1","dir2","attrs2"],format:function($){return"imageattr:%s %s %s"+($.dir2?" %s %s":"")}},{name:"simulcast",reg:new RegExp("^simulcast:(send|recv) ([a-zA-Z0-9\\-_~;,]+)(?:\\s?(send|recv) ([a-zA-Z0-9\\-_~;,]+))?$"),names:["dir1","list1","dir2","list2"],format:function($){return"simulcast:%s %s"+($.dir2?" %s %s":"")}},{name:"simulcast_03",reg:/^simulcast:[\s\t]+([\S+\s\t]+)$/,names:["value"],format:"simulcast: %s"},{name:"framerate",reg:/^framerate:(\d+(?:$|\.\d+))/,format:"framerate:%s"},{name:"sourceFilter",reg:/^source-filter: *(excl|incl) (\S*) (IP4|IP6|\*) (\S*) (.*)/,names:["filterMode","netType","addressTypes","destAddress","srcList"],format:"source-filter: %s %s %s %s %s"},{name:"bundleOnly",reg:/^(bundle-only)/},{name:"label",reg:/^label:(.+)/,format:"label:%s"},{name:"sctpPort",reg:/^sctp-port:(\d+)$/,format:"sctp-port:%s"},{name:"maxMessageSize",reg:/^max-message-size:(\d+)$/,format:"max-message-size:%s"},{push:"tsRefClocks",reg:/^ts-refclk:([^\s=]*)(?:=(\S*))?/,names:["clksrc","clksrcExt"],format:function($){return"ts-refclk:%s"+($.clksrcExt!=null?"=%s":"")}},{name:"mediaClk",reg:/^mediaclk:(?:id=(\S*))? *([^\s=]*)(?:=(\S*))?(?: *rate=(\d+)\/(\d+))?/,names:["id","mediaClockName","mediaClockValue","rateNumerator","rateDenominator"],format:function($){var U="mediaclk:";return U+=$.id!=null?"id=%s %s":"%v%s",U+=$.mediaClockValue!=null?"=%s":"",U+=$.rateNumerator!=null?" rate=%s":"",U+=$.rateDenominator!=null?"/%s":"",U}},{name:"keywords",reg:/^keywds:(.+)$/,format:"keywds:%s"},{name:"content",reg:/^content:(.+)/,format:"content:%s"},{name:"bfcpFloorCtrl",reg:/^floorctrl:(c-only|s-only|c-s)/,format:"floorctrl:%s"},{name:"bfcpConfId",reg:/^confid:(\d+)/,format:"confid:%s"},{name:"bfcpUserId",reg:/^userid:(\d+)/,format:"userid:%s"},{name:"bfcpFloorId",reg:/^floorid:(.+) (?:m-stream|mstrm):(.+)/,names:["id","mStream"],format:"floorid:%s mstrm:%s"},{push:"invalid",names:["value"]}]};return Object.keys(B).forEach(function($){var U=B[$];U.forEach(function(F){F.reg||(F.reg=/(.*)/),F.format||(F.format="%s")})}),grammar$1.exports}var hasRequiredParser$1;function requireParser$1(){return hasRequiredParser$1||(hasRequiredParser$1=1,(function(B){var $=function(W){return String(Number(W))===W?Number(W):W},U=function(W,K,G,z){if(z&&!G)K[z]=$(W[1]);else for(var H=0;H<G.length;H+=1)W[H+1]!=null&&(K[G[H]]=$(W[H+1]))},F=function(W,K,G){var z=W.name&&W.names;W.push&&!K[W.push]?K[W.push]=[]:z&&!K[W.name]&&(K[W.name]={});var H=W.push?{}:z?K[W.name]:K;U(G.match(W.reg),H,W.names,W.name),W.push&&K[W.push].push(H)},V=requireGrammar$1(),q=RegExp.prototype.test.bind(/^([a-z])=(.*)/);B.parse=function(W){var K={},G=[],z=K;return W.split(/(\r\n|\r|\n)/).filter(q).forEach(function(H){var Q=H[0],Y=H.slice(2);Q==="m"&&(G.push({rtp:[],fmtp:[]}),z=G[G.length-1]);for(var X=0;X<(V[Q]||[]).length;X+=1){var Z=V[Q][X];if(Z.reg.test(Y))return F(Z,z,Y)}}),K.media=G,K};var j=function(W,K){var G=K.split(/=(.+)/,2);return G.length===2?W[G[0]]=$(G[1]):G.length===1&&K.length>1&&(W[G[0]]=void 0),W};B.parseParams=function(W){return W.split(/;\s?/).reduce(j,{})},B.parseFmtpConfig=B.parseParams,B.parsePayloads=function(W){return W.toString().split(" ").map(Number)},B.parseRemoteCandidates=function(W){for(var K=[],G=W.split(" ").map($),z=0;z<G.length;z+=3)K.push({component:G[z],ip:G[z+1],port:G[z+2]});return K},B.parseImageAttributes=function(W){return W.split(" ").map(function(K){return K.substring(1,K.length-1).split(",").reduce(j,{})})},B.parseSimulcastStreamList=function(W){return W.split(";").map(function(K){return K.split(",").map(function(G){var z,H=!1;return G[0]!=="~"?z=$(G):(z=$(G.substring(1,G.length)),H=!0),{scid:z,paused:H}})})}})(parser$1)),parser$1}var writer$2,hasRequiredWriter$2;function requireWriter$2(){if(hasRequiredWriter$2)return writer$2;hasRequiredWriter$2=1;var B=requireGrammar$1(),$=/%[sdv%]/g,U=function(j){var W=1,K=arguments,G=K.length;return j.replace($,function(z){if(W>=G)return z;var H=K[W];switch(W+=1,z){case"%%":return"%";case"%s":return String(H);case"%d":return Number(H);case"%v":return""}})},F=function(j,W,K){var G=W.format instanceof Function?W.format(W.push?K:K[W.name]):W.format,z=[j+"="+G];if(W.names)for(var H=0;H<W.names.length;H+=1){var Q=W.names[H];W.name?z.push(K[W.name][Q]):z.push(K[W.names[H]])}else z.push(K[W.name]);return U.apply(null,z)},V=["v","o","s","i","u","e","p","c","b","t","r","z","a"],q=["i","c","b","a"];return writer$2=function(j,W){W=W||{},j.version==null&&(j.version=0),j.name==null&&(j.name=" "),j.media.forEach(function(H){H.payloads==null&&(H.payloads="")});var K=W.outerOrder||V,G=W.innerOrder||q,z=[];return K.forEach(function(H){B[H].forEach(function(Q){Q.name in j&&j[Q.name]!=null?z.push(F(H,Q,j)):Q.push in j&&j[Q.push]!=null&&j[Q.push].forEach(function(Y){z.push(F(H,Q,Y))})})}),j.media.forEach(function(H){z.push(F("m",B.m[0],H)),G.forEach(function(Q){B[Q].forEach(function(Y){Y.name in H&&H[Y.name]!=null?z.push(F(Q,Y,H)):Y.push in H&&H[Y.push]!=null&&H[Y.push].forEach(function(X){z.push(F(Q,Y,X))})})})}),z.join(`\r
`)+`\r
`},writer$2}var hasRequiredLib$1;function requireLib$1(){if(hasRequiredLib$1)return lib$1;hasRequiredLib$1=1;var B=requireParser$1(),$=requireWriter$2(),U=requireGrammar$1();return lib$1.grammar=U,lib$1.write=$,lib$1.parse=B.parse,lib$1.parseParams=B.parseParams,lib$1.parseFmtpConfig=B.parseFmtpConfig,lib$1.parsePayloads=B.parsePayloads,lib$1.parseRemoteCandidates=B.parseRemoteCandidates,lib$1.parseImageAttributes=B.parseImageAttributes,lib$1.parseSimulcastStreamList=B.parseSimulcastStreamList,lib$1}var libExports$1=requireLib$1();function r$2(B,$,U){var F,V,q;$===void 0&&($=50),U===void 0&&(U={});var j=(F=U.isImmediate)!=null&&F,W=(V=U.callback)!=null&&V,K=U.maxWait,G=Date.now(),z=[];function H(){if(K!==void 0){var Y=Date.now()-G;if(Y+$>=K)return K-Y}return $}var Q=function(){var Y=[].slice.call(arguments),X=this;return new Promise(function(Z,ne){var ee=j&&q===void 0;if(q!==void 0&&clearTimeout(q),q=setTimeout(function(){if(q=void 0,G=Date.now(),!j){var se=B.apply(X,Y);W&&W(se),z.forEach(function(te){return(0,te.resolve)(se)}),z=[]}},H()),ee){var ie=B.apply(X,Y);return W&&W(ie),Z(ie)}z.push({resolve:Z,reject:ne})})};return Q.cancel=function(Y){q!==void 0&&clearTimeout(q),z.forEach(function(X){return(0,X.reject)(Y)}),z=[]},Q}const startBitrateForSVC$1=.7,debounceInterval$1=20,PCEvents$1={NegotiationStarted:"negotiationStarted",NegotiationComplete:"negotiationComplete",RTPVideoPayloadTypes:"rtpVideoPayloadTypes"};let PCTransport$1=class extends eventsExports$1.EventEmitter{get pc(){return this._pc||(this._pc=this.createPC()),this._pc}constructor($){let U=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};var F;super(),this.log=livekitLogger$1,this.ddExtID=0,this.pendingCandidates=[],this.restartingIce=!1,this.renegotiate=!1,this.trackBitrates=[],this.remoteStereoMids=[],this.remoteNackMids=[],this.negotiate=r$2(V=>__awaiter$2(this,void 0,void 0,function*(){this.emit(PCEvents$1.NegotiationStarted);try{yield this.createAndSendOffer()}catch(q){if(V)V(q);else throw q}}),debounceInterval$1),this.close=()=>{this._pc&&(this._pc.close(),this._pc.onconnectionstatechange=null,this._pc.oniceconnectionstatechange=null,this._pc.onicegatheringstatechange=null,this._pc.ondatachannel=null,this._pc.onnegotiationneeded=null,this._pc.onsignalingstatechange=null,this._pc.onicecandidate=null,this._pc.ondatachannel=null,this._pc.ontrack=null,this._pc.onconnectionstatechange=null,this._pc.oniceconnectionstatechange=null,this._pc=null)},this.log=getLogger$1((F=U.loggerName)!==null&&F!==void 0?F:LoggerNames$1.PCTransport),this.loggerOptions=U,this.config=$,this._pc=this.createPC()}createPC(){const $=new RTCPeerConnection(this.config);return $.onicecandidate=U=>{var F;U.candidate&&((F=this.onIceCandidate)===null||F===void 0||F.call(this,U.candidate))},$.onicecandidateerror=U=>{var F;(F=this.onIceCandidateError)===null||F===void 0||F.call(this,U)},$.oniceconnectionstatechange=()=>{var U;(U=this.onIceConnectionStateChange)===null||U===void 0||U.call(this,$.iceConnectionState)},$.onsignalingstatechange=()=>{var U;(U=this.onSignalingStatechange)===null||U===void 0||U.call(this,$.signalingState)},$.onconnectionstatechange=()=>{var U;(U=this.onConnectionStateChange)===null||U===void 0||U.call(this,$.connectionState)},$.ondatachannel=U=>{var F;(F=this.onDataChannel)===null||F===void 0||F.call(this,U)},$.ontrack=U=>{var F;(F=this.onTrack)===null||F===void 0||F.call(this,U)},$}get logContext(){var $,U;return Object.assign({},(U=($=this.loggerOptions).loggerContextCb)===null||U===void 0?void 0:U.call($))}get isICEConnected(){return this._pc!==null&&(this.pc.iceConnectionState==="connected"||this.pc.iceConnectionState==="completed")}addIceCandidate($){return __awaiter$2(this,void 0,void 0,function*(){if(this.pc.remoteDescription&&!this.restartingIce)return this.pc.addIceCandidate($);this.pendingCandidates.push($)})}setRemoteDescription($){return __awaiter$2(this,void 0,void 0,function*(){var U;let F;if($.type==="offer"){let{stereoMids:V,nackMids:q}=extractStereoAndNackAudioFromOffer$1($);this.remoteStereoMids=V,this.remoteNackMids=q}else if($.type==="answer"){const V=libExports$1.parse((U=$.sdp)!==null&&U!==void 0?U:"");V.media.forEach(q=>{q.type==="audio"&&this.trackBitrates.some(j=>{if(!j.transceiver||q.mid!=j.transceiver.mid)return!1;let W=0;if(q.rtp.some(G=>G.codec.toUpperCase()===j.codec.toUpperCase()?(W=G.payload,!0):!1),W===0)return!0;let K=!1;for(const G of q.fmtp)if(G.payload===W){G.config=G.config.split(";").filter(z=>!z.includes("maxaveragebitrate")).join(";"),j.maxbr>0&&(G.config+=";maxaveragebitrate=".concat(j.maxbr*1e3)),K=!0;break}return K||j.maxbr>0&&q.fmtp.push({payload:W,config:"maxaveragebitrate=".concat(j.maxbr*1e3)}),!0})}),F=libExports$1.write(V)}yield this.setMungedSDP($,F,!0),this.pendingCandidates.forEach(V=>{this.pc.addIceCandidate(V)}),this.pendingCandidates=[],this.restartingIce=!1,this.renegotiate?(this.renegotiate=!1,yield this.createAndSendOffer()):$.type==="answer"&&(this.emit(PCEvents$1.NegotiationComplete),$.sdp&&libExports$1.parse($.sdp).media.forEach(q=>{q.type==="video"&&this.emit(PCEvents$1.RTPVideoPayloadTypes,q.rtp)}))})}createAndSendOffer($){return __awaiter$2(this,void 0,void 0,function*(){var U;if(this.onOffer===void 0)return;if($?.iceRestart&&(this.log.debug("restarting ICE",this.logContext),this.restartingIce=!0),this._pc&&this._pc.signalingState==="have-local-offer"){const q=this._pc.remoteDescription;if($?.iceRestart&&q)yield this._pc.setRemoteDescription(q);else{this.renegotiate=!0;return}}else if(!this._pc||this._pc.signalingState==="closed"){this.log.warn("could not createOffer with closed peer connection",this.logContext);return}this.log.debug("starting to negotiate",this.logContext);const F=yield this.pc.createOffer($);this.log.debug("original offer",Object.assign({sdp:F.sdp},this.logContext));const V=libExports$1.parse((U=F.sdp)!==null&&U!==void 0?U:"");V.media.forEach(q=>{ensureIPAddrMatchVersion$1(q),q.type==="audio"?ensureAudioNackAndStereo$1(q,[],[]):q.type==="video"&&this.trackBitrates.some(j=>{if(!q.msid||!j.cid||!q.msid.includes(j.cid))return!1;let W=0;if(q.rtp.some(G=>G.codec.toUpperCase()===j.codec.toUpperCase()?(W=G.payload,!0):!1),W===0||(isSVCCodec$1(j.codec)&&this.ensureVideoDDExtensionForSVC(q,V),j.codec!=="av1"))return!0;const K=Math.round(j.maxbr*startBitrateForSVC$1);for(const G of q.fmtp)if(G.payload===W){G.config.includes("x-google-start-bitrate")||(G.config+=";x-google-start-bitrate=".concat(K));break}return!0})}),yield this.setMungedSDP(F,libExports$1.write(V)),this.onOffer(F)})}createAndSetAnswer(){return __awaiter$2(this,void 0,void 0,function*(){var $;const U=yield this.pc.createAnswer(),F=libExports$1.parse(($=U.sdp)!==null&&$!==void 0?$:"");return F.media.forEach(V=>{ensureIPAddrMatchVersion$1(V),V.type==="audio"&&ensureAudioNackAndStereo$1(V,this.remoteStereoMids,this.remoteNackMids)}),yield this.setMungedSDP(U,libExports$1.write(F)),U})}createDataChannel($,U){return this.pc.createDataChannel($,U)}addTransceiver($,U){return this.pc.addTransceiver($,U)}addTrack($){if(!this._pc)throw new UnexpectedConnectionState$1("PC closed, cannot add track");return this._pc.addTrack($)}setTrackCodecBitrate($){this.trackBitrates.push($)}setConfiguration($){var U;if(!this._pc)throw new UnexpectedConnectionState$1("PC closed, cannot configure");return(U=this._pc)===null||U===void 0?void 0:U.setConfiguration($)}canRemoveTrack(){var $;return!!(!(($=this._pc)===null||$===void 0)&&$.removeTrack)}removeTrack($){var U;return(U=this._pc)===null||U===void 0?void 0:U.removeTrack($)}getConnectionState(){var $,U;return(U=($=this._pc)===null||$===void 0?void 0:$.connectionState)!==null&&U!==void 0?U:"closed"}getICEConnectionState(){var $,U;return(U=($=this._pc)===null||$===void 0?void 0:$.iceConnectionState)!==null&&U!==void 0?U:"closed"}getSignallingState(){var $,U;return(U=($=this._pc)===null||$===void 0?void 0:$.signalingState)!==null&&U!==void 0?U:"closed"}getTransceivers(){var $,U;return(U=($=this._pc)===null||$===void 0?void 0:$.getTransceivers())!==null&&U!==void 0?U:[]}getSenders(){var $,U;return(U=($=this._pc)===null||$===void 0?void 0:$.getSenders())!==null&&U!==void 0?U:[]}getLocalDescription(){var $;return($=this._pc)===null||$===void 0?void 0:$.localDescription}getRemoteDescription(){var $;return($=this.pc)===null||$===void 0?void 0:$.remoteDescription}getStats(){return this.pc.getStats()}getConnectedAddress(){return __awaiter$2(this,void 0,void 0,function*(){var $;if(!this._pc)return;let U="";const F=new Map,V=new Map;if((yield this._pc.getStats()).forEach(W=>{switch(W.type){case"transport":U=W.selectedCandidatePairId;break;case"candidate-pair":U===""&&W.selected&&(U=W.id),F.set(W.id,W);break;case"remote-candidate":V.set(W.id,"".concat(W.address,":").concat(W.port));break}}),U==="")return;const j=($=F.get(U))===null||$===void 0?void 0:$.remoteCandidateId;if(j!==void 0)return V.get(j)})}setMungedSDP($,U,F){return __awaiter$2(this,void 0,void 0,function*(){if(U){const V=$.sdp;$.sdp=U;try{this.log.debug("setting munged ".concat(F?"remote":"local"," description"),this.logContext),F?yield this.pc.setRemoteDescription($):yield this.pc.setLocalDescription($);return}catch(q){this.log.warn("not able to set ".concat($.type,", falling back to unmodified sdp"),Object.assign(Object.assign({},this.logContext),{error:q,sdp:U})),$.sdp=V}}try{F?yield this.pc.setRemoteDescription($):yield this.pc.setLocalDescription($)}catch(V){let q="unknown error";V instanceof Error?q=V.message:typeof V=="string"&&(q=V);const j={error:q,sdp:$.sdp};throw!F&&this.pc.remoteDescription&&(j.remoteSdp=this.pc.remoteDescription),this.log.error("unable to set ".concat($.type),Object.assign(Object.assign({},this.logContext),{fields:j})),new NegotiationError$1(q)}})}ensureVideoDDExtensionForSVC($,U){var F,V;if(!((F=$.ext)===null||F===void 0?void 0:F.some(j=>j.uri===ddExtensionURI$1))){if(this.ddExtID===0){let j=0;U.media.forEach(W=>{var K;W.type==="video"&&((K=W.ext)===null||K===void 0||K.forEach(G=>{G.value>j&&(j=G.value)}))}),this.ddExtID=j+1}(V=$.ext)===null||V===void 0||V.push({value:this.ddExtID,uri:ddExtensionURI$1})}}};function ensureAudioNackAndStereo$1(B,$,U){let F=0;B.rtp.some(V=>V.codec==="opus"?(F=V.payload,!0):!1),F>0&&(B.rtcpFb||(B.rtcpFb=[]),U.includes(B.mid)&&!B.rtcpFb.some(V=>V.payload===F&&V.type==="nack")&&B.rtcpFb.push({payload:F,type:"nack"}),$.includes(B.mid)&&B.fmtp.some(V=>V.payload===F?(V.config.includes("stereo=1")||(V.config+=";stereo=1"),!0):!1))}function extractStereoAndNackAudioFromOffer$1(B){var $;const U=[],F=[],V=libExports$1.parse(($=B.sdp)!==null&&$!==void 0?$:"");let q=0;return V.media.forEach(j=>{var W;j.type==="audio"&&(j.rtp.some(K=>K.codec==="opus"?(q=K.payload,!0):!1),!((W=j.rtcpFb)===null||W===void 0)&&W.some(K=>K.payload===q&&K.type==="nack")&&F.push(j.mid),j.fmtp.some(K=>K.payload===q?(K.config.includes("sprop-stereo=1")&&U.push(j.mid),!0):!1))}),{stereoMids:U,nackMids:F}}function ensureIPAddrMatchVersion$1(B){if(B.connection){const $=B.connection.ip.indexOf(":")>=0;(B.connection.version===4&&$||B.connection.version===6&&!$)&&(B.connection.ip="0.0.0.0",B.connection.version=4)}}const defaultVideoCodec$1="vp8",publishDefaults$1={audioPreset:AudioPresets$1.music,dtx:!0,red:!0,forceStereo:!1,simulcast:!0,screenShareEncoding:ScreenSharePresets$1.h1080fps15.encoding,stopMicTrackOnMute:!1,videoCodec:defaultVideoCodec$1,backupCodec:!0},audioDefaults$1={deviceId:{ideal:"default"},autoGainControl:!0,echoCancellation:!0,noiseSuppression:!0,voiceIsolation:!0},videoDefaults$1={deviceId:{ideal:"default"},resolution:VideoPresets$1.h720.resolution},roomOptionDefaults$1={adaptiveStream:!1,dynacast:!1,stopLocalTrackOnUnpublish:!0,reconnectPolicy:new DefaultReconnectPolicy$1,disconnectOnPageLeave:!0,webAudioMix:!1},roomConnectOptionDefaults$1={autoSubscribe:!0,maxRetries:1,peerConnectionTimeout:15e3,websocketTimeout:15e3};var PCTransportState$1;(function(B){B[B.NEW=0]="NEW",B[B.CONNECTING=1]="CONNECTING",B[B.CONNECTED=2]="CONNECTED",B[B.FAILED=3]="FAILED",B[B.CLOSING=4]="CLOSING",B[B.CLOSED=5]="CLOSED"})(PCTransportState$1||(PCTransportState$1={}));let PCTransportManager$1=class{get needsPublisher(){return this.isPublisherConnectionRequired}get needsSubscriber(){return this.isSubscriberConnectionRequired}get currentState(){return this.state}constructor($,U,F){var V;this.peerConnectionTimeout=roomConnectOptionDefaults$1.peerConnectionTimeout,this.log=livekitLogger$1,this.updateState=()=>{var q;const j=this.state,W=this.requiredTransports.map(K=>K.getConnectionState());W.every(K=>K==="connected")?this.state=PCTransportState$1.CONNECTED:W.some(K=>K==="failed")?this.state=PCTransportState$1.FAILED:W.some(K=>K==="connecting")?this.state=PCTransportState$1.CONNECTING:W.every(K=>K==="closed")?this.state=PCTransportState$1.CLOSED:W.some(K=>K==="closed")?this.state=PCTransportState$1.CLOSING:W.every(K=>K==="new")&&(this.state=PCTransportState$1.NEW),j!==this.state&&(this.log.debug("pc state change: from ".concat(PCTransportState$1[j]," to ").concat(PCTransportState$1[this.state]),this.logContext),(q=this.onStateChange)===null||q===void 0||q.call(this,this.state,this.publisher.getConnectionState(),this.subscriber.getConnectionState()))},this.log=getLogger$1((V=F.loggerName)!==null&&V!==void 0?V:LoggerNames$1.PCManager),this.loggerOptions=F,this.isPublisherConnectionRequired=!U,this.isSubscriberConnectionRequired=U,this.publisher=new PCTransport$1($,F),this.subscriber=new PCTransport$1($,F),this.publisher.onConnectionStateChange=this.updateState,this.subscriber.onConnectionStateChange=this.updateState,this.publisher.onIceConnectionStateChange=this.updateState,this.subscriber.onIceConnectionStateChange=this.updateState,this.publisher.onSignalingStatechange=this.updateState,this.subscriber.onSignalingStatechange=this.updateState,this.publisher.onIceCandidate=q=>{var j;(j=this.onIceCandidate)===null||j===void 0||j.call(this,q,SignalTarget$1.PUBLISHER)},this.subscriber.onIceCandidate=q=>{var j;(j=this.onIceCandidate)===null||j===void 0||j.call(this,q,SignalTarget$1.SUBSCRIBER)},this.subscriber.onDataChannel=q=>{var j;(j=this.onDataChannel)===null||j===void 0||j.call(this,q)},this.subscriber.onTrack=q=>{var j;(j=this.onTrack)===null||j===void 0||j.call(this,q)},this.publisher.onOffer=q=>{var j;(j=this.onPublisherOffer)===null||j===void 0||j.call(this,q)},this.state=PCTransportState$1.NEW,this.connectionLock=new _$2,this.remoteOfferLock=new _$2}get logContext(){var $,U;return Object.assign({},(U=($=this.loggerOptions).loggerContextCb)===null||U===void 0?void 0:U.call($))}requirePublisher(){let $=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0;this.isPublisherConnectionRequired=$,this.updateState()}requireSubscriber(){let $=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0;this.isSubscriberConnectionRequired=$,this.updateState()}createAndSendPublisherOffer($){return this.publisher.createAndSendOffer($)}setPublisherAnswer($){return this.publisher.setRemoteDescription($)}removeTrack($){return this.publisher.removeTrack($)}close(){return __awaiter$2(this,void 0,void 0,function*(){if(this.publisher&&this.publisher.getSignallingState()!=="closed"){const $=this.publisher;for(const U of $.getSenders())try{$.canRemoveTrack()&&$.removeTrack(U)}catch(F){this.log.warn("could not removeTrack",Object.assign(Object.assign({},this.logContext),{error:F}))}}yield Promise.all([this.publisher.close(),this.subscriber.close()]),this.updateState()})}triggerIceRestart(){return __awaiter$2(this,void 0,void 0,function*(){this.subscriber.restartingIce=!0,this.needsPublisher&&(yield this.createAndSendPublisherOffer({iceRestart:!0}))})}addIceCandidate($,U){return __awaiter$2(this,void 0,void 0,function*(){U===SignalTarget$1.PUBLISHER?yield this.publisher.addIceCandidate($):yield this.subscriber.addIceCandidate($)})}createSubscriberAnswerFromOffer($){return __awaiter$2(this,void 0,void 0,function*(){this.log.debug("received server offer",Object.assign(Object.assign({},this.logContext),{RTCSdpType:$.type,sdp:$.sdp,signalingState:this.subscriber.getSignallingState().toString()}));const U=yield this.remoteOfferLock.lock();try{return yield this.subscriber.setRemoteDescription($),yield this.subscriber.createAndSetAnswer()}finally{U()}})}updateConfiguration($,U){this.publisher.setConfiguration($),this.subscriber.setConfiguration($),U&&this.triggerIceRestart()}ensurePCTransportConnection($,U){return __awaiter$2(this,void 0,void 0,function*(){var F;const V=yield this.connectionLock.lock();try{this.isPublisherConnectionRequired&&this.publisher.getConnectionState()!=="connected"&&this.publisher.getConnectionState()!=="connecting"&&(this.log.debug("negotiation required, start negotiating",this.logContext),this.publisher.negotiate()),yield Promise.all((F=this.requiredTransports)===null||F===void 0?void 0:F.map(q=>this.ensureTransportConnected(q,$,U)))}finally{V()}})}negotiate($){return __awaiter$2(this,void 0,void 0,function*(){return new Promise((U,F)=>__awaiter$2(this,void 0,void 0,function*(){const V=setTimeout(()=>{F("negotiation timed out")},this.peerConnectionTimeout),q=()=>{clearTimeout(V),F("negotiation aborted")};$.signal.addEventListener("abort",q),this.publisher.once(PCEvents$1.NegotiationStarted,()=>{$.signal.aborted||this.publisher.once(PCEvents$1.NegotiationComplete,()=>{clearTimeout(V),U()})}),yield this.publisher.negotiate(j=>{clearTimeout(V),F(j)})}))})}addPublisherTransceiver($,U){return this.publisher.addTransceiver($,U)}addPublisherTrack($){return this.publisher.addTrack($)}createPublisherDataChannel($,U){return this.publisher.createDataChannel($,U)}getConnectedAddress($){return $===SignalTarget$1.PUBLISHER?this.publisher.getConnectedAddress():$===SignalTarget$1.SUBSCRIBER?this.publisher.getConnectedAddress():this.requiredTransports[0].getConnectedAddress()}get requiredTransports(){const $=[];return this.isPublisherConnectionRequired&&$.push(this.publisher),this.isSubscriberConnectionRequired&&$.push(this.subscriber),$}ensureTransportConnected($,U){return __awaiter$2(this,arguments,void 0,function(F,V){var q=this;let j=arguments.length>2&&arguments[2]!==void 0?arguments[2]:this.peerConnectionTimeout;return(function*(){if(F.getConnectionState()!=="connected")return new Promise((K,G)=>__awaiter$2(q,void 0,void 0,function*(){const z=()=>{this.log.warn("abort transport connection",this.logContext),CriticalTimers$1.clearTimeout(H),G(new ConnectionError$1("room connection has been cancelled",ConnectionErrorReason$1.Cancelled))};V?.signal.aborted&&z(),V?.signal.addEventListener("abort",z);const H=CriticalTimers$1.setTimeout(()=>{V?.signal.removeEventListener("abort",z),G(new ConnectionError$1("could not establish pc connection",ConnectionErrorReason$1.InternalError))},j);for(;this.state!==PCTransportState$1.CONNECTED;)if(yield sleep$2(50),V?.signal.aborted){G(new ConnectionError$1("room connection has been cancelled",ConnectionErrorReason$1.Cancelled));return}CriticalTimers$1.clearTimeout(H),V?.signal.removeEventListener("abort",z),K()}))})()})}},RpcError$2=class Be extends Error{constructor($,U,F){super(U),this.code=$,this.message=truncateBytes$1(U,Be.MAX_MESSAGE_BYTES),this.data=F?truncateBytes$1(F,Be.MAX_DATA_BYTES):void 0}static fromProto($){return new Be($.code,$.message,$.data)}toProto(){return new RpcError$1$1({code:this.code,message:this.message,data:this.data})}static builtIn($,U){return new Be(Be.ErrorCode[$],Be.ErrorMessage[$],U)}};RpcError$2.MAX_MESSAGE_BYTES=256,RpcError$2.MAX_DATA_BYTES=15360,RpcError$2.ErrorCode={APPLICATION_ERROR:1500,CONNECTION_TIMEOUT:1501,RESPONSE_TIMEOUT:1502,RECIPIENT_DISCONNECTED:1503,RESPONSE_PAYLOAD_TOO_LARGE:1504,SEND_FAILED:1505,UNSUPPORTED_METHOD:1400,RECIPIENT_NOT_FOUND:1401,REQUEST_PAYLOAD_TOO_LARGE:1402,UNSUPPORTED_SERVER:1403,UNSUPPORTED_VERSION:1404},RpcError$2.ErrorMessage={APPLICATION_ERROR:"Application error in method handler",CONNECTION_TIMEOUT:"Connection timeout",RESPONSE_TIMEOUT:"Response timeout",RECIPIENT_DISCONNECTED:"Recipient disconnected",RESPONSE_PAYLOAD_TOO_LARGE:"Response payload too large",SEND_FAILED:"Failed to send",UNSUPPORTED_METHOD:"Method not supported at destination",RECIPIENT_NOT_FOUND:"Recipient not found",REQUEST_PAYLOAD_TOO_LARGE:"Request payload too large",UNSUPPORTED_SERVER:"RPC not supported by server",UNSUPPORTED_VERSION:"Unsupported RPC version"};const MAX_PAYLOAD_BYTES$1=15360;function byteLength$1(B){return new TextEncoder().encode(B).length}function truncateBytes$1(B,$){if(byteLength$1(B)<=$)return B;let U=0,F=B.length;const V=new TextEncoder;for(;U<F;){const q=Math.floor((U+F+1)/2);V.encode(B.slice(0,q)).length<=$?U=q:F=q-1}return B.slice(0,U)}const monitorFrequency$1=2e3;function computeBitrate$1(B,$){if(!$)return 0;let U,F;return"bytesReceived"in B?(U=B.bytesReceived,F=$.bytesReceived):"bytesSent"in B&&(U=B.bytesSent,F=$.bytesSent),U===void 0||F===void 0||B.timestamp===void 0||$.timestamp===void 0?0:(U-F)*8*1e3/(B.timestamp-$.timestamp)}const defaultDimensionsTimeout=1e3;let LocalTrack$1=class extends Track$1{get sender(){return this._sender}set sender($){this._sender=$}get constraints(){return this._constraints}constructor($,U,F){let V=arguments.length>3&&arguments[3]!==void 0?arguments[3]:!1,q=arguments.length>4?arguments[4]:void 0;super($,U,q),this.manuallyStopped=!1,this._isUpstreamPaused=!1,this.handleTrackMuteEvent=()=>this.debouncedTrackMuteHandler().catch(()=>this.log.debug("track mute bounce got cancelled by an unmute event",this.logContext)),this.debouncedTrackMuteHandler=r$2(()=>__awaiter$2(this,void 0,void 0,function*(){yield this.pauseUpstream()}),5e3),this.handleTrackUnmuteEvent=()=>__awaiter$2(this,void 0,void 0,function*(){this.debouncedTrackMuteHandler.cancel("unmute"),yield this.resumeUpstream()}),this.handleEnded=()=>{this.isInBackground&&(this.reacquireTrack=!0),this._mediaStreamTrack.removeEventListener("mute",this.handleTrackMuteEvent),this._mediaStreamTrack.removeEventListener("unmute",this.handleTrackUnmuteEvent),this.emit(TrackEvent$1.Ended,this)},this.reacquireTrack=!1,this.providedByUser=V,this.muteLock=new _$2,this.pauseUpstreamLock=new _$2,this.processorLock=new _$2,this.restartLock=new _$2,this.setMediaStreamTrack($,!0),this._constraints=$.getConstraints(),F&&(this._constraints=F)}get id(){return this._mediaStreamTrack.id}get dimensions(){if(this.kind!==Track$1.Kind.Video)return;const{width:$,height:U}=this._mediaStreamTrack.getSettings();if($&&U)return{width:$,height:U}}get isUpstreamPaused(){return this._isUpstreamPaused}get isUserProvided(){return this.providedByUser}get mediaStreamTrack(){var $,U;return(U=($=this.processor)===null||$===void 0?void 0:$.processedTrack)!==null&&U!==void 0?U:this._mediaStreamTrack}get isLocal(){return!0}getSourceTrackSettings(){return this._mediaStreamTrack.getSettings()}setMediaStreamTrack($,U){return __awaiter$2(this,void 0,void 0,function*(){var F;if($===this._mediaStreamTrack&&!U)return;this._mediaStreamTrack&&(this.attachedElements.forEach(q=>{detachTrack$1(this._mediaStreamTrack,q)}),this.debouncedTrackMuteHandler.cancel("new-track"),this._mediaStreamTrack.removeEventListener("ended",this.handleEnded),this._mediaStreamTrack.removeEventListener("mute",this.handleTrackMuteEvent),this._mediaStreamTrack.removeEventListener("unmute",this.handleTrackUnmuteEvent)),this.mediaStream=new MediaStream([$]),$&&($.addEventListener("ended",this.handleEnded),$.addEventListener("mute",this.handleTrackMuteEvent),$.addEventListener("unmute",this.handleTrackUnmuteEvent),this._constraints=$.getConstraints());let V;if(this.processor&&$){const q=yield this.processorLock.lock();try{if(this.log.debug("restarting processor",this.logContext),this.kind==="unknown")throw TypeError("cannot set processor on track of unknown kind");this.processorElement&&(attachToElement$1($,this.processorElement),this.processorElement.muted=!0),yield this.processor.restart({track:$,kind:this.kind,element:this.processorElement}),V=this.processor.processedTrack}finally{q()}}this.sender&&((F=this.sender.transport)===null||F===void 0?void 0:F.state)!=="closed"&&(yield this.sender.replaceTrack(V??$)),!this.providedByUser&&this._mediaStreamTrack!==$&&this._mediaStreamTrack.stop(),this._mediaStreamTrack=$,$&&(this._mediaStreamTrack.enabled=!this.isMuted,yield this.resumeUpstream(),this.attachedElements.forEach(q=>{attachToElement$1(V??$,q)}))})}waitForDimensions(){return __awaiter$2(this,arguments,void 0,function(){var $=this;let U=arguments.length>0&&arguments[0]!==void 0?arguments[0]:defaultDimensionsTimeout;return(function*(){var F;if($.kind===Track$1.Kind.Audio)throw new Error("cannot get dimensions for audio tracks");((F=getBrowser$1())===null||F===void 0?void 0:F.os)==="iOS"&&(yield sleep$2(10));const V=Date.now();for(;Date.now()-V<U;){const q=$.dimensions;if(q)return q;yield sleep$2(50)}throw new TrackInvalidError$1("unable to get track dimensions after timeout")})()})}setDeviceId($){return __awaiter$2(this,void 0,void 0,function*(){return this._constraints.deviceId===$&&this._mediaStreamTrack.getSettings().deviceId===unwrapConstraint$1($)||(this._constraints.deviceId=$,this.isMuted)?!0:(yield this.restartTrack(),unwrapConstraint$1($)===this._mediaStreamTrack.getSettings().deviceId)})}getDeviceId(){return __awaiter$2(this,arguments,void 0,function(){var $=this;let U=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0;return(function*(){if($.source===Track$1.Source.ScreenShare)return;const{deviceId:F,groupId:V}=$._mediaStreamTrack.getSettings(),q=$.kind===Track$1.Kind.Audio?"audioinput":"videoinput";return U?DeviceManager$1.getInstance().normalizeDeviceId(q,F,V):F})()})}mute(){return __awaiter$2(this,void 0,void 0,function*(){return this.setTrackMuted(!0),this})}unmute(){return __awaiter$2(this,void 0,void 0,function*(){return this.setTrackMuted(!1),this})}replaceTrack($,U){return __awaiter$2(this,void 0,void 0,function*(){if(!this.sender)throw new TrackInvalidError$1("unable to replace an unpublished track");let F,V;return typeof U=="boolean"?F=U:U!==void 0&&(F=U.userProvidedTrack,V=U.stopProcessor),this.providedByUser=F??!0,this.log.debug("replace MediaStreamTrack",this.logContext),yield this.setMediaStreamTrack($),V&&this.processor&&(yield this.stopProcessor()),this})}restart($){return __awaiter$2(this,void 0,void 0,function*(){this.manuallyStopped=!1;const U=yield this.restartLock.lock();try{$||($=this._constraints);const{deviceId:F,facingMode:V}=$,q=__rest$1($,["deviceId","facingMode"]);this.log.debug("restarting track with constraints",Object.assign(Object.assign({},this.logContext),{constraints:$}));const j={audio:!1,video:!1};this.kind===Track$1.Kind.Video?j.video=F||V?{deviceId:F,facingMode:V}:!0:j.audio=F?{deviceId:F}:!0,this.attachedElements.forEach(G=>{detachTrack$1(this.mediaStreamTrack,G)}),this._mediaStreamTrack.removeEventListener("ended",this.handleEnded),this._mediaStreamTrack.stop();const K=(yield navigator.mediaDevices.getUserMedia(j)).getTracks()[0];return yield K.applyConstraints(q),K.addEventListener("ended",this.handleEnded),this.log.debug("re-acquired MediaStreamTrack",this.logContext),yield this.setMediaStreamTrack(K),this._constraints=$,this.emit(TrackEvent$1.Restarted,this),this.manuallyStopped&&(this.log.warn("track was stopped during a restart, stopping restarted track",this.logContext),this.stop()),this}finally{U()}})}setTrackMuted($){this.log.debug("setting ".concat(this.kind," track ").concat($?"muted":"unmuted"),this.logContext),!(this.isMuted===$&&this._mediaStreamTrack.enabled!==$)&&(this.isMuted=$,this._mediaStreamTrack.enabled=!$,this.emit($?TrackEvent$1.Muted:TrackEvent$1.Unmuted,this))}get needsReAcquisition(){return this._mediaStreamTrack.readyState!=="live"||this._mediaStreamTrack.muted||!this._mediaStreamTrack.enabled||this.reacquireTrack}handleAppVisibilityChanged(){const $=Object.create(null,{handleAppVisibilityChanged:{get:()=>super.handleAppVisibilityChanged}});return __awaiter$2(this,void 0,void 0,function*(){yield $.handleAppVisibilityChanged.call(this),isMobile$1()&&(this.log.debug("visibility changed, is in Background: ".concat(this.isInBackground),this.logContext),!this.isInBackground&&this.needsReAcquisition&&!this.isUserProvided&&!this.isMuted&&(this.log.debug("track needs to be reacquired, restarting ".concat(this.source),this.logContext),yield this.restart(),this.reacquireTrack=!1))})}stop(){var $;this.manuallyStopped=!0,super.stop(),this._mediaStreamTrack.removeEventListener("ended",this.handleEnded),this._mediaStreamTrack.removeEventListener("mute",this.handleTrackMuteEvent),this._mediaStreamTrack.removeEventListener("unmute",this.handleTrackUnmuteEvent),($=this.processor)===null||$===void 0||$.destroy(),this.processor=void 0}pauseUpstream(){return __awaiter$2(this,void 0,void 0,function*(){var $;const U=yield this.pauseUpstreamLock.lock();try{if(this._isUpstreamPaused===!0)return;if(!this.sender){this.log.warn("unable to pause upstream for an unpublished track",this.logContext);return}this._isUpstreamPaused=!0,this.emit(TrackEvent$1.UpstreamPaused,this);const F=getBrowser$1();if(F?.name==="Safari"&&compareVersions$1(F.version,"12.0")<0)throw new DeviceUnsupportedError$1("pauseUpstream is not supported on Safari < 12.");(($=this.sender.transport)===null||$===void 0?void 0:$.state)!=="closed"&&(yield this.sender.replaceTrack(null))}finally{U()}})}resumeUpstream(){return __awaiter$2(this,void 0,void 0,function*(){var $;const U=yield this.pauseUpstreamLock.lock();try{if(this._isUpstreamPaused===!1)return;if(!this.sender){this.log.warn("unable to resume upstream for an unpublished track",this.logContext);return}this._isUpstreamPaused=!1,this.emit(TrackEvent$1.UpstreamResumed,this),(($=this.sender.transport)===null||$===void 0?void 0:$.state)!=="closed"&&(yield this.sender.replaceTrack(this.mediaStreamTrack))}finally{U()}})}getRTCStatsReport(){return __awaiter$2(this,void 0,void 0,function*(){var $;return!(($=this.sender)===null||$===void 0)&&$.getStats?yield this.sender.getStats():void 0})}setProcessor($){return __awaiter$2(this,arguments,void 0,function(U){var F=this;let V=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0;return(function*(){var q;const j=yield F.processorLock.lock();try{F.log.debug("setting up processor",F.logContext);const W=document.createElement(F.kind),K={kind:F.kind,track:F._mediaStreamTrack,element:W,audioContext:F.audioContext};if(yield U.init(K),F.log.debug("processor initialized",F.logContext),F.processor&&(yield F.stopProcessor()),F.kind==="unknown")throw TypeError("cannot set processor on track of unknown kind");if(attachToElement$1(F._mediaStreamTrack,W),W.muted=!0,W.play().catch(G=>F.log.error("failed to play processor element",Object.assign(Object.assign({},F.logContext),{error:G}))),F.processor=U,F.processorElement=W,F.processor.processedTrack){for(const G of F.attachedElements)G!==F.processorElement&&V&&(detachTrack$1(F._mediaStreamTrack,G),attachToElement$1(F.processor.processedTrack,G));yield(q=F.sender)===null||q===void 0?void 0:q.replaceTrack(F.processor.processedTrack)}F.emit(TrackEvent$1.TrackProcessorUpdate,F.processor)}finally{j()}})()})}getProcessor(){return this.processor}stopProcessor(){return __awaiter$2(this,arguments,void 0,function(){var $=this;let U=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0;return(function*(){var F,V;$.processor&&($.log.debug("stopping processor",$.logContext),(F=$.processor.processedTrack)===null||F===void 0||F.stop(),yield $.processor.destroy(),$.processor=void 0,U||((V=$.processorElement)===null||V===void 0||V.remove(),$.processorElement=void 0),yield $._mediaStreamTrack.applyConstraints($._constraints),yield $.setMediaStreamTrack($._mediaStreamTrack,!0),$.emit(TrackEvent$1.TrackProcessorUpdate))})()})}},LocalAudioTrack$1=class extends LocalTrack$1{get enhancedNoiseCancellation(){return this.isKrispNoiseFilterEnabled}constructor($,U){let F=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!0,V=arguments.length>3?arguments[3]:void 0,q=arguments.length>4?arguments[4]:void 0;super($,Track$1.Kind.Audio,U,F,q),this.stopOnMute=!1,this.isKrispNoiseFilterEnabled=!1,this.monitorSender=()=>__awaiter$2(this,void 0,void 0,function*(){if(!this.sender){this._currentBitrate=0;return}let j;try{j=yield this.getSenderStats()}catch(W){this.log.error("could not get audio sender stats",Object.assign(Object.assign({},this.logContext),{error:W}));return}j&&this.prevStats&&(this._currentBitrate=computeBitrate$1(j,this.prevStats)),this.prevStats=j}),this.handleKrispNoiseFilterEnable=()=>{this.isKrispNoiseFilterEnabled=!0,this.log.debug("Krisp noise filter enabled",this.logContext),this.emit(TrackEvent$1.AudioTrackFeatureUpdate,this,AudioTrackFeature$1.TF_ENHANCED_NOISE_CANCELLATION,!0)},this.handleKrispNoiseFilterDisable=()=>{this.isKrispNoiseFilterEnabled=!1,this.log.debug("Krisp noise filter disabled",this.logContext),this.emit(TrackEvent$1.AudioTrackFeatureUpdate,this,AudioTrackFeature$1.TF_ENHANCED_NOISE_CANCELLATION,!1)},this.audioContext=V,this.checkForSilence()}mute(){const $=Object.create(null,{mute:{get:()=>super.mute}});return __awaiter$2(this,void 0,void 0,function*(){const U=yield this.muteLock.lock();try{return this.isMuted?(this.log.debug("Track already muted",this.logContext),this):(this.source===Track$1.Source.Microphone&&this.stopOnMute&&!this.isUserProvided&&(this.log.debug("stopping mic track",this.logContext),this._mediaStreamTrack.stop()),yield $.mute.call(this),this)}finally{U()}})}unmute(){const $=Object.create(null,{unmute:{get:()=>super.unmute}});return __awaiter$2(this,void 0,void 0,function*(){const U=yield this.muteLock.lock();try{if(!this.isMuted)return this.log.debug("Track already unmuted",this.logContext),this;const F=this._constraints.deviceId&&this._mediaStreamTrack.getSettings().deviceId!==unwrapConstraint$1(this._constraints.deviceId);return this.source===Track$1.Source.Microphone&&(this.stopOnMute||this._mediaStreamTrack.readyState==="ended"||F)&&!this.isUserProvided&&(this.log.debug("reacquiring mic track",this.logContext),yield this.restartTrack()),yield $.unmute.call(this),this}finally{U()}})}restartTrack($){return __awaiter$2(this,void 0,void 0,function*(){let U;if($){const F=constraintsForOptions$1({audio:$});typeof F.audio!="boolean"&&(U=F.audio)}yield this.restart(U)})}restart($){const U=Object.create(null,{restart:{get:()=>super.restart}});return __awaiter$2(this,void 0,void 0,function*(){const F=yield U.restart.call(this,$);return this.checkForSilence(),F})}startMonitor(){isWeb$1()&&(this.monitorInterval||(this.monitorInterval=setInterval(()=>{this.monitorSender()},monitorFrequency$1)))}setProcessor($){return __awaiter$2(this,void 0,void 0,function*(){var U;const F=yield this.processorLock.lock();try{if(!isReactNative$1()&&!this.audioContext)throw Error("Audio context needs to be set on LocalAudioTrack in order to enable processors");this.processor&&(yield this.stopProcessor());const V={kind:this.kind,track:this._mediaStreamTrack,audioContext:this.audioContext};this.log.debug("setting up audio processor ".concat($.name),this.logContext),yield $.init(V),this.processor=$,this.processor.processedTrack&&(yield(U=this.sender)===null||U===void 0?void 0:U.replaceTrack(this.processor.processedTrack),this.processor.processedTrack.addEventListener("enable-lk-krisp-noise-filter",this.handleKrispNoiseFilterEnable),this.processor.processedTrack.addEventListener("disable-lk-krisp-noise-filter",this.handleKrispNoiseFilterDisable)),this.emit(TrackEvent$1.TrackProcessorUpdate,this.processor)}finally{F()}})}setAudioContext($){this.audioContext=$}getSenderStats(){return __awaiter$2(this,void 0,void 0,function*(){var $;if(!(!(($=this.sender)===null||$===void 0)&&$.getStats))return;const U=yield this.sender.getStats();let F;return U.forEach(V=>{V.type==="outbound-rtp"&&(F={type:"audio",streamId:V.id,packetsSent:V.packetsSent,packetsLost:V.packetsLost,bytesSent:V.bytesSent,timestamp:V.timestamp,roundTripTime:V.roundTripTime,jitter:V.jitter})}),F})}checkForSilence(){return __awaiter$2(this,void 0,void 0,function*(){const $=yield detectSilence$1(this);return $&&(this.isMuted||this.log.warn("silence detected on local audio track",this.logContext),this.emit(TrackEvent$1.AudioSilenceDetected)),$})}};function mediaTrackToLocalTrack$1(B,$,U){switch(B.kind){case"audio":return new LocalAudioTrack$1(B,$,!1,void 0,U);case"video":return new LocalVideoTrack$1(B,$,!1,U);default:throw new TrackInvalidError$1("unsupported track type: ".concat(B.kind))}}const presets169$1=Object.values(VideoPresets$1),presets43$1=Object.values(VideoPresets43$1),presetsScreenShare$1=Object.values(ScreenSharePresets$1),defaultSimulcastPresets169$1=[VideoPresets$1.h180,VideoPresets$1.h360],defaultSimulcastPresets43$1=[VideoPresets43$1.h180,VideoPresets43$1.h360],computeDefaultScreenShareSimulcastPresets$1=B=>[{scaleResolutionDownBy:2,fps:B.encoding.maxFramerate}].map(U=>{var F,V;return new VideoPreset$1(Math.floor(B.width/U.scaleResolutionDownBy),Math.floor(B.height/U.scaleResolutionDownBy),Math.max(15e4,Math.floor(B.encoding.maxBitrate/(Math.pow(U.scaleResolutionDownBy,2)*(((F=B.encoding.maxFramerate)!==null&&F!==void 0?F:30)/((V=U.fps)!==null&&V!==void 0?V:30))))),U.fps,B.encoding.priority)}),videoRids$1=["q","h","f"];function computeVideoEncodings$1(B,$,U,F){var V,q;let j=F?.videoEncoding;B&&(j=F?.screenShareEncoding);const W=F?.simulcast,K=F?.scalabilityMode,G=F?.videoCodec;if(!j&&!W&&!K||!$||!U)return[{}];j||(j=determineAppropriateEncoding$1(B,$,U,G),livekitLogger$1.debug("using video encoding",j));const z=j.maxFramerate,H=new VideoPreset$1($,U,j.maxBitrate,j.maxFramerate,j.priority);if(K&&isSVCCodec$1(G)){const X=new ScalabilityMode$1(K),Z=[];if(X.spatial>3)throw new Error("unsupported scalabilityMode: ".concat(K));const ne=getBrowser$1();if(isSafari$1()||isReactNative$1()||ne?.name==="Chrome"&&compareVersions$1(ne?.version,"113")<0){const ee=X.suffix=="h"?2:3;for(let ie=0;ie<X.spatial;ie+=1)Z.push({rid:videoRids$1[2-ie],maxBitrate:j.maxBitrate/Math.pow(ee,ie),maxFramerate:H.encoding.maxFramerate});Z[0].scalabilityMode=K}else Z.push({maxBitrate:j.maxBitrate,maxFramerate:H.encoding.maxFramerate,scalabilityMode:K});return H.encoding.priority&&(Z[0].priority=H.encoding.priority,Z[0].networkPriority=H.encoding.priority),livekitLogger$1.debug("using svc encoding",{encodings:Z}),Z}if(!W)return[j];let Q=[];B?Q=(V=sortPresets$1(F?.screenShareSimulcastLayers))!==null&&V!==void 0?V:defaultSimulcastLayers$1(B,H):Q=(q=sortPresets$1(F?.videoSimulcastLayers))!==null&&q!==void 0?q:defaultSimulcastLayers$1(B,H);let Y;if(Q.length>0){const X=Q[0];Q.length>1&&([,Y]=Q);const Z=Math.max($,U);if(Z>=960&&Y)return encodingsFromPresets$1($,U,[X,Y,H],z);if(Z>=480)return encodingsFromPresets$1($,U,[X,H],z)}return encodingsFromPresets$1($,U,[H])}function computeTrackBackupEncodings$1(B,$,U){var F,V,q,j;if(!U.backupCodec||U.backupCodec===!0||U.backupCodec.codec===U.videoCodec)return;$!==U.backupCodec.codec&&livekitLogger$1.warn("requested a different codec than specified as backup",{serverRequested:$,backup:U.backupCodec.codec}),U.videoCodec=$,U.videoEncoding=U.backupCodec.encoding;const W=B.mediaStreamTrack.getSettings(),K=(F=W.width)!==null&&F!==void 0?F:(V=B.dimensions)===null||V===void 0?void 0:V.width,G=(q=W.height)!==null&&q!==void 0?q:(j=B.dimensions)===null||j===void 0?void 0:j.height;return B.source===Track$1.Source.ScreenShare&&U.simulcast&&(U.simulcast=!1),computeVideoEncodings$1(B.source===Track$1.Source.ScreenShare,K,G,U)}function determineAppropriateEncoding$1(B,$,U,F){const V=presetsForResolution$1(B,$,U);let{encoding:q}=V[0];const j=Math.max($,U);for(let W=0;W<V.length;W+=1){const K=V[W];if(q=K.encoding,K.width>=j)break}if(F)switch(F){case"av1":q=Object.assign({},q),q.maxBitrate=q.maxBitrate*.7;break;case"vp9":q=Object.assign({},q),q.maxBitrate=q.maxBitrate*.85;break}return q}function presetsForResolution$1(B,$,U){if(B)return presetsScreenShare$1;const F=$>U?$/U:U/$;return Math.abs(F-16/9)<Math.abs(F-4/3)?presets169$1:presets43$1}function defaultSimulcastLayers$1(B,$){if(B)return computeDefaultScreenShareSimulcastPresets$1($);const{width:U,height:F}=$,V=U>F?U/F:F/U;return Math.abs(V-16/9)<Math.abs(V-4/3)?defaultSimulcastPresets169$1:defaultSimulcastPresets43$1}function encodingsFromPresets$1(B,$,U,F){const V=[];if(U.forEach((q,j)=>{if(j>=videoRids$1.length)return;const W=Math.min(B,$),G={rid:videoRids$1[j],scaleResolutionDownBy:Math.max(1,W/Math.min(q.width,q.height)),maxBitrate:q.encoding.maxBitrate},z=F&&q.encoding.maxFramerate?Math.min(F,q.encoding.maxFramerate):q.encoding.maxFramerate;z&&(G.maxFramerate=z);const H=isFireFox$1()||j===0;q.encoding.priority&&H&&(G.priority=q.encoding.priority,G.networkPriority=q.encoding.priority),V.push(G)}),isReactNative$1()&&getReactNativeOs$1()==="ios"){let q;V.forEach(W=>{q?W.maxFramerate&&W.maxFramerate>q&&(q=W.maxFramerate):q=W.maxFramerate});let j=!0;V.forEach(W=>{var K;W.maxFramerate!=q&&(j&&(j=!1,livekitLogger$1.info("Simulcast on iOS React-Native requires all encodings to share the same framerate.")),livekitLogger$1.info('Setting framerate of encoding "'.concat((K=W.rid)!==null&&K!==void 0?K:"",'" to ').concat(q)),W.maxFramerate=q)})}return V}function sortPresets$1(B){if(B)return B.sort(($,U)=>{const{encoding:F}=$,{encoding:V}=U;return F.maxBitrate>V.maxBitrate?1:F.maxBitrate<V.maxBitrate?-1:F.maxBitrate===V.maxBitrate&&F.maxFramerate&&V.maxFramerate?F.maxFramerate>V.maxFramerate?1:-1:0})}let ScalabilityMode$1=class{constructor($){const U=$.match(/^L(\d)T(\d)(h|_KEY|_KEY_SHIFT){0,1}$/);if(!U)throw new Error("invalid scalability mode");if(this.spatial=parseInt(U[1]),this.temporal=parseInt(U[2]),U.length>3)switch(U[3]){case"h":case"_KEY":case"_KEY_SHIFT":this.suffix=U[3]}}toString(){var $;return"L".concat(this.spatial,"T").concat(this.temporal).concat(($=this.suffix)!==null&&$!==void 0?$:"")}};function getDefaultDegradationPreference$1(B){return B.source===Track$1.Source.ScreenShare||B.constraints.height&&unwrapConstraint$1(B.constraints.height)>=1080?"maintain-resolution":"balanced"}const refreshSubscribedCodecAfterNewCodec$1=5e3;let LocalVideoTrack$1=class extends LocalTrack$1{get sender(){return this._sender}set sender($){this._sender=$,this.degradationPreference&&this.setDegradationPreference(this.degradationPreference)}constructor($,U){let F=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!0,V=arguments.length>3?arguments[3]:void 0;super($,Track$1.Kind.Video,U,F,V),this.simulcastCodecs=new Map,this.degradationPreference="balanced",this.monitorSender=()=>__awaiter$2(this,void 0,void 0,function*(){if(!this.sender){this._currentBitrate=0;return}let q;try{q=yield this.getSenderStats()}catch(W){this.log.error("could not get audio sender stats",Object.assign(Object.assign({},this.logContext),{error:W}));return}const j=new Map(q.map(W=>[W.rid,W]));if(this.prevStats){let W=0;j.forEach((K,G)=>{var z;const H=(z=this.prevStats)===null||z===void 0?void 0:z.get(G);W+=computeBitrate$1(K,H)}),this._currentBitrate=W}this.prevStats=j}),this.senderLock=new _$2}get isSimulcast(){return!!(this.sender&&this.sender.getParameters().encodings.length>1)}startMonitor($){var U;if(this.signalClient=$,!isWeb$1())return;const F=(U=this.sender)===null||U===void 0?void 0:U.getParameters();F&&(this.encodings=F.encodings),!this.monitorInterval&&(this.monitorInterval=setInterval(()=>{this.monitorSender()},monitorFrequency$1))}stop(){this._mediaStreamTrack.getConstraints(),this.simulcastCodecs.forEach($=>{$.mediaStreamTrack.stop()}),super.stop()}pauseUpstream(){const $=Object.create(null,{pauseUpstream:{get:()=>super.pauseUpstream}});return __awaiter$2(this,void 0,void 0,function*(){var U,F,V,q,j;yield $.pauseUpstream.call(this);try{for(var W=!0,K=__asyncValues$1(this.simulcastCodecs.values()),G;G=yield K.next(),U=G.done,!U;W=!0)q=G.value,W=!1,yield(j=q.sender)===null||j===void 0?void 0:j.replaceTrack(null)}catch(z){F={error:z}}finally{try{!W&&!U&&(V=K.return)&&(yield V.call(K))}finally{if(F)throw F.error}}})}resumeUpstream(){const $=Object.create(null,{resumeUpstream:{get:()=>super.resumeUpstream}});return __awaiter$2(this,void 0,void 0,function*(){var U,F,V,q,j;yield $.resumeUpstream.call(this);try{for(var W=!0,K=__asyncValues$1(this.simulcastCodecs.values()),G;G=yield K.next(),U=G.done,!U;W=!0){q=G.value,W=!1;const z=q;yield(j=z.sender)===null||j===void 0?void 0:j.replaceTrack(z.mediaStreamTrack)}}catch(z){F={error:z}}finally{try{!W&&!U&&(V=K.return)&&(yield V.call(K))}finally{if(F)throw F.error}}})}mute(){const $=Object.create(null,{mute:{get:()=>super.mute}});return __awaiter$2(this,void 0,void 0,function*(){const U=yield this.muteLock.lock();try{return this.isMuted?(this.log.debug("Track already muted",this.logContext),this):(this.source===Track$1.Source.Camera&&!this.isUserProvided&&(this.log.debug("stopping camera track",this.logContext),this._mediaStreamTrack.stop()),yield $.mute.call(this),this)}finally{U()}})}unmute(){const $=Object.create(null,{unmute:{get:()=>super.unmute}});return __awaiter$2(this,void 0,void 0,function*(){const U=yield this.muteLock.lock();try{return this.isMuted?(this.source===Track$1.Source.Camera&&!this.isUserProvided&&(this.log.debug("reacquiring camera track",this.logContext),yield this.restartTrack()),yield $.unmute.call(this),this):(this.log.debug("Track already unmuted",this.logContext),this)}finally{U()}})}setTrackMuted($){super.setTrackMuted($);for(const U of this.simulcastCodecs.values())U.mediaStreamTrack.enabled=!$}getSenderStats(){return __awaiter$2(this,void 0,void 0,function*(){var $;if(!(!(($=this.sender)===null||$===void 0)&&$.getStats))return[];const U=[],F=yield this.sender.getStats();return F.forEach(V=>{var q;if(V.type==="outbound-rtp"){const j={type:"video",streamId:V.id,frameHeight:V.frameHeight,frameWidth:V.frameWidth,framesPerSecond:V.framesPerSecond,framesSent:V.framesSent,firCount:V.firCount,pliCount:V.pliCount,nackCount:V.nackCount,packetsSent:V.packetsSent,bytesSent:V.bytesSent,qualityLimitationReason:V.qualityLimitationReason,qualityLimitationDurations:V.qualityLimitationDurations,qualityLimitationResolutionChanges:V.qualityLimitationResolutionChanges,rid:(q=V.rid)!==null&&q!==void 0?q:V.id,retransmittedPacketsSent:V.retransmittedPacketsSent,targetBitrate:V.targetBitrate,timestamp:V.timestamp},W=F.get(V.remoteId);W&&(j.jitter=W.jitter,j.packetsLost=W.packetsLost,j.roundTripTime=W.roundTripTime),U.push(j)}}),U.sort((V,q)=>{var j,W;return((j=q.frameWidth)!==null&&j!==void 0?j:0)-((W=V.frameWidth)!==null&&W!==void 0?W:0)}),U})}setPublishingQuality($){const U=[];for(let F=VideoQuality$2.LOW;F<=VideoQuality$2.HIGH;F+=1)U.push(new SubscribedQuality$1({quality:F,enabled:F<=$}));this.log.debug("setting publishing quality. max quality ".concat($),this.logContext),this.setPublishingLayers(U)}restartTrack($){return __awaiter$2(this,void 0,void 0,function*(){var U,F,V,q,j;let W;if($){const H=constraintsForOptions$1({video:$});typeof H.video!="boolean"&&(W=H.video)}yield this.restart(W);try{for(var K=!0,G=__asyncValues$1(this.simulcastCodecs.values()),z;z=yield G.next(),U=z.done,!U;K=!0){q=z.value,K=!1;const H=q;H.sender&&((j=H.sender.transport)===null||j===void 0?void 0:j.state)!=="closed"&&(H.mediaStreamTrack=this.mediaStreamTrack.clone(),yield H.sender.replaceTrack(H.mediaStreamTrack))}}catch(H){F={error:H}}finally{try{!K&&!U&&(V=G.return)&&(yield V.call(G))}finally{if(F)throw F.error}}})}setProcessor($){const U=Object.create(null,{setProcessor:{get:()=>super.setProcessor}});return __awaiter$2(this,arguments,void 0,function(F){var V=this;let q=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0;return(function*(){var j,W,K,G,z,H;if(yield U.setProcessor.call(V,F,q),!((z=V.processor)===null||z===void 0)&&z.processedTrack)try{for(var Q=!0,Y=__asyncValues$1(V.simulcastCodecs.values()),X;X=yield Y.next(),j=X.done,!j;Q=!0)G=X.value,Q=!1,yield(H=G.sender)===null||H===void 0?void 0:H.replaceTrack(V.processor.processedTrack)}catch(Z){W={error:Z}}finally{try{!Q&&!j&&(K=Y.return)&&(yield K.call(Y))}finally{if(W)throw W.error}}})()})}setDegradationPreference($){return __awaiter$2(this,void 0,void 0,function*(){if(this.degradationPreference=$,this.sender)try{this.log.debug("setting degradationPreference to ".concat($),this.logContext);const U=this.sender.getParameters();U.degradationPreference=$,this.sender.setParameters(U)}catch(U){this.log.warn("failed to set degradationPreference",Object.assign({error:U},this.logContext))}})}addSimulcastTrack($,U){if(this.simulcastCodecs.has($)){this.log.error("".concat($," already added, skipping adding simulcast codec"),this.logContext);return}const F={codec:$,mediaStreamTrack:this.mediaStreamTrack.clone(),sender:void 0,encodings:U};return this.simulcastCodecs.set($,F),F}setSimulcastTrackSender($,U){const F=this.simulcastCodecs.get($);F&&(F.sender=U,setTimeout(()=>{this.subscribedCodecs&&this.setPublishingCodecs(this.subscribedCodecs)},refreshSubscribedCodecAfterNewCodec$1))}setPublishingCodecs($){return __awaiter$2(this,void 0,void 0,function*(){var U,F,V,q,j,W,K;if(this.log.debug("setting publishing codecs",Object.assign(Object.assign({},this.logContext),{codecs:$,currentCodec:this.codec})),!this.codec&&$.length>0)return yield this.setPublishingLayers($[0].qualities),[];this.subscribedCodecs=$;const G=[];try{for(U=!0,F=__asyncValues$1($);V=yield F.next(),q=V.done,!q;U=!0){K=V.value,U=!1;const z=K;if(!this.codec||this.codec===z.codec)yield this.setPublishingLayers(z.qualities);else{const H=this.simulcastCodecs.get(z.codec);if(this.log.debug("try setPublishingCodec for ".concat(z.codec),Object.assign(Object.assign({},this.logContext),{simulcastCodecInfo:H})),!H||!H.sender){for(const Q of z.qualities)if(Q.enabled){G.push(z.codec);break}}else H.encodings&&(this.log.debug("try setPublishingLayersForSender ".concat(z.codec),this.logContext),yield setPublishingLayersForSender$1(H.sender,H.encodings,z.qualities,this.senderLock,this.log,this.logContext))}}}catch(z){j={error:z}}finally{try{!U&&!q&&(W=F.return)&&(yield W.call(F))}finally{if(j)throw j.error}}return G})}setPublishingLayers($){return __awaiter$2(this,void 0,void 0,function*(){this.log.debug("setting publishing layers",Object.assign(Object.assign({},this.logContext),{qualities:$})),!(!this.sender||!this.encodings)&&(yield setPublishingLayersForSender$1(this.sender,this.encodings,$,this.senderLock,this.log,this.logContext))})}handleAppVisibilityChanged(){const $=Object.create(null,{handleAppVisibilityChanged:{get:()=>super.handleAppVisibilityChanged}});return __awaiter$2(this,void 0,void 0,function*(){yield $.handleAppVisibilityChanged.call(this),isMobile$1()&&this.isInBackground&&this.source===Track$1.Source.Camera&&(this._mediaStreamTrack.enabled=!1)})}};function setPublishingLayersForSender$1(B,$,U,F,V,q){return __awaiter$2(this,void 0,void 0,function*(){const j=yield F.lock();V.debug("setPublishingLayersForSender",Object.assign(Object.assign({},q),{sender:B,qualities:U,senderEncodings:$}));try{const W=B.getParameters(),{encodings:K}=W;if(!K)return;if(K.length!==$.length){V.warn("cannot set publishing layers, encodings mismatch",Object.assign(Object.assign({},q),{encodings:K,senderEncodings:$}));return}let G=!1;const z=getBrowser$1();if(z?.name==="Chrome"&&compareVersions$1(z?.version,"133")>0&&K[0].scalabilityMode){const Q=K[0],Y=new ScalabilityMode$1(Q.scalabilityMode);let X=VideoQuality$1$1.OFF;if(U.forEach(Z=>{Z.enabled&&(X===VideoQuality$1$1.OFF||Z.quality>X)&&(X=Z.quality)}),X===VideoQuality$1$1.OFF)Q.active&&(Q.active=!1,G=!0);else if(!Q.active||Y.spatial!==X+1){G=!0,Q.active=!0;const Z=new ScalabilityMode$1($[0].scalabilityMode);Y.spatial=X+1,Y.suffix=Z.suffix,Y.spatial===1&&(Y.suffix=void 0),Q.scalabilityMode=Y.toString(),Q.scaleResolutionDownBy=Math.pow(2,2-X),$[0].maxBitrate&&(Q.maxBitrate=$[0].maxBitrate/(Q.scaleResolutionDownBy*Q.scaleResolutionDownBy))}}else K.forEach((Q,Y)=>{var X;let Z=(X=Q.rid)!==null&&X!==void 0?X:"";Z===""&&(Z="q");const ne=videoQualityForRid$1(Z),ee=U.find(ie=>ie.quality===ne);ee&&Q.active!==ee.enabled&&(G=!0,Q.active=ee.enabled,V.debug("setting layer ".concat(ee.quality," to ").concat(Q.active?"enabled":"disabled"),q),isFireFox$1()&&(ee.enabled?(Q.scaleResolutionDownBy=$[Y].scaleResolutionDownBy,Q.maxBitrate=$[Y].maxBitrate,Q.maxFrameRate=$[Y].maxFrameRate):(Q.scaleResolutionDownBy=4,Q.maxBitrate=10,Q.maxFrameRate=2)))});G&&(W.encodings=K,V.debug("setting encodings",Object.assign(Object.assign({},q),{encodings:W.encodings})),yield B.setParameters(W))}finally{j()}})}function videoQualityForRid$1(B){switch(B){case"f":return VideoQuality$2.HIGH;case"h":return VideoQuality$2.MEDIUM;case"q":return VideoQuality$2.LOW;default:return VideoQuality$2.HIGH}}function videoLayersFromEncodings$1(B,$,U,F){if(!U)return[new VideoLayer$1({quality:VideoQuality$2.HIGH,width:B,height:$,bitrate:0,ssrc:0})];if(F){const V=U[0].scalabilityMode,q=new ScalabilityMode$1(V),j=[],W=q.suffix=="h"?1.5:2,K=q.suffix=="h"?2:3;for(let G=0;G<q.spatial;G+=1)j.push(new VideoLayer$1({quality:Math.min(VideoQuality$2.HIGH,q.spatial-1)-G,width:Math.ceil(B/Math.pow(W,G)),height:Math.ceil($/Math.pow(W,G)),bitrate:U[0].maxBitrate?Math.ceil(U[0].maxBitrate/Math.pow(K,G)):0,ssrc:0}));return j}return U.map(V=>{var q,j,W;const K=(q=V.scaleResolutionDownBy)!==null&&q!==void 0?q:1;let G=videoQualityForRid$1((j=V.rid)!==null&&j!==void 0?j:"");return new VideoLayer$1({quality:G,width:Math.ceil(B/K),height:Math.ceil($/K),bitrate:(W=V.maxBitrate)!==null&&W!==void 0?W:0,ssrc:0})})}const lossyDataChannel$1="_lossy",reliableDataChannel$1="_reliable",minReconnectWait$1=2*1e3,leaveReconnect$1="leave-reconnect";var PCState$1;(function(B){B[B.New=0]="New",B[B.Connected=1]="Connected",B[B.Disconnected=2]="Disconnected",B[B.Reconnecting=3]="Reconnecting",B[B.Closed=4]="Closed"})(PCState$1||(PCState$1={}));let RTCEngine$1=class extends eventsExports$1.EventEmitter{get isClosed(){return this._isClosed}get pendingReconnect(){return!!this.reconnectTimeout}constructor($){var U;super(),this.options=$,this.rtcConfig={},this.peerConnectionTimeout=roomConnectOptionDefaults$1.peerConnectionTimeout,this.fullReconnectOnNext=!1,this.subscriberPrimary=!1,this.pcState=PCState$1.New,this._isClosed=!0,this.pendingTrackResolvers={},this.reconnectAttempts=0,this.reconnectStart=0,this.attemptingReconnect=!1,this.joinAttempts=0,this.maxJoinAttempts=1,this.shouldFailNext=!1,this.log=livekitLogger$1,this.handleDataChannel=F=>__awaiter$2(this,[F],void 0,function(V){var q=this;let{channel:j}=V;return(function*(){if(j){if(j.label===reliableDataChannel$1)q.reliableDCSub=j;else if(j.label===lossyDataChannel$1)q.lossyDCSub=j;else return;q.log.debug("on data channel ".concat(j.id,", ").concat(j.label),q.logContext),j.onmessage=q.handleDataMessage}})()}),this.handleDataMessage=F=>__awaiter$2(this,void 0,void 0,function*(){var V,q;const j=yield this.dataProcessLock.lock();try{let W;if(F.data instanceof ArrayBuffer)W=F.data;else if(F.data instanceof Blob)W=yield F.data.arrayBuffer();else{this.log.error("unsupported data type",Object.assign(Object.assign({},this.logContext),{data:F.data}));return}const K=DataPacket$1.fromBinary(new Uint8Array(W));((V=K.value)===null||V===void 0?void 0:V.case)==="speaker"?this.emit(EngineEvent$1.ActiveSpeakersUpdate,K.value.value.speakers):(((q=K.value)===null||q===void 0?void 0:q.case)==="user"&&applyUserDataCompat$1(K,K.value.value),this.emit(EngineEvent$1.DataPacketReceived,K))}finally{j()}}),this.handleDataError=F=>{const q=F.currentTarget.maxRetransmits===0?"lossy":"reliable";if(F instanceof ErrorEvent&&F.error){const{error:j}=F.error;this.log.error("DataChannel error on ".concat(q,": ").concat(F.message),Object.assign(Object.assign({},this.logContext),{error:j}))}else this.log.error("Unknown DataChannel error on ".concat(q),Object.assign(Object.assign({},this.logContext),{event:F}))},this.handleBufferedAmountLow=F=>{const q=F.currentTarget.maxRetransmits===0?DataPacket_Kind$1.LOSSY:DataPacket_Kind$1.RELIABLE;this.updateAndEmitDCBufferStatus(q)},this.handleDisconnect=(F,V)=>{if(this._isClosed)return;this.log.warn("".concat(F," disconnected"),this.logContext),this.reconnectAttempts===0&&(this.reconnectStart=Date.now());const q=K=>{this.log.warn("could not recover connection after ".concat(this.reconnectAttempts," attempts, ").concat(K,"ms. giving up"),this.logContext),this.emit(EngineEvent$1.Disconnected),this.close()},j=Date.now()-this.reconnectStart;let W=this.getNextRetryDelay({elapsedMs:j,retryCount:this.reconnectAttempts});if(W===null){q(j);return}F===leaveReconnect$1&&(W=0),this.log.debug("reconnecting in ".concat(W,"ms"),this.logContext),this.clearReconnectTimeout(),this.token&&this.regionUrlProvider&&this.regionUrlProvider.updateToken(this.token),this.reconnectTimeout=CriticalTimers$1.setTimeout(()=>this.attemptReconnect(V).finally(()=>this.reconnectTimeout=void 0),W)},this.waitForRestarted=()=>new Promise((F,V)=>{this.pcState===PCState$1.Connected&&F();const q=()=>{this.off(EngineEvent$1.Disconnected,j),F()},j=()=>{this.off(EngineEvent$1.Restarted,q),V()};this.once(EngineEvent$1.Restarted,q),this.once(EngineEvent$1.Disconnected,j)}),this.updateAndEmitDCBufferStatus=F=>{const V=this.isBufferStatusLow(F);typeof V<"u"&&V!==this.dcBufferStatus.get(F)&&(this.dcBufferStatus.set(F,V),this.emit(EngineEvent$1.DCBufferStatusChanged,V,F))},this.isBufferStatusLow=F=>{const V=this.dataChannelForKind(F);if(V)return V.bufferedAmount<=V.bufferedAmountLowThreshold},this.handleBrowserOnLine=()=>{this.client.currentState===SignalConnectionState$1.RECONNECTING&&(this.clearReconnectTimeout(),this.attemptReconnect(ReconnectReason$1.RR_SIGNAL_DISCONNECTED))},this.log=getLogger$1((U=$.loggerName)!==null&&U!==void 0?U:LoggerNames$1.Engine),this.loggerOptions={loggerName:$.loggerName,loggerContextCb:()=>this.logContext},this.client=new SignalClient$1(void 0,this.loggerOptions),this.client.signalLatency=this.options.expSignalLatency,this.reconnectPolicy=this.options.reconnectPolicy,this.registerOnLineListener(),this.closingLock=new _$2,this.dataProcessLock=new _$2,this.dcBufferStatus=new Map([[DataPacket_Kind$1.LOSSY,!0],[DataPacket_Kind$1.RELIABLE,!0]]),this.client.onParticipantUpdate=F=>this.emit(EngineEvent$1.ParticipantUpdate,F),this.client.onConnectionQuality=F=>this.emit(EngineEvent$1.ConnectionQualityUpdate,F),this.client.onRoomUpdate=F=>this.emit(EngineEvent$1.RoomUpdate,F),this.client.onSubscriptionError=F=>this.emit(EngineEvent$1.SubscriptionError,F),this.client.onSubscriptionPermissionUpdate=F=>this.emit(EngineEvent$1.SubscriptionPermissionUpdate,F),this.client.onSpeakersChanged=F=>this.emit(EngineEvent$1.SpeakersChanged,F),this.client.onStreamStateUpdate=F=>this.emit(EngineEvent$1.StreamStateChanged,F),this.client.onRequestResponse=F=>this.emit(EngineEvent$1.SignalRequestResponse,F)}get logContext(){var $,U,F,V,q,j,W,K;return{room:(U=($=this.latestJoinResponse)===null||$===void 0?void 0:$.room)===null||U===void 0?void 0:U.name,roomID:(V=(F=this.latestJoinResponse)===null||F===void 0?void 0:F.room)===null||V===void 0?void 0:V.sid,participant:(j=(q=this.latestJoinResponse)===null||q===void 0?void 0:q.participant)===null||j===void 0?void 0:j.identity,pID:(K=(W=this.latestJoinResponse)===null||W===void 0?void 0:W.participant)===null||K===void 0?void 0:K.sid}}join($,U,F,V){return __awaiter$2(this,void 0,void 0,function*(){this.url=$,this.token=U,this.signalOpts=F,this.maxJoinAttempts=F.maxRetries;try{this.joinAttempts+=1,this.setupSignalClientCallbacks();const q=yield this.client.join($,U,F,V);return this._isClosed=!1,this.latestJoinResponse=q,this.subscriberPrimary=q.subscriberPrimary,this.pcManager||(yield this.configure(q)),(!this.subscriberPrimary||q.fastPublish)&&this.negotiate(),this.clientConfiguration=q.clientConfiguration,setTimeout(()=>{this.emit(EngineEvent$1.SignalConnected)},10),q}catch(q){if(q instanceof ConnectionError$1&&q.reason===ConnectionErrorReason$1.ServerUnreachable&&(this.log.warn("Couldn't connect to server, attempt ".concat(this.joinAttempts," of ").concat(this.maxJoinAttempts),this.logContext),this.joinAttempts<this.maxJoinAttempts))return this.join($,U,F,V);throw q}})}close(){return __awaiter$2(this,void 0,void 0,function*(){const $=yield this.closingLock.lock();if(this.isClosed){$();return}try{this._isClosed=!0,this.joinAttempts=0,this.emit(EngineEvent$1.Closing),this.removeAllListeners(),this.deregisterOnLineListener(),this.clearPendingReconnect(),yield this.cleanupPeerConnections(),yield this.cleanupClient()}finally{$()}})}cleanupPeerConnections(){return __awaiter$2(this,void 0,void 0,function*(){var $;yield($=this.pcManager)===null||$===void 0?void 0:$.close(),this.pcManager=void 0;const U=F=>{F&&(F.close(),F.onbufferedamountlow=null,F.onclose=null,F.onclosing=null,F.onerror=null,F.onmessage=null,F.onopen=null)};U(this.lossyDC),U(this.lossyDCSub),U(this.reliableDC),U(this.reliableDCSub),this.lossyDC=void 0,this.lossyDCSub=void 0,this.reliableDC=void 0,this.reliableDCSub=void 0})}cleanupClient(){return __awaiter$2(this,void 0,void 0,function*(){yield this.client.close(),this.client.resetCallbacks()})}addTrack($){if(this.pendingTrackResolvers[$.cid])throw new TrackInvalidError$1("a track with the same ID has already been published");return new Promise((U,F)=>{const V=setTimeout(()=>{delete this.pendingTrackResolvers[$.cid],F(new ConnectionError$1("publication of local track timed out, no response from server",ConnectionErrorReason$1.InternalError))},1e4);this.pendingTrackResolvers[$.cid]={resolve:q=>{clearTimeout(V),U(q)},reject:()=>{clearTimeout(V),F(new Error("Cancelled publication by calling unpublish"))}},this.client.sendAddTrack($)})}removeTrack($){if($.track&&this.pendingTrackResolvers[$.track.id]){const{reject:U}=this.pendingTrackResolvers[$.track.id];U&&U(),delete this.pendingTrackResolvers[$.track.id]}try{return this.pcManager.removeTrack($),!0}catch(U){this.log.warn("failed to remove track",Object.assign(Object.assign({},this.logContext),{error:U}))}return!1}updateMuteStatus($,U){this.client.sendMuteTrack($,U)}get dataSubscriberReadyState(){var $;return($=this.reliableDCSub)===null||$===void 0?void 0:$.readyState}getConnectedServerAddress(){return __awaiter$2(this,void 0,void 0,function*(){var $;return($=this.pcManager)===null||$===void 0?void 0:$.getConnectedAddress()})}setRegionUrlProvider($){this.regionUrlProvider=$}configure($){return __awaiter$2(this,void 0,void 0,function*(){var U,F;if(this.pcManager&&this.pcManager.currentState!==PCTransportState$1.NEW)return;this.participantSid=(U=$.participant)===null||U===void 0?void 0:U.sid;const V=this.makeRTCConfiguration($);this.pcManager=new PCTransportManager$1(V,$.subscriberPrimary,this.loggerOptions),this.emit(EngineEvent$1.TransportsCreated,this.pcManager.publisher,this.pcManager.subscriber),this.pcManager.onIceCandidate=(q,j)=>{this.client.sendIceCandidate(q,j)},this.pcManager.onPublisherOffer=q=>{this.client.sendOffer(q)},this.pcManager.onDataChannel=this.handleDataChannel,this.pcManager.onStateChange=(q,j,W)=>__awaiter$2(this,void 0,void 0,function*(){if(this.log.debug("primary PC state changed ".concat(q),this.logContext),["closed","disconnected","failed"].includes(j)&&(this.publisherConnectionPromise=void 0),q===PCTransportState$1.CONNECTED){const z=this.pcState===PCState$1.New;this.pcState=PCState$1.Connected,z&&this.emit(EngineEvent$1.Connected,$)}else q===PCTransportState$1.FAILED&&this.pcState===PCState$1.Connected&&(this.pcState=PCState$1.Disconnected,this.handleDisconnect("peerconnection failed",W==="failed"?ReconnectReason$1.RR_SUBSCRIBER_FAILED:ReconnectReason$1.RR_PUBLISHER_FAILED));const K=this.client.isDisconnected||this.client.currentState===SignalConnectionState$1.RECONNECTING,G=[PCTransportState$1.FAILED,PCTransportState$1.CLOSING,PCTransportState$1.CLOSED].includes(q);K&&G&&!this._isClosed&&this.emit(EngineEvent$1.Offline)}),this.pcManager.onTrack=q=>{this.emit(EngineEvent$1.MediaTrackAdded,q.track,q.streams[0],q.receiver)},supportOptionalDatachannel$1((F=$.serverInfo)===null||F===void 0?void 0:F.protocol)||this.createDataChannels()})}setupSignalClientCallbacks(){this.client.onAnswer=$=>__awaiter$2(this,void 0,void 0,function*(){this.pcManager&&(this.log.debug("received server answer",Object.assign(Object.assign({},this.logContext),{RTCSdpType:$.type})),yield this.pcManager.setPublisherAnswer($))}),this.client.onTrickle=($,U)=>{this.pcManager&&(this.log.debug("got ICE candidate from peer",Object.assign(Object.assign({},this.logContext),{candidate:$,target:U})),this.pcManager.addIceCandidate($,U))},this.client.onOffer=$=>__awaiter$2(this,void 0,void 0,function*(){if(!this.pcManager)return;const U=yield this.pcManager.createSubscriberAnswerFromOffer($);this.client.sendAnswer(U)}),this.client.onLocalTrackPublished=$=>{var U;if(this.log.debug("received trackPublishedResponse",Object.assign(Object.assign({},this.logContext),{cid:$.cid,track:(U=$.track)===null||U===void 0?void 0:U.sid})),!this.pendingTrackResolvers[$.cid]){this.log.error("missing track resolver for ".concat($.cid),Object.assign(Object.assign({},this.logContext),{cid:$.cid}));return}const{resolve:F}=this.pendingTrackResolvers[$.cid];delete this.pendingTrackResolvers[$.cid],F($.track)},this.client.onLocalTrackUnpublished=$=>{this.emit(EngineEvent$1.LocalTrackUnpublished,$)},this.client.onLocalTrackSubscribed=$=>{this.emit(EngineEvent$1.LocalTrackSubscribed,$)},this.client.onTokenRefresh=$=>{this.token=$},this.client.onRemoteMuteChanged=($,U)=>{this.emit(EngineEvent$1.RemoteMute,$,U)},this.client.onSubscribedQualityUpdate=$=>{this.emit(EngineEvent$1.SubscribedQualityUpdate,$)},this.client.onClose=()=>{this.handleDisconnect("signal",ReconnectReason$1.RR_SIGNAL_DISCONNECTED)},this.client.onLeave=$=>{switch(this.log.debug("client leave request",Object.assign(Object.assign({},this.logContext),{reason:$?.reason})),$.regions&&this.regionUrlProvider&&(this.log.debug("updating regions",this.logContext),this.regionUrlProvider.setServerReportedRegions($.regions)),$.action){case LeaveRequest_Action$1.DISCONNECT:this.emit(EngineEvent$1.Disconnected,$?.reason),this.close();break;case LeaveRequest_Action$1.RECONNECT:this.fullReconnectOnNext=!0,this.handleDisconnect(leaveReconnect$1);break;case LeaveRequest_Action$1.RESUME:this.handleDisconnect(leaveReconnect$1)}}}makeRTCConfiguration($){var U;const F=Object.assign({},this.rtcConfig);if(!((U=this.signalOpts)===null||U===void 0)&&U.e2eeEnabled&&(this.log.debug("E2EE - setting up transports with insertable streams",this.logContext),F.encodedInsertableStreams=!0),$.iceServers&&!F.iceServers){const V=[];$.iceServers.forEach(q=>{const j={urls:q.urls};q.username&&(j.username=q.username),q.credential&&(j.credential=q.credential),V.push(j)}),F.iceServers=V}return $.clientConfiguration&&$.clientConfiguration.forceRelay===ClientConfigSetting$1.ENABLED&&(F.iceTransportPolicy="relay"),F.sdpSemantics="unified-plan",F.continualGatheringPolicy="gather_continually",F}createDataChannels(){this.pcManager&&(this.lossyDC&&(this.lossyDC.onmessage=null,this.lossyDC.onerror=null),this.reliableDC&&(this.reliableDC.onmessage=null,this.reliableDC.onerror=null),this.lossyDC=this.pcManager.createPublisherDataChannel(lossyDataChannel$1,{ordered:!0,maxRetransmits:0}),this.reliableDC=this.pcManager.createPublisherDataChannel(reliableDataChannel$1,{ordered:!0}),this.lossyDC.onmessage=this.handleDataMessage,this.reliableDC.onmessage=this.handleDataMessage,this.lossyDC.onerror=this.handleDataError,this.reliableDC.onerror=this.handleDataError,this.lossyDC.bufferedAmountLowThreshold=65535,this.reliableDC.bufferedAmountLowThreshold=65535,this.lossyDC.onbufferedamountlow=this.handleBufferedAmountLow,this.reliableDC.onbufferedamountlow=this.handleBufferedAmountLow)}createSender($,U,F){return __awaiter$2(this,void 0,void 0,function*(){if(supportsTransceiver$1())return yield this.createTransceiverRTCRtpSender($,U,F);if(supportsAddTrack$1())return this.log.warn("using add-track fallback",this.logContext),yield this.createRTCRtpSender($.mediaStreamTrack);throw new UnexpectedConnectionState$1("Required webRTC APIs not supported on this device")})}createSimulcastSender($,U,F,V){return __awaiter$2(this,void 0,void 0,function*(){if(supportsTransceiver$1())return this.createSimulcastTransceiverSender($,U,F,V);if(supportsAddTrack$1())return this.log.debug("using add-track fallback",this.logContext),this.createRTCRtpSender($.mediaStreamTrack);throw new UnexpectedConnectionState$1("Cannot stream on this device")})}createTransceiverRTCRtpSender($,U,F){return __awaiter$2(this,void 0,void 0,function*(){if(!this.pcManager)throw new UnexpectedConnectionState$1("publisher is closed");const V=[];$.mediaStream&&V.push($.mediaStream),isVideoTrack$1($)&&($.codec=U.videoCodec);const q={direction:"sendonly",streams:V};return F&&(q.sendEncodings=F),(yield this.pcManager.addPublisherTransceiver($.mediaStreamTrack,q)).sender})}createSimulcastTransceiverSender($,U,F,V){return __awaiter$2(this,void 0,void 0,function*(){if(!this.pcManager)throw new UnexpectedConnectionState$1("publisher is closed");const q={direction:"sendonly"};V&&(q.sendEncodings=V);const j=yield this.pcManager.addPublisherTransceiver(U.mediaStreamTrack,q);if(F.videoCodec)return $.setSimulcastTrackSender(F.videoCodec,j.sender),j.sender})}createRTCRtpSender($){return __awaiter$2(this,void 0,void 0,function*(){if(!this.pcManager)throw new UnexpectedConnectionState$1("publisher is closed");return this.pcManager.addPublisherTrack($)})}attemptReconnect($){return __awaiter$2(this,void 0,void 0,function*(){var U,F,V;if(!this._isClosed){if(this.attemptingReconnect){livekitLogger$1.warn("already attempting reconnect, returning early",this.logContext);return}(((U=this.clientConfiguration)===null||U===void 0?void 0:U.resumeConnection)===ClientConfigSetting$1.DISABLED||((V=(F=this.pcManager)===null||F===void 0?void 0:F.currentState)!==null&&V!==void 0?V:PCTransportState$1.NEW)===PCTransportState$1.NEW)&&(this.fullReconnectOnNext=!0);try{this.attemptingReconnect=!0,this.fullReconnectOnNext?yield this.restartConnection():yield this.resumeConnection($),this.clearPendingReconnect(),this.fullReconnectOnNext=!1}catch(q){this.reconnectAttempts+=1;let j=!0;q instanceof UnexpectedConnectionState$1?(this.log.debug("received unrecoverable error",Object.assign(Object.assign({},this.logContext),{error:q})),j=!1):q instanceof SignalReconnectError$1||(this.fullReconnectOnNext=!0),j?this.handleDisconnect("reconnect",ReconnectReason$1.RR_UNKNOWN):(this.log.info("could not recover connection after ".concat(this.reconnectAttempts," attempts, ").concat(Date.now()-this.reconnectStart,"ms. giving up"),this.logContext),this.emit(EngineEvent$1.Disconnected),yield this.close())}finally{this.attemptingReconnect=!1}}})}getNextRetryDelay($){try{return this.reconnectPolicy.nextRetryDelayInMs($)}catch(U){this.log.warn("encountered error in reconnect policy",Object.assign(Object.assign({},this.logContext),{error:U}))}return null}restartConnection($){return __awaiter$2(this,void 0,void 0,function*(){var U,F,V;try{if(!this.url||!this.token)throw new UnexpectedConnectionState$1("could not reconnect, url or token not saved");this.log.info("reconnecting, attempt: ".concat(this.reconnectAttempts),this.logContext),this.emit(EngineEvent$1.Restarting),this.client.isDisconnected||(yield this.client.sendLeave()),yield this.cleanupPeerConnections(),yield this.cleanupClient();let q;try{if(!this.signalOpts)throw this.log.warn("attempted connection restart, without signal options present",this.logContext),new SignalReconnectError$1;q=yield this.join($??this.url,this.token,this.signalOpts)}catch(j){throw j instanceof ConnectionError$1&&j.reason===ConnectionErrorReason$1.NotAllowed?new UnexpectedConnectionState$1("could not reconnect, token might be expired"):new SignalReconnectError$1}if(this.shouldFailNext)throw this.shouldFailNext=!1,new Error("simulated failure");if(this.client.setReconnected(),this.emit(EngineEvent$1.SignalRestarted,q),yield this.waitForPCReconnected(),this.client.currentState!==SignalConnectionState$1.CONNECTED)throw new SignalReconnectError$1("Signal connection got severed during reconnect");(U=this.regionUrlProvider)===null||U===void 0||U.resetAttempts(),this.emit(EngineEvent$1.Restarted)}catch(q){const j=yield(F=this.regionUrlProvider)===null||F===void 0?void 0:F.getNextBestRegionUrl();if(j){yield this.restartConnection(j);return}else throw(V=this.regionUrlProvider)===null||V===void 0||V.resetAttempts(),q}})}resumeConnection($){return __awaiter$2(this,void 0,void 0,function*(){var U;if(!this.url||!this.token)throw new UnexpectedConnectionState$1("could not reconnect, url or token not saved");if(!this.pcManager)throw new UnexpectedConnectionState$1("publisher and subscriber connections unset");this.log.info("resuming signal connection, attempt ".concat(this.reconnectAttempts),this.logContext),this.emit(EngineEvent$1.Resuming);let F;try{this.setupSignalClientCallbacks(),F=yield this.client.reconnect(this.url,this.token,this.participantSid,$)}catch(V){let q="";throw V instanceof Error&&(q=V.message,this.log.error(V.message,Object.assign(Object.assign({},this.logContext),{error:V}))),V instanceof ConnectionError$1&&V.reason===ConnectionErrorReason$1.NotAllowed?new UnexpectedConnectionState$1("could not reconnect, token might be expired"):V instanceof ConnectionError$1&&V.reason===ConnectionErrorReason$1.LeaveRequest?V:new SignalReconnectError$1(q)}if(this.emit(EngineEvent$1.SignalResumed),F){const V=this.makeRTCConfiguration(F);this.pcManager.updateConfiguration(V)}else this.log.warn("Did not receive reconnect response",this.logContext);if(this.shouldFailNext)throw this.shouldFailNext=!1,new Error("simulated failure");if(yield this.pcManager.triggerIceRestart(),yield this.waitForPCReconnected(),this.client.currentState!==SignalConnectionState$1.CONNECTED)throw new SignalReconnectError$1("Signal connection got severed during reconnect");this.client.setReconnected(),((U=this.reliableDC)===null||U===void 0?void 0:U.readyState)==="open"&&this.reliableDC.id===null&&this.createDataChannels(),this.emit(EngineEvent$1.Resumed)})}waitForPCInitialConnection($,U){return __awaiter$2(this,void 0,void 0,function*(){if(!this.pcManager)throw new UnexpectedConnectionState$1("PC manager is closed");yield this.pcManager.ensurePCTransportConnection(U,$)})}waitForPCReconnected(){return __awaiter$2(this,void 0,void 0,function*(){this.pcState=PCState$1.Reconnecting,this.log.debug("waiting for peer connection to reconnect",this.logContext);try{if(yield sleep$2(minReconnectWait$1),!this.pcManager)throw new UnexpectedConnectionState$1("PC manager is closed");yield this.pcManager.ensurePCTransportConnection(void 0,this.peerConnectionTimeout),this.pcState=PCState$1.Connected}catch($){throw this.pcState=PCState$1.Disconnected,new ConnectionError$1("could not establish PC connection, ".concat($.message),ConnectionErrorReason$1.InternalError)}})}publishRpcResponse($,U,F,V){return __awaiter$2(this,void 0,void 0,function*(){const q=new DataPacket$1({destinationIdentities:[$],kind:DataPacket_Kind$1.RELIABLE,value:{case:"rpcResponse",value:new RpcResponse$1({requestId:U,value:V?{case:"error",value:V.toProto()}:{case:"payload",value:F??""}})}});yield this.sendDataPacket(q,DataPacket_Kind$1.RELIABLE)})}publishRpcAck($,U){return __awaiter$2(this,void 0,void 0,function*(){const F=new DataPacket$1({destinationIdentities:[$],kind:DataPacket_Kind$1.RELIABLE,value:{case:"rpcAck",value:new RpcAck$1({requestId:U})}});yield this.sendDataPacket(F,DataPacket_Kind$1.RELIABLE)})}sendDataPacket($,U){return __awaiter$2(this,void 0,void 0,function*(){const F=$.toBinary();yield this.ensurePublisherConnected(U);const V=this.dataChannelForKind(U);V&&V.send(F),this.updateAndEmitDCBufferStatus(U)})}waitForBufferStatusLow($){return new Promise((U,F)=>__awaiter$2(this,void 0,void 0,function*(){if(this.isBufferStatusLow($))U();else{const V=()=>F("Engine closed");for(this.once(EngineEvent$1.Closing,V);!this.dcBufferStatus.get($);)yield sleep$2(10);this.off(EngineEvent$1.Closing,V),U()}}))}ensureDataTransportConnected($){return __awaiter$2(this,arguments,void 0,function(U){var F=this;let V=arguments.length>1&&arguments[1]!==void 0?arguments[1]:this.subscriberPrimary;return(function*(){var q;if(!F.pcManager)throw new UnexpectedConnectionState$1("PC manager is closed");const j=V?F.pcManager.subscriber:F.pcManager.publisher,W=V?"Subscriber":"Publisher";if(!j)throw new ConnectionError$1("".concat(W," connection not set"),ConnectionErrorReason$1.InternalError);let K=!1;!V&&!F.dataChannelForKind(U,V)&&(F.createDataChannels(),K=!0),!K&&!V&&!F.pcManager.publisher.isICEConnected&&F.pcManager.publisher.getICEConnectionState()!=="checking"&&(K=!0),K&&F.negotiate();const G=F.dataChannelForKind(U,V);if(G?.readyState==="open")return;const z=new Date().getTime()+F.peerConnectionTimeout;for(;new Date().getTime()<z;){if(j.isICEConnected&&((q=F.dataChannelForKind(U,V))===null||q===void 0?void 0:q.readyState)==="open")return;yield sleep$2(50)}throw new ConnectionError$1("could not establish ".concat(W," connection, state: ").concat(j.getICEConnectionState()),ConnectionErrorReason$1.InternalError)})()})}ensurePublisherConnected($){return __awaiter$2(this,void 0,void 0,function*(){this.publisherConnectionPromise||(this.publisherConnectionPromise=this.ensureDataTransportConnected($,!1)),yield this.publisherConnectionPromise})}verifyTransport(){return!(!this.pcManager||this.pcManager.currentState!==PCTransportState$1.CONNECTED||!this.client.ws||this.client.ws.readyState===WebSocket.CLOSED)}negotiate(){return __awaiter$2(this,void 0,void 0,function*(){return new Promise(($,U)=>__awaiter$2(this,void 0,void 0,function*(){if(!this.pcManager){U(new NegotiationError$1("PC manager is closed"));return}this.pcManager.requirePublisher(),this.pcManager.publisher.getTransceivers().length==0&&!this.lossyDC&&!this.reliableDC&&this.createDataChannels();const F=new AbortController,V=()=>{F.abort(),this.log.debug("engine disconnected while negotiation was ongoing",this.logContext),$()};this.isClosed&&U("cannot negotiate on closed engine"),this.on(EngineEvent$1.Closing,V),this.pcManager.publisher.once(PCEvents$1.RTPVideoPayloadTypes,q=>{const j=new Map;q.forEach(W=>{const K=W.codec.toLowerCase();isVideoCodec$1(K)&&j.set(W.payload,K)}),this.emit(EngineEvent$1.RTPVideoMapUpdate,j)});try{yield this.pcManager.negotiate(F),$()}catch(q){q instanceof NegotiationError$1&&(this.fullReconnectOnNext=!0),this.handleDisconnect("negotiation",ReconnectReason$1.RR_UNKNOWN),U(q)}finally{this.off(EngineEvent$1.Closing,V)}}))})}dataChannelForKind($,U){if(U){if($===DataPacket_Kind$1.LOSSY)return this.lossyDCSub;if($===DataPacket_Kind$1.RELIABLE)return this.reliableDCSub}else{if($===DataPacket_Kind$1.LOSSY)return this.lossyDC;if($===DataPacket_Kind$1.RELIABLE)return this.reliableDC}}sendSyncState($,U){var F,V;if(!this.pcManager){this.log.warn("sync state cannot be sent without peer connection setup",this.logContext);return}const q=this.pcManager.subscriber.getLocalDescription(),j=this.pcManager.subscriber.getRemoteDescription(),W=(V=(F=this.signalOpts)===null||F===void 0?void 0:F.autoSubscribe)!==null&&V!==void 0?V:!0,K=new Array,G=new Array;$.forEach(z=>{z.isDesired!==W&&K.push(z.trackSid),z.isEnabled||G.push(z.trackSid)}),this.client.sendSyncState(new SyncState$1({answer:q?toProtoSessionDescription$1({sdp:q.sdp,type:q.type}):void 0,offer:j?toProtoSessionDescription$1({sdp:j.sdp,type:j.type}):void 0,subscription:new UpdateSubscription$1({trackSids:K,subscribe:!W,participantTracks:[]}),publishTracks:getTrackPublicationInfo$1(U),dataChannels:this.dataChannelsInfo(),trackSidsDisabled:G}))}failNext(){this.shouldFailNext=!0}dataChannelsInfo(){const $=[],U=(F,V)=>{F?.id!==void 0&&F.id!==null&&$.push(new DataChannelInfo$1({label:F.label,id:F.id,target:V}))};return U(this.dataChannelForKind(DataPacket_Kind$1.LOSSY),SignalTarget$1.PUBLISHER),U(this.dataChannelForKind(DataPacket_Kind$1.RELIABLE),SignalTarget$1.PUBLISHER),U(this.dataChannelForKind(DataPacket_Kind$1.LOSSY,!0),SignalTarget$1.SUBSCRIBER),U(this.dataChannelForKind(DataPacket_Kind$1.RELIABLE,!0),SignalTarget$1.SUBSCRIBER),$}clearReconnectTimeout(){this.reconnectTimeout&&CriticalTimers$1.clearTimeout(this.reconnectTimeout)}clearPendingReconnect(){this.clearReconnectTimeout(),this.reconnectAttempts=0}registerOnLineListener(){isWeb$1()&&window.addEventListener("online",this.handleBrowserOnLine)}deregisterOnLineListener(){isWeb$1()&&window.removeEventListener("online",this.handleBrowserOnLine)}},SignalReconnectError$1=class extends Error{};function supportOptionalDatachannel$1(B){return B!==void 0&&B>13}function applyUserDataCompat$1(B,$){const U=B.participantIdentity?B.participantIdentity:$.participantIdentity;B.participantIdentity=U,$.participantIdentity=U;const F=B.destinationIdentities.length!==0?B.destinationIdentities:$.destinationIdentities;B.destinationIdentities=F,$.destinationIdentities=F}let RegionUrlProvider$1=class{constructor($,U){this.lastUpdateAt=0,this.settingsCacheTime=3e3,this.attemptedRegions=[],this.serverUrl=new URL($),this.token=U}updateToken($){this.token=$}isCloud(){return isCloud$1(this.serverUrl)}getServerUrl(){return this.serverUrl}getNextBestRegionUrl($){return __awaiter$2(this,void 0,void 0,function*(){if(!this.isCloud())throw Error("region availability is only supported for LiveKit Cloud domains");(!this.regionSettings||Date.now()-this.lastUpdateAt>this.settingsCacheTime)&&(this.regionSettings=yield this.fetchRegionSettings($));const U=this.regionSettings.regions.filter(F=>!this.attemptedRegions.find(V=>V.url===F.url));if(U.length>0){const F=U[0];return this.attemptedRegions.push(F),livekitLogger$1.debug("next region: ".concat(F.region)),F.url}else return null})}resetAttempts(){this.attemptedRegions=[]}fetchRegionSettings($){return __awaiter$2(this,void 0,void 0,function*(){const U=yield fetch("".concat(getCloudConfigUrl$1(this.serverUrl),"/regions"),{headers:{authorization:"Bearer ".concat(this.token)},signal:$});if(U.ok){const F=yield U.json();return this.lastUpdateAt=Date.now(),F}else throw new ConnectionError$1("Could not fetch region settings: ".concat(U.statusText),U.status===401?ConnectionErrorReason$1.NotAllowed:ConnectionErrorReason$1.InternalError,U.status)})}setServerReportedRegions($){this.regionSettings=$,this.lastUpdateAt=Date.now()}};function getCloudConfigUrl$1(B){return"".concat(B.protocol.replace("ws","http"),"//").concat(B.host,"/settings")}let BaseStreamReader$1=class{get info(){return this._info}constructor($,U,F){this.reader=U,this.totalByteSize=F,this._info=$,this.bytesReceived=0}},ByteStreamReader$1=class extends BaseStreamReader$1{handleChunkReceived($){var U;this.bytesReceived+=$.content.byteLength;const F=this.totalByteSize?this.bytesReceived/this.totalByteSize:void 0;(U=this.onProgress)===null||U===void 0||U.call(this,F)}[Symbol.asyncIterator](){const $=this.reader.getReader();return{next:()=>__awaiter$2(this,void 0,void 0,function*(){try{const{done:U,value:F}=yield $.read();return U?{done:!0,value:void 0}:(this.handleChunkReceived(F),{done:!1,value:F.content})}catch{return{done:!0,value:void 0}}}),return(){return __awaiter$2(this,void 0,void 0,function*(){return $.releaseLock(),{done:!0,value:void 0}})}}}readAll(){return __awaiter$2(this,void 0,void 0,function*(){var $,U,F,V;let q=new Set;try{for(var j=!0,W=__asyncValues$1(this),K;K=yield W.next(),$=K.done,!$;j=!0){V=K.value,j=!1;const G=V;q.add(G)}}catch(G){U={error:G}}finally{try{!j&&!$&&(F=W.return)&&(yield F.call(W))}finally{if(U)throw U.error}}return Array.from(q)})}},TextStreamReader$1=class extends BaseStreamReader$1{constructor($,U,F){super($,U,F),this.receivedChunks=new Map}handleChunkReceived($){var U;const F=bigIntToNumber$1($.chunkIndex),V=this.receivedChunks.get(F);if(V&&V.version>$.version)return;this.receivedChunks.set(F,$),this.bytesReceived+=$.content.byteLength;const q=this.totalByteSize?this.bytesReceived/this.totalByteSize:void 0;(U=this.onProgress)===null||U===void 0||U.call(this,q)}[Symbol.asyncIterator](){const $=this.reader.getReader(),U=new TextDecoder;return{next:()=>__awaiter$2(this,void 0,void 0,function*(){try{const{done:F,value:V}=yield $.read();return F?{done:!0,value:void 0}:(this.handleChunkReceived(V),{done:!1,value:U.decode(V.content)})}catch{return{done:!0,value:void 0}}}),return(){return __awaiter$2(this,void 0,void 0,function*(){return $.releaseLock(),{done:!0,value:void 0}})}}}readAll(){return __awaiter$2(this,void 0,void 0,function*(){var $,U,F,V;let q="";try{for(var j=!0,W=__asyncValues$1(this),K;K=yield W.next(),$=K.done,!$;j=!0)V=K.value,j=!1,q+=V}catch(G){U={error:G}}finally{try{!j&&!$&&(F=W.return)&&(yield F.call(W))}finally{if(U)throw U.error}}return q})}},BaseStreamWriter$1=class{constructor($,U,F){this.writableStream=$,this.defaultWriter=$.getWriter(),this.onClose=F,this.info=U}write($){return this.defaultWriter.write($)}close(){return __awaiter$2(this,void 0,void 0,function*(){var $;yield this.defaultWriter.close(),this.defaultWriter.releaseLock(),($=this.onClose)===null||$===void 0||$.call(this)})}},TextStreamWriter$1=class extends BaseStreamWriter$1{},ByteStreamWriter$1=class extends BaseStreamWriter$1{},RemoteTrack$1=class extends Track$1{constructor($,U,F,V,q){super($,F,q),this.sid=U,this.receiver=V}get isLocal(){return!1}setMuted($){this.isMuted!==$&&(this.isMuted=$,this._mediaStreamTrack.enabled=!$,this.emit($?TrackEvent$1.Muted:TrackEvent$1.Unmuted,this))}setMediaStream($){this.mediaStream=$;const U=F=>{F.track===this._mediaStreamTrack&&($.removeEventListener("removetrack",U),this.receiver&&"playoutDelayHint"in this.receiver&&(this.receiver.playoutDelayHint=void 0),this.receiver=void 0,this._currentBitrate=0,this.emit(TrackEvent$1.Ended,this))};$.addEventListener("removetrack",U)}start(){this.startMonitor(),super.enable()}stop(){this.stopMonitor(),super.disable()}getRTCStatsReport(){return __awaiter$2(this,void 0,void 0,function*(){var $;return!(($=this.receiver)===null||$===void 0)&&$.getStats?yield this.receiver.getStats():void 0})}setPlayoutDelay($){this.receiver?"playoutDelayHint"in this.receiver?this.receiver.playoutDelayHint=$:this.log.warn("Playout delay not supported in this browser"):this.log.warn("Cannot set playout delay, track already ended")}getPlayoutDelay(){if(this.receiver){if("playoutDelayHint"in this.receiver)return this.receiver.playoutDelayHint;this.log.warn("Playout delay not supported in this browser")}else this.log.warn("Cannot get playout delay, track already ended");return 0}startMonitor(){this.monitorInterval||(this.monitorInterval=setInterval(()=>this.monitorReceiver(),monitorFrequency$1)),supportsSynchronizationSources$1()&&this.registerTimeSyncUpdate()}registerTimeSyncUpdate(){const $=()=>{var U;this.timeSyncHandle=requestAnimationFrame(()=>$());const F=(U=this.receiver)===null||U===void 0?void 0:U.getSynchronizationSources()[0];if(F){const{timestamp:V,rtpTimestamp:q}=F;q&&this.rtpTimestamp!==q&&(this.emit(TrackEvent$1.TimeSyncUpdate,{timestamp:V,rtpTimestamp:q}),this.rtpTimestamp=q)}};$()}},RemoteAudioTrack$1=class extends RemoteTrack$1{constructor($,U,F,V,q,j){super($,U,Track$1.Kind.Audio,F,j),this.monitorReceiver=()=>__awaiter$2(this,void 0,void 0,function*(){if(!this.receiver){this._currentBitrate=0;return}const W=yield this.getReceiverStats();W&&this.prevStats&&this.receiver&&(this._currentBitrate=computeBitrate$1(W,this.prevStats)),this.prevStats=W}),this.audioContext=V,this.webAudioPluginNodes=[],q&&(this.sinkId=q.deviceId)}setVolume($){var U;for(const F of this.attachedElements)this.audioContext?(U=this.gainNode)===null||U===void 0||U.gain.setTargetAtTime($,0,.1):F.volume=$;isReactNative$1()&&this._mediaStreamTrack._setVolume($),this.elementVolume=$}getVolume(){if(this.elementVolume)return this.elementVolume;if(isReactNative$1())return 1;let $=0;return this.attachedElements.forEach(U=>{U.volume>$&&($=U.volume)}),$}setSinkId($){return __awaiter$2(this,void 0,void 0,function*(){this.sinkId=$,yield Promise.all(this.attachedElements.map(U=>{if(supportsSetSinkId$1(U))return U.setSinkId($)}))})}attach($){const U=this.attachedElements.length===0;return $?super.attach($):$=super.attach(),this.sinkId&&supportsSetSinkId$1($)&&$.setSinkId(this.sinkId),this.audioContext&&U&&(this.log.debug("using audio context mapping",this.logContext),this.connectWebAudio(this.audioContext,$),$.volume=0,$.muted=!0),this.elementVolume&&this.setVolume(this.elementVolume),$}detach($){let U;return $?(U=super.detach($),this.audioContext&&(this.attachedElements.length>0?this.connectWebAudio(this.audioContext,this.attachedElements[0]):this.disconnectWebAudio())):(U=super.detach(),this.disconnectWebAudio()),U}setAudioContext($){this.audioContext=$,$&&this.attachedElements.length>0?this.connectWebAudio($,this.attachedElements[0]):$||this.disconnectWebAudio()}setWebAudioPlugins($){this.webAudioPluginNodes=$,this.attachedElements.length>0&&this.audioContext&&this.connectWebAudio(this.audioContext,this.attachedElements[0])}connectWebAudio($,U){this.disconnectWebAudio(),this.sourceNode=$.createMediaStreamSource(U.srcObject);let F=this.sourceNode;this.webAudioPluginNodes.forEach(V=>{F.connect(V),F=V}),this.gainNode=$.createGain(),F.connect(this.gainNode),this.gainNode.connect($.destination),this.elementVolume&&this.gainNode.gain.setTargetAtTime(this.elementVolume,0,.1),$.state!=="running"&&$.resume().then(()=>{$.state!=="running"&&this.emit(TrackEvent$1.AudioPlaybackFailed,new Error("Audio Context couldn't be started automatically"))}).catch(V=>{this.emit(TrackEvent$1.AudioPlaybackFailed,V)})}disconnectWebAudio(){var $,U;($=this.gainNode)===null||$===void 0||$.disconnect(),(U=this.sourceNode)===null||U===void 0||U.disconnect(),this.gainNode=void 0,this.sourceNode=void 0}getReceiverStats(){return __awaiter$2(this,void 0,void 0,function*(){if(!this.receiver||!this.receiver.getStats)return;const $=yield this.receiver.getStats();let U;return $.forEach(F=>{F.type==="inbound-rtp"&&(U={type:"audio",streamId:F.id,timestamp:F.timestamp,jitter:F.jitter,bytesReceived:F.bytesReceived,concealedSamples:F.concealedSamples,concealmentEvents:F.concealmentEvents,silentConcealedSamples:F.silentConcealedSamples,silentConcealmentEvents:F.silentConcealmentEvents,totalAudioEnergy:F.totalAudioEnergy,totalSamplesDuration:F.totalSamplesDuration})}),U})}};const REACTION_DELAY$1=100;let RemoteVideoTrack$1=class extends RemoteTrack$1{constructor($,U,F,V,q){super($,U,Track$1.Kind.Video,F,q),this.elementInfos=[],this.monitorReceiver=()=>__awaiter$2(this,void 0,void 0,function*(){if(!this.receiver){this._currentBitrate=0;return}const j=yield this.getReceiverStats();j&&this.prevStats&&this.receiver&&(this._currentBitrate=computeBitrate$1(j,this.prevStats)),this.prevStats=j}),this.debouncedHandleResize=r$2(()=>{this.updateDimensions()},REACTION_DELAY$1),this.adaptiveStreamSettings=V}get isAdaptiveStream(){return this.adaptiveStreamSettings!==void 0}get mediaStreamTrack(){return this._mediaStreamTrack}setMuted($){super.setMuted($),this.attachedElements.forEach(U=>{$?detachTrack$1(this._mediaStreamTrack,U):attachToElement$1(this._mediaStreamTrack,U)})}attach($){if($?super.attach($):$=super.attach(),this.adaptiveStreamSettings&&this.elementInfos.find(U=>U.element===$)===void 0){const U=new HTMLElementInfo$1($);this.observeElementInfo(U)}return $}observeElementInfo($){this.adaptiveStreamSettings&&this.elementInfos.find(U=>U===$)===void 0?($.handleResize=()=>{this.debouncedHandleResize()},$.handleVisibilityChanged=()=>{this.updateVisibility()},this.elementInfos.push($),$.observe(),this.debouncedHandleResize(),this.updateVisibility()):this.log.warn("visibility resize observer not triggered",this.logContext)}stopObservingElementInfo($){if(!this.isAdaptiveStream){this.log.warn("stopObservingElementInfo ignored",this.logContext);return}const U=this.elementInfos.filter(F=>F===$);for(const F of U)F.stopObserving();this.elementInfos=this.elementInfos.filter(F=>F!==$),this.updateVisibility(),this.debouncedHandleResize()}detach($){let U=[];if($)return this.stopObservingElement($),super.detach($);U=super.detach();for(const F of U)this.stopObservingElement(F);return U}getDecoderImplementation(){var $;return($=this.prevStats)===null||$===void 0?void 0:$.decoderImplementation}getReceiverStats(){return __awaiter$2(this,void 0,void 0,function*(){if(!this.receiver||!this.receiver.getStats)return;const $=yield this.receiver.getStats();let U,F="",V=new Map;return $.forEach(q=>{q.type==="inbound-rtp"?(F=q.codecId,U={type:"video",streamId:q.id,framesDecoded:q.framesDecoded,framesDropped:q.framesDropped,framesReceived:q.framesReceived,packetsReceived:q.packetsReceived,packetsLost:q.packetsLost,frameWidth:q.frameWidth,frameHeight:q.frameHeight,pliCount:q.pliCount,firCount:q.firCount,nackCount:q.nackCount,jitter:q.jitter,timestamp:q.timestamp,bytesReceived:q.bytesReceived,decoderImplementation:q.decoderImplementation}):q.type==="codec"&&V.set(q.id,q)}),U&&F!==""&&V.get(F)&&(U.mimeType=V.get(F).mimeType),U})}stopObservingElement($){const U=this.elementInfos.filter(F=>F.element===$);for(const F of U)this.stopObservingElementInfo(F)}handleAppVisibilityChanged(){const $=Object.create(null,{handleAppVisibilityChanged:{get:()=>super.handleAppVisibilityChanged}});return __awaiter$2(this,void 0,void 0,function*(){yield $.handleAppVisibilityChanged.call(this),this.isAdaptiveStream&&this.updateVisibility()})}updateVisibility(){var $,U;const F=this.elementInfos.reduce((W,K)=>Math.max(W,K.visibilityChangedAt||0),0),V=!((U=($=this.adaptiveStreamSettings)===null||$===void 0?void 0:$.pauseVideoInBackground)!==null&&U!==void 0)||U?this.isInBackground:!1,q=this.elementInfos.some(W=>W.pictureInPicture),j=this.elementInfos.some(W=>W.visible)&&!V||q;if(this.lastVisible!==j){if(!j&&Date.now()-F<REACTION_DELAY$1){CriticalTimers$1.setTimeout(()=>{this.updateVisibility()},REACTION_DELAY$1);return}this.lastVisible=j,this.emit(TrackEvent$1.VisibilityChanged,j,this)}}updateDimensions(){var $,U;let F=0,V=0;const q=this.getPixelDensity();for(const j of this.elementInfos){const W=j.width()*q,K=j.height()*q;W+K>F+V&&(F=W,V=K)}(($=this.lastDimensions)===null||$===void 0?void 0:$.width)===F&&((U=this.lastDimensions)===null||U===void 0?void 0:U.height)===V||(this.lastDimensions={width:F,height:V},this.emit(TrackEvent$1.VideoDimensionsChanged,this.lastDimensions,this))}getPixelDensity(){var $;const U=($=this.adaptiveStreamSettings)===null||$===void 0?void 0:$.pixelDensity;return U==="screen"?getDevicePixelRatio$1():U||(getDevicePixelRatio$1()>2?2:1)}},HTMLElementInfo$1=class{get visible(){return this.isPiP||this.isIntersecting}get pictureInPicture(){return this.isPiP}constructor($,U){this.onVisibilityChanged=F=>{var V;const{target:q,isIntersecting:j}=F;q===this.element&&(this.isIntersecting=j,this.isPiP=isElementInPiP$1(this.element),this.visibilityChangedAt=Date.now(),(V=this.handleVisibilityChanged)===null||V===void 0||V.call(this))},this.onEnterPiP=()=>{var F,V,q;(V=(F=window.documentPictureInPicture)===null||F===void 0?void 0:F.window)===null||V===void 0||V.addEventListener("pagehide",this.onLeavePiP),this.isPiP=isElementInPiP$1(this.element),(q=this.handleVisibilityChanged)===null||q===void 0||q.call(this)},this.onLeavePiP=()=>{var F;this.isPiP=isElementInPiP$1(this.element),(F=this.handleVisibilityChanged)===null||F===void 0||F.call(this)},this.element=$,this.isIntersecting=U??isElementInViewport$1($),this.isPiP=isWeb$1()&&isElementInPiP$1($),this.visibilityChangedAt=0}width(){return this.element.clientWidth}height(){return this.element.clientHeight}observe(){var $,U,F;this.isIntersecting=isElementInViewport$1(this.element),this.isPiP=isElementInPiP$1(this.element),this.element.handleResize=()=>{var V;(V=this.handleResize)===null||V===void 0||V.call(this)},this.element.handleVisibilityChanged=this.onVisibilityChanged,getIntersectionObserver$1().observe(this.element),getResizeObserver$1().observe(this.element),this.element.addEventListener("enterpictureinpicture",this.onEnterPiP),this.element.addEventListener("leavepictureinpicture",this.onLeavePiP),($=window.documentPictureInPicture)===null||$===void 0||$.addEventListener("enter",this.onEnterPiP),(F=(U=window.documentPictureInPicture)===null||U===void 0?void 0:U.window)===null||F===void 0||F.addEventListener("pagehide",this.onLeavePiP)}stopObserving(){var $,U,F,V,q;($=getIntersectionObserver$1())===null||$===void 0||$.unobserve(this.element),(U=getResizeObserver$1())===null||U===void 0||U.unobserve(this.element),this.element.removeEventListener("enterpictureinpicture",this.onEnterPiP),this.element.removeEventListener("leavepictureinpicture",this.onLeavePiP),(F=window.documentPictureInPicture)===null||F===void 0||F.removeEventListener("enter",this.onEnterPiP),(q=(V=window.documentPictureInPicture)===null||V===void 0?void 0:V.window)===null||q===void 0||q.removeEventListener("pagehide",this.onLeavePiP)}};function isElementInPiP$1(B){var $,U;return document.pictureInPictureElement===B?!0:!(($=window.documentPictureInPicture)===null||$===void 0)&&$.window?isElementInViewport$1(B,(U=window.documentPictureInPicture)===null||U===void 0?void 0:U.window):!1}function isElementInViewport$1(B,$){const U=$||window;let F=B.offsetTop,V=B.offsetLeft;const q=B.offsetWidth,j=B.offsetHeight,{hidden:W}=B,{display:K}=getComputedStyle(B);for(;B.offsetParent;)B=B.offsetParent,F+=B.offsetTop,V+=B.offsetLeft;return F<U.pageYOffset+U.innerHeight&&V<U.pageXOffset+U.innerWidth&&F+j>U.pageYOffset&&V+q>U.pageXOffset&&!W&&K!=="none"}let TrackPublication$1=class extends eventsExports$1.EventEmitter{constructor($,U,F,V){var q;super(),this.metadataMuted=!1,this.encryption=Encryption_Type$1.NONE,this.log=livekitLogger$1,this.handleMuted=()=>{this.emit(TrackEvent$1.Muted)},this.handleUnmuted=()=>{this.emit(TrackEvent$1.Unmuted)},this.log=getLogger$1((q=V?.loggerName)!==null&&q!==void 0?q:LoggerNames$1.Publication),this.loggerContextCb=this.loggerContextCb,this.setMaxListeners(100),this.kind=$,this.trackSid=U,this.trackName=F,this.source=Track$1.Source.Unknown}setTrack($){this.track&&(this.track.off(TrackEvent$1.Muted,this.handleMuted),this.track.off(TrackEvent$1.Unmuted,this.handleUnmuted)),this.track=$,$&&($.on(TrackEvent$1.Muted,this.handleMuted),$.on(TrackEvent$1.Unmuted,this.handleUnmuted))}get logContext(){var $;return Object.assign(Object.assign({},($=this.loggerContextCb)===null||$===void 0?void 0:$.call(this)),getLogContextFromTrack$1(this))}get isMuted(){return this.metadataMuted}get isEnabled(){return!0}get isSubscribed(){return this.track!==void 0}get isEncrypted(){return this.encryption!==Encryption_Type$1.NONE}get audioTrack(){if(isAudioTrack$1(this.track))return this.track}get videoTrack(){if(isVideoTrack$1(this.track))return this.track}updateInfo($){this.trackSid=$.sid,this.trackName=$.name,this.source=Track$1.sourceFromProto($.source),this.mimeType=$.mimeType,this.kind===Track$1.Kind.Video&&$.width>0&&(this.dimensions={width:$.width,height:$.height},this.simulcasted=$.simulcast),this.encryption=$.encryption,this.trackInfo=$,this.log.debug("update publication info",Object.assign(Object.assign({},this.logContext),{info:$}))}};(function(B){(function($){$.Desired="desired",$.Subscribed="subscribed",$.Unsubscribed="unsubscribed"})(B.SubscriptionStatus||(B.SubscriptionStatus={})),(function($){$.Allowed="allowed",$.NotAllowed="not_allowed"})(B.PermissionStatus||(B.PermissionStatus={}))})(TrackPublication$1||(TrackPublication$1={}));let LocalTrackPublication$1=class extends TrackPublication$1{get isUpstreamPaused(){var $;return($=this.track)===null||$===void 0?void 0:$.isUpstreamPaused}constructor($,U,F,V){super($,U.sid,U.name,V),this.track=void 0,this.handleTrackEnded=()=>{this.emit(TrackEvent$1.Ended)},this.updateInfo(U),this.setTrack(F)}setTrack($){this.track&&this.track.off(TrackEvent$1.Ended,this.handleTrackEnded),super.setTrack($),$&&$.on(TrackEvent$1.Ended,this.handleTrackEnded)}get isMuted(){return this.track?this.track.isMuted:super.isMuted}get audioTrack(){return super.audioTrack}get videoTrack(){return super.videoTrack}get isLocal(){return!0}mute(){return __awaiter$2(this,void 0,void 0,function*(){var $;return($=this.track)===null||$===void 0?void 0:$.mute()})}unmute(){return __awaiter$2(this,void 0,void 0,function*(){var $;return($=this.track)===null||$===void 0?void 0:$.unmute()})}pauseUpstream(){return __awaiter$2(this,void 0,void 0,function*(){var $;yield($=this.track)===null||$===void 0?void 0:$.pauseUpstream()})}resumeUpstream(){return __awaiter$2(this,void 0,void 0,function*(){var $;yield($=this.track)===null||$===void 0?void 0:$.resumeUpstream()})}getTrackFeatures(){var $;if(isAudioTrack$1(this.track)){const U=this.track.getSourceTrackSettings(),F=new Set;return U.autoGainControl&&F.add(AudioTrackFeature$1.TF_AUTO_GAIN_CONTROL),U.echoCancellation&&F.add(AudioTrackFeature$1.TF_ECHO_CANCELLATION),U.noiseSuppression&&F.add(AudioTrackFeature$1.TF_NOISE_SUPPRESSION),U.channelCount&&U.channelCount>1&&F.add(AudioTrackFeature$1.TF_STEREO),!(($=this.options)===null||$===void 0)&&$.dtx||F.add(AudioTrackFeature$1.TF_NO_DTX),this.track.enhancedNoiseCancellation&&F.add(AudioTrackFeature$1.TF_ENHANCED_NOISE_CANCELLATION),Array.from(F.values())}else return[]}};function createLocalTracks$1(B,$){return __awaiter$2(this,void 0,void 0,function*(){B??(B={});let U=!1;const{audioProcessor:F,videoProcessor:V,optionsWithoutProcessor:q}=extractProcessorsFromOptions$1(B);let j=q.audio,W=q.video;if(F&&typeof q.audio=="object"&&(q.audio.processor=F),V&&typeof q.video=="object"&&(q.video.processor=V),B.audio&&typeof q.audio=="object"&&typeof q.audio.deviceId=="string"){const H=q.audio.deviceId;q.audio.deviceId={exact:H},U=!0,j=Object.assign(Object.assign({},q.audio),{deviceId:{ideal:H}})}if(q.video&&typeof q.video=="object"&&typeof q.video.deviceId=="string"){const H=q.video.deviceId;q.video.deviceId={exact:H},U=!0,W=Object.assign(Object.assign({},q.video),{deviceId:{ideal:H}})}(q.audio===!0||typeof q.audio=="object"&&!q.audio.deviceId)&&(q.audio={deviceId:"default"}),(q.video===!0||typeof q.video=="object"&&!q.video.deviceId)&&(q.video={deviceId:"default"});const K=mergeDefaultOptions$1(q,audioDefaults$1,videoDefaults$1),G=constraintsForOptions$1(K),z=navigator.mediaDevices.getUserMedia(G);q.audio&&(DeviceManager$1.userMediaPromiseMap.set("audioinput",z),z.catch(()=>DeviceManager$1.userMediaPromiseMap.delete("audioinput"))),q.video&&(DeviceManager$1.userMediaPromiseMap.set("videoinput",z),z.catch(()=>DeviceManager$1.userMediaPromiseMap.delete("videoinput")));try{const H=yield z;return yield Promise.all(H.getTracks().map(Q=>__awaiter$2(this,void 0,void 0,function*(){const Y=Q.kind==="audio";let X=Y?K.audio:K.video;(typeof X=="boolean"||!X)&&(X={});let Z;const ne=Y?G.audio:G.video;typeof ne!="boolean"&&(Z=ne);const ee=Q.getSettings().deviceId;Z?.deviceId&&unwrapConstraint$1(Z.deviceId)!==ee?Z.deviceId=ee:Z||(Z={deviceId:ee});const ie=mediaTrackToLocalTrack$1(Q,Z,$);return ie.kind===Track$1.Kind.Video?ie.source=Track$1.Source.Camera:ie.kind===Track$1.Kind.Audio&&(ie.source=Track$1.Source.Microphone),ie.mediaStream=H,isAudioTrack$1(ie)&&F?yield ie.setProcessor(F):isVideoTrack$1(ie)&&V&&(yield ie.setProcessor(V)),ie})))}catch(H){if(!U)throw H;return createLocalTracks$1(Object.assign(Object.assign({},B),{audio:j,video:W}),$)}})}function createLocalVideoTrack$1(B){return __awaiter$2(this,void 0,void 0,function*(){return(yield createLocalTracks$1({audio:!1,video:!0}))[0]})}function createLocalAudioTrack$1(B){return __awaiter$2(this,void 0,void 0,function*(){return(yield createLocalTracks$1({audio:B??!0,video:!1}))[0]})}var ConnectionQuality$3;(function(B){B.Excellent="excellent",B.Good="good",B.Poor="poor",B.Lost="lost",B.Unknown="unknown"})(ConnectionQuality$3||(ConnectionQuality$3={}));function qualityFromProto$1(B){switch(B){case ConnectionQuality$1$1.EXCELLENT:return ConnectionQuality$3.Excellent;case ConnectionQuality$1$1.GOOD:return ConnectionQuality$3.Good;case ConnectionQuality$1$1.POOR:return ConnectionQuality$3.Poor;case ConnectionQuality$1$1.LOST:return ConnectionQuality$3.Lost;default:return ConnectionQuality$3.Unknown}}let Participant$1=class extends eventsExports$1.EventEmitter{get logContext(){var $,U;return Object.assign({},(U=($=this.loggerOptions)===null||$===void 0?void 0:$.loggerContextCb)===null||U===void 0?void 0:U.call($))}get isEncrypted(){return this.trackPublications.size>0&&Array.from(this.trackPublications.values()).every($=>$.isEncrypted)}get isAgent(){var $;return(($=this.permissions)===null||$===void 0?void 0:$.agent)||this.kind===ParticipantInfo_Kind$1.AGENT}get kind(){return this._kind}get attributes(){return Object.freeze(Object.assign({},this._attributes))}constructor($,U,F,V,q,j){let W=arguments.length>6&&arguments[6]!==void 0?arguments[6]:ParticipantInfo_Kind$1.STANDARD;var K;super(),this.audioLevel=0,this.isSpeaking=!1,this._connectionQuality=ConnectionQuality$3.Unknown,this.log=livekitLogger$1,this.log=getLogger$1((K=j?.loggerName)!==null&&K!==void 0?K:LoggerNames$1.Participant),this.loggerOptions=j,this.setMaxListeners(100),this.sid=$,this.identity=U,this.name=F,this.metadata=V,this.audioTrackPublications=new Map,this.videoTrackPublications=new Map,this.trackPublications=new Map,this._kind=W,this._attributes=q??{}}getTrackPublications(){return Array.from(this.trackPublications.values())}getTrackPublication($){for(const[,U]of this.trackPublications)if(U.source===$)return U}getTrackPublicationByName($){for(const[,U]of this.trackPublications)if(U.trackName===$)return U}get connectionQuality(){return this._connectionQuality}get isCameraEnabled(){var $;const U=this.getTrackPublication(Track$1.Source.Camera);return!(!(($=U?.isMuted)!==null&&$!==void 0)||$)}get isMicrophoneEnabled(){var $;const U=this.getTrackPublication(Track$1.Source.Microphone);return!(!(($=U?.isMuted)!==null&&$!==void 0)||$)}get isScreenShareEnabled(){return!!this.getTrackPublication(Track$1.Source.ScreenShare)}get isLocal(){return!1}get joinedAt(){return this.participantInfo?new Date(Number.parseInt(this.participantInfo.joinedAt.toString())*1e3):new Date}updateInfo($){return this.participantInfo&&this.participantInfo.sid===$.sid&&this.participantInfo.version>$.version?!1:(this.identity=$.identity,this.sid=$.sid,this._setName($.name),this._setMetadata($.metadata),this._setAttributes($.attributes),$.permission&&this.setPermissions($.permission),this.participantInfo=$,this.log.trace("update participant info",Object.assign(Object.assign({},this.logContext),{info:$})),!0)}_setMetadata($){const U=this.metadata!==$,F=this.metadata;this.metadata=$,U&&this.emit(ParticipantEvent$1.ParticipantMetadataChanged,F)}_setName($){const U=this.name!==$;this.name=$,U&&this.emit(ParticipantEvent$1.ParticipantNameChanged,$)}_setAttributes($){const U=diffAttributes$1(this.attributes,$);this._attributes=$,Object.keys(U).length>0&&this.emit(ParticipantEvent$1.AttributesChanged,U)}setPermissions($){var U,F,V,q,j,W;const K=this.permissions,G=$.canPublish!==((U=this.permissions)===null||U===void 0?void 0:U.canPublish)||$.canSubscribe!==((F=this.permissions)===null||F===void 0?void 0:F.canSubscribe)||$.canPublishData!==((V=this.permissions)===null||V===void 0?void 0:V.canPublishData)||$.hidden!==((q=this.permissions)===null||q===void 0?void 0:q.hidden)||$.recorder!==((j=this.permissions)===null||j===void 0?void 0:j.recorder)||$.canPublishSources.length!==this.permissions.canPublishSources.length||$.canPublishSources.some((z,H)=>{var Q;return z!==((Q=this.permissions)===null||Q===void 0?void 0:Q.canPublishSources[H])})||$.canSubscribeMetrics!==((W=this.permissions)===null||W===void 0?void 0:W.canSubscribeMetrics);return this.permissions=$,G&&this.emit(ParticipantEvent$1.ParticipantPermissionsChanged,K),G}setIsSpeaking($){$!==this.isSpeaking&&(this.isSpeaking=$,$&&(this.lastSpokeAt=new Date),this.emit(ParticipantEvent$1.IsSpeakingChanged,$))}setConnectionQuality($){const U=this._connectionQuality;this._connectionQuality=qualityFromProto$1($),U!==this._connectionQuality&&this.emit(ParticipantEvent$1.ConnectionQualityChanged,this._connectionQuality)}setAudioContext($){this.audioContext=$,this.audioTrackPublications.forEach(U=>isAudioTrack$1(U.track)&&U.track.setAudioContext($))}addTrackPublication($){$.on(TrackEvent$1.Muted,()=>{this.emit(ParticipantEvent$1.TrackMuted,$)}),$.on(TrackEvent$1.Unmuted,()=>{this.emit(ParticipantEvent$1.TrackUnmuted,$)});const U=$;switch(U.track&&(U.track.sid=$.trackSid),this.trackPublications.set($.trackSid,$),$.kind){case Track$1.Kind.Audio:this.audioTrackPublications.set($.trackSid,$);break;case Track$1.Kind.Video:this.videoTrackPublications.set($.trackSid,$);break}}};function trackPermissionToProto$1(B){var $,U,F;if(!B.participantSid&&!B.participantIdentity)throw new Error("Invalid track permission, must provide at least one of participantIdentity and participantSid");return new TrackPermission$1({participantIdentity:($=B.participantIdentity)!==null&&$!==void 0?$:"",participantSid:(U=B.participantSid)!==null&&U!==void 0?U:"",allTracks:(F=B.allowAll)!==null&&F!==void 0?F:!1,trackSids:B.allowedTrackSids||[]})}const STREAM_CHUNK_SIZE$1=15e3;let LocalParticipant$1=class extends Participant$1{constructor($,U,F,V,q){super($,U,void 0,void 0,void 0,{loggerName:V.loggerName,loggerContextCb:()=>this.engine.logContext}),this.pendingPublishing=new Set,this.pendingPublishPromises=new Map,this.participantTrackPermissions=[],this.allParticipantsAllowedToSubscribe=!0,this.encryptionType=Encryption_Type$1.NONE,this.enabledPublishVideoCodecs=[],this.pendingAcks=new Map,this.pendingResponses=new Map,this.handleReconnecting=()=>{this.reconnectFuture||(this.reconnectFuture=new Future$1)},this.handleReconnected=()=>{var j,W;(W=(j=this.reconnectFuture)===null||j===void 0?void 0:j.resolve)===null||W===void 0||W.call(j),this.reconnectFuture=void 0,this.updateTrackSubscriptionPermissions()},this.handleDisconnected=()=>{var j,W;this.reconnectFuture&&(this.reconnectFuture.promise.catch(K=>this.log.warn(K.message,this.logContext)),(W=(j=this.reconnectFuture)===null||j===void 0?void 0:j.reject)===null||W===void 0||W.call(j,"Got disconnected during reconnection attempt"),this.reconnectFuture=void 0)},this.handleSignalRequestResponse=j=>{const{requestId:W,reason:K,message:G}=j,z=this.pendingSignalRequests.get(W);z&&(K!==RequestResponse_Reason$1.OK&&z.reject(new SignalRequestError$1(G,K)),this.pendingSignalRequests.delete(W))},this.handleDataPacket=j=>{switch(j.value.case){case"rpcResponse":let W=j.value.value,K=null,G=null;W.value.case==="payload"?K=W.value.value:W.value.case==="error"&&(G=RpcError$2.fromProto(W.value.value)),this.handleIncomingRpcResponse(W.requestId,K,G);break;case"rpcAck":let z=j.value.value;this.handleIncomingRpcAck(z.requestId);break}},this.updateTrackSubscriptionPermissions=()=>{this.log.debug("updating track subscription permissions",Object.assign(Object.assign({},this.logContext),{allParticipantsAllowed:this.allParticipantsAllowedToSubscribe,participantTrackPermissions:this.participantTrackPermissions})),this.engine.client.sendUpdateSubscriptionPermissions(this.allParticipantsAllowedToSubscribe,this.participantTrackPermissions.map(j=>trackPermissionToProto$1(j)))},this.onTrackUnmuted=j=>{this.onTrackMuted(j,j.isUpstreamPaused)},this.onTrackMuted=(j,W)=>{if(W===void 0&&(W=!0),!j.sid){this.log.error("could not update mute status for unpublished track",Object.assign(Object.assign({},this.logContext),getLogContextFromTrack$1(j)));return}this.engine.updateMuteStatus(j.sid,W)},this.onTrackUpstreamPaused=j=>{this.log.debug("upstream paused",Object.assign(Object.assign({},this.logContext),getLogContextFromTrack$1(j))),this.onTrackMuted(j,!0)},this.onTrackUpstreamResumed=j=>{this.log.debug("upstream resumed",Object.assign(Object.assign({},this.logContext),getLogContextFromTrack$1(j))),this.onTrackMuted(j,j.isMuted)},this.onTrackFeatureUpdate=j=>{const W=this.audioTrackPublications.get(j.sid);if(!W){this.log.warn("Could not update local audio track settings, missing publication for track ".concat(j.sid),this.logContext);return}this.engine.client.sendUpdateLocalAudioTrack(W.trackSid,W.getTrackFeatures())},this.handleSubscribedQualityUpdate=j=>__awaiter$2(this,void 0,void 0,function*(){var W,K,G,z,H,Q;if(!(!((H=this.roomOptions)===null||H===void 0)&&H.dynacast))return;const Y=this.videoTrackPublications.get(j.trackSid);if(!Y){this.log.warn("received subscribed quality update for unknown track",Object.assign(Object.assign({},this.logContext),{trackSid:j.trackSid}));return}if(j.subscribedCodecs.length>0){if(!Y.videoTrack)return;const ee=yield Y.videoTrack.setPublishingCodecs(j.subscribedCodecs);try{for(var X=!0,Z=__asyncValues$1(ee),ne;ne=yield Z.next(),W=ne.done,!W;X=!0){z=ne.value,X=!1;const ie=z;isBackupCodec$1(ie)&&(this.log.debug("publish ".concat(ie," for ").concat(Y.videoTrack.sid),Object.assign(Object.assign({},this.logContext),getLogContextFromTrack$1(Y))),yield this.publishAdditionalCodecForTrack(Y.videoTrack,ie,Y.options))}}catch(ie){K={error:ie}}finally{try{!X&&!W&&(G=Z.return)&&(yield G.call(Z))}finally{if(K)throw K.error}}}else j.subscribedQualities.length>0&&(yield(Q=Y.videoTrack)===null||Q===void 0?void 0:Q.setPublishingLayers(j.subscribedQualities))}),this.handleLocalTrackUnpublished=j=>{const W=this.trackPublications.get(j.trackSid);if(!W){this.log.warn("received unpublished event for unknown track",Object.assign(Object.assign({},this.logContext),{trackSid:j.trackSid}));return}this.unpublishTrack(W.track)},this.handleTrackEnded=j=>__awaiter$2(this,void 0,void 0,function*(){if(j.source===Track$1.Source.ScreenShare||j.source===Track$1.Source.ScreenShareAudio)this.log.debug("unpublishing local track due to TrackEnded",Object.assign(Object.assign({},this.logContext),getLogContextFromTrack$1(j))),this.unpublishTrack(j);else if(j.isUserProvided)yield j.mute();else if(isLocalAudioTrack$1(j)||isLocalVideoTrack$1(j))try{if(isWeb$1())try{const W=yield navigator?.permissions.query({name:j.source===Track$1.Source.Camera?"camera":"microphone"});if(W&&W.state==="denied")throw this.log.warn("user has revoked access to ".concat(j.source),Object.assign(Object.assign({},this.logContext),getLogContextFromTrack$1(j))),W.onchange=()=>{W.state!=="denied"&&(j.isMuted||j.restartTrack(),W.onchange=null)},new Error("GetUserMedia Permission denied")}catch{}j.isMuted||(this.log.debug("track ended, attempting to use a different device",Object.assign(Object.assign({},this.logContext),getLogContextFromTrack$1(j))),isLocalAudioTrack$1(j)?yield j.restartTrack({deviceId:"default"}):yield j.restartTrack())}catch{this.log.warn("could not restart track, muting instead",Object.assign(Object.assign({},this.logContext),getLogContextFromTrack$1(j))),yield j.mute()}}),this.audioTrackPublications=new Map,this.videoTrackPublications=new Map,this.trackPublications=new Map,this.engine=F,this.roomOptions=V,this.setupEngine(F),this.activeDeviceMap=new Map([["audioinput","default"],["videoinput","default"],["audiooutput","default"]]),this.pendingSignalRequests=new Map,this.rpcHandlers=q}get lastCameraError(){return this.cameraError}get lastMicrophoneError(){return this.microphoneError}get isE2EEEnabled(){return this.encryptionType!==Encryption_Type$1.NONE}getTrackPublication($){const U=super.getTrackPublication($);if(U)return U}getTrackPublicationByName($){const U=super.getTrackPublicationByName($);if(U)return U}setupEngine($){this.engine=$,this.engine.on(EngineEvent$1.RemoteMute,(U,F)=>{const V=this.trackPublications.get(U);!V||!V.track||(F?V.mute():V.unmute())}),this.engine.on(EngineEvent$1.Connected,this.handleReconnected).on(EngineEvent$1.SignalRestarted,this.handleReconnected).on(EngineEvent$1.SignalResumed,this.handleReconnected).on(EngineEvent$1.Restarting,this.handleReconnecting).on(EngineEvent$1.Resuming,this.handleReconnecting).on(EngineEvent$1.LocalTrackUnpublished,this.handleLocalTrackUnpublished).on(EngineEvent$1.SubscribedQualityUpdate,this.handleSubscribedQualityUpdate).on(EngineEvent$1.Disconnected,this.handleDisconnected).on(EngineEvent$1.SignalRequestResponse,this.handleSignalRequestResponse).on(EngineEvent$1.DataPacketReceived,this.handleDataPacket)}setMetadata($){return __awaiter$2(this,void 0,void 0,function*(){yield this.requestMetadataUpdate({metadata:$})})}setName($){return __awaiter$2(this,void 0,void 0,function*(){yield this.requestMetadataUpdate({name:$})})}setAttributes($){return __awaiter$2(this,void 0,void 0,function*(){yield this.requestMetadataUpdate({attributes:$})})}requestMetadataUpdate($){return __awaiter$2(this,arguments,void 0,function(U){var F=this;let{metadata:V,name:q,attributes:j}=U;return(function*(){return new Promise((W,K)=>__awaiter$2(F,void 0,void 0,function*(){var G,z;try{let H=!1;const Q=yield this.engine.client.sendUpdateLocalMetadata((G=V??this.metadata)!==null&&G!==void 0?G:"",(z=q??this.name)!==null&&z!==void 0?z:"",j),Y=performance.now();for(this.pendingSignalRequests.set(Q,{resolve:W,reject:X=>{K(X),H=!0},values:{name:q,metadata:V,attributes:j}});performance.now()-Y<5e3&&!H;){if((!q||this.name===q)&&(!V||this.metadata===V)&&(!j||Object.entries(j).every(X=>{let[Z,ne]=X;return this.attributes[Z]===ne||ne===""&&!this.attributes[Z]}))){this.pendingSignalRequests.delete(Q),W();return}yield sleep$2(50)}K(new SignalRequestError$1("Request to update local metadata timed out","TimeoutError"))}catch(H){H instanceof Error&&K(H)}}))})()})}setCameraEnabled($,U,F){return this.setTrackEnabled(Track$1.Source.Camera,$,U,F)}setMicrophoneEnabled($,U,F){return this.setTrackEnabled(Track$1.Source.Microphone,$,U,F)}setScreenShareEnabled($,U,F){return this.setTrackEnabled(Track$1.Source.ScreenShare,$,U,F)}setPermissions($){const U=this.permissions,F=super.setPermissions($);return F&&U&&this.emit(ParticipantEvent$1.ParticipantPermissionsChanged,U),F}setE2EEEnabled($){return __awaiter$2(this,void 0,void 0,function*(){this.encryptionType=$?Encryption_Type$1.GCM:Encryption_Type$1.NONE,yield this.republishAllTracks(void 0,!1)})}setTrackEnabled($,U,F,V){return __awaiter$2(this,void 0,void 0,function*(){var q,j;this.log.debug("setTrackEnabled",Object.assign(Object.assign({},this.logContext),{source:$,enabled:U})),this.republishPromise&&(yield this.republishPromise);let W=this.getTrackPublication($);if(U)if(W)yield W.unmute();else{let K;if(this.pendingPublishing.has($)){const G=yield this.waitForPendingPublicationOfSource($);return G||this.log.info("waiting for pending publication promise timed out",Object.assign(Object.assign({},this.logContext),{source:$})),yield G?.unmute(),G}this.pendingPublishing.add($);try{switch($){case Track$1.Source.Camera:K=yield this.createTracks({video:(q=F)!==null&&q!==void 0?q:!0});break;case Track$1.Source.Microphone:K=yield this.createTracks({audio:(j=F)!==null&&j!==void 0?j:!0});break;case Track$1.Source.ScreenShare:K=yield this.createScreenTracks(Object.assign({},F));break;default:throw new TrackInvalidError$1($)}}catch(G){throw K?.forEach(z=>{z.stop()}),G instanceof Error&&this.emit(ParticipantEvent$1.MediaDevicesError,G),this.pendingPublishing.delete($),G}try{const G=[];for(const H of K)this.log.info("publishing track",Object.assign(Object.assign({},this.logContext),getLogContextFromTrack$1(H))),G.push(this.publishTrack(H,V));[W]=yield Promise.all(G)}catch(G){throw K?.forEach(z=>{z.stop()}),G}finally{this.pendingPublishing.delete($)}}else if(!W?.track&&this.pendingPublishing.has($)&&(W=yield this.waitForPendingPublicationOfSource($),W||this.log.info("waiting for pending publication promise timed out",Object.assign(Object.assign({},this.logContext),{source:$}))),W&&W.track)if($===Track$1.Source.ScreenShare){W=yield this.unpublishTrack(W.track);const K=this.getTrackPublication(Track$1.Source.ScreenShareAudio);K&&K.track&&this.unpublishTrack(K.track)}else yield W.mute();return W})}enableCameraAndMicrophone(){return __awaiter$2(this,void 0,void 0,function*(){if(!(this.pendingPublishing.has(Track$1.Source.Camera)||this.pendingPublishing.has(Track$1.Source.Microphone))){this.pendingPublishing.add(Track$1.Source.Camera),this.pendingPublishing.add(Track$1.Source.Microphone);try{const $=yield this.createTracks({audio:!0,video:!0});yield Promise.all($.map(U=>this.publishTrack(U)))}finally{this.pendingPublishing.delete(Track$1.Source.Camera),this.pendingPublishing.delete(Track$1.Source.Microphone)}}})}createTracks($){return __awaiter$2(this,void 0,void 0,function*(){var U,F;$??($={});const V=mergeDefaultOptions$1($,(U=this.roomOptions)===null||U===void 0?void 0:U.audioCaptureDefaults,(F=this.roomOptions)===null||F===void 0?void 0:F.videoCaptureDefaults);try{return(yield createLocalTracks$1(V,{loggerName:this.roomOptions.loggerName,loggerContextCb:()=>this.logContext})).map(W=>(isAudioTrack$1(W)&&(this.microphoneError=void 0,W.setAudioContext(this.audioContext),W.source=Track$1.Source.Microphone,this.emit(ParticipantEvent$1.AudioStreamAcquired)),isVideoTrack$1(W)&&(this.cameraError=void 0,W.source=Track$1.Source.Camera),W))}catch(q){throw q instanceof Error&&($.audio&&(this.microphoneError=q),$.video&&(this.cameraError=q)),q}})}createScreenTracks($){return __awaiter$2(this,void 0,void 0,function*(){if($===void 0&&($={}),navigator.mediaDevices.getDisplayMedia===void 0)throw new DeviceUnsupportedError$1("getDisplayMedia not supported");$.resolution===void 0&&!isSafari17()&&($.resolution=ScreenSharePresets$1.h1080fps30.resolution);const U=screenCaptureToDisplayMediaStreamOptions$1($),F=yield navigator.mediaDevices.getDisplayMedia(U),V=F.getVideoTracks();if(V.length===0)throw new TrackInvalidError$1("no video track found");const q=new LocalVideoTrack$1(V[0],void 0,!1,{loggerName:this.roomOptions.loggerName,loggerContextCb:()=>this.logContext});q.source=Track$1.Source.ScreenShare,$.contentHint&&(q.mediaStreamTrack.contentHint=$.contentHint);const j=[q];if(F.getAudioTracks().length>0){this.emit(ParticipantEvent$1.AudioStreamAcquired);const W=new LocalAudioTrack$1(F.getAudioTracks()[0],void 0,!1,this.audioContext,{loggerName:this.roomOptions.loggerName,loggerContextCb:()=>this.logContext});W.source=Track$1.Source.ScreenShareAudio,j.push(W)}return j})}publishTrack($,U){return __awaiter$2(this,void 0,void 0,function*(){return this.publishOrRepublishTrack($,U)})}publishOrRepublishTrack($,U){return __awaiter$2(this,arguments,void 0,function(F,V){var q=this;let j=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1;return(function*(){var W,K,G,z;isLocalAudioTrack$1(F)&&F.setAudioContext(q.audioContext),yield(W=q.reconnectFuture)===null||W===void 0?void 0:W.promise,q.republishPromise&&!j&&(yield q.republishPromise),isLocalTrack$1(F)&&q.pendingPublishPromises.has(F)&&(yield q.pendingPublishPromises.get(F));let H;if(F instanceof MediaStreamTrack)H=F.getConstraints();else{H=F.constraints;let ee;switch(F.source){case Track$1.Source.Microphone:ee="audioinput";break;case Track$1.Source.Camera:ee="videoinput"}ee&&q.activeDeviceMap.has(ee)&&(H=Object.assign(Object.assign({},H),{deviceId:q.activeDeviceMap.get(ee)}))}if(F instanceof MediaStreamTrack)switch(F.kind){case"audio":F=new LocalAudioTrack$1(F,H,!0,q.audioContext,{loggerName:q.roomOptions.loggerName,loggerContextCb:()=>q.logContext});break;case"video":F=new LocalVideoTrack$1(F,H,!0,{loggerName:q.roomOptions.loggerName,loggerContextCb:()=>q.logContext});break;default:throw new TrackInvalidError$1("unsupported MediaStreamTrack kind ".concat(F.kind))}else F.updateLoggerOptions({loggerName:q.roomOptions.loggerName,loggerContextCb:()=>q.logContext});let Q;if(q.trackPublications.forEach(ee=>{ee.track&&ee.track===F&&(Q=ee)}),Q)return q.log.warn("track has already been published, skipping",Object.assign(Object.assign({},q.logContext),getLogContextFromTrack$1(Q))),Q;const Y="channelCount"in F.mediaStreamTrack.getSettings()&&F.mediaStreamTrack.getSettings().channelCount===2||F.mediaStreamTrack.getConstraints().channelCount===2,X=(K=V?.forceStereo)!==null&&K!==void 0?K:Y;X&&(V||(V={}),V.dtx===void 0&&q.log.info("Opus DTX will be disabled for stereo tracks by default. Enable them explicitly to make it work.",Object.assign(Object.assign({},q.logContext),getLogContextFromTrack$1(F))),V.red===void 0&&q.log.info("Opus RED will be disabled for stereo tracks by default. Enable them explicitly to make it work."),(G=V.dtx)!==null&&G!==void 0||(V.dtx=!1),(z=V.red)!==null&&z!==void 0||(V.red=!1));const Z=Object.assign(Object.assign({},q.roomOptions.publishDefaults),V);!isE2EESimulcastSupported$1()&&q.roomOptions.e2ee&&(q.log.info("End-to-end encryption is set up, simulcast publishing will be disabled on Safari versions and iOS browsers running iOS < v17.2",Object.assign({},q.logContext)),Z.simulcast=!1),Z.source&&(F.source=Z.source);const ne=new Promise((ee,ie)=>__awaiter$2(q,void 0,void 0,function*(){try{if(this.engine.client.currentState!==SignalConnectionState$1.CONNECTED){this.log.debug("deferring track publication until signal is connected",Object.assign(Object.assign({},this.logContext),{track:getLogContextFromTrack$1(F)}));const se=()=>__awaiter$2(this,void 0,void 0,function*(){try{const te=yield this.publish(F,Z,X);ee(te)}catch(te){ie(te)}});setTimeout(()=>{this.engine.off(EngineEvent$1.SignalConnected,se),ie(new PublishTrackError$1("publishing rejected as engine not connected within timeout",408))},15e3),this.engine.once(EngineEvent$1.SignalConnected,se),this.engine.on(EngineEvent$1.Closing,()=>{this.engine.off(EngineEvent$1.SignalConnected,se),ie(new PublishTrackError$1("publishing rejected as engine closed",499))})}else try{const se=yield this.publish(F,Z,X);ee(se)}catch(se){ie(se)}}catch(se){ie(se)}}));q.pendingPublishPromises.set(F,ne);try{return yield ne}catch(ee){throw ee}finally{q.pendingPublishPromises.delete(F)}})()})}hasPermissionsToPublish($){if(!this.permissions)return this.log.warn("no permissions present for publishing track",Object.assign(Object.assign({},this.logContext),getLogContextFromTrack$1($))),!1;const{canPublish:U,canPublishSources:F}=this.permissions;return U&&(F.length===0||F.map(V=>getTrackSourceFromProto$1(V)).includes($.source))?!0:(this.log.warn("insufficient permissions to publish",Object.assign(Object.assign({},this.logContext),getLogContextFromTrack$1($))),!1)}publish($,U,F){return __awaiter$2(this,void 0,void 0,function*(){var V,q,j,W,K,G,z,H,Q,Y;if(!this.hasPermissionsToPublish($))throw new PublishTrackError$1("failed to publish track, insufficient permissions",403);Array.from(this.trackPublications.values()).find(re=>isLocalTrack$1($)&&re.source===$.source)&&$.source!==Track$1.Source.Unknown&&this.log.info("publishing a second track with the same source: ".concat($.source),Object.assign(Object.assign({},this.logContext),getLogContextFromTrack$1($))),U.stopMicTrackOnMute&&isAudioTrack$1($)&&($.stopOnMute=!0),$.source===Track$1.Source.ScreenShare&&isFireFox$1()&&(U.simulcast=!1),U.videoCodec==="av1"&&!supportsAV1$1()&&(U.videoCodec=void 0),U.videoCodec==="vp9"&&!supportsVP9$1()&&(U.videoCodec=void 0),U.videoCodec===void 0&&(U.videoCodec=defaultVideoCodec$1),this.enabledPublishVideoCodecs.length>0&&(this.enabledPublishVideoCodecs.some(re=>U.videoCodec===mimeTypeToVideoCodecString$1(re.mime))||(U.videoCodec=mimeTypeToVideoCodecString$1(this.enabledPublishVideoCodecs[0].mime)));const Z=U.videoCodec;$.on(TrackEvent$1.Muted,this.onTrackMuted),$.on(TrackEvent$1.Unmuted,this.onTrackUnmuted),$.on(TrackEvent$1.Ended,this.handleTrackEnded),$.on(TrackEvent$1.UpstreamPaused,this.onTrackUpstreamPaused),$.on(TrackEvent$1.UpstreamResumed,this.onTrackUpstreamResumed),$.on(TrackEvent$1.AudioTrackFeatureUpdate,this.onTrackFeatureUpdate);const ne=new AddTrackRequest$1({cid:$.mediaStreamTrack.id,name:U.name,type:Track$1.kindToProto($.kind),muted:$.isMuted,source:Track$1.sourceToProto($.source),disableDtx:!(!((V=U.dtx)!==null&&V!==void 0)||V),encryption:this.encryptionType,stereo:F,disableRed:this.isE2EEEnabled||!(!((q=U.red)!==null&&q!==void 0)||q),stream:U?.stream,backupCodecPolicy:U?.backupCodecPolicy});let ee;if($.kind===Track$1.Kind.Video){let re={width:0,height:0};try{re=yield $.waitForDimensions()}catch{const ce=(W=(j=this.roomOptions.videoCaptureDefaults)===null||j===void 0?void 0:j.resolution)!==null&&W!==void 0?W:VideoPresets$1.h720.resolution;re={width:ce.width,height:ce.height},this.log.error("could not determine track dimensions, using defaults",Object.assign(Object.assign(Object.assign({},this.logContext),getLogContextFromTrack$1($)),{dims:re}))}ne.width=re.width,ne.height=re.height,isLocalVideoTrack$1($)&&(isSVCCodec$1(Z)&&($.source===Track$1.Source.ScreenShare&&(U.scalabilityMode="L1T3","contentHint"in $.mediaStreamTrack&&($.mediaStreamTrack.contentHint="motion",this.log.info("forcing contentHint to motion for screenshare with SVC codecs",Object.assign(Object.assign({},this.logContext),getLogContextFromTrack$1($))))),U.scalabilityMode=(K=U.scalabilityMode)!==null&&K!==void 0?K:"L3T3_KEY"),ne.simulcastCodecs=[new SimulcastCodec$1({codec:Z,cid:$.mediaStreamTrack.id})],U.backupCodec===!0&&(U.backupCodec={codec:defaultVideoCodec$1}),U.backupCodec&&Z!==U.backupCodec.codec&&ne.encryption===Encryption_Type$1.NONE&&(this.roomOptions.dynacast||(this.roomOptions.dynacast=!0),ne.simulcastCodecs.push(new SimulcastCodec$1({codec:U.backupCodec.codec,cid:""})))),ee=computeVideoEncodings$1($.source===Track$1.Source.ScreenShare,ne.width,ne.height,U),ne.layers=videoLayersFromEncodings$1(ne.width,ne.height,ee,isSVCCodec$1(U.videoCodec))}else $.kind===Track$1.Kind.Audio&&(ee=[{maxBitrate:(G=U.audioPreset)===null||G===void 0?void 0:G.maxBitrate,priority:(H=(z=U.audioPreset)===null||z===void 0?void 0:z.priority)!==null&&H!==void 0?H:"high",networkPriority:(Y=(Q=U.audioPreset)===null||Q===void 0?void 0:Q.priority)!==null&&Y!==void 0?Y:"high"}]);if(!this.engine||this.engine.isClosed)throw new UnexpectedConnectionState$1("cannot publish track when not connected");const ie=()=>__awaiter$2(this,void 0,void 0,function*(){var re,ae,ce;if(!this.engine.pcManager)throw new UnexpectedConnectionState$1("pcManager is not ready");if($.sender=yield this.engine.createSender($,U,ee),isLocalVideoTrack$1($)&&((re=U.degradationPreference)!==null&&re!==void 0||(U.degradationPreference=getDefaultDegradationPreference$1($)),$.setDegradationPreference(U.degradationPreference)),ee)if(isFireFox$1()&&$.kind===Track$1.Kind.Audio){let le;for(const de of this.engine.pcManager.publisher.getTransceivers())if(de.sender===$.sender){le=de;break}le&&this.engine.pcManager.publisher.setTrackCodecBitrate({transceiver:le,codec:"opus",maxbr:!((ae=ee[0])===null||ae===void 0)&&ae.maxBitrate?ee[0].maxBitrate/1e3:0})}else $.codec&&isSVCCodec$1($.codec)&&(!((ce=ee[0])===null||ce===void 0)&&ce.maxBitrate)&&this.engine.pcManager.publisher.setTrackCodecBitrate({cid:ne.cid,codec:$.codec,maxbr:ee[0].maxBitrate/1e3});yield this.engine.negotiate()});let se;if(this.enabledPublishVideoCodecs.length>0)se=(yield Promise.all([this.engine.addTrack(ne),ie()]))[0];else{se=yield this.engine.addTrack(ne);let re;if(se.codecs.forEach(ae=>{re===void 0&&(re=ae.mimeType)}),re&&$.kind===Track$1.Kind.Video){const ae=mimeTypeToVideoCodecString$1(re);ae!==Z&&(this.log.debug("falling back to server selected codec",Object.assign(Object.assign(Object.assign({},this.logContext),getLogContextFromTrack$1($)),{codec:ae})),U.videoCodec=ae,ee=computeVideoEncodings$1($.source===Track$1.Source.ScreenShare,ne.width,ne.height,U))}yield ie()}const te=new LocalTrackPublication$1($.kind,se,$,{loggerName:this.roomOptions.loggerName,loggerContextCb:()=>this.logContext});return te.options=U,$.sid=se.sid,this.log.debug("publishing ".concat($.kind," with encodings"),Object.assign(Object.assign({},this.logContext),{encodings:ee,trackInfo:se})),isLocalVideoTrack$1($)?$.startMonitor(this.engine.client):isLocalAudioTrack$1($)&&$.startMonitor(),this.addTrackPublication(te),this.emit(ParticipantEvent$1.LocalTrackPublished,te),te})}get isLocal(){return!0}publishAdditionalCodecForTrack($,U,F){return __awaiter$2(this,void 0,void 0,function*(){var V;if(this.encryptionType!==Encryption_Type$1.NONE)return;let q;if(this.trackPublications.forEach(Y=>{Y.track&&Y.track===$&&(q=Y)}),!q)throw new TrackInvalidError$1("track is not published");if(!isLocalVideoTrack$1($))throw new TrackInvalidError$1("track is not a video track");const j=Object.assign(Object.assign({},(V=this.roomOptions)===null||V===void 0?void 0:V.publishDefaults),F),W=computeTrackBackupEncodings$1($,U,j);if(!W){this.log.info("backup codec has been disabled, ignoring request to add additional codec for track",Object.assign(Object.assign({},this.logContext),getLogContextFromTrack$1($)));return}const K=$.addSimulcastTrack(U,W);if(!K)return;const G=new AddTrackRequest$1({cid:K.mediaStreamTrack.id,type:Track$1.kindToProto($.kind),muted:$.isMuted,source:Track$1.sourceToProto($.source),sid:$.sid,simulcastCodecs:[{codec:j.videoCodec,cid:K.mediaStreamTrack.id}]});if(G.layers=videoLayersFromEncodings$1(G.width,G.height,W),!this.engine||this.engine.isClosed)throw new UnexpectedConnectionState$1("cannot publish track when not connected");const z=()=>__awaiter$2(this,void 0,void 0,function*(){yield this.engine.createSimulcastSender($,K,j,W),yield this.engine.negotiate()}),Q=(yield Promise.all([this.engine.addTrack(G),z()]))[0];this.log.debug("published ".concat(U," for track ").concat($.sid),Object.assign(Object.assign({},this.logContext),{encodings:W,trackInfo:Q}))})}unpublishTrack($,U){return __awaiter$2(this,void 0,void 0,function*(){var F,V;if(isLocalTrack$1($)){const G=this.pendingPublishPromises.get($);G&&(this.log.info("awaiting publish promise before attempting to unpublish",Object.assign(Object.assign({},this.logContext),getLogContextFromTrack$1($))),yield G)}const q=this.getPublicationForTrack($),j=q?getLogContextFromTrack$1(q):void 0;if(this.log.debug("unpublishing track",Object.assign(Object.assign({},this.logContext),j)),!q||!q.track){this.log.warn("track was not unpublished because no publication was found",Object.assign(Object.assign({},this.logContext),j));return}$=q.track,$.off(TrackEvent$1.Muted,this.onTrackMuted),$.off(TrackEvent$1.Unmuted,this.onTrackUnmuted),$.off(TrackEvent$1.Ended,this.handleTrackEnded),$.off(TrackEvent$1.UpstreamPaused,this.onTrackUpstreamPaused),$.off(TrackEvent$1.UpstreamResumed,this.onTrackUpstreamResumed),$.off(TrackEvent$1.AudioTrackFeatureUpdate,this.onTrackFeatureUpdate),U===void 0&&(U=(V=(F=this.roomOptions)===null||F===void 0?void 0:F.stopLocalTrackOnUnpublish)!==null&&V!==void 0?V:!0),U?$.stop():$.stopMonitor();let W=!1;const K=$.sender;if($.sender=void 0,this.engine.pcManager&&this.engine.pcManager.currentState<PCTransportState$1.FAILED&&K)try{for(const G of this.engine.pcManager.publisher.getTransceivers())G.sender===K&&(G.direction="inactive",W=!0);if(this.engine.removeTrack(K)&&(W=!0),isLocalVideoTrack$1($)){for(const[,G]of $.simulcastCodecs)G.sender&&(this.engine.removeTrack(G.sender)&&(W=!0),G.sender=void 0);$.simulcastCodecs.clear()}}catch(G){this.log.warn("failed to unpublish track",Object.assign(Object.assign(Object.assign({},this.logContext),j),{error:G}))}switch(this.trackPublications.delete(q.trackSid),q.kind){case Track$1.Kind.Audio:this.audioTrackPublications.delete(q.trackSid);break;case Track$1.Kind.Video:this.videoTrackPublications.delete(q.trackSid);break}return this.emit(ParticipantEvent$1.LocalTrackUnpublished,q),q.setTrack(void 0),W&&(yield this.engine.negotiate()),q})}unpublishTracks($){return __awaiter$2(this,void 0,void 0,function*(){return(yield Promise.all($.map(F=>this.unpublishTrack(F)))).filter(F=>!!F)})}republishAllTracks($){return __awaiter$2(this,arguments,void 0,function(U){var F=this;let V=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0;return(function*(){F.republishPromise&&(yield F.republishPromise),F.republishPromise=new Promise((q,j)=>__awaiter$2(F,void 0,void 0,function*(){try{const W=[];this.trackPublications.forEach(K=>{K.track&&(U&&(K.options=Object.assign(Object.assign({},K.options),U)),W.push(K))}),yield Promise.all(W.map(K=>__awaiter$2(this,void 0,void 0,function*(){const G=K.track;yield this.unpublishTrack(G,!1),V&&!G.isMuted&&G.source!==Track$1.Source.ScreenShare&&G.source!==Track$1.Source.ScreenShareAudio&&(isLocalAudioTrack$1(G)||isLocalVideoTrack$1(G))&&!G.isUserProvided&&(this.log.debug("restarting existing track",Object.assign(Object.assign({},this.logContext),{track:K.trackSid})),yield G.restartTrack()),yield this.publishOrRepublishTrack(G,K.options,!0)}))),q()}catch(W){j(W)}finally{this.republishPromise=void 0}})),yield F.republishPromise})()})}publishData($){return __awaiter$2(this,arguments,void 0,function(U){var F=this;let V=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};return(function*(){const q=V.reliable?DataPacket_Kind$1.RELIABLE:DataPacket_Kind$1.LOSSY,j=V.destinationIdentities,W=V.topic,K=new DataPacket$1({kind:q,value:{case:"user",value:new UserPacket$1({participantIdentity:F.identity,payload:U,destinationIdentities:j,topic:W})}});yield F.engine.sendDataPacket(K,q)})()})}publishDtmf($,U){return __awaiter$2(this,void 0,void 0,function*(){const F=new DataPacket$1({kind:DataPacket_Kind$1.RELIABLE,value:{case:"sipDtmf",value:new SipDTMF$1({code:$,digit:U})}});yield this.engine.sendDataPacket(F,DataPacket_Kind$1.RELIABLE)})}sendChatMessage($,U){return __awaiter$2(this,void 0,void 0,function*(){const F={id:crypto.randomUUID(),message:$,timestamp:Date.now(),attachedFiles:U?.attachments},V=new DataPacket$1({value:{case:"chatMessage",value:new ChatMessage$1(Object.assign(Object.assign({},F),{timestamp:protoInt64$1.parse(F.timestamp)}))}});return yield this.engine.sendDataPacket(V,DataPacket_Kind$1.RELIABLE),this.emit(ParticipantEvent$1.ChatMessage,F),F})}editChatMessage($,U){return __awaiter$2(this,void 0,void 0,function*(){const F=Object.assign(Object.assign({},U),{message:$,editTimestamp:Date.now()}),V=new DataPacket$1({value:{case:"chatMessage",value:new ChatMessage$1(Object.assign(Object.assign({},F),{timestamp:protoInt64$1.parse(F.timestamp),editTimestamp:protoInt64$1.parse(F.editTimestamp)}))}});return yield this.engine.sendDataPacket(V,DataPacket_Kind$1.RELIABLE),this.emit(ParticipantEvent$1.ChatMessage,F),F})}sendText($,U){return __awaiter$2(this,void 0,void 0,function*(){var F;const V=crypto.randomUUID(),j=new TextEncoder().encode($).byteLength,W=(F=U?.attachments)===null||F===void 0?void 0:F.map(()=>crypto.randomUUID()),K=new Array(W?W.length+1:1).fill(0),G=(H,Q)=>{var Y;K[Q]=H;const X=K.reduce((Z,ne)=>Z+ne,0);(Y=U?.onProgress)===null||Y===void 0||Y.call(U,X)},z=yield this.streamText({streamId:V,totalSize:j,destinationIdentities:U?.destinationIdentities,topic:U?.topic,attachedStreamIds:W,attributes:U?.attributes});return yield z.write($),G(1,0),yield z.close(),U?.attachments&&W&&(yield Promise.all(U.attachments.map((H,Q)=>__awaiter$2(this,void 0,void 0,function*(){return this._sendFile(W[Q],H,{topic:U.topic,mimeType:H.type,onProgress:Y=>{G(Y,Q+1)}})})))),z.info})}streamText($){return __awaiter$2(this,void 0,void 0,function*(){var U,F;const V=(U=$?.streamId)!==null&&U!==void 0?U:crypto.randomUUID(),q={id:V,mimeType:"text/plain",timestamp:Date.now(),topic:(F=$?.topic)!==null&&F!==void 0?F:"",size:$?.totalSize,attributes:$?.attributes},j=new DataStream_Header$1({streamId:V,mimeType:q.mimeType,topic:q.topic,timestamp:numberToBigInt$1(q.timestamp),totalLength:numberToBigInt$1($?.totalSize),attributes:q.attributes,contentHeader:{case:"textHeader",value:new DataStream_TextHeader$1({version:$?.version,attachedStreamIds:$?.attachedStreamIds,replyToStreamId:$?.replyToStreamId,operationType:$?.type==="update"?DataStream_OperationType$1.UPDATE:DataStream_OperationType$1.CREATE})}}),W=$?.destinationIdentities,K=new DataPacket$1({destinationIdentities:W,value:{case:"streamHeader",value:j}});yield this.engine.sendDataPacket(K,DataPacket_Kind$1.RELIABLE);let G=0;const z=this,H=new WritableStream({write(X){return __awaiter$2(this,void 0,void 0,function*(){for(const Z of splitUtf8$1(X,STREAM_CHUNK_SIZE$1)){yield z.engine.waitForBufferStatusLow(DataPacket_Kind$1.RELIABLE);const ne=new DataStream_Chunk$1({content:Z,streamId:V,chunkIndex:numberToBigInt$1(G)}),ee=new DataPacket$1({destinationIdentities:W,value:{case:"streamChunk",value:ne}});yield z.engine.sendDataPacket(ee,DataPacket_Kind$1.RELIABLE),G+=1}})},close(){return __awaiter$2(this,void 0,void 0,function*(){const X=new DataStream_Trailer$1({streamId:V}),Z=new DataPacket$1({destinationIdentities:W,value:{case:"streamTrailer",value:X}});yield z.engine.sendDataPacket(Z,DataPacket_Kind$1.RELIABLE)})},abort(X){console.log("Sink error:",X)}});let Q=()=>__awaiter$2(this,void 0,void 0,function*(){yield Y.close()});z.engine.once(EngineEvent$1.Closing,Q);const Y=new TextStreamWriter$1(H,q,()=>this.engine.off(EngineEvent$1.Closing,Q));return Y})}sendFile($,U){return __awaiter$2(this,void 0,void 0,function*(){const F=crypto.randomUUID();return yield this._sendFile(F,$,U),{id:F}})}_sendFile($,U,F){return __awaiter$2(this,void 0,void 0,function*(){var V;const q=yield this.streamBytes({streamId:$,totalSize:U.size,name:U.name,mimeType:(V=F?.mimeType)!==null&&V!==void 0?V:U.type,topic:F?.topic,destinationIdentities:F?.destinationIdentities}),j=U.stream().getReader();for(;;){const{done:W,value:K}=yield j.read();if(W)break;yield q.write(K)}return yield q.close(),q.info})}streamBytes($){return __awaiter$2(this,void 0,void 0,function*(){var U,F,V,q,j;const W=(U=$?.streamId)!==null&&U!==void 0?U:crypto.randomUUID(),K=$?.destinationIdentities,G={id:W,mimeType:(F=$?.mimeType)!==null&&F!==void 0?F:"application/octet-stream",topic:(V=$?.topic)!==null&&V!==void 0?V:"",timestamp:Date.now(),attributes:$?.attributes,size:$?.totalSize,name:(q=$?.name)!==null&&q!==void 0?q:"unknown"},z=new DataStream_Header$1({totalLength:numberToBigInt$1((j=G.size)!==null&&j!==void 0?j:0),mimeType:G.mimeType,streamId:W,topic:G.topic,timestamp:numberToBigInt$1(Date.now()),contentHeader:{case:"byteHeader",value:new DataStream_ByteHeader$1({name:G.name})}}),H=new DataPacket$1({destinationIdentities:K,value:{case:"streamHeader",value:z}});yield this.engine.sendDataPacket(H,DataPacket_Kind$1.RELIABLE);let Q=0;const Y=new _$2,X=this.engine,Z=this.log,ne=new WritableStream({write(ie){return __awaiter$2(this,void 0,void 0,function*(){const se=yield Y.lock();let te=0;try{for(;te<ie.byteLength;){const re=ie.slice(te,te+STREAM_CHUNK_SIZE$1);yield X.waitForBufferStatusLow(DataPacket_Kind$1.RELIABLE);const ae=new DataPacket$1({destinationIdentities:K,value:{case:"streamChunk",value:new DataStream_Chunk$1({content:re,streamId:W,chunkIndex:numberToBigInt$1(Q)})}});yield X.sendDataPacket(ae,DataPacket_Kind$1.RELIABLE),Q+=1,te+=re.byteLength}}finally{se()}})},close(){return __awaiter$2(this,void 0,void 0,function*(){const ie=new DataStream_Trailer$1({streamId:W}),se=new DataPacket$1({destinationIdentities:K,value:{case:"streamTrailer",value:ie}});yield X.sendDataPacket(se,DataPacket_Kind$1.RELIABLE)})},abort(ie){Z.error("Sink error:",ie)}});return new ByteStreamWriter$1(ne,G)})}performRpc($){return __awaiter$2(this,arguments,void 0,function(U){var F=this;let{destinationIdentity:V,method:q,payload:j,responseTimeout:W=1e4}=U;return(function*(){return new Promise((G,z)=>__awaiter$2(F,void 0,void 0,function*(){var H,Q,Y,X;if(byteLength$1(j)>MAX_PAYLOAD_BYTES$1){z(RpcError$2.builtIn("REQUEST_PAYLOAD_TOO_LARGE"));return}if(!((Q=(H=this.engine.latestJoinResponse)===null||H===void 0?void 0:H.serverInfo)===null||Q===void 0)&&Q.version&&compareVersions$1((X=(Y=this.engine.latestJoinResponse)===null||Y===void 0?void 0:Y.serverInfo)===null||X===void 0?void 0:X.version,"1.8.0")<0){z(RpcError$2.builtIn("UNSUPPORTED_SERVER"));return}const Z=crypto.randomUUID();yield this.publishRpcRequest(V,Z,q,j,W-2e3);const ne=setTimeout(()=>{this.pendingAcks.delete(Z),z(RpcError$2.builtIn("CONNECTION_TIMEOUT")),this.pendingResponses.delete(Z),clearTimeout(ee)},2e3);this.pendingAcks.set(Z,{resolve:()=>{clearTimeout(ne)},participantIdentity:V});const ee=setTimeout(()=>{this.pendingResponses.delete(Z),z(RpcError$2.builtIn("RESPONSE_TIMEOUT"))},W);this.pendingResponses.set(Z,{resolve:(ie,se)=>{clearTimeout(ee),this.pendingAcks.has(Z)&&(console.warn("RPC response received before ack",Z),this.pendingAcks.delete(Z),clearTimeout(ne)),se?z(se):G(ie??"")},participantIdentity:V})}))})()})}registerRpcMethod($,U){this.rpcHandlers.has($)&&this.log.warn("you're overriding the RPC handler for method ".concat($,", in the future this will throw an error")),this.rpcHandlers.set($,U)}unregisterRpcMethod($){this.rpcHandlers.delete($)}setTrackSubscriptionPermissions($){let U=arguments.length>1&&arguments[1]!==void 0?arguments[1]:[];this.participantTrackPermissions=U,this.allParticipantsAllowedToSubscribe=$,this.engine.client.isDisconnected||this.updateTrackSubscriptionPermissions()}handleIncomingRpcAck($){const U=this.pendingAcks.get($);U?(U.resolve(),this.pendingAcks.delete($)):console.error("Ack received for unexpected RPC request",$)}handleIncomingRpcResponse($,U,F){const V=this.pendingResponses.get($);V?(V.resolve(U,F),this.pendingResponses.delete($)):console.error("Response received for unexpected RPC request",$)}publishRpcRequest($,U,F,V,q){return __awaiter$2(this,void 0,void 0,function*(){const j=new DataPacket$1({destinationIdentities:[$],kind:DataPacket_Kind$1.RELIABLE,value:{case:"rpcRequest",value:new RpcRequest$1({id:U,method:F,payload:V,responseTimeoutMs:q,version:1})}});yield this.engine.sendDataPacket(j,DataPacket_Kind$1.RELIABLE)})}handleParticipantDisconnected($){for(const[U,{participantIdentity:F}]of this.pendingAcks)F===$&&this.pendingAcks.delete(U);for(const[U,{participantIdentity:F,resolve:V}]of this.pendingResponses)F===$&&(V(null,RpcError$2.builtIn("RECIPIENT_DISCONNECTED")),this.pendingResponses.delete(U))}setEnabledPublishCodecs($){this.enabledPublishVideoCodecs=$.filter(U=>U.mime.split("/")[0].toLowerCase()==="video")}updateInfo($){return $.sid!==this.sid||!super.updateInfo($)?!1:($.tracks.forEach(U=>{var F,V;const q=this.trackPublications.get(U.sid);if(q){const j=q.isMuted||((V=(F=q.track)===null||F===void 0?void 0:F.isUpstreamPaused)!==null&&V!==void 0?V:!1);j!==U.muted&&(this.log.debug("updating server mute state after reconcile",Object.assign(Object.assign(Object.assign({},this.logContext),getLogContextFromTrack$1(q)),{mutedOnServer:j})),this.engine.client.sendMuteTrack(U.sid,j))}}),!0)}getPublicationForTrack($){let U;return this.trackPublications.forEach(F=>{const V=F.track;V&&($ instanceof MediaStreamTrack?(isLocalAudioTrack$1(V)||isLocalVideoTrack$1(V))&&V.mediaStreamTrack===$&&(U=F):$===V&&(U=F))}),U}waitForPendingPublicationOfSource($){return __awaiter$2(this,void 0,void 0,function*(){const F=Date.now();for(;Date.now()<F+1e4;){const V=Array.from(this.pendingPublishPromises.entries()).find(q=>{let[j]=q;return j.source===$});if(V)return V[1];yield sleep$2(20)}})}},RemoteTrackPublication$1=class extends TrackPublication$1{constructor($,U,F,V){super($,U.sid,U.name,V),this.track=void 0,this.allowed=!0,this.disabled=!1,this.currentVideoQuality=VideoQuality$2.HIGH,this.handleEnded=q=>{this.setTrack(void 0),this.emit(TrackEvent$1.Ended,q)},this.handleVisibilityChange=q=>{this.log.debug("adaptivestream video visibility ".concat(this.trackSid,", visible=").concat(q),this.logContext),this.disabled=!q,this.emitTrackUpdate()},this.handleVideoDimensionsChange=q=>{this.log.debug("adaptivestream video dimensions ".concat(q.width,"x").concat(q.height),this.logContext),this.videoDimensions=q,this.emitTrackUpdate()},this.subscribed=F,this.updateInfo(U)}setSubscribed($){const U=this.subscriptionStatus,F=this.permissionStatus;this.subscribed=$,$&&(this.allowed=!0);const V=new UpdateSubscription$1({trackSids:[this.trackSid],subscribe:this.subscribed,participantTracks:[new ParticipantTracks$1({participantSid:"",trackSids:[this.trackSid]})]});this.emit(TrackEvent$1.UpdateSubscription,V),this.emitSubscriptionUpdateIfChanged(U),this.emitPermissionUpdateIfChanged(F)}get subscriptionStatus(){return this.subscribed===!1?TrackPublication$1.SubscriptionStatus.Unsubscribed:super.isSubscribed?TrackPublication$1.SubscriptionStatus.Subscribed:TrackPublication$1.SubscriptionStatus.Desired}get permissionStatus(){return this.allowed?TrackPublication$1.PermissionStatus.Allowed:TrackPublication$1.PermissionStatus.NotAllowed}get isSubscribed(){return this.subscribed===!1?!1:super.isSubscribed}get isDesired(){return this.subscribed!==!1}get isEnabled(){return!this.disabled}get isLocal(){return!1}setEnabled($){!this.isManualOperationAllowed()||this.disabled===!$||(this.disabled=!$,this.emitTrackUpdate())}setVideoQuality($){!this.isManualOperationAllowed()||this.currentVideoQuality===$||(this.currentVideoQuality=$,this.videoDimensions=void 0,this.emitTrackUpdate())}setVideoDimensions($){var U,F;this.isManualOperationAllowed()&&(((U=this.videoDimensions)===null||U===void 0?void 0:U.width)===$.width&&((F=this.videoDimensions)===null||F===void 0?void 0:F.height)===$.height||(isRemoteVideoTrack$1(this.track)&&(this.videoDimensions=$),this.currentVideoQuality=void 0,this.emitTrackUpdate()))}setVideoFPS($){this.isManualOperationAllowed()&&isRemoteVideoTrack$1(this.track)&&this.fps!==$&&(this.fps=$,this.emitTrackUpdate())}get videoQuality(){return this.currentVideoQuality}setTrack($){const U=this.subscriptionStatus,F=this.permissionStatus,V=this.track;V!==$&&(V&&(V.off(TrackEvent$1.VideoDimensionsChanged,this.handleVideoDimensionsChange),V.off(TrackEvent$1.VisibilityChanged,this.handleVisibilityChange),V.off(TrackEvent$1.Ended,this.handleEnded),V.detach(),V.stopMonitor(),this.emit(TrackEvent$1.Unsubscribed,V)),super.setTrack($),$&&($.sid=this.trackSid,$.on(TrackEvent$1.VideoDimensionsChanged,this.handleVideoDimensionsChange),$.on(TrackEvent$1.VisibilityChanged,this.handleVisibilityChange),$.on(TrackEvent$1.Ended,this.handleEnded),this.emit(TrackEvent$1.Subscribed,$)),this.emitPermissionUpdateIfChanged(F),this.emitSubscriptionUpdateIfChanged(U))}setAllowed($){const U=this.subscriptionStatus,F=this.permissionStatus;this.allowed=$,this.emitPermissionUpdateIfChanged(F),this.emitSubscriptionUpdateIfChanged(U)}setSubscriptionError($){this.emit(TrackEvent$1.SubscriptionFailed,$)}updateInfo($){super.updateInfo($);const U=this.metadataMuted;this.metadataMuted=$.muted,this.track?this.track.setMuted($.muted):U!==$.muted&&this.emit($.muted?TrackEvent$1.Muted:TrackEvent$1.Unmuted)}emitSubscriptionUpdateIfChanged($){const U=this.subscriptionStatus;$!==U&&this.emit(TrackEvent$1.SubscriptionStatusChanged,U,$)}emitPermissionUpdateIfChanged($){this.permissionStatus!==$&&this.emit(TrackEvent$1.SubscriptionPermissionChanged,this.permissionStatus,$)}isManualOperationAllowed(){return this.kind===Track$1.Kind.Video&&this.isAdaptiveStream?(this.log.warn("adaptive stream is enabled, cannot change video track settings",this.logContext),!1):this.isDesired?!0:(this.log.warn("cannot update track settings when not subscribed",this.logContext),!1)}get isAdaptiveStream(){return isRemoteVideoTrack$1(this.track)&&this.track.isAdaptiveStream}emitTrackUpdate(){const $=new UpdateTrackSettings$1({trackSids:[this.trackSid],disabled:this.disabled,fps:this.fps});this.videoDimensions?($.width=Math.ceil(this.videoDimensions.width),$.height=Math.ceil(this.videoDimensions.height)):this.currentVideoQuality!==void 0?$.quality=this.currentVideoQuality:$.quality=VideoQuality$2.HIGH,this.emit(TrackEvent$1.UpdateSettings,$)}},RemoteParticipant$1=class nt extends Participant$1{static fromParticipantInfo($,U,F){return new nt($,U.sid,U.identity,U.name,U.metadata,U.attributes,F,U.kind)}get logContext(){return Object.assign(Object.assign({},super.logContext),{rpID:this.sid,remoteParticipant:this.identity})}constructor($,U,F,V,q,j,W){let K=arguments.length>7&&arguments[7]!==void 0?arguments[7]:ParticipantInfo_Kind$1.STANDARD;super(U,F||"",V,q,j,W,K),this.signalClient=$,this.trackPublications=new Map,this.audioTrackPublications=new Map,this.videoTrackPublications=new Map,this.volumeMap=new Map}addTrackPublication($){super.addTrackPublication($),$.on(TrackEvent$1.UpdateSettings,U=>{this.log.debug("send update settings",Object.assign(Object.assign({},this.logContext),getLogContextFromTrack$1($))),this.signalClient.sendUpdateTrackSettings(U)}),$.on(TrackEvent$1.UpdateSubscription,U=>{U.participantTracks.forEach(F=>{F.participantSid=this.sid}),this.signalClient.sendUpdateSubscription(U)}),$.on(TrackEvent$1.SubscriptionPermissionChanged,U=>{this.emit(ParticipantEvent$1.TrackSubscriptionPermissionChanged,$,U)}),$.on(TrackEvent$1.SubscriptionStatusChanged,U=>{this.emit(ParticipantEvent$1.TrackSubscriptionStatusChanged,$,U)}),$.on(TrackEvent$1.Subscribed,U=>{this.emit(ParticipantEvent$1.TrackSubscribed,U,$)}),$.on(TrackEvent$1.Unsubscribed,U=>{this.emit(ParticipantEvent$1.TrackUnsubscribed,U,$)}),$.on(TrackEvent$1.SubscriptionFailed,U=>{this.emit(ParticipantEvent$1.TrackSubscriptionFailed,$.trackSid,U)})}getTrackPublication($){const U=super.getTrackPublication($);if(U)return U}getTrackPublicationByName($){const U=super.getTrackPublicationByName($);if(U)return U}setVolume($){let U=arguments.length>1&&arguments[1]!==void 0?arguments[1]:Track$1.Source.Microphone;this.volumeMap.set(U,$);const F=this.getTrackPublication(U);F&&F.track&&F.track.setVolume($)}getVolume(){let $=arguments.length>0&&arguments[0]!==void 0?arguments[0]:Track$1.Source.Microphone;const U=this.getTrackPublication($);return U&&U.track?U.track.getVolume():this.volumeMap.get($)}addSubscribedMediaTrack($,U,F,V,q,j){let W=this.getTrackPublicationBySid(U);if(W||U.startsWith("TR")||this.trackPublications.forEach(z=>{!W&&$.kind===z.kind.toString()&&(W=z)}),!W){if(j===0){this.log.error("could not find published track",Object.assign(Object.assign({},this.logContext),{trackSid:U})),this.emit(ParticipantEvent$1.TrackSubscriptionFailed,U);return}j===void 0&&(j=20),setTimeout(()=>{this.addSubscribedMediaTrack($,U,F,V,q,j-1)},150);return}if($.readyState==="ended"){this.log.error("unable to subscribe because MediaStreamTrack is ended. Do not call MediaStreamTrack.stop()",Object.assign(Object.assign({},this.logContext),getLogContextFromTrack$1(W))),this.emit(ParticipantEvent$1.TrackSubscriptionFailed,U);return}const K=$.kind==="video";let G;return K?G=new RemoteVideoTrack$1($,U,V,q):G=new RemoteAudioTrack$1($,U,V,this.audioContext,this.audioOutput),G.source=W.source,G.isMuted=W.isMuted,G.setMediaStream(F),G.start(),W.setTrack(G),this.volumeMap.has(W.source)&&isRemoteTrack$1(G)&&isAudioTrack$1(G)&&G.setVolume(this.volumeMap.get(W.source)),W}get hasMetadata(){return!!this.participantInfo}getTrackPublicationBySid($){return this.trackPublications.get($)}updateInfo($){if(!super.updateInfo($))return!1;const U=new Map,F=new Map;return $.tracks.forEach(V=>{var q,j;let W=this.getTrackPublicationBySid(V.sid);if(W)W.updateInfo(V);else{const K=Track$1.kindFromProto(V.type);if(!K)return;W=new RemoteTrackPublication$1(K,V,(q=this.signalClient.connectOptions)===null||q===void 0?void 0:q.autoSubscribe,{loggerContextCb:()=>this.logContext,loggerName:(j=this.loggerOptions)===null||j===void 0?void 0:j.loggerName}),W.updateInfo(V),F.set(V.sid,W);const G=Array.from(this.trackPublications.values()).find(z=>z.source===W?.source);G&&W.source!==Track$1.Source.Unknown&&this.log.debug("received a second track publication for ".concat(this.identity," with the same source: ").concat(W.source),Object.assign(Object.assign({},this.logContext),{oldTrack:getLogContextFromTrack$1(G),newTrack:getLogContextFromTrack$1(W)})),this.addTrackPublication(W)}U.set(V.sid,W)}),this.trackPublications.forEach(V=>{U.has(V.trackSid)||(this.log.trace("detected removed track on remote participant, unpublishing",Object.assign(Object.assign({},this.logContext),getLogContextFromTrack$1(V))),this.unpublishTrack(V.trackSid,!0))}),F.forEach(V=>{this.emit(ParticipantEvent$1.TrackPublished,V)}),!0}unpublishTrack($,U){const F=this.trackPublications.get($);if(!F)return;const{track:V}=F;switch(V&&(V.stop(),F.setTrack(void 0)),this.trackPublications.delete($),F.kind){case Track$1.Kind.Audio:this.audioTrackPublications.delete($);break;case Track$1.Kind.Video:this.videoTrackPublications.delete($);break}U&&this.emit(ParticipantEvent$1.TrackUnpublished,F)}setAudioOutput($){return __awaiter$2(this,void 0,void 0,function*(){this.audioOutput=$;const U=[];this.audioTrackPublications.forEach(F=>{var V;isAudioTrack$1(F.track)&&isRemoteTrack$1(F.track)&&U.push(F.track.setSinkId((V=$.deviceId)!==null&&V!==void 0?V:"default"))}),yield Promise.all(U)})}emit($){for(var U=arguments.length,F=new Array(U>1?U-1:0),V=1;V<U;V++)F[V-1]=arguments[V];return this.log.trace("participant event",Object.assign(Object.assign({},this.logContext),{event:$,args:F})),super.emit($,...F)}};var ConnectionState$1;(function(B){B.Disconnected="disconnected",B.Connecting="connecting",B.Connected="connected",B.Reconnecting="reconnecting",B.SignalReconnecting="signalReconnecting"})(ConnectionState$1||(ConnectionState$1={}));const connectionReconcileFrequency$1=4*1e3;let Room$2=class Ze extends eventsExports$1.EventEmitter{constructor($){var U,F,V,q;if(super(),U=this,this.state=ConnectionState$1.Disconnected,this.activeSpeakers=[],this.isE2EEEnabled=!1,this.audioEnabled=!0,this.isVideoPlaybackBlocked=!1,this.log=livekitLogger$1,this.bufferedEvents=[],this.isResuming=!1,this.byteStreamControllers=new Map,this.textStreamControllers=new Map,this.byteStreamHandlers=new Map,this.textStreamHandlers=new Map,this.rpcHandlers=new Map,this.connect=(j,W,K)=>__awaiter$2(this,void 0,void 0,function*(){var G;if(!isBrowserSupported$1())throw isReactNative$1()?Error("WebRTC isn't detected, have you called registerGlobals?"):Error("LiveKit doesn't seem to be supported on this browser. Try to update your browser and make sure no browser extensions are disabling webRTC.");const z=yield this.disconnectLock.lock();if(this.state===ConnectionState$1.Connected)return this.log.info("already connected to room ".concat(this.name),this.logContext),z(),Promise.resolve();if(this.connectFuture)return z(),this.connectFuture.promise;this.setAndEmitConnectionState(ConnectionState$1.Connecting),((G=this.regionUrlProvider)===null||G===void 0?void 0:G.getServerUrl().toString())!==j&&(this.regionUrl=void 0,this.regionUrlProvider=void 0),isCloud$1(new URL(j))&&(this.regionUrlProvider===void 0?this.regionUrlProvider=new RegionUrlProvider$1(j,W):this.regionUrlProvider.updateToken(W),this.regionUrlProvider.fetchRegionSettings().then(Y=>{var X;(X=this.regionUrlProvider)===null||X===void 0||X.setServerReportedRegions(Y)}).catch(Y=>{this.log.warn("could not fetch region settings",Object.assign(Object.assign({},this.logContext),{error:Y}))}));const H=(Y,X,Z)=>__awaiter$2(this,void 0,void 0,function*(){var ne,ee;this.abortController&&this.abortController.abort();const ie=new AbortController;this.abortController=ie,z?.();try{yield this.attemptConnection(Z??j,W,K,ie),this.abortController=void 0,Y()}catch(se){if(this.regionUrlProvider&&se instanceof ConnectionError$1&&se.reason!==ConnectionErrorReason$1.Cancelled&&se.reason!==ConnectionErrorReason$1.NotAllowed){let te=null;try{te=yield this.regionUrlProvider.getNextBestRegionUrl((ne=this.abortController)===null||ne===void 0?void 0:ne.signal)}catch(re){if(re instanceof ConnectionError$1&&(re.status===401||re.reason===ConnectionErrorReason$1.Cancelled)){this.handleDisconnect(this.options.stopLocalTrackOnUnpublish),X(re);return}}te&&!(!((ee=this.abortController)===null||ee===void 0)&&ee.signal.aborted)?(this.log.info("Initial connection failed with ConnectionError: ".concat(se.message,". Retrying with another region: ").concat(te),this.logContext),this.recreateEngine(),yield H(Y,X,te)):(this.handleDisconnect(this.options.stopLocalTrackOnUnpublish,getDisconnectReasonFromConnectionError$1(se)),X(se))}else{let te=DisconnectReason$1.UNKNOWN_REASON;se instanceof ConnectionError$1&&(te=getDisconnectReasonFromConnectionError$1(se)),this.handleDisconnect(this.options.stopLocalTrackOnUnpublish,te),X(se)}}}),Q=this.regionUrl;return this.regionUrl=void 0,this.connectFuture=new Future$1((Y,X)=>{H(Y,X,Q)},()=>{this.clearConnectionFutures()}),this.connectFuture.promise}),this.connectSignal=(j,W,K,G,z,H)=>__awaiter$2(this,void 0,void 0,function*(){var Q,Y,X;const Z=yield K.join(j,W,{autoSubscribe:G.autoSubscribe,adaptiveStream:typeof z.adaptiveStream=="object"?!0:z.adaptiveStream,maxRetries:G.maxRetries,e2eeEnabled:!!this.e2eeManager,websocketTimeout:G.websocketTimeout},H.signal);let ne=Z.serverInfo;if(ne||(ne={version:Z.serverVersion,region:Z.serverRegion}),this.serverInfo=ne,this.log.debug("connected to Livekit Server ".concat(Object.entries(ne).map(ee=>{let[ie,se]=ee;return"".concat(ie,": ").concat(se)}).join(", ")),{room:(Q=Z.room)===null||Q===void 0?void 0:Q.name,roomSid:(Y=Z.room)===null||Y===void 0?void 0:Y.sid,identity:(X=Z.participant)===null||X===void 0?void 0:X.identity}),!ne.version)throw new UnsupportedServer$1("unknown server version");return ne.version==="0.15.1"&&this.options.dynacast&&(this.log.debug("disabling dynacast due to server version",this.logContext),z.dynacast=!1),Z}),this.applyJoinResponse=j=>{const W=j.participant;if(this.localParticipant.sid=W.sid,this.localParticipant.identity=W.identity,this.localParticipant.setEnabledPublishCodecs(j.enabledPublishCodecs),this.options.e2ee&&this.e2eeManager)try{this.e2eeManager.setSifTrailer(j.sifTrailer)}catch(K){this.log.error(K instanceof Error?K.message:"Could not set SifTrailer",Object.assign(Object.assign({},this.logContext),{error:K}))}this.handleParticipantUpdates([W,...j.otherParticipants]),j.room&&this.handleRoomUpdate(j.room)},this.attemptConnection=(j,W,K,G)=>__awaiter$2(this,void 0,void 0,function*(){var z,H;this.state===ConnectionState$1.Reconnecting||this.isResuming||!((z=this.engine)===null||z===void 0)&&z.pendingReconnect?(this.log.info("Reconnection attempt replaced by new connection attempt",this.logContext),this.recreateEngine()):this.maybeCreateEngine(),!((H=this.regionUrlProvider)===null||H===void 0)&&H.isCloud()&&this.engine.setRegionUrlProvider(this.regionUrlProvider),this.acquireAudioContext(),this.connOptions=Object.assign(Object.assign({},roomConnectOptionDefaults$1),K),this.connOptions.rtcConfig&&(this.engine.rtcConfig=this.connOptions.rtcConfig),this.connOptions.peerConnectionTimeout&&(this.engine.peerConnectionTimeout=this.connOptions.peerConnectionTimeout);try{const Q=yield this.connectSignal(j,W,this.engine,this.connOptions,this.options,G);this.applyJoinResponse(Q),this.setupLocalParticipantEvents(),this.emit(RoomEvent$1.SignalConnected)}catch(Q){yield this.engine.close(),this.recreateEngine();const Y=new ConnectionError$1("could not establish signal connection",ConnectionErrorReason$1.ServerUnreachable);throw Q instanceof Error&&(Y.message="".concat(Y.message,": ").concat(Q.message)),Q instanceof ConnectionError$1&&(Y.reason=Q.reason,Y.status=Q.status),this.log.debug("error trying to establish signal connection",Object.assign(Object.assign({},this.logContext),{error:Q})),Y}if(G.signal.aborted)throw yield this.engine.close(),this.recreateEngine(),new ConnectionError$1("Connection attempt aborted",ConnectionErrorReason$1.Cancelled);try{yield this.engine.waitForPCInitialConnection(this.connOptions.peerConnectionTimeout,G)}catch(Q){throw yield this.engine.close(),this.recreateEngine(),Q}isWeb$1()&&this.options.disconnectOnPageLeave&&(window.addEventListener("pagehide",this.onPageLeave),window.addEventListener("beforeunload",this.onPageLeave)),isWeb$1()&&document.addEventListener("freeze",this.onPageLeave),this.setAndEmitConnectionState(ConnectionState$1.Connected),this.emit(RoomEvent$1.Connected),this.registerConnectionReconcile()}),this.disconnect=function(){for(var j=arguments.length,W=new Array(j),K=0;K<j;K++)W[K]=arguments[K];return __awaiter$2(U,[...W],void 0,function(){var G=this;let z=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0;return(function*(){var H,Q,Y,X;const Z=yield G.disconnectLock.lock();try{if(G.state===ConnectionState$1.Disconnected){G.log.debug("already disconnected",G.logContext);return}G.log.info("disconnect from room",Object.assign({},G.logContext)),(G.state===ConnectionState$1.Connecting||G.state===ConnectionState$1.Reconnecting||G.isResuming)&&(G.log.warn("abort connection attempt",G.logContext),(H=G.abortController)===null||H===void 0||H.abort(),(Y=(Q=G.connectFuture)===null||Q===void 0?void 0:Q.reject)===null||Y===void 0||Y.call(Q,new ConnectionError$1("Client initiated disconnect",ConnectionErrorReason$1.Cancelled)),G.connectFuture=void 0),!((X=G.engine)===null||X===void 0)&&X.client.isDisconnected||(yield G.engine.client.sendLeave()),G.engine&&(yield G.engine.close()),G.handleDisconnect(z,DisconnectReason$1.CLIENT_INITIATED),G.engine=void 0}finally{Z()}})()})},this.onPageLeave=()=>__awaiter$2(this,void 0,void 0,function*(){this.log.info("Page leave detected, disconnecting",this.logContext),yield this.disconnect()}),this.startAudio=()=>__awaiter$2(this,void 0,void 0,function*(){const j=[],W=getBrowser$1();if(W&&W.os==="iOS"){const K="livekit-dummy-audio-el";let G=document.getElementById(K);if(!G){G=document.createElement("audio"),G.id=K,G.autoplay=!0,G.hidden=!0;const z=getEmptyAudioStreamTrack$1();z.enabled=!0;const H=new MediaStream([z]);G.srcObject=H,document.addEventListener("visibilitychange",()=>{G&&(G.srcObject=document.hidden?null:H,document.hidden||(this.log.debug("page visible again, triggering startAudio to resume playback and update playback status",this.logContext),this.startAudio()))}),document.body.append(G),this.once(RoomEvent$1.Disconnected,()=>{G?.remove(),G=null})}j.push(G)}this.remoteParticipants.forEach(K=>{K.audioTrackPublications.forEach(G=>{G.track&&G.track.attachedElements.forEach(z=>{j.push(z)})})});try{yield Promise.all([this.acquireAudioContext(),...j.map(K=>(K.muted=!1,K.play()))]),this.handleAudioPlaybackStarted()}catch(K){throw this.handleAudioPlaybackFailed(K),K}}),this.startVideo=()=>__awaiter$2(this,void 0,void 0,function*(){const j=[];for(const W of this.remoteParticipants.values())W.videoTrackPublications.forEach(K=>{var G;(G=K.track)===null||G===void 0||G.attachedElements.forEach(z=>{j.includes(z)||j.push(z)})});yield Promise.all(j.map(W=>W.play())).then(()=>{this.handleVideoPlaybackStarted()}).catch(W=>{W.name==="NotAllowedError"?this.handleVideoPlaybackFailed():this.log.warn("Resuming video playback failed, make sure you call `startVideo` directly in a user gesture handler",this.logContext)})}),this.handleRestarting=()=>{this.clearConnectionReconcile(),this.isResuming=!1;for(const j of this.remoteParticipants.values())this.handleParticipantDisconnected(j.identity,j);this.setAndEmitConnectionState(ConnectionState$1.Reconnecting)&&this.emit(RoomEvent$1.Reconnecting)},this.handleSignalRestarted=j=>__awaiter$2(this,void 0,void 0,function*(){this.log.debug("signal reconnected to server, region ".concat(j.serverRegion),Object.assign(Object.assign({},this.logContext),{region:j.serverRegion})),this.bufferedEvents=[],this.applyJoinResponse(j);try{yield this.localParticipant.republishAllTracks(void 0,!0)}catch(W){this.log.error("error trying to re-publish tracks after reconnection",Object.assign(Object.assign({},this.logContext),{error:W}))}try{yield this.engine.waitForRestarted(),this.log.debug("fully reconnected to server",Object.assign(Object.assign({},this.logContext),{region:j.serverRegion}))}catch{return}this.setAndEmitConnectionState(ConnectionState$1.Connected),this.emit(RoomEvent$1.Reconnected),this.registerConnectionReconcile(),this.emitBufferedEvents()}),this.handleParticipantUpdates=j=>{j.forEach(W=>{var K;if(W.identity===this.localParticipant.identity){this.localParticipant.updateInfo(W);return}W.identity===""&&(W.identity=(K=this.sidToIdentity.get(W.sid))!==null&&K!==void 0?K:"");let G=this.remoteParticipants.get(W.identity);W.state===ParticipantInfo_State$1.DISCONNECTED?this.handleParticipantDisconnected(W.identity,G):G=this.getOrCreateParticipant(W.identity,W)})},this.handleActiveSpeakersUpdate=j=>{const W=[],K={};j.forEach(G=>{if(K[G.sid]=!0,G.sid===this.localParticipant.sid)this.localParticipant.audioLevel=G.level,this.localParticipant.setIsSpeaking(!0),W.push(this.localParticipant);else{const z=this.getRemoteParticipantBySid(G.sid);z&&(z.audioLevel=G.level,z.setIsSpeaking(!0),W.push(z))}}),K[this.localParticipant.sid]||(this.localParticipant.audioLevel=0,this.localParticipant.setIsSpeaking(!1)),this.remoteParticipants.forEach(G=>{K[G.sid]||(G.audioLevel=0,G.setIsSpeaking(!1))}),this.activeSpeakers=W,this.emitWhenConnected(RoomEvent$1.ActiveSpeakersChanged,W)},this.handleSpeakersChanged=j=>{const W=new Map;this.activeSpeakers.forEach(G=>{const z=this.remoteParticipants.get(G.identity);z&&z.sid!==G.sid||W.set(G.sid,G)}),j.forEach(G=>{let z=this.getRemoteParticipantBySid(G.sid);G.sid===this.localParticipant.sid&&(z=this.localParticipant),z&&(z.audioLevel=G.level,z.setIsSpeaking(G.active),G.active?W.set(G.sid,z):W.delete(G.sid))});const K=Array.from(W.values());K.sort((G,z)=>z.audioLevel-G.audioLevel),this.activeSpeakers=K,this.emitWhenConnected(RoomEvent$1.ActiveSpeakersChanged,K)},this.handleStreamStateUpdate=j=>{j.streamStates.forEach(W=>{const K=this.getRemoteParticipantBySid(W.participantSid);if(!K)return;const G=K.getTrackPublicationBySid(W.trackSid);if(!G||!G.track)return;const z=Track$1.streamStateFromProto(W.state);z!==G.track.streamState&&(G.track.streamState=z,K.emit(ParticipantEvent$1.TrackStreamStateChanged,G,G.track.streamState),this.emitWhenConnected(RoomEvent$1.TrackStreamStateChanged,G,G.track.streamState,K))})},this.handleSubscriptionPermissionUpdate=j=>{const W=this.getRemoteParticipantBySid(j.participantSid);if(!W)return;const K=W.getTrackPublicationBySid(j.trackSid);K&&K.setAllowed(j.allowed)},this.handleSubscriptionError=j=>{const W=Array.from(this.remoteParticipants.values()).find(G=>G.trackPublications.has(j.trackSid));if(!W)return;const K=W.getTrackPublicationBySid(j.trackSid);K&&K.setSubscriptionError(j.err)},this.handleDataPacket=j=>{const W=this.remoteParticipants.get(j.participantIdentity);if(j.value.case==="user")this.handleUserPacket(W,j.value.value,j.kind);else if(j.value.case==="transcription")this.handleTranscription(W,j.value.value);else if(j.value.case==="sipDtmf")this.handleSipDtmf(W,j.value.value);else if(j.value.case==="chatMessage")this.handleChatMessage(W,j.value.value);else if(j.value.case==="metrics")this.handleMetrics(j.value.value,W);else if(j.value.case==="streamHeader")this.handleStreamHeader(j.value.value,j.participantIdentity);else if(j.value.case==="streamChunk")this.handleStreamChunk(j.value.value);else if(j.value.case==="streamTrailer")this.handleStreamTrailer(j.value.value);else if(j.value.case==="rpcRequest"){const K=j.value.value;this.handleIncomingRpcRequest(j.participantIdentity,K.id,K.method,K.payload,K.responseTimeoutMs,K.version)}},this.handleUserPacket=(j,W,K)=>{this.emit(RoomEvent$1.DataReceived,W.payload,j,K,W.topic),j?.emit(ParticipantEvent$1.DataReceived,W.payload,K)},this.handleSipDtmf=(j,W)=>{this.emit(RoomEvent$1.SipDTMFReceived,W,j),j?.emit(ParticipantEvent$1.SipDTMFReceived,W)},this.bufferedSegments=new Map,this.handleTranscription=(j,W)=>{const K=W.transcribedParticipantIdentity===this.localParticipant.identity?this.localParticipant:this.getParticipantByIdentity(W.transcribedParticipantIdentity),G=K?.trackPublications.get(W.trackId),z=extractTranscriptionSegments$1(W,this.transcriptionReceivedTimes);G?.emit(TrackEvent$1.TranscriptionReceived,z),K?.emit(ParticipantEvent$1.TranscriptionReceived,z,G),this.emit(RoomEvent$1.TranscriptionReceived,z,K,G)},this.handleChatMessage=(j,W)=>{const K=extractChatMessage$1(W);this.emit(RoomEvent$1.ChatMessage,K,j)},this.handleMetrics=(j,W)=>{this.emit(RoomEvent$1.MetricsReceived,j,W)},this.handleAudioPlaybackStarted=()=>{this.canPlaybackAudio||(this.audioEnabled=!0,this.emit(RoomEvent$1.AudioPlaybackStatusChanged,!0))},this.handleAudioPlaybackFailed=j=>{this.log.warn("could not playback audio",Object.assign(Object.assign({},this.logContext),{error:j})),this.canPlaybackAudio&&(this.audioEnabled=!1,this.emit(RoomEvent$1.AudioPlaybackStatusChanged,!1))},this.handleVideoPlaybackStarted=()=>{this.isVideoPlaybackBlocked&&(this.isVideoPlaybackBlocked=!1,this.emit(RoomEvent$1.VideoPlaybackStatusChanged,!0))},this.handleVideoPlaybackFailed=()=>{this.isVideoPlaybackBlocked||(this.isVideoPlaybackBlocked=!0,this.emit(RoomEvent$1.VideoPlaybackStatusChanged,!1))},this.handleDeviceChange=()=>__awaiter$2(this,void 0,void 0,function*(){var j,W;const K=DeviceManager$1.getInstance().previousDevices,G=yield DeviceManager$1.getInstance().getDevices(void 0,!1),z=getBrowser$1();if(z?.name==="Chrome"&&z.os!=="iOS")for(let Q of G){const Y=K.find(X=>X.deviceId===Q.deviceId);Y&&Y.label!==""&&Y.kind===Q.kind&&Y.label!==Q.label&&this.getActiveDevice(Q.kind)==="default"&&this.emit(RoomEvent$1.ActiveDeviceChanged,Q.kind,Q.deviceId)}const H=["audiooutput","audioinput","videoinput"];for(let Q of H){const Y=G.filter(Z=>Z.kind===Q),X=this.getActiveDevice(Q);if(X===((j=K.filter(Z=>Z.kind===Q)[0])===null||j===void 0?void 0:j.deviceId)&&Y.length>0&&((W=Y[0])===null||W===void 0?void 0:W.deviceId)!==X){yield this.switchActiveDevice(Q,Y[0].deviceId);continue}Q==="audioinput"&&!isSafari$1()||Q==="videoinput"||Y.length>0&&!Y.find(Z=>Z.deviceId===this.getActiveDevice(Q))&&(yield this.switchActiveDevice(Q,Y[0].deviceId))}this.emit(RoomEvent$1.MediaDevicesChanged)}),this.handleRoomUpdate=j=>{const W=this.roomInfo;this.roomInfo=j,W&&W.metadata!==j.metadata&&this.emitWhenConnected(RoomEvent$1.RoomMetadataChanged,j.metadata),W?.activeRecording!==j.activeRecording&&this.emitWhenConnected(RoomEvent$1.RecordingStatusChanged,j.activeRecording)},this.handleConnectionQualityUpdate=j=>{j.updates.forEach(W=>{if(W.participantSid===this.localParticipant.sid){this.localParticipant.setConnectionQuality(W.quality);return}const K=this.getRemoteParticipantBySid(W.participantSid);K&&K.setConnectionQuality(W.quality)})},this.onLocalParticipantMetadataChanged=j=>{this.emit(RoomEvent$1.ParticipantMetadataChanged,j,this.localParticipant)},this.onLocalParticipantNameChanged=j=>{this.emit(RoomEvent$1.ParticipantNameChanged,j,this.localParticipant)},this.onLocalAttributesChanged=j=>{this.emit(RoomEvent$1.ParticipantAttributesChanged,j,this.localParticipant)},this.onLocalTrackMuted=j=>{this.emit(RoomEvent$1.TrackMuted,j,this.localParticipant)},this.onLocalTrackUnmuted=j=>{this.emit(RoomEvent$1.TrackUnmuted,j,this.localParticipant)},this.onTrackProcessorUpdate=j=>{var W;(W=j?.onPublish)===null||W===void 0||W.call(j,this)},this.onLocalTrackPublished=j=>__awaiter$2(this,void 0,void 0,function*(){var W,K,G,z,H,Q;(W=j.track)===null||W===void 0||W.on(TrackEvent$1.TrackProcessorUpdate,this.onTrackProcessorUpdate),(K=j.track)===null||K===void 0||K.on(TrackEvent$1.Restarted,this.onLocalTrackRestarted),(H=(z=(G=j.track)===null||G===void 0?void 0:G.getProcessor())===null||z===void 0?void 0:z.onPublish)===null||H===void 0||H.call(z,this),this.emit(RoomEvent$1.LocalTrackPublished,j,this.localParticipant),isLocalAudioTrack$1(j.track)&&(yield j.track.checkForSilence())&&this.emit(RoomEvent$1.LocalAudioSilenceDetected,j);const Y=yield(Q=j.track)===null||Q===void 0?void 0:Q.getDeviceId(!1),X=sourceToKind$1(j.source);X&&Y&&Y!==this.localParticipant.activeDeviceMap.get(X)&&(this.localParticipant.activeDeviceMap.set(X,Y),this.emit(RoomEvent$1.ActiveDeviceChanged,X,Y))}),this.onLocalTrackUnpublished=j=>{var W,K;(W=j.track)===null||W===void 0||W.off(TrackEvent$1.TrackProcessorUpdate,this.onTrackProcessorUpdate),(K=j.track)===null||K===void 0||K.off(TrackEvent$1.Restarted,this.onLocalTrackRestarted),this.emit(RoomEvent$1.LocalTrackUnpublished,j,this.localParticipant)},this.onLocalTrackRestarted=j=>__awaiter$2(this,void 0,void 0,function*(){const W=yield j.getDeviceId(!1),K=sourceToKind$1(j.source);K&&W&&W!==this.localParticipant.activeDeviceMap.get(K)&&(this.log.debug("local track restarted, setting ".concat(K," ").concat(W," active"),this.logContext),this.localParticipant.activeDeviceMap.set(K,W),this.emit(RoomEvent$1.ActiveDeviceChanged,K,W))}),this.onLocalConnectionQualityChanged=j=>{this.emit(RoomEvent$1.ConnectionQualityChanged,j,this.localParticipant)},this.onMediaDevicesError=j=>{this.emit(RoomEvent$1.MediaDevicesError,j)},this.onLocalParticipantPermissionsChanged=j=>{this.emit(RoomEvent$1.ParticipantPermissionsChanged,j,this.localParticipant)},this.onLocalChatMessageSent=j=>{this.emit(RoomEvent$1.ChatMessage,j,this.localParticipant)},this.setMaxListeners(100),this.remoteParticipants=new Map,this.sidToIdentity=new Map,this.options=Object.assign(Object.assign({},roomOptionDefaults$1),$),this.log=getLogger$1((F=this.options.loggerName)!==null&&F!==void 0?F:LoggerNames$1.Room),this.transcriptionReceivedTimes=new Map,this.options.audioCaptureDefaults=Object.assign(Object.assign({},audioDefaults$1),$?.audioCaptureDefaults),this.options.videoCaptureDefaults=Object.assign(Object.assign({},videoDefaults$1),$?.videoCaptureDefaults),this.options.publishDefaults=Object.assign(Object.assign({},publishDefaults$1),$?.publishDefaults),this.maybeCreateEngine(),this.disconnectLock=new _$2,this.localParticipant=new LocalParticipant$1("","",this.engine,this.options,this.rpcHandlers),this.options.videoCaptureDefaults.deviceId&&this.localParticipant.activeDeviceMap.set("videoinput",unwrapConstraint$1(this.options.videoCaptureDefaults.deviceId)),this.options.audioCaptureDefaults.deviceId&&this.localParticipant.activeDeviceMap.set("audioinput",unwrapConstraint$1(this.options.audioCaptureDefaults.deviceId)),!((V=this.options.audioOutput)===null||V===void 0)&&V.deviceId&&this.switchActiveDevice("audiooutput",unwrapConstraint$1(this.options.audioOutput.deviceId)).catch(j=>this.log.warn("Could not set audio output: ".concat(j.message),this.logContext)),this.options.e2ee&&this.setupE2EE(),isWeb$1()){const j=new AbortController;(q=navigator.mediaDevices)===null||q===void 0||q.addEventListener("devicechange",this.handleDeviceChange,{signal:j.signal}),Ze.cleanupRegistry&&Ze.cleanupRegistry.register(this,()=>{j.abort()})}}registerTextStreamHandler($,U){if(this.textStreamHandlers.has($))throw new TypeError('A text stream handler for topic "'.concat($,'" has already been set.'));this.textStreamHandlers.set($,U)}unregisterTextStreamHandler($){this.textStreamHandlers.delete($)}registerByteStreamHandler($,U){if(this.byteStreamHandlers.has($))throw new TypeError('A byte stream handler for topic "'.concat($,'" has already been set.'));this.byteStreamHandlers.set($,U)}unregisterByteStreamHandler($){this.byteStreamHandlers.delete($)}registerRpcMethod($,U){if(this.rpcHandlers.has($))throw Error("RPC handler already registered for method ".concat($,", unregisterRpcMethod before trying to register again"));this.rpcHandlers.set($,U)}unregisterRpcMethod($){this.rpcHandlers.delete($)}handleIncomingRpcRequest($,U,F,V,q,j){return __awaiter$2(this,void 0,void 0,function*(){if(yield this.engine.publishRpcAck($,U),j!==1){yield this.engine.publishRpcResponse($,U,null,RpcError$2.builtIn("UNSUPPORTED_VERSION"));return}const W=this.rpcHandlers.get(F);if(!W){yield this.engine.publishRpcResponse($,U,null,RpcError$2.builtIn("UNSUPPORTED_METHOD"));return}let K=null,G=null;try{const z=yield W({requestId:U,callerIdentity:$,payload:V,responseTimeout:q});byteLength$1(z)>MAX_PAYLOAD_BYTES$1?(K=RpcError$2.builtIn("RESPONSE_PAYLOAD_TOO_LARGE"),console.warn("RPC Response payload too large for ".concat(F))):G=z}catch(z){z instanceof RpcError$2?K=z:(console.warn("Uncaught error returned by RPC handler for ".concat(F,". Returning APPLICATION_ERROR instead."),z),K=RpcError$2.builtIn("APPLICATION_ERROR"))}yield this.engine.publishRpcResponse($,U,G,K)})}setE2EEEnabled($){return __awaiter$2(this,void 0,void 0,function*(){if(this.e2eeManager)yield Promise.all([this.localParticipant.setE2EEEnabled($)]),this.localParticipant.identity!==""&&this.e2eeManager.setParticipantCryptorEnabled($,this.localParticipant.identity);else throw Error("e2ee not configured, please set e2ee settings within the room options")})}setupE2EE(){var $;this.options.e2ee&&("e2eeManager"in this.options.e2ee?this.e2eeManager=this.options.e2ee.e2eeManager:this.e2eeManager=new E2EEManager$1(this.options.e2ee),this.e2eeManager.on(EncryptionEvent$1.ParticipantEncryptionStatusChanged,(U,F)=>{isLocalParticipant$1(F)&&(this.isE2EEEnabled=U),this.emit(RoomEvent$1.ParticipantEncryptionStatusChanged,U,F)}),this.e2eeManager.on(EncryptionEvent$1.EncryptionError,U=>this.emit(RoomEvent$1.EncryptionError,U)),($=this.e2eeManager)===null||$===void 0||$.setup(this))}get logContext(){var $;return{room:this.name,roomID:($=this.roomInfo)===null||$===void 0?void 0:$.sid,participant:this.localParticipant.identity,pID:this.localParticipant.sid}}get isRecording(){var $,U;return(U=($=this.roomInfo)===null||$===void 0?void 0:$.activeRecording)!==null&&U!==void 0?U:!1}getSid(){return __awaiter$2(this,void 0,void 0,function*(){return this.state===ConnectionState$1.Disconnected?"":this.roomInfo&&this.roomInfo.sid!==""?this.roomInfo.sid:new Promise(($,U)=>{const F=V=>{V.sid!==""&&(this.engine.off(EngineEvent$1.RoomUpdate,F),$(V.sid))};this.engine.on(EngineEvent$1.RoomUpdate,F),this.once(RoomEvent$1.Disconnected,()=>{this.engine.off(EngineEvent$1.RoomUpdate,F),U("Room disconnected before room server id was available")})})})}get name(){var $,U;return(U=($=this.roomInfo)===null||$===void 0?void 0:$.name)!==null&&U!==void 0?U:""}get metadata(){var $;return($=this.roomInfo)===null||$===void 0?void 0:$.metadata}get numParticipants(){var $,U;return(U=($=this.roomInfo)===null||$===void 0?void 0:$.numParticipants)!==null&&U!==void 0?U:0}get numPublishers(){var $,U;return(U=($=this.roomInfo)===null||$===void 0?void 0:$.numPublishers)!==null&&U!==void 0?U:0}maybeCreateEngine(){this.engine&&!this.engine.isClosed||(this.engine=new RTCEngine$1(this.options),this.engine.on(EngineEvent$1.ParticipantUpdate,this.handleParticipantUpdates).on(EngineEvent$1.RoomUpdate,this.handleRoomUpdate).on(EngineEvent$1.SpeakersChanged,this.handleSpeakersChanged).on(EngineEvent$1.StreamStateChanged,this.handleStreamStateUpdate).on(EngineEvent$1.ConnectionQualityUpdate,this.handleConnectionQualityUpdate).on(EngineEvent$1.SubscriptionError,this.handleSubscriptionError).on(EngineEvent$1.SubscriptionPermissionUpdate,this.handleSubscriptionPermissionUpdate).on(EngineEvent$1.MediaTrackAdded,($,U,F)=>{this.onTrackAdded($,U,F)}).on(EngineEvent$1.Disconnected,$=>{this.handleDisconnect(this.options.stopLocalTrackOnUnpublish,$)}).on(EngineEvent$1.ActiveSpeakersUpdate,this.handleActiveSpeakersUpdate).on(EngineEvent$1.DataPacketReceived,this.handleDataPacket).on(EngineEvent$1.Resuming,()=>{this.clearConnectionReconcile(),this.isResuming=!0,this.log.info("Resuming signal connection",this.logContext),this.setAndEmitConnectionState(ConnectionState$1.SignalReconnecting)&&this.emit(RoomEvent$1.SignalReconnecting)}).on(EngineEvent$1.Resumed,()=>{this.registerConnectionReconcile(),this.isResuming=!1,this.log.info("Resumed signal connection",this.logContext),this.updateSubscriptions(),this.emitBufferedEvents(),this.setAndEmitConnectionState(ConnectionState$1.Connected)&&this.emit(RoomEvent$1.Reconnected)}).on(EngineEvent$1.SignalResumed,()=>{this.bufferedEvents=[],(this.state===ConnectionState$1.Reconnecting||this.isResuming)&&this.sendSyncState()}).on(EngineEvent$1.Restarting,this.handleRestarting).on(EngineEvent$1.SignalRestarted,this.handleSignalRestarted).on(EngineEvent$1.Offline,()=>{this.setAndEmitConnectionState(ConnectionState$1.Reconnecting)&&this.emit(RoomEvent$1.Reconnecting)}).on(EngineEvent$1.DCBufferStatusChanged,($,U)=>{this.emit(RoomEvent$1.DCBufferStatusChanged,$,U)}).on(EngineEvent$1.LocalTrackSubscribed,$=>{const U=this.localParticipant.getTrackPublications().find(F=>{let{trackSid:V}=F;return V===$});if(!U){this.log.warn("could not find local track subscription for subscribed event",this.logContext);return}this.localParticipant.emit(ParticipantEvent$1.LocalTrackSubscribed,U),this.emitWhenConnected(RoomEvent$1.LocalTrackSubscribed,U,this.localParticipant)}),this.localParticipant&&this.localParticipant.setupEngine(this.engine),this.e2eeManager&&this.e2eeManager.setupEngine(this.engine))}static getLocalDevices($){let U=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0;return DeviceManager$1.getInstance().getDevices($,U)}prepareConnection($,U){return __awaiter$2(this,void 0,void 0,function*(){if(this.state===ConnectionState$1.Disconnected){this.log.debug("prepareConnection to ".concat($),this.logContext);try{if(isCloud$1(new URL($))&&U){this.regionUrlProvider=new RegionUrlProvider$1($,U);const F=yield this.regionUrlProvider.getNextBestRegionUrl();F&&this.state===ConnectionState$1.Disconnected&&(this.regionUrl=F,yield fetch(toHttpUrl$1(F),{method:"HEAD"}),this.log.debug("prepared connection to ".concat(F),this.logContext))}else yield fetch(toHttpUrl$1($),{method:"HEAD"})}catch(F){this.log.warn("could not prepare connection",Object.assign(Object.assign({},this.logContext),{error:F}))}}})}getParticipantByIdentity($){return this.localParticipant.identity===$?this.localParticipant:this.remoteParticipants.get($)}clearConnectionFutures(){this.connectFuture=void 0}simulateScenario($,U){return __awaiter$2(this,void 0,void 0,function*(){let F=()=>{},V;switch($){case"signal-reconnect":yield this.engine.client.handleOnClose("simulate disconnect");break;case"speaker":V=new SimulateScenario$1({scenario:{case:"speakerUpdate",value:3}});break;case"node-failure":V=new SimulateScenario$1({scenario:{case:"nodeFailure",value:!0}});break;case"server-leave":V=new SimulateScenario$1({scenario:{case:"serverLeave",value:!0}});break;case"migration":V=new SimulateScenario$1({scenario:{case:"migration",value:!0}});break;case"resume-reconnect":this.engine.failNext(),yield this.engine.client.handleOnClose("simulate resume-disconnect");break;case"disconnect-signal-on-resume":F=()=>__awaiter$2(this,void 0,void 0,function*(){yield this.engine.client.handleOnClose("simulate resume-disconnect")}),V=new SimulateScenario$1({scenario:{case:"disconnectSignalOnResume",value:!0}});break;case"disconnect-signal-on-resume-no-messages":F=()=>__awaiter$2(this,void 0,void 0,function*(){yield this.engine.client.handleOnClose("simulate resume-disconnect")}),V=new SimulateScenario$1({scenario:{case:"disconnectSignalOnResumeNoMessages",value:!0}});break;case"full-reconnect":this.engine.fullReconnectOnNext=!0,yield this.engine.client.handleOnClose("simulate full-reconnect");break;case"force-tcp":case"force-tls":V=new SimulateScenario$1({scenario:{case:"switchCandidateProtocol",value:$==="force-tls"?2:1}}),F=()=>__awaiter$2(this,void 0,void 0,function*(){const q=this.engine.client.onLeave;q&&q(new LeaveRequest$1({reason:DisconnectReason$1.CLIENT_INITIATED,action:LeaveRequest_Action$1.RECONNECT}))});break;case"subscriber-bandwidth":if(U===void 0||typeof U!="number")throw new Error("subscriber-bandwidth requires a number as argument");V=new SimulateScenario$1({scenario:{case:"subscriberBandwidth",value:numberToBigInt$1(U)}});break;case"leave-full-reconnect":V=new SimulateScenario$1({scenario:{case:"leaveRequestFullReconnect",value:!0}})}V&&(yield this.engine.client.sendSimulateScenario(V),yield F())})}get canPlaybackAudio(){return this.audioEnabled}get canPlaybackVideo(){return!this.isVideoPlaybackBlocked}getActiveDevice($){return this.localParticipant.activeDeviceMap.get($)}switchActiveDevice($,U){return __awaiter$2(this,arguments,void 0,function(F,V){var q=this;let j=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!0;return(function*(){var W,K,G,z,H,Q,Y,X;let Z=!0,ne=!1;const ee=j?{exact:V}:V;if(F==="audioinput"){ne=q.localParticipant.audioTrackPublications.size===0;const ie=(W=q.getActiveDevice(F))!==null&&W!==void 0?W:q.options.audioCaptureDefaults.deviceId;q.options.audioCaptureDefaults.deviceId=ee;const se=Array.from(q.localParticipant.audioTrackPublications.values()).filter(te=>te.source===Track$1.Source.Microphone);try{Z=(yield Promise.all(se.map(te=>{var re;return(re=te.audioTrack)===null||re===void 0?void 0:re.setDeviceId(ee)}))).every(te=>te===!0)}catch(te){throw q.options.audioCaptureDefaults.deviceId=ie,te}}else if(F==="videoinput"){ne=q.localParticipant.videoTrackPublications.size===0;const ie=(K=q.getActiveDevice(F))!==null&&K!==void 0?K:q.options.videoCaptureDefaults.deviceId;q.options.videoCaptureDefaults.deviceId=ee;const se=Array.from(q.localParticipant.videoTrackPublications.values()).filter(te=>te.source===Track$1.Source.Camera);try{Z=(yield Promise.all(se.map(te=>{var re;return(re=te.videoTrack)===null||re===void 0?void 0:re.setDeviceId(ee)}))).every(te=>te===!0)}catch(te){throw q.options.videoCaptureDefaults.deviceId=ie,te}}else if(F==="audiooutput"){if(!supportsSetSinkId$1()&&!q.options.webAudioMix||q.options.webAudioMix&&q.audioContext&&!("setSinkId"in q.audioContext))throw new Error("cannot switch audio output, setSinkId not supported");q.options.webAudioMix&&(V=(G=yield DeviceManager$1.getInstance().normalizeDeviceId("audiooutput",V))!==null&&G!==void 0?G:""),(z=(X=q.options).audioOutput)!==null&&z!==void 0||(X.audioOutput={});const ie=(H=q.getActiveDevice(F))!==null&&H!==void 0?H:q.options.audioOutput.deviceId;q.options.audioOutput.deviceId=V;try{q.options.webAudioMix&&((Q=q.audioContext)===null||Q===void 0||Q.setSinkId(V)),yield Promise.all(Array.from(q.remoteParticipants.values()).map(se=>se.setAudioOutput({deviceId:V})))}catch(se){throw q.options.audioOutput.deviceId=ie,se}}return(ne||F==="audiooutput")&&(q.localParticipant.activeDeviceMap.set(F,F==="audiooutput"&&((Y=q.options.audioOutput)===null||Y===void 0?void 0:Y.deviceId)||V),q.emit(RoomEvent$1.ActiveDeviceChanged,F,V)),Z})()})}setupLocalParticipantEvents(){this.localParticipant.on(ParticipantEvent$1.ParticipantMetadataChanged,this.onLocalParticipantMetadataChanged).on(ParticipantEvent$1.ParticipantNameChanged,this.onLocalParticipantNameChanged).on(ParticipantEvent$1.AttributesChanged,this.onLocalAttributesChanged).on(ParticipantEvent$1.TrackMuted,this.onLocalTrackMuted).on(ParticipantEvent$1.TrackUnmuted,this.onLocalTrackUnmuted).on(ParticipantEvent$1.LocalTrackPublished,this.onLocalTrackPublished).on(ParticipantEvent$1.LocalTrackUnpublished,this.onLocalTrackUnpublished).on(ParticipantEvent$1.ConnectionQualityChanged,this.onLocalConnectionQualityChanged).on(ParticipantEvent$1.MediaDevicesError,this.onMediaDevicesError).on(ParticipantEvent$1.AudioStreamAcquired,this.startAudio).on(ParticipantEvent$1.ChatMessage,this.onLocalChatMessageSent).on(ParticipantEvent$1.ParticipantPermissionsChanged,this.onLocalParticipantPermissionsChanged)}recreateEngine(){var $;($=this.engine)===null||$===void 0||$.close(),this.engine=void 0,this.isResuming=!1,this.remoteParticipants.clear(),this.sidToIdentity.clear(),this.bufferedEvents=[],this.maybeCreateEngine()}onTrackAdded($,U,F){if(this.state===ConnectionState$1.Connecting||this.state===ConnectionState$1.Reconnecting){const z=()=>{this.onTrackAdded($,U,F),H()},H=()=>{this.off(RoomEvent$1.Reconnected,z),this.off(RoomEvent$1.Connected,z),this.off(RoomEvent$1.Disconnected,H)};this.once(RoomEvent$1.Reconnected,z),this.once(RoomEvent$1.Connected,z),this.once(RoomEvent$1.Disconnected,H);return}if(this.state===ConnectionState$1.Disconnected){this.log.warn("skipping incoming track after Room disconnected",this.logContext);return}if($.readyState==="ended"){this.log.info("skipping incoming track as it already ended",this.logContext);return}const V=unpackStreamId$1(U.id),q=V[0];let j=V[1],W=$.id;if(j&&j.startsWith("TR")&&(W=j),q===this.localParticipant.sid){this.log.warn("tried to create RemoteParticipant for local participant",this.logContext);return}const K=Array.from(this.remoteParticipants.values()).find(z=>z.sid===q);if(!K){this.log.error("Tried to add a track for a participant, that's not present. Sid: ".concat(q),this.logContext);return}let G;this.options.adaptiveStream&&(typeof this.options.adaptiveStream=="object"?G=this.options.adaptiveStream:G={}),K.addSubscribedMediaTrack($,W,U,F,G)}handleDisconnect(){let $=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0,U=arguments.length>1?arguments[1]:void 0;var F;if(this.clearConnectionReconcile(),this.isResuming=!1,this.bufferedEvents=[],this.transcriptionReceivedTimes.clear(),this.state!==ConnectionState$1.Disconnected){this.regionUrl=void 0;try{this.remoteParticipants.forEach(V=>{V.trackPublications.forEach(q=>{V.unpublishTrack(q.trackSid)})}),this.localParticipant.trackPublications.forEach(V=>{var q,j,W;V.track&&this.localParticipant.unpublishTrack(V.track,$),$?((q=V.track)===null||q===void 0||q.detach(),(j=V.track)===null||j===void 0||j.stop()):(W=V.track)===null||W===void 0||W.stopMonitor()}),this.localParticipant.off(ParticipantEvent$1.ParticipantMetadataChanged,this.onLocalParticipantMetadataChanged).off(ParticipantEvent$1.ParticipantNameChanged,this.onLocalParticipantNameChanged).off(ParticipantEvent$1.AttributesChanged,this.onLocalAttributesChanged).off(ParticipantEvent$1.TrackMuted,this.onLocalTrackMuted).off(ParticipantEvent$1.TrackUnmuted,this.onLocalTrackUnmuted).off(ParticipantEvent$1.LocalTrackPublished,this.onLocalTrackPublished).off(ParticipantEvent$1.LocalTrackUnpublished,this.onLocalTrackUnpublished).off(ParticipantEvent$1.ConnectionQualityChanged,this.onLocalConnectionQualityChanged).off(ParticipantEvent$1.MediaDevicesError,this.onMediaDevicesError).off(ParticipantEvent$1.AudioStreamAcquired,this.startAudio).off(ParticipantEvent$1.ChatMessage,this.onLocalChatMessageSent).off(ParticipantEvent$1.ParticipantPermissionsChanged,this.onLocalParticipantPermissionsChanged),this.localParticipant.trackPublications.clear(),this.localParticipant.videoTrackPublications.clear(),this.localParticipant.audioTrackPublications.clear(),this.remoteParticipants.clear(),this.sidToIdentity.clear(),this.activeSpeakers=[],this.audioContext&&typeof this.options.webAudioMix=="boolean"&&(this.audioContext.close(),this.audioContext=void 0),isWeb$1()&&(window.removeEventListener("beforeunload",this.onPageLeave),window.removeEventListener("pagehide",this.onPageLeave),window.removeEventListener("freeze",this.onPageLeave),(F=navigator.mediaDevices)===null||F===void 0||F.removeEventListener("devicechange",this.handleDeviceChange))}finally{this.setAndEmitConnectionState(ConnectionState$1.Disconnected),this.emit(RoomEvent$1.Disconnected,U)}}}handleParticipantDisconnected($,U){var F;this.remoteParticipants.delete($),U&&(U.trackPublications.forEach(V=>{U.unpublishTrack(V.trackSid,!0)}),this.emit(RoomEvent$1.ParticipantDisconnected,U),(F=this.localParticipant)===null||F===void 0||F.handleParticipantDisconnected(U.identity))}handleStreamHeader($,U){return __awaiter$2(this,void 0,void 0,function*(){var F;if($.contentHeader.case==="byteHeader"){const V=this.byteStreamHandlers.get($.topic);if(!V){this.log.debug("ignoring incoming byte stream due to no handler for topic",$.topic);return}let q;const j={id:$.streamId,name:(F=$.contentHeader.value.name)!==null&&F!==void 0?F:"unknown",mimeType:$.mimeType,size:$.totalLength?Number($.totalLength):void 0,topic:$.topic,timestamp:bigIntToNumber$1($.timestamp),attributes:$.attributes},W=new ReadableStream({start:K=>{q=K,this.byteStreamControllers.set($.streamId,{info:j,controller:q,startTime:Date.now()})}});V(new ByteStreamReader$1(j,W,bigIntToNumber$1($.totalLength)),{identity:U})}else if($.contentHeader.case==="textHeader"){const V=this.textStreamHandlers.get($.topic);if(!V){this.log.debug("ignoring incoming text stream due to no handler for topic",$.topic);return}let q;const j={id:$.streamId,mimeType:$.mimeType,size:$.totalLength?Number($.totalLength):void 0,topic:$.topic,timestamp:Number($.timestamp),attributes:$.attributes},W=new ReadableStream({start:K=>{q=K,this.textStreamControllers.set($.streamId,{info:j,controller:q,startTime:Date.now()})}});V(new TextStreamReader$1(j,W,bigIntToNumber$1($.totalLength)),{identity:U})}})}handleStreamChunk($){const U=this.byteStreamControllers.get($.streamId);U&&$.content.length>0&&U.controller.enqueue($);const F=this.textStreamControllers.get($.streamId);F&&$.content.length>0&&F.controller.enqueue($)}handleStreamTrailer($){const U=this.textStreamControllers.get($.streamId);U&&(U.info.attributes=Object.assign(Object.assign({},U.info.attributes),$.attributes),U.controller.close(),this.textStreamControllers.delete($.streamId));const F=this.byteStreamControllers.get($.streamId);F&&(F.info.attributes=Object.assign(Object.assign({},F.info.attributes),$.attributes),F.controller.close(),this.byteStreamControllers.delete($.streamId))}acquireAudioContext(){return __awaiter$2(this,void 0,void 0,function*(){var $,U;if(typeof this.options.webAudioMix!="boolean"&&this.options.webAudioMix.audioContext?this.audioContext=this.options.webAudioMix.audioContext:(!this.audioContext||this.audioContext.state==="closed")&&(this.audioContext=($=getNewAudioContext$1())!==null&&$!==void 0?$:void 0),this.options.webAudioMix&&this.remoteParticipants.forEach(V=>V.setAudioContext(this.audioContext)),this.localParticipant.setAudioContext(this.audioContext),this.audioContext&&this.audioContext.state==="suspended")try{yield Promise.race([this.audioContext.resume(),sleep$2(200)])}catch(V){this.log.warn("Could not resume audio context",Object.assign(Object.assign({},this.logContext),{error:V}))}const F=((U=this.audioContext)===null||U===void 0?void 0:U.state)==="running";F!==this.canPlaybackAudio&&(this.audioEnabled=F,this.emit(RoomEvent$1.AudioPlaybackStatusChanged,F))})}createParticipant($,U){var F;let V;return U?V=RemoteParticipant$1.fromParticipantInfo(this.engine.client,U,{loggerContextCb:()=>this.logContext,loggerName:this.options.loggerName}):V=new RemoteParticipant$1(this.engine.client,"",$,void 0,void 0,void 0,{loggerContextCb:()=>this.logContext,loggerName:this.options.loggerName}),this.options.webAudioMix&&V.setAudioContext(this.audioContext),!((F=this.options.audioOutput)===null||F===void 0)&&F.deviceId&&V.setAudioOutput(this.options.audioOutput).catch(q=>this.log.warn("Could not set audio output: ".concat(q.message),this.logContext)),V}getOrCreateParticipant($,U){if(this.remoteParticipants.has($)){const V=this.remoteParticipants.get($);return U&&V.updateInfo(U)&&this.sidToIdentity.set(U.sid,U.identity),V}const F=this.createParticipant($,U);return this.remoteParticipants.set($,F),this.sidToIdentity.set(U.sid,U.identity),this.emitWhenConnected(RoomEvent$1.ParticipantConnected,F),F.on(ParticipantEvent$1.TrackPublished,V=>{this.emitWhenConnected(RoomEvent$1.TrackPublished,V,F)}).on(ParticipantEvent$1.TrackSubscribed,(V,q)=>{V.kind===Track$1.Kind.Audio?(V.on(TrackEvent$1.AudioPlaybackStarted,this.handleAudioPlaybackStarted),V.on(TrackEvent$1.AudioPlaybackFailed,this.handleAudioPlaybackFailed)):V.kind===Track$1.Kind.Video&&(V.on(TrackEvent$1.VideoPlaybackFailed,this.handleVideoPlaybackFailed),V.on(TrackEvent$1.VideoPlaybackStarted,this.handleVideoPlaybackStarted)),this.emit(RoomEvent$1.TrackSubscribed,V,q,F)}).on(ParticipantEvent$1.TrackUnpublished,V=>{this.emit(RoomEvent$1.TrackUnpublished,V,F)}).on(ParticipantEvent$1.TrackUnsubscribed,(V,q)=>{this.emit(RoomEvent$1.TrackUnsubscribed,V,q,F)}).on(ParticipantEvent$1.TrackMuted,V=>{this.emitWhenConnected(RoomEvent$1.TrackMuted,V,F)}).on(ParticipantEvent$1.TrackUnmuted,V=>{this.emitWhenConnected(RoomEvent$1.TrackUnmuted,V,F)}).on(ParticipantEvent$1.ParticipantMetadataChanged,V=>{this.emitWhenConnected(RoomEvent$1.ParticipantMetadataChanged,V,F)}).on(ParticipantEvent$1.ParticipantNameChanged,V=>{this.emitWhenConnected(RoomEvent$1.ParticipantNameChanged,V,F)}).on(ParticipantEvent$1.AttributesChanged,V=>{this.emitWhenConnected(RoomEvent$1.ParticipantAttributesChanged,V,F)}).on(ParticipantEvent$1.ConnectionQualityChanged,V=>{this.emitWhenConnected(RoomEvent$1.ConnectionQualityChanged,V,F)}).on(ParticipantEvent$1.ParticipantPermissionsChanged,V=>{this.emitWhenConnected(RoomEvent$1.ParticipantPermissionsChanged,V,F)}).on(ParticipantEvent$1.TrackSubscriptionStatusChanged,(V,q)=>{this.emitWhenConnected(RoomEvent$1.TrackSubscriptionStatusChanged,V,q,F)}).on(ParticipantEvent$1.TrackSubscriptionFailed,(V,q)=>{this.emit(RoomEvent$1.TrackSubscriptionFailed,V,F,q)}).on(ParticipantEvent$1.TrackSubscriptionPermissionChanged,(V,q)=>{this.emitWhenConnected(RoomEvent$1.TrackSubscriptionPermissionChanged,V,q,F)}),U&&F.updateInfo(U),F}sendSyncState(){const $=Array.from(this.remoteParticipants.values()).reduce((F,V)=>(F.push(...V.getTrackPublications()),F),[]),U=this.localParticipant.getTrackPublications();this.engine.sendSyncState($,U)}updateSubscriptions(){for(const $ of this.remoteParticipants.values())for(const U of $.videoTrackPublications.values())U.isSubscribed&&isRemotePub$1(U)&&U.emitTrackUpdate()}getRemoteParticipantBySid($){const U=this.sidToIdentity.get($);if(U)return this.remoteParticipants.get(U)}registerConnectionReconcile(){this.clearConnectionReconcile();let $=0;this.connectionReconcileInterval=CriticalTimers$1.setInterval(()=>{!this.engine||this.engine.isClosed||!this.engine.verifyTransport()?($++,this.log.warn("detected connection state mismatch",Object.assign(Object.assign({},this.logContext),{numFailures:$,engine:this.engine?{closed:this.engine.isClosed,transportsConnected:this.engine.verifyTransport()}:void 0})),$>=3&&(this.recreateEngine(),this.handleDisconnect(this.options.stopLocalTrackOnUnpublish,DisconnectReason$1.STATE_MISMATCH))):$=0},connectionReconcileFrequency$1)}clearConnectionReconcile(){this.connectionReconcileInterval&&CriticalTimers$1.clearInterval(this.connectionReconcileInterval)}setAndEmitConnectionState($){return $===this.state?!1:(this.state=$,this.emit(RoomEvent$1.ConnectionStateChanged,this.state),!0)}emitBufferedEvents(){this.bufferedEvents.forEach($=>{let[U,F]=$;this.emit(U,...F)}),this.bufferedEvents=[]}emitWhenConnected($){for(var U=arguments.length,F=new Array(U>1?U-1:0),V=1;V<U;V++)F[V-1]=arguments[V];if(this.state===ConnectionState$1.Reconnecting||this.isResuming||!this.engine||this.engine.pendingReconnect)this.bufferedEvents.push([$,F]);else if(this.state===ConnectionState$1.Connected)return this.emit($,...F);return!1}simulateParticipants($){return __awaiter$2(this,void 0,void 0,function*(){var U,F;const V=Object.assign({audio:!0,video:!0,useRealTracks:!1},$.publish),q=Object.assign({count:9,audio:!1,video:!0,aspectRatios:[1.66,1.7,1.3]},$.participants);if(this.handleDisconnect(),this.roomInfo=new Room$1$1({sid:"RM_SIMULATED",name:"simulated-room",emptyTimeout:0,maxParticipants:0,creationTime:protoInt64$1.parse(new Date().getTime()),metadata:"",numParticipants:1,numPublishers:1,turnPassword:"",enabledCodecs:[],activeRecording:!1}),this.localParticipant.updateInfo(new ParticipantInfo$1({identity:"simulated-local",name:"local-name"})),this.setupLocalParticipantEvents(),this.emit(RoomEvent$1.SignalConnected),this.emit(RoomEvent$1.Connected),this.setAndEmitConnectionState(ConnectionState$1.Connected),V.video){const j=new LocalTrackPublication$1(Track$1.Kind.Video,new TrackInfo$1({source:TrackSource$1.CAMERA,sid:Math.floor(Math.random()*1e4).toString(),type:TrackType$1.AUDIO,name:"video-dummy"}),new LocalVideoTrack$1(V.useRealTracks?(yield window.navigator.mediaDevices.getUserMedia({video:!0})).getVideoTracks()[0]:createDummyVideoStreamTrack$1(160*((U=q.aspectRatios[0])!==null&&U!==void 0?U:1),160,!0,!0),void 0,!1,{loggerName:this.options.loggerName,loggerContextCb:()=>this.logContext}),{loggerName:this.options.loggerName,loggerContextCb:()=>this.logContext});this.localParticipant.addTrackPublication(j),this.localParticipant.emit(ParticipantEvent$1.LocalTrackPublished,j)}if(V.audio){const j=new LocalTrackPublication$1(Track$1.Kind.Audio,new TrackInfo$1({source:TrackSource$1.MICROPHONE,sid:Math.floor(Math.random()*1e4).toString(),type:TrackType$1.AUDIO}),new LocalAudioTrack$1(V.useRealTracks?(yield navigator.mediaDevices.getUserMedia({audio:!0})).getAudioTracks()[0]:getEmptyAudioStreamTrack$1(),void 0,!1,this.audioContext,{loggerName:this.options.loggerName,loggerContextCb:()=>this.logContext}),{loggerName:this.options.loggerName,loggerContextCb:()=>this.logContext});this.localParticipant.addTrackPublication(j),this.localParticipant.emit(ParticipantEvent$1.LocalTrackPublished,j)}for(let j=0;j<q.count-1;j+=1){let W=new ParticipantInfo$1({sid:Math.floor(Math.random()*1e4).toString(),identity:"simulated-".concat(j),state:ParticipantInfo_State$1.ACTIVE,tracks:[],joinedAt:protoInt64$1.parse(Date.now())});const K=this.getOrCreateParticipant(W.identity,W);if(q.video){const G=createDummyVideoStreamTrack$1(160*((F=q.aspectRatios[j%q.aspectRatios.length])!==null&&F!==void 0?F:1),160,!1,!0),z=new TrackInfo$1({source:TrackSource$1.CAMERA,sid:Math.floor(Math.random()*1e4).toString(),type:TrackType$1.AUDIO});K.addSubscribedMediaTrack(G,z.sid,new MediaStream([G]),new RTCRtpReceiver),W.tracks=[...W.tracks,z]}if(q.audio){const G=getEmptyAudioStreamTrack$1(),z=new TrackInfo$1({source:TrackSource$1.MICROPHONE,sid:Math.floor(Math.random()*1e4).toString(),type:TrackType$1.AUDIO});K.addSubscribedMediaTrack(G,z.sid,new MediaStream([G]),new RTCRtpReceiver),W.tracks=[...W.tracks,z]}K.updateInfo(W)}})}emit($){for(var U=arguments.length,F=new Array(U>1?U-1:0),V=1;V<U;V++)F[V-1]=arguments[V];if($!==RoomEvent$1.ActiveSpeakersChanged&&$!==RoomEvent$1.TranscriptionReceived){const q=mapArgs$1(F).filter(j=>j!==void 0);this.log.debug("room event ".concat($),Object.assign(Object.assign({},this.logContext),{event:$,args:q}))}return super.emit($,...F)}};Room$2.cleanupRegistry=typeof FinalizationRegistry<"u"&&new FinalizationRegistry(B=>{B()});function mapArgs$1(B){return B.map($=>{if($)return Array.isArray($)?mapArgs$1($):typeof $=="object"?"logContext"in $?$.logContext:void 0:$})}var CheckStatus$1;(function(B){B[B.IDLE=0]="IDLE",B[B.RUNNING=1]="RUNNING",B[B.SKIPPED=2]="SKIPPED",B[B.SUCCESS=3]="SUCCESS",B[B.FAILED=4]="FAILED"})(CheckStatus$1||(CheckStatus$1={}));let Checker$1=class extends eventsExports$1.EventEmitter{constructor($,U){let F=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};super(),this.status=CheckStatus$1.IDLE,this.logs=[],this.options={},this.url=$,this.token=U,this.name=this.constructor.name,this.room=new Room$2(F.roomOptions),this.connectOptions=F.connectOptions,this.options=F}run($){return __awaiter$2(this,void 0,void 0,function*(){if(this.status!==CheckStatus$1.IDLE)throw Error("check is running already");this.setStatus(CheckStatus$1.RUNNING);try{yield this.perform()}catch(U){U instanceof Error&&(this.options.errorsAsWarnings?this.appendWarning(U.message):this.appendError(U.message))}return yield this.disconnect(),yield new Promise(U=>setTimeout(U,500)),this.status!==CheckStatus$1.SKIPPED&&this.setStatus(this.isSuccess()?CheckStatus$1.SUCCESS:CheckStatus$1.FAILED),$&&$(),this.getInfo()})}isSuccess(){return!this.logs.some($=>$.level==="error")}connect($){return __awaiter$2(this,void 0,void 0,function*(){return this.room.state===ConnectionState$1.Connected?this.room:($||($=this.url),yield this.room.connect($,this.token,this.connectOptions),this.room)})}disconnect(){return __awaiter$2(this,void 0,void 0,function*(){this.room&&this.room.state!==ConnectionState$1.Disconnected&&(yield this.room.disconnect(),yield new Promise($=>setTimeout($,500)))})}skip(){this.setStatus(CheckStatus$1.SKIPPED)}switchProtocol($){return __awaiter$2(this,void 0,void 0,function*(){let U=!1,F=!1;if(this.room.on(RoomEvent$1.Reconnecting,()=>{U=!0}),this.room.once(RoomEvent$1.Reconnected,()=>{F=!0}),this.room.simulateScenario("force-".concat($)),yield new Promise(q=>setTimeout(q,1e3)),!U)return;const V=Date.now()+1e4;for(;Date.now()<V;){if(F)return;yield sleep$2(100)}throw new Error("Could not reconnect using ".concat($," protocol after 10 seconds"))})}appendMessage($){this.logs.push({level:"info",message:$}),this.emit("update",this.getInfo())}appendWarning($){this.logs.push({level:"warning",message:$}),this.emit("update",this.getInfo())}appendError($){this.logs.push({level:"error",message:$}),this.emit("update",this.getInfo())}setStatus($){this.status=$,this.emit("update",this.getInfo())}get engine(){var $;return($=this.room)===null||$===void 0?void 0:$.engine}getInfo(){return{logs:this.logs,name:this.name,status:this.status,description:this.description}}},CloudRegionCheck$1=class extends Checker$1{get description(){return"Cloud regions"}perform(){return __awaiter$2(this,void 0,void 0,function*(){const $=new RegionUrlProvider$1(this.url,this.token);if(!$.isCloud()){this.skip();return}const U=[],F=new Set;for(let q=0;q<3;q++){const j=yield $.getNextBestRegionUrl();if(!j)break;if(F.has(j))continue;F.add(j);const W=yield this.checkCloudRegion(j);this.appendMessage("".concat(W.region," RTT: ").concat(W.rtt,"ms, duration: ").concat(W.duration,"ms")),U.push(W)}U.sort((q,j)=>(q.duration-j.duration)*.5+(q.rtt-j.rtt)*.5);const V=U[0];this.bestStats=V,this.appendMessage("best Cloud region: ".concat(V.region))})}getInfo(){const $=super.getInfo();return $.data=this.bestStats,$}checkCloudRegion($){return __awaiter$2(this,void 0,void 0,function*(){var U,F;yield this.connect($),this.options.protocol==="tcp"&&(yield this.switchProtocol("tcp"));const V=(U=this.room.serverInfo)===null||U===void 0?void 0:U.region;if(!V)throw new Error("Region not found");const q=yield this.room.localParticipant.streamText({topic:"test"}),j=1e3,K=1e6/j,G="A".repeat(j),z=Date.now();for(let X=0;X<K;X++)yield q.write(G);yield q.close();const H=Date.now(),Q=yield(F=this.room.engine.pcManager)===null||F===void 0?void 0:F.publisher.getStats(),Y={region:V,rtt:1e4,duration:H-z};return Q?.forEach(X=>{X.type==="candidate-pair"&&X.nominated&&(Y.rtt=X.currentRoundTripTime*1e3)}),yield this.disconnect(),Y})}};const TEST_DURATION$1=1e4;let ConnectionProtocolCheck$1=class extends Checker$1{get description(){return"Connection via UDP vs TCP"}perform(){return __awaiter$2(this,void 0,void 0,function*(){const $=yield this.checkConnectionProtocol("udp"),U=yield this.checkConnectionProtocol("tcp");this.bestStats=$,$.qualityLimitationDurations.bandwidth-U.qualityLimitationDurations.bandwidth>.5||($.packetsLost-U.packetsLost)/$.packetsSent>.01?(this.appendMessage("best connection quality via tcp"),this.bestStats=U):this.appendMessage("best connection quality via udp");const F=this.bestStats;this.appendMessage("upstream bitrate: ".concat((F.bitrateTotal/F.count/1e3/1e3).toFixed(2)," mbps")),this.appendMessage("RTT: ".concat((F.rttTotal/F.count*1e3).toFixed(2)," ms")),this.appendMessage("jitter: ".concat((F.jitterTotal/F.count*1e3).toFixed(2)," ms")),F.packetsLost>0&&this.appendWarning("packets lost: ".concat((F.packetsLost/F.packetsSent*100).toFixed(2),"%")),F.qualityLimitationDurations.bandwidth>1&&this.appendWarning("bandwidth limited ".concat((F.qualityLimitationDurations.bandwidth/(TEST_DURATION$1/1e3)*100).toFixed(2),"%")),F.qualityLimitationDurations.cpu>0&&this.appendWarning("cpu limited ".concat((F.qualityLimitationDurations.cpu/(TEST_DURATION$1/1e3)*100).toFixed(2),"%"))})}getInfo(){const $=super.getInfo();return $.data=this.bestStats,$}checkConnectionProtocol($){return __awaiter$2(this,void 0,void 0,function*(){yield this.connect(),$==="tcp"?yield this.switchProtocol("tcp"):yield this.switchProtocol("udp");const U=document.createElement("canvas");U.width=1280,U.height=720;const F=U.getContext("2d");if(!F)throw new Error("Could not get canvas context");let V=0;const q=()=>{V=(V+1)%360,F.fillStyle="hsl(".concat(V,", 100%, 50%)"),F.fillRect(0,0,U.width,U.height),requestAnimationFrame(q)};q();const W=U.captureStream(30).getVideoTracks()[0],G=(yield this.room.localParticipant.publishTrack(W,{simulcast:!1,degradationPreference:"maintain-resolution",videoEncoding:{maxBitrate:2e6}})).track,z={protocol:$,packetsLost:0,packetsSent:0,qualityLimitationDurations:{},rttTotal:0,jitterTotal:0,bitrateTotal:0,count:0},H=setInterval(()=>__awaiter$2(this,void 0,void 0,function*(){const Q=yield G.getRTCStatsReport();Q?.forEach(Y=>{Y.type==="outbound-rtp"?(z.packetsSent=Y.packetsSent,z.qualityLimitationDurations=Y.qualityLimitationDurations,z.bitrateTotal+=Y.targetBitrate,z.count++):Y.type==="remote-inbound-rtp"&&(z.packetsLost=Y.packetsLost,z.rttTotal+=Y.roundTripTime,z.jitterTotal+=Y.jitter)})}),1e3);return yield new Promise(Q=>setTimeout(Q,TEST_DURATION$1)),clearInterval(H),W.stop(),U.remove(),yield this.disconnect(),z})}},PublishAudioCheck$1=class extends Checker$1{get description(){return"Can publish audio"}perform(){return __awaiter$2(this,void 0,void 0,function*(){var $;const U=yield this.connect(),F=yield createLocalAudioTrack$1();if(yield detectSilence$1(F,1e3))throw new Error("unable to detect audio from microphone");this.appendMessage("detected audio from microphone"),U.localParticipant.publishTrack(F),yield new Promise(W=>setTimeout(W,3e3));const q=yield($=F.sender)===null||$===void 0?void 0:$.getStats();if(!q)throw new Error("Could not get RTCStats");let j=0;if(q.forEach(W=>{W.type==="outbound-rtp"&&(W.kind==="audio"||!W.kind&&W.mediaType==="audio")&&(j=W.packetsSent)}),j===0)throw new Error("Could not determine packets are sent");this.appendMessage("published ".concat(j," audio packets"))})}},PublishVideoCheck$1=class extends Checker$1{get description(){return"Can publish video"}perform(){return __awaiter$2(this,void 0,void 0,function*(){var $;const U=yield this.connect(),F=yield createLocalVideoTrack$1();yield this.checkForVideo(F.mediaStreamTrack),U.localParticipant.publishTrack(F),yield new Promise(j=>setTimeout(j,5e3));const V=yield($=F.sender)===null||$===void 0?void 0:$.getStats();if(!V)throw new Error("Could not get RTCStats");let q=0;if(V.forEach(j=>{j.type==="outbound-rtp"&&(j.kind==="video"||!j.kind&&j.mediaType==="video")&&(q+=j.packetsSent)}),q===0)throw new Error("Could not determine packets are sent");this.appendMessage("published ".concat(q," video packets"))})}checkForVideo($){return __awaiter$2(this,void 0,void 0,function*(){const U=new MediaStream;U.addTrack($.clone());const F=document.createElement("video");F.srcObject=U,F.muted=!0,yield new Promise(V=>{F.onplay=()=>{setTimeout(()=>{var q,j,W,K;const G=document.createElement("canvas"),z=$.getSettings(),H=(j=(q=z.width)!==null&&q!==void 0?q:F.videoWidth)!==null&&j!==void 0?j:1280,Q=(K=(W=z.height)!==null&&W!==void 0?W:F.videoHeight)!==null&&K!==void 0?K:720;G.width=H,G.height=Q;const Y=G.getContext("2d");Y.drawImage(F,0,0);const Z=Y.getImageData(0,0,G.width,G.height).data;let ne=!0;for(let ee=0;ee<Z.length;ee+=4)if(Z[ee]!==0||Z[ee+1]!==0||Z[ee+2]!==0){ne=!1;break}ne?this.appendError("camera appears to be producing only black frames"):this.appendMessage("received video frames"),V()},1e3)},F.play()}),F.remove()})}},ReconnectCheck$1=class extends Checker$1{get description(){return"Resuming connection after interruption"}perform(){return __awaiter$2(this,void 0,void 0,function*(){var $;const U=yield this.connect();let F=!1,V=!1,q;const j=new Promise(G=>{setTimeout(G,5e3),q=G}),W=()=>{F=!0};U.on(RoomEvent$1.SignalReconnecting,W).on(RoomEvent$1.Reconnecting,W).on(RoomEvent$1.Reconnected,()=>{V=!0,q(!0)}),($=U.engine.client.ws)===null||$===void 0||$.close();const K=U.engine.client.onClose;if(K&&K(""),yield j,F){if(!V||U.state!==ConnectionState$1.Connected)throw this.appendWarning("reconnection is only possible in Redis-based configurations"),new Error("Not able to reconnect")}else throw new Error("Did not attempt to reconnect")})}},TURNCheck$1=class extends Checker$1{get description(){return"Can connect via TURN"}perform(){return __awaiter$2(this,void 0,void 0,function*(){var $,U;const F=new SignalClient$1,V=yield F.join(this.url,this.token,{autoSubscribe:!0,maxRetries:0,e2eeEnabled:!1,websocketTimeout:15e3});let q=!1,j=!1,W=!1;for(let K of V.iceServers)for(let G of K.urls)G.startsWith("turn:")?(j=!0,W=!0):G.startsWith("turns:")&&(j=!0,W=!0,q=!0),G.startsWith("stun:")&&(W=!0);W?j&&!q&&this.appendWarning("TURN is configured server side, but TURN/TLS is unavailable."):this.appendWarning("No STUN servers configured on server side."),yield F.close(),!((U=($=this.connectOptions)===null||$===void 0?void 0:$.rtcConfig)===null||U===void 0)&&U.iceServers||j?yield this.room.connect(this.url,this.token,{rtcConfig:{iceTransportPolicy:"relay"}}):(this.appendWarning("No TURN servers configured."),this.skip(),yield new Promise(K=>setTimeout(K,0)))})}},WebRTCCheck$1=class extends Checker$1{get description(){return"Establishing WebRTC connection"}perform(){return __awaiter$2(this,void 0,void 0,function*(){let $=!1,U=!1;this.room.on(RoomEvent$1.SignalConnected,()=>{const F=this.room.engine.client.onTrickle;this.room.engine.client.onTrickle=(V,q)=>{if(V.candidate){const j=new RTCIceCandidate(V);let W="".concat(j.protocol," ").concat(j.address,":").concat(j.port," ").concat(j.type);j.address&&(isIPPrivate$1(j.address)?W+=" (private)":j.protocol==="tcp"&&j.tcpType==="passive"?($=!0,W+=" (passive)"):j.protocol==="udp"&&(U=!0)),this.appendMessage(W)}F&&F(V,q)},this.room.engine.pcManager&&(this.room.engine.pcManager.subscriber.onIceCandidateError=V=>{V instanceof RTCPeerConnectionIceErrorEvent&&this.appendWarning("error with ICE candidate: ".concat(V.errorCode," ").concat(V.errorText," ").concat(V.url))})});try{yield this.connect(),livekitLogger$1.info("now the room is connected")}catch(F){throw this.appendWarning("ports need to be open on firewall in order to connect."),F}$||this.appendWarning("Server is not configured for ICE/TCP"),U||this.appendWarning("No public IPv4 UDP candidates were found. Your server is likely not configured correctly")})}};function isIPPrivate$1(B){const $=B.split(".");if($.length===4){if($[0]==="10")return!0;if($[0]==="192"&&$[1]==="168")return!0;if($[0]==="172"){const U=parseInt($[1],10);if(U>=16&&U<=31)return!0}}return!1}let WebSocketCheck$1=class extends Checker$1{get description(){return"Connecting to signal connection via WebSocket"}perform(){return __awaiter$2(this,void 0,void 0,function*(){var $,U,F;(this.url.startsWith("ws:")||this.url.startsWith("http:"))&&this.appendWarning("Server is insecure, clients may block connections to it");let V=new SignalClient$1;const q=yield V.join(this.url,this.token,{autoSubscribe:!0,maxRetries:0,e2eeEnabled:!1,websocketTimeout:15e3});this.appendMessage("Connected to server, version ".concat(q.serverVersion,".")),(($=q.serverInfo)===null||$===void 0?void 0:$.edition)===ServerInfo_Edition$1.Cloud&&(!((U=q.serverInfo)===null||U===void 0)&&U.region)&&this.appendMessage("LiveKit Cloud: ".concat((F=q.serverInfo)===null||F===void 0?void 0:F.region)),yield V.close()})}},ConnectionCheck$1=class extends eventsExports$1.EventEmitter{constructor($,U){let F=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};super(),this.options={},this.checkResults=new Map,this.url=$,this.token=U,this.options=F}getNextCheckId(){const $=this.checkResults.size;return this.checkResults.set($,{logs:[],status:CheckStatus$1.IDLE,name:"",description:""}),$}updateCheck($,U){this.checkResults.set($,U),this.emit("checkUpdate",$,U)}isSuccess(){return Array.from(this.checkResults.values()).every($=>$.status!==CheckStatus$1.FAILED)}getResults(){return Array.from(this.checkResults.values())}createAndRunCheck($){return __awaiter$2(this,void 0,void 0,function*(){const U=this.getNextCheckId(),F=new $(this.url,this.token,this.options),V=j=>{this.updateCheck(U,j)};F.on("update",V);const q=yield F.run();return F.off("update",V),q})}checkWebsocket(){return __awaiter$2(this,void 0,void 0,function*(){return this.createAndRunCheck(WebSocketCheck$1)})}checkWebRTC(){return __awaiter$2(this,void 0,void 0,function*(){return this.createAndRunCheck(WebRTCCheck$1)})}checkTURN(){return __awaiter$2(this,void 0,void 0,function*(){return this.createAndRunCheck(TURNCheck$1)})}checkReconnect(){return __awaiter$2(this,void 0,void 0,function*(){return this.createAndRunCheck(ReconnectCheck$1)})}checkPublishAudio(){return __awaiter$2(this,void 0,void 0,function*(){return this.createAndRunCheck(PublishAudioCheck$1)})}checkPublishVideo(){return __awaiter$2(this,void 0,void 0,function*(){return this.createAndRunCheck(PublishVideoCheck$1)})}checkConnectionProtocol(){return __awaiter$2(this,void 0,void 0,function*(){const $=yield this.createAndRunCheck(ConnectionProtocolCheck$1);if($.data&&"protocol"in $.data){const U=$.data;this.options.protocol=U.protocol}return $})}checkCloudRegion(){return __awaiter$2(this,void 0,void 0,function*(){return this.createAndRunCheck(CloudRegionCheck$1)})}};var commonjsGlobal=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function getDefaultExportFromCjs$1(B){return B&&B.__esModule&&Object.prototype.hasOwnProperty.call(B,"default")?B.default:B}var src={exports:{}},indexLight={exports:{}},indexMinimal={},minimal={},aspromise,hasRequiredAspromise;function requireAspromise(){if(hasRequiredAspromise)return aspromise;hasRequiredAspromise=1,aspromise=B;function B($,U){for(var F=new Array(arguments.length-1),V=0,q=2,j=!0;q<arguments.length;)F[V++]=arguments[q++];return new Promise(function(K,G){F[V]=function(H){if(j)if(j=!1,H)G(H);else{for(var Q=new Array(arguments.length-1),Y=0;Y<Q.length;)Q[Y++]=arguments[Y];K.apply(null,Q)}};try{$.apply(U||null,F)}catch(z){j&&(j=!1,G(z))}})}return aspromise}var base64={},hasRequiredBase64;function requireBase64(){return hasRequiredBase64||(hasRequiredBase64=1,(function(B){var $=B;$.length=function(W){var K=W.length;if(!K)return 0;for(var G=0;--K%4>1&&W.charAt(K)==="=";)++G;return Math.ceil(W.length*3)/4-G};for(var U=new Array(64),F=new Array(123),V=0;V<64;)F[U[V]=V<26?V+65:V<52?V+71:V<62?V-4:V-59|43]=V++;$.encode=function(W,K,G){for(var z=null,H=[],Q=0,Y=0,X;K<G;){var Z=W[K++];switch(Y){case 0:H[Q++]=U[Z>>2],X=(Z&3)<<4,Y=1;break;case 1:H[Q++]=U[X|Z>>4],X=(Z&15)<<2,Y=2;break;case 2:H[Q++]=U[X|Z>>6],H[Q++]=U[Z&63],Y=0;break}Q>8191&&((z||(z=[])).push(String.fromCharCode.apply(String,H)),Q=0)}return Y&&(H[Q++]=U[X],H[Q++]=61,Y===1&&(H[Q++]=61)),z?(Q&&z.push(String.fromCharCode.apply(String,H.slice(0,Q))),z.join("")):String.fromCharCode.apply(String,H.slice(0,Q))};var q="invalid encoding";$.decode=function(W,K,G){for(var z=G,H=0,Q,Y=0;Y<W.length;){var X=W.charCodeAt(Y++);if(X===61&&H>1)break;if((X=F[X])===void 0)throw Error(q);switch(H){case 0:Q=X,H=1;break;case 1:K[G++]=Q<<2|(X&48)>>4,Q=X,H=2;break;case 2:K[G++]=(Q&15)<<4|(X&60)>>2,Q=X,H=3;break;case 3:K[G++]=(Q&3)<<6|X,H=0;break}}if(H===1)throw Error(q);return G-z},$.test=function(W){return/^(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=)?$/.test(W)}})(base64)),base64}var eventemitter,hasRequiredEventemitter;function requireEventemitter(){if(hasRequiredEventemitter)return eventemitter;hasRequiredEventemitter=1,eventemitter=B;function B(){this._listeners={}}return B.prototype.on=function(U,F,V){return(this._listeners[U]||(this._listeners[U]=[])).push({fn:F,ctx:V||this}),this},B.prototype.off=function(U,F){if(U===void 0)this._listeners={};else if(F===void 0)this._listeners[U]=[];else for(var V=this._listeners[U],q=0;q<V.length;)V[q].fn===F?V.splice(q,1):++q;return this},B.prototype.emit=function(U){var F=this._listeners[U];if(F){for(var V=[],q=1;q<arguments.length;)V.push(arguments[q++]);for(q=0;q<F.length;)F[q].fn.apply(F[q++].ctx,V)}return this},eventemitter}var float,hasRequiredFloat;function requireFloat(){if(hasRequiredFloat)return float;hasRequiredFloat=1,float=B(B);function B(q){return typeof Float32Array<"u"?(function(){var j=new Float32Array([-0]),W=new Uint8Array(j.buffer),K=W[3]===128;function G(Y,X,Z){j[0]=Y,X[Z]=W[0],X[Z+1]=W[1],X[Z+2]=W[2],X[Z+3]=W[3]}function z(Y,X,Z){j[0]=Y,X[Z]=W[3],X[Z+1]=W[2],X[Z+2]=W[1],X[Z+3]=W[0]}q.writeFloatLE=K?G:z,q.writeFloatBE=K?z:G;function H(Y,X){return W[0]=Y[X],W[1]=Y[X+1],W[2]=Y[X+2],W[3]=Y[X+3],j[0]}function Q(Y,X){return W[3]=Y[X],W[2]=Y[X+1],W[1]=Y[X+2],W[0]=Y[X+3],j[0]}q.readFloatLE=K?H:Q,q.readFloatBE=K?Q:H})():(function(){function j(K,G,z,H){var Q=G<0?1:0;if(Q&&(G=-G),G===0)K(1/G>0?0:2147483648,z,H);else if(isNaN(G))K(2143289344,z,H);else if(G>34028234663852886e22)K((Q<<31|2139095040)>>>0,z,H);else if(G<11754943508222875e-54)K((Q<<31|Math.round(G/1401298464324817e-60))>>>0,z,H);else{var Y=Math.floor(Math.log(G)/Math.LN2),X=Math.round(G*Math.pow(2,-Y)*8388608)&8388607;K((Q<<31|Y+127<<23|X)>>>0,z,H)}}q.writeFloatLE=j.bind(null,$),q.writeFloatBE=j.bind(null,U);function W(K,G,z){var H=K(G,z),Q=(H>>31)*2+1,Y=H>>>23&255,X=H&8388607;return Y===255?X?NaN:Q*(1/0):Y===0?Q*1401298464324817e-60*X:Q*Math.pow(2,Y-150)*(X+8388608)}q.readFloatLE=W.bind(null,F),q.readFloatBE=W.bind(null,V)})(),typeof Float64Array<"u"?(function(){var j=new Float64Array([-0]),W=new Uint8Array(j.buffer),K=W[7]===128;function G(Y,X,Z){j[0]=Y,X[Z]=W[0],X[Z+1]=W[1],X[Z+2]=W[2],X[Z+3]=W[3],X[Z+4]=W[4],X[Z+5]=W[5],X[Z+6]=W[6],X[Z+7]=W[7]}function z(Y,X,Z){j[0]=Y,X[Z]=W[7],X[Z+1]=W[6],X[Z+2]=W[5],X[Z+3]=W[4],X[Z+4]=W[3],X[Z+5]=W[2],X[Z+6]=W[1],X[Z+7]=W[0]}q.writeDoubleLE=K?G:z,q.writeDoubleBE=K?z:G;function H(Y,X){return W[0]=Y[X],W[1]=Y[X+1],W[2]=Y[X+2],W[3]=Y[X+3],W[4]=Y[X+4],W[5]=Y[X+5],W[6]=Y[X+6],W[7]=Y[X+7],j[0]}function Q(Y,X){return W[7]=Y[X],W[6]=Y[X+1],W[5]=Y[X+2],W[4]=Y[X+3],W[3]=Y[X+4],W[2]=Y[X+5],W[1]=Y[X+6],W[0]=Y[X+7],j[0]}q.readDoubleLE=K?H:Q,q.readDoubleBE=K?Q:H})():(function(){function j(K,G,z,H,Q,Y){var X=H<0?1:0;if(X&&(H=-H),H===0)K(0,Q,Y+G),K(1/H>0?0:2147483648,Q,Y+z);else if(isNaN(H))K(0,Q,Y+G),K(2146959360,Q,Y+z);else if(H>17976931348623157e292)K(0,Q,Y+G),K((X<<31|2146435072)>>>0,Q,Y+z);else{var Z;if(H<22250738585072014e-324)Z=H/5e-324,K(Z>>>0,Q,Y+G),K((X<<31|Z/4294967296)>>>0,Q,Y+z);else{var ne=Math.floor(Math.log(H)/Math.LN2);ne===1024&&(ne=1023),Z=H*Math.pow(2,-ne),K(Z*4503599627370496>>>0,Q,Y+G),K((X<<31|ne+1023<<20|Z*1048576&1048575)>>>0,Q,Y+z)}}}q.writeDoubleLE=j.bind(null,$,0,4),q.writeDoubleBE=j.bind(null,U,4,0);function W(K,G,z,H,Q){var Y=K(H,Q+G),X=K(H,Q+z),Z=(X>>31)*2+1,ne=X>>>20&2047,ee=4294967296*(X&1048575)+Y;return ne===2047?ee?NaN:Z*(1/0):ne===0?Z*5e-324*ee:Z*Math.pow(2,ne-1075)*(ee+4503599627370496)}q.readDoubleLE=W.bind(null,F,0,4),q.readDoubleBE=W.bind(null,V,4,0)})(),q}function $(q,j,W){j[W]=q&255,j[W+1]=q>>>8&255,j[W+2]=q>>>16&255,j[W+3]=q>>>24}function U(q,j,W){j[W]=q>>>24,j[W+1]=q>>>16&255,j[W+2]=q>>>8&255,j[W+3]=q&255}function F(q,j){return(q[j]|q[j+1]<<8|q[j+2]<<16|q[j+3]<<24)>>>0}function V(q,j){return(q[j]<<24|q[j+1]<<16|q[j+2]<<8|q[j+3])>>>0}return float}var inquire_1,hasRequiredInquire;function requireInquire(){if(hasRequiredInquire)return inquire_1;hasRequiredInquire=1,inquire_1=inquire;function inquire(moduleName){try{var mod=eval("quire".replace(/^/,"re"))(moduleName);if(mod&&(mod.length||Object.keys(mod).length))return mod}catch(B){}return null}return inquire_1}var utf8={},hasRequiredUtf8;function requireUtf8(){return hasRequiredUtf8||(hasRequiredUtf8=1,(function(B){var $=B;$.length=function(F){for(var V=0,q=0,j=0;j<F.length;++j)q=F.charCodeAt(j),q<128?V+=1:q<2048?V+=2:(q&64512)===55296&&(F.charCodeAt(j+1)&64512)===56320?(++j,V+=4):V+=3;return V},$.read=function(F,V,q){var j=q-V;if(j<1)return"";for(var W=null,K=[],G=0,z;V<q;)z=F[V++],z<128?K[G++]=z:z>191&&z<224?K[G++]=(z&31)<<6|F[V++]&63:z>239&&z<365?(z=((z&7)<<18|(F[V++]&63)<<12|(F[V++]&63)<<6|F[V++]&63)-65536,K[G++]=55296+(z>>10),K[G++]=56320+(z&1023)):K[G++]=(z&15)<<12|(F[V++]&63)<<6|F[V++]&63,G>8191&&((W||(W=[])).push(String.fromCharCode.apply(String,K)),G=0);return W?(G&&W.push(String.fromCharCode.apply(String,K.slice(0,G))),W.join("")):String.fromCharCode.apply(String,K.slice(0,G))},$.write=function(F,V,q){for(var j=q,W,K,G=0;G<F.length;++G)W=F.charCodeAt(G),W<128?V[q++]=W:W<2048?(V[q++]=W>>6|192,V[q++]=W&63|128):(W&64512)===55296&&((K=F.charCodeAt(G+1))&64512)===56320?(W=65536+((W&1023)<<10)+(K&1023),++G,V[q++]=W>>18|240,V[q++]=W>>12&63|128,V[q++]=W>>6&63|128,V[q++]=W&63|128):(V[q++]=W>>12|224,V[q++]=W>>6&63|128,V[q++]=W&63|128);return q-j}})(utf8)),utf8}var pool_1,hasRequiredPool;function requirePool(){if(hasRequiredPool)return pool_1;hasRequiredPool=1,pool_1=B;function B($,U,F){var V=F||8192,q=V>>>1,j=null,W=V;return function(G){if(G<1||G>q)return $(G);W+G>V&&(j=$(V),W=0);var z=U.call(j,W,W+=G);return W&7&&(W=(W|7)+1),z}}return pool_1}var longbits,hasRequiredLongbits;function requireLongbits(){if(hasRequiredLongbits)return longbits;hasRequiredLongbits=1,longbits=$;var B=requireMinimal();function $(q,j){this.lo=q>>>0,this.hi=j>>>0}var U=$.zero=new $(0,0);U.toNumber=function(){return 0},U.zzEncode=U.zzDecode=function(){return this},U.length=function(){return 1};var F=$.zeroHash="\0\0\0\0\0\0\0\0";$.fromNumber=function(j){if(j===0)return U;var W=j<0;W&&(j=-j);var K=j>>>0,G=(j-K)/4294967296>>>0;return W&&(G=~G>>>0,K=~K>>>0,++K>4294967295&&(K=0,++G>4294967295&&(G=0))),new $(K,G)},$.from=function(j){if(typeof j=="number")return $.fromNumber(j);if(B.isString(j))if(B.Long)j=B.Long.fromString(j);else return $.fromNumber(parseInt(j,10));return j.low||j.high?new $(j.low>>>0,j.high>>>0):U},$.prototype.toNumber=function(j){if(!j&&this.hi>>>31){var W=~this.lo+1>>>0,K=~this.hi>>>0;return W||(K=K+1>>>0),-(W+K*4294967296)}return this.lo+this.hi*4294967296},$.prototype.toLong=function(j){return B.Long?new B.Long(this.lo|0,this.hi|0,!!j):{low:this.lo|0,high:this.hi|0,unsigned:!!j}};var V=String.prototype.charCodeAt;return $.fromHash=function(j){return j===F?U:new $((V.call(j,0)|V.call(j,1)<<8|V.call(j,2)<<16|V.call(j,3)<<24)>>>0,(V.call(j,4)|V.call(j,5)<<8|V.call(j,6)<<16|V.call(j,7)<<24)>>>0)},$.prototype.toHash=function(){return String.fromCharCode(this.lo&255,this.lo>>>8&255,this.lo>>>16&255,this.lo>>>24,this.hi&255,this.hi>>>8&255,this.hi>>>16&255,this.hi>>>24)},$.prototype.zzEncode=function(){var j=this.hi>>31;return this.hi=((this.hi<<1|this.lo>>>31)^j)>>>0,this.lo=(this.lo<<1^j)>>>0,this},$.prototype.zzDecode=function(){var j=-(this.lo&1);return this.lo=((this.lo>>>1|this.hi<<31)^j)>>>0,this.hi=(this.hi>>>1^j)>>>0,this},$.prototype.length=function(){var j=this.lo,W=(this.lo>>>28|this.hi<<4)>>>0,K=this.hi>>>24;return K===0?W===0?j<16384?j<128?1:2:j<2097152?3:4:W<16384?W<128?5:6:W<2097152?7:8:K<128?9:10},longbits}var hasRequiredMinimal;function requireMinimal(){return hasRequiredMinimal||(hasRequiredMinimal=1,(function(B){var $=B;$.asPromise=requireAspromise(),$.base64=requireBase64(),$.EventEmitter=requireEventemitter(),$.float=requireFloat(),$.inquire=requireInquire(),$.utf8=requireUtf8(),$.pool=requirePool(),$.LongBits=requireLongbits(),$.isNode=!!(typeof commonjsGlobal<"u"&&commonjsGlobal&&commonjsGlobal.process&&commonjsGlobal.process.versions&&commonjsGlobal.process.versions.node),$.global=$.isNode&&commonjsGlobal||typeof window<"u"&&window||typeof self<"u"&&self||minimal,$.emptyArray=Object.freeze?Object.freeze([]):[],$.emptyObject=Object.freeze?Object.freeze({}):{},$.isInteger=Number.isInteger||function(q){return typeof q=="number"&&isFinite(q)&&Math.floor(q)===q},$.isString=function(q){return typeof q=="string"||q instanceof String},$.isObject=function(q){return q&&typeof q=="object"},$.isset=$.isSet=function(q,j){var W=q[j];return W!=null&&q.hasOwnProperty(j)?typeof W!="object"||(Array.isArray(W)?W.length:Object.keys(W).length)>0:!1},$.Buffer=(function(){try{var V=$.inquire("buffer").Buffer;return V.prototype.utf8Write?V:null}catch{return null}})(),$._Buffer_from=null,$._Buffer_allocUnsafe=null,$.newBuffer=function(q){return typeof q=="number"?$.Buffer?$._Buffer_allocUnsafe(q):new $.Array(q):$.Buffer?$._Buffer_from(q):typeof Uint8Array>"u"?q:new Uint8Array(q)},$.Array=typeof Uint8Array<"u"?Uint8Array:Array,$.Long=$.global.dcodeIO&&$.global.dcodeIO.Long||$.global.Long||$.inquire("long"),$.key2Re=/^true|false|0|1$/,$.key32Re=/^-?(?:0|[1-9][0-9]*)$/,$.key64Re=/^(?:[\\x00-\\xff]{8}|-?(?:0|[1-9][0-9]*))$/,$.longToHash=function(q){return q?$.LongBits.from(q).toHash():$.LongBits.zeroHash},$.longFromHash=function(q,j){var W=$.LongBits.fromHash(q);return $.Long?$.Long.fromBits(W.lo,W.hi,j):W.toNumber(!!j)};function U(V,q,j){for(var W=Object.keys(q),K=0;K<W.length;++K)(V[W[K]]===void 0||!j)&&(V[W[K]]=q[W[K]]);return V}$.merge=U,$.lcFirst=function(q){return q.charAt(0).toLowerCase()+q.substring(1)};function F(V){function q(j,W){if(!(this instanceof q))return new q(j,W);Object.defineProperty(this,"message",{get:function(){return j}}),Error.captureStackTrace?Error.captureStackTrace(this,q):Object.defineProperty(this,"stack",{value:new Error().stack||""}),W&&U(this,W)}return q.prototype=Object.create(Error.prototype,{constructor:{value:q,writable:!0,enumerable:!1,configurable:!0},name:{get:function(){return V},set:void 0,enumerable:!1,configurable:!0},toString:{value:function(){return this.name+": "+this.message},writable:!0,enumerable:!1,configurable:!0}}),q}$.newError=F,$.ProtocolError=F("ProtocolError"),$.oneOfGetter=function(q){for(var j={},W=0;W<q.length;++W)j[q[W]]=1;return function(){for(var K=Object.keys(this),G=K.length-1;G>-1;--G)if(j[K[G]]===1&&this[K[G]]!==void 0&&this[K[G]]!==null)return K[G]}},$.oneOfSetter=function(q){return function(j){for(var W=0;W<q.length;++W)q[W]!==j&&delete this[q[W]]}},$.toJSONOptions={longs:String,enums:String,bytes:String,json:!0},$._configure=function(){var V=$.Buffer;if(!V){$._Buffer_from=$._Buffer_allocUnsafe=null;return}$._Buffer_from=V.from!==Uint8Array.from&&V.from||function(j,W){return new V(j,W)},$._Buffer_allocUnsafe=V.allocUnsafe||function(j){return new V(j)}}})(minimal)),minimal}var writer$1,hasRequiredWriter$1;function requireWriter$1(){if(hasRequiredWriter$1)return writer$1;hasRequiredWriter$1=1,writer$1=K;var B=requireMinimal(),$,U=B.LongBits,F=B.base64,V=B.utf8;function q(ne,ee,ie){this.fn=ne,this.len=ee,this.next=void 0,this.val=ie}function j(){}function W(ne){this.head=ne.head,this.tail=ne.tail,this.len=ne.len,this.next=ne.states}function K(){this.len=0,this.head=new q(j,0,0),this.tail=this.head,this.states=null}var G=function(){return B.Buffer?function(){return(K.create=function(){return new $})()}:function(){return new K}};K.create=G(),K.alloc=function(ee){return new B.Array(ee)},B.Array!==Array&&(K.alloc=B.pool(K.alloc,B.Array.prototype.subarray)),K.prototype._push=function(ee,ie,se){return this.tail=this.tail.next=new q(ee,ie,se),this.len+=ie,this};function z(ne,ee,ie){ee[ie]=ne&255}function H(ne,ee,ie){for(;ne>127;)ee[ie++]=ne&127|128,ne>>>=7;ee[ie]=ne}function Q(ne,ee){this.len=ne,this.next=void 0,this.val=ee}Q.prototype=Object.create(q.prototype),Q.prototype.fn=H,K.prototype.uint32=function(ee){return this.len+=(this.tail=this.tail.next=new Q((ee=ee>>>0)<128?1:ee<16384?2:ee<2097152?3:ee<268435456?4:5,ee)).len,this},K.prototype.int32=function(ee){return ee<0?this._push(Y,10,U.fromNumber(ee)):this.uint32(ee)},K.prototype.sint32=function(ee){return this.uint32((ee<<1^ee>>31)>>>0)};function Y(ne,ee,ie){for(;ne.hi;)ee[ie++]=ne.lo&127|128,ne.lo=(ne.lo>>>7|ne.hi<<25)>>>0,ne.hi>>>=7;for(;ne.lo>127;)ee[ie++]=ne.lo&127|128,ne.lo=ne.lo>>>7;ee[ie++]=ne.lo}K.prototype.uint64=function(ee){var ie=U.from(ee);return this._push(Y,ie.length(),ie)},K.prototype.int64=K.prototype.uint64,K.prototype.sint64=function(ee){var ie=U.from(ee).zzEncode();return this._push(Y,ie.length(),ie)},K.prototype.bool=function(ee){return this._push(z,1,ee?1:0)};function X(ne,ee,ie){ee[ie]=ne&255,ee[ie+1]=ne>>>8&255,ee[ie+2]=ne>>>16&255,ee[ie+3]=ne>>>24}K.prototype.fixed32=function(ee){return this._push(X,4,ee>>>0)},K.prototype.sfixed32=K.prototype.fixed32,K.prototype.fixed64=function(ee){var ie=U.from(ee);return this._push(X,4,ie.lo)._push(X,4,ie.hi)},K.prototype.sfixed64=K.prototype.fixed64,K.prototype.float=function(ee){return this._push(B.float.writeFloatLE,4,ee)},K.prototype.double=function(ee){return this._push(B.float.writeDoubleLE,8,ee)};var Z=B.Array.prototype.set?function(ee,ie,se){ie.set(ee,se)}:function(ee,ie,se){for(var te=0;te<ee.length;++te)ie[se+te]=ee[te]};return K.prototype.bytes=function(ee){var ie=ee.length>>>0;if(!ie)return this._push(z,1,0);if(B.isString(ee)){var se=K.alloc(ie=F.length(ee));F.decode(ee,se,0),ee=se}return this.uint32(ie)._push(Z,ie,ee)},K.prototype.string=function(ee){var ie=V.length(ee);return ie?this.uint32(ie)._push(V.write,ie,ee):this._push(z,1,0)},K.prototype.fork=function(){return this.states=new W(this),this.head=this.tail=new q(j,0,0),this.len=0,this},K.prototype.reset=function(){return this.states?(this.head=this.states.head,this.tail=this.states.tail,this.len=this.states.len,this.states=this.states.next):(this.head=this.tail=new q(j,0,0),this.len=0),this},K.prototype.ldelim=function(){var ee=this.head,ie=this.tail,se=this.len;return this.reset().uint32(se),se&&(this.tail.next=ee.next,this.tail=ie,this.len+=se),this},K.prototype.finish=function(){for(var ee=this.head.next,ie=this.constructor.alloc(this.len),se=0;ee;)ee.fn(ee.val,ie,se),se+=ee.len,ee=ee.next;return ie},K._configure=function(ne){$=ne,K.create=G(),$._configure()},writer$1}var writer_buffer,hasRequiredWriter_buffer;function requireWriter_buffer(){if(hasRequiredWriter_buffer)return writer_buffer;hasRequiredWriter_buffer=1,writer_buffer=U;var B=requireWriter$1();(U.prototype=Object.create(B.prototype)).constructor=U;var $=requireMinimal();function U(){B.call(this)}U._configure=function(){U.alloc=$._Buffer_allocUnsafe,U.writeBytesBuffer=$.Buffer&&$.Buffer.prototype instanceof Uint8Array&&$.Buffer.prototype.set.name==="set"?function(q,j,W){j.set(q,W)}:function(q,j,W){if(q.copy)q.copy(j,W,0,q.length);else for(var K=0;K<q.length;)j[W++]=q[K++]}},U.prototype.bytes=function(q){$.isString(q)&&(q=$._Buffer_from(q,"base64"));var j=q.length>>>0;return this.uint32(j),j&&this._push(U.writeBytesBuffer,j,q),this};function F(V,q,j){V.length<40?$.utf8.write(V,q,j):q.utf8Write?q.utf8Write(V,j):q.write(V,j)}return U.prototype.string=function(q){var j=$.Buffer.byteLength(q);return this.uint32(j),j&&this._push(F,j,q),this},U._configure(),writer_buffer}var reader,hasRequiredReader;function requireReader(){if(hasRequiredReader)return reader;hasRequiredReader=1,reader=q;var B=requireMinimal(),$,U=B.LongBits,F=B.utf8;function V(H,Q){return RangeError("index out of range: "+H.pos+" + "+(Q||1)+" > "+H.len)}function q(H){this.buf=H,this.pos=0,this.len=H.length}var j=typeof Uint8Array<"u"?function(Q){if(Q instanceof Uint8Array||Array.isArray(Q))return new q(Q);throw Error("illegal buffer")}:function(Q){if(Array.isArray(Q))return new q(Q);throw Error("illegal buffer")},W=function(){return B.Buffer?function(Y){return(q.create=function(Z){return B.Buffer.isBuffer(Z)?new $(Z):j(Z)})(Y)}:j};q.create=W(),q.prototype._slice=B.Array.prototype.subarray||B.Array.prototype.slice,q.prototype.uint32=(function(){var Q=4294967295;return function(){if(Q=(this.buf[this.pos]&127)>>>0,this.buf[this.pos++]<128||(Q=(Q|(this.buf[this.pos]&127)<<7)>>>0,this.buf[this.pos++]<128)||(Q=(Q|(this.buf[this.pos]&127)<<14)>>>0,this.buf[this.pos++]<128)||(Q=(Q|(this.buf[this.pos]&127)<<21)>>>0,this.buf[this.pos++]<128)||(Q=(Q|(this.buf[this.pos]&15)<<28)>>>0,this.buf[this.pos++]<128))return Q;if((this.pos+=5)>this.len)throw this.pos=this.len,V(this,10);return Q}})(),q.prototype.int32=function(){return this.uint32()|0},q.prototype.sint32=function(){var Q=this.uint32();return Q>>>1^-(Q&1)|0};function K(){var H=new U(0,0),Q=0;if(this.len-this.pos>4){for(;Q<4;++Q)if(H.lo=(H.lo|(this.buf[this.pos]&127)<<Q*7)>>>0,this.buf[this.pos++]<128)return H;if(H.lo=(H.lo|(this.buf[this.pos]&127)<<28)>>>0,H.hi=(H.hi|(this.buf[this.pos]&127)>>4)>>>0,this.buf[this.pos++]<128)return H;Q=0}else{for(;Q<3;++Q){if(this.pos>=this.len)throw V(this);if(H.lo=(H.lo|(this.buf[this.pos]&127)<<Q*7)>>>0,this.buf[this.pos++]<128)return H}return H.lo=(H.lo|(this.buf[this.pos++]&127)<<Q*7)>>>0,H}if(this.len-this.pos>4){for(;Q<5;++Q)if(H.hi=(H.hi|(this.buf[this.pos]&127)<<Q*7+3)>>>0,this.buf[this.pos++]<128)return H}else for(;Q<5;++Q){if(this.pos>=this.len)throw V(this);if(H.hi=(H.hi|(this.buf[this.pos]&127)<<Q*7+3)>>>0,this.buf[this.pos++]<128)return H}throw Error("invalid varint encoding")}q.prototype.bool=function(){return this.uint32()!==0};function G(H,Q){return(H[Q-4]|H[Q-3]<<8|H[Q-2]<<16|H[Q-1]<<24)>>>0}q.prototype.fixed32=function(){if(this.pos+4>this.len)throw V(this,4);return G(this.buf,this.pos+=4)},q.prototype.sfixed32=function(){if(this.pos+4>this.len)throw V(this,4);return G(this.buf,this.pos+=4)|0};function z(){if(this.pos+8>this.len)throw V(this,8);return new U(G(this.buf,this.pos+=4),G(this.buf,this.pos+=4))}return q.prototype.float=function(){if(this.pos+4>this.len)throw V(this,4);var Q=B.float.readFloatLE(this.buf,this.pos);return this.pos+=4,Q},q.prototype.double=function(){if(this.pos+8>this.len)throw V(this,4);var Q=B.float.readDoubleLE(this.buf,this.pos);return this.pos+=8,Q},q.prototype.bytes=function(){var Q=this.uint32(),Y=this.pos,X=this.pos+Q;if(X>this.len)throw V(this,Q);if(this.pos+=Q,Array.isArray(this.buf))return this.buf.slice(Y,X);if(Y===X){var Z=B.Buffer;return Z?Z.alloc(0):new this.buf.constructor(0)}return this._slice.call(this.buf,Y,X)},q.prototype.string=function(){var Q=this.bytes();return F.read(Q,0,Q.length)},q.prototype.skip=function(Q){if(typeof Q=="number"){if(this.pos+Q>this.len)throw V(this,Q);this.pos+=Q}else do if(this.pos>=this.len)throw V(this);while(this.buf[this.pos++]&128);return this},q.prototype.skipType=function(H){switch(H){case 0:this.skip();break;case 1:this.skip(8);break;case 2:this.skip(this.uint32());break;case 3:for(;(H=this.uint32()&7)!==4;)this.skipType(H);break;case 5:this.skip(4);break;default:throw Error("invalid wire type "+H+" at offset "+this.pos)}return this},q._configure=function(H){$=H,q.create=W(),$._configure();var Q=B.Long?"toLong":"toNumber";B.merge(q.prototype,{int64:function(){return K.call(this)[Q](!1)},uint64:function(){return K.call(this)[Q](!0)},sint64:function(){return K.call(this).zzDecode()[Q](!1)},fixed64:function(){return z.call(this)[Q](!0)},sfixed64:function(){return z.call(this)[Q](!1)}})},reader}var reader_buffer,hasRequiredReader_buffer;function requireReader_buffer(){if(hasRequiredReader_buffer)return reader_buffer;hasRequiredReader_buffer=1,reader_buffer=U;var B=requireReader();(U.prototype=Object.create(B.prototype)).constructor=U;var $=requireMinimal();function U(F){B.call(this,F)}return U._configure=function(){$.Buffer&&(U.prototype._slice=$.Buffer.prototype.slice)},U.prototype.string=function(){var V=this.uint32();return this.buf.utf8Slice?this.buf.utf8Slice(this.pos,this.pos=Math.min(this.pos+V,this.len)):this.buf.toString("utf-8",this.pos,this.pos=Math.min(this.pos+V,this.len))},U._configure(),reader_buffer}var rpc={},service$1,hasRequiredService$1;function requireService$1(){if(hasRequiredService$1)return service$1;hasRequiredService$1=1,service$1=$;var B=requireMinimal();($.prototype=Object.create(B.EventEmitter.prototype)).constructor=$;function $(U,F,V){if(typeof U!="function")throw TypeError("rpcImpl must be a function");B.EventEmitter.call(this),this.rpcImpl=U,this.requestDelimited=!!F,this.responseDelimited=!!V}return $.prototype.rpcCall=function U(F,V,q,j,W){if(!j)throw TypeError("request must be specified");var K=this;if(!W)return B.asPromise(U,K,F,V,q,j);if(!K.rpcImpl){setTimeout(function(){W(Error("already ended"))},0);return}try{return K.rpcImpl(F,V[K.requestDelimited?"encodeDelimited":"encode"](j).finish(),function(z,H){if(z)return K.emit("error",z,F),W(z);if(H===null){K.end(!0);return}if(!(H instanceof q))try{H=q[K.responseDelimited?"decodeDelimited":"decode"](H)}catch(Q){return K.emit("error",Q,F),W(Q)}return K.emit("data",H,F),W(null,H)})}catch(G){K.emit("error",G,F),setTimeout(function(){W(G)},0);return}},$.prototype.end=function(F){return this.rpcImpl&&(F||this.rpcImpl(null,null,null),this.rpcImpl=null,this.emit("end").off()),this},service$1}var hasRequiredRpc;function requireRpc(){return hasRequiredRpc||(hasRequiredRpc=1,(function(B){var $=B;$.Service=requireService$1()})(rpc)),rpc}var roots,hasRequiredRoots;function requireRoots(){return hasRequiredRoots||(hasRequiredRoots=1,roots={}),roots}var hasRequiredIndexMinimal;function requireIndexMinimal(){return hasRequiredIndexMinimal||(hasRequiredIndexMinimal=1,(function(B){var $=B;$.build="minimal",$.Writer=requireWriter$1(),$.BufferWriter=requireWriter_buffer(),$.Reader=requireReader(),$.BufferReader=requireReader_buffer(),$.util=requireMinimal(),$.rpc=requireRpc(),$.roots=requireRoots(),$.configure=U;function U(){$.util._configure(),$.Writer._configure($.BufferWriter),$.Reader._configure($.BufferReader)}U()})(indexMinimal)),indexMinimal}var types={},util={exports:{}},codegen_1,hasRequiredCodegen;function requireCodegen(){if(hasRequiredCodegen)return codegen_1;hasRequiredCodegen=1,codegen_1=B;function B($,U){typeof $=="string"&&(U=$,$=void 0);var F=[];function V(j){if(typeof j!="string"){var W=q();if(B.verbose&&console.log("codegen: "+W),W="return "+W,j){for(var K=Object.keys(j),G=new Array(K.length+1),z=new Array(K.length),H=0;H<K.length;)G[H]=K[H],z[H]=j[K[H++]];return G[H]=W,Function.apply(null,G).apply(null,z)}return Function(W)()}for(var Q=new Array(arguments.length-1),Y=0;Y<Q.length;)Q[Y]=arguments[++Y];if(Y=0,j=j.replace(/%([%dfijs])/g,function(Z,ne){var ee=Q[Y++];switch(ne){case"d":case"f":return String(Number(ee));case"i":return String(Math.floor(ee));case"j":return JSON.stringify(ee);case"s":return String(ee)}return"%"}),Y!==Q.length)throw Error("parameter count mismatch");return F.push(j),V}function q(j){return"function "+(j||U||"")+"("+($&&$.join(",")||"")+`){
  `+F.join(`
  `)+`
}`}return V.toString=q,V}return B.verbose=!1,codegen_1}var fetch_1,hasRequiredFetch;function requireFetch(){if(hasRequiredFetch)return fetch_1;hasRequiredFetch=1,fetch_1=F;var B=requireAspromise(),$=requireInquire(),U=$("fs");function F(V,q,j){return typeof q=="function"?(j=q,q={}):q||(q={}),j?!q.xhr&&U&&U.readFile?U.readFile(V,function(K,G){return K&&typeof XMLHttpRequest<"u"?F.xhr(V,q,j):K?j(K):j(null,q.binary?G:G.toString("utf8"))}):F.xhr(V,q,j):B(F,this,V,q)}return F.xhr=function(q,j,W){var K=new XMLHttpRequest;K.onreadystatechange=function(){if(K.readyState===4){if(K.status!==0&&K.status!==200)return W(Error("status "+K.status));if(j.binary){var z=K.response;if(!z){z=[];for(var H=0;H<K.responseText.length;++H)z.push(K.responseText.charCodeAt(H)&255)}return W(null,typeof Uint8Array<"u"?new Uint8Array(z):z)}return W(null,K.responseText)}},j.binary&&("overrideMimeType"in K&&K.overrideMimeType("text/plain; charset=x-user-defined"),K.responseType="arraybuffer"),K.open("GET",q),K.send()},fetch_1}var path={},hasRequiredPath;function requirePath(){return hasRequiredPath||(hasRequiredPath=1,(function(B){var $=B,U=$.isAbsolute=function(q){return/^(?:\/|\w+:)/.test(q)},F=$.normalize=function(q){q=q.replace(/\\/g,"/").replace(/\/{2,}/g,"/");var j=q.split("/"),W=U(q),K="";W&&(K=j.shift()+"/");for(var G=0;G<j.length;)j[G]===".."?G>0&&j[G-1]!==".."?j.splice(--G,2):W?j.splice(G,1):++G:j[G]==="."?j.splice(G,1):++G;return K+j.join("/")};$.resolve=function(q,j,W){return W||(j=F(j)),U(j)?j:(W||(q=F(q)),(q=q.replace(/(?:\/|^)[^/]+$/,"")).length?F(q+"/"+j):j)}})(path)),path}var namespace,hasRequiredNamespace;function requireNamespace(){if(hasRequiredNamespace)return namespace;hasRequiredNamespace=1,namespace=K;var B=requireObject();((K.prototype=Object.create(B.prototype)).constructor=K).className="Namespace";var $=requireField(),U=requireUtil(),F=requireOneof(),V,q,j;K.fromJSON=function(H,Q){return new K(H,Q.options).addJSON(Q.nested)};function W(z,H){if(z&&z.length){for(var Q={},Y=0;Y<z.length;++Y)Q[z[Y].name]=z[Y].toJSON(H);return Q}}K.arrayToJSON=W,K.isReservedId=function(H,Q){if(H){for(var Y=0;Y<H.length;++Y)if(typeof H[Y]!="string"&&H[Y][0]<=Q&&H[Y][1]>Q)return!0}return!1},K.isReservedName=function(H,Q){if(H){for(var Y=0;Y<H.length;++Y)if(H[Y]===Q)return!0}return!1};function K(z,H){B.call(this,z,H),this.nested=void 0,this._nestedArray=null}function G(z){return z._nestedArray=null,z}return Object.defineProperty(K.prototype,"nestedArray",{get:function(){return this._nestedArray||(this._nestedArray=U.toArray(this.nested))}}),K.prototype.toJSON=function(H){return U.toObject(["options",this.options,"nested",W(this.nestedArray,H)])},K.prototype.addJSON=function(H){var Q=this;if(H)for(var Y=Object.keys(H),X=0,Z;X<Y.length;++X)Z=H[Y[X]],Q.add((Z.fields!==void 0?V.fromJSON:Z.values!==void 0?j.fromJSON:Z.methods!==void 0?q.fromJSON:Z.id!==void 0?$.fromJSON:K.fromJSON)(Y[X],Z));return this},K.prototype.get=function(H){return this.nested&&this.nested[H]||null},K.prototype.getEnum=function(H){if(this.nested&&this.nested[H]instanceof j)return this.nested[H].values;throw Error("no such enum: "+H)},K.prototype.add=function(H){if(!(H instanceof $&&H.extend!==void 0||H instanceof V||H instanceof F||H instanceof j||H instanceof q||H instanceof K))throw TypeError("object must be a valid nested object");if(!this.nested)this.nested={};else{var Q=this.get(H.name);if(Q)if(Q instanceof K&&H instanceof K&&!(Q instanceof V||Q instanceof q)){for(var Y=Q.nestedArray,X=0;X<Y.length;++X)H.add(Y[X]);this.remove(Q),this.nested||(this.nested={}),H.setOptions(Q.options,!0)}else throw Error("duplicate name '"+H.name+"' in "+this)}return this.nested[H.name]=H,this instanceof V||this instanceof q||this instanceof j||this instanceof $||H._edition||(H._edition=H._defaultEdition),H.onAdd(this),G(this)},K.prototype.remove=function(H){if(!(H instanceof B))throw TypeError("object must be a ReflectionObject");if(H.parent!==this)throw Error(H+" is not a member of "+this);return delete this.nested[H.name],Object.keys(this.nested).length||(this.nested=void 0),H.onRemove(this),G(this)},K.prototype.define=function(H,Q){if(U.isString(H))H=H.split(".");else if(!Array.isArray(H))throw TypeError("illegal path");if(H&&H.length&&H[0]==="")throw Error("path must be relative");for(var Y=this;H.length>0;){var X=H.shift();if(Y.nested&&Y.nested[X]){if(Y=Y.nested[X],!(Y instanceof K))throw Error("path conflicts with non-namespace objects")}else Y.add(Y=new K(X))}return Q&&Y.addJSON(Q),Y},K.prototype.resolveAll=function(){var H=this.nestedArray,Q=0;for(this.resolve();Q<H.length;)H[Q]instanceof K?H[Q++].resolveAll():H[Q++].resolve();return this},K.prototype._resolveFeaturesRecursive=function(H){return H=this._edition||H,B.prototype._resolveFeaturesRecursive.call(this,H),this.nestedArray.forEach(Q=>{Q._resolveFeaturesRecursive(H)}),this},K.prototype.lookup=function(H,Q,Y){if(typeof Q=="boolean"?(Y=Q,Q=void 0):Q&&!Array.isArray(Q)&&(Q=[Q]),U.isString(H)&&H.length){if(H===".")return this.root;H=H.split(".")}else if(!H.length)return this;if(H[0]==="")return this.root.lookup(H.slice(1),Q);var X=this.get(H[0]);if(X){if(H.length===1){if(!Q||Q.indexOf(X.constructor)>-1)return X}else if(X instanceof K&&(X=X.lookup(H.slice(1),Q,!0)))return X}else for(var Z=0;Z<this.nestedArray.length;++Z)if(this._nestedArray[Z]instanceof K&&(X=this._nestedArray[Z].lookup(H,Q,!0)))return X;return this.parent===null||Y?null:this.parent.lookup(H,Q)},K.prototype.lookupType=function(H){var Q=this.lookup(H,[V]);if(!Q)throw Error("no such type: "+H);return Q},K.prototype.lookupEnum=function(H){var Q=this.lookup(H,[j]);if(!Q)throw Error("no such Enum '"+H+"' in "+this);return Q},K.prototype.lookupTypeOrEnum=function(H){var Q=this.lookup(H,[V,j]);if(!Q)throw Error("no such Type or Enum '"+H+"' in "+this);return Q},K.prototype.lookupService=function(H){var Q=this.lookup(H,[q]);if(!Q)throw Error("no such Service '"+H+"' in "+this);return Q},K._configure=function(z,H,Q){V=z,q=H,j=Q},namespace}var mapfield,hasRequiredMapfield;function requireMapfield(){if(hasRequiredMapfield)return mapfield;hasRequiredMapfield=1,mapfield=F;var B=requireField();((F.prototype=Object.create(B.prototype)).constructor=F).className="MapField";var $=requireTypes(),U=requireUtil();function F(V,q,j,W,K,G){if(B.call(this,V,q,W,void 0,void 0,K,G),!U.isString(j))throw TypeError("keyType must be a string");this.keyType=j,this.resolvedKeyType=null,this.map=!0}return F.fromJSON=function(q,j){return new F(q,j.id,j.keyType,j.type,j.options,j.comment)},F.prototype.toJSON=function(q){var j=q?!!q.keepComments:!1;return U.toObject(["keyType",this.keyType,"type",this.type,"id",this.id,"extend",this.extend,"options",this.options,"comment",j?this.comment:void 0])},F.prototype.resolve=function(){if(this.resolved)return this;if($.mapKey[this.keyType]===void 0)throw Error("invalid key type: "+this.keyType);return B.prototype.resolve.call(this)},F.d=function(q,j,W){return typeof W=="function"?W=U.decorateType(W).name:W&&typeof W=="object"&&(W=U.decorateEnum(W).name),function(G,z){U.decorateType(G.constructor).add(new F(z,q,j,W))}},mapfield}var method,hasRequiredMethod;function requireMethod(){if(hasRequiredMethod)return method;hasRequiredMethod=1,method=U;var B=requireObject();((U.prototype=Object.create(B.prototype)).constructor=U).className="Method";var $=requireUtil();function U(F,V,q,j,W,K,G,z,H){if($.isObject(W)?(G=W,W=K=void 0):$.isObject(K)&&(G=K,K=void 0),!(V===void 0||$.isString(V)))throw TypeError("type must be a string");if(!$.isString(q))throw TypeError("requestType must be a string");if(!$.isString(j))throw TypeError("responseType must be a string");B.call(this,F,G),this.type=V||"rpc",this.requestType=q,this.requestStream=W?!0:void 0,this.responseType=j,this.responseStream=K?!0:void 0,this.resolvedRequestType=null,this.resolvedResponseType=null,this.comment=z,this.parsedOptions=H}return U.fromJSON=function(V,q){return new U(V,q.type,q.requestType,q.responseType,q.requestStream,q.responseStream,q.options,q.comment,q.parsedOptions)},U.prototype.toJSON=function(V){var q=V?!!V.keepComments:!1;return $.toObject(["type",this.type!=="rpc"&&this.type||void 0,"requestType",this.requestType,"requestStream",this.requestStream,"responseType",this.responseType,"responseStream",this.responseStream,"options",this.options,"comment",q?this.comment:void 0,"parsedOptions",this.parsedOptions])},U.prototype.resolve=function(){return this.resolved?this:(this.resolvedRequestType=this.parent.lookupType(this.requestType),this.resolvedResponseType=this.parent.lookupType(this.responseType),B.prototype.resolve.call(this))},method}var service,hasRequiredService;function requireService(){if(hasRequiredService)return service;hasRequiredService=1,service=V;var B=requireNamespace();((V.prototype=Object.create(B.prototype)).constructor=V).className="Service";var $=requireMethod(),U=requireUtil(),F=requireRpc();function V(j,W){B.call(this,j,W),this.methods={},this._methodsArray=null}V.fromJSON=function(W,K){var G=new V(W,K.options);if(K.methods)for(var z=Object.keys(K.methods),H=0;H<z.length;++H)G.add($.fromJSON(z[H],K.methods[z[H]]));return K.nested&&G.addJSON(K.nested),K.edition&&(G._edition=K.edition),G.comment=K.comment,G._defaultEdition="proto3",G},V.prototype.toJSON=function(W){var K=B.prototype.toJSON.call(this,W),G=W?!!W.keepComments:!1;return U.toObject(["edition",this._editionToJSON(),"options",K&&K.options||void 0,"methods",B.arrayToJSON(this.methodsArray,W)||{},"nested",K&&K.nested||void 0,"comment",G?this.comment:void 0])},Object.defineProperty(V.prototype,"methodsArray",{get:function(){return this._methodsArray||(this._methodsArray=U.toArray(this.methods))}});function q(j){return j._methodsArray=null,j}return V.prototype.get=function(W){return this.methods[W]||B.prototype.get.call(this,W)},V.prototype.resolveAll=function(){B.prototype.resolve.call(this);for(var W=this.methodsArray,K=0;K<W.length;++K)W[K].resolve();return this},V.prototype._resolveFeaturesRecursive=function(W){return W=this._edition||W,B.prototype._resolveFeaturesRecursive.call(this,W),this.methodsArray.forEach(K=>{K._resolveFeaturesRecursive(W)}),this},V.prototype.add=function(W){if(this.get(W.name))throw Error("duplicate name '"+W.name+"' in "+this);return W instanceof $?(this.methods[W.name]=W,W.parent=this,q(this)):B.prototype.add.call(this,W)},V.prototype.remove=function(W){if(W instanceof $){if(this.methods[W.name]!==W)throw Error(W+" is not a member of "+this);return delete this.methods[W.name],W.parent=null,q(this)}return B.prototype.remove.call(this,W)},V.prototype.create=function(W,K,G){for(var z=new F.Service(W,K,G),H=0,Q;H<this.methodsArray.length;++H){var Y=U.lcFirst((Q=this._methodsArray[H]).resolve().name).replace(/[^$\w_]/g,"");z[Y]=U.codegen(["r","c"],U.isReserved(Y)?Y+"_":Y)("return this.rpcCall(m,q,s,r,c)")({m:Q,q:Q.resolvedRequestType.ctor,s:Q.resolvedResponseType.ctor})}return z},service}var message,hasRequiredMessage;function requireMessage(){if(hasRequiredMessage)return message;hasRequiredMessage=1,message=$;var B=requireMinimal();function $(U){if(U)for(var F=Object.keys(U),V=0;V<F.length;++V)this[F[V]]=U[F[V]]}return $.create=function(F){return this.$type.create(F)},$.encode=function(F,V){return this.$type.encode(F,V)},$.encodeDelimited=function(F,V){return this.$type.encodeDelimited(F,V)},$.decode=function(F){return this.$type.decode(F)},$.decodeDelimited=function(F){return this.$type.decodeDelimited(F)},$.verify=function(F){return this.$type.verify(F)},$.fromObject=function(F){return this.$type.fromObject(F)},$.toObject=function(F,V){return this.$type.toObject(F,V)},$.prototype.toJSON=function(){return this.$type.toObject(this,B.toJSONOptions)},message}var decoder_1,hasRequiredDecoder;function requireDecoder(){if(hasRequiredDecoder)return decoder_1;hasRequiredDecoder=1,decoder_1=V;var B=require_enum(),$=requireTypes(),U=requireUtil();function F(q){return"missing required '"+q.name+"'"}function V(q){for(var j=U.codegen(["r","l","e"],q.name+"$decode")("if(!(r instanceof Reader))")("r=Reader.create(r)")("var c=l===undefined?r.len:r.pos+l,m=new this.ctor"+(q.fieldsArray.filter(function(Q){return Q.map}).length?",k,value":""))("while(r.pos<c){")("var t=r.uint32()")("if(t===e)")("break")("switch(t>>>3){"),W=0;W<q.fieldsArray.length;++W){var K=q._fieldsArray[W].resolve(),G=K.resolvedType instanceof B?"int32":K.type,z="m"+U.safeProp(K.name);j("case %i: {",K.id),K.map?(j("if(%s===util.emptyObject)",z)("%s={}",z)("var c2 = r.uint32()+r.pos"),$.defaults[K.keyType]!==void 0?j("k=%j",$.defaults[K.keyType]):j("k=null"),$.defaults[G]!==void 0?j("value=%j",$.defaults[G]):j("value=null"),j("while(r.pos<c2){")("var tag2=r.uint32()")("switch(tag2>>>3){")("case 1: k=r.%s(); break",K.keyType)("case 2:"),$.basic[G]===void 0?j("value=types[%i].decode(r,r.uint32())",W):j("value=r.%s()",G),j("break")("default:")("r.skipType(tag2&7)")("break")("}")("}"),$.long[K.keyType]!==void 0?j('%s[typeof k==="object"?util.longToHash(k):k]=value',z):j("%s[k]=value",z)):K.repeated?(j("if(!(%s&&%s.length))",z,z)("%s=[]",z),$.packed[G]!==void 0&&j("if((t&7)===2){")("var c2=r.uint32()+r.pos")("while(r.pos<c2)")("%s.push(r.%s())",z,G)("}else"),$.basic[G]===void 0?j(K.delimited?"%s.push(types[%i].decode(r,undefined,((t&~7)|4)))":"%s.push(types[%i].decode(r,r.uint32()))",z,W):j("%s.push(r.%s())",z,G)):$.basic[G]===void 0?j(K.delimited?"%s=types[%i].decode(r,undefined,((t&~7)|4))":"%s=types[%i].decode(r,r.uint32())",z,W):j("%s=r.%s()",z,G),j("break")("}")}for(j("default:")("r.skipType(t&7)")("break")("}")("}"),W=0;W<q._fieldsArray.length;++W){var H=q._fieldsArray[W];H.required&&j("if(!m.hasOwnProperty(%j))",H.name)("throw util.ProtocolError(%j,{instance:m})",F(H))}return j("return m")}return decoder_1}var verifier_1,hasRequiredVerifier;function requireVerifier(){if(hasRequiredVerifier)return verifier_1;hasRequiredVerifier=1,verifier_1=q;var B=require_enum(),$=requireUtil();function U(j,W){return j.name+": "+W+(j.repeated&&W!=="array"?"[]":j.map&&W!=="object"?"{k:"+j.keyType+"}":"")+" expected"}function F(j,W,K,G){if(W.resolvedType)if(W.resolvedType instanceof B){j("switch(%s){",G)("default:")("return%j",U(W,"enum value"));for(var z=Object.keys(W.resolvedType.values),H=0;H<z.length;++H)j("case %i:",W.resolvedType.values[z[H]]);j("break")("}")}else j("{")("var e=types[%i].verify(%s);",K,G)("if(e)")("return%j+e",W.name+".")("}");else switch(W.type){case"int32":case"uint32":case"sint32":case"fixed32":case"sfixed32":j("if(!util.isInteger(%s))",G)("return%j",U(W,"integer"));break;case"int64":case"uint64":case"sint64":case"fixed64":case"sfixed64":j("if(!util.isInteger(%s)&&!(%s&&util.isInteger(%s.low)&&util.isInteger(%s.high)))",G,G,G,G)("return%j",U(W,"integer|Long"));break;case"float":case"double":j('if(typeof %s!=="number")',G)("return%j",U(W,"number"));break;case"bool":j('if(typeof %s!=="boolean")',G)("return%j",U(W,"boolean"));break;case"string":j("if(!util.isString(%s))",G)("return%j",U(W,"string"));break;case"bytes":j('if(!(%s&&typeof %s.length==="number"||util.isString(%s)))',G,G,G)("return%j",U(W,"buffer"));break}return j}function V(j,W,K){switch(W.keyType){case"int32":case"uint32":case"sint32":case"fixed32":case"sfixed32":j("if(!util.key32Re.test(%s))",K)("return%j",U(W,"integer key"));break;case"int64":case"uint64":case"sint64":case"fixed64":case"sfixed64":j("if(!util.key64Re.test(%s))",K)("return%j",U(W,"integer|Long key"));break;case"bool":j("if(!util.key2Re.test(%s))",K)("return%j",U(W,"boolean key"));break}return j}function q(j){var W=$.codegen(["m"],j.name+"$verify")('if(typeof m!=="object"||m===null)')("return%j","object expected"),K=j.oneofsArray,G={};K.length&&W("var p={}");for(var z=0;z<j.fieldsArray.length;++z){var H=j._fieldsArray[z].resolve(),Q="m"+$.safeProp(H.name);if(H.optional&&W("if(%s!=null&&m.hasOwnProperty(%j)){",Q,H.name),H.map)W("if(!util.isObject(%s))",Q)("return%j",U(H,"object"))("var k=Object.keys(%s)",Q)("for(var i=0;i<k.length;++i){"),V(W,H,"k[i]"),F(W,H,z,Q+"[k[i]]")("}");else if(H.repeated)W("if(!Array.isArray(%s))",Q)("return%j",U(H,"array"))("for(var i=0;i<%s.length;++i){",Q),F(W,H,z,Q+"[i]")("}");else{if(H.partOf){var Y=$.safeProp(H.partOf.name);G[H.partOf.name]===1&&W("if(p%s===1)",Y)("return%j",H.partOf.name+": multiple values"),G[H.partOf.name]=1,W("p%s=1",Y)}F(W,H,z,Q)}H.optional&&W("}")}return W("return null")}return verifier_1}var converter={},hasRequiredConverter;function requireConverter(){return hasRequiredConverter||(hasRequiredConverter=1,(function(B){var $=B,U=require_enum(),F=requireUtil();function V(j,W,K,G){var z=!1;if(W.resolvedType)if(W.resolvedType instanceof U){j("switch(d%s){",G);for(var H=W.resolvedType.values,Q=Object.keys(H),Y=0;Y<Q.length;++Y)H[Q[Y]]===W.typeDefault&&!z&&(j("default:")('if(typeof(d%s)==="number"){m%s=d%s;break}',G,G,G),W.repeated||j("break"),z=!0),j("case%j:",Q[Y])("case %i:",H[Q[Y]])("m%s=%j",G,H[Q[Y]])("break");j("}")}else j('if(typeof d%s!=="object")',G)("throw TypeError(%j)",W.fullName+": object expected")("m%s=types[%i].fromObject(d%s)",G,K,G);else{var X=!1;switch(W.type){case"double":case"float":j("m%s=Number(d%s)",G,G);break;case"uint32":case"fixed32":j("m%s=d%s>>>0",G,G);break;case"int32":case"sint32":case"sfixed32":j("m%s=d%s|0",G,G);break;case"uint64":X=!0;case"int64":case"sint64":case"fixed64":case"sfixed64":j("if(util.Long)")("(m%s=util.Long.fromValue(d%s)).unsigned=%j",G,G,X)('else if(typeof d%s==="string")',G)("m%s=parseInt(d%s,10)",G,G)('else if(typeof d%s==="number")',G)("m%s=d%s",G,G)('else if(typeof d%s==="object")',G)("m%s=new util.LongBits(d%s.low>>>0,d%s.high>>>0).toNumber(%s)",G,G,G,X?"true":"");break;case"bytes":j('if(typeof d%s==="string")',G)("util.base64.decode(d%s,m%s=util.newBuffer(util.base64.length(d%s)),0)",G,G,G)("else if(d%s.length >= 0)",G)("m%s=d%s",G,G);break;case"string":j("m%s=String(d%s)",G,G);break;case"bool":j("m%s=Boolean(d%s)",G,G);break}}return j}$.fromObject=function(W){var K=W.fieldsArray,G=F.codegen(["d"],W.name+"$fromObject")("if(d instanceof this.ctor)")("return d");if(!K.length)return G("return new this.ctor");G("var m=new this.ctor");for(var z=0;z<K.length;++z){var H=K[z].resolve(),Q=F.safeProp(H.name);H.map?(G("if(d%s){",Q)('if(typeof d%s!=="object")',Q)("throw TypeError(%j)",H.fullName+": object expected")("m%s={}",Q)("for(var ks=Object.keys(d%s),i=0;i<ks.length;++i){",Q),V(G,H,z,Q+"[ks[i]]")("}")("}")):H.repeated?(G("if(d%s){",Q)("if(!Array.isArray(d%s))",Q)("throw TypeError(%j)",H.fullName+": array expected")("m%s=[]",Q)("for(var i=0;i<d%s.length;++i){",Q),V(G,H,z,Q+"[i]")("}")("}")):(H.resolvedType instanceof U||G("if(d%s!=null){",Q),V(G,H,z,Q),H.resolvedType instanceof U||G("}"))}return G("return m")};function q(j,W,K,G){if(W.resolvedType)W.resolvedType instanceof U?j("d%s=o.enums===String?(types[%i].values[m%s]===undefined?m%s:types[%i].values[m%s]):m%s",G,K,G,G,K,G,G):j("d%s=types[%i].toObject(m%s,o)",G,K,G);else{var z=!1;switch(W.type){case"double":case"float":j("d%s=o.json&&!isFinite(m%s)?String(m%s):m%s",G,G,G,G);break;case"uint64":z=!0;case"int64":case"sint64":case"fixed64":case"sfixed64":j('if(typeof m%s==="number")',G)("d%s=o.longs===String?String(m%s):m%s",G,G,G)("else")("d%s=o.longs===String?util.Long.prototype.toString.call(m%s):o.longs===Number?new util.LongBits(m%s.low>>>0,m%s.high>>>0).toNumber(%s):m%s",G,G,G,G,z?"true":"",G);break;case"bytes":j("d%s=o.bytes===String?util.base64.encode(m%s,0,m%s.length):o.bytes===Array?Array.prototype.slice.call(m%s):m%s",G,G,G,G,G);break;default:j("d%s=m%s",G,G);break}}return j}$.toObject=function(W){var K=W.fieldsArray.slice().sort(F.compareFieldsById);if(!K.length)return F.codegen()("return {}");for(var G=F.codegen(["m","o"],W.name+"$toObject")("if(!o)")("o={}")("var d={}"),z=[],H=[],Q=[],Y=0;Y<K.length;++Y)K[Y].partOf||(K[Y].resolve().repeated?z:K[Y].map?H:Q).push(K[Y]);if(z.length){for(G("if(o.arrays||o.defaults){"),Y=0;Y<z.length;++Y)G("d%s=[]",F.safeProp(z[Y].name));G("}")}if(H.length){for(G("if(o.objects||o.defaults){"),Y=0;Y<H.length;++Y)G("d%s={}",F.safeProp(H[Y].name));G("}")}if(Q.length){for(G("if(o.defaults){"),Y=0;Y<Q.length;++Y){var X=Q[Y],Z=F.safeProp(X.name);if(X.resolvedType instanceof U)G("d%s=o.enums===String?%j:%j",Z,X.resolvedType.valuesById[X.typeDefault],X.typeDefault);else if(X.long)G("if(util.Long){")("var n=new util.Long(%i,%i,%j)",X.typeDefault.low,X.typeDefault.high,X.typeDefault.unsigned)("d%s=o.longs===String?n.toString():o.longs===Number?n.toNumber():n",Z)("}else")("d%s=o.longs===String?%j:%i",Z,X.typeDefault.toString(),X.typeDefault.toNumber());else if(X.bytes){var ne="["+Array.prototype.slice.call(X.typeDefault).join(",")+"]";G("if(o.bytes===String)d%s=%j",Z,String.fromCharCode.apply(String,X.typeDefault))("else{")("d%s=%s",Z,ne)("if(o.bytes!==Array)d%s=util.newBuffer(d%s)",Z,Z)("}")}else G("d%s=%j",Z,X.typeDefault)}G("}")}var ee=!1;for(Y=0;Y<K.length;++Y){var X=K[Y],ie=W._fieldsArray.indexOf(X),Z=F.safeProp(X.name);X.map?(ee||(ee=!0,G("var ks2")),G("if(m%s&&(ks2=Object.keys(m%s)).length){",Z,Z)("d%s={}",Z)("for(var j=0;j<ks2.length;++j){"),q(G,X,ie,Z+"[ks2[j]]")("}")):X.repeated?(G("if(m%s&&m%s.length){",Z,Z)("d%s=[]",Z)("for(var j=0;j<m%s.length;++j){",Z),q(G,X,ie,Z+"[j]")("}")):(G("if(m%s!=null&&m.hasOwnProperty(%j)){",Z,X.name),q(G,X,ie,Z),X.partOf&&G("if(o.oneofs)")("d%s=%j",F.safeProp(X.partOf.name),X.name)),G("}")}return G("return d")}})(converter)),converter}var wrappers={},hasRequiredWrappers;function requireWrappers(){return hasRequiredWrappers||(hasRequiredWrappers=1,(function(B){var $=B,U=requireMessage();$[".google.protobuf.Any"]={fromObject:function(F){if(F&&F["@type"]){var V=F["@type"].substring(F["@type"].lastIndexOf("/")+1),q=this.lookup(V);if(q){var j=F["@type"].charAt(0)==="."?F["@type"].slice(1):F["@type"];return j.indexOf("/")===-1&&(j="/"+j),this.create({type_url:j,value:q.encode(q.fromObject(F)).finish()})}}return this.fromObject(F)},toObject:function(F,V){var q="type.googleapis.com/",j="",W="";if(V&&V.json&&F.type_url&&F.value){W=F.type_url.substring(F.type_url.lastIndexOf("/")+1),j=F.type_url.substring(0,F.type_url.lastIndexOf("/")+1);var K=this.lookup(W);K&&(F=K.decode(F.value))}if(!(F instanceof this.ctor)&&F instanceof U){var G=F.$type.toObject(F,V),z=F.$type.fullName[0]==="."?F.$type.fullName.slice(1):F.$type.fullName;return j===""&&(j=q),W=j+z,G["@type"]=W,G}return this.toObject(F,V)}}})(wrappers)),wrappers}var type,hasRequiredType;function requireType(){if(hasRequiredType)return type;hasRequiredType=1,type=Z;var B=requireNamespace();((Z.prototype=Object.create(B.prototype)).constructor=Z).className="Type";var $=require_enum(),U=requireOneof(),F=requireField(),V=requireMapfield(),q=requireService(),j=requireMessage(),W=requireReader(),K=requireWriter$1(),G=requireUtil(),z=requireEncoder(),H=requireDecoder(),Q=requireVerifier(),Y=requireConverter(),X=requireWrappers();function Z(ee,ie){B.call(this,ee,ie),this.fields={},this.oneofs=void 0,this.extensions=void 0,this.reserved=void 0,this.group=void 0,this._fieldsById=null,this._fieldsArray=null,this._oneofsArray=null,this._ctor=null}Object.defineProperties(Z.prototype,{fieldsById:{get:function(){if(this._fieldsById)return this._fieldsById;this._fieldsById={};for(var ee=Object.keys(this.fields),ie=0;ie<ee.length;++ie){var se=this.fields[ee[ie]],te=se.id;if(this._fieldsById[te])throw Error("duplicate id "+te+" in "+this);this._fieldsById[te]=se}return this._fieldsById}},fieldsArray:{get:function(){return this._fieldsArray||(this._fieldsArray=G.toArray(this.fields))}},oneofsArray:{get:function(){return this._oneofsArray||(this._oneofsArray=G.toArray(this.oneofs))}},ctor:{get:function(){return this._ctor||(this.ctor=Z.generateConstructor(this)())},set:function(ee){var ie=ee.prototype;ie instanceof j||((ee.prototype=new j).constructor=ee,G.merge(ee.prototype,ie)),ee.$type=ee.prototype.$type=this,G.merge(ee,j,!0),this._ctor=ee;for(var se=0;se<this.fieldsArray.length;++se)this._fieldsArray[se].resolve();var te={};for(se=0;se<this.oneofsArray.length;++se)te[this._oneofsArray[se].resolve().name]={get:G.oneOfGetter(this._oneofsArray[se].oneof),set:G.oneOfSetter(this._oneofsArray[se].oneof)};se&&Object.defineProperties(ee.prototype,te)}}}),Z.generateConstructor=function(ie){for(var se=G.codegen(["p"],ie.name),te=0,re;te<ie.fieldsArray.length;++te)(re=ie._fieldsArray[te]).map?se("this%s={}",G.safeProp(re.name)):re.repeated&&se("this%s=[]",G.safeProp(re.name));return se("if(p)for(var ks=Object.keys(p),i=0;i<ks.length;++i)if(p[ks[i]]!=null)")("this[ks[i]]=p[ks[i]]")};function ne(ee){return ee._fieldsById=ee._fieldsArray=ee._oneofsArray=null,delete ee.encode,delete ee.decode,delete ee.verify,ee}return Z.fromJSON=function(ie,se){var te=new Z(ie,se.options);te.extensions=se.extensions,te.reserved=se.reserved;for(var re=Object.keys(se.fields),ae=0;ae<re.length;++ae)te.add((typeof se.fields[re[ae]].keyType<"u"?V.fromJSON:F.fromJSON)(re[ae],se.fields[re[ae]]));if(se.oneofs)for(re=Object.keys(se.oneofs),ae=0;ae<re.length;++ae)te.add(U.fromJSON(re[ae],se.oneofs[re[ae]]));if(se.nested)for(re=Object.keys(se.nested),ae=0;ae<re.length;++ae){var ce=se.nested[re[ae]];te.add((ce.id!==void 0?F.fromJSON:ce.fields!==void 0?Z.fromJSON:ce.values!==void 0?$.fromJSON:ce.methods!==void 0?q.fromJSON:B.fromJSON)(re[ae],ce))}return se.extensions&&se.extensions.length&&(te.extensions=se.extensions),se.reserved&&se.reserved.length&&(te.reserved=se.reserved),se.group&&(te.group=!0),se.comment&&(te.comment=se.comment),se.edition&&(te._edition=se.edition),te._defaultEdition="proto3",te},Z.prototype.toJSON=function(ie){var se=B.prototype.toJSON.call(this,ie),te=ie?!!ie.keepComments:!1;return G.toObject(["edition",this._editionToJSON(),"options",se&&se.options||void 0,"oneofs",B.arrayToJSON(this.oneofsArray,ie),"fields",B.arrayToJSON(this.fieldsArray.filter(function(re){return!re.declaringField}),ie)||{},"extensions",this.extensions&&this.extensions.length?this.extensions:void 0,"reserved",this.reserved&&this.reserved.length?this.reserved:void 0,"group",this.group||void 0,"nested",se&&se.nested||void 0,"comment",te?this.comment:void 0])},Z.prototype.resolveAll=function(){B.prototype.resolveAll.call(this);var ie=this.oneofsArray;for(te=0;te<ie.length;)ie[te++].resolve();for(var se=this.fieldsArray,te=0;te<se.length;)se[te++].resolve();return this},Z.prototype._resolveFeaturesRecursive=function(ie){return ie=this._edition||ie,B.prototype._resolveFeaturesRecursive.call(this,ie),this.oneofsArray.forEach(se=>{se._resolveFeatures(ie)}),this.fieldsArray.forEach(se=>{se._resolveFeatures(ie)}),this},Z.prototype.get=function(ie){return this.fields[ie]||this.oneofs&&this.oneofs[ie]||this.nested&&this.nested[ie]||null},Z.prototype.add=function(ie){if(this.get(ie.name))throw Error("duplicate name '"+ie.name+"' in "+this);if(ie instanceof F&&ie.extend===void 0){if(this._fieldsById?this._fieldsById[ie.id]:this.fieldsById[ie.id])throw Error("duplicate id "+ie.id+" in "+this);if(this.isReservedId(ie.id))throw Error("id "+ie.id+" is reserved in "+this);if(this.isReservedName(ie.name))throw Error("name '"+ie.name+"' is reserved in "+this);return ie.parent&&ie.parent.remove(ie),this.fields[ie.name]=ie,ie.message=this,ie.onAdd(this),ne(this)}return ie instanceof U?(this.oneofs||(this.oneofs={}),this.oneofs[ie.name]=ie,ie.onAdd(this),ne(this)):B.prototype.add.call(this,ie)},Z.prototype.remove=function(ie){if(ie instanceof F&&ie.extend===void 0){if(!this.fields||this.fields[ie.name]!==ie)throw Error(ie+" is not a member of "+this);return delete this.fields[ie.name],ie.parent=null,ie.onRemove(this),ne(this)}if(ie instanceof U){if(!this.oneofs||this.oneofs[ie.name]!==ie)throw Error(ie+" is not a member of "+this);return delete this.oneofs[ie.name],ie.parent=null,ie.onRemove(this),ne(this)}return B.prototype.remove.call(this,ie)},Z.prototype.isReservedId=function(ie){return B.isReservedId(this.reserved,ie)},Z.prototype.isReservedName=function(ie){return B.isReservedName(this.reserved,ie)},Z.prototype.create=function(ie){return new this.ctor(ie)},Z.prototype.setup=function(){for(var ie=this.fullName,se=[],te=0;te<this.fieldsArray.length;++te)se.push(this._fieldsArray[te].resolve().resolvedType);this.encode=z(this)({Writer:K,types:se,util:G}),this.decode=H(this)({Reader:W,types:se,util:G}),this.verify=Q(this)({types:se,util:G}),this.fromObject=Y.fromObject(this)({types:se,util:G}),this.toObject=Y.toObject(this)({types:se,util:G});var re=X[ie];if(re){var ae=Object.create(this);ae.fromObject=this.fromObject,this.fromObject=re.fromObject.bind(ae),ae.toObject=this.toObject,this.toObject=re.toObject.bind(ae)}return this},Z.prototype.encode=function(ie,se){return this.setup().encode(ie,se)},Z.prototype.encodeDelimited=function(ie,se){return this.encode(ie,se&&se.len?se.fork():se).ldelim()},Z.prototype.decode=function(ie,se){return this.setup().decode(ie,se)},Z.prototype.decodeDelimited=function(ie){return ie instanceof W||(ie=W.create(ie)),this.decode(ie,ie.uint32())},Z.prototype.verify=function(ie){return this.setup().verify(ie)},Z.prototype.fromObject=function(ie){return this.setup().fromObject(ie)},Z.prototype.toObject=function(ie,se){return this.setup().toObject(ie,se)},Z.d=function(ie){return function(te){G.decorateType(te,ie)}},type}var root,hasRequiredRoot;function requireRoot(){if(hasRequiredRoot)return root;hasRequiredRoot=1,root=K;var B=requireNamespace();((K.prototype=Object.create(B.prototype)).constructor=K).className="Root";var $=requireField(),U=require_enum(),F=requireOneof(),V=requireUtil(),q,j,W;function K(Q){B.call(this,"",Q),this.deferred=[],this.files=[],this._edition="proto2"}K.fromJSON=function(Y,X){return X||(X=new K),Y.options&&X.setOptions(Y.options),X.addJSON(Y.nested).resolveAll()},K.prototype.resolvePath=V.path.resolve,K.prototype.fetch=V.fetch;function G(){}K.prototype.load=function Q(Y,X,Z){typeof X=="function"&&(Z=X,X=void 0);var ne=this;if(!Z)return V.asPromise(Q,ne,Y,X);var ee=Z===G;function ie(de,ue){if(Z){if(ee)throw de;var oe=Z;Z=null,ue&&ue.resolveAll(),oe(de,ue)}}function se(de){var ue=de.lastIndexOf("google/protobuf/");if(ue>-1){var oe=de.substring(ue);if(oe in W)return oe}return null}function te(de,ue){try{if(V.isString(ue)&&ue.charAt(0)==="{"&&(ue=JSON.parse(ue)),!V.isString(ue))ne.setOptions(ue.options).addJSON(ue.nested);else{j.filename=de;var oe=j(ue,ne,X),me,be=0;if(oe.imports)for(;be<oe.imports.length;++be)(me=se(oe.imports[be])||ne.resolvePath(de,oe.imports[be]))&&re(me);if(oe.weakImports)for(be=0;be<oe.weakImports.length;++be)(me=se(oe.weakImports[be])||ne.resolvePath(de,oe.weakImports[be]))&&re(me,!0)}}catch(ge){ie(ge)}!ee&&!ae&&ie(null,ne)}function re(de,ue){if(de=se(de)||de,!(ne.files.indexOf(de)>-1)){if(ne.files.push(de),de in W){ee?te(de,W[de]):(++ae,setTimeout(function(){--ae,te(de,W[de])}));return}if(ee){var oe;try{oe=V.fs.readFileSync(de).toString("utf8")}catch(me){ue||ie(me);return}te(de,oe)}else++ae,ne.fetch(de,function(me,be){if(--ae,!!Z){if(me){ue?ae||ie(null,ne):ie(me);return}te(de,be)}})}}var ae=0;V.isString(Y)&&(Y=[Y]);for(var ce=0,le;ce<Y.length;++ce)(le=ne.resolvePath("",Y[ce]))&&re(le);return ne.resolveAll(),ee||ae||ie(null,ne),ne},K.prototype.loadSync=function(Y,X){if(!V.isNode)throw Error("not supported");return this.load(Y,X,G)},K.prototype.resolveAll=function(){if(this.deferred.length)throw Error("unresolvable extensions: "+this.deferred.map(function(Y){return"'extend "+Y.extend+"' in "+Y.parent.fullName}).join(", "));return B.prototype.resolveAll.call(this)};var z=/^[A-Z]/;function H(Q,Y){var X=Y.parent.lookup(Y.extend);if(X){var Z=new $(Y.fullName,Y.id,Y.type,Y.rule,void 0,Y.options);return X.get(Z.name)||(Z.declaringField=Y,Y.extensionField=Z,X.add(Z)),!0}return!1}return K.prototype._handleAdd=function(Y){if(Y instanceof $)Y.extend!==void 0&&!Y.extensionField&&(H(this,Y)||this.deferred.push(Y));else if(Y instanceof U)z.test(Y.name)&&(Y.parent[Y.name]=Y.values);else if(!(Y instanceof F)){if(Y instanceof q)for(var X=0;X<this.deferred.length;)H(this,this.deferred[X])?this.deferred.splice(X,1):++X;for(var Z=0;Z<Y.nestedArray.length;++Z)this._handleAdd(Y._nestedArray[Z]);z.test(Y.name)&&(Y.parent[Y.name]=Y)}},K.prototype._handleRemove=function(Y){if(Y instanceof $){if(Y.extend!==void 0)if(Y.extensionField)Y.extensionField.parent.remove(Y.extensionField),Y.extensionField=null;else{var X=this.deferred.indexOf(Y);X>-1&&this.deferred.splice(X,1)}}else if(Y instanceof U)z.test(Y.name)&&delete Y.parent[Y.name];else if(Y instanceof B){for(var Z=0;Z<Y.nestedArray.length;++Z)this._handleRemove(Y._nestedArray[Z]);z.test(Y.name)&&delete Y.parent[Y.name]}},K._configure=function(Q,Y,X){q=Q,j=Y,W=X},root}var hasRequiredUtil;function requireUtil(){if(hasRequiredUtil)return util.exports;hasRequiredUtil=1;var B=util.exports=requireMinimal(),$=requireRoots(),U,F;B.codegen=requireCodegen(),B.fetch=requireFetch(),B.path=requirePath(),B.fs=B.inquire("fs"),B.toArray=function(G){if(G){for(var z=Object.keys(G),H=new Array(z.length),Q=0;Q<z.length;)H[Q]=G[z[Q++]];return H}return[]},B.toObject=function(G){for(var z={},H=0;H<G.length;){var Q=G[H++],Y=G[H++];Y!==void 0&&(z[Q]=Y)}return z};var V=/\\/g,q=/"/g;B.isReserved=function(G){return/^(?:do|if|in|for|let|new|try|var|case|else|enum|eval|false|null|this|true|void|with|break|catch|class|const|super|throw|while|yield|delete|export|import|public|return|static|switch|typeof|default|extends|finally|package|private|continue|debugger|function|arguments|interface|protected|implements|instanceof)$/.test(G)},B.safeProp=function(G){return!/^[$\w_]+$/.test(G)||B.isReserved(G)?'["'+G.replace(V,"\\\\").replace(q,'\\"')+'"]':"."+G},B.ucFirst=function(G){return G.charAt(0).toUpperCase()+G.substring(1)};var j=/_([a-z])/g;B.camelCase=function(G){return G.substring(0,1)+G.substring(1).replace(j,function(z,H){return H.toUpperCase()})},B.compareFieldsById=function(G,z){return G.id-z.id},B.decorateType=function(G,z){if(G.$type)return z&&G.$type.name!==z&&(B.decorateRoot.remove(G.$type),G.$type.name=z,B.decorateRoot.add(G.$type)),G.$type;U||(U=requireType());var H=new U(z||G.name);return B.decorateRoot.add(H),H.ctor=G,Object.defineProperty(G,"$type",{value:H,enumerable:!1}),Object.defineProperty(G.prototype,"$type",{value:H,enumerable:!1}),H};var W=0;return B.decorateEnum=function(G){if(G.$type)return G.$type;F||(F=require_enum());var z=new F("Enum"+W++,G);return B.decorateRoot.add(z),Object.defineProperty(G,"$type",{value:z,enumerable:!1}),z},B.setProperty=function(G,z,H,Q){function Y(X,Z,ne){var ee=Z.shift();if(ee==="__proto__"||ee==="prototype")return X;if(Z.length>0)X[ee]=Y(X[ee]||{},Z,ne);else{var ie=X[ee];if(ie&&Q)return X;ie&&(ne=[].concat(ie).concat(ne)),X[ee]=ne}return X}if(typeof G!="object")throw TypeError("dst must be an object");if(!z)throw TypeError("path must be specified");return z=z.split("."),Y(G,z,H)},Object.defineProperty(B,"decorateRoot",{get:function(){return $.decorated||($.decorated=new(requireRoot()))}}),util.exports}var hasRequiredTypes;function requireTypes(){return hasRequiredTypes||(hasRequiredTypes=1,(function(B){var $=B,U=requireUtil(),F=["double","float","int32","uint32","sint32","fixed32","sfixed32","int64","uint64","sint64","fixed64","sfixed64","bool","string","bytes"];function V(q,j){var W=0,K={};for(j|=0;W<q.length;)K[F[W+j]]=q[W++];return K}$.basic=V([1,5,0,0,0,5,5,0,0,0,1,1,0,2,2]),$.defaults=V([0,0,0,0,0,0,0,0,0,0,0,0,!1,"",U.emptyArray,null]),$.long=V([0,0,0,1,1],7),$.mapKey=V([0,0,0,5,5,0,0,0,1,1,0,2],2),$.packed=V([1,5,0,0,0,5,5,0,0,0,1,1,0])})(types)),types}var field,hasRequiredField;function requireField(){if(hasRequiredField)return field;hasRequiredField=1,field=j;var B=requireObject();((j.prototype=Object.create(B.prototype)).constructor=j).className="Field";var $=require_enum(),U=requireTypes(),F=requireUtil(),V,q=/^required|optional|repeated$/;j.fromJSON=function(K,G){var z=new j(K,G.id,G.type,G.rule,G.extend,G.options,G.comment);return G.edition&&(z._edition=G.edition),z._defaultEdition="proto3",z};function j(W,K,G,z,H,Q,Y){if(F.isObject(z)?(Y=H,Q=z,z=H=void 0):F.isObject(H)&&(Y=Q,Q=H,H=void 0),B.call(this,W,Q),!F.isInteger(K)||K<0)throw TypeError("id must be a non-negative integer");if(!F.isString(G))throw TypeError("type must be a string");if(z!==void 0&&!q.test(z=z.toString().toLowerCase()))throw TypeError("rule must be a string rule");if(H!==void 0&&!F.isString(H))throw TypeError("extend must be a string");z==="proto3_optional"&&(z="optional"),this.rule=z&&z!=="optional"?z:void 0,this.type=G,this.id=K,this.extend=H||void 0,this.repeated=z==="repeated",this.map=!1,this.message=null,this.partOf=null,this.typeDefault=null,this.defaultValue=null,this.long=F.Long?U.long[G]!==void 0:!1,this.bytes=G==="bytes",this.resolvedType=null,this.extensionField=null,this.declaringField=null,this.comment=Y}return Object.defineProperty(j.prototype,"required",{get:function(){return this._features.field_presence==="LEGACY_REQUIRED"}}),Object.defineProperty(j.prototype,"optional",{get:function(){return!this.required}}),Object.defineProperty(j.prototype,"delimited",{get:function(){return this.resolvedType instanceof V&&this._features.message_encoding==="DELIMITED"}}),Object.defineProperty(j.prototype,"packed",{get:function(){return this._features.repeated_field_encoding==="PACKED"}}),Object.defineProperty(j.prototype,"hasPresence",{get:function(){return this.repeated||this.map?!1:this.partOf||this.declaringField||this.extensionField||this._features.field_presence!=="IMPLICIT"}}),j.prototype.setOption=function(K,G,z){return B.prototype.setOption.call(this,K,G,z)},j.prototype.toJSON=function(K){var G=K?!!K.keepComments:!1;return F.toObject(["edition",this._editionToJSON(),"rule",this.rule!=="optional"&&this.rule||void 0,"type",this.type,"id",this.id,"extend",this.extend,"options",this.options,"comment",G?this.comment:void 0])},j.prototype.resolve=function(){if(this.resolved)return this;if((this.typeDefault=U.defaults[this.type])===void 0?(this.resolvedType=(this.declaringField?this.declaringField.parent:this.parent).lookupTypeOrEnum(this.type),this.resolvedType instanceof V?this.typeDefault=null:this.typeDefault=this.resolvedType.values[Object.keys(this.resolvedType.values)[0]]):this.options&&this.options.proto3_optional&&(this.typeDefault=null),this.options&&this.options.default!=null&&(this.typeDefault=this.options.default,this.resolvedType instanceof $&&typeof this.typeDefault=="string"&&(this.typeDefault=this.resolvedType.values[this.typeDefault])),this.options&&(this.options.packed!==void 0&&this.resolvedType&&!(this.resolvedType instanceof $)&&delete this.options.packed,Object.keys(this.options).length||(this.options=void 0)),this.long)this.typeDefault=F.Long.fromNumber(this.typeDefault,this.type.charAt(0)==="u"),Object.freeze&&Object.freeze(this.typeDefault);else if(this.bytes&&typeof this.typeDefault=="string"){var K;F.base64.test(this.typeDefault)?F.base64.decode(this.typeDefault,K=F.newBuffer(F.base64.length(this.typeDefault)),0):F.utf8.write(this.typeDefault,K=F.newBuffer(F.utf8.length(this.typeDefault)),0),this.typeDefault=K}return this.map?this.defaultValue=F.emptyObject:this.repeated?this.defaultValue=F.emptyArray:this.defaultValue=this.typeDefault,this.parent instanceof V&&(this.parent.ctor.prototype[this.name]=this.defaultValue),B.prototype.resolve.call(this)},j.prototype._inferLegacyProtoFeatures=function(K){if(K!=="proto2"&&K!=="proto3")return{};var G={};return this.resolve(),this.rule==="required"&&(G.field_presence="LEGACY_REQUIRED"),this.resolvedType instanceof V&&this.resolvedType.group&&(G.message_encoding="DELIMITED"),this.getOption("packed")===!0?G.repeated_field_encoding="PACKED":this.getOption("packed")===!1&&(G.repeated_field_encoding="EXPANDED"),G},j.prototype._resolveFeatures=function(K){return B.prototype._resolveFeatures.call(this,this._edition||K)},j.d=function(K,G,z,H){return typeof G=="function"?G=F.decorateType(G).name:G&&typeof G=="object"&&(G=F.decorateEnum(G).name),function(Y,X){F.decorateType(Y.constructor).add(new j(X,K,G,z,{default:H}))}},j._configure=function(K){V=K},field}var oneof,hasRequiredOneof;function requireOneof(){if(hasRequiredOneof)return oneof;hasRequiredOneof=1,oneof=F;var B=requireObject();((F.prototype=Object.create(B.prototype)).constructor=F).className="OneOf";var $=requireField(),U=requireUtil();function F(q,j,W,K){if(Array.isArray(j)||(W=j,j=void 0),B.call(this,q,W),!(j===void 0||Array.isArray(j)))throw TypeError("fieldNames must be an Array");this.oneof=j||[],this.fieldsArray=[],this.comment=K}F.fromJSON=function(j,W){return new F(j,W.oneof,W.options,W.comment)},F.prototype.toJSON=function(j){var W=j?!!j.keepComments:!1;return U.toObject(["options",this.options,"oneof",this.oneof,"comment",W?this.comment:void 0])};function V(q){if(q.parent)for(var j=0;j<q.fieldsArray.length;++j)q.fieldsArray[j].parent||q.parent.add(q.fieldsArray[j])}return F.prototype.add=function(j){if(!(j instanceof $))throw TypeError("field must be a Field");return j.parent&&j.parent!==this.parent&&j.parent.remove(j),this.oneof.push(j.name),this.fieldsArray.push(j),j.partOf=this,V(this),this},F.prototype.remove=function(j){if(!(j instanceof $))throw TypeError("field must be a Field");var W=this.fieldsArray.indexOf(j);if(W<0)throw Error(j+" is not a member of "+this);return this.fieldsArray.splice(W,1),W=this.oneof.indexOf(j.name),W>-1&&this.oneof.splice(W,1),j.partOf=null,this},F.prototype.onAdd=function(j){B.prototype.onAdd.call(this,j);for(var W=this,K=0;K<this.oneof.length;++K){var G=j.get(this.oneof[K]);G&&!G.partOf&&(G.partOf=W,W.fieldsArray.push(G))}V(this)},F.prototype.onRemove=function(j){for(var W=0,K;W<this.fieldsArray.length;++W)(K=this.fieldsArray[W]).parent&&K.parent.remove(K);B.prototype.onRemove.call(this,j)},Object.defineProperty(F.prototype,"isProto3Optional",{get:function(){if(this.fieldsArray==null||this.fieldsArray.length!==1)return!1;var q=this.fieldsArray[0];return q.options!=null&&q.options.proto3_optional===!0}}),F.d=function(){for(var j=new Array(arguments.length),W=0;W<arguments.length;)j[W]=arguments[W++];return function(G,z){U.decorateType(G.constructor).add(new F(z,j)),Object.defineProperty(G,z,{get:U.oneOfGetter(j),set:U.oneOfSetter(j)})}},oneof}var object,hasRequiredObject;function requireObject(){if(hasRequiredObject)return object;hasRequiredObject=1,object=j,j.className="ReflectionObject";const B=requireOneof();var $=requireUtil(),U,F={enum_type:"OPEN",field_presence:"EXPLICIT",json_format:"ALLOW",message_encoding:"LENGTH_PREFIXED",repeated_field_encoding:"PACKED",utf8_validation:"VERIFY"},V={enum_type:"CLOSED",field_presence:"EXPLICIT",json_format:"LEGACY_BEST_EFFORT",message_encoding:"LENGTH_PREFIXED",repeated_field_encoding:"EXPANDED",utf8_validation:"NONE"},q={enum_type:"OPEN",field_presence:"IMPLICIT",json_format:"ALLOW",message_encoding:"LENGTH_PREFIXED",repeated_field_encoding:"PACKED",utf8_validation:"VERIFY"};function j(W,K){if(!$.isString(W))throw TypeError("name must be a string");if(K&&!$.isObject(K))throw TypeError("options must be an object");this.options=K,this.parsedOptions=null,this.name=W,this._edition=null,this._defaultEdition="proto2",this._features={},this.parent=null,this.resolved=!1,this.comment=null,this.filename=null}return Object.defineProperties(j.prototype,{root:{get:function(){for(var W=this;W.parent!==null;)W=W.parent;return W}},fullName:{get:function(){for(var W=[this.name],K=this.parent;K;)W.unshift(K.name),K=K.parent;return W.join(".")}}}),j.prototype.toJSON=function(){throw Error()},j.prototype.onAdd=function(K){this.parent&&this.parent!==K&&this.parent.remove(this),this.parent=K,this.resolved=!1;var G=K.root;G instanceof U&&G._handleAdd(this)},j.prototype.onRemove=function(K){var G=K.root;G instanceof U&&G._handleRemove(this),this.parent=null,this.resolved=!1},j.prototype.resolve=function(){return this.resolved?this:(this instanceof U&&(this._resolveFeaturesRecursive(this._edition),this.resolved=!0),this)},j.prototype._resolveFeaturesRecursive=function(K){return this._resolveFeatures(this._edition||K)},j.prototype._resolveFeatures=function(K){var G={};if(!K)throw new Error("Unknown edition for "+this.fullName);var z=Object.assign(this.options?Object.assign({},this.options.features):{},this._inferLegacyProtoFeatures(K));if(this._edition){if(K==="proto2")G=Object.assign({},V);else if(K==="proto3")G=Object.assign({},q);else if(K==="2023")G=Object.assign({},F);else throw new Error("Unknown edition: "+K);this._features=Object.assign(G,z||{});return}if(this.partOf instanceof B){var H=Object.assign({},this.partOf._features);this._features=Object.assign(H,z||{})}else if(!this.declaringField)if(this.parent){var Q=Object.assign({},this.parent._features);this._features=Object.assign(Q,z||{})}else throw new Error("Unable to find a parent for "+this.fullName);this.extensionField&&(this.extensionField._features=this._features)},j.prototype._inferLegacyProtoFeatures=function(){return{}},j.prototype.getOption=function(K){if(this.options)return this.options[K]},j.prototype.setOption=function(K,G,z){return this.options||(this.options={}),/^features\./.test(K)?$.setProperty(this.options,K,G,z):(!z||this.options[K]===void 0)&&(this.getOption(K)!==G&&(this.resolved=!1),this.options[K]=G),this},j.prototype.setParsedOption=function(K,G,z){this.parsedOptions||(this.parsedOptions=[]);var H=this.parsedOptions;if(z){var Q=H.find(function(Z){return Object.prototype.hasOwnProperty.call(Z,K)});if(Q){var Y=Q[K];$.setProperty(Y,z,G)}else Q={},Q[K]=$.setProperty({},z,G),H.push(Q)}else{var X={};X[K]=G,H.push(X)}return this},j.prototype.setOptions=function(K,G){if(K)for(var z=Object.keys(K),H=0;H<z.length;++H)this.setOption(z[H],K[z[H]],G);return this},j.prototype.toString=function(){var K=this.constructor.className,G=this.fullName;return G.length?K+" "+G:K},j.prototype._editionToJSON=function(){if(!(!this._edition||this._edition==="proto3"))return this._edition},j._configure=function(W){U=W},object}var _enum,hasRequired_enum;function require_enum(){if(hasRequired_enum)return _enum;hasRequired_enum=1,_enum=F;var B=requireObject();((F.prototype=Object.create(B.prototype)).constructor=F).className="Enum";var $=requireNamespace(),U=requireUtil();function F(V,q,j,W,K,G){if(B.call(this,V,j),q&&typeof q!="object")throw TypeError("values must be an object");if(this.valuesById={},this.values=Object.create(this.valuesById),this.comment=W,this.comments=K||{},this.valuesOptions=G,this._valuesFeatures={},this.reserved=void 0,q)for(var z=Object.keys(q),H=0;H<z.length;++H)typeof q[z[H]]=="number"&&(this.valuesById[this.values[z[H]]=q[z[H]]]=z[H])}return F.prototype._resolveFeatures=function(q){return q=this._edition||q,B.prototype._resolveFeatures.call(this,q),Object.keys(this.values).forEach(j=>{var W=Object.assign({},this._features);this._valuesFeatures[j]=Object.assign(W,this.valuesOptions&&this.valuesOptions[j]&&this.valuesOptions[j].features)}),this},F.fromJSON=function(q,j){var W=new F(q,j.values,j.options,j.comment,j.comments);return W.reserved=j.reserved,j.edition&&(W._edition=j.edition),W._defaultEdition="proto3",W},F.prototype.toJSON=function(q){var j=q?!!q.keepComments:!1;return U.toObject(["edition",this._editionToJSON(),"options",this.options,"valuesOptions",this.valuesOptions,"values",this.values,"reserved",this.reserved&&this.reserved.length?this.reserved:void 0,"comment",j?this.comment:void 0,"comments",j?this.comments:void 0])},F.prototype.add=function(q,j,W,K){if(!U.isString(q))throw TypeError("name must be a string");if(!U.isInteger(j))throw TypeError("id must be an integer");if(this.values[q]!==void 0)throw Error("duplicate name '"+q+"' in "+this);if(this.isReservedId(j))throw Error("id "+j+" is reserved in "+this);if(this.isReservedName(q))throw Error("name '"+q+"' is reserved in "+this);if(this.valuesById[j]!==void 0){if(!(this.options&&this.options.allow_alias))throw Error("duplicate id "+j+" in "+this);this.values[q]=j}else this.valuesById[this.values[q]=j]=q;return K&&(this.valuesOptions===void 0&&(this.valuesOptions={}),this.valuesOptions[q]=K||null),this.comments[q]=W||null,this},F.prototype.remove=function(q){if(!U.isString(q))throw TypeError("name must be a string");var j=this.values[q];if(j==null)throw Error("name '"+q+"' does not exist in "+this);return delete this.valuesById[j],delete this.values[q],delete this.comments[q],this.valuesOptions&&delete this.valuesOptions[q],this},F.prototype.isReservedId=function(q){return $.isReservedId(this.reserved,q)},F.prototype.isReservedName=function(q){return $.isReservedName(this.reserved,q)},_enum}var encoder_1,hasRequiredEncoder;function requireEncoder(){if(hasRequiredEncoder)return encoder_1;hasRequiredEncoder=1,encoder_1=V;var B=require_enum(),$=requireTypes(),U=requireUtil();function F(q,j,W,K){return j.delimited?q("types[%i].encode(%s,w.uint32(%i)).uint32(%i)",W,K,(j.id<<3|3)>>>0,(j.id<<3|4)>>>0):q("types[%i].encode(%s,w.uint32(%i).fork()).ldelim()",W,K,(j.id<<3|2)>>>0)}function V(q){for(var j=U.codegen(["m","w"],q.name+"$encode")("if(!w)")("w=Writer.create()"),W,K,G=q.fieldsArray.slice().sort(U.compareFieldsById),W=0;W<G.length;++W){var z=G[W].resolve(),H=q._fieldsArray.indexOf(z),Q=z.resolvedType instanceof B?"int32":z.type,Y=$.basic[Q];K="m"+U.safeProp(z.name),z.map?(j("if(%s!=null&&Object.hasOwnProperty.call(m,%j)){",K,z.name)("for(var ks=Object.keys(%s),i=0;i<ks.length;++i){",K)("w.uint32(%i).fork().uint32(%i).%s(ks[i])",(z.id<<3|2)>>>0,8|$.mapKey[z.keyType],z.keyType),Y===void 0?j("types[%i].encode(%s[ks[i]],w.uint32(18).fork()).ldelim().ldelim()",H,K):j(".uint32(%i).%s(%s[ks[i]]).ldelim()",16|Y,Q,K),j("}")("}")):z.repeated?(j("if(%s!=null&&%s.length){",K,K),z.packed&&$.packed[Q]!==void 0?j("w.uint32(%i).fork()",(z.id<<3|2)>>>0)("for(var i=0;i<%s.length;++i)",K)("w.%s(%s[i])",Q,K)("w.ldelim()"):(j("for(var i=0;i<%s.length;++i)",K),Y===void 0?F(j,z,H,K+"[i]"):j("w.uint32(%i).%s(%s[i])",(z.id<<3|Y)>>>0,Q,K)),j("}")):(z.optional&&j("if(%s!=null&&Object.hasOwnProperty.call(m,%j))",K,z.name),Y===void 0?F(j,z,H,K):j("w.uint32(%i).%s(%s)",(z.id<<3|Y)>>>0,Q,K))}return j("return w")}return encoder_1}var hasRequiredIndexLight;function requireIndexLight(){if(hasRequiredIndexLight)return indexLight.exports;hasRequiredIndexLight=1;var B=indexLight.exports=requireIndexMinimal();B.build="light";function $(F,V,q){return typeof V=="function"?(q=V,V=new B.Root):V||(V=new B.Root),V.load(F,q)}B.load=$;function U(F,V){return V||(V=new B.Root),V.loadSync(F)}return B.loadSync=U,B.encoder=requireEncoder(),B.decoder=requireDecoder(),B.verifier=requireVerifier(),B.converter=requireConverter(),B.ReflectionObject=requireObject(),B.Namespace=requireNamespace(),B.Root=requireRoot(),B.Enum=require_enum(),B.Type=requireType(),B.Field=requireField(),B.OneOf=requireOneof(),B.MapField=requireMapfield(),B.Service=requireService(),B.Method=requireMethod(),B.Message=requireMessage(),B.wrappers=requireWrappers(),B.types=requireTypes(),B.util=requireUtil(),B.ReflectionObject._configure(B.Root),B.Namespace._configure(B.Type,B.Service,B.Enum),B.Root._configure(B.Type),B.Field._configure(B.Type),indexLight.exports}var tokenize_1,hasRequiredTokenize;function requireTokenize(){if(hasRequiredTokenize)return tokenize_1;hasRequiredTokenize=1,tokenize_1=z;var B=/[\s{}=;:[\],'"()<>]/g,$=/(?:"([^"\\]*(?:\\.[^"\\]*)*)")/g,U=/(?:'([^'\\]*(?:\\.[^'\\]*)*)')/g,F=/^ *[*/]+ */,V=/^\s*\*?\/*/,q=/\n/g,j=/\s/,W=/\\(.?)/g,K={0:"\0",r:"\r",n:`
`,t:"	"};function G(H){return H.replace(W,function(Q,Y){switch(Y){case"\\":case"":return Y;default:return K[Y]||""}})}z.unescape=G;function z(H,Q){H=H.toString();var Y=0,X=H.length,Z=1,ne=0,ee={},ie=[],se=null;function te(ke){return Error("illegal "+ke+" (line "+Z+")")}function re(){var ke=se==="'"?U:$;ke.lastIndex=Y-1;var _e=ke.exec(H);if(!_e)throw te("string");return Y=ke.lastIndex,oe(se),se=null,G(_e[1])}function ae(ke){return H.charAt(ke)}function ce(ke,_e,Ce){var Re={type:H.charAt(ke++),lineEmpty:!1,leading:Ce},$e;Q?$e=2:$e=3;var Ee=ke-$e,we;do if(--Ee<0||(we=H.charAt(Ee))===`
`){Re.lineEmpty=!0;break}while(we===" "||we==="	");for(var De=H.substring(ke,_e).split(q),Ie=0;Ie<De.length;++Ie)De[Ie]=De[Ie].replace(Q?V:F,"").trim();Re.text=De.join(`
`).trim(),ee[Z]=Re,ne=Z}function le(ke){var _e=de(ke),Ce=H.substring(ke,_e),Re=/^\s*\/\//.test(Ce);return Re}function de(ke){for(var _e=ke;_e<X&&ae(_e)!==`
`;)_e++;return _e}function ue(){if(ie.length>0)return ie.shift();if(se)return re();var ke,_e,Ce,Re,$e,Ee=Y===0;do{if(Y===X)return null;for(ke=!1;j.test(Ce=ae(Y));)if(Ce===`
`&&(Ee=!0,++Z),++Y===X)return null;if(ae(Y)==="/"){if(++Y===X)throw te("comment");if(ae(Y)==="/")if(Q){if(Re=Y,$e=!1,le(Y-1)){$e=!0;do if(Y=de(Y),Y===X||(Y++,!Ee))break;while(le(Y))}else Y=Math.min(X,de(Y)+1);$e&&(ce(Re,Y,Ee),Ee=!0),Z++,ke=!0}else{for($e=ae(Re=Y+1)==="/";ae(++Y)!==`
`;)if(Y===X)return null;++Y,$e&&(ce(Re,Y-1,Ee),Ee=!0),++Z,ke=!0}else if((Ce=ae(Y))==="*"){Re=Y+1,$e=Q||ae(Re)==="*";do{if(Ce===`
`&&++Z,++Y===X)throw te("comment");_e=Ce,Ce=ae(Y)}while(_e!=="*"||Ce!=="/");++Y,$e&&(ce(Re,Y-2,Ee),Ee=!0),ke=!0}else return"/"}}while(ke);var we=Y;B.lastIndex=0;var De=B.test(ae(we++));if(!De)for(;we<X&&!B.test(ae(we));)++we;var Ie=H.substring(Y,Y=we);return(Ie==='"'||Ie==="'")&&(se=Ie),Ie}function oe(ke){ie.push(ke)}function me(){if(!ie.length){var ke=ue();if(ke===null)return null;oe(ke)}return ie[0]}function be(ke,_e){var Ce=me(),Re=Ce===ke;if(Re)return ue(),!0;if(!_e)throw te("token '"+Ce+"', '"+ke+"' expected");return!1}function ge(ke){var _e=null,Ce;return ke===void 0?(Ce=ee[Z-1],delete ee[Z-1],Ce&&(Q||Ce.type==="*"||Ce.lineEmpty)&&(_e=Ce.leading?Ce.text:null)):(ne<ke&&me(),Ce=ee[ke],delete ee[ke],Ce&&!Ce.lineEmpty&&(Q||Ce.type==="/")&&(_e=Ce.leading?null:Ce.text)),_e}return Object.defineProperty({next:ue,peek:me,push:oe,skip:be,cmnt:ge},"line",{get:function(){return Z}})}return tokenize_1}var parse_1,hasRequiredParse;function requireParse(){if(hasRequiredParse)return parse_1;hasRequiredParse=1,parse_1=re,re.filename=null,re.defaults={keepCase:!1};var B=requireTokenize(),$=requireRoot(),U=requireType(),F=requireField(),V=requireMapfield(),q=requireOneof(),j=require_enum(),W=requireService(),K=requireMethod(),G=requireObject(),z=requireTypes(),H=requireUtil(),Q=/^[1-9][0-9]*$/,Y=/^-?[1-9][0-9]*$/,X=/^0[x][0-9a-fA-F]+$/,Z=/^-?0[x][0-9a-fA-F]+$/,ne=/^0[0-7]+$/,ee=/^-?0[0-7]+$/,ie=/^(?![eE])[0-9]*(?:\.[0-9]*)?(?:[eE][+-]?[0-9]+)?$/,se=/^[a-zA-Z_][a-zA-Z_0-9]*$/,te=/^(?:\.?[a-zA-Z_][a-zA-Z_0-9]*)(?:\.[a-zA-Z_][a-zA-Z_0-9]*)*$/;function re(ae,ce,le){ce instanceof $||(le=ce,ce=new $),le||(le=re.defaults);var de=le.preferTrailingComment||!1,ue=B(ae,le.alternateCommentMode||!1),oe=ue.next,me=ue.push,be=ue.peek,ge=ue.skip,ke=ue.cmnt,_e=!0,Ce,Re,$e,Ee="proto2",we=ce,De=[],Ie={},je=le.keepCase?function(pe){return pe}:H.camelCase;function Ke(){De.forEach(pe=>{pe._edition=Ee,Object.keys(Ie).forEach(he=>{pe.getOption(he)===void 0&&pe.setOption(he,Ie[he],!0)})})}function Te(pe,he,fe){var ve=re.filename;return fe||(re.filename=null),Error("illegal "+(he||"token")+" '"+pe+"' ("+(ve?ve+", ":"")+"line "+ue.line+")")}function We(){var pe=[],he;do{if((he=oe())!=='"'&&he!=="'")throw Te(he);pe.push(oe()),ge(he),he=be()}while(he==='"'||he==="'");return pe.join("")}function He(pe){var he=oe();switch(he){case"'":case'"':return me(he),We();case"true":case"TRUE":return!0;case"false":case"FALSE":return!1}try{return rt(he,!0)}catch{if(te.test(he))return he;throw Te(he,"value")}}function Je(pe,he){var fe,ve;do if(he&&((fe=be())==='"'||fe==="'")){var ye=We();if(pe.push(ye),Ee>=2023)throw Te(ye,"id")}else try{pe.push([ve=Ve(oe()),ge("to",!0)?Ve(oe()):ve])}catch(Pe){if(he&&te.test(fe)&&Ee>=2023)pe.push(fe);else throw Pe}while(ge(",",!0));var Se={options:void 0};Se.setOption=function(Pe,Ae){this.options===void 0&&(this.options={}),this.options[Pe]=Ae},Me(Se,function(Ae){if(Ae==="option")Ne(Se,Ae),ge(";");else throw Te(Ae)},function(){Ge(Se)})}function rt(pe,he){var fe=1;switch(pe.charAt(0)==="-"&&(fe=-1,pe=pe.substring(1)),pe){case"inf":case"INF":case"Inf":return fe*(1/0);case"nan":case"NAN":case"Nan":case"NaN":return NaN;case"0":return 0}if(Q.test(pe))return fe*parseInt(pe,10);if(X.test(pe))return fe*parseInt(pe,16);if(ne.test(pe))return fe*parseInt(pe,8);if(ie.test(pe))return fe*parseFloat(pe);throw Te(pe,"number",he)}function Ve(pe,he){switch(pe){case"max":case"MAX":case"Max":return 536870911;case"0":return 0}if(!he&&pe.charAt(0)==="-")throw Te(pe,"id");if(Y.test(pe))return parseInt(pe,10);if(Z.test(pe))return parseInt(pe,16);if(ee.test(pe))return parseInt(pe,8);throw Te(pe,"id")}function st(){if(Ce!==void 0)throw Te("package");if(Ce=oe(),!te.test(Ce))throw Te(Ce,"name");we=we.define(Ce),ge(";")}function at(){var pe=be(),he;switch(pe){case"weak":he=$e||($e=[]),oe();break;case"public":oe();default:he=Re||(Re=[]);break}pe=We(),ge(";"),he.push(pe)}function ot(){if(ge("="),Ee=We(),Ee<2023)throw Te(Ee,"syntax");ge(";")}function ct(){if(ge("="),Ee=We(),!["2023"].includes(Ee))throw Te(Ee,"edition");ge(";")}function Qe(pe,he){switch(he){case"option":return Ne(pe,he),ge(";"),!0;case"message":return et(pe,he),!0;case"enum":return tt(pe,he),!0;case"service":return ft(pe,he),!0;case"extend":return gt(pe,he),!0}return!1}function Me(pe,he,fe){var ve=ue.line;if(pe&&(typeof pe.comment!="string"&&(pe.comment=ke()),pe.filename=re.filename),ge("{",!0)){for(var ye;(ye=oe())!=="}";)he(ye);ge(";",!0)}else fe&&fe(),ge(";"),pe&&(typeof pe.comment!="string"||de)&&(pe.comment=ke(ve)||pe.comment)}function et(pe,he){if(!se.test(he=oe()))throw Te(he,"type name");var fe=new U(he);Me(fe,function(ye){if(!Qe(fe,ye))switch(ye){case"map":ut(fe);break;case"required":if(Ee!=="proto2")throw Te(ye);case"repeated":Le(fe,ye);break;case"optional":if(Ee==="proto3")Le(fe,"proto3_optional");else{if(Ee!=="proto2")throw Te(ye);Le(fe,"optional")}break;case"oneof":lt(fe,ye);break;case"extensions":Je(fe.extensions||(fe.extensions=[]));break;case"reserved":Je(fe.reserved||(fe.reserved=[]),!0);break;default:if(Ee==="proto2"||!te.test(ye))throw Te(ye);me(ye),Le(fe,"optional");break}}),pe.add(fe),pe===we&&De.push(fe)}function Le(pe,he,fe){var ve=oe();if(ve==="group"){dt(pe,he);return}for(;ve.endsWith(".")||be().startsWith(".");)ve+=oe();if(!te.test(ve))throw Te(ve,"type");var ye=oe();if(!se.test(ye))throw Te(ye,"name");ye=je(ye),ge("=");var Se=new F(ye,Ve(oe()),ve,he,fe);if(Me(Se,function(xe){if(xe==="option")Ne(Se,xe),ge(";");else throw Te(xe)},function(){Ge(Se)}),he==="proto3_optional"){var Pe=new q("_"+ye);Se.setOption("proto3_optional",!0),Pe.add(Se),pe.add(Pe)}else pe.add(Se);pe===we&&De.push(Se)}function dt(pe,he){if(Ee>=2023)throw Te("group");var fe=oe();if(!se.test(fe))throw Te(fe,"name");var ve=H.lcFirst(fe);fe===ve&&(fe=H.ucFirst(fe)),ge("=");var ye=Ve(oe()),Se=new U(fe);Se.group=!0;var Pe=new F(ve,ye,fe,he);Pe.filename=re.filename,Me(Se,function(xe){switch(xe){case"option":Ne(Se,xe),ge(";");break;case"required":case"repeated":Le(Se,xe);break;case"optional":Ee==="proto3"?Le(Se,"proto3_optional"):Le(Se,"optional");break;case"message":et(Se,xe);break;case"enum":tt(Se,xe);break;default:throw Te(xe)}}),pe.add(Se).add(Pe)}function ut(pe){ge("<");var he=oe();if(z.mapKey[he]===void 0)throw Te(he,"type");ge(",");var fe=oe();if(!te.test(fe))throw Te(fe,"type");ge(">");var ve=oe();if(!se.test(ve))throw Te(ve,"name");ge("=");var ye=new V(je(ve),Ve(oe()),he,fe);Me(ye,function(Pe){if(Pe==="option")Ne(ye,Pe),ge(";");else throw Te(Pe)},function(){Ge(ye)}),pe.add(ye)}function lt(pe,he){if(!se.test(he=oe()))throw Te(he,"name");var fe=new q(je(he));Me(fe,function(ye){ye==="option"?(Ne(fe,ye),ge(";")):(me(ye),Le(fe,"optional"))}),pe.add(fe)}function tt(pe,he){if(!se.test(he=oe()))throw Te(he,"name");var fe=new j(he);Me(fe,function(ye){switch(ye){case"option":Ne(fe,ye),ge(";");break;case"reserved":Je(fe.reserved||(fe.reserved=[]),!0),fe.reserved===void 0&&(fe.reserved=[]);break;default:ht(fe,ye)}}),pe.add(fe),pe===we&&De.push(fe)}function ht(pe,he){if(!se.test(he))throw Te(he,"name");ge("=");var fe=Ve(oe(),!0),ve={options:void 0};ve.getOption=function(ye){return this.options[ye]},ve.setOption=function(ye,Se){G.prototype.setOption.call(ve,ye,Se)},ve.setParsedOption=function(){},Me(ve,function(Se){if(Se==="option")Ne(ve,Se),ge(";");else throw Te(Se)},function(){Ge(ve)}),pe.add(he,fe,ve.comment,ve.parsedOptions||ve.options)}function Ne(pe,he){var fe,ve,ye=!0;for(he==="option"&&(he=oe());he!=="=";){if(he==="("){var Se=oe();ge(")"),he="("+Se+")"}if(ye){if(ye=!1,he.includes(".")&&!he.includes("(")){var Pe=he.split(".");fe=Pe[0]+".",he=Pe[1];continue}fe=he}else ve=ve?ve+=he:he;he=oe()}var Ae=ve?fe.concat(ve):fe,xe=it(pe,Ae);ve=ve&&ve[0]==="."?ve.slice(1):ve,fe=fe&&fe[fe.length-1]==="."?fe.slice(0,-1):fe,pt(pe,fe,xe,ve)}function it(pe,he){if(ge("{",!0)){for(var fe={};!ge("}",!0);){if(!se.test(Oe=oe()))throw Te(Oe,"name");if(Oe===null)throw Te(Oe,"end of input");var ve,ye=Oe;if(ge(":",!0),be()==="{")ve=it(pe,he+"."+Oe);else if(be()==="["){ve=[];var Se;if(ge("[",!0)){do Se=He(),ve.push(Se);while(ge(",",!0));ge("]"),typeof Se<"u"&&Ye(pe,he+"."+Oe,Se)}}else ve=He(),Ye(pe,he+"."+Oe,ve);var Pe=fe[ye];Pe&&(ve=[].concat(Pe).concat(ve)),fe[ye]=ve,ge(",",!0),ge(";",!0)}return fe}var Ae=He();return Ye(pe,he,Ae),Ae}function Ye(pe,he,fe){if(we===pe&&/^features\./.test(he)){Ie[he]=fe;return}pe.setOption&&pe.setOption(he,fe)}function pt(pe,he,fe,ve){pe.setParsedOption&&pe.setParsedOption(he,fe,ve)}function Ge(pe){if(ge("[",!0)){do Ne(pe,"option");while(ge(",",!0));ge("]")}return pe}function ft(pe,he){if(!se.test(he=oe()))throw Te(he,"service name");var fe=new W(he);Me(fe,function(ye){if(!Qe(fe,ye))if(ye==="rpc")mt(fe,ye);else throw Te(ye)}),pe.add(fe),pe===we&&De.push(fe)}function mt(pe,he){var fe=ke(),ve=he;if(!se.test(he=oe()))throw Te(he,"name");var ye=he,Se,Pe,Ae,xe;if(ge("("),ge("stream",!0)&&(Pe=!0),!te.test(he=oe())||(Se=he,ge(")"),ge("returns"),ge("("),ge("stream",!0)&&(xe=!0),!te.test(he=oe())))throw Te(he);Ae=he,ge(")");var ze=new K(ye,ve,Se,Ae,Pe,xe);ze.comment=fe,Me(ze,function(Xe){if(Xe==="option")Ne(ze,Xe),ge(";");else throw Te(Xe)}),pe.add(ze)}function gt(pe,he){if(!te.test(he=oe()))throw Te(he,"reference");var fe=he;Me(null,function(ye){switch(ye){case"required":case"repeated":Le(pe,ye,fe);break;case"optional":Ee==="proto3"?Le(pe,"proto3_optional",fe):Le(pe,"optional",fe);break;default:if(Ee==="proto2"||!te.test(ye))throw Te(ye);me(ye),Le(pe,"optional",fe);break}})}for(var Oe;(Oe=oe())!==null;)switch(Oe){case"package":if(!_e)throw Te(Oe);st();break;case"import":if(!_e)throw Te(Oe);at();break;case"syntax":if(!_e)throw Te(Oe);ot();break;case"edition":if(!_e)throw Te(Oe);ct();break;case"option":Ne(we,Oe),ge(";",!0);break;default:if(Qe(we,Oe)){_e=!1;continue}throw Te(Oe)}return Ke(),re.filename=null,{package:Ce,imports:Re,weakImports:$e,root:ce}}return parse_1}var common_1,hasRequiredCommon;function requireCommon(){if(hasRequiredCommon)return common_1;hasRequiredCommon=1,common_1=$;var B=/\/|\./;function $(F,V){B.test(F)||(F="google/protobuf/"+F+".proto",V={nested:{google:{nested:{protobuf:{nested:V}}}}}),$[F]=V}$("any",{Any:{fields:{type_url:{type:"string",id:1},value:{type:"bytes",id:2}}}});var U;return $("duration",{Duration:U={fields:{seconds:{type:"int64",id:1},nanos:{type:"int32",id:2}}}}),$("timestamp",{Timestamp:U}),$("empty",{Empty:{fields:{}}}),$("struct",{Struct:{fields:{fields:{keyType:"string",type:"Value",id:1}}},Value:{oneofs:{kind:{oneof:["nullValue","numberValue","stringValue","boolValue","structValue","listValue"]}},fields:{nullValue:{type:"NullValue",id:1},numberValue:{type:"double",id:2},stringValue:{type:"string",id:3},boolValue:{type:"bool",id:4},structValue:{type:"Struct",id:5},listValue:{type:"ListValue",id:6}}},NullValue:{values:{NULL_VALUE:0}},ListValue:{fields:{values:{rule:"repeated",type:"Value",id:1}}}}),$("wrappers",{DoubleValue:{fields:{value:{type:"double",id:1}}},FloatValue:{fields:{value:{type:"float",id:1}}},Int64Value:{fields:{value:{type:"int64",id:1}}},UInt64Value:{fields:{value:{type:"uint64",id:1}}},Int32Value:{fields:{value:{type:"int32",id:1}}},UInt32Value:{fields:{value:{type:"uint32",id:1}}},BoolValue:{fields:{value:{type:"bool",id:1}}},StringValue:{fields:{value:{type:"string",id:1}}},BytesValue:{fields:{value:{type:"bytes",id:1}}}}),$("field_mask",{FieldMask:{fields:{paths:{rule:"repeated",type:"string",id:1}}}}),$.get=function(V){return $[V]||null},common_1}var hasRequiredSrc;function requireSrc(){if(hasRequiredSrc)return src.exports;hasRequiredSrc=1;var B=src.exports=requireIndexLight();return B.build="full",B.tokenize=requireTokenize(),B.parse=requireParse(),B.common=requireCommon(),B.Root._configure(B.Type,B.parse,B.common),src.exports}var protobufjs,hasRequiredProtobufjs;function requireProtobufjs(){return hasRequiredProtobufjs||(hasRequiredProtobufjs=1,protobufjs=requireSrc()),protobufjs}var protobufjsExports=requireProtobufjs();const protobuf=getDefaultExportFromCjs$1(protobufjsExports);var extendStatics=function(B,$){return extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(U,F){U.__proto__=F}||function(U,F){for(var V in F)Object.prototype.hasOwnProperty.call(F,V)&&(U[V]=F[V])},extendStatics(B,$)};function __extends(B,$){if(typeof $!="function"&&$!==null)throw new TypeError("Class extends value "+String($)+" is not a constructor or null");extendStatics(B,$);function U(){this.constructor=B}B.prototype=$===null?Object.create($):(U.prototype=$.prototype,new U)}var __assign=function(){return __assign=Object.assign||function($){for(var U,F=1,V=arguments.length;F<V;F++){U=arguments[F];for(var q in U)Object.prototype.hasOwnProperty.call(U,q)&&($[q]=U[q])}return $},__assign.apply(this,arguments)};function __awaiter$1(B,$,U,F){function V(q){return q instanceof U?q:new U(function(j){j(q)})}return new(U||(U=Promise))(function(q,j){function W(z){try{G(F.next(z))}catch(H){j(H)}}function K(z){try{G(F.throw(z))}catch(H){j(H)}}function G(z){z.done?q(z.value):V(z.value).then(W,K)}G((F=F.apply(B,$||[])).next())})}function __generator(B,$){var U={label:0,sent:function(){if(q[0]&1)throw q[1];return q[1]},trys:[],ops:[]},F,V,q,j=Object.create((typeof Iterator=="function"?Iterator:Object).prototype);return j.next=W(0),j.throw=W(1),j.return=W(2),typeof Symbol=="function"&&(j[Symbol.iterator]=function(){return this}),j;function W(G){return function(z){return K([G,z])}}function K(G){if(F)throw new TypeError("Generator is already executing.");for(;j&&(j=0,G[0]&&(U=0)),U;)try{if(F=1,V&&(q=G[0]&2?V.return:G[0]?V.throw||((q=V.return)&&q.call(V),0):V.next)&&!(q=q.call(V,G[1])).done)return q;switch(V=0,q&&(G=[G[0]&2,q.value]),G[0]){case 0:case 1:q=G;break;case 4:return U.label++,{value:G[1],done:!1};case 5:U.label++,V=G[1],G=[0];continue;case 7:G=U.ops.pop(),U.trys.pop();continue;default:if(q=U.trys,!(q=q.length>0&&q[q.length-1])&&(G[0]===6||G[0]===2)){U=0;continue}if(G[0]===3&&(!q||G[1]>q[0]&&G[1]<q[3])){U.label=G[1];break}if(G[0]===6&&U.label<q[1]){U.label=q[1],q=G;break}if(q&&U.label<q[2]){U.label=q[2],U.ops.push(G);break}q[2]&&U.ops.pop(),U.trys.pop();continue}G=$.call(B,U)}catch(z){G=[6,z],V=0}finally{F=q=0}if(G[0]&5)throw G[1];return{value:G[0]?G[1]:void 0,done:!0}}}typeof SuppressedError=="function"&&SuppressedError;var options={syntax:"proto3"},nested={pipecat:{nested:{TextFrame:{fields:{id:{type:"uint64",id:1},name:{type:"string",id:2},text:{type:"string",id:3}}},AudioRawFrame:{fields:{id:{type:"uint64",id:1},name:{type:"string",id:2},audio:{type:"bytes",id:3},sampleRate:{type:"uint32",id:4},numChannels:{type:"uint32",id:5}}},TranscriptionFrame:{fields:{id:{type:"uint64",id:1},name:{type:"string",id:2},text:{type:"string",id:3},userId:{type:"string",id:4},timestamp:{type:"string",id:5}}},Frame:{oneofs:{frame:{oneof:["text","audio","transcription"]}},fields:{text:{type:"TextFrame",id:1},audio:{type:"AudioRawFrame",id:2},transcription:{type:"TranscriptionFrame",id:3}}}}}},jsonDescriptor={options,nested},ConnectionQuality$2;(function(B){B.UNKNOWN="UNKNOWN",B.GOOD="GOOD",B.BAD="BAD"})(ConnectionQuality$2||(ConnectionQuality$2={}));var AbstractConnectionQualityIndicator=(function(){function B($){this._connectionQuality=ConnectionQuality$2.UNKNOWN,this.onConnectionQualityChanged=$}return Object.defineProperty(B.prototype,"connectionQuality",{get:function(){return this._connectionQuality},enumerable:!1,configurable:!0}),B.prototype.handleStatsChanged=function(){var $=this.calculateConnectionQuality();$!==this._connectionQuality&&(this._connectionQuality=$,this.onConnectionQualityChanged($))},B.prototype.start=function($){this.stop(!0),this._start($)},B.prototype.stop=function($){$===void 0&&($=!1),this._stop(),this._connectionQuality=ConnectionQuality$2.UNKNOWN,$||this.onConnectionQualityChanged(ConnectionQuality$2.UNKNOWN)},B})();function QualityIndicatorMixer(){for(var B=[],$=0;$<arguments.length;$++)B[$]=arguments[$];var U=(function(F){__extends(V,F);function V(q){var j=F.call(this,q)||this;return j.childTrackers=B.map(function(W){var K=W.getParams,G=W.TrackerClass;return{tracker:new G(function(){return j.handleStatsChanged()}),getParams:K}}),j}return V.prototype.calculateConnectionQuality=function(){var q=this.childTrackers.map(function(j){var W=j.tracker;return W.connectionQuality});return q.some(function(j){return j===ConnectionQuality$2.BAD})?ConnectionQuality$2.BAD:q.every(function(j){return j===ConnectionQuality$2.UNKNOWN})?ConnectionQuality$2.UNKNOWN:ConnectionQuality$2.GOOD},V.prototype._start=function(q){this.childTrackers.forEach(function(j){var W=j.tracker,K=j.getParams;return W.start(K(q))})},V.prototype._stop=function(){this.childTrackers.forEach(function(q){var j=q.tracker;return j.stop(!0)})},V})(AbstractConnectionQualityIndicator);return U}var LiveKitConnectionQualityIndicator=(function(B){__extends($,B);function $(){var U=B!==null&&B.apply(this,arguments)||this;return U.room=null,U.liveKitConnectionQuality=ConnectionQuality$3.Unknown,U.liveKitConnectionState=null,U.handleConnectionQualityChanged=function(F){U.liveKitConnectionQuality=F,U.handleStatsChanged()},U.handleConnectionStateChanged=function(F){U.liveKitConnectionState=F,U.handleStatsChanged()},U}return $.prototype._start=function(U){this.room=U,this.room.localParticipant.on(ParticipantEvent$1.ConnectionQualityChanged,this.handleConnectionQualityChanged),this.room.on(RoomEvent$1.ConnectionStateChanged,this.handleConnectionStateChanged)},$.prototype._stop=function(){this.room&&(this.room.localParticipant.off(RoomEvent$1.ConnectionQualityChanged,this.handleConnectionQualityChanged),this.room.off(RoomEvent$1.ConnectionStateChanged,this.handleConnectionStateChanged))},$.prototype.calculateConnectionQuality=function(){return[ConnectionQuality$3.Lost,ConnectionQuality$3.Poor].includes(this.liveKitConnectionQuality)||this.liveKitConnectionState&&[ConnectionState$1.Disconnected,ConnectionState$1.Reconnecting,ConnectionState$1.SignalReconnecting].includes(this.liveKitConnectionState)?ConnectionQuality$2.BAD:ConnectionQuality$2.GOOD},$})(AbstractConnectionQualityIndicator),t,e$1,s,n;function r$1(){}function o$1(){o$1.init.call(this)}function i(B){return B._maxListeners===void 0?o$1.defaultMaxListeners:B._maxListeners}function a(B,$,U){if($)B.call(U);else for(var F=B.length,V=m(B,F),q=0;q<F;++q)V[q].call(U)}function c(B,$,U,F){if($)B.call(U,F);else for(var V=B.length,q=m(B,V),j=0;j<V;++j)q[j].call(U,F)}function d(B,$,U,F,V){if($)B.call(U,F,V);else for(var q=B.length,j=m(B,q),W=0;W<q;++W)j[W].call(U,F,V)}function u(B,$,U,F,V,q){if($)B.call(U,F,V,q);else for(var j=B.length,W=m(B,j),K=0;K<j;++K)W[K].call(U,F,V,q)}function h$1(B,$,U,F){if($)B.apply(U,F);else for(var V=B.length,q=m(B,V),j=0;j<V;++j)q[j].apply(U,F)}function l(B,$,U,F){var V,q,j,W;if(typeof U!="function")throw new TypeError('"listener" argument must be a function');if((q=B._events)?(q.newListener&&(B.emit("newListener",$,U.listener?U.listener:U),q=B._events),j=q[$]):(q=B._events=new r$1,B._eventsCount=0),j){if(typeof j=="function"?j=q[$]=F?[U,j]:[j,U]:F?j.unshift(U):j.push(U),!j.warned&&(V=i(B))&&V>0&&j.length>V){j.warned=!0;var K=new Error("Possible EventEmitter memory leak detected. "+j.length+" "+$+" listeners added. Use emitter.setMaxListeners() to increase limit");K.name="MaxListenersExceededWarning",K.emitter=B,K.type=$,K.count=j.length,W=K,typeof console.warn=="function"?console.warn(W):console.log(W)}}else j=q[$]=U,++B._eventsCount;return B}function p(B,$,U){var F=!1;function V(){B.removeListener($,V),F||(F=!0,U.apply(B,arguments))}return V.listener=U,V}function f(B){var $=this._events;if($){var U=$[B];if(typeof U=="function")return 1;if(U)return U.length}return 0}function m(B,$){for(var U=new Array($);$--;)U[$]=B[$];return U}r$1.prototype=Object.create(null),o$1.EventEmitter=o$1,o$1.usingDomains=!1,o$1.prototype.domain=void 0,o$1.prototype._events=void 0,o$1.prototype._maxListeners=void 0,o$1.defaultMaxListeners=10,o$1.init=function(){this.domain=null,o$1.usingDomains&&(void 0).active,this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=new r$1,this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},o$1.prototype.setMaxListeners=function(B){if(typeof B!="number"||B<0||isNaN(B))throw new TypeError('"n" argument must be a positive number');return this._maxListeners=B,this},o$1.prototype.getMaxListeners=function(){return i(this)},o$1.prototype.emit=function(B){var $,U,F,V,q,j,W,K=B==="error";if(j=this._events)K=K&&j.error==null;else if(!K)return!1;if(W=this.domain,K){if($=arguments[1],!W){if($ instanceof Error)throw $;var G=new Error('Uncaught, unspecified "error" event. ('+$+")");throw G.context=$,G}return $||($=new Error('Uncaught, unspecified "error" event')),$.domainEmitter=this,$.domain=W,$.domainThrown=!1,W.emit("error",$),!1}if(!(U=j[B]))return!1;var z=typeof U=="function";switch(F=arguments.length){case 1:a(U,z,this);break;case 2:c(U,z,this,arguments[1]);break;case 3:d(U,z,this,arguments[1],arguments[2]);break;case 4:u(U,z,this,arguments[1],arguments[2],arguments[3]);break;default:for(V=new Array(F-1),q=1;q<F;q++)V[q-1]=arguments[q];h$1(U,z,this,V)}return!0},o$1.prototype.addListener=function(B,$){return l(this,B,$,!1)},o$1.prototype.on=o$1.prototype.addListener,o$1.prototype.prependListener=function(B,$){return l(this,B,$,!0)},o$1.prototype.once=function(B,$){if(typeof $!="function")throw new TypeError('"listener" argument must be a function');return this.on(B,p(this,B,$)),this},o$1.prototype.prependOnceListener=function(B,$){if(typeof $!="function")throw new TypeError('"listener" argument must be a function');return this.prependListener(B,p(this,B,$)),this},o$1.prototype.removeListener=function(B,$){var U,F,V,q,j;if(typeof $!="function")throw new TypeError('"listener" argument must be a function');if(!(F=this._events))return this;if(!(U=F[B]))return this;if(U===$||U.listener&&U.listener===$)--this._eventsCount==0?this._events=new r$1:(delete F[B],F.removeListener&&this.emit("removeListener",B,U.listener||$));else if(typeof U!="function"){for(V=-1,q=U.length;q-- >0;)if(U[q]===$||U[q].listener&&U[q].listener===$){j=U[q].listener,V=q;break}if(V<0)return this;if(U.length===1){if(U[0]=void 0,--this._eventsCount==0)return this._events=new r$1,this;delete F[B]}else(function(W,K){for(var G=K,z=G+1,H=W.length;z<H;G+=1,z+=1)W[G]=W[z];W.pop()})(U,V);F.removeListener&&this.emit("removeListener",B,j||$)}return this},o$1.prototype.off=function(B,$){return this.removeListener(B,$)},o$1.prototype.removeAllListeners=function(B){var $,U;if(!(U=this._events))return this;if(!U.removeListener)return arguments.length===0?(this._events=new r$1,this._eventsCount=0):U[B]&&(--this._eventsCount==0?this._events=new r$1:delete U[B]),this;if(arguments.length===0){for(var F,V=Object.keys(U),q=0;q<V.length;++q)(F=V[q])!=="removeListener"&&this.removeAllListeners(F);return this.removeAllListeners("removeListener"),this._events=new r$1,this._eventsCount=0,this}if(typeof($=U[B])=="function")this.removeListener(B,$);else if($)do this.removeListener(B,$[$.length-1]);while($[0]);return this},o$1.prototype.listeners=function(B){var $,U=this._events;return U&&($=U[B])?typeof $=="function"?[$.listener||$]:(function(F){for(var V=new Array(F.length),q=0;q<V.length;++q)V[q]=F[q].listener||F[q];return V})($):[]},o$1.listenerCount=function(B,$){return typeof B.listenerCount=="function"?B.listenerCount($):f.call(B,$)},o$1.prototype.listenerCount=f,o$1.prototype.eventNames=function(){return this._eventsCount>0?Reflect.ownKeys(this._events):[]};class g extends o$1{}(function(B){B.Issue="issue",B.NetworkScoresUpdated="network-scores-updated",B.StatsParsingFinished="stats-parsing-finished"})(t||(t={})),(function(B){B.Network="network",B.CPU="cpu",B.Server="server",B.Stream="stream"})(e$1||(e$1={})),(function(B){B.OutboundNetworkQuality="outbound-network-quality",B.InboundNetworkQuality="inbound-network-quality",B.OutboundNetworkMediaLatency="outbound-network-media-latency",B.InboundNetworkMediaLatency="inbound-network-media-latency",B.NetworkMediaSyncFailure="network-media-sync-failure",B.OutboundNetworkThroughput="outbound-network-throughput",B.InboundNetworkThroughput="inbound-network-throughput",B.EncoderCPUThrottling="encoder-cpu-throttling",B.DecoderCPUThrottling="decoder-cpu-throttling",B.ServerIssue="server-issue",B.UnknownVideoDecoderIssue="unknown-video-decoder",B.LowInboundMOS="low-inbound-mean-opinion-score",B.LowOutboundMOS="low-outbound-mean-opinion-score",B.FrozenVideoTrack="frozen-video-track",B.MissingVideoStreamData="missing-video-stream-data",B.MissingAudioStreamData="missing-audio-stream-data"})(s||(s={})),(function(B){B[B.BAD=2.1]="BAD",B[B.POOR=2.6]="POOR",B[B.FAIR=3.1]="FAIR",B[B.GOOD=3.8]="GOOD",B[B.EXCELLENT=4.3]="EXCELLENT"})(n||(n={}));class S extends o$1{static STATS_REPORT_READY_EVENT="stats-report-ready";static STATS_REPORTS_PARSED="stats-reports-parsed";isStopped=!1;reportTimer;getStatsInterval;compositeStatsParser;constructor($){super(),this.compositeStatsParser=$.compositeStatsParser,this.getStatsInterval=$.getStatsInterval??1e4}get isRunning(){return!!this.reportTimer&&!this.isStopped}startReporting(){if(this.reportTimer)return;const $=()=>setTimeout((()=>{this.isStopped?this.reportTimer=void 0:this.parseReports().finally((()=>{this.reportTimer=$()}))}),this.getStatsInterval);this.isStopped=!1,this.reportTimer=$()}stopReporting(){this.isStopped=!0,this.reportTimer&&(clearTimeout(this.reportTimer),this.reportTimer=void 0)}async parseReports(){const $=Date.now(),U=await this.compositeStatsParser.parse(),F=Date.now()-$;this.emit(S.STATS_REPORTS_PARSED,{timeTaken:F,reportItems:U}),U.forEach((V=>{this.emit(S.STATS_REPORT_READY_EVENT,V)}))}}const v=(()=>{const B=new Map;return $=>{const{taskId:U,delayMs:F,maxJitterMs:V,callback:q}=$,j=Math.ceil(Math.random()*(V||0)),W=B.get(U);W&&clearTimeout(W);const K=setTimeout((()=>{q(),B.delete(U)}),F+j);B.set(U,K)}})();class k{#e={};calculate($){const{connection:{id:U}}=$,{mos:F,stats:V}=this.calculateOutboundScore($)||{},{mos:q,stats:j}=this.calculateInboundScore($)||{};return this.#e[U]=$,v({taskId:U,delayMs:35e3,callback:()=>delete this.#e[U]}),{outbound:F,inbound:q,connectionId:U,statsSamples:{inboundStatsSample:j,outboundStatsSample:V}}}calculateOutboundScore($){const U=[...$.remote?.audio.inbound||[],...$.remote?.video.inbound||[]];if(!U.length)return;const F=this.#e[$.connection.id];if(!F)return;const V=[...F.remote?.audio.inbound||[],...F.remote?.video.inbound||[]],{packetsSent:q}=$.connection,j=F.connection.packetsSent,W=U.reduce(((X,Z)=>{const ne=V.find((ee=>ee.ssrc===Z.ssrc));return{sumJitter:X.sumJitter+Z.jitter,packetsLost:X.packetsLost+Z.packetsLost,lastPacketsLost:X.lastPacketsLost+(ne?.packetsLost||0)}}),{sumJitter:0,packetsLost:0,lastPacketsLost:0}),K=1e3*$.connection.currentRoundTripTime||0,{sumJitter:G}=W,z=G/U.length,H=q-j,Q=W.packetsLost-W.lastPacketsLost,Y=H&&Q?Math.round(100*Q/(H+Q)):0;return{mos:this.calculateMOS({avgJitter:z,rtt:K,packetsLoss:Y}),stats:{avgJitter:z,rtt:K,packetsLoss:Y}}}calculateInboundScore($){const U=[...$.audio?.inbound,...$.video?.inbound];if(!U.length)return;const F=this.#e[$.connection.id];if(!F)return;const V=[...F.video?.inbound,...F.audio?.inbound],{packetsReceived:q}=$.connection,j=F.connection.packetsReceived,W=U.reduce(((X,Z)=>{const ne=V.find((ee=>ee.ssrc===Z.ssrc));return{sumJitter:X.sumJitter+Z.jitter,packetsLost:X.packetsLost+Z.packetsLost,lastPacketsLost:X.lastPacketsLost+(ne?.packetsLost||0)}}),{sumJitter:0,packetsLost:0,lastPacketsLost:0}),K=1e3*$.connection.currentRoundTripTime||0,{sumJitter:G}=W,z=G/U.length,H=q-j,Q=W.packetsLost-W.lastPacketsLost,Y=H&&Q?Math.round(100*Q/(H+Q)):0;return{mos:this.calculateMOS({avgJitter:z,rtt:K,packetsLoss:Y}),stats:{avgJitter:z,rtt:K,packetsLoss:Y}}}calculateMOS({avgJitter:$,rtt:U,packetsLoss:F}){const V=U+2*$+10;let q=V<160?93.2-V/40:93.2-V/120-10;return q-=2.5*F,1+.035*q+7e-6*q*(q-60)*(100-q)}}class y{#e=new Map;#t;#i;constructor($={}){this.#t=$.statsCleanupTtlMs??35e3,this.#i=$.maxParsedStatsStorageSize??5}detect($,U){const F={...$,networkScores:{...U,statsSamples:U?.statsSamples||{}}},V=this.performDetection(F);return this.setLastProcessedStats($.connection.id,F),this.performPrevStatsCleanup({connectionId:$.connection.id}),V}performPrevStatsCleanup($){const{connectionId:U,cleanupCallback:F}=$;this.#e.has(U)&&v({taskId:U,delayMs:this.#t,callback:()=>{this.deleteLastProcessedStats(U),typeof F=="function"&&F()}})}setLastProcessedStats($,U){if(!$||U.connection.id!==$)return;const F=this.#e.get($)??[];F.push(U),F.length>this.#i&&F.shift(),this.#e.set($,F)}getLastProcessedStats($){const U=this.#e.get($);return U?.[U.length-1]}getAllLastProcessedStats($){return this.#e.get($)??[]}deleteLastProcessedStats($){this.#e.delete($)}}class w extends y{#e;constructor($={}){super($),this.#e=$.availableOutgoingBitrateThreshold??1e5}performDetection($){const U=[],{availableOutgoingBitrate:F}=$.connection;if(F===void 0)return U;const V=$.audio.outbound.reduce(((W,K)=>W+K.targetBitrate),0),q=$.video.outbound.reduce(((W,K)=>W+K.bitrate),0);if(!V&&!q)return U;const j={availableOutgoingBitrate:F,videoStreamsTotalBitrate:q,audioStreamsTotalTargetBitrate:V};return(V>F||q>0&&F<this.#e)&&U.push({statsSample:j,type:e$1.Network,reason:s.OutboundNetworkThroughput}),U}}class b extends y{#e;#t;#i;#n;constructor($={}){super(),this.#e=$.highPacketLossThresholdPct??5,this.#t=$.highJitterThreshold??200,this.#i=$.highJitterBufferDelayThresholdMs??500,this.#n=$.highRttThresholdMs??250}performDetection($){return this.processData($)}processData($){const U=[],F=[...$.audio?.inbound,...$.video?.inbound];if(!F.length)return U;const V=this.getLastProcessedStats($.connection.id);if(!V)return U;const q=[...V.video?.inbound,...V.audio?.inbound],{packetsReceived:j}=$.connection,W=V.connection.packetsReceived,K=F.reduce(((de,ue)=>{const oe=q.find((Ce=>Ce.ssrc===ue.ssrc)),me=oe?.jitterBufferDelay||0,be=oe?.jitterBufferEmittedCount||0,ge=ue.jitterBufferDelay-me,ke=ue.jitterBufferEmittedCount-be,_e=ge&&ke?1e3*ge/ke:0;return{sumJitter:de.sumJitter+ue.jitter,sumJitterBufferDelayMs:de.sumJitterBufferDelayMs+_e,packetsLost:de.packetsLost+ue.packetsLost,lastPacketsLost:de.lastPacketsLost+(oe?.packetsLost||0)}}),{sumJitter:0,sumJitterBufferDelayMs:0,packetsLost:0,lastPacketsLost:0}),G=1e3*$.connection.currentRoundTripTime||0,{sumJitter:z,sumJitterBufferDelayMs:H}=K,Q=z/F.length,Y=H/F.length,X=j-W,Z=K.packetsLost-K.lastPacketsLost,ne=X&&Z?Math.round(100*Z/(X+Z)):0,ee=ne>this.#e,ie=Q>=this.#t,se=G>=this.#n,te=Y>this.#i,re=se&&!ie&&!ee,ae=ee&&ie,ce=ie&&te,le={rtt:G,packetLossPct:ne,avgJitter:Q,avgJitterBufferDelay:Y};return(ie||ee)&&U.push({statsSample:le,type:e$1.Network,reason:s.InboundNetworkQuality,iceCandidate:$.connection.local.id}),re&&U.push({statsSample:le,type:e$1.Server,reason:s.ServerIssue,iceCandidate:$.connection.remote.id}),ae&&U.push({statsSample:le,type:e$1.Network,reason:s.InboundNetworkMediaLatency,iceCandidate:$.connection.local.id}),ce&&U.push({statsSample:le,type:e$1.Network,reason:s.NetworkMediaSyncFailure,iceCandidate:$.connection.local.id}),U}}class P extends y{#e;constructor($={}){super(),this.#e=$.correctedSamplesThresholdPct??5}performDetection($){return this.processData($)}processData($){const U=$.audio.inbound,F=[],V=this.getLastProcessedStats($.connection.id)?.audio.inbound;return V&&U.forEach((q=>{const j=V.find((Y=>Y.ssrc===q.ssrc));if(!j)return;const W=q.track.insertedSamplesForDeceleration+q.track.removedSamplesForAcceleration,K=j.track.insertedSamplesForDeceleration+j.track.removedSamplesForAcceleration;if(W===K)return;const G=q.track.totalSamplesReceived-j.track.totalSamplesReceived,z=W-K,H=Math.round(100*z/G),Q={correctedSamplesPct:H};H>this.#e&&F.push({statsSample:Q,type:e$1.Network,reason:s.NetworkMediaSyncFailure,ssrc:q.ssrc})})),F}}class T extends y{#e;#t;constructor($={}){super(),this.#e=$.highPacketLossThresholdPct??5,this.#t=$.highJitterThreshold??200}performDetection($){return this.processData($)}processData($){const U=[],F=[...$.remote?.audio.inbound||[],...$.remote?.video.inbound||[]];if(!F.length)return U;const V=this.getLastProcessedStats($.connection.id);if(!V)return U;const q=[...V.remote?.audio.inbound||[],...V.remote?.video.inbound||[]],{packetsSent:j}=$.connection,W=V.connection.packetsSent,K=F.reduce(((se,te)=>{const re=q.find((ae=>ae.ssrc===te.ssrc));return{sumJitter:se.sumJitter+te.jitter,packetsLost:se.packetsLost+te.packetsLost,lastPacketsLost:se.lastPacketsLost+(re?.packetsLost||0)}}),{sumJitter:0,packetsLost:0,lastPacketsLost:0}),G=1e3*$.connection.currentRoundTripTime||0,{sumJitter:z}=K,H=z/F.length,Q=j-W,Y=K.packetsLost-K.lastPacketsLost,X=Q&&Y?Math.round(100*Y/(Q+Y)):0,Z=X>this.#e,ne=H>=this.#t,ee=!Z&&ne||ne||Z,ie={rtt:G,avgJitter:H,packetLossPct:X};return Z&&ne&&U.push({statsSample:ie,type:e$1.Network,reason:s.OutboundNetworkMediaLatency,iceCandidate:$.connection.local.id}),ee&&U.push({statsSample:ie,type:e$1.Network,reason:s.OutboundNetworkQuality,iceCandidate:$.connection.local.id}),U}}class L extends y{performDetection($){return this.processData($)}processData($){const U=$.video.outbound.filter((q=>q.qualityLimitationReason!=="none")),F=[],V=this.getLastProcessedStats($.connection.id)?.video.outbound;return V&&U.forEach((q=>{const j=V.find((K=>K.ssrc===q.ssrc));if(!j)return;const W={qualityLimitationReason:q.qualityLimitationReason};q.framesSent>j.framesSent||(q.qualityLimitationReason==="cpu"&&F.push({statsSample:W,type:e$1.CPU,reason:s.EncoderCPUThrottling,ssrc:q.ssrc}),q.qualityLimitationReason==="bandwidth"&&F.push({statsSample:W,type:e$1.Network,reason:s.OutboundNetworkThroughput,ssrc:q.ssrc}))})),F}}class D extends y{UNKNOWN_DECODER="unknown";#e={};performDetection($){return this.processData($)}performPrevStatsCleanup($){const{connectionId:U,cleanupCallback:F}=$;super.performPrevStatsCleanup({...$,cleanupCallback:()=>{delete this.#e[U],typeof F=="function"&&F()}})}processData($){const U=[],{id:F}=$.connection,V=this.getLastProcessedStats(F)?.video.inbound;return $.video.inbound.forEach((q=>{const{decoderImplementation:j,ssrc:W}=q;if(V?.find((G=>G.ssrc===W)))if(j===this.UNKNOWN_DECODER){if(!this.hadLastDecoderWithIssue(F,W)){this.setLastDecoderWithIssue(F,W,this.UNKNOWN_DECODER);const G={mimeType:q.mimeType,decoderImplementation:j};U.push({ssrc:W,statsSample:G,type:e$1.Stream,reason:s.UnknownVideoDecoderIssue,trackIdentifier:q.track.trackIdentifier})}}else this.setLastDecoderWithIssue(F,W,void 0)})),U}setLastDecoderWithIssue($,U,F){const V=this.#e[$]??{};F===void 0?delete V[U]:V[U]=F,this.#e[$]=V}hadLastDecoderWithIssue($,U){const F=this.#e[$];return(F&&F[U])===this.UNKNOWN_DECODER}}const C=B=>B.reduce((($,U)=>$+U),0)/B.length,R=(B,$,U=30)=>{const F=[];for(let V=1;V<$.length-1;V+=1){const q=$[V]?.video?.inbound.find((G=>G.ssrc===B));if(!q)continue;const j=$[V-1]?.video?.inbound?.find((G=>G.ssrc===B));if(!q||!j)continue;const W=q.timestamp-j.timestamp,K=q.framesDecoded-j.framesDecoded;if(K>0){const G=W/K;F.push(G)}}return F.length<=1?!1:(V=>{const q=((j,W)=>W.reduce(((K,G)=>K+(G-j)**2),0)/W.length)(C(V),V);return Math.sqrt(q)})(F)>U},M=(B,$)=>{for(let U=1;U<$.length;U+=1){const F=$[U].video.inbound.find((W=>W.ssrc===B));if(!F)continue;const V=$[U-1].video.inbound.find((W=>W.ssrc===B)),q=F.frameWidth!==V?.frameWidth,j=F.frameHeight!==V?.frameHeight;if(q||j)return!0}return!1};class I extends y{#e;#t;#i;constructor($={}){super(),this.#e=$.avgFreezeDurationThresholdMs??1e3,this.#t=$.frozenDurationThresholdPct??30,this.#i=$.minMosQuality??n.BAD}performDetection($){const U=$.networkScores.inbound;return U!==void 0&&U<=this.#i?[]:this.processData($)}processData($){const U=[],F=this.getAllLastProcessedStats($.connection.id);if(F.length===0)return[];const V=$.video.inbound.map((q=>{const j=F[F.length-1].video.inbound.find((H=>H.ssrc===q.ssrc));if(!j||M(q.ssrc,[F[F.length-1],$])||R(q.ssrc,F))return;const W=q.freezeCount-(j.freezeCount??0),K=1e3*(q.totalFreezesDuration-(j.totalFreezesDuration??0)),G=W>0?K/W:0,z=K/(q.timestamp-j.timestamp)*100;return z>this.#t||G>this.#e?{ssrc:q.ssrc,avgFreezeDurationMs:G,frozenDurationPct:z}:void 0})).filter((q=>q!==void 0));return V.length>0&&(U.push({type:e$1.Stream,reason:s.FrozenVideoTrack,statsSample:{ssrcs:V.map((q=>q.ssrc))}}),this.deleteLastProcessedStats($.connection.id)),U}}class E extends y{#e;#t;#i;constructor($={}){super($),this.#e=$.volatilityThreshold??8,this.#t=$.affectedStreamsPercentThreshold??30,this.#i=$.minMosQuality??n.BAD}performDetection($){return[...this.getAllLastProcessedStats($.connection.id),$].find((U=>U.networkScores.inbound!==void 0&&U.networkScores.inbound<=this.#i))?[]:this.processData($)}processData($){const U=[],F=[...this.getAllLastProcessedStats($.connection.id),$],V=$.video.inbound.map((j=>{if(F.length<5||M(j.ssrc,F))return;const W=[];for(let G=0;G<F.length-1;G+=1){const z=F[G].video.inbound.find((H=>H.ssrc===j.ssrc));z?.framesPerSecond!==void 0&&W.push(z.framesPerSecond)}if(W.length<5||R(j.ssrc,F))return;const K=(G=>{if(G.length===0)throw new Error("Cannot calculate volatility for empty array");const z=C(G);return G.reduce(((H,Q)=>H+Math.abs(Q-z)),0)/G.length*100/z})(W);return K>this.#e?{ssrc:j.ssrc,allFps:W,volatility:K}:void 0})).filter((j=>!!j));if(V.length===0)return U;const q=V.length/($.video.inbound.length/100);return q>this.#t&&(U.push({type:e$1.CPU,reason:s.DecoderCPUThrottling,statsSample:{affectedStreamsPercent:q,throtthedStreams:V}}),this.deleteLastProcessedStats($.connection.id)),U}}const N=B=>B.iceConnectionState==="closed"||B.connectionState==="closed",_$1=(B,$,U)=>8*((F,V,q)=>{if(!V)return 0;const j=F[q],W=V[q];if(j==null||W==null)return 0;const K=Math.floor(F.timestamp)-Math.floor(V.timestamp);return K===0?0:(Number(j)-Number(W))/K*1e3})(B,$,U);class A{connections=[];statsParser;constructor($){this.statsParser=$.statsParser}listConnections(){return[...this.connections]}addPeerConnection($){this.connections.push({id:$.id??String(Date.now()+Math.random().toString(32)),pc:$.pc})}removePeerConnection($){const U=this.connections.findIndex((({pc:F})=>F===$.pc));U>=0&&this.removeConnectionsByIndexes([U])}async parse(){const $=[],U=this.connections.map((async(F,V)=>{if(!N(F.pc))return this.statsParser.parse(F);$.unshift(V)}));return $.length&&this.removeConnectionsByIndexes($),(await Promise.all(U)).filter((F=>F!==void 0))}removeConnectionsByIndexes($){$.forEach((U=>{this.connections.splice(U,1)}))}}class O{prevStats=new Map;allowedReportTypes=new Set(["candidate-pair","inbound-rtp","outbound-rtp","remote-outbound-rtp","remote-inbound-rtp","track","transport"]);ignoreSSRCList;logger;constructor($){this.ignoreSSRCList=$.ignoreSSRCList??[],this.logger=$.logger}get previouslyParsedStatsConnectionsIds(){return[...this.prevStats.keys()]}async parse($){if(!N($.pc))return this.getConnectionStats($);this.logger.debug("Skip stats parsing. Connection is closed.",{connection:$})}async getConnectionStats($){const{pc:U,id:F}=$;try{const V=Date.now(),q=U.getReceivers().filter((G=>G.track?.enabled)),j=U.getSenders().filter((G=>G.track?.enabled)),W=await Promise.all(q.map((G=>G.getStats()))),K=await Promise.all(j.map((G=>G.getStats())));return{id:F,stats:this.mapReportsStats([...W,...K],$),timeTaken:Date.now()-V}}catch(V){return void this.logger.error("Failed to get stats for PC",{id:F,pc:U,error:V})}}mapReportsStats($,U){const F={audio:{inbound:[],outbound:[]},video:{inbound:[],outbound:[]},connection:{},remote:{video:{inbound:[],outbound:[]},audio:{inbound:[],outbound:[]}}};$.forEach((j=>{j.forEach((W=>{this.allowedReportTypes.has(W.type)&&this.updateMappedStatsWithReportItemData(W,F,j)}))}));const{id:V}=U,q=this.prevStats.get(V);return q&&this.propagateStatsWithRateValues(F,q.stats),this.prevStats.set(V,{stats:F,ts:Date.now()}),v({taskId:V,delayMs:35e3,callback:()=>this.prevStats.delete(V)}),F}updateMappedStatsWithReportItemData($,U,F){const V=$.type;if(V==="candidate-pair"&&$.state==="succeeded"&&$.nominated)return void(U.connection=this.prepareConnectionStats($,F));const q=this.getMediaType($);if(!q)return;const j=$.ssrc;if(!j||!this.ignoreSSRCList.includes(j))if(V!=="outbound-rtp")if(V!=="inbound-rtp")V!=="remote-outbound-rtp"?V==="remote-inbound-rtp"&&(this.mapConnectionStatsIfNecessary(U,$,F),U.remote[q].inbound.push({...$})):U.remote[q].outbound.push({...$});else{const W=F.get($.trackId)||F.get($.mediaSourceId)||{};this.mapConnectionStatsIfNecessary(U,$,F);const K={...$,track:{...W}};U[q].inbound.push(K)}else{const W=F.get($.trackId)||F.get($.mediaSourceId)||{},K={...$,track:{...W}};U[q].outbound.push(K)}}getMediaType($){const U=$.mediaType||$.kind;if(!["audio","video"].includes(U)){const{id:F}=$;return F?String(F).includes("Video")?"video":String(F).includes("Audio")?"audio":void 0:void 0}return U}propagateStatsWithRateValues($,U){$.audio.inbound.forEach((F=>{const V=U.audio.inbound.find((({id:q})=>q===F.id));F.bitrate=_$1(F,V,"bytesReceived"),F.packetRate=_$1(F,V,"packetsReceived")})),$.audio.outbound.forEach((F=>{const V=U.audio.outbound.find((({id:q})=>q===F.id));F.bitrate=_$1(F,V,"bytesSent"),F.packetRate=_$1(F,V,"packetsSent")})),$.video.inbound.forEach((F=>{const V=U.video.inbound.find((({id:q})=>q===F.id));F.bitrate=_$1(F,V,"bytesReceived"),F.packetRate=_$1(F,V,"packetsReceived")})),$.video.outbound.forEach((F=>{const V=U.video.outbound.find((({id:q})=>q===F.id));F.bitrate=_$1(F,V,"bytesSent"),F.packetRate=_$1(F,V,"packetsSent")}))}mapConnectionStatsIfNecessary($,U,F){if($.connection.id||!U.transportId)return;const V=F.get(U.transportId);if(V&&V.selectedCandidatePairId){const q=F.get(V.selectedCandidatePairId);$.connection=this.prepareConnectionStats(q,F)}}prepareConnectionStats($,U){if(!$||!U)return{};const F={...$};if(F.remoteCandidateId){const V=U.get(F.remoteCandidateId);F.remote={...V}}if(F.localCandidateId){const V=U.get(F.localCandidateId);F.local={...V}}return F}}class J extends y{#e=new Map;#t;#i;constructor($={}){super(),this.#t=$.timeoutMs??15e3,this.#i=$.steps??3}performDetection($){return this.processData($)}processData($){const U=[],F=[...this.getAllLastProcessedStats($.connection.id),$];if(F.length<this.#i)return U;const V=F.slice(-this.#i),q=V.map((W=>W.video.inbound)),j=V.map((W=>W.audio.inbound));return U.push(...this.detectMissingData(j,e$1.Stream,s.MissingAudioStreamData)),U.push(...this.detectMissingData(q,e$1.Stream,s.MissingVideoStreamData)),new Set(this.#e.keys()).forEach((W=>{const K=this.#e.get(W);K&&Date.now()-K>this.#t&&this.removeMarkedIssue(W)})),U}detectMissingData($,U,F){const V=[],q=$.pop(),j=J.mapStatsByTrackId($);return q.forEach((W=>{const K=W.track.trackIdentifier,G=j.get(K);if(!Array.isArray(G)||G.length===0||W.track.detached||W.track.ended)return;if(!J.isAllBytesReceivedDidntChange(W.bytesReceived,G))return void this.removeMarkedIssue(K);if(!this.markIssue(K))return;const z={bytesReceived:W.bytesReceived};V.push({type:U,reason:F,statsSample:z,trackIdentifier:K})})),V}static mapStatsByTrackId($){const U=new Map;return $.forEach((F=>{F.forEach((V=>{const q=U.get(V.track.trackIdentifier)||[];q.push(V),U.set(V.track.trackIdentifier,q)}))})),U}static isAllBytesReceivedDidntChange($,U){for(let F=0;F<U.length;F+=1)if(U[F].bytesReceived!==$)return!1;return!0}markIssue($){const U=Date.now(),F=this.#e.get($);return(!F||U-F>this.#t)&&(this.#e.set($,U),!0)}removeMarkedIssue($){this.#e.delete($)}}class x{eventEmitter;#e=!1;detectors=[];networkScoresCalculator;statsReporter;compositeStatsParser;logger;autoAddPeerConnections;constructor($){this.logger=$.logger??{debug:()=>{},info:()=>{},warn:()=>{},error:()=>{}},this.eventEmitter=$.issueEmitter??new g,$.onIssues&&this.eventEmitter.on(t.Issue,$.onIssues),$.onNetworkScoresUpdated&&this.eventEmitter.on(t.NetworkScoresUpdated,$.onNetworkScoresUpdated),this.detectors=$.detectors??[new L,new b,new T,new P,new w,new D,new I,new E,new J],this.networkScoresCalculator=$.networkScoresCalculator??new k,this.compositeStatsParser=$.compositeStatsParser??new A({statsParser:new O({ignoreSSRCList:$.ignoreSSRCList,logger:this.logger})}),this.statsReporter=$.statsReporter??new S({compositeStatsParser:this.compositeStatsParser,getStatsInterval:$.getStatsInterval??5e3}),window.wid=this,this.autoAddPeerConnections=$.autoAddPeerConnections??!0,this.autoAddPeerConnections&&this.wrapRTCPeerConnection(),this.statsReporter.on(S.STATS_REPORT_READY_EVENT,(U=>{const F=this.calculateNetworkScores(U.stats);this.detectIssues({data:U.stats},F)})),this.statsReporter.on(S.STATS_REPORTS_PARSED,(U=>{const F={timeTaken:U.timeTaken,ts:Date.now()};$.onStats&&$.onStats(U.reportItems),this.eventEmitter.emit(t.StatsParsingFinished,F)}))}watchNewPeerConnections(){if(!this.autoAddPeerConnections)throw new Error("Auto add peer connections was disabled in the constructor.");this.#e?this.logger.warn("WebRTCIssueDetector is already started. Skip processing"):(this.logger.info("Start watching peer connections"),this.#e=!0,this.statsReporter.startReporting())}stopWatchingNewPeerConnections(){this.#e?(this.logger.info("Stop watching peer connections"),this.#e=!1,this.statsReporter.stopReporting()):this.logger.warn("WebRTCIssueDetector is already stopped. Skip processing")}handleNewPeerConnection($,U){this.#e||!this.autoAddPeerConnections?(this.#e||this.autoAddPeerConnections!==!1||(this.logger.info("Starting stats reporting for new peer connection"),this.#e=!0,this.statsReporter.startReporting()),this.logger.debug("Handling new peer connection",$),this.compositeStatsParser.addPeerConnection({pc:$,id:U})):this.logger.debug("Skip handling new peer connection. Detector is not running",$)}emitIssues($){this.eventEmitter.emit(t.Issue,$)}detectIssues({data:$},U){const F=this.detectors.reduce(((V,q)=>[...V,...q.detect($,U)]),[]);F.length>0&&this.emitIssues(F)}calculateNetworkScores($){const U=this.networkScoresCalculator.calculate($);return this.eventEmitter.emit(t.NetworkScoresUpdated,U),U}wrapRTCPeerConnection(){if(!window.RTCPeerConnection)return void this.logger.warn("No RTCPeerConnection found in browser window. Skipping");const $=window.RTCPeerConnection,U=V=>this.handleNewPeerConnection(V);function F(V){const q=new $(V);return U(q),q}F.prototype=$.prototype,window.RTCPeerConnection=F}}var WebRTCConnectionQualityIndicator=(function(B){__extends($,B);function $(){var U=B!==null&&B.apply(this,arguments)||this;return U.issueDetector=null,U.mosScores=null,U}return $.prototype._start=function(U){var F=this;this.issueDetector=new x({autoAddPeerConnections:!1,getStatsInterval:3e3,onNetworkScoresUpdated:function(V){F.mosScores=V,F.handleStatsChanged()}}),this.issueDetector.handleNewPeerConnection(U)},$.prototype._stop=function(){this.issueDetector&&(this.issueDetector.stopWatchingNewPeerConnections(),this.issueDetector=null),this.mosScores=null},$.prototype.calculateConnectionQuality=function(){return!this.mosScores||this.mosScores.inbound&&this.mosScores.outbound?ConnectionQuality$2.UNKNOWN:this.mosScores.inbound&&this.mosScores.inbound<3||this.mosScores.outbound&&this.mosScores.outbound<3?ConnectionQuality$2.BAD:ConnectionQuality$2.GOOD},$})(AbstractConnectionQualityIndicator),VoiceChatState;(function(B){B.INACTIVE="inactive",B.STARTING="starting",B.ACTIVE="started",B.STOPPING="stopping"})(VoiceChatState||(VoiceChatState={}));var AbstractVoiceChat=(function(){function B(){}return B})(),AbstractVoiceChatImplementation=(function(B){__extends($,B);function $(){var U=B!==null&&B.apply(this,arguments)||this;return U._isMuted=!0,U.state=VoiceChatState.INACTIVE,U}return Object.defineProperty($.prototype,"isMuted",{get:function(){return this._isMuted},enumerable:!1,configurable:!0}),Object.defineProperty($.prototype,"isVoiceChatting",{get:function(){return this.state!==VoiceChatState.INACTIVE},enumerable:!1,configurable:!0}),$.prototype.startVoiceChat=function(U){return __awaiter$1(this,void 0,void 0,function(){var F;return __generator(this,function(V){switch(V.label){case 0:return this.state===VoiceChatState.INACTIVE?[3,2]:[4,this.stopVoiceChat()];case 1:V.sent(),V.label=2;case 2:return V.trys.push([2,4,,6]),this.state=VoiceChatState.STARTING,[4,this._startVoiceChat(U)];case 3:return V.sent(),this.state=VoiceChatState.ACTIVE,[3,6];case 4:return F=V.sent(),[4,this.stopVoiceChat()];case 5:throw V.sent(),F;case 6:return[2]}})})},$.prototype.stopVoiceChat=function(){return __awaiter$1(this,void 0,void 0,function(){return __generator(this,function(U){switch(U.label){case 0:return this.state===VoiceChatState.INACTIVE?[2]:(this.state=VoiceChatState.STOPPING,[4,this._stopVoiceChat()]);case 1:return U.sent(),this._isMuted=!0,this.state=VoiceChatState.INACTIVE,[2]}})})},$.prototype._mute=function(){},$.prototype._unmute=function(){},$.prototype.mute=function(){this.isVoiceChatting&&(this._mute(),this._isMuted=!0)},$.prototype.unmute=function(){this.isVoiceChatting&&(this._unmute(),this._isMuted=!1)},$})(AbstractVoiceChat);function sleep$1(B){return new Promise(function($){return setTimeout($,B)})}function convertFloat32ToS16PCM(B){for(var $=new Int16Array(B.length),U=0;U<B.length;U++){var F=Math.max(-1,Math.min(1,B[U]));$[U]=F<0?F*32768:F*32767}return $}var LivekitVoiceChat=(function(B){__extends($,B);function $(){var U=B!==null&&B.apply(this,arguments)||this;return U.room=null,U.track=null,U}return $.prototype._startVoiceChat=function(U){return __awaiter$1(this,void 0,void 0,function(){var F,V;return __generator(this,function(q){switch(q.label){case 0:return this.room=U.room,F=this,[4,createLocalAudioTrack$1({echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0})];case 1:return F.track=q.sent(),[4,this.room.localParticipant.publishTrack(this.track)];case 2:return q.sent(),!((V=U.config)===null||V===void 0)&&V.defaultMuted?this.mute():this.unmute(),[4,sleep$1(4e3)];case 3:return q.sent(),[2]}})})},$.prototype._stopVoiceChat=function(){return __awaiter$1(this,void 0,void 0,function(){var U;return __generator(this,function(F){return!((U=this.room)===null||U===void 0)&&U.localParticipant&&this.room.localParticipant.getTrackPublications().forEach(function(V){V.track&&V.track.kind===Track$1.Kind.Audio&&V.track.stop()}),this.track&&(this.track.stop(),this.track=null),[2]})})},$.prototype._mute=function(){this.track&&!this.track.isMuted&&this.track.mute()},$.prototype._unmute=function(){this.track&&this.track.isMuted&&this.track.unmute()},$})(AbstractVoiceChatImplementation),WebSocketVoiceChat=(function(B){__extends($,B);function $(){var U=B!==null&&B.apply(this,arguments)||this;return U.audioContext=null,U.webSocket=null,U.scriptProcessor=null,U.mediaStreamAudioSource=null,U.mediaDevicesStream=null,U.audioRawFrame=null,U}return $.prototype._startVoiceChat=function(U){return __awaiter$1(this,void 0,void 0,function(){var F,V=this,q,j,W,K;return __generator(this,function(G){switch(G.label){case 0:if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)throw new Error("Cannot start voice chat without media devices");return this.webSocket=U.webSocket,this.audioRawFrame=U.audioRawFrame,this.audioContext=new window.AudioContext({latencyHint:"interactive",sampleRate:16e3}),!((q=U.config)===null||q===void 0)&&q.defaultMuted||this.unmute(),[4,navigator.mediaDevices.getUserMedia({audio:{sampleRate:16e3,channelCount:1,autoGainControl:!0,echoCancellation:!0,noiseSuppression:!0}})];case 1:return F=G.sent(),this.mediaDevicesStream=F,this.mediaStreamAudioSource=(j=this.audioContext)===null||j===void 0?void 0:j.createMediaStreamSource(F),this.scriptProcessor=(W=this.audioContext)===null||W===void 0?void 0:W.createScriptProcessor(512,1,1),this.mediaStreamAudioSource.connect(this.scriptProcessor),this.scriptProcessor.connect((K=this.audioContext)===null||K===void 0?void 0:K.destination),this.scriptProcessor.onaudioprocess=function(z){var H;if(!(!V.webSocket||!V.audioRawFrame)){var Q;V.isMuted?Q=new Float32Array(512):Q=z.inputBuffer.getChannelData(0);var Y=convertFloat32ToS16PCM(Q),X=new Uint8Array(Y.buffer),Z=V.audioRawFrame.create({audio:{audio:Array.from(X),sampleRate:16e3,numChannels:1}}),ne=new Uint8Array(V.audioRawFrame.encode(Z).finish());(H=V.webSocket)===null||H===void 0||H.send(ne)}},[4,sleep$1(2e3)];case 2:return G.sent(),[2]}})})},$.prototype._stopVoiceChat=function(){return __awaiter$1(this,void 0,void 0,function(){var U,F;return __generator(this,function(V){return this.audioContext&&(this.audioContext=null),this.scriptProcessor&&(this.scriptProcessor.disconnect(),this.scriptProcessor=null),this.mediaStreamAudioSource&&(this.mediaStreamAudioSource.disconnect(),this.mediaStreamAudioSource=null),this.mediaDevicesStream&&((F=(U=this.mediaDevicesStream)===null||U===void 0?void 0:U.getTracks())===null||F===void 0||F.forEach(function(q){return q.stop()}),this.mediaDevicesStream=null),[2]})})},$})(AbstractVoiceChatImplementation),VoiceChatTransport;(function(B){B.LIVEKIT="livekit",B.WEBSOCKET="websocket"})(VoiceChatTransport||(VoiceChatTransport={}));var VoiceChatFactory=(function(B){__extends($,B);function $(U){var F=U.voiceChatInstance,V=U.initialConfig,q=B.call(this)||this;return q.initialConfig=V,q.voiceChat=F,q}return Object.defineProperty($.prototype,"isMuted",{get:function(){return this.voiceChat.isMuted},enumerable:!1,configurable:!0}),Object.defineProperty($.prototype,"isVoiceChatting",{get:function(){return this.voiceChat.isVoiceChatting},enumerable:!1,configurable:!0}),$.prototype.startVoiceChat=function(U){return __awaiter$1(this,arguments,void 0,function(F){var V=F.config;return __generator(this,function(q){switch(q.label){case 0:return[4,this.voiceChat.startVoiceChat(__assign(__assign({},this.initialConfig),{config:V}))];case 1:return q.sent(),[2]}})})},$.prototype.stopVoiceChat=function(){return __awaiter$1(this,void 0,void 0,function(){return __generator(this,function(U){switch(U.label){case 0:return[4,this.voiceChat.stopVoiceChat()];case 1:return U.sent(),[2]}})})},$.prototype.mute=function(){this.voiceChat.mute()},$.prototype.unmute=function(){this.voiceChat.unmute()},$.createLiveKitVoiceChat=function(U){return new this({voiceChatInstance:new LivekitVoiceChat,initialConfig:U})},$.createWebSocketVoiceChat=function(U){return new this({voiceChatInstance:new WebSocketVoiceChat,initialConfig:U})},$})(AbstractVoiceChat),AvatarQuality;(function(B){B.Low="low",B.Medium="medium",B.High="high"})(AvatarQuality||(AvatarQuality={}));var VoiceEmotion;(function(B){B.EXCITED="excited",B.SERIOUS="serious",B.FRIENDLY="friendly",B.SOOTHING="soothing",B.BROADCASTER="broadcaster"})(VoiceEmotion||(VoiceEmotion={}));var ElevenLabsModel;(function(B){B.eleven_flash_v2_5="eleven_flash_v2_5",B.eleven_multilingual_v2="eleven_multilingual_v2"})(ElevenLabsModel||(ElevenLabsModel={}));var STTProvider;(function(B){B.DEEPGRAM="deepgram",B.GLADIA="gladia"})(STTProvider||(STTProvider={}));var TaskType;(function(B){B.TALK="talk",B.REPEAT="repeat"})(TaskType||(TaskType={}));var TaskMode;(function(B){B.SYNC="sync",B.ASYNC="async"})(TaskMode||(TaskMode={}));var StreamingEvents;(function(B){B.AVATAR_START_TALKING="avatar_start_talking",B.AVATAR_STOP_TALKING="avatar_stop_talking",B.AVATAR_TALKING_MESSAGE="avatar_talking_message",B.AVATAR_END_MESSAGE="avatar_end_message",B.USER_TALKING_MESSAGE="user_talking_message",B.USER_END_MESSAGE="user_end_message",B.USER_START="user_start",B.USER_STOP="user_stop",B.USER_SILENCE="user_silence",B.STREAM_READY="stream_ready",B.STREAM_DISCONNECTED="stream_disconnected",B.CONNECTION_QUALITY_CHANGED="connection_quality_changed"})(StreamingEvents||(StreamingEvents={}));var APIError=(function(B){__extends($,B);function $(U,F,V){var q=B.call(this,U)||this;return q.name="APIError",q.status=F,q.responseText=V,q}return $})(Error),ConnectionQualityIndicatorClass=QualityIndicatorMixer({TrackerClass:LiveKitConnectionQualityIndicator,getParams:function(B){return B}},{TrackerClass:WebRTCConnectionQualityIndicator,getParams:function(B){var $;return(($=B.engine.pcManager)===null||$===void 0?void 0:$.subscriber)._pc}}),StreamingAvatar=(function(){function B($){var U=$.token,F=$.basePath,V=F===void 0?"https://api.heygen.com":F,q=this;this.room=null,this.mediaStream=null,this.eventTarget=new EventTarget,this.webSocket=null,this.sessionId=null,this.voiceChat=null,this.isLiveKitTransport=!1,this.enablePushToTalk=!1,this.token=U,this.basePath=V,this.connectionQualityIndicator=new ConnectionQualityIndicatorClass(function(j){return q.emit(StreamingEvents.CONNECTION_QUALITY_CHANGED,j)})}return Object.defineProperty(B.prototype,"connectionQuality",{get:function(){return this.connectionQualityIndicator.connectionQuality},enumerable:!1,configurable:!0}),Object.defineProperty(B.prototype,"isInputAudioMuted",{get:function(){var $,U;return(U=($=this.voiceChat)===null||$===void 0?void 0:$.isMuted)!==null&&U!==void 0?U:!0},enumerable:!1,configurable:!0}),B.prototype.muteInputAudio=function(){var $;($=this.voiceChat)===null||$===void 0||$.mute()},B.prototype.unmuteInputAudio=function(){var $;($=this.voiceChat)===null||$===void 0||$.unmute()},B.prototype.createStartAvatar=function($){return __awaiter$1(this,void 0,void 0,function(){var U;return __generator(this,function(F){switch(F.label){case 0:return[4,this.newSession($)];case 1:return U=F.sent(),[2,this.startAvatar($,U)]}})})},B.prototype.startAvatar=function($,U){return __awaiter$1(this,void 0,void 0,function(){var F,V,q=this,j;return __generator(this,function(W){switch(W.label){case 0:this.sessionId=U.session_id,this.isLiveKitTransport=$.voiceChatTransport===VoiceChatTransport.LIVEKIT,F=new Room$2({adaptiveStream:!0,dynacast:!0,videoCaptureDefaults:{resolution:VideoPresets$1.h720.resolution}}),this.room=F,this.mediaStream=null,this.enablePushToTalk=(j=$.enablePushToTalk)!==null&&j!==void 0?j:!1,F.on(RoomEvent$1.DataReceived,function(K){var G=null;try{var z=new TextDecoder().decode(K);G=JSON.parse(z)}catch(H){console.error(H)}G&&q.emit(G.type,G)}),V=new MediaStream,F.on(RoomEvent$1.TrackSubscribed,function(K){if(K.kind==="video"||K.kind==="audio"){V.addTrack(K.mediaStreamTrack);var G=V.getVideoTracks().length>0,z=V.getAudioTracks().length>0;G&&z&&!q.mediaStream&&(q.mediaStream=V,q.emit(StreamingEvents.STREAM_READY,q.mediaStream))}}),F.on(RoomEvent$1.TrackUnsubscribed,function(K){var G=K.mediaStreamTrack;G&&V.removeTrack(G)}),F.on(RoomEvent$1.Disconnected,function(K){q.emit(StreamingEvents.STREAM_DISCONNECTED,K)}),W.label=1;case 1:return W.trys.push([1,3,,4]),[4,F.prepareConnection(U.url,U.access_token)];case 2:return W.sent(),[3,4];case 3:return W.sent(),[3,4];case 4:return[4,this.startSession()];case 5:return W.sent(),[4,F.connect(U.url,U.access_token)];case 6:return W.sent(),[4,this.connectWebSocket({useSilencePrompt:!!$.useSilencePrompt})];case 7:return W.sent(),this.initVoiceChat($.voiceChatTransport||VoiceChatTransport.WEBSOCKET),this.connectionQualityIndicator.start(F),[2,U]}})})},B.prototype.startVoiceChat=function(){return __awaiter$1(this,arguments,void 0,function($){var U,F=$===void 0?{}:$,V=F.isInputAudioMuted;return __generator(this,function(q){switch(q.label){case 0:return[4,(U=this.voiceChat)===null||U===void 0?void 0:U.startVoiceChat({config:{defaultMuted:V}})];case 1:return q.sent(),[2]}})})},B.prototype.closeVoiceChat=function(){return __awaiter$1(this,void 0,void 0,function(){var $;return __generator(this,function(U){switch(U.label){case 0:return[4,($=this.voiceChat)===null||$===void 0?void 0:$.stopVoiceChat()];case 1:return U.sent(),[2]}})})},B.prototype.newSession=function($){return __awaiter$1(this,void 0,void 0,function(){var U,F,V,q,j;return __generator(this,function(W){return[2,this.request("/v1/streaming.new",{avatar_name:$.avatarName,quality:$.quality,knowledge_base_id:$.knowledgeId,knowledge_base:$.knowledgeBase,voice:{voice_id:(U=$.voice)===null||U===void 0?void 0:U.voiceId,rate:(F=$.voice)===null||F===void 0?void 0:F.rate,emotion:(V=$.voice)===null||V===void 0?void 0:V.emotion,elevenlabs_settings:__assign(__assign({},(q=$?.voice)===null||q===void 0?void 0:q.elevenlabsSettings),{model_id:(j=$.voice)===null||j===void 0?void 0:j.model})},language:$.language,version:"v2",video_encoding:"H264",source:"sdk",disable_idle_timeout:$.disableIdleTimeout,stt_settings:$.sttSettings,ia_is_livekit_transport:$.voiceChatTransport===VoiceChatTransport.LIVEKIT,silence_response:$.useSilencePrompt,activity_idle_timeout:$.activityIdleTimeout})]})})},B.prototype.startSession=function(){return __awaiter$1(this,void 0,void 0,function(){return __generator(this,function($){return[2,this.request("/v1/streaming.start",{session_id:this.sessionId})]})})},B.prototype.speak=function($){return __awaiter$1(this,void 0,void 0,function(){var U,F;return __generator(this,function(V){if(U=$.taskType||$.task_type||TaskType.TALK,F=$.taskMode||TaskMode.ASYNC,U===TaskType.TALK&&F===TaskMode.ASYNC){if(this.isLiveKitTransport&&this.room)return this.sendLivekitMessage($.text),[2];if(!this.isLiveKitTransport&&this.webSocket&&this.audioRawFrame)return this.sendWebsocketMessage($.text),[2]}return[2,this.request("/v1/streaming.task",{text:$.text,session_id:this.sessionId,task_mode:$.taskMode,task_type:$.taskType})]})})},B.prototype.startListening=function(){return __awaiter$1(this,void 0,void 0,function(){return __generator(this,function($){return[2,this.request("/v1/streaming.start_listening",{session_id:this.sessionId})]})})},B.prototype.stopListening=function(){return __awaiter$1(this,void 0,void 0,function(){return __generator(this,function($){return[2,this.request("/v1/streaming.stop_listening",{session_id:this.sessionId})]})})},B.prototype.interrupt=function(){return __awaiter$1(this,void 0,void 0,function(){return __generator(this,function($){return[2,this.request("/v1/streaming.interrupt",{session_id:this.sessionId})]})})},B.prototype.stopAvatar=function(){return __awaiter$1(this,void 0,void 0,function(){return __generator(this,function($){return this.closeVoiceChat(),this.connectionQualityIndicator.stop(),this.voiceChat=null,this.webSocket&&(this.webSocket.close(),this.webSocket=null),[2,this.request("/v1/streaming.stop",{session_id:this.sessionId})]})})},B.prototype.pushToTalkStart=function(){return __awaiter$1(this,void 0,void 0,function(){return __generator(this,function($){if(!this.isLiveKitTransport)throw new Error("push to talk is only supported for LiveKit transport");if(!this.enablePushToTalk)throw new Error("push to talk is not enabled");if(!this.voiceChat.isVoiceChatting)throw new Error("voice chat is not active");if(!this.room)throw new Error("room is not initialized");return[2,this.sendLivekitMessage("push_to_talk:start")]})})},B.prototype.pushToTalkStop=function(){return __awaiter$1(this,void 0,void 0,function(){return __generator(this,function($){if(!this.isLiveKitTransport)throw new Error("push to talk is only supported for LiveKit transport");if(!this.enablePushToTalk)throw new Error("push to talk is not enabled");if(this.voiceChat.isVoiceChatting||console.log("voice chat is not active"),!this.room)throw new Error("room is not initialized");return[2,this.sendLivekitMessage("push_to_talk:stop")]})})},B.prototype.keepAlive=function(){return __awaiter$1(this,void 0,void 0,function(){return __generator(this,function($){return[2,this.request("/v1/streaming.keep_alive",{session_id:this.sessionId})]})})},B.prototype.on=function($,U){return this.eventTarget.addEventListener($,U),this},B.prototype.off=function($,U){return this.eventTarget.removeEventListener($,U),this},B.prototype.sendLivekitMessage=function($){return __awaiter$1(this,void 0,void 0,function(){var U;return __generator(this,function(F){return this.room?(U=new TextEncoder().encode(JSON.stringify($)),this.room.localParticipant.publishData(U,{reliable:!0}),[2]):[2]})})},B.prototype.sendWebsocketMessage=function($){return __awaiter$1(this,void 0,void 0,function(){var U,F,V,q;return __generator(this,function(j){return!this.webSocket||!this.audioRawFrame?[2]:(U=(V=this.audioRawFrame)===null||V===void 0?void 0:V.create({text:{text:$}}),F=new Uint8Array((q=this.audioRawFrame)===null||q===void 0?void 0:q.encode(U).finish()),this.webSocket.send(F),[2])})})},B.prototype.initVoiceChat=function($){if($===VoiceChatTransport.WEBSOCKET){if(this.loadAudioRawFrame(),!this.audioRawFrame||!this.webSocket)return;this.voiceChat=VoiceChatFactory.createWebSocketVoiceChat({webSocket:this.webSocket,audioRawFrame:this.audioRawFrame})}else{if(!this.room)return;this.voiceChat=VoiceChatFactory.createLiveKitVoiceChat({room:this.room})}},B.prototype.request=function($,U,F){return __awaiter$1(this,void 0,void 0,function(){var V,q,j,W;return __generator(this,function(K){switch(K.label){case 0:return K.trys.push([0,5,,6]),[4,fetch(this.getRequestUrl($),{method:"POST",headers:{Authorization:"Bearer ".concat(this.token),"Content-Type":"application/json"},body:JSON.stringify(U)})];case 1:return V=K.sent(),V.ok?[3,3]:[4,V.text()];case 2:throw q=K.sent(),new APIError("API request failed with status ".concat(V.status),V.status,q);case 3:return[4,V.json()];case 4:return j=K.sent(),[2,j.data];case 5:throw W=K.sent(),W;case 6:return[2]}})})},B.prototype.emit=function($,U){var F=new CustomEvent($,{detail:U});this.eventTarget.dispatchEvent(F)},B.prototype.getRequestUrl=function($){return"".concat(this.basePath).concat($)},B.prototype.connectWebSocket=function($){return __awaiter$1(this,void 0,void 0,function(){var U,F=this;return __generator(this,function(V){return U="wss://".concat(new URL(this.basePath).hostname,"/v1/ws/streaming.chat?session_id=").concat(this.sessionId,"&session_token=").concat(this.token).concat(this.isLiveKitTransport?"&arch_version=v2":"","&silence_response=").concat($.useSilencePrompt,"&push_to_talk=").concat(this.enablePushToTalk),this.webSocket=new WebSocket(U),this.webSocket.addEventListener("message",function(q){var j=null;try{j=JSON.parse(q.data)}catch(W){console.error(W);return}j&&F.emit(j.event_type,j)}),this.webSocket.addEventListener("close",function(q){F.webSocket=null}),[2,new Promise(function(q,j){var W,K;(W=F.webSocket)===null||W===void 0||W.addEventListener("error",function(G){F.webSocket=null,j(G)}),(K=F.webSocket)===null||K===void 0||K.addEventListener("open",function(){q(!0)})})]})})},B.prototype.loadAudioRawFrame=function(){return __awaiter$1(this,void 0,void 0,function(){var $;return __generator(this,function(U){return this.audioRawFrame||($=protobuf.Root.fromJSON(jsonDescriptor),this.audioRawFrame=$?.lookupType("pipecat.Frame")),[2]})})},B})();function _mergeNamespaces$1(B,$){return $.forEach(function(U){U&&typeof U!="string"&&!Array.isArray(U)&&Object.keys(U).forEach(function(F){if(F!=="default"&&!(F in B)){var V=Object.getOwnPropertyDescriptor(U,F);Object.defineProperty(B,F,V.get?V:{enumerable:!0,get:function(){return U[F]}})}})}),Object.freeze(B)}var e=Object.defineProperty,h=(B,$,U)=>$ in B?e(B,$,{enumerable:!0,configurable:!0,writable:!0,value:U}):B[$]=U,o=(B,$,U)=>h(B,typeof $!="symbol"?$+"":$,U);class _{constructor(){o(this,"_locking"),o(this,"_locks"),this._locking=Promise.resolve(),this._locks=0}isLocked(){return this._locks>0}lock(){this._locks+=1;let $;const U=new Promise(V=>$=()=>{this._locks-=1,V()}),F=this._locking.then(()=>$);return this._locking=this._locking.then(()=>U),F}}function assert(B,$){if(!B)throw new Error($)}const FLOAT32_MAX=34028234663852886e22,FLOAT32_MIN=-34028234663852886e22,UINT32_MAX=4294967295,INT32_MAX=2147483647,INT32_MIN=-2147483648;function assertInt32(B){if(typeof B!="number")throw new Error("invalid int 32: "+typeof B);if(!Number.isInteger(B)||B>INT32_MAX||B<INT32_MIN)throw new Error("invalid int 32: "+B)}function assertUInt32(B){if(typeof B!="number")throw new Error("invalid uint 32: "+typeof B);if(!Number.isInteger(B)||B>UINT32_MAX||B<0)throw new Error("invalid uint 32: "+B)}function assertFloat32(B){if(typeof B!="number")throw new Error("invalid float 32: "+typeof B);if(Number.isFinite(B)&&(B>FLOAT32_MAX||B<FLOAT32_MIN))throw new Error("invalid float 32: "+B)}const enumTypeSymbol=Symbol("@bufbuild/protobuf/enum-type");function getEnumType(B){const $=B[enumTypeSymbol];return assert($,"missing enum type on enum object"),$}function setEnumType(B,$,U,F){B[enumTypeSymbol]=makeEnumType($,U.map(V=>({no:V.no,name:V.name,localName:B[V.no]})))}function makeEnumType(B,$,U){const F=Object.create(null),V=Object.create(null),q=[];for(const j of $){const W=normalizeEnumValue(j);q.push(W),F[j.name]=W,V[j.no]=W}return{typeName:B,values:q,findName(j){return F[j]},findNumber(j){return V[j]}}}function makeEnum(B,$,U){const F={};for(const V of $){const q=normalizeEnumValue(V);F[q.localName]=q.no,F[q.no]=q.localName}return setEnumType(F,B,$),F}function normalizeEnumValue(B){return"localName"in B?B:Object.assign(Object.assign({},B),{localName:B.name})}class Message{equals($){return this.getType().runtime.util.equals(this.getType(),this,$)}clone(){return this.getType().runtime.util.clone(this)}fromBinary($,U){const F=this.getType(),V=F.runtime.bin,q=V.makeReadOptions(U);return V.readMessage(this,q.readerFactory($),$.byteLength,q),this}fromJson($,U){const F=this.getType(),V=F.runtime.json,q=V.makeReadOptions(U);return V.readMessage(F,$,q,this),this}fromJsonString($,U){let F;try{F=JSON.parse($)}catch(V){throw new Error("cannot decode ".concat(this.getType().typeName," from JSON: ").concat(V instanceof Error?V.message:String(V)))}return this.fromJson(F,U)}toBinary($){const U=this.getType(),F=U.runtime.bin,V=F.makeWriteOptions($),q=V.writerFactory();return F.writeMessage(this,q,V),q.finish()}toJson($){const U=this.getType(),F=U.runtime.json,V=F.makeWriteOptions($);return F.writeMessage(this,V)}toJsonString($){var U;const F=this.toJson($);return JSON.stringify(F,null,(U=$?.prettySpaces)!==null&&U!==void 0?U:0)}toJSON(){return this.toJson({emitDefaultValues:!0})}getType(){return Object.getPrototypeOf(this).constructor}}function makeMessageType(B,$,U,F){var V;const q=(V=F?.localName)!==null&&V!==void 0?V:$.substring($.lastIndexOf(".")+1),j={[q]:function(W){B.util.initFields(this),B.util.initPartial(W,this)}}[q];return Object.setPrototypeOf(j.prototype,new Message),Object.assign(j,{runtime:B,typeName:$,fields:B.util.newFieldList(U),fromBinary(W,K){return new j().fromBinary(W,K)},fromJson(W,K){return new j().fromJson(W,K)},fromJsonString(W,K){return new j().fromJsonString(W,K)},equals(W,K){return B.util.equals(j,W,K)}}),j}function varint64read(){let B=0,$=0;for(let F=0;F<28;F+=7){let V=this.buf[this.pos++];if(B|=(V&127)<<F,(V&128)==0)return this.assertBounds(),[B,$]}let U=this.buf[this.pos++];if(B|=(U&15)<<28,$=(U&112)>>4,(U&128)==0)return this.assertBounds(),[B,$];for(let F=3;F<=31;F+=7){let V=this.buf[this.pos++];if($|=(V&127)<<F,(V&128)==0)return this.assertBounds(),[B,$]}throw new Error("invalid varint")}function varint64write(B,$,U){for(let q=0;q<28;q=q+7){const j=B>>>q,W=!(!(j>>>7)&&$==0),K=(W?j|128:j)&255;if(U.push(K),!W)return}const F=B>>>28&15|($&7)<<4,V=$>>3!=0;if(U.push((V?F|128:F)&255),!!V){for(let q=3;q<31;q=q+7){const j=$>>>q,W=!!(j>>>7),K=(W?j|128:j)&255;if(U.push(K),!W)return}U.push($>>>31&1)}}const TWO_PWR_32_DBL=4294967296;function int64FromString(B){const $=B[0]==="-";$&&(B=B.slice(1));const U=1e6;let F=0,V=0;function q(j,W){const K=Number(B.slice(j,W));V*=U,F=F*U+K,F>=TWO_PWR_32_DBL&&(V=V+(F/TWO_PWR_32_DBL|0),F=F%TWO_PWR_32_DBL)}return q(-24,-18),q(-18,-12),q(-12,-6),q(-6),$?negate(F,V):newBits(F,V)}function int64ToString(B,$){let U=newBits(B,$);const F=U.hi&2147483648;F&&(U=negate(U.lo,U.hi));const V=uInt64ToString(U.lo,U.hi);return F?"-"+V:V}function uInt64ToString(B,$){if({lo:B,hi:$}=toUnsigned(B,$),$<=2097151)return String(TWO_PWR_32_DBL*$+B);const U=B&16777215,F=(B>>>24|$<<8)&16777215,V=$>>16&65535;let q=U+F*6777216+V*6710656,j=F+V*8147497,W=V*2;const K=1e7;return q>=K&&(j+=Math.floor(q/K),q%=K),j>=K&&(W+=Math.floor(j/K),j%=K),W.toString()+decimalFrom1e7WithLeadingZeros(j)+decimalFrom1e7WithLeadingZeros(q)}function toUnsigned(B,$){return{lo:B>>>0,hi:$>>>0}}function newBits(B,$){return{lo:B|0,hi:$|0}}function negate(B,$){return $=~$,B?B=~B+1:$+=1,newBits(B,$)}const decimalFrom1e7WithLeadingZeros=B=>{const $=String(B);return"0000000".slice($.length)+$};function varint32write(B,$){if(B>=0){for(;B>127;)$.push(B&127|128),B=B>>>7;$.push(B)}else{for(let U=0;U<9;U++)$.push(B&127|128),B=B>>7;$.push(1)}}function varint32read(){let B=this.buf[this.pos++],$=B&127;if((B&128)==0)return this.assertBounds(),$;if(B=this.buf[this.pos++],$|=(B&127)<<7,(B&128)==0)return this.assertBounds(),$;if(B=this.buf[this.pos++],$|=(B&127)<<14,(B&128)==0)return this.assertBounds(),$;if(B=this.buf[this.pos++],$|=(B&127)<<21,(B&128)==0)return this.assertBounds(),$;B=this.buf[this.pos++],$|=(B&15)<<28;for(let U=5;(B&128)!==0&&U<10;U++)B=this.buf[this.pos++];if((B&128)!=0)throw new Error("invalid varint");return this.assertBounds(),$>>>0}function makeInt64Support(){const B=new DataView(new ArrayBuffer(8));if(typeof BigInt=="function"&&typeof B.getBigInt64=="function"&&typeof B.getBigUint64=="function"&&typeof B.setBigInt64=="function"&&typeof B.setBigUint64=="function"&&(typeof process!="object"||typeof process.env!="object"||process.env.BUF_BIGINT_DISABLE!=="1")){const V=BigInt("-9223372036854775808"),q=BigInt("9223372036854775807"),j=BigInt("0"),W=BigInt("18446744073709551615");return{zero:BigInt(0),supported:!0,parse(K){const G=typeof K=="bigint"?K:BigInt(K);if(G>q||G<V)throw new Error("int64 invalid: ".concat(K));return G},uParse(K){const G=typeof K=="bigint"?K:BigInt(K);if(G>W||G<j)throw new Error("uint64 invalid: ".concat(K));return G},enc(K){return B.setBigInt64(0,this.parse(K),!0),{lo:B.getInt32(0,!0),hi:B.getInt32(4,!0)}},uEnc(K){return B.setBigInt64(0,this.uParse(K),!0),{lo:B.getInt32(0,!0),hi:B.getInt32(4,!0)}},dec(K,G){return B.setInt32(0,K,!0),B.setInt32(4,G,!0),B.getBigInt64(0,!0)},uDec(K,G){return B.setInt32(0,K,!0),B.setInt32(4,G,!0),B.getBigUint64(0,!0)}}}const U=V=>assert(/^-?[0-9]+$/.test(V),"int64 invalid: ".concat(V)),F=V=>assert(/^[0-9]+$/.test(V),"uint64 invalid: ".concat(V));return{zero:"0",supported:!1,parse(V){return typeof V!="string"&&(V=V.toString()),U(V),V},uParse(V){return typeof V!="string"&&(V=V.toString()),F(V),V},enc(V){return typeof V!="string"&&(V=V.toString()),U(V),int64FromString(V)},uEnc(V){return typeof V!="string"&&(V=V.toString()),F(V),int64FromString(V)},dec(V,q){return int64ToString(V,q)},uDec(V,q){return uInt64ToString(V,q)}}}const protoInt64=makeInt64Support();var ScalarType;(function(B){B[B.DOUBLE=1]="DOUBLE",B[B.FLOAT=2]="FLOAT",B[B.INT64=3]="INT64",B[B.UINT64=4]="UINT64",B[B.INT32=5]="INT32",B[B.FIXED64=6]="FIXED64",B[B.FIXED32=7]="FIXED32",B[B.BOOL=8]="BOOL",B[B.STRING=9]="STRING",B[B.BYTES=12]="BYTES",B[B.UINT32=13]="UINT32",B[B.SFIXED32=15]="SFIXED32",B[B.SFIXED64=16]="SFIXED64",B[B.SINT32=17]="SINT32",B[B.SINT64=18]="SINT64"})(ScalarType||(ScalarType={}));var LongType;(function(B){B[B.BIGINT=0]="BIGINT",B[B.STRING=1]="STRING"})(LongType||(LongType={}));function scalarEquals(B,$,U){if($===U)return!0;if(B==ScalarType.BYTES){if(!($ instanceof Uint8Array)||!(U instanceof Uint8Array)||$.length!==U.length)return!1;for(let F=0;F<$.length;F++)if($[F]!==U[F])return!1;return!0}switch(B){case ScalarType.UINT64:case ScalarType.FIXED64:case ScalarType.INT64:case ScalarType.SFIXED64:case ScalarType.SINT64:return $==U}return!1}function scalarZeroValue(B,$){switch(B){case ScalarType.BOOL:return!1;case ScalarType.UINT64:case ScalarType.FIXED64:case ScalarType.INT64:case ScalarType.SFIXED64:case ScalarType.SINT64:return $==0?protoInt64.zero:"0";case ScalarType.DOUBLE:case ScalarType.FLOAT:return 0;case ScalarType.BYTES:return new Uint8Array(0);case ScalarType.STRING:return"";default:return 0}}function isScalarZeroValue(B,$){switch(B){case ScalarType.BOOL:return $===!1;case ScalarType.STRING:return $==="";case ScalarType.BYTES:return $ instanceof Uint8Array&&!$.byteLength;default:return $==0}}var WireType;(function(B){B[B.Varint=0]="Varint",B[B.Bit64=1]="Bit64",B[B.LengthDelimited=2]="LengthDelimited",B[B.StartGroup=3]="StartGroup",B[B.EndGroup=4]="EndGroup",B[B.Bit32=5]="Bit32"})(WireType||(WireType={}));class BinaryWriter{constructor($){this.stack=[],this.textEncoder=$??new TextEncoder,this.chunks=[],this.buf=[]}finish(){this.chunks.push(new Uint8Array(this.buf));let $=0;for(let V=0;V<this.chunks.length;V++)$+=this.chunks[V].length;let U=new Uint8Array($),F=0;for(let V=0;V<this.chunks.length;V++)U.set(this.chunks[V],F),F+=this.chunks[V].length;return this.chunks=[],U}fork(){return this.stack.push({chunks:this.chunks,buf:this.buf}),this.chunks=[],this.buf=[],this}join(){let $=this.finish(),U=this.stack.pop();if(!U)throw new Error("invalid state, fork stack empty");return this.chunks=U.chunks,this.buf=U.buf,this.uint32($.byteLength),this.raw($)}tag($,U){return this.uint32(($<<3|U)>>>0)}raw($){return this.buf.length&&(this.chunks.push(new Uint8Array(this.buf)),this.buf=[]),this.chunks.push($),this}uint32($){for(assertUInt32($);$>127;)this.buf.push($&127|128),$=$>>>7;return this.buf.push($),this}int32($){return assertInt32($),varint32write($,this.buf),this}bool($){return this.buf.push($?1:0),this}bytes($){return this.uint32($.byteLength),this.raw($)}string($){let U=this.textEncoder.encode($);return this.uint32(U.byteLength),this.raw(U)}float($){assertFloat32($);let U=new Uint8Array(4);return new DataView(U.buffer).setFloat32(0,$,!0),this.raw(U)}double($){let U=new Uint8Array(8);return new DataView(U.buffer).setFloat64(0,$,!0),this.raw(U)}fixed32($){assertUInt32($);let U=new Uint8Array(4);return new DataView(U.buffer).setUint32(0,$,!0),this.raw(U)}sfixed32($){assertInt32($);let U=new Uint8Array(4);return new DataView(U.buffer).setInt32(0,$,!0),this.raw(U)}sint32($){return assertInt32($),$=($<<1^$>>31)>>>0,varint32write($,this.buf),this}sfixed64($){let U=new Uint8Array(8),F=new DataView(U.buffer),V=protoInt64.enc($);return F.setInt32(0,V.lo,!0),F.setInt32(4,V.hi,!0),this.raw(U)}fixed64($){let U=new Uint8Array(8),F=new DataView(U.buffer),V=protoInt64.uEnc($);return F.setInt32(0,V.lo,!0),F.setInt32(4,V.hi,!0),this.raw(U)}int64($){let U=protoInt64.enc($);return varint64write(U.lo,U.hi,this.buf),this}sint64($){let U=protoInt64.enc($),F=U.hi>>31,V=U.lo<<1^F,q=(U.hi<<1|U.lo>>>31)^F;return varint64write(V,q,this.buf),this}uint64($){let U=protoInt64.uEnc($);return varint64write(U.lo,U.hi,this.buf),this}}class BinaryReader{constructor($,U){this.varint64=varint64read,this.uint32=varint32read,this.buf=$,this.len=$.length,this.pos=0,this.view=new DataView($.buffer,$.byteOffset,$.byteLength),this.textDecoder=U??new TextDecoder}tag(){let $=this.uint32(),U=$>>>3,F=$&7;if(U<=0||F<0||F>5)throw new Error("illegal tag: field no "+U+" wire type "+F);return[U,F]}skip($,U){let F=this.pos;switch($){case WireType.Varint:for(;this.buf[this.pos++]&128;);break;case WireType.Bit64:this.pos+=4;case WireType.Bit32:this.pos+=4;break;case WireType.LengthDelimited:let V=this.uint32();this.pos+=V;break;case WireType.StartGroup:for(;;){const[q,j]=this.tag();if(j===WireType.EndGroup){if(U!==void 0&&q!==U)throw new Error("invalid end group tag");break}this.skip(j,q)}break;default:throw new Error("cant skip wire type "+$)}return this.assertBounds(),this.buf.subarray(F,this.pos)}assertBounds(){if(this.pos>this.len)throw new RangeError("premature EOF")}int32(){return this.uint32()|0}sint32(){let $=this.uint32();return $>>>1^-($&1)}int64(){return protoInt64.dec(...this.varint64())}uint64(){return protoInt64.uDec(...this.varint64())}sint64(){let[$,U]=this.varint64(),F=-($&1);return $=($>>>1|(U&1)<<31)^F,U=U>>>1^F,protoInt64.dec($,U)}bool(){let[$,U]=this.varint64();return $!==0||U!==0}fixed32(){return this.view.getUint32((this.pos+=4)-4,!0)}sfixed32(){return this.view.getInt32((this.pos+=4)-4,!0)}fixed64(){return protoInt64.uDec(this.sfixed32(),this.sfixed32())}sfixed64(){return protoInt64.dec(this.sfixed32(),this.sfixed32())}float(){return this.view.getFloat32((this.pos+=4)-4,!0)}double(){return this.view.getFloat64((this.pos+=8)-8,!0)}bytes(){let $=this.uint32(),U=this.pos;return this.pos+=$,this.assertBounds(),this.buf.subarray(U,U+$)}string(){return this.textDecoder.decode(this.bytes())}}function makeExtension(B,$,U,F){let V;return{typeName:$,extendee:U,get field(){if(!V){const q=typeof F=="function"?F():F;q.name=$.split(".").pop(),q.jsonName="[".concat($,"]"),V=B.util.newFieldList([q]).list()[0]}return V},runtime:B}}function createExtensionContainer(B){const $=B.field.localName,U=Object.create(null);return U[$]=initExtensionField(B),[U,()=>U[$]]}function initExtensionField(B){const $=B.field;if($.repeated)return[];if($.default!==void 0)return $.default;switch($.kind){case"enum":return $.T.values[0].no;case"scalar":return scalarZeroValue($.T,$.L);case"message":const U=$.T,F=new U;return U.fieldWrapper?U.fieldWrapper.unwrapField(F):F;case"map":throw"map fields are not allowed to be extensions"}}function filterUnknownFields(B,$){if(!$.repeated&&($.kind=="enum"||$.kind=="scalar")){for(let U=B.length-1;U>=0;--U)if(B[U].no==$.no)return[B[U]];return[]}return B.filter(U=>U.no===$.no)}let encTable="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".split(""),decTable=[];for(let B=0;B<encTable.length;B++)decTable[encTable[B].charCodeAt(0)]=B;decTable[45]=encTable.indexOf("+"),decTable[95]=encTable.indexOf("/");const protoBase64={dec(B){let $=B.length*3/4;B[B.length-2]=="="?$-=2:B[B.length-1]=="="&&($-=1);let U=new Uint8Array($),F=0,V=0,q,j=0;for(let W=0;W<B.length;W++){if(q=decTable[B.charCodeAt(W)],q===void 0)switch(B[W]){case"=":V=0;case`
`:case"\r":case"	":case" ":continue;default:throw Error("invalid base64 string.")}switch(V){case 0:j=q,V=1;break;case 1:U[F++]=j<<2|(q&48)>>4,j=q,V=2;break;case 2:U[F++]=(j&15)<<4|(q&60)>>2,j=q,V=3;break;case 3:U[F++]=(j&3)<<6|q,V=0;break}}if(V==1)throw Error("invalid base64 string.");return U.subarray(0,F)},enc(B){let $="",U=0,F,V=0;for(let q=0;q<B.length;q++)switch(F=B[q],U){case 0:$+=encTable[F>>2],V=(F&3)<<4,U=1;break;case 1:$+=encTable[V|F>>4],V=(F&15)<<2,U=2;break;case 2:$+=encTable[V|F>>6],$+=encTable[F&63],U=0;break}return U&&($+=encTable[V],$+="=",U==1&&($+="=")),$}};function getExtension(B,$,U){assertExtendee($,B);const F=$.runtime.bin.makeReadOptions(U),V=filterUnknownFields(B.getType().runtime.bin.listUnknownFields(B),$.field),[q,j]=createExtensionContainer($);for(const W of V)$.runtime.bin.readField(q,F.readerFactory(W.data),$.field,W.wireType,F);return j()}function setExtension(B,$,U,F){assertExtendee($,B);const V=$.runtime.bin.makeReadOptions(F),q=$.runtime.bin.makeWriteOptions(F);if(hasExtension(B,$)){const G=B.getType().runtime.bin.listUnknownFields(B).filter(z=>z.no!=$.field.no);B.getType().runtime.bin.discardUnknownFields(B);for(const z of G)B.getType().runtime.bin.onUnknownField(B,z.no,z.wireType,z.data)}const j=q.writerFactory();let W=$.field;!W.opt&&!W.repeated&&(W.kind=="enum"||W.kind=="scalar")&&(W=Object.assign(Object.assign({},$.field),{opt:!0})),$.runtime.bin.writeField(W,U,j,q);const K=V.readerFactory(j.finish());for(;K.pos<K.len;){const[G,z]=K.tag(),H=K.skip(z,G);B.getType().runtime.bin.onUnknownField(B,G,z,H)}}function hasExtension(B,$){const U=B.getType();return $.extendee.typeName===U.typeName&&!!U.runtime.bin.listUnknownFields(B).find(F=>F.no==$.field.no)}function assertExtendee(B,$){assert(B.extendee.typeName==$.getType().typeName,"extension ".concat(B.typeName," can only be applied to message ").concat(B.extendee.typeName))}function isFieldSet(B,$){const U=B.localName;if(B.repeated)return $[U].length>0;if(B.oneof)return $[B.oneof.localName].case===U;switch(B.kind){case"enum":case"scalar":return B.opt||B.req?$[U]!==void 0:B.kind=="enum"?$[U]!==B.T.values[0].no:!isScalarZeroValue(B.T,$[U]);case"message":return $[U]!==void 0;case"map":return Object.keys($[U]).length>0}}function clearField(B,$){const U=B.localName,F=!B.opt&&!B.req;if(B.repeated)$[U]=[];else if(B.oneof)$[B.oneof.localName]={case:void 0};else switch(B.kind){case"map":$[U]={};break;case"enum":$[U]=F?B.T.values[0].no:void 0;break;case"scalar":$[U]=F?scalarZeroValue(B.T,B.L):void 0;break;case"message":$[U]=void 0;break}}function isMessage(B,$){if(B===null||typeof B!="object"||!Object.getOwnPropertyNames(Message.prototype).every(F=>F in B&&typeof B[F]=="function"))return!1;const U=B.getType();return U===null||typeof U!="function"||!("typeName"in U)||typeof U.typeName!="string"?!1:$===void 0?!0:U.typeName==$.typeName}function wrapField(B,$){return isMessage($)||!B.fieldWrapper?$:B.fieldWrapper.wrapField($)}ScalarType.DOUBLE,ScalarType.FLOAT,ScalarType.INT64,ScalarType.UINT64,ScalarType.INT32,ScalarType.UINT32,ScalarType.BOOL,ScalarType.STRING,ScalarType.BYTES;const jsonReadDefaults={ignoreUnknownFields:!1},jsonWriteDefaults={emitDefaultValues:!1,enumAsInteger:!1,useProtoFieldName:!1,prettySpaces:0};function makeReadOptions$1(B){return B?Object.assign(Object.assign({},jsonReadDefaults),B):jsonReadDefaults}function makeWriteOptions$1(B){return B?Object.assign(Object.assign({},jsonWriteDefaults),B):jsonWriteDefaults}const tokenNull=Symbol(),tokenIgnoredUnknownEnum=Symbol();function makeJsonFormat(){return{makeReadOptions:makeReadOptions$1,makeWriteOptions:makeWriteOptions$1,readMessage(B,$,U,F){if($==null||Array.isArray($)||typeof $!="object")throw new Error("cannot decode message ".concat(B.typeName," from JSON: ").concat(debugJsonValue($)));F=F??new B;const V=new Map,q=U.typeRegistry;for(const[j,W]of Object.entries($)){const K=B.fields.findJsonName(j);if(K){if(K.oneof){if(W===null&&K.kind=="scalar")continue;const G=V.get(K.oneof);if(G!==void 0)throw new Error("cannot decode message ".concat(B.typeName,' from JSON: multiple keys for oneof "').concat(K.oneof.name,'" present: "').concat(G,'", "').concat(j,'"'));V.set(K.oneof,j)}readField$1(F,W,K,U,B)}else{let G=!1;if(q?.findExtension&&j.startsWith("[")&&j.endsWith("]")){const z=q.findExtension(j.substring(1,j.length-1));if(z&&z.extendee.typeName==B.typeName){G=!0;const[H,Q]=createExtensionContainer(z);readField$1(H,W,z.field,U,z),setExtension(F,z,Q(),U)}}if(!G&&!U.ignoreUnknownFields)throw new Error("cannot decode message ".concat(B.typeName,' from JSON: key "').concat(j,'" is unknown'))}}return F},writeMessage(B,$){const U=B.getType(),F={};let V;try{for(V of U.fields.byNumber()){if(!isFieldSet(V,B)){if(V.req)throw"required field not set";if(!$.emitDefaultValues||!canEmitFieldDefaultValue(V))continue}const j=V.oneof?B[V.oneof.localName].value:B[V.localName],W=writeField$1(V,j,$);W!==void 0&&(F[$.useProtoFieldName?V.name:V.jsonName]=W)}const q=$.typeRegistry;if(q?.findExtensionFor)for(const j of U.runtime.bin.listUnknownFields(B)){const W=q.findExtensionFor(U.typeName,j.no);if(W&&hasExtension(B,W)){const K=getExtension(B,W,$),G=writeField$1(W.field,K,$);G!==void 0&&(F[W.field.jsonName]=G)}}}catch(q){const j=V?"cannot encode field ".concat(U.typeName,".").concat(V.name," to JSON"):"cannot encode message ".concat(U.typeName," to JSON"),W=q instanceof Error?q.message:String(q);throw new Error(j+(W.length>0?": ".concat(W):""))}return F},readScalar(B,$,U){return readScalar$1(B,$,U??LongType.BIGINT,!0)},writeScalar(B,$,U){if($!==void 0&&(U||isScalarZeroValue(B,$)))return writeScalar$1(B,$)},debug:debugJsonValue}}function debugJsonValue(B){if(B===null)return"null";switch(typeof B){case"object":return Array.isArray(B)?"array":"object";case"string":return B.length>100?"string":'"'.concat(B.split('"').join('\\"'),'"');default:return String(B)}}function readField$1(B,$,U,F,V){let q=U.localName;if(U.repeated){if(assert(U.kind!="map"),$===null)return;if(!Array.isArray($))throw new Error("cannot decode field ".concat(V.typeName,".").concat(U.name," from JSON: ").concat(debugJsonValue($)));const j=B[q];for(const W of $){if(W===null)throw new Error("cannot decode field ".concat(V.typeName,".").concat(U.name," from JSON: ").concat(debugJsonValue(W)));switch(U.kind){case"message":j.push(U.T.fromJson(W,F));break;case"enum":const K=readEnum(U.T,W,F.ignoreUnknownFields,!0);K!==tokenIgnoredUnknownEnum&&j.push(K);break;case"scalar":try{j.push(readScalar$1(U.T,W,U.L,!0))}catch(G){let z="cannot decode field ".concat(V.typeName,".").concat(U.name," from JSON: ").concat(debugJsonValue(W));throw G instanceof Error&&G.message.length>0&&(z+=": ".concat(G.message)),new Error(z)}break}}}else if(U.kind=="map"){if($===null)return;if(typeof $!="object"||Array.isArray($))throw new Error("cannot decode field ".concat(V.typeName,".").concat(U.name," from JSON: ").concat(debugJsonValue($)));const j=B[q];for(const[W,K]of Object.entries($)){if(K===null)throw new Error("cannot decode field ".concat(V.typeName,".").concat(U.name," from JSON: map value null"));let G;try{G=readMapKey(U.K,W)}catch(z){let H="cannot decode map key for field ".concat(V.typeName,".").concat(U.name," from JSON: ").concat(debugJsonValue($));throw z instanceof Error&&z.message.length>0&&(H+=": ".concat(z.message)),new Error(H)}switch(U.V.kind){case"message":j[G]=U.V.T.fromJson(K,F);break;case"enum":const z=readEnum(U.V.T,K,F.ignoreUnknownFields,!0);z!==tokenIgnoredUnknownEnum&&(j[G]=z);break;case"scalar":try{j[G]=readScalar$1(U.V.T,K,LongType.BIGINT,!0)}catch(H){let Q="cannot decode map value for field ".concat(V.typeName,".").concat(U.name," from JSON: ").concat(debugJsonValue($));throw H instanceof Error&&H.message.length>0&&(Q+=": ".concat(H.message)),new Error(Q)}break}}}else switch(U.oneof&&(B=B[U.oneof.localName]={case:q},q="value"),U.kind){case"message":const j=U.T;if($===null&&j.typeName!="google.protobuf.Value")return;let W=B[q];isMessage(W)?W.fromJson($,F):(B[q]=W=j.fromJson($,F),j.fieldWrapper&&!U.oneof&&(B[q]=j.fieldWrapper.unwrapField(W)));break;case"enum":const K=readEnum(U.T,$,F.ignoreUnknownFields,!1);switch(K){case tokenNull:clearField(U,B);break;case tokenIgnoredUnknownEnum:break;default:B[q]=K;break}break;case"scalar":try{const G=readScalar$1(U.T,$,U.L,!1);switch(G){case tokenNull:clearField(U,B);break;default:B[q]=G;break}}catch(G){let z="cannot decode field ".concat(V.typeName,".").concat(U.name," from JSON: ").concat(debugJsonValue($));throw G instanceof Error&&G.message.length>0&&(z+=": ".concat(G.message)),new Error(z)}break}}function readMapKey(B,$){if(B===ScalarType.BOOL)switch($){case"true":$=!0;break;case"false":$=!1;break}return readScalar$1(B,$,LongType.BIGINT,!0).toString()}function readScalar$1(B,$,U,F){if($===null)return F?scalarZeroValue(B,U):tokenNull;switch(B){case ScalarType.DOUBLE:case ScalarType.FLOAT:if($==="NaN")return Number.NaN;if($==="Infinity")return Number.POSITIVE_INFINITY;if($==="-Infinity")return Number.NEGATIVE_INFINITY;if($===""||typeof $=="string"&&$.trim().length!==$.length||typeof $!="string"&&typeof $!="number")break;const V=Number($);if(Number.isNaN(V)||!Number.isFinite(V))break;return B==ScalarType.FLOAT&&assertFloat32(V),V;case ScalarType.INT32:case ScalarType.FIXED32:case ScalarType.SFIXED32:case ScalarType.SINT32:case ScalarType.UINT32:let q;if(typeof $=="number"?q=$:typeof $=="string"&&$.length>0&&$.trim().length===$.length&&(q=Number($)),q===void 0)break;return B==ScalarType.UINT32||B==ScalarType.FIXED32?assertUInt32(q):assertInt32(q),q;case ScalarType.INT64:case ScalarType.SFIXED64:case ScalarType.SINT64:if(typeof $!="number"&&typeof $!="string")break;const j=protoInt64.parse($);return U?j.toString():j;case ScalarType.FIXED64:case ScalarType.UINT64:if(typeof $!="number"&&typeof $!="string")break;const W=protoInt64.uParse($);return U?W.toString():W;case ScalarType.BOOL:if(typeof $!="boolean")break;return $;case ScalarType.STRING:if(typeof $!="string")break;try{encodeURIComponent($)}catch{throw new Error("invalid UTF8")}return $;case ScalarType.BYTES:if($==="")return new Uint8Array(0);if(typeof $!="string")break;return protoBase64.dec($)}throw new Error}function readEnum(B,$,U,F){if($===null)return B.typeName=="google.protobuf.NullValue"?0:F?B.values[0].no:tokenNull;switch(typeof $){case"number":if(Number.isInteger($))return $;break;case"string":const V=B.findName($);if(V!==void 0)return V.no;if(U)return tokenIgnoredUnknownEnum;break}throw new Error("cannot decode enum ".concat(B.typeName," from JSON: ").concat(debugJsonValue($)))}function canEmitFieldDefaultValue(B){return B.repeated||B.kind=="map"?!0:!(B.oneof||B.kind=="message"||B.opt||B.req)}function writeField$1(B,$,U){if(B.kind=="map"){assert(typeof $=="object"&&$!=null);const F={},V=Object.entries($);switch(B.V.kind){case"scalar":for(const[j,W]of V)F[j.toString()]=writeScalar$1(B.V.T,W);break;case"message":for(const[j,W]of V)F[j.toString()]=W.toJson(U);break;case"enum":const q=B.V.T;for(const[j,W]of V)F[j.toString()]=writeEnum(q,W,U.enumAsInteger);break}return U.emitDefaultValues||V.length>0?F:void 0}if(B.repeated){assert(Array.isArray($));const F=[];switch(B.kind){case"scalar":for(let V=0;V<$.length;V++)F.push(writeScalar$1(B.T,$[V]));break;case"enum":for(let V=0;V<$.length;V++)F.push(writeEnum(B.T,$[V],U.enumAsInteger));break;case"message":for(let V=0;V<$.length;V++)F.push($[V].toJson(U));break}return U.emitDefaultValues||F.length>0?F:void 0}switch(B.kind){case"scalar":return writeScalar$1(B.T,$);case"enum":return writeEnum(B.T,$,U.enumAsInteger);case"message":return wrapField(B.T,$).toJson(U)}}function writeEnum(B,$,U){var F;if(assert(typeof $=="number"),B.typeName=="google.protobuf.NullValue")return null;if(U)return $;const V=B.findNumber($);return(F=V?.name)!==null&&F!==void 0?F:$}function writeScalar$1(B,$){switch(B){case ScalarType.INT32:case ScalarType.SFIXED32:case ScalarType.SINT32:case ScalarType.FIXED32:case ScalarType.UINT32:return assert(typeof $=="number"),$;case ScalarType.FLOAT:case ScalarType.DOUBLE:return assert(typeof $=="number"),Number.isNaN($)?"NaN":$===Number.POSITIVE_INFINITY?"Infinity":$===Number.NEGATIVE_INFINITY?"-Infinity":$;case ScalarType.STRING:return assert(typeof $=="string"),$;case ScalarType.BOOL:return assert(typeof $=="boolean"),$;case ScalarType.UINT64:case ScalarType.FIXED64:case ScalarType.INT64:case ScalarType.SFIXED64:case ScalarType.SINT64:return assert(typeof $=="bigint"||typeof $=="string"||typeof $=="number"),$.toString();case ScalarType.BYTES:return assert($ instanceof Uint8Array),protoBase64.enc($)}}const unknownFieldsSymbol=Symbol("@bufbuild/protobuf/unknown-fields"),readDefaults={readUnknownFields:!0,readerFactory:B=>new BinaryReader(B)},writeDefaults={writeUnknownFields:!0,writerFactory:()=>new BinaryWriter};function makeReadOptions(B){return B?Object.assign(Object.assign({},readDefaults),B):readDefaults}function makeWriteOptions(B){return B?Object.assign(Object.assign({},writeDefaults),B):writeDefaults}function makeBinaryFormat(){return{makeReadOptions,makeWriteOptions,listUnknownFields(B){var $;return($=B[unknownFieldsSymbol])!==null&&$!==void 0?$:[]},discardUnknownFields(B){delete B[unknownFieldsSymbol]},writeUnknownFields(B,$){const F=B[unknownFieldsSymbol];if(F)for(const V of F)$.tag(V.no,V.wireType).raw(V.data)},onUnknownField(B,$,U,F){const V=B;Array.isArray(V[unknownFieldsSymbol])||(V[unknownFieldsSymbol]=[]),V[unknownFieldsSymbol].push({no:$,wireType:U,data:F})},readMessage(B,$,U,F,V){const q=B.getType(),j=V?$.len:$.pos+U;let W,K;for(;$.pos<j&&([W,K]=$.tag(),!(V===!0&&K==WireType.EndGroup));){const G=q.fields.find(W);if(!G){const z=$.skip(K,W);F.readUnknownFields&&this.onUnknownField(B,W,K,z);continue}readField(B,$,G,K,F)}if(V&&(K!=WireType.EndGroup||W!==U))throw new Error("invalid end group tag")},readField,writeMessage(B,$,U){const F=B.getType();for(const V of F.fields.byNumber()){if(!isFieldSet(V,B)){if(V.req)throw new Error("cannot encode field ".concat(F.typeName,".").concat(V.name," to binary: required field not set"));continue}const q=V.oneof?B[V.oneof.localName].value:B[V.localName];writeField(V,q,$,U)}return U.writeUnknownFields&&this.writeUnknownFields(B,$),$},writeField(B,$,U,F){$!==void 0&&writeField(B,$,U,F)}}}function readField(B,$,U,F,V){let{repeated:q,localName:j}=U;switch(U.oneof&&(B=B[U.oneof.localName],B.case!=j&&delete B.value,B.case=j,j="value"),U.kind){case"scalar":case"enum":const W=U.kind=="enum"?ScalarType.INT32:U.T;let K=readScalar;if(U.kind=="scalar"&&U.L>0&&(K=readScalarLTString),q){let Q=B[j];if(F==WireType.LengthDelimited&&W!=ScalarType.STRING&&W!=ScalarType.BYTES){let X=$.uint32()+$.pos;for(;$.pos<X;)Q.push(K($,W))}else Q.push(K($,W))}else B[j]=K($,W);break;case"message":const G=U.T;q?B[j].push(readMessageField($,new G,V,U)):isMessage(B[j])?readMessageField($,B[j],V,U):(B[j]=readMessageField($,new G,V,U),G.fieldWrapper&&!U.oneof&&!U.repeated&&(B[j]=G.fieldWrapper.unwrapField(B[j])));break;case"map":let[z,H]=readMapEntry(U,$,V);B[j][z]=H;break}}function readMessageField(B,$,U,F){const V=$.getType().runtime.bin,q=F?.delimited;return V.readMessage($,B,q?F.no:B.uint32(),U,q),$}function readMapEntry(B,$,U){const F=$.uint32(),V=$.pos+F;let q,j;for(;$.pos<V;){const[W]=$.tag();switch(W){case 1:q=readScalar($,B.K);break;case 2:switch(B.V.kind){case"scalar":j=readScalar($,B.V.T);break;case"enum":j=$.int32();break;case"message":j=readMessageField($,new B.V.T,U,void 0);break}break}}if(q===void 0&&(q=scalarZeroValue(B.K,LongType.BIGINT)),typeof q!="string"&&typeof q!="number"&&(q=q.toString()),j===void 0)switch(B.V.kind){case"scalar":j=scalarZeroValue(B.V.T,LongType.BIGINT);break;case"enum":j=B.V.T.values[0].no;break;case"message":j=new B.V.T;break}return[q,j]}function readScalarLTString(B,$){const U=readScalar(B,$);return typeof U=="bigint"?U.toString():U}function readScalar(B,$){switch($){case ScalarType.STRING:return B.string();case ScalarType.BOOL:return B.bool();case ScalarType.DOUBLE:return B.double();case ScalarType.FLOAT:return B.float();case ScalarType.INT32:return B.int32();case ScalarType.INT64:return B.int64();case ScalarType.UINT64:return B.uint64();case ScalarType.FIXED64:return B.fixed64();case ScalarType.BYTES:return B.bytes();case ScalarType.FIXED32:return B.fixed32();case ScalarType.SFIXED32:return B.sfixed32();case ScalarType.SFIXED64:return B.sfixed64();case ScalarType.SINT64:return B.sint64();case ScalarType.UINT32:return B.uint32();case ScalarType.SINT32:return B.sint32()}}function writeField(B,$,U,F){assert($!==void 0);const V=B.repeated;switch(B.kind){case"scalar":case"enum":let q=B.kind=="enum"?ScalarType.INT32:B.T;if(V)if(assert(Array.isArray($)),B.packed)writePacked(U,q,B.no,$);else for(const j of $)writeScalar(U,q,B.no,j);else writeScalar(U,q,B.no,$);break;case"message":if(V){assert(Array.isArray($));for(const j of $)writeMessageField(U,F,B,j)}else writeMessageField(U,F,B,$);break;case"map":assert(typeof $=="object"&&$!=null);for(const[j,W]of Object.entries($))writeMapEntry(U,F,B,j,W);break}}function writeMapEntry(B,$,U,F,V){B.tag(U.no,WireType.LengthDelimited),B.fork();let q=F;switch(U.K){case ScalarType.INT32:case ScalarType.FIXED32:case ScalarType.UINT32:case ScalarType.SFIXED32:case ScalarType.SINT32:q=Number.parseInt(F);break;case ScalarType.BOOL:assert(F=="true"||F=="false"),q=F=="true";break}switch(writeScalar(B,U.K,1,q),U.V.kind){case"scalar":writeScalar(B,U.V.T,2,V);break;case"enum":writeScalar(B,ScalarType.INT32,2,V);break;case"message":assert(V!==void 0),B.tag(2,WireType.LengthDelimited).bytes(V.toBinary($));break}B.join()}function writeMessageField(B,$,U,F){const V=wrapField(U.T,F);U.delimited?B.tag(U.no,WireType.StartGroup).raw(V.toBinary($)).tag(U.no,WireType.EndGroup):B.tag(U.no,WireType.LengthDelimited).bytes(V.toBinary($))}function writeScalar(B,$,U,F){assert(F!==void 0);let[V,q]=scalarTypeInfo($);B.tag(U,V)[q](F)}function writePacked(B,$,U,F){if(!F.length)return;B.tag(U,WireType.LengthDelimited).fork();let[,V]=scalarTypeInfo($);for(let q=0;q<F.length;q++)B[V](F[q]);B.join()}function scalarTypeInfo(B){let $=WireType.Varint;switch(B){case ScalarType.BYTES:case ScalarType.STRING:$=WireType.LengthDelimited;break;case ScalarType.DOUBLE:case ScalarType.FIXED64:case ScalarType.SFIXED64:$=WireType.Bit64;break;case ScalarType.FIXED32:case ScalarType.SFIXED32:case ScalarType.FLOAT:$=WireType.Bit32;break}const U=ScalarType[B].toLowerCase();return[$,U]}function makeUtilCommon(){return{setEnumType,initPartial(B,$){if(B===void 0)return;const U=$.getType();for(const F of U.fields.byMember()){const V=F.localName,q=$,j=B;if(j[V]!=null)switch(F.kind){case"oneof":const W=j[V].case;if(W===void 0)continue;const K=F.findField(W);let G=j[V].value;K&&K.kind=="message"&&!isMessage(G,K.T)?G=new K.T(G):K&&K.kind==="scalar"&&K.T===ScalarType.BYTES&&(G=toU8Arr(G)),q[V]={case:W,value:G};break;case"scalar":case"enum":let z=j[V];F.T===ScalarType.BYTES&&(z=F.repeated?z.map(toU8Arr):toU8Arr(z)),q[V]=z;break;case"map":switch(F.V.kind){case"scalar":case"enum":if(F.V.T===ScalarType.BYTES)for(const[Y,X]of Object.entries(j[V]))q[V][Y]=toU8Arr(X);else Object.assign(q[V],j[V]);break;case"message":const Q=F.V.T;for(const Y of Object.keys(j[V])){let X=j[V][Y];Q.fieldWrapper||(X=new Q(X)),q[V][Y]=X}break}break;case"message":const H=F.T;if(F.repeated)q[V]=j[V].map(Q=>isMessage(Q,H)?Q:new H(Q));else{const Q=j[V];H.fieldWrapper?H.typeName==="google.protobuf.BytesValue"?q[V]=toU8Arr(Q):q[V]=Q:q[V]=isMessage(Q,H)?Q:new H(Q)}break}}},equals(B,$,U){return $===U?!0:!$||!U?!1:B.fields.byMember().every(F=>{const V=$[F.localName],q=U[F.localName];if(F.repeated){if(V.length!==q.length)return!1;switch(F.kind){case"message":return V.every((j,W)=>F.T.equals(j,q[W]));case"scalar":return V.every((j,W)=>scalarEquals(F.T,j,q[W]));case"enum":return V.every((j,W)=>scalarEquals(ScalarType.INT32,j,q[W]))}throw new Error("repeated cannot contain ".concat(F.kind))}switch(F.kind){case"message":let j=V,W=q;return F.T.fieldWrapper&&(j!==void 0&&!isMessage(j)&&(j=F.T.fieldWrapper.wrapField(j)),W!==void 0&&!isMessage(W)&&(W=F.T.fieldWrapper.wrapField(W))),F.T.equals(j,W);case"enum":return scalarEquals(ScalarType.INT32,V,q);case"scalar":return scalarEquals(F.T,V,q);case"oneof":if(V.case!==q.case)return!1;const K=F.findField(V.case);if(K===void 0)return!0;switch(K.kind){case"message":return K.T.equals(V.value,q.value);case"enum":return scalarEquals(ScalarType.INT32,V.value,q.value);case"scalar":return scalarEquals(K.T,V.value,q.value)}throw new Error("oneof cannot contain ".concat(K.kind));case"map":const G=Object.keys(V).concat(Object.keys(q));switch(F.V.kind){case"message":const z=F.V.T;return G.every(Q=>z.equals(V[Q],q[Q]));case"enum":return G.every(Q=>scalarEquals(ScalarType.INT32,V[Q],q[Q]));case"scalar":const H=F.V.T;return G.every(Q=>scalarEquals(H,V[Q],q[Q]))}break}})},clone(B){const $=B.getType(),U=new $,F=U;for(const V of $.fields.byMember()){const q=B[V.localName];let j;if(V.repeated)j=q.map(cloneSingularField);else if(V.kind=="map"){j=F[V.localName];for(const[W,K]of Object.entries(q))j[W]=cloneSingularField(K)}else V.kind=="oneof"?j=V.findField(q.case)?{case:q.case,value:cloneSingularField(q.value)}:{case:void 0}:j=cloneSingularField(q);F[V.localName]=j}for(const V of $.runtime.bin.listUnknownFields(B))$.runtime.bin.onUnknownField(F,V.no,V.wireType,V.data);return U}}}function cloneSingularField(B){if(B===void 0)return B;if(isMessage(B))return B.clone();if(B instanceof Uint8Array){const $=new Uint8Array(B.byteLength);return $.set(B),$}return B}function toU8Arr(B){return B instanceof Uint8Array?B:new Uint8Array(B)}function makeProtoRuntime(B,$,U){return{syntax:B,json:makeJsonFormat(),bin:makeBinaryFormat(),util:Object.assign(Object.assign({},makeUtilCommon()),{newFieldList:$,initFields:U}),makeMessageType(F,V,q){return makeMessageType(this,F,V,q)},makeEnum,makeEnumType,getEnumType,makeExtension(F,V,q){return makeExtension(this,F,V,q)}}}class InternalFieldList{constructor($,U){this._fields=$,this._normalizer=U}findJsonName($){if(!this.jsonNames){const U={};for(const F of this.list())U[F.jsonName]=U[F.name]=F;this.jsonNames=U}return this.jsonNames[$]}find($){if(!this.numbers){const U={};for(const F of this.list())U[F.no]=F;this.numbers=U}return this.numbers[$]}list(){return this.all||(this.all=this._normalizer(this._fields)),this.all}byNumber(){return this.numbersAsc||(this.numbersAsc=this.list().concat().sort(($,U)=>$.no-U.no)),this.numbersAsc}byMember(){if(!this.members){this.members=[];const $=this.members;let U;for(const F of this.list())F.oneof?F.oneof!==U&&(U=F.oneof,$.push(U)):$.push(F)}return this.members}}function localFieldName(B,$){const U=protoCamelCase(B);return $?U:safeObjectProperty(safeMessageProperty(U))}function localOneofName(B){return localFieldName(B,!1)}const fieldJsonName=protoCamelCase;function protoCamelCase(B){let $=!1;const U=[];for(let F=0;F<B.length;F++){let V=B.charAt(F);switch(V){case"_":$=!0;break;case"0":case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":U.push(V),$=!1;break;default:$&&($=!1,V=V.toUpperCase()),U.push(V);break}}return U.join("")}const reservedObjectProperties=new Set(["constructor","toString","toJSON","valueOf"]),reservedMessageProperties=new Set(["getType","clone","equals","fromBinary","fromJson","fromJsonString","toBinary","toJson","toJsonString","toObject"]),fallback=B=>"".concat(B,"$"),safeMessageProperty=B=>reservedMessageProperties.has(B)?fallback(B):B,safeObjectProperty=B=>reservedObjectProperties.has(B)?fallback(B):B;class InternalOneofInfo{constructor($){this.kind="oneof",this.repeated=!1,this.packed=!1,this.opt=!1,this.req=!1,this.default=void 0,this.fields=[],this.name=$,this.localName=localOneofName($)}addField($){assert($.oneof===this,"field ".concat($.name," not one of ").concat(this.name)),this.fields.push($)}findField($){if(!this._lookup){this._lookup=Object.create(null);for(let U=0;U<this.fields.length;U++)this._lookup[this.fields[U].localName]=this.fields[U]}return this._lookup[$]}}function normalizeFieldInfos(B,$){var U,F,V,q,j,W;const K=[];let G;for(const z of typeof B=="function"?B():B){const H=z;if(H.localName=localFieldName(z.name,z.oneof!==void 0),H.jsonName=(U=z.jsonName)!==null&&U!==void 0?U:fieldJsonName(z.name),H.repeated=(F=z.repeated)!==null&&F!==void 0?F:!1,z.kind=="scalar"&&(H.L=(V=z.L)!==null&&V!==void 0?V:LongType.BIGINT),H.delimited=(q=z.delimited)!==null&&q!==void 0?q:!1,H.req=(j=z.req)!==null&&j!==void 0?j:!1,H.opt=(W=z.opt)!==null&&W!==void 0?W:!1,z.packed===void 0&&(H.packed=z.kind=="enum"||z.kind=="scalar"&&z.T!=ScalarType.BYTES&&z.T!=ScalarType.STRING),z.oneof!==void 0){const Q=typeof z.oneof=="string"?z.oneof:z.oneof.name;(!G||G.name!=Q)&&(G=new InternalOneofInfo(Q)),H.oneof=G,G.addField(H)}K.push(H)}return K}const proto3=makeProtoRuntime("proto3",B=>new InternalFieldList(B,$=>normalizeFieldInfos($)),B=>{for(const $ of B.getType().fields.byMember()){if($.opt)continue;const U=$.localName,F=B;if($.repeated){F[U]=[];continue}switch($.kind){case"oneof":F[U]={case:void 0};break;case"enum":F[U]=0;break;case"map":F[U]={};break;case"scalar":F[U]=scalarZeroValue($.T,$.L);break}}});class Timestamp extends Message{constructor($){super(),this.seconds=protoInt64.zero,this.nanos=0,proto3.util.initPartial($,this)}fromJson($,U){if(typeof $!="string")throw new Error("cannot decode google.protobuf.Timestamp from JSON: ".concat(proto3.json.debug($)));const F=$.match(/^([0-9]{4})-([0-9]{2})-([0-9]{2})T([0-9]{2}):([0-9]{2}):([0-9]{2})(?:Z|\.([0-9]{3,9})Z|([+-][0-9][0-9]:[0-9][0-9]))$/);if(!F)throw new Error("cannot decode google.protobuf.Timestamp from JSON: invalid RFC 3339 string");const V=Date.parse(F[1]+"-"+F[2]+"-"+F[3]+"T"+F[4]+":"+F[5]+":"+F[6]+(F[8]?F[8]:"Z"));if(Number.isNaN(V))throw new Error("cannot decode google.protobuf.Timestamp from JSON: invalid RFC 3339 string");if(V<Date.parse("0001-01-01T00:00:00Z")||V>Date.parse("9999-12-31T23:59:59Z"))throw new Error("cannot decode message google.protobuf.Timestamp from JSON: must be from 0001-01-01T00:00:00Z to 9999-12-31T23:59:59Z inclusive");return this.seconds=protoInt64.parse(V/1e3),this.nanos=0,F[7]&&(this.nanos=parseInt("1"+F[7]+"0".repeat(9-F[7].length))-1e9),this}toJson($){const U=Number(this.seconds)*1e3;if(U<Date.parse("0001-01-01T00:00:00Z")||U>Date.parse("9999-12-31T23:59:59Z"))throw new Error("cannot encode google.protobuf.Timestamp to JSON: must be from 0001-01-01T00:00:00Z to 9999-12-31T23:59:59Z inclusive");if(this.nanos<0)throw new Error("cannot encode google.protobuf.Timestamp to JSON: nanos must not be negative");let F="Z";if(this.nanos>0){const V=(this.nanos+1e9).toString().substring(1);V.substring(3)==="000000"?F="."+V.substring(0,3)+"Z":V.substring(6)==="000"?F="."+V.substring(0,6)+"Z":F="."+V+"Z"}return new Date(U).toISOString().replace(".000Z",F)}toDate(){return new Date(Number(this.seconds)*1e3+Math.ceil(this.nanos/1e6))}static now(){return Timestamp.fromDate(new Date)}static fromDate($){const U=$.getTime();return new Timestamp({seconds:protoInt64.parse(Math.floor(U/1e3)),nanos:U%1e3*1e6})}static fromBinary($,U){return new Timestamp().fromBinary($,U)}static fromJson($,U){return new Timestamp().fromJson($,U)}static fromJsonString($,U){return new Timestamp().fromJsonString($,U)}static equals($,U){return proto3.util.equals(Timestamp,$,U)}}Timestamp.runtime=proto3,Timestamp.typeName="google.protobuf.Timestamp",Timestamp.fields=proto3.util.newFieldList(()=>[{no:1,name:"seconds",kind:"scalar",T:3},{no:2,name:"nanos",kind:"scalar",T:5}]);const MetricsBatch=proto3.makeMessageType("livekit.MetricsBatch",()=>[{no:1,name:"timestamp_ms",kind:"scalar",T:3},{no:2,name:"normalized_timestamp",kind:"message",T:Timestamp},{no:3,name:"str_data",kind:"scalar",T:9,repeated:!0},{no:4,name:"time_series",kind:"message",T:TimeSeriesMetric,repeated:!0},{no:5,name:"events",kind:"message",T:EventMetric,repeated:!0}]),TimeSeriesMetric=proto3.makeMessageType("livekit.TimeSeriesMetric",()=>[{no:1,name:"label",kind:"scalar",T:13},{no:2,name:"participant_identity",kind:"scalar",T:13},{no:3,name:"track_sid",kind:"scalar",T:13},{no:4,name:"samples",kind:"message",T:MetricSample,repeated:!0},{no:5,name:"rid",kind:"scalar",T:13}]),MetricSample=proto3.makeMessageType("livekit.MetricSample",()=>[{no:1,name:"timestamp_ms",kind:"scalar",T:3},{no:2,name:"normalized_timestamp",kind:"message",T:Timestamp},{no:3,name:"value",kind:"scalar",T:2}]),EventMetric=proto3.makeMessageType("livekit.EventMetric",()=>[{no:1,name:"label",kind:"scalar",T:13},{no:2,name:"participant_identity",kind:"scalar",T:13},{no:3,name:"track_sid",kind:"scalar",T:13},{no:4,name:"start_timestamp_ms",kind:"scalar",T:3},{no:5,name:"end_timestamp_ms",kind:"scalar",T:3,opt:!0},{no:6,name:"normalized_start_timestamp",kind:"message",T:Timestamp},{no:7,name:"normalized_end_timestamp",kind:"message",T:Timestamp,opt:!0},{no:8,name:"metadata",kind:"scalar",T:9},{no:9,name:"rid",kind:"scalar",T:13}]),BackupCodecPolicy$1=proto3.makeEnum("livekit.BackupCodecPolicy",[{no:0,name:"PREFER_REGRESSION"},{no:1,name:"SIMULCAST"},{no:2,name:"REGRESSION"}]),TrackType=proto3.makeEnum("livekit.TrackType",[{no:0,name:"AUDIO"},{no:1,name:"VIDEO"},{no:2,name:"DATA"}]),TrackSource=proto3.makeEnum("livekit.TrackSource",[{no:0,name:"UNKNOWN"},{no:1,name:"CAMERA"},{no:2,name:"MICROPHONE"},{no:3,name:"SCREEN_SHARE"},{no:4,name:"SCREEN_SHARE_AUDIO"}]),VideoQuality$1=proto3.makeEnum("livekit.VideoQuality",[{no:0,name:"LOW"},{no:1,name:"MEDIUM"},{no:2,name:"HIGH"},{no:3,name:"OFF"}]),ConnectionQuality$1=proto3.makeEnum("livekit.ConnectionQuality",[{no:0,name:"POOR"},{no:1,name:"GOOD"},{no:2,name:"EXCELLENT"},{no:3,name:"LOST"}]),ClientConfigSetting=proto3.makeEnum("livekit.ClientConfigSetting",[{no:0,name:"UNSET"},{no:1,name:"DISABLED"},{no:2,name:"ENABLED"}]),DisconnectReason=proto3.makeEnum("livekit.DisconnectReason",[{no:0,name:"UNKNOWN_REASON"},{no:1,name:"CLIENT_INITIATED"},{no:2,name:"DUPLICATE_IDENTITY"},{no:3,name:"SERVER_SHUTDOWN"},{no:4,name:"PARTICIPANT_REMOVED"},{no:5,name:"ROOM_DELETED"},{no:6,name:"STATE_MISMATCH"},{no:7,name:"JOIN_FAILURE"},{no:8,name:"MIGRATION"},{no:9,name:"SIGNAL_CLOSE"},{no:10,name:"ROOM_CLOSED"},{no:11,name:"USER_UNAVAILABLE"},{no:12,name:"USER_REJECTED"},{no:13,name:"SIP_TRUNK_FAILURE"},{no:14,name:"CONNECTION_TIMEOUT"},{no:15,name:"MEDIA_FAILURE"}]),ReconnectReason=proto3.makeEnum("livekit.ReconnectReason",[{no:0,name:"RR_UNKNOWN"},{no:1,name:"RR_SIGNAL_DISCONNECTED"},{no:2,name:"RR_PUBLISHER_FAILED"},{no:3,name:"RR_SUBSCRIBER_FAILED"},{no:4,name:"RR_SWITCH_CANDIDATE"}]),SubscriptionError=proto3.makeEnum("livekit.SubscriptionError",[{no:0,name:"SE_UNKNOWN"},{no:1,name:"SE_CODEC_UNSUPPORTED"},{no:2,name:"SE_TRACK_NOTFOUND"}]),AudioTrackFeature=proto3.makeEnum("livekit.AudioTrackFeature",[{no:0,name:"TF_STEREO"},{no:1,name:"TF_NO_DTX"},{no:2,name:"TF_AUTO_GAIN_CONTROL"},{no:3,name:"TF_ECHO_CANCELLATION"},{no:4,name:"TF_NOISE_SUPPRESSION"},{no:5,name:"TF_ENHANCED_NOISE_CANCELLATION"},{no:6,name:"TF_PRECONNECT_BUFFER"}]),Room$1=proto3.makeMessageType("livekit.Room",()=>[{no:1,name:"sid",kind:"scalar",T:9},{no:2,name:"name",kind:"scalar",T:9},{no:3,name:"empty_timeout",kind:"scalar",T:13},{no:14,name:"departure_timeout",kind:"scalar",T:13},{no:4,name:"max_participants",kind:"scalar",T:13},{no:5,name:"creation_time",kind:"scalar",T:3},{no:15,name:"creation_time_ms",kind:"scalar",T:3},{no:6,name:"turn_password",kind:"scalar",T:9},{no:7,name:"enabled_codecs",kind:"message",T:Codec,repeated:!0},{no:8,name:"metadata",kind:"scalar",T:9},{no:9,name:"num_participants",kind:"scalar",T:13},{no:11,name:"num_publishers",kind:"scalar",T:13},{no:10,name:"active_recording",kind:"scalar",T:8},{no:13,name:"version",kind:"message",T:TimedVersion}]),Codec=proto3.makeMessageType("livekit.Codec",()=>[{no:1,name:"mime",kind:"scalar",T:9},{no:2,name:"fmtp_line",kind:"scalar",T:9}]),ParticipantPermission=proto3.makeMessageType("livekit.ParticipantPermission",()=>[{no:1,name:"can_subscribe",kind:"scalar",T:8},{no:2,name:"can_publish",kind:"scalar",T:8},{no:3,name:"can_publish_data",kind:"scalar",T:8},{no:9,name:"can_publish_sources",kind:"enum",T:proto3.getEnumType(TrackSource),repeated:!0},{no:7,name:"hidden",kind:"scalar",T:8},{no:8,name:"recorder",kind:"scalar",T:8},{no:10,name:"can_update_metadata",kind:"scalar",T:8},{no:11,name:"agent",kind:"scalar",T:8},{no:12,name:"can_subscribe_metrics",kind:"scalar",T:8}]),ParticipantInfo=proto3.makeMessageType("livekit.ParticipantInfo",()=>[{no:1,name:"sid",kind:"scalar",T:9},{no:2,name:"identity",kind:"scalar",T:9},{no:3,name:"state",kind:"enum",T:proto3.getEnumType(ParticipantInfo_State)},{no:4,name:"tracks",kind:"message",T:TrackInfo,repeated:!0},{no:5,name:"metadata",kind:"scalar",T:9},{no:6,name:"joined_at",kind:"scalar",T:3},{no:17,name:"joined_at_ms",kind:"scalar",T:3},{no:9,name:"name",kind:"scalar",T:9},{no:10,name:"version",kind:"scalar",T:13},{no:11,name:"permission",kind:"message",T:ParticipantPermission},{no:12,name:"region",kind:"scalar",T:9},{no:13,name:"is_publisher",kind:"scalar",T:8},{no:14,name:"kind",kind:"enum",T:proto3.getEnumType(ParticipantInfo_Kind)},{no:15,name:"attributes",kind:"map",K:9,V:{kind:"scalar",T:9}},{no:16,name:"disconnect_reason",kind:"enum",T:proto3.getEnumType(DisconnectReason)},{no:18,name:"kind_details",kind:"enum",T:proto3.getEnumType(ParticipantInfo_KindDetail),repeated:!0}]),ParticipantInfo_State=proto3.makeEnum("livekit.ParticipantInfo.State",[{no:0,name:"JOINING"},{no:1,name:"JOINED"},{no:2,name:"ACTIVE"},{no:3,name:"DISCONNECTED"}]),ParticipantInfo_Kind=proto3.makeEnum("livekit.ParticipantInfo.Kind",[{no:0,name:"STANDARD"},{no:1,name:"INGRESS"},{no:2,name:"EGRESS"},{no:3,name:"SIP"},{no:4,name:"AGENT"}]),ParticipantInfo_KindDetail=proto3.makeEnum("livekit.ParticipantInfo.KindDetail",[{no:0,name:"CLOUD_AGENT"},{no:1,name:"FORWARDED"}]),Encryption_Type=proto3.makeEnum("livekit.Encryption.Type",[{no:0,name:"NONE"},{no:1,name:"GCM"},{no:2,name:"CUSTOM"}]),SimulcastCodecInfo=proto3.makeMessageType("livekit.SimulcastCodecInfo",()=>[{no:1,name:"mime_type",kind:"scalar",T:9},{no:2,name:"mid",kind:"scalar",T:9},{no:3,name:"cid",kind:"scalar",T:9},{no:4,name:"layers",kind:"message",T:VideoLayer,repeated:!0}]),TrackInfo=proto3.makeMessageType("livekit.TrackInfo",()=>[{no:1,name:"sid",kind:"scalar",T:9},{no:2,name:"type",kind:"enum",T:proto3.getEnumType(TrackType)},{no:3,name:"name",kind:"scalar",T:9},{no:4,name:"muted",kind:"scalar",T:8},{no:5,name:"width",kind:"scalar",T:13},{no:6,name:"height",kind:"scalar",T:13},{no:7,name:"simulcast",kind:"scalar",T:8},{no:8,name:"disable_dtx",kind:"scalar",T:8},{no:9,name:"source",kind:"enum",T:proto3.getEnumType(TrackSource)},{no:10,name:"layers",kind:"message",T:VideoLayer,repeated:!0},{no:11,name:"mime_type",kind:"scalar",T:9},{no:12,name:"mid",kind:"scalar",T:9},{no:13,name:"codecs",kind:"message",T:SimulcastCodecInfo,repeated:!0},{no:14,name:"stereo",kind:"scalar",T:8},{no:15,name:"disable_red",kind:"scalar",T:8},{no:16,name:"encryption",kind:"enum",T:proto3.getEnumType(Encryption_Type)},{no:17,name:"stream",kind:"scalar",T:9},{no:18,name:"version",kind:"message",T:TimedVersion},{no:19,name:"audio_features",kind:"enum",T:proto3.getEnumType(AudioTrackFeature),repeated:!0},{no:20,name:"backup_codec_policy",kind:"enum",T:proto3.getEnumType(BackupCodecPolicy$1)}]),VideoLayer=proto3.makeMessageType("livekit.VideoLayer",()=>[{no:1,name:"quality",kind:"enum",T:proto3.getEnumType(VideoQuality$1)},{no:2,name:"width",kind:"scalar",T:13},{no:3,name:"height",kind:"scalar",T:13},{no:4,name:"bitrate",kind:"scalar",T:13},{no:5,name:"ssrc",kind:"scalar",T:13},{no:6,name:"spatial_layer",kind:"scalar",T:5},{no:7,name:"rid",kind:"scalar",T:9}]),DataPacket=proto3.makeMessageType("livekit.DataPacket",()=>[{no:1,name:"kind",kind:"enum",T:proto3.getEnumType(DataPacket_Kind)},{no:4,name:"participant_identity",kind:"scalar",T:9},{no:5,name:"destination_identities",kind:"scalar",T:9,repeated:!0},{no:2,name:"user",kind:"message",T:UserPacket,oneof:"value"},{no:3,name:"speaker",kind:"message",T:ActiveSpeakerUpdate,oneof:"value"},{no:6,name:"sip_dtmf",kind:"message",T:SipDTMF,oneof:"value"},{no:7,name:"transcription",kind:"message",T:Transcription,oneof:"value"},{no:8,name:"metrics",kind:"message",T:MetricsBatch,oneof:"value"},{no:9,name:"chat_message",kind:"message",T:ChatMessage,oneof:"value"},{no:10,name:"rpc_request",kind:"message",T:RpcRequest,oneof:"value"},{no:11,name:"rpc_ack",kind:"message",T:RpcAck,oneof:"value"},{no:12,name:"rpc_response",kind:"message",T:RpcResponse,oneof:"value"},{no:13,name:"stream_header",kind:"message",T:DataStream_Header,oneof:"value"},{no:14,name:"stream_chunk",kind:"message",T:DataStream_Chunk,oneof:"value"},{no:15,name:"stream_trailer",kind:"message",T:DataStream_Trailer,oneof:"value"},{no:16,name:"sequence",kind:"scalar",T:13},{no:17,name:"participant_sid",kind:"scalar",T:9}]),DataPacket_Kind=proto3.makeEnum("livekit.DataPacket.Kind",[{no:0,name:"RELIABLE"},{no:1,name:"LOSSY"}]),ActiveSpeakerUpdate=proto3.makeMessageType("livekit.ActiveSpeakerUpdate",()=>[{no:1,name:"speakers",kind:"message",T:SpeakerInfo,repeated:!0}]),SpeakerInfo=proto3.makeMessageType("livekit.SpeakerInfo",()=>[{no:1,name:"sid",kind:"scalar",T:9},{no:2,name:"level",kind:"scalar",T:2},{no:3,name:"active",kind:"scalar",T:8}]),UserPacket=proto3.makeMessageType("livekit.UserPacket",()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:5,name:"participant_identity",kind:"scalar",T:9},{no:2,name:"payload",kind:"scalar",T:12},{no:3,name:"destination_sids",kind:"scalar",T:9,repeated:!0},{no:6,name:"destination_identities",kind:"scalar",T:9,repeated:!0},{no:4,name:"topic",kind:"scalar",T:9,opt:!0},{no:8,name:"id",kind:"scalar",T:9,opt:!0},{no:9,name:"start_time",kind:"scalar",T:4,opt:!0},{no:10,name:"end_time",kind:"scalar",T:4,opt:!0},{no:11,name:"nonce",kind:"scalar",T:12}]),SipDTMF=proto3.makeMessageType("livekit.SipDTMF",()=>[{no:3,name:"code",kind:"scalar",T:13},{no:4,name:"digit",kind:"scalar",T:9}]),Transcription=proto3.makeMessageType("livekit.Transcription",()=>[{no:2,name:"transcribed_participant_identity",kind:"scalar",T:9},{no:3,name:"track_id",kind:"scalar",T:9},{no:4,name:"segments",kind:"message",T:TranscriptionSegment,repeated:!0}]),TranscriptionSegment=proto3.makeMessageType("livekit.TranscriptionSegment",()=>[{no:1,name:"id",kind:"scalar",T:9},{no:2,name:"text",kind:"scalar",T:9},{no:3,name:"start_time",kind:"scalar",T:4},{no:4,name:"end_time",kind:"scalar",T:4},{no:5,name:"final",kind:"scalar",T:8},{no:6,name:"language",kind:"scalar",T:9}]),ChatMessage=proto3.makeMessageType("livekit.ChatMessage",()=>[{no:1,name:"id",kind:"scalar",T:9},{no:2,name:"timestamp",kind:"scalar",T:3},{no:3,name:"edit_timestamp",kind:"scalar",T:3,opt:!0},{no:4,name:"message",kind:"scalar",T:9},{no:5,name:"deleted",kind:"scalar",T:8},{no:6,name:"generated",kind:"scalar",T:8}]),RpcRequest=proto3.makeMessageType("livekit.RpcRequest",()=>[{no:1,name:"id",kind:"scalar",T:9},{no:2,name:"method",kind:"scalar",T:9},{no:3,name:"payload",kind:"scalar",T:9},{no:4,name:"response_timeout_ms",kind:"scalar",T:13},{no:5,name:"version",kind:"scalar",T:13}]),RpcAck=proto3.makeMessageType("livekit.RpcAck",()=>[{no:1,name:"request_id",kind:"scalar",T:9}]),RpcResponse=proto3.makeMessageType("livekit.RpcResponse",()=>[{no:1,name:"request_id",kind:"scalar",T:9},{no:2,name:"payload",kind:"scalar",T:9,oneof:"value"},{no:3,name:"error",kind:"message",T:RpcError$1,oneof:"value"}]),RpcError$1=proto3.makeMessageType("livekit.RpcError",()=>[{no:1,name:"code",kind:"scalar",T:13},{no:2,name:"message",kind:"scalar",T:9},{no:3,name:"data",kind:"scalar",T:9}]),ParticipantTracks=proto3.makeMessageType("livekit.ParticipantTracks",()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:2,name:"track_sids",kind:"scalar",T:9,repeated:!0}]),ServerInfo=proto3.makeMessageType("livekit.ServerInfo",()=>[{no:1,name:"edition",kind:"enum",T:proto3.getEnumType(ServerInfo_Edition)},{no:2,name:"version",kind:"scalar",T:9},{no:3,name:"protocol",kind:"scalar",T:5},{no:4,name:"region",kind:"scalar",T:9},{no:5,name:"node_id",kind:"scalar",T:9},{no:6,name:"debug_info",kind:"scalar",T:9},{no:7,name:"agent_protocol",kind:"scalar",T:5}]),ServerInfo_Edition=proto3.makeEnum("livekit.ServerInfo.Edition",[{no:0,name:"Standard"},{no:1,name:"Cloud"}]),ClientInfo=proto3.makeMessageType("livekit.ClientInfo",()=>[{no:1,name:"sdk",kind:"enum",T:proto3.getEnumType(ClientInfo_SDK)},{no:2,name:"version",kind:"scalar",T:9},{no:3,name:"protocol",kind:"scalar",T:5},{no:4,name:"os",kind:"scalar",T:9},{no:5,name:"os_version",kind:"scalar",T:9},{no:6,name:"device_model",kind:"scalar",T:9},{no:7,name:"browser",kind:"scalar",T:9},{no:8,name:"browser_version",kind:"scalar",T:9},{no:9,name:"address",kind:"scalar",T:9},{no:10,name:"network",kind:"scalar",T:9},{no:11,name:"other_sdks",kind:"scalar",T:9}]),ClientInfo_SDK=proto3.makeEnum("livekit.ClientInfo.SDK",[{no:0,name:"UNKNOWN"},{no:1,name:"JS"},{no:2,name:"SWIFT"},{no:3,name:"ANDROID"},{no:4,name:"FLUTTER"},{no:5,name:"GO"},{no:6,name:"UNITY"},{no:7,name:"REACT_NATIVE"},{no:8,name:"RUST"},{no:9,name:"PYTHON"},{no:10,name:"CPP"},{no:11,name:"UNITY_WEB"},{no:12,name:"NODE"},{no:13,name:"UNREAL"},{no:14,name:"ESP32"}]),ClientConfiguration=proto3.makeMessageType("livekit.ClientConfiguration",()=>[{no:1,name:"video",kind:"message",T:VideoConfiguration},{no:2,name:"screen",kind:"message",T:VideoConfiguration},{no:3,name:"resume_connection",kind:"enum",T:proto3.getEnumType(ClientConfigSetting)},{no:4,name:"disabled_codecs",kind:"message",T:DisabledCodecs},{no:5,name:"force_relay",kind:"enum",T:proto3.getEnumType(ClientConfigSetting)}]),VideoConfiguration=proto3.makeMessageType("livekit.VideoConfiguration",()=>[{no:1,name:"hardware_encoder",kind:"enum",T:proto3.getEnumType(ClientConfigSetting)}]),DisabledCodecs=proto3.makeMessageType("livekit.DisabledCodecs",()=>[{no:1,name:"codecs",kind:"message",T:Codec,repeated:!0},{no:2,name:"publish",kind:"message",T:Codec,repeated:!0}]),TimedVersion=proto3.makeMessageType("livekit.TimedVersion",()=>[{no:1,name:"unix_micro",kind:"scalar",T:3},{no:2,name:"ticks",kind:"scalar",T:5}]),DataStream_OperationType=proto3.makeEnum("livekit.DataStream.OperationType",[{no:0,name:"CREATE"},{no:1,name:"UPDATE"},{no:2,name:"DELETE"},{no:3,name:"REACTION"}]),DataStream_TextHeader=proto3.makeMessageType("livekit.DataStream.TextHeader",()=>[{no:1,name:"operation_type",kind:"enum",T:proto3.getEnumType(DataStream_OperationType)},{no:2,name:"version",kind:"scalar",T:5},{no:3,name:"reply_to_stream_id",kind:"scalar",T:9},{no:4,name:"attached_stream_ids",kind:"scalar",T:9,repeated:!0},{no:5,name:"generated",kind:"scalar",T:8}],{localName:"DataStream_TextHeader"}),DataStream_ByteHeader=proto3.makeMessageType("livekit.DataStream.ByteHeader",()=>[{no:1,name:"name",kind:"scalar",T:9}],{localName:"DataStream_ByteHeader"}),DataStream_Header=proto3.makeMessageType("livekit.DataStream.Header",()=>[{no:1,name:"stream_id",kind:"scalar",T:9},{no:2,name:"timestamp",kind:"scalar",T:3},{no:3,name:"topic",kind:"scalar",T:9},{no:4,name:"mime_type",kind:"scalar",T:9},{no:5,name:"total_length",kind:"scalar",T:4,opt:!0},{no:7,name:"encryption_type",kind:"enum",T:proto3.getEnumType(Encryption_Type)},{no:8,name:"attributes",kind:"map",K:9,V:{kind:"scalar",T:9}},{no:9,name:"text_header",kind:"message",T:DataStream_TextHeader,oneof:"content_header"},{no:10,name:"byte_header",kind:"message",T:DataStream_ByteHeader,oneof:"content_header"}],{localName:"DataStream_Header"}),DataStream_Chunk=proto3.makeMessageType("livekit.DataStream.Chunk",()=>[{no:1,name:"stream_id",kind:"scalar",T:9},{no:2,name:"chunk_index",kind:"scalar",T:4},{no:3,name:"content",kind:"scalar",T:12},{no:4,name:"version",kind:"scalar",T:5},{no:5,name:"iv",kind:"scalar",T:12,opt:!0}],{localName:"DataStream_Chunk"}),DataStream_Trailer=proto3.makeMessageType("livekit.DataStream.Trailer",()=>[{no:1,name:"stream_id",kind:"scalar",T:9},{no:2,name:"reason",kind:"scalar",T:9},{no:3,name:"attributes",kind:"map",K:9,V:{kind:"scalar",T:9}}],{localName:"DataStream_Trailer"}),SignalTarget=proto3.makeEnum("livekit.SignalTarget",[{no:0,name:"PUBLISHER"},{no:1,name:"SUBSCRIBER"}]),StreamState=proto3.makeEnum("livekit.StreamState",[{no:0,name:"ACTIVE"},{no:1,name:"PAUSED"}]),CandidateProtocol=proto3.makeEnum("livekit.CandidateProtocol",[{no:0,name:"UDP"},{no:1,name:"TCP"},{no:2,name:"TLS"}]),SignalRequest=proto3.makeMessageType("livekit.SignalRequest",()=>[{no:1,name:"offer",kind:"message",T:SessionDescription,oneof:"message"},{no:2,name:"answer",kind:"message",T:SessionDescription,oneof:"message"},{no:3,name:"trickle",kind:"message",T:TrickleRequest,oneof:"message"},{no:4,name:"add_track",kind:"message",T:AddTrackRequest,oneof:"message"},{no:5,name:"mute",kind:"message",T:MuteTrackRequest,oneof:"message"},{no:6,name:"subscription",kind:"message",T:UpdateSubscription,oneof:"message"},{no:7,name:"track_setting",kind:"message",T:UpdateTrackSettings,oneof:"message"},{no:8,name:"leave",kind:"message",T:LeaveRequest,oneof:"message"},{no:10,name:"update_layers",kind:"message",T:UpdateVideoLayers,oneof:"message"},{no:11,name:"subscription_permission",kind:"message",T:SubscriptionPermission,oneof:"message"},{no:12,name:"sync_state",kind:"message",T:SyncState,oneof:"message"},{no:13,name:"simulate",kind:"message",T:SimulateScenario,oneof:"message"},{no:14,name:"ping",kind:"scalar",T:3,oneof:"message"},{no:15,name:"update_metadata",kind:"message",T:UpdateParticipantMetadata,oneof:"message"},{no:16,name:"ping_req",kind:"message",T:Ping,oneof:"message"},{no:17,name:"update_audio_track",kind:"message",T:UpdateLocalAudioTrack,oneof:"message"},{no:18,name:"update_video_track",kind:"message",T:UpdateLocalVideoTrack,oneof:"message"}]),SignalResponse=proto3.makeMessageType("livekit.SignalResponse",()=>[{no:1,name:"join",kind:"message",T:JoinResponse,oneof:"message"},{no:2,name:"answer",kind:"message",T:SessionDescription,oneof:"message"},{no:3,name:"offer",kind:"message",T:SessionDescription,oneof:"message"},{no:4,name:"trickle",kind:"message",T:TrickleRequest,oneof:"message"},{no:5,name:"update",kind:"message",T:ParticipantUpdate,oneof:"message"},{no:6,name:"track_published",kind:"message",T:TrackPublishedResponse,oneof:"message"},{no:8,name:"leave",kind:"message",T:LeaveRequest,oneof:"message"},{no:9,name:"mute",kind:"message",T:MuteTrackRequest,oneof:"message"},{no:10,name:"speakers_changed",kind:"message",T:SpeakersChanged,oneof:"message"},{no:11,name:"room_update",kind:"message",T:RoomUpdate,oneof:"message"},{no:12,name:"connection_quality",kind:"message",T:ConnectionQualityUpdate,oneof:"message"},{no:13,name:"stream_state_update",kind:"message",T:StreamStateUpdate,oneof:"message"},{no:14,name:"subscribed_quality_update",kind:"message",T:SubscribedQualityUpdate,oneof:"message"},{no:15,name:"subscription_permission_update",kind:"message",T:SubscriptionPermissionUpdate,oneof:"message"},{no:16,name:"refresh_token",kind:"scalar",T:9,oneof:"message"},{no:17,name:"track_unpublished",kind:"message",T:TrackUnpublishedResponse,oneof:"message"},{no:18,name:"pong",kind:"scalar",T:3,oneof:"message"},{no:19,name:"reconnect",kind:"message",T:ReconnectResponse,oneof:"message"},{no:20,name:"pong_resp",kind:"message",T:Pong,oneof:"message"},{no:21,name:"subscription_response",kind:"message",T:SubscriptionResponse,oneof:"message"},{no:22,name:"request_response",kind:"message",T:RequestResponse,oneof:"message"},{no:23,name:"track_subscribed",kind:"message",T:TrackSubscribed,oneof:"message"},{no:24,name:"room_moved",kind:"message",T:RoomMovedResponse,oneof:"message"}]),SimulcastCodec=proto3.makeMessageType("livekit.SimulcastCodec",()=>[{no:1,name:"codec",kind:"scalar",T:9},{no:2,name:"cid",kind:"scalar",T:9}]),AddTrackRequest=proto3.makeMessageType("livekit.AddTrackRequest",()=>[{no:1,name:"cid",kind:"scalar",T:9},{no:2,name:"name",kind:"scalar",T:9},{no:3,name:"type",kind:"enum",T:proto3.getEnumType(TrackType)},{no:4,name:"width",kind:"scalar",T:13},{no:5,name:"height",kind:"scalar",T:13},{no:6,name:"muted",kind:"scalar",T:8},{no:7,name:"disable_dtx",kind:"scalar",T:8},{no:8,name:"source",kind:"enum",T:proto3.getEnumType(TrackSource)},{no:9,name:"layers",kind:"message",T:VideoLayer,repeated:!0},{no:10,name:"simulcast_codecs",kind:"message",T:SimulcastCodec,repeated:!0},{no:11,name:"sid",kind:"scalar",T:9},{no:12,name:"stereo",kind:"scalar",T:8},{no:13,name:"disable_red",kind:"scalar",T:8},{no:14,name:"encryption",kind:"enum",T:proto3.getEnumType(Encryption_Type)},{no:15,name:"stream",kind:"scalar",T:9},{no:16,name:"backup_codec_policy",kind:"enum",T:proto3.getEnumType(BackupCodecPolicy$1)},{no:17,name:"audio_features",kind:"enum",T:proto3.getEnumType(AudioTrackFeature),repeated:!0}]),TrickleRequest=proto3.makeMessageType("livekit.TrickleRequest",()=>[{no:1,name:"candidateInit",kind:"scalar",T:9},{no:2,name:"target",kind:"enum",T:proto3.getEnumType(SignalTarget)},{no:3,name:"final",kind:"scalar",T:8}]),MuteTrackRequest=proto3.makeMessageType("livekit.MuteTrackRequest",()=>[{no:1,name:"sid",kind:"scalar",T:9},{no:2,name:"muted",kind:"scalar",T:8}]),JoinResponse=proto3.makeMessageType("livekit.JoinResponse",()=>[{no:1,name:"room",kind:"message",T:Room$1},{no:2,name:"participant",kind:"message",T:ParticipantInfo},{no:3,name:"other_participants",kind:"message",T:ParticipantInfo,repeated:!0},{no:4,name:"server_version",kind:"scalar",T:9},{no:5,name:"ice_servers",kind:"message",T:ICEServer,repeated:!0},{no:6,name:"subscriber_primary",kind:"scalar",T:8},{no:7,name:"alternative_url",kind:"scalar",T:9},{no:8,name:"client_configuration",kind:"message",T:ClientConfiguration},{no:9,name:"server_region",kind:"scalar",T:9},{no:10,name:"ping_timeout",kind:"scalar",T:5},{no:11,name:"ping_interval",kind:"scalar",T:5},{no:12,name:"server_info",kind:"message",T:ServerInfo},{no:13,name:"sif_trailer",kind:"scalar",T:12},{no:14,name:"enabled_publish_codecs",kind:"message",T:Codec,repeated:!0},{no:15,name:"fast_publish",kind:"scalar",T:8}]),ReconnectResponse=proto3.makeMessageType("livekit.ReconnectResponse",()=>[{no:1,name:"ice_servers",kind:"message",T:ICEServer,repeated:!0},{no:2,name:"client_configuration",kind:"message",T:ClientConfiguration},{no:3,name:"server_info",kind:"message",T:ServerInfo},{no:4,name:"last_message_seq",kind:"scalar",T:13}]),TrackPublishedResponse=proto3.makeMessageType("livekit.TrackPublishedResponse",()=>[{no:1,name:"cid",kind:"scalar",T:9},{no:2,name:"track",kind:"message",T:TrackInfo}]),TrackUnpublishedResponse=proto3.makeMessageType("livekit.TrackUnpublishedResponse",()=>[{no:1,name:"track_sid",kind:"scalar",T:9}]),SessionDescription=proto3.makeMessageType("livekit.SessionDescription",()=>[{no:1,name:"type",kind:"scalar",T:9},{no:2,name:"sdp",kind:"scalar",T:9},{no:3,name:"id",kind:"scalar",T:13}]),ParticipantUpdate=proto3.makeMessageType("livekit.ParticipantUpdate",()=>[{no:1,name:"participants",kind:"message",T:ParticipantInfo,repeated:!0}]),UpdateSubscription=proto3.makeMessageType("livekit.UpdateSubscription",()=>[{no:1,name:"track_sids",kind:"scalar",T:9,repeated:!0},{no:2,name:"subscribe",kind:"scalar",T:8},{no:3,name:"participant_tracks",kind:"message",T:ParticipantTracks,repeated:!0}]),UpdateTrackSettings=proto3.makeMessageType("livekit.UpdateTrackSettings",()=>[{no:1,name:"track_sids",kind:"scalar",T:9,repeated:!0},{no:3,name:"disabled",kind:"scalar",T:8},{no:4,name:"quality",kind:"enum",T:proto3.getEnumType(VideoQuality$1)},{no:5,name:"width",kind:"scalar",T:13},{no:6,name:"height",kind:"scalar",T:13},{no:7,name:"fps",kind:"scalar",T:13},{no:8,name:"priority",kind:"scalar",T:13}]),UpdateLocalAudioTrack=proto3.makeMessageType("livekit.UpdateLocalAudioTrack",()=>[{no:1,name:"track_sid",kind:"scalar",T:9},{no:2,name:"features",kind:"enum",T:proto3.getEnumType(AudioTrackFeature),repeated:!0}]),UpdateLocalVideoTrack=proto3.makeMessageType("livekit.UpdateLocalVideoTrack",()=>[{no:1,name:"track_sid",kind:"scalar",T:9},{no:2,name:"width",kind:"scalar",T:13},{no:3,name:"height",kind:"scalar",T:13}]),LeaveRequest=proto3.makeMessageType("livekit.LeaveRequest",()=>[{no:1,name:"can_reconnect",kind:"scalar",T:8},{no:2,name:"reason",kind:"enum",T:proto3.getEnumType(DisconnectReason)},{no:3,name:"action",kind:"enum",T:proto3.getEnumType(LeaveRequest_Action)},{no:4,name:"regions",kind:"message",T:RegionSettings}]),LeaveRequest_Action=proto3.makeEnum("livekit.LeaveRequest.Action",[{no:0,name:"DISCONNECT"},{no:1,name:"RESUME"},{no:2,name:"RECONNECT"}]),UpdateVideoLayers=proto3.makeMessageType("livekit.UpdateVideoLayers",()=>[{no:1,name:"track_sid",kind:"scalar",T:9},{no:2,name:"layers",kind:"message",T:VideoLayer,repeated:!0}]),UpdateParticipantMetadata=proto3.makeMessageType("livekit.UpdateParticipantMetadata",()=>[{no:1,name:"metadata",kind:"scalar",T:9},{no:2,name:"name",kind:"scalar",T:9},{no:3,name:"attributes",kind:"map",K:9,V:{kind:"scalar",T:9}},{no:4,name:"request_id",kind:"scalar",T:13}]),ICEServer=proto3.makeMessageType("livekit.ICEServer",()=>[{no:1,name:"urls",kind:"scalar",T:9,repeated:!0},{no:2,name:"username",kind:"scalar",T:9},{no:3,name:"credential",kind:"scalar",T:9}]),SpeakersChanged=proto3.makeMessageType("livekit.SpeakersChanged",()=>[{no:1,name:"speakers",kind:"message",T:SpeakerInfo,repeated:!0}]),RoomUpdate=proto3.makeMessageType("livekit.RoomUpdate",()=>[{no:1,name:"room",kind:"message",T:Room$1}]),ConnectionQualityInfo=proto3.makeMessageType("livekit.ConnectionQualityInfo",()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:2,name:"quality",kind:"enum",T:proto3.getEnumType(ConnectionQuality$1)},{no:3,name:"score",kind:"scalar",T:2}]),ConnectionQualityUpdate=proto3.makeMessageType("livekit.ConnectionQualityUpdate",()=>[{no:1,name:"updates",kind:"message",T:ConnectionQualityInfo,repeated:!0}]),StreamStateInfo=proto3.makeMessageType("livekit.StreamStateInfo",()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:2,name:"track_sid",kind:"scalar",T:9},{no:3,name:"state",kind:"enum",T:proto3.getEnumType(StreamState)}]),StreamStateUpdate=proto3.makeMessageType("livekit.StreamStateUpdate",()=>[{no:1,name:"stream_states",kind:"message",T:StreamStateInfo,repeated:!0}]),SubscribedQuality=proto3.makeMessageType("livekit.SubscribedQuality",()=>[{no:1,name:"quality",kind:"enum",T:proto3.getEnumType(VideoQuality$1)},{no:2,name:"enabled",kind:"scalar",T:8}]),SubscribedCodec=proto3.makeMessageType("livekit.SubscribedCodec",()=>[{no:1,name:"codec",kind:"scalar",T:9},{no:2,name:"qualities",kind:"message",T:SubscribedQuality,repeated:!0}]),SubscribedQualityUpdate=proto3.makeMessageType("livekit.SubscribedQualityUpdate",()=>[{no:1,name:"track_sid",kind:"scalar",T:9},{no:2,name:"subscribed_qualities",kind:"message",T:SubscribedQuality,repeated:!0},{no:3,name:"subscribed_codecs",kind:"message",T:SubscribedCodec,repeated:!0}]),TrackPermission=proto3.makeMessageType("livekit.TrackPermission",()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:2,name:"all_tracks",kind:"scalar",T:8},{no:3,name:"track_sids",kind:"scalar",T:9,repeated:!0},{no:4,name:"participant_identity",kind:"scalar",T:9}]),SubscriptionPermission=proto3.makeMessageType("livekit.SubscriptionPermission",()=>[{no:1,name:"all_participants",kind:"scalar",T:8},{no:2,name:"track_permissions",kind:"message",T:TrackPermission,repeated:!0}]),SubscriptionPermissionUpdate=proto3.makeMessageType("livekit.SubscriptionPermissionUpdate",()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:2,name:"track_sid",kind:"scalar",T:9},{no:3,name:"allowed",kind:"scalar",T:8}]),RoomMovedResponse=proto3.makeMessageType("livekit.RoomMovedResponse",()=>[{no:1,name:"room",kind:"message",T:Room$1},{no:2,name:"token",kind:"scalar",T:9},{no:3,name:"participant",kind:"message",T:ParticipantInfo},{no:4,name:"other_participants",kind:"message",T:ParticipantInfo,repeated:!0}]),SyncState=proto3.makeMessageType("livekit.SyncState",()=>[{no:1,name:"answer",kind:"message",T:SessionDescription},{no:2,name:"subscription",kind:"message",T:UpdateSubscription},{no:3,name:"publish_tracks",kind:"message",T:TrackPublishedResponse,repeated:!0},{no:4,name:"data_channels",kind:"message",T:DataChannelInfo,repeated:!0},{no:5,name:"offer",kind:"message",T:SessionDescription},{no:6,name:"track_sids_disabled",kind:"scalar",T:9,repeated:!0},{no:7,name:"datachannel_receive_states",kind:"message",T:DataChannelReceiveState,repeated:!0}]),DataChannelReceiveState=proto3.makeMessageType("livekit.DataChannelReceiveState",()=>[{no:1,name:"publisher_sid",kind:"scalar",T:9},{no:2,name:"last_seq",kind:"scalar",T:13}]),DataChannelInfo=proto3.makeMessageType("livekit.DataChannelInfo",()=>[{no:1,name:"label",kind:"scalar",T:9},{no:2,name:"id",kind:"scalar",T:13},{no:3,name:"target",kind:"enum",T:proto3.getEnumType(SignalTarget)}]),SimulateScenario=proto3.makeMessageType("livekit.SimulateScenario",()=>[{no:1,name:"speaker_update",kind:"scalar",T:5,oneof:"scenario"},{no:2,name:"node_failure",kind:"scalar",T:8,oneof:"scenario"},{no:3,name:"migration",kind:"scalar",T:8,oneof:"scenario"},{no:4,name:"server_leave",kind:"scalar",T:8,oneof:"scenario"},{no:5,name:"switch_candidate_protocol",kind:"enum",T:proto3.getEnumType(CandidateProtocol),oneof:"scenario"},{no:6,name:"subscriber_bandwidth",kind:"scalar",T:3,oneof:"scenario"},{no:7,name:"disconnect_signal_on_resume",kind:"scalar",T:8,oneof:"scenario"},{no:8,name:"disconnect_signal_on_resume_no_messages",kind:"scalar",T:8,oneof:"scenario"},{no:9,name:"leave_request_full_reconnect",kind:"scalar",T:8,oneof:"scenario"}]),Ping=proto3.makeMessageType("livekit.Ping",()=>[{no:1,name:"timestamp",kind:"scalar",T:3},{no:2,name:"rtt",kind:"scalar",T:3}]),Pong=proto3.makeMessageType("livekit.Pong",()=>[{no:1,name:"last_ping_timestamp",kind:"scalar",T:3},{no:2,name:"timestamp",kind:"scalar",T:3}]),RegionSettings=proto3.makeMessageType("livekit.RegionSettings",()=>[{no:1,name:"regions",kind:"message",T:RegionInfo,repeated:!0}]),RegionInfo=proto3.makeMessageType("livekit.RegionInfo",()=>[{no:1,name:"region",kind:"scalar",T:9},{no:2,name:"url",kind:"scalar",T:9},{no:3,name:"distance",kind:"scalar",T:3}]),SubscriptionResponse=proto3.makeMessageType("livekit.SubscriptionResponse",()=>[{no:1,name:"track_sid",kind:"scalar",T:9},{no:2,name:"err",kind:"enum",T:proto3.getEnumType(SubscriptionError)}]),RequestResponse=proto3.makeMessageType("livekit.RequestResponse",()=>[{no:1,name:"request_id",kind:"scalar",T:13},{no:2,name:"reason",kind:"enum",T:proto3.getEnumType(RequestResponse_Reason)},{no:3,name:"message",kind:"scalar",T:9}]),RequestResponse_Reason=proto3.makeEnum("livekit.RequestResponse.Reason",[{no:0,name:"OK"},{no:1,name:"NOT_FOUND"},{no:2,name:"NOT_ALLOWED"},{no:3,name:"LIMIT_EXCEEDED"}]),TrackSubscribed=proto3.makeMessageType("livekit.TrackSubscribed",()=>[{no:1,name:"track_sid",kind:"scalar",T:9}]);function getDefaultExportFromCjs(B){return B&&B.__esModule&&Object.prototype.hasOwnProperty.call(B,"default")?B.default:B}var loglevel$1={exports:{}},loglevel=loglevel$1.exports,hasRequiredLoglevel;function requireLoglevel(){return hasRequiredLoglevel||(hasRequiredLoglevel=1,(function(B){(function($,U){B.exports?B.exports=U():$.log=U()})(loglevel,function(){var $=function(){},U="undefined",F=typeof window!==U&&typeof window.navigator!==U&&/Trident\/|MSIE /.test(window.navigator.userAgent),V=["trace","debug","info","warn","error"],q={},j=null;function W(Z,ne){var ee=Z[ne];if(typeof ee.bind=="function")return ee.bind(Z);try{return Function.prototype.bind.call(ee,Z)}catch{return function(){return Function.prototype.apply.apply(ee,[Z,arguments])}}}function K(){console.log&&(console.log.apply?console.log.apply(console,arguments):Function.prototype.apply.apply(console.log,[console,arguments])),console.trace&&console.trace()}function G(Z){return Z==="debug"&&(Z="log"),typeof console===U?!1:Z==="trace"&&F?K:console[Z]!==void 0?W(console,Z):console.log!==void 0?W(console,"log"):$}function z(){for(var Z=this.getLevel(),ne=0;ne<V.length;ne++){var ee=V[ne];this[ee]=ne<Z?$:this.methodFactory(ee,Z,this.name)}if(this.log=this.debug,typeof console===U&&Z<this.levels.SILENT)return"No console available for logging"}function H(Z){return function(){typeof console!==U&&(z.call(this),this[Z].apply(this,arguments))}}function Q(Z,ne,ee){return G(Z)||H.apply(this,arguments)}function Y(Z,ne){var ee=this,ie,se,te,re="loglevel";typeof Z=="string"?re+=":"+Z:typeof Z=="symbol"&&(re=void 0);function ae(oe){var me=(V[oe]||"silent").toUpperCase();if(!(typeof window===U||!re)){try{window.localStorage[re]=me;return}catch{}try{window.document.cookie=encodeURIComponent(re)+"="+me+";"}catch{}}}function ce(){var oe;if(!(typeof window===U||!re)){try{oe=window.localStorage[re]}catch{}if(typeof oe===U)try{var me=window.document.cookie,be=encodeURIComponent(re),ge=me.indexOf(be+"=");ge!==-1&&(oe=/^([^;]+)/.exec(me.slice(ge+be.length+1))[1])}catch{}return ee.levels[oe]===void 0&&(oe=void 0),oe}}function le(){if(!(typeof window===U||!re)){try{window.localStorage.removeItem(re)}catch{}try{window.document.cookie=encodeURIComponent(re)+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC"}catch{}}}function de(oe){var me=oe;if(typeof me=="string"&&ee.levels[me.toUpperCase()]!==void 0&&(me=ee.levels[me.toUpperCase()]),typeof me=="number"&&me>=0&&me<=ee.levels.SILENT)return me;throw new TypeError("log.setLevel() called with invalid level: "+oe)}ee.name=Z,ee.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},ee.methodFactory=ne||Q,ee.getLevel=function(){return te??se??ie},ee.setLevel=function(oe,me){return te=de(oe),me!==!1&&ae(te),z.call(ee)},ee.setDefaultLevel=function(oe){se=de(oe),ce()||ee.setLevel(oe,!1)},ee.resetLevel=function(){te=null,le(),z.call(ee)},ee.enableAll=function(oe){ee.setLevel(ee.levels.TRACE,oe)},ee.disableAll=function(oe){ee.setLevel(ee.levels.SILENT,oe)},ee.rebuild=function(){if(j!==ee&&(ie=de(j.getLevel())),z.call(ee),j===ee)for(var oe in q)q[oe].rebuild()},ie=de(j?j.getLevel():"WARN");var ue=ce();ue!=null&&(te=de(ue)),z.call(ee)}j=new Y,j.getLogger=function(ne){if(typeof ne!="symbol"&&typeof ne!="string"||ne==="")throw new TypeError("You must supply a name when creating a logger.");var ee=q[ne];return ee||(ee=q[ne]=new Y(ne,j.methodFactory)),ee};var X=typeof window!==U?window.log:void 0;return j.noConflict=function(){return typeof window!==U&&window.log===j&&(window.log=X),j},j.getLoggers=function(){return q},j.default=j,j})})(loglevel$1)),loglevel$1.exports}var loglevelExports=requireLoglevel(),LogLevel;(function(B){B[B.trace=0]="trace",B[B.debug=1]="debug",B[B.info=2]="info",B[B.warn=3]="warn",B[B.error=4]="error",B[B.silent=5]="silent"})(LogLevel||(LogLevel={}));var LoggerNames;(function(B){B.Default="livekit",B.Room="livekit-room",B.Participant="livekit-participant",B.Track="livekit-track",B.Publication="livekit-track-publication",B.Engine="livekit-engine",B.Signal="livekit-signal",B.PCManager="livekit-pc-manager",B.PCTransport="livekit-pc-transport",B.E2EE="lk-e2ee"})(LoggerNames||(LoggerNames={}));let livekitLogger=loglevelExports.getLogger("livekit");Object.values(LoggerNames).map(B=>loglevelExports.getLogger(B)),livekitLogger.setDefaultLevel(LogLevel.info);function getLogger(B){const $=loglevelExports.getLogger(B);return $.setDefaultLevel(livekitLogger.getLevel()),$}const workerLogger=loglevelExports.getLogger("lk-e2ee"),maxRetryDelay=7e3,DEFAULT_RETRY_DELAYS_IN_MS=[0,300,4*300,9*300,16*300,maxRetryDelay,maxRetryDelay,maxRetryDelay,maxRetryDelay,maxRetryDelay];class DefaultReconnectPolicy{constructor($){this._retryDelays=$!==void 0?[...$]:DEFAULT_RETRY_DELAYS_IN_MS}nextRetryDelayInMs($){if($.retryCount>=this._retryDelays.length)return null;const U=this._retryDelays[$.retryCount];return $.retryCount<=1?U:U+Math.random()*1e3}}function __rest(B,$){var U={};for(var F in B)Object.prototype.hasOwnProperty.call(B,F)&&$.indexOf(F)<0&&(U[F]=B[F]);if(B!=null&&typeof Object.getOwnPropertySymbols=="function")for(var V=0,F=Object.getOwnPropertySymbols(B);V<F.length;V++)$.indexOf(F[V])<0&&Object.prototype.propertyIsEnumerable.call(B,F[V])&&(U[F[V]]=B[F[V]]);return U}function __awaiter(B,$,U,F){function V(q){return q instanceof U?q:new U(function(j){j(q)})}return new(U||(U=Promise))(function(q,j){function W(z){try{G(F.next(z))}catch(H){j(H)}}function K(z){try{G(F.throw(z))}catch(H){j(H)}}function G(z){z.done?q(z.value):V(z.value).then(W,K)}G((F=F.apply(B,$||[])).next())})}function __values(B){var $=typeof Symbol=="function"&&Symbol.iterator,U=$&&B[$],F=0;if(U)return U.call(B);if(B&&typeof B.length=="number")return{next:function(){return B&&F>=B.length&&(B=void 0),{value:B&&B[F++],done:!B}}};throw new TypeError($?"Object is not iterable.":"Symbol.iterator is not defined.")}function __asyncValues(B){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var $=B[Symbol.asyncIterator],U;return $?$.call(B):(B=typeof __values=="function"?__values(B):B[Symbol.iterator](),U={},F("next"),F("throw"),F("return"),U[Symbol.asyncIterator]=function(){return this},U);function F(q){U[q]=B[q]&&function(j){return new Promise(function(W,K){j=B[q](j),V(W,K,j.done,j.value)})}}function V(q,j,W,K){Promise.resolve(K).then(function(G){q({value:G,done:W})},j)}}typeof SuppressedError=="function"&&SuppressedError;var events={exports:{}},hasRequiredEvents;function requireEvents(){if(hasRequiredEvents)return events.exports;hasRequiredEvents=1;var B=typeof Reflect=="object"?Reflect:null,$=B&&typeof B.apply=="function"?B.apply:function(re,ae,ce){return Function.prototype.apply.call(re,ae,ce)},U;B&&typeof B.ownKeys=="function"?U=B.ownKeys:Object.getOwnPropertySymbols?U=function(re){return Object.getOwnPropertyNames(re).concat(Object.getOwnPropertySymbols(re))}:U=function(re){return Object.getOwnPropertyNames(re)};function F(te){console&&console.warn&&console.warn(te)}var V=Number.isNaN||function(re){return re!==re};function q(){q.init.call(this)}events.exports=q,events.exports.once=ee,q.EventEmitter=q,q.prototype._events=void 0,q.prototype._eventsCount=0,q.prototype._maxListeners=void 0;var j=10;function W(te){if(typeof te!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof te)}Object.defineProperty(q,"defaultMaxListeners",{enumerable:!0,get:function(){return j},set:function(te){if(typeof te!="number"||te<0||V(te))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+te+".");j=te}}),q.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},q.prototype.setMaxListeners=function(re){if(typeof re!="number"||re<0||V(re))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+re+".");return this._maxListeners=re,this};function K(te){return te._maxListeners===void 0?q.defaultMaxListeners:te._maxListeners}q.prototype.getMaxListeners=function(){return K(this)},q.prototype.emit=function(re){for(var ae=[],ce=1;ce<arguments.length;ce++)ae.push(arguments[ce]);var le=re==="error",de=this._events;if(de!==void 0)le=le&&de.error===void 0;else if(!le)return!1;if(le){var ue;if(ae.length>0&&(ue=ae[0]),ue instanceof Error)throw ue;var oe=new Error("Unhandled error."+(ue?" ("+ue.message+")":""));throw oe.context=ue,oe}var me=de[re];if(me===void 0)return!1;if(typeof me=="function")$(me,this,ae);else for(var be=me.length,ge=X(me,be),ce=0;ce<be;++ce)$(ge[ce],this,ae);return!0};function G(te,re,ae,ce){var le,de,ue;if(W(ae),de=te._events,de===void 0?(de=te._events=Object.create(null),te._eventsCount=0):(de.newListener!==void 0&&(te.emit("newListener",re,ae.listener?ae.listener:ae),de=te._events),ue=de[re]),ue===void 0)ue=de[re]=ae,++te._eventsCount;else if(typeof ue=="function"?ue=de[re]=ce?[ae,ue]:[ue,ae]:ce?ue.unshift(ae):ue.push(ae),le=K(te),le>0&&ue.length>le&&!ue.warned){ue.warned=!0;var oe=new Error("Possible EventEmitter memory leak detected. "+ue.length+" "+String(re)+" listeners added. Use emitter.setMaxListeners() to increase limit");oe.name="MaxListenersExceededWarning",oe.emitter=te,oe.type=re,oe.count=ue.length,F(oe)}return te}q.prototype.addListener=function(re,ae){return G(this,re,ae,!1)},q.prototype.on=q.prototype.addListener,q.prototype.prependListener=function(re,ae){return G(this,re,ae,!0)};function z(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function H(te,re,ae){var ce={fired:!1,wrapFn:void 0,target:te,type:re,listener:ae},le=z.bind(ce);return le.listener=ae,ce.wrapFn=le,le}q.prototype.once=function(re,ae){return W(ae),this.on(re,H(this,re,ae)),this},q.prototype.prependOnceListener=function(re,ae){return W(ae),this.prependListener(re,H(this,re,ae)),this},q.prototype.removeListener=function(re,ae){var ce,le,de,ue,oe;if(W(ae),le=this._events,le===void 0)return this;if(ce=le[re],ce===void 0)return this;if(ce===ae||ce.listener===ae)--this._eventsCount===0?this._events=Object.create(null):(delete le[re],le.removeListener&&this.emit("removeListener",re,ce.listener||ae));else if(typeof ce!="function"){for(de=-1,ue=ce.length-1;ue>=0;ue--)if(ce[ue]===ae||ce[ue].listener===ae){oe=ce[ue].listener,de=ue;break}if(de<0)return this;de===0?ce.shift():Z(ce,de),ce.length===1&&(le[re]=ce[0]),le.removeListener!==void 0&&this.emit("removeListener",re,oe||ae)}return this},q.prototype.off=q.prototype.removeListener,q.prototype.removeAllListeners=function(re){var ae,ce,le;if(ce=this._events,ce===void 0)return this;if(ce.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):ce[re]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete ce[re]),this;if(arguments.length===0){var de=Object.keys(ce),ue;for(le=0;le<de.length;++le)ue=de[le],ue!=="removeListener"&&this.removeAllListeners(ue);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(ae=ce[re],typeof ae=="function")this.removeListener(re,ae);else if(ae!==void 0)for(le=ae.length-1;le>=0;le--)this.removeListener(re,ae[le]);return this};function Q(te,re,ae){var ce=te._events;if(ce===void 0)return[];var le=ce[re];return le===void 0?[]:typeof le=="function"?ae?[le.listener||le]:[le]:ae?ne(le):X(le,le.length)}q.prototype.listeners=function(re){return Q(this,re,!0)},q.prototype.rawListeners=function(re){return Q(this,re,!1)},q.listenerCount=function(te,re){return typeof te.listenerCount=="function"?te.listenerCount(re):Y.call(te,re)},q.prototype.listenerCount=Y;function Y(te){var re=this._events;if(re!==void 0){var ae=re[te];if(typeof ae=="function")return 1;if(ae!==void 0)return ae.length}return 0}q.prototype.eventNames=function(){return this._eventsCount>0?U(this._events):[]};function X(te,re){for(var ae=new Array(re),ce=0;ce<re;++ce)ae[ce]=te[ce];return ae}function Z(te,re){for(;re+1<te.length;re++)te[re]=te[re+1];te.pop()}function ne(te){for(var re=new Array(te.length),ae=0;ae<re.length;++ae)re[ae]=te[ae].listener||te[ae];return re}function ee(te,re){return new Promise(function(ae,ce){function le(ue){te.removeListener(re,de),ce(ue)}function de(){typeof te.removeListener=="function"&&te.removeListener("error",le),ae([].slice.call(arguments))}se(te,re,de,{once:!0}),re!=="error"&&ie(te,le,{once:!0})})}function ie(te,re,ae){typeof te.on=="function"&&se(te,"error",re,ae)}function se(te,re,ae,ce){if(typeof te.on=="function")ce.once?te.once(re,ae):te.on(re,ae);else if(typeof te.addEventListener=="function")te.addEventListener(re,function le(de){ce.once&&te.removeEventListener(re,le),ae(de)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof te)}return events.exports}var eventsExports=requireEvents();let logDisabled_=!0,deprecationWarnings_=!0;function extractVersion(B,$,U){const F=B.match($);return F&&F.length>=U&&parseFloat(F[U],10)}function wrapPeerConnectionEvent(B,$,U){if(!B.RTCPeerConnection)return;const F=B.RTCPeerConnection.prototype,V=F.addEventListener;F.addEventListener=function(j,W){if(j!==$)return V.apply(this,arguments);const K=G=>{const z=U(G);z&&(W.handleEvent?W.handleEvent(z):W(z))};return this._eventMap=this._eventMap||{},this._eventMap[$]||(this._eventMap[$]=new Map),this._eventMap[$].set(W,K),V.apply(this,[j,K])};const q=F.removeEventListener;F.removeEventListener=function(j,W){if(j!==$||!this._eventMap||!this._eventMap[$])return q.apply(this,arguments);if(!this._eventMap[$].has(W))return q.apply(this,arguments);const K=this._eventMap[$].get(W);return this._eventMap[$].delete(W),this._eventMap[$].size===0&&delete this._eventMap[$],Object.keys(this._eventMap).length===0&&delete this._eventMap,q.apply(this,[j,K])},Object.defineProperty(F,"on"+$,{get(){return this["_on"+$]},set(j){this["_on"+$]&&(this.removeEventListener($,this["_on"+$]),delete this["_on"+$]),j&&this.addEventListener($,this["_on"+$]=j)},enumerable:!0,configurable:!0})}function disableLog(B){return typeof B!="boolean"?new Error("Argument type: "+typeof B+". Please use a boolean."):(logDisabled_=B,B?"adapter.js logging disabled":"adapter.js logging enabled")}function disableWarnings(B){return typeof B!="boolean"?new Error("Argument type: "+typeof B+". Please use a boolean."):(deprecationWarnings_=!B,"adapter.js deprecation warnings "+(B?"disabled":"enabled"))}function log(){if(typeof window=="object"){if(logDisabled_)return;typeof console<"u"&&typeof console.log=="function"&&console.log.apply(console,arguments)}}function deprecated(B,$){deprecationWarnings_&&console.warn(B+" is deprecated, please use "+$+" instead.")}function detectBrowser(B){const $={browser:null,version:null};if(typeof B>"u"||!B.navigator||!B.navigator.userAgent)return $.browser="Not a browser.",$;const{navigator:U}=B;if(U.userAgentData&&U.userAgentData.brands){const F=U.userAgentData.brands.find(V=>V.brand==="Chromium");if(F)return{browser:"chrome",version:parseInt(F.version,10)}}if(U.mozGetUserMedia)$.browser="firefox",$.version=parseInt(extractVersion(U.userAgent,/Firefox\/(\d+)\./,1));else if(U.webkitGetUserMedia||B.isSecureContext===!1&&B.webkitRTCPeerConnection)$.browser="chrome",$.version=parseInt(extractVersion(U.userAgent,/Chrom(e|ium)\/(\d+)\./,2));else if(B.RTCPeerConnection&&U.userAgent.match(/AppleWebKit\/(\d+)\./))$.browser="safari",$.version=parseInt(extractVersion(U.userAgent,/AppleWebKit\/(\d+)\./,1)),$.supportsUnifiedPlan=B.RTCRtpTransceiver&&"currentDirection"in B.RTCRtpTransceiver.prototype,$._safariVersion=extractVersion(U.userAgent,/Version\/(\d+(\.?\d+))/,1);else return $.browser="Not a supported browser.",$;return $}function isObject(B){return Object.prototype.toString.call(B)==="[object Object]"}function compactObject(B){return isObject(B)?Object.keys(B).reduce(function($,U){const F=isObject(B[U]),V=F?compactObject(B[U]):B[U],q=F&&!Object.keys(V).length;return V===void 0||q?$:Object.assign($,{[U]:V})},{}):B}function walkStats(B,$,U){!$||U.has($.id)||(U.set($.id,$),Object.keys($).forEach(F=>{F.endsWith("Id")?walkStats(B,B.get($[F]),U):F.endsWith("Ids")&&$[F].forEach(V=>{walkStats(B,B.get(V),U)})}))}function filterStats(B,$,U){const F=U?"outbound-rtp":"inbound-rtp",V=new Map;if($===null)return V;const q=[];return B.forEach(j=>{j.type==="track"&&j.trackIdentifier===$.id&&q.push(j)}),q.forEach(j=>{B.forEach(W=>{W.type===F&&W.trackId===j.id&&walkStats(B,W,V)})}),V}const logging=log;function shimGetUserMedia$2(B,$){const U=B&&B.navigator;if(!U.mediaDevices)return;const F=function(W){if(typeof W!="object"||W.mandatory||W.optional)return W;const K={};return Object.keys(W).forEach(G=>{if(G==="require"||G==="advanced"||G==="mediaSource")return;const z=typeof W[G]=="object"?W[G]:{ideal:W[G]};z.exact!==void 0&&typeof z.exact=="number"&&(z.min=z.max=z.exact);const H=function(Q,Y){return Q?Q+Y.charAt(0).toUpperCase()+Y.slice(1):Y==="deviceId"?"sourceId":Y};if(z.ideal!==void 0){K.optional=K.optional||[];let Q={};typeof z.ideal=="number"?(Q[H("min",G)]=z.ideal,K.optional.push(Q),Q={},Q[H("max",G)]=z.ideal,K.optional.push(Q)):(Q[H("",G)]=z.ideal,K.optional.push(Q))}z.exact!==void 0&&typeof z.exact!="number"?(K.mandatory=K.mandatory||{},K.mandatory[H("",G)]=z.exact):["min","max"].forEach(Q=>{z[Q]!==void 0&&(K.mandatory=K.mandatory||{},K.mandatory[H(Q,G)]=z[Q])})}),W.advanced&&(K.optional=(K.optional||[]).concat(W.advanced)),K},V=function(W,K){if($.version>=61)return K(W);if(W=JSON.parse(JSON.stringify(W)),W&&typeof W.audio=="object"){const G=function(z,H,Q){H in z&&!(Q in z)&&(z[Q]=z[H],delete z[H])};W=JSON.parse(JSON.stringify(W)),G(W.audio,"autoGainControl","googAutoGainControl"),G(W.audio,"noiseSuppression","googNoiseSuppression"),W.audio=F(W.audio)}if(W&&typeof W.video=="object"){let G=W.video.facingMode;G=G&&(typeof G=="object"?G:{ideal:G});const z=$.version<66;if(G&&(G.exact==="user"||G.exact==="environment"||G.ideal==="user"||G.ideal==="environment")&&!(U.mediaDevices.getSupportedConstraints&&U.mediaDevices.getSupportedConstraints().facingMode&&!z)){delete W.video.facingMode;let H;if(G.exact==="environment"||G.ideal==="environment"?H=["back","rear"]:(G.exact==="user"||G.ideal==="user")&&(H=["front"]),H)return U.mediaDevices.enumerateDevices().then(Q=>{Q=Q.filter(X=>X.kind==="videoinput");let Y=Q.find(X=>H.some(Z=>X.label.toLowerCase().includes(Z)));return!Y&&Q.length&&H.includes("back")&&(Y=Q[Q.length-1]),Y&&(W.video.deviceId=G.exact?{exact:Y.deviceId}:{ideal:Y.deviceId}),W.video=F(W.video),logging("chrome: "+JSON.stringify(W)),K(W)})}W.video=F(W.video)}return logging("chrome: "+JSON.stringify(W)),K(W)},q=function(W){return $.version>=64?W:{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[W.name]||W.name,message:W.message,constraint:W.constraint||W.constraintName,toString(){return this.name+(this.message&&": ")+this.message}}},j=function(W,K,G){V(W,z=>{U.webkitGetUserMedia(z,K,H=>{G&&G(q(H))})})};if(U.getUserMedia=j.bind(U),U.mediaDevices.getUserMedia){const W=U.mediaDevices.getUserMedia.bind(U.mediaDevices);U.mediaDevices.getUserMedia=function(K){return V(K,G=>W(G).then(z=>{if(G.audio&&!z.getAudioTracks().length||G.video&&!z.getVideoTracks().length)throw z.getTracks().forEach(H=>{H.stop()}),new DOMException("","NotFoundError");return z},z=>Promise.reject(q(z))))}}}function shimMediaStream(B){B.MediaStream=B.MediaStream||B.webkitMediaStream}function shimOnTrack$1(B){if(typeof B=="object"&&B.RTCPeerConnection&&!("ontrack"in B.RTCPeerConnection.prototype)){Object.defineProperty(B.RTCPeerConnection.prototype,"ontrack",{get(){return this._ontrack},set(U){this._ontrack&&this.removeEventListener("track",this._ontrack),this.addEventListener("track",this._ontrack=U)},enumerable:!0,configurable:!0});const $=B.RTCPeerConnection.prototype.setRemoteDescription;B.RTCPeerConnection.prototype.setRemoteDescription=function(){return this._ontrackpoly||(this._ontrackpoly=F=>{F.stream.addEventListener("addtrack",V=>{let q;B.RTCPeerConnection.prototype.getReceivers?q=this.getReceivers().find(W=>W.track&&W.track.id===V.track.id):q={track:V.track};const j=new Event("track");j.track=V.track,j.receiver=q,j.transceiver={receiver:q},j.streams=[F.stream],this.dispatchEvent(j)}),F.stream.getTracks().forEach(V=>{let q;B.RTCPeerConnection.prototype.getReceivers?q=this.getReceivers().find(W=>W.track&&W.track.id===V.id):q={track:V};const j=new Event("track");j.track=V,j.receiver=q,j.transceiver={receiver:q},j.streams=[F.stream],this.dispatchEvent(j)})},this.addEventListener("addstream",this._ontrackpoly)),$.apply(this,arguments)}}else wrapPeerConnectionEvent(B,"track",$=>($.transceiver||Object.defineProperty($,"transceiver",{value:{receiver:$.receiver}}),$))}function shimGetSendersWithDtmf(B){if(typeof B=="object"&&B.RTCPeerConnection&&!("getSenders"in B.RTCPeerConnection.prototype)&&"createDTMFSender"in B.RTCPeerConnection.prototype){const $=function(V,q){return{track:q,get dtmf(){return this._dtmf===void 0&&(q.kind==="audio"?this._dtmf=V.createDTMFSender(q):this._dtmf=null),this._dtmf},_pc:V}};if(!B.RTCPeerConnection.prototype.getSenders){B.RTCPeerConnection.prototype.getSenders=function(){return this._senders=this._senders||[],this._senders.slice()};const V=B.RTCPeerConnection.prototype.addTrack;B.RTCPeerConnection.prototype.addTrack=function(W,K){let G=V.apply(this,arguments);return G||(G=$(this,W),this._senders.push(G)),G};const q=B.RTCPeerConnection.prototype.removeTrack;B.RTCPeerConnection.prototype.removeTrack=function(W){q.apply(this,arguments);const K=this._senders.indexOf(W);K!==-1&&this._senders.splice(K,1)}}const U=B.RTCPeerConnection.prototype.addStream;B.RTCPeerConnection.prototype.addStream=function(q){this._senders=this._senders||[],U.apply(this,[q]),q.getTracks().forEach(j=>{this._senders.push($(this,j))})};const F=B.RTCPeerConnection.prototype.removeStream;B.RTCPeerConnection.prototype.removeStream=function(q){this._senders=this._senders||[],F.apply(this,[q]),q.getTracks().forEach(j=>{const W=this._senders.find(K=>K.track===j);W&&this._senders.splice(this._senders.indexOf(W),1)})}}else if(typeof B=="object"&&B.RTCPeerConnection&&"getSenders"in B.RTCPeerConnection.prototype&&"createDTMFSender"in B.RTCPeerConnection.prototype&&B.RTCRtpSender&&!("dtmf"in B.RTCRtpSender.prototype)){const $=B.RTCPeerConnection.prototype.getSenders;B.RTCPeerConnection.prototype.getSenders=function(){const F=$.apply(this,[]);return F.forEach(V=>V._pc=this),F},Object.defineProperty(B.RTCRtpSender.prototype,"dtmf",{get(){return this._dtmf===void 0&&(this.track.kind==="audio"?this._dtmf=this._pc.createDTMFSender(this.track):this._dtmf=null),this._dtmf}})}}function shimSenderReceiverGetStats(B){if(!(typeof B=="object"&&B.RTCPeerConnection&&B.RTCRtpSender&&B.RTCRtpReceiver))return;if(!("getStats"in B.RTCRtpSender.prototype)){const U=B.RTCPeerConnection.prototype.getSenders;U&&(B.RTCPeerConnection.prototype.getSenders=function(){const q=U.apply(this,[]);return q.forEach(j=>j._pc=this),q});const F=B.RTCPeerConnection.prototype.addTrack;F&&(B.RTCPeerConnection.prototype.addTrack=function(){const q=F.apply(this,arguments);return q._pc=this,q}),B.RTCRtpSender.prototype.getStats=function(){const q=this;return this._pc.getStats().then(j=>filterStats(j,q.track,!0))}}if(!("getStats"in B.RTCRtpReceiver.prototype)){const U=B.RTCPeerConnection.prototype.getReceivers;U&&(B.RTCPeerConnection.prototype.getReceivers=function(){const V=U.apply(this,[]);return V.forEach(q=>q._pc=this),V}),wrapPeerConnectionEvent(B,"track",F=>(F.receiver._pc=F.srcElement,F)),B.RTCRtpReceiver.prototype.getStats=function(){const V=this;return this._pc.getStats().then(q=>filterStats(q,V.track,!1))}}if(!("getStats"in B.RTCRtpSender.prototype&&"getStats"in B.RTCRtpReceiver.prototype))return;const $=B.RTCPeerConnection.prototype.getStats;B.RTCPeerConnection.prototype.getStats=function(){if(arguments.length>0&&arguments[0]instanceof B.MediaStreamTrack){const F=arguments[0];let V,q,j;return this.getSenders().forEach(W=>{W.track===F&&(V?j=!0:V=W)}),this.getReceivers().forEach(W=>(W.track===F&&(q?j=!0:q=W),W.track===F)),j||V&&q?Promise.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError")):V?V.getStats():q?q.getStats():Promise.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return $.apply(this,arguments)}}function shimAddTrackRemoveTrackWithNative(B){B.RTCPeerConnection.prototype.getLocalStreams=function(){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},Object.keys(this._shimmedLocalStreams).map(j=>this._shimmedLocalStreams[j][0])};const $=B.RTCPeerConnection.prototype.addTrack;B.RTCPeerConnection.prototype.addTrack=function(j,W){if(!W)return $.apply(this,arguments);this._shimmedLocalStreams=this._shimmedLocalStreams||{};const K=$.apply(this,arguments);return this._shimmedLocalStreams[W.id]?this._shimmedLocalStreams[W.id].indexOf(K)===-1&&this._shimmedLocalStreams[W.id].push(K):this._shimmedLocalStreams[W.id]=[W,K],K};const U=B.RTCPeerConnection.prototype.addStream;B.RTCPeerConnection.prototype.addStream=function(j){this._shimmedLocalStreams=this._shimmedLocalStreams||{},j.getTracks().forEach(G=>{if(this.getSenders().find(H=>H.track===G))throw new DOMException("Track already exists.","InvalidAccessError")});const W=this.getSenders();U.apply(this,arguments);const K=this.getSenders().filter(G=>W.indexOf(G)===-1);this._shimmedLocalStreams[j.id]=[j].concat(K)};const F=B.RTCPeerConnection.prototype.removeStream;B.RTCPeerConnection.prototype.removeStream=function(j){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},delete this._shimmedLocalStreams[j.id],F.apply(this,arguments)};const V=B.RTCPeerConnection.prototype.removeTrack;B.RTCPeerConnection.prototype.removeTrack=function(j){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},j&&Object.keys(this._shimmedLocalStreams).forEach(W=>{const K=this._shimmedLocalStreams[W].indexOf(j);K!==-1&&this._shimmedLocalStreams[W].splice(K,1),this._shimmedLocalStreams[W].length===1&&delete this._shimmedLocalStreams[W]}),V.apply(this,arguments)}}function shimAddTrackRemoveTrack(B,$){if(!B.RTCPeerConnection)return;if(B.RTCPeerConnection.prototype.addTrack&&$.version>=65)return shimAddTrackRemoveTrackWithNative(B);const U=B.RTCPeerConnection.prototype.getLocalStreams;B.RTCPeerConnection.prototype.getLocalStreams=function(){const z=U.apply(this);return this._reverseStreams=this._reverseStreams||{},z.map(H=>this._reverseStreams[H.id])};const F=B.RTCPeerConnection.prototype.addStream;B.RTCPeerConnection.prototype.addStream=function(z){if(this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},z.getTracks().forEach(H=>{if(this.getSenders().find(Y=>Y.track===H))throw new DOMException("Track already exists.","InvalidAccessError")}),!this._reverseStreams[z.id]){const H=new B.MediaStream(z.getTracks());this._streams[z.id]=H,this._reverseStreams[H.id]=z,z=H}F.apply(this,[z])};const V=B.RTCPeerConnection.prototype.removeStream;B.RTCPeerConnection.prototype.removeStream=function(z){this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},V.apply(this,[this._streams[z.id]||z]),delete this._reverseStreams[this._streams[z.id]?this._streams[z.id].id:z.id],delete this._streams[z.id]},B.RTCPeerConnection.prototype.addTrack=function(z,H){if(this.signalingState==="closed")throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");const Q=[].slice.call(arguments,1);if(Q.length!==1||!Q[0].getTracks().find(Z=>Z===z))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");if(this.getSenders().find(Z=>Z.track===z))throw new DOMException("Track already exists.","InvalidAccessError");this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{};const X=this._streams[H.id];if(X)X.addTrack(z),Promise.resolve().then(()=>{this.dispatchEvent(new Event("negotiationneeded"))});else{const Z=new B.MediaStream([z]);this._streams[H.id]=Z,this._reverseStreams[Z.id]=H,this.addStream(Z)}return this.getSenders().find(Z=>Z.track===z)};function q(G,z){let H=z.sdp;return Object.keys(G._reverseStreams||[]).forEach(Q=>{const Y=G._reverseStreams[Q],X=G._streams[Y.id];H=H.replace(new RegExp(X.id,"g"),Y.id)}),new RTCSessionDescription({type:z.type,sdp:H})}function j(G,z){let H=z.sdp;return Object.keys(G._reverseStreams||[]).forEach(Q=>{const Y=G._reverseStreams[Q],X=G._streams[Y.id];H=H.replace(new RegExp(Y.id,"g"),X.id)}),new RTCSessionDescription({type:z.type,sdp:H})}["createOffer","createAnswer"].forEach(function(G){const z=B.RTCPeerConnection.prototype[G],H={[G](){const Q=arguments;return arguments.length&&typeof arguments[0]=="function"?z.apply(this,[X=>{const Z=q(this,X);Q[0].apply(null,[Z])},X=>{Q[1]&&Q[1].apply(null,X)},arguments[2]]):z.apply(this,arguments).then(X=>q(this,X))}};B.RTCPeerConnection.prototype[G]=H[G]});const W=B.RTCPeerConnection.prototype.setLocalDescription;B.RTCPeerConnection.prototype.setLocalDescription=function(){return!arguments.length||!arguments[0].type?W.apply(this,arguments):(arguments[0]=j(this,arguments[0]),W.apply(this,arguments))};const K=Object.getOwnPropertyDescriptor(B.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(B.RTCPeerConnection.prototype,"localDescription",{get(){const G=K.get.apply(this);return G.type===""?G:q(this,G)}}),B.RTCPeerConnection.prototype.removeTrack=function(z){if(this.signalingState==="closed")throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!z._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");if(!(z._pc===this))throw new DOMException("Sender was not created by this connection.","InvalidAccessError");this._streams=this._streams||{};let Q;Object.keys(this._streams).forEach(Y=>{this._streams[Y].getTracks().find(Z=>z.track===Z)&&(Q=this._streams[Y])}),Q&&(Q.getTracks().length===1?this.removeStream(this._reverseStreams[Q.id]):Q.removeTrack(z.track),this.dispatchEvent(new Event("negotiationneeded")))}}function shimPeerConnection$1(B,$){!B.RTCPeerConnection&&B.webkitRTCPeerConnection&&(B.RTCPeerConnection=B.webkitRTCPeerConnection),B.RTCPeerConnection&&$.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(U){const F=B.RTCPeerConnection.prototype[U],V={[U](){return arguments[0]=new(U==="addIceCandidate"?B.RTCIceCandidate:B.RTCSessionDescription)(arguments[0]),F.apply(this,arguments)}};B.RTCPeerConnection.prototype[U]=V[U]})}function fixNegotiationNeeded(B,$){wrapPeerConnectionEvent(B,"negotiationneeded",U=>{const F=U.target;if(!(($.version<72||F.getConfiguration&&F.getConfiguration().sdpSemantics==="plan-b")&&F.signalingState!=="stable"))return U})}var chromeShim=Object.freeze({__proto__:null,fixNegotiationNeeded,shimAddTrackRemoveTrack,shimAddTrackRemoveTrackWithNative,shimGetSendersWithDtmf,shimGetUserMedia:shimGetUserMedia$2,shimMediaStream,shimOnTrack:shimOnTrack$1,shimPeerConnection:shimPeerConnection$1,shimSenderReceiverGetStats});function shimGetUserMedia$1(B,$){const U=B&&B.navigator,F=B&&B.MediaStreamTrack;if(U.getUserMedia=function(V,q,j){deprecated("navigator.getUserMedia","navigator.mediaDevices.getUserMedia"),U.mediaDevices.getUserMedia(V).then(q,j)},!($.version>55&&"autoGainControl"in U.mediaDevices.getSupportedConstraints())){const V=function(j,W,K){W in j&&!(K in j)&&(j[K]=j[W],delete j[W])},q=U.mediaDevices.getUserMedia.bind(U.mediaDevices);if(U.mediaDevices.getUserMedia=function(j){return typeof j=="object"&&typeof j.audio=="object"&&(j=JSON.parse(JSON.stringify(j)),V(j.audio,"autoGainControl","mozAutoGainControl"),V(j.audio,"noiseSuppression","mozNoiseSuppression")),q(j)},F&&F.prototype.getSettings){const j=F.prototype.getSettings;F.prototype.getSettings=function(){const W=j.apply(this,arguments);return V(W,"mozAutoGainControl","autoGainControl"),V(W,"mozNoiseSuppression","noiseSuppression"),W}}if(F&&F.prototype.applyConstraints){const j=F.prototype.applyConstraints;F.prototype.applyConstraints=function(W){return this.kind==="audio"&&typeof W=="object"&&(W=JSON.parse(JSON.stringify(W)),V(W,"autoGainControl","mozAutoGainControl"),V(W,"noiseSuppression","mozNoiseSuppression")),j.apply(this,[W])}}}}function shimGetDisplayMedia(B,$){B.navigator.mediaDevices&&"getDisplayMedia"in B.navigator.mediaDevices||B.navigator.mediaDevices&&(B.navigator.mediaDevices.getDisplayMedia=function(F){if(!(F&&F.video)){const V=new DOMException("getDisplayMedia without video constraints is undefined");return V.name="NotFoundError",V.code=8,Promise.reject(V)}return F.video===!0?F.video={mediaSource:$}:F.video.mediaSource=$,B.navigator.mediaDevices.getUserMedia(F)})}function shimOnTrack(B){typeof B=="object"&&B.RTCTrackEvent&&"receiver"in B.RTCTrackEvent.prototype&&!("transceiver"in B.RTCTrackEvent.prototype)&&Object.defineProperty(B.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function shimPeerConnection(B,$){if(typeof B!="object"||!(B.RTCPeerConnection||B.mozRTCPeerConnection))return;!B.RTCPeerConnection&&B.mozRTCPeerConnection&&(B.RTCPeerConnection=B.mozRTCPeerConnection),$.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(V){const q=B.RTCPeerConnection.prototype[V],j={[V](){return arguments[0]=new(V==="addIceCandidate"?B.RTCIceCandidate:B.RTCSessionDescription)(arguments[0]),q.apply(this,arguments)}};B.RTCPeerConnection.prototype[V]=j[V]});const U={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},F=B.RTCPeerConnection.prototype.getStats;B.RTCPeerConnection.prototype.getStats=function(){const[q,j,W]=arguments;return F.apply(this,[q||null]).then(K=>{if($.version<53&&!j)try{K.forEach(G=>{G.type=U[G.type]||G.type})}catch(G){if(G.name!=="TypeError")throw G;K.forEach((z,H)=>{K.set(H,Object.assign({},z,{type:U[z.type]||z.type}))})}return K}).then(j,W)}}function shimSenderGetStats(B){if(!(typeof B=="object"&&B.RTCPeerConnection&&B.RTCRtpSender)||B.RTCRtpSender&&"getStats"in B.RTCRtpSender.prototype)return;const $=B.RTCPeerConnection.prototype.getSenders;$&&(B.RTCPeerConnection.prototype.getSenders=function(){const V=$.apply(this,[]);return V.forEach(q=>q._pc=this),V});const U=B.RTCPeerConnection.prototype.addTrack;U&&(B.RTCPeerConnection.prototype.addTrack=function(){const V=U.apply(this,arguments);return V._pc=this,V}),B.RTCRtpSender.prototype.getStats=function(){return this.track?this._pc.getStats(this.track):Promise.resolve(new Map)}}function shimReceiverGetStats(B){if(!(typeof B=="object"&&B.RTCPeerConnection&&B.RTCRtpSender)||B.RTCRtpSender&&"getStats"in B.RTCRtpReceiver.prototype)return;const $=B.RTCPeerConnection.prototype.getReceivers;$&&(B.RTCPeerConnection.prototype.getReceivers=function(){const F=$.apply(this,[]);return F.forEach(V=>V._pc=this),F}),wrapPeerConnectionEvent(B,"track",U=>(U.receiver._pc=U.srcElement,U)),B.RTCRtpReceiver.prototype.getStats=function(){return this._pc.getStats(this.track)}}function shimRemoveStream(B){!B.RTCPeerConnection||"removeStream"in B.RTCPeerConnection.prototype||(B.RTCPeerConnection.prototype.removeStream=function(U){deprecated("removeStream","removeTrack"),this.getSenders().forEach(F=>{F.track&&U.getTracks().includes(F.track)&&this.removeTrack(F)})})}function shimRTCDataChannel(B){B.DataChannel&&!B.RTCDataChannel&&(B.RTCDataChannel=B.DataChannel)}function shimAddTransceiver(B){if(!(typeof B=="object"&&B.RTCPeerConnection))return;const $=B.RTCPeerConnection.prototype.addTransceiver;$&&(B.RTCPeerConnection.prototype.addTransceiver=function(){this.setParametersPromises=[];let F=arguments[1]&&arguments[1].sendEncodings;F===void 0&&(F=[]),F=[...F];const V=F.length>0;V&&F.forEach(j=>{if("rid"in j&&!/^[a-z0-9]{0,16}$/i.test(j.rid))throw new TypeError("Invalid RID value provided.");if("scaleResolutionDownBy"in j&&!(parseFloat(j.scaleResolutionDownBy)>=1))throw new RangeError("scale_resolution_down_by must be >= 1.0");if("maxFramerate"in j&&!(parseFloat(j.maxFramerate)>=0))throw new RangeError("max_framerate must be >= 0.0")});const q=$.apply(this,arguments);if(V){const{sender:j}=q,W=j.getParameters();(!("encodings"in W)||W.encodings.length===1&&Object.keys(W.encodings[0]).length===0)&&(W.encodings=F,j.sendEncodings=F,this.setParametersPromises.push(j.setParameters(W).then(()=>{delete j.sendEncodings}).catch(()=>{delete j.sendEncodings})))}return q})}function shimGetParameters(B){if(!(typeof B=="object"&&B.RTCRtpSender))return;const $=B.RTCRtpSender.prototype.getParameters;$&&(B.RTCRtpSender.prototype.getParameters=function(){const F=$.apply(this,arguments);return"encodings"in F||(F.encodings=[].concat(this.sendEncodings||[{}])),F})}function shimCreateOffer(B){if(!(typeof B=="object"&&B.RTCPeerConnection))return;const $=B.RTCPeerConnection.prototype.createOffer;B.RTCPeerConnection.prototype.createOffer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then(()=>$.apply(this,arguments)).finally(()=>{this.setParametersPromises=[]}):$.apply(this,arguments)}}function shimCreateAnswer(B){if(!(typeof B=="object"&&B.RTCPeerConnection))return;const $=B.RTCPeerConnection.prototype.createAnswer;B.RTCPeerConnection.prototype.createAnswer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then(()=>$.apply(this,arguments)).finally(()=>{this.setParametersPromises=[]}):$.apply(this,arguments)}}var firefoxShim=Object.freeze({__proto__:null,shimAddTransceiver,shimCreateAnswer,shimCreateOffer,shimGetDisplayMedia,shimGetParameters,shimGetUserMedia:shimGetUserMedia$1,shimOnTrack,shimPeerConnection,shimRTCDataChannel,shimReceiverGetStats,shimRemoveStream,shimSenderGetStats});function shimLocalStreamsAPI(B){if(!(typeof B!="object"||!B.RTCPeerConnection)){if("getLocalStreams"in B.RTCPeerConnection.prototype||(B.RTCPeerConnection.prototype.getLocalStreams=function(){return this._localStreams||(this._localStreams=[]),this._localStreams}),!("addStream"in B.RTCPeerConnection.prototype)){const $=B.RTCPeerConnection.prototype.addTrack;B.RTCPeerConnection.prototype.addStream=function(F){this._localStreams||(this._localStreams=[]),this._localStreams.includes(F)||this._localStreams.push(F),F.getAudioTracks().forEach(V=>$.call(this,V,F)),F.getVideoTracks().forEach(V=>$.call(this,V,F))},B.RTCPeerConnection.prototype.addTrack=function(F){for(var V=arguments.length,q=new Array(V>1?V-1:0),j=1;j<V;j++)q[j-1]=arguments[j];return q&&q.forEach(W=>{this._localStreams?this._localStreams.includes(W)||this._localStreams.push(W):this._localStreams=[W]}),$.apply(this,arguments)}}"removeStream"in B.RTCPeerConnection.prototype||(B.RTCPeerConnection.prototype.removeStream=function(U){this._localStreams||(this._localStreams=[]);const F=this._localStreams.indexOf(U);if(F===-1)return;this._localStreams.splice(F,1);const V=U.getTracks();this.getSenders().forEach(q=>{V.includes(q.track)&&this.removeTrack(q)})})}}function shimRemoteStreamsAPI(B){if(!(typeof B!="object"||!B.RTCPeerConnection)&&("getRemoteStreams"in B.RTCPeerConnection.prototype||(B.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}),!("onaddstream"in B.RTCPeerConnection.prototype))){Object.defineProperty(B.RTCPeerConnection.prototype,"onaddstream",{get(){return this._onaddstream},set(U){this._onaddstream&&(this.removeEventListener("addstream",this._onaddstream),this.removeEventListener("track",this._onaddstreampoly)),this.addEventListener("addstream",this._onaddstream=U),this.addEventListener("track",this._onaddstreampoly=F=>{F.streams.forEach(V=>{if(this._remoteStreams||(this._remoteStreams=[]),this._remoteStreams.includes(V))return;this._remoteStreams.push(V);const q=new Event("addstream");q.stream=V,this.dispatchEvent(q)})})}});const $=B.RTCPeerConnection.prototype.setRemoteDescription;B.RTCPeerConnection.prototype.setRemoteDescription=function(){const F=this;return this._onaddstreampoly||this.addEventListener("track",this._onaddstreampoly=function(V){V.streams.forEach(q=>{if(F._remoteStreams||(F._remoteStreams=[]),F._remoteStreams.indexOf(q)>=0)return;F._remoteStreams.push(q);const j=new Event("addstream");j.stream=q,F.dispatchEvent(j)})}),$.apply(F,arguments)}}}function shimCallbacksAPI(B){if(typeof B!="object"||!B.RTCPeerConnection)return;const $=B.RTCPeerConnection.prototype,U=$.createOffer,F=$.createAnswer,V=$.setLocalDescription,q=$.setRemoteDescription,j=$.addIceCandidate;$.createOffer=function(G,z){const H=arguments.length>=2?arguments[2]:arguments[0],Q=U.apply(this,[H]);return z?(Q.then(G,z),Promise.resolve()):Q},$.createAnswer=function(G,z){const H=arguments.length>=2?arguments[2]:arguments[0],Q=F.apply(this,[H]);return z?(Q.then(G,z),Promise.resolve()):Q};let W=function(K,G,z){const H=V.apply(this,[K]);return z?(H.then(G,z),Promise.resolve()):H};$.setLocalDescription=W,W=function(K,G,z){const H=q.apply(this,[K]);return z?(H.then(G,z),Promise.resolve()):H},$.setRemoteDescription=W,W=function(K,G,z){const H=j.apply(this,[K]);return z?(H.then(G,z),Promise.resolve()):H},$.addIceCandidate=W}function shimGetUserMedia(B){const $=B&&B.navigator;if($.mediaDevices&&$.mediaDevices.getUserMedia){const U=$.mediaDevices,F=U.getUserMedia.bind(U);$.mediaDevices.getUserMedia=V=>F(shimConstraints(V))}!$.getUserMedia&&$.mediaDevices&&$.mediaDevices.getUserMedia&&($.getUserMedia=function(F,V,q){$.mediaDevices.getUserMedia(F).then(V,q)}.bind($))}function shimConstraints(B){return B&&B.video!==void 0?Object.assign({},B,{video:compactObject(B.video)}):B}function shimRTCIceServerUrls(B){if(!B.RTCPeerConnection)return;const $=B.RTCPeerConnection;B.RTCPeerConnection=function(F,V){if(F&&F.iceServers){const q=[];for(let j=0;j<F.iceServers.length;j++){let W=F.iceServers[j];W.urls===void 0&&W.url?(deprecated("RTCIceServer.url","RTCIceServer.urls"),W=JSON.parse(JSON.stringify(W)),W.urls=W.url,delete W.url,q.push(W)):q.push(F.iceServers[j])}F.iceServers=q}return new $(F,V)},B.RTCPeerConnection.prototype=$.prototype,"generateCertificate"in $&&Object.defineProperty(B.RTCPeerConnection,"generateCertificate",{get(){return $.generateCertificate}})}function shimTrackEventTransceiver(B){typeof B=="object"&&B.RTCTrackEvent&&"receiver"in B.RTCTrackEvent.prototype&&!("transceiver"in B.RTCTrackEvent.prototype)&&Object.defineProperty(B.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function shimCreateOfferLegacy(B){const $=B.RTCPeerConnection.prototype.createOffer;B.RTCPeerConnection.prototype.createOffer=function(F){if(F){typeof F.offerToReceiveAudio<"u"&&(F.offerToReceiveAudio=!!F.offerToReceiveAudio);const V=this.getTransceivers().find(j=>j.receiver.track.kind==="audio");F.offerToReceiveAudio===!1&&V?V.direction==="sendrecv"?V.setDirection?V.setDirection("sendonly"):V.direction="sendonly":V.direction==="recvonly"&&(V.setDirection?V.setDirection("inactive"):V.direction="inactive"):F.offerToReceiveAudio===!0&&!V&&this.addTransceiver("audio",{direction:"recvonly"}),typeof F.offerToReceiveVideo<"u"&&(F.offerToReceiveVideo=!!F.offerToReceiveVideo);const q=this.getTransceivers().find(j=>j.receiver.track.kind==="video");F.offerToReceiveVideo===!1&&q?q.direction==="sendrecv"?q.setDirection?q.setDirection("sendonly"):q.direction="sendonly":q.direction==="recvonly"&&(q.setDirection?q.setDirection("inactive"):q.direction="inactive"):F.offerToReceiveVideo===!0&&!q&&this.addTransceiver("video",{direction:"recvonly"})}return $.apply(this,arguments)}}function shimAudioContext(B){typeof B!="object"||B.AudioContext||(B.AudioContext=B.webkitAudioContext)}var safariShim=Object.freeze({__proto__:null,shimAudioContext,shimCallbacksAPI,shimConstraints,shimCreateOfferLegacy,shimGetUserMedia,shimLocalStreamsAPI,shimRTCIceServerUrls,shimRemoteStreamsAPI,shimTrackEventTransceiver}),sdp$1={exports:{}},hasRequiredSdp;function requireSdp(){return hasRequiredSdp||(hasRequiredSdp=1,(function(B){const $={};$.generateIdentifier=function(){return Math.random().toString(36).substring(2,12)},$.localCName=$.generateIdentifier(),$.splitLines=function(U){return U.trim().split(`
`).map(F=>F.trim())},$.splitSections=function(U){return U.split(`
m=`).map((V,q)=>(q>0?"m="+V:V).trim()+`\r
`)},$.getDescription=function(U){const F=$.splitSections(U);return F&&F[0]},$.getMediaSections=function(U){const F=$.splitSections(U);return F.shift(),F},$.matchPrefix=function(U,F){return $.splitLines(U).filter(V=>V.indexOf(F)===0)},$.parseCandidate=function(U){let F;U.indexOf("a=candidate:")===0?F=U.substring(12).split(" "):F=U.substring(10).split(" ");const V={foundation:F[0],component:{1:"rtp",2:"rtcp"}[F[1]]||F[1],protocol:F[2].toLowerCase(),priority:parseInt(F[3],10),ip:F[4],address:F[4],port:parseInt(F[5],10),type:F[7]};for(let q=8;q<F.length;q+=2)switch(F[q]){case"raddr":V.relatedAddress=F[q+1];break;case"rport":V.relatedPort=parseInt(F[q+1],10);break;case"tcptype":V.tcpType=F[q+1];break;case"ufrag":V.ufrag=F[q+1],V.usernameFragment=F[q+1];break;default:V[F[q]]===void 0&&(V[F[q]]=F[q+1]);break}return V},$.writeCandidate=function(U){const F=[];F.push(U.foundation);const V=U.component;V==="rtp"?F.push(1):V==="rtcp"?F.push(2):F.push(V),F.push(U.protocol.toUpperCase()),F.push(U.priority),F.push(U.address||U.ip),F.push(U.port);const q=U.type;return F.push("typ"),F.push(q),q!=="host"&&U.relatedAddress&&U.relatedPort&&(F.push("raddr"),F.push(U.relatedAddress),F.push("rport"),F.push(U.relatedPort)),U.tcpType&&U.protocol.toLowerCase()==="tcp"&&(F.push("tcptype"),F.push(U.tcpType)),(U.usernameFragment||U.ufrag)&&(F.push("ufrag"),F.push(U.usernameFragment||U.ufrag)),"candidate:"+F.join(" ")},$.parseIceOptions=function(U){return U.substring(14).split(" ")},$.parseRtpMap=function(U){let F=U.substring(9).split(" ");const V={payloadType:parseInt(F.shift(),10)};return F=F[0].split("/"),V.name=F[0],V.clockRate=parseInt(F[1],10),V.channels=F.length===3?parseInt(F[2],10):1,V.numChannels=V.channels,V},$.writeRtpMap=function(U){let F=U.payloadType;U.preferredPayloadType!==void 0&&(F=U.preferredPayloadType);const V=U.channels||U.numChannels||1;return"a=rtpmap:"+F+" "+U.name+"/"+U.clockRate+(V!==1?"/"+V:"")+`\r
`},$.parseExtmap=function(U){const F=U.substring(9).split(" ");return{id:parseInt(F[0],10),direction:F[0].indexOf("/")>0?F[0].split("/")[1]:"sendrecv",uri:F[1],attributes:F.slice(2).join(" ")}},$.writeExtmap=function(U){return"a=extmap:"+(U.id||U.preferredId)+(U.direction&&U.direction!=="sendrecv"?"/"+U.direction:"")+" "+U.uri+(U.attributes?" "+U.attributes:"")+`\r
`},$.parseFmtp=function(U){const F={};let V;const q=U.substring(U.indexOf(" ")+1).split(";");for(let j=0;j<q.length;j++)V=q[j].trim().split("="),F[V[0].trim()]=V[1];return F},$.writeFmtp=function(U){let F="",V=U.payloadType;if(U.preferredPayloadType!==void 0&&(V=U.preferredPayloadType),U.parameters&&Object.keys(U.parameters).length){const q=[];Object.keys(U.parameters).forEach(j=>{U.parameters[j]!==void 0?q.push(j+"="+U.parameters[j]):q.push(j)}),F+="a=fmtp:"+V+" "+q.join(";")+`\r
`}return F},$.parseRtcpFb=function(U){const F=U.substring(U.indexOf(" ")+1).split(" ");return{type:F.shift(),parameter:F.join(" ")}},$.writeRtcpFb=function(U){let F="",V=U.payloadType;return U.preferredPayloadType!==void 0&&(V=U.preferredPayloadType),U.rtcpFeedback&&U.rtcpFeedback.length&&U.rtcpFeedback.forEach(q=>{F+="a=rtcp-fb:"+V+" "+q.type+(q.parameter&&q.parameter.length?" "+q.parameter:"")+`\r
`}),F},$.parseSsrcMedia=function(U){const F=U.indexOf(" "),V={ssrc:parseInt(U.substring(7,F),10)},q=U.indexOf(":",F);return q>-1?(V.attribute=U.substring(F+1,q),V.value=U.substring(q+1)):V.attribute=U.substring(F+1),V},$.parseSsrcGroup=function(U){const F=U.substring(13).split(" ");return{semantics:F.shift(),ssrcs:F.map(V=>parseInt(V,10))}},$.getMid=function(U){const F=$.matchPrefix(U,"a=mid:")[0];if(F)return F.substring(6)},$.parseFingerprint=function(U){const F=U.substring(14).split(" ");return{algorithm:F[0].toLowerCase(),value:F[1].toUpperCase()}},$.getDtlsParameters=function(U,F){return{role:"auto",fingerprints:$.matchPrefix(U+F,"a=fingerprint:").map($.parseFingerprint)}},$.writeDtlsParameters=function(U,F){let V="a=setup:"+F+`\r
`;return U.fingerprints.forEach(q=>{V+="a=fingerprint:"+q.algorithm+" "+q.value+`\r
`}),V},$.parseCryptoLine=function(U){const F=U.substring(9).split(" ");return{tag:parseInt(F[0],10),cryptoSuite:F[1],keyParams:F[2],sessionParams:F.slice(3)}},$.writeCryptoLine=function(U){return"a=crypto:"+U.tag+" "+U.cryptoSuite+" "+(typeof U.keyParams=="object"?$.writeCryptoKeyParams(U.keyParams):U.keyParams)+(U.sessionParams?" "+U.sessionParams.join(" "):"")+`\r
`},$.parseCryptoKeyParams=function(U){if(U.indexOf("inline:")!==0)return null;const F=U.substring(7).split("|");return{keyMethod:"inline",keySalt:F[0],lifeTime:F[1],mkiValue:F[2]?F[2].split(":")[0]:void 0,mkiLength:F[2]?F[2].split(":")[1]:void 0}},$.writeCryptoKeyParams=function(U){return U.keyMethod+":"+U.keySalt+(U.lifeTime?"|"+U.lifeTime:"")+(U.mkiValue&&U.mkiLength?"|"+U.mkiValue+":"+U.mkiLength:"")},$.getCryptoParameters=function(U,F){return $.matchPrefix(U+F,"a=crypto:").map($.parseCryptoLine)},$.getIceParameters=function(U,F){const V=$.matchPrefix(U+F,"a=ice-ufrag:")[0],q=$.matchPrefix(U+F,"a=ice-pwd:")[0];return V&&q?{usernameFragment:V.substring(12),password:q.substring(10)}:null},$.writeIceParameters=function(U){let F="a=ice-ufrag:"+U.usernameFragment+`\r
a=ice-pwd:`+U.password+`\r
`;return U.iceLite&&(F+=`a=ice-lite\r
`),F},$.parseRtpParameters=function(U){const F={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},q=$.splitLines(U)[0].split(" ");F.profile=q[2];for(let W=3;W<q.length;W++){const K=q[W],G=$.matchPrefix(U,"a=rtpmap:"+K+" ")[0];if(G){const z=$.parseRtpMap(G),H=$.matchPrefix(U,"a=fmtp:"+K+" ");switch(z.parameters=H.length?$.parseFmtp(H[0]):{},z.rtcpFeedback=$.matchPrefix(U,"a=rtcp-fb:"+K+" ").map($.parseRtcpFb),F.codecs.push(z),z.name.toUpperCase()){case"RED":case"ULPFEC":F.fecMechanisms.push(z.name.toUpperCase());break}}}$.matchPrefix(U,"a=extmap:").forEach(W=>{F.headerExtensions.push($.parseExtmap(W))});const j=$.matchPrefix(U,"a=rtcp-fb:* ").map($.parseRtcpFb);return F.codecs.forEach(W=>{j.forEach(K=>{W.rtcpFeedback.find(z=>z.type===K.type&&z.parameter===K.parameter)||W.rtcpFeedback.push(K)})}),F},$.writeRtpDescription=function(U,F){let V="";V+="m="+U+" ",V+=F.codecs.length>0?"9":"0",V+=" "+(F.profile||"UDP/TLS/RTP/SAVPF")+" ",V+=F.codecs.map(j=>j.preferredPayloadType!==void 0?j.preferredPayloadType:j.payloadType).join(" ")+`\r
`,V+=`c=IN IP4 0.0.0.0\r
`,V+=`a=rtcp:9 IN IP4 0.0.0.0\r
`,F.codecs.forEach(j=>{V+=$.writeRtpMap(j),V+=$.writeFmtp(j),V+=$.writeRtcpFb(j)});let q=0;return F.codecs.forEach(j=>{j.maxptime>q&&(q=j.maxptime)}),q>0&&(V+="a=maxptime:"+q+`\r
`),F.headerExtensions&&F.headerExtensions.forEach(j=>{V+=$.writeExtmap(j)}),V},$.parseRtpEncodingParameters=function(U){const F=[],V=$.parseRtpParameters(U),q=V.fecMechanisms.indexOf("RED")!==-1,j=V.fecMechanisms.indexOf("ULPFEC")!==-1,W=$.matchPrefix(U,"a=ssrc:").map(Q=>$.parseSsrcMedia(Q)).filter(Q=>Q.attribute==="cname"),K=W.length>0&&W[0].ssrc;let G;const z=$.matchPrefix(U,"a=ssrc-group:FID").map(Q=>Q.substring(17).split(" ").map(X=>parseInt(X,10)));z.length>0&&z[0].length>1&&z[0][0]===K&&(G=z[0][1]),V.codecs.forEach(Q=>{if(Q.name.toUpperCase()==="RTX"&&Q.parameters.apt){let Y={ssrc:K,codecPayloadType:parseInt(Q.parameters.apt,10)};K&&G&&(Y.rtx={ssrc:G}),F.push(Y),q&&(Y=JSON.parse(JSON.stringify(Y)),Y.fec={ssrc:K,mechanism:j?"red+ulpfec":"red"},F.push(Y))}}),F.length===0&&K&&F.push({ssrc:K});let H=$.matchPrefix(U,"b=");return H.length&&(H[0].indexOf("b=TIAS:")===0?H=parseInt(H[0].substring(7),10):H[0].indexOf("b=AS:")===0?H=parseInt(H[0].substring(5),10)*1e3*.95-2e3*8:H=void 0,F.forEach(Q=>{Q.maxBitrate=H})),F},$.parseRtcpParameters=function(U){const F={},V=$.matchPrefix(U,"a=ssrc:").map(W=>$.parseSsrcMedia(W)).filter(W=>W.attribute==="cname")[0];V&&(F.cname=V.value,F.ssrc=V.ssrc);const q=$.matchPrefix(U,"a=rtcp-rsize");F.reducedSize=q.length>0,F.compound=q.length===0;const j=$.matchPrefix(U,"a=rtcp-mux");return F.mux=j.length>0,F},$.writeRtcpParameters=function(U){let F="";return U.reducedSize&&(F+=`a=rtcp-rsize\r
`),U.mux&&(F+=`a=rtcp-mux\r
`),U.ssrc!==void 0&&U.cname&&(F+="a=ssrc:"+U.ssrc+" cname:"+U.cname+`\r
`),F},$.parseMsid=function(U){let F;const V=$.matchPrefix(U,"a=msid:");if(V.length===1)return F=V[0].substring(7).split(" "),{stream:F[0],track:F[1]};const q=$.matchPrefix(U,"a=ssrc:").map(j=>$.parseSsrcMedia(j)).filter(j=>j.attribute==="msid");if(q.length>0)return F=q[0].value.split(" "),{stream:F[0],track:F[1]}},$.parseSctpDescription=function(U){const F=$.parseMLine(U),V=$.matchPrefix(U,"a=max-message-size:");let q;V.length>0&&(q=parseInt(V[0].substring(19),10)),isNaN(q)&&(q=65536);const j=$.matchPrefix(U,"a=sctp-port:");if(j.length>0)return{port:parseInt(j[0].substring(12),10),protocol:F.fmt,maxMessageSize:q};const W=$.matchPrefix(U,"a=sctpmap:");if(W.length>0){const K=W[0].substring(10).split(" ");return{port:parseInt(K[0],10),protocol:K[1],maxMessageSize:q}}},$.writeSctpDescription=function(U,F){let V=[];return U.protocol!=="DTLS/SCTP"?V=["m="+U.kind+" 9 "+U.protocol+" "+F.protocol+`\r
`,`c=IN IP4 0.0.0.0\r
`,"a=sctp-port:"+F.port+`\r
`]:V=["m="+U.kind+" 9 "+U.protocol+" "+F.port+`\r
`,`c=IN IP4 0.0.0.0\r
`,"a=sctpmap:"+F.port+" "+F.protocol+` 65535\r
`],F.maxMessageSize!==void 0&&V.push("a=max-message-size:"+F.maxMessageSize+`\r
`),V.join("")},$.generateSessionId=function(){return Math.random().toString().substr(2,22)},$.writeSessionBoilerplate=function(U,F,V){let q;const j=F!==void 0?F:2;return U?q=U:q=$.generateSessionId(),`v=0\r
o=`+(V||"thisisadapterortc")+" "+q+" "+j+` IN IP4 127.0.0.1\r
s=-\r
t=0 0\r
`},$.getDirection=function(U,F){const V=$.splitLines(U);for(let q=0;q<V.length;q++)switch(V[q]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return V[q].substring(2)}return F?$.getDirection(F):"sendrecv"},$.getKind=function(U){return $.splitLines(U)[0].split(" ")[0].substring(2)},$.isRejected=function(U){return U.split(" ",2)[1]==="0"},$.parseMLine=function(U){const V=$.splitLines(U)[0].substring(2).split(" ");return{kind:V[0],port:parseInt(V[1],10),protocol:V[2],fmt:V.slice(3).join(" ")}},$.parseOLine=function(U){const V=$.matchPrefix(U,"o=")[0].substring(2).split(" ");return{username:V[0],sessionId:V[1],sessionVersion:parseInt(V[2],10),netType:V[3],addressType:V[4],address:V[5]}},$.isValidSDP=function(U){if(typeof U!="string"||U.length===0)return!1;const F=$.splitLines(U);for(let V=0;V<F.length;V++)if(F[V].length<2||F[V].charAt(1)!=="=")return!1;return!0},B.exports=$})(sdp$1)),sdp$1.exports}var sdpExports=requireSdp(),SDPUtils=getDefaultExportFromCjs(sdpExports),sdp=_mergeNamespaces$1({__proto__:null,default:SDPUtils},[sdpExports]);function shimRTCIceCandidate(B){if(!B.RTCIceCandidate||B.RTCIceCandidate&&"foundation"in B.RTCIceCandidate.prototype)return;const $=B.RTCIceCandidate;B.RTCIceCandidate=function(F){if(typeof F=="object"&&F.candidate&&F.candidate.indexOf("a=")===0&&(F=JSON.parse(JSON.stringify(F)),F.candidate=F.candidate.substring(2)),F.candidate&&F.candidate.length){const V=new $(F),q=SDPUtils.parseCandidate(F.candidate);for(const j in q)j in V||Object.defineProperty(V,j,{value:q[j]});return V.toJSON=function(){return{candidate:V.candidate,sdpMid:V.sdpMid,sdpMLineIndex:V.sdpMLineIndex,usernameFragment:V.usernameFragment}},V}return new $(F)},B.RTCIceCandidate.prototype=$.prototype,wrapPeerConnectionEvent(B,"icecandidate",U=>(U.candidate&&Object.defineProperty(U,"candidate",{value:new B.RTCIceCandidate(U.candidate),writable:"false"}),U))}function shimRTCIceCandidateRelayProtocol(B){!B.RTCIceCandidate||B.RTCIceCandidate&&"relayProtocol"in B.RTCIceCandidate.prototype||wrapPeerConnectionEvent(B,"icecandidate",$=>{if($.candidate){const U=SDPUtils.parseCandidate($.candidate.candidate);U.type==="relay"&&($.candidate.relayProtocol={0:"tls",1:"tcp",2:"udp"}[U.priority>>24])}return $})}function shimMaxMessageSize(B,$){if(!B.RTCPeerConnection)return;"sctp"in B.RTCPeerConnection.prototype||Object.defineProperty(B.RTCPeerConnection.prototype,"sctp",{get(){return typeof this._sctp>"u"?null:this._sctp}});const U=function(W){if(!W||!W.sdp)return!1;const K=SDPUtils.splitSections(W.sdp);return K.shift(),K.some(G=>{const z=SDPUtils.parseMLine(G);return z&&z.kind==="application"&&z.protocol.indexOf("SCTP")!==-1})},F=function(W){const K=W.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(K===null||K.length<2)return-1;const G=parseInt(K[1],10);return G!==G?-1:G},V=function(W){let K=65536;return $.browser==="firefox"&&($.version<57?W===-1?K=16384:K=2147483637:$.version<60?K=$.version===57?65535:65536:K=2147483637),K},q=function(W,K){let G=65536;$.browser==="firefox"&&$.version===57&&(G=65535);const z=SDPUtils.matchPrefix(W.sdp,"a=max-message-size:");return z.length>0?G=parseInt(z[0].substring(19),10):$.browser==="firefox"&&K!==-1&&(G=2147483637),G},j=B.RTCPeerConnection.prototype.setRemoteDescription;B.RTCPeerConnection.prototype.setRemoteDescription=function(){if(this._sctp=null,$.browser==="chrome"&&$.version>=76){const{sdpSemantics:K}=this.getConfiguration();K==="plan-b"&&Object.defineProperty(this,"sctp",{get(){return typeof this._sctp>"u"?null:this._sctp},enumerable:!0,configurable:!0})}if(U(arguments[0])){const K=F(arguments[0]),G=V(K),z=q(arguments[0],K);let H;G===0&&z===0?H=Number.POSITIVE_INFINITY:G===0||z===0?H=Math.max(G,z):H=Math.min(G,z);const Q={};Object.defineProperty(Q,"maxMessageSize",{get(){return H}}),this._sctp=Q}return j.apply(this,arguments)}}function shimSendThrowTypeError(B){if(!(B.RTCPeerConnection&&"createDataChannel"in B.RTCPeerConnection.prototype))return;function $(F,V){const q=F.send;F.send=function(){const W=arguments[0],K=W.length||W.size||W.byteLength;if(F.readyState==="open"&&V.sctp&&K>V.sctp.maxMessageSize)throw new TypeError("Message too large (can send a maximum of "+V.sctp.maxMessageSize+" bytes)");return q.apply(F,arguments)}}const U=B.RTCPeerConnection.prototype.createDataChannel;B.RTCPeerConnection.prototype.createDataChannel=function(){const V=U.apply(this,arguments);return $(V,this),V},wrapPeerConnectionEvent(B,"datachannel",F=>($(F.channel,F.target),F))}function shimConnectionState(B){if(!B.RTCPeerConnection||"connectionState"in B.RTCPeerConnection.prototype)return;const $=B.RTCPeerConnection.prototype;Object.defineProperty($,"connectionState",{get(){return{completed:"connected",checking:"connecting"}[this.iceConnectionState]||this.iceConnectionState},enumerable:!0,configurable:!0}),Object.defineProperty($,"onconnectionstatechange",{get(){return this._onconnectionstatechange||null},set(U){this._onconnectionstatechange&&(this.removeEventListener("connectionstatechange",this._onconnectionstatechange),delete this._onconnectionstatechange),U&&this.addEventListener("connectionstatechange",this._onconnectionstatechange=U)},enumerable:!0,configurable:!0}),["setLocalDescription","setRemoteDescription"].forEach(U=>{const F=$[U];$[U]=function(){return this._connectionstatechangepoly||(this._connectionstatechangepoly=V=>{const q=V.target;if(q._lastConnectionState!==q.connectionState){q._lastConnectionState=q.connectionState;const j=new Event("connectionstatechange",V);q.dispatchEvent(j)}return V},this.addEventListener("iceconnectionstatechange",this._connectionstatechangepoly)),F.apply(this,arguments)}})}function removeExtmapAllowMixed(B,$){if(!B.RTCPeerConnection||$.browser==="chrome"&&$.version>=71||$.browser==="safari"&&$._safariVersion>=13.1)return;const U=B.RTCPeerConnection.prototype.setRemoteDescription;B.RTCPeerConnection.prototype.setRemoteDescription=function(V){if(V&&V.sdp&&V.sdp.indexOf(`
a=extmap-allow-mixed`)!==-1){const q=V.sdp.split(`
`).filter(j=>j.trim()!=="a=extmap-allow-mixed").join(`
`);B.RTCSessionDescription&&V instanceof B.RTCSessionDescription?arguments[0]=new B.RTCSessionDescription({type:V.type,sdp:q}):V.sdp=q}return U.apply(this,arguments)}}function shimAddIceCandidateNullOrEmpty(B,$){if(!(B.RTCPeerConnection&&B.RTCPeerConnection.prototype))return;const U=B.RTCPeerConnection.prototype.addIceCandidate;!U||U.length===0||(B.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?($.browser==="chrome"&&$.version<78||$.browser==="firefox"&&$.version<68||$.browser==="safari")&&arguments[0]&&arguments[0].candidate===""?Promise.resolve():U.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())})}function shimParameterlessSetLocalDescription(B,$){if(!(B.RTCPeerConnection&&B.RTCPeerConnection.prototype))return;const U=B.RTCPeerConnection.prototype.setLocalDescription;!U||U.length===0||(B.RTCPeerConnection.prototype.setLocalDescription=function(){let V=arguments[0]||{};if(typeof V!="object"||V.type&&V.sdp)return U.apply(this,arguments);if(V={type:V.type,sdp:V.sdp},!V.type)switch(this.signalingState){case"stable":case"have-local-offer":case"have-remote-pranswer":V.type="offer";break;default:V.type="answer";break}return V.sdp||V.type!=="offer"&&V.type!=="answer"?U.apply(this,[V]):(V.type==="offer"?this.createOffer:this.createAnswer).apply(this).then(j=>U.apply(this,[j]))})}var commonShim=Object.freeze({__proto__:null,removeExtmapAllowMixed,shimAddIceCandidateNullOrEmpty,shimConnectionState,shimMaxMessageSize,shimParameterlessSetLocalDescription,shimRTCIceCandidate,shimRTCIceCandidateRelayProtocol,shimSendThrowTypeError});function adapterFactory(){let{window:B}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},$=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{shimChrome:!0,shimFirefox:!0,shimSafari:!0};const U=log,F=detectBrowser(B),V={browserDetails:F,commonShim,extractVersion,disableLog,disableWarnings,sdp};switch(F.browser){case"chrome":if(!chromeShim||!shimPeerConnection$1||!$.shimChrome)return U("Chrome shim is not included in this adapter release."),V;if(F.version===null)return U("Chrome shim can not determine version, not shimming."),V;U("adapter.js shimming chrome."),V.browserShim=chromeShim,shimAddIceCandidateNullOrEmpty(B,F),shimParameterlessSetLocalDescription(B),shimGetUserMedia$2(B,F),shimMediaStream(B),shimPeerConnection$1(B,F),shimOnTrack$1(B),shimAddTrackRemoveTrack(B,F),shimGetSendersWithDtmf(B),shimSenderReceiverGetStats(B),fixNegotiationNeeded(B,F),shimRTCIceCandidate(B),shimRTCIceCandidateRelayProtocol(B),shimConnectionState(B),shimMaxMessageSize(B,F),shimSendThrowTypeError(B),removeExtmapAllowMixed(B,F);break;case"firefox":if(!firefoxShim||!shimPeerConnection||!$.shimFirefox)return U("Firefox shim is not included in this adapter release."),V;U("adapter.js shimming firefox."),V.browserShim=firefoxShim,shimAddIceCandidateNullOrEmpty(B,F),shimParameterlessSetLocalDescription(B),shimGetUserMedia$1(B,F),shimPeerConnection(B,F),shimOnTrack(B),shimRemoveStream(B),shimSenderGetStats(B),shimReceiverGetStats(B),shimRTCDataChannel(B),shimAddTransceiver(B),shimGetParameters(B),shimCreateOffer(B),shimCreateAnswer(B),shimRTCIceCandidate(B),shimConnectionState(B),shimMaxMessageSize(B,F),shimSendThrowTypeError(B);break;case"safari":if(!safariShim||!$.shimSafari)return U("Safari shim is not included in this adapter release."),V;U("adapter.js shimming safari."),V.browserShim=safariShim,shimAddIceCandidateNullOrEmpty(B,F),shimParameterlessSetLocalDescription(B),shimRTCIceServerUrls(B),shimCreateOfferLegacy(B),shimCallbacksAPI(B),shimLocalStreamsAPI(B),shimRemoteStreamsAPI(B),shimTrackEventTransceiver(B),shimGetUserMedia(B),shimAudioContext(B),shimRTCIceCandidate(B),shimRTCIceCandidateRelayProtocol(B),shimMaxMessageSize(B,F),shimSendThrowTypeError(B),removeExtmapAllowMixed(B,F);break;default:U("Unsupported browser!");break}return V}adapterFactory({window:typeof window>"u"?void 0:window});const DECRYPTION_FAILURE_TOLERANCE=10,E2EE_FLAG="lk_e2ee",SALT="LKFrameEncryptionKey",KEY_PROVIDER_DEFAULTS={sharedKey:!1,ratchetSalt:SALT,ratchetWindowSize:8,failureTolerance:DECRYPTION_FAILURE_TOLERANCE,keyringSize:16};var KeyProviderEvent;(function(B){B.SetKey="setKey",B.RatchetRequest="ratchetRequest",B.KeyRatcheted="keyRatcheted"})(KeyProviderEvent||(KeyProviderEvent={}));var KeyHandlerEvent;(function(B){B.KeyRatcheted="keyRatcheted"})(KeyHandlerEvent||(KeyHandlerEvent={}));var EncryptionEvent;(function(B){B.ParticipantEncryptionStatusChanged="participantEncryptionStatusChanged",B.EncryptionError="encryptionError"})(EncryptionEvent||(EncryptionEvent={}));var CryptorEvent;(function(B){B.Error="cryptorError"})(CryptorEvent||(CryptorEvent={}));function isE2EESupported(){return isInsertableStreamSupported()||isScriptTransformSupported()}function isScriptTransformSupported(){return typeof window.RTCRtpScriptTransform<"u"}function isInsertableStreamSupported(){return typeof window.RTCRtpSender<"u"&&typeof window.RTCRtpSender.prototype.createEncodedStreams<"u"}class BaseKeyProvider extends eventsExports.EventEmitter{constructor(){let $=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};super(),this.onKeyRatcheted=(U,F,V)=>{livekitLogger.debug("key ratcheted event received",{ratchetResult:U,participantId:F,keyIndex:V})},this.keyInfoMap=new Map,this.options=Object.assign(Object.assign({},KEY_PROVIDER_DEFAULTS),$),this.on(KeyProviderEvent.KeyRatcheted,this.onKeyRatcheted)}onSetEncryptionKey($,U,F){const V={key:$,participantIdentity:U,keyIndex:F};if(!this.options.sharedKey&&!U)throw new Error("participant identity needs to be passed for encryption key if sharedKey option is false");this.keyInfoMap.set("".concat(U??"shared","-").concat(F??0),V),this.emit(KeyProviderEvent.SetKey,V)}getKeys(){return Array.from(this.keyInfoMap.values())}getOptions(){return this.options}ratchetKey($,U){this.emit(KeyProviderEvent.RatchetRequest,$,U)}}class LivekitError extends Error{constructor($,U){super(U||"an error has occured"),this.name="LiveKitError",this.code=$}}var ConnectionErrorReason;(function(B){B[B.NotAllowed=0]="NotAllowed",B[B.ServerUnreachable=1]="ServerUnreachable",B[B.InternalError=2]="InternalError",B[B.Cancelled=3]="Cancelled",B[B.LeaveRequest=4]="LeaveRequest",B[B.Timeout=5]="Timeout"})(ConnectionErrorReason||(ConnectionErrorReason={}));class ConnectionError extends LivekitError{constructor($,U,F,V){super(1,$),this.name="ConnectionError",this.status=F,this.reason=U,this.context=V,this.reasonName=ConnectionErrorReason[U]}}class DeviceUnsupportedError extends LivekitError{constructor($){super(21,$??"device is unsupported"),this.name="DeviceUnsupportedError"}}class TrackInvalidError extends LivekitError{constructor($){super(20,$??"track is invalid"),this.name="TrackInvalidError"}}class UnsupportedServer extends LivekitError{constructor($){super(10,$??"unsupported server"),this.name="UnsupportedServer"}}class UnexpectedConnectionState extends LivekitError{constructor($){super(12,$??"unexpected connection state"),this.name="UnexpectedConnectionState"}}class NegotiationError extends LivekitError{constructor($){super(13,$??"unable to negotiate"),this.name="NegotiationError"}}class PublishTrackError extends LivekitError{constructor($,U){super(15,$),this.name="PublishTrackError",this.status=U}}class SignalRequestError extends LivekitError{constructor($,U){super(15,$),this.reason=U,this.reasonName=typeof U=="string"?U:RequestResponse_Reason[U]}}var DataStreamErrorReason;(function(B){B[B.AlreadyOpened=0]="AlreadyOpened",B[B.AbnormalEnd=1]="AbnormalEnd",B[B.DecodeFailed=2]="DecodeFailed",B[B.LengthExceeded=3]="LengthExceeded",B[B.Incomplete=4]="Incomplete",B[B.HandlerAlreadyRegistered=7]="HandlerAlreadyRegistered"})(DataStreamErrorReason||(DataStreamErrorReason={}));class DataStreamError extends LivekitError{constructor($,U){super(16,$),this.name="DataStreamError",this.reason=U,this.reasonName=DataStreamErrorReason[U]}}var MediaDeviceFailure;(function(B){B.PermissionDenied="PermissionDenied",B.NotFound="NotFound",B.DeviceInUse="DeviceInUse",B.Other="Other"})(MediaDeviceFailure||(MediaDeviceFailure={})),(function(B){function $(U){if(U&&"name"in U)return U.name==="NotFoundError"||U.name==="DevicesNotFoundError"?B.NotFound:U.name==="NotAllowedError"||U.name==="PermissionDeniedError"?B.PermissionDenied:U.name==="NotReadableError"||U.name==="TrackStartError"?B.DeviceInUse:B.Other}B.getFailure=$})(MediaDeviceFailure||(MediaDeviceFailure={}));var CryptorErrorReason;(function(B){B[B.InvalidKey=0]="InvalidKey",B[B.MissingKey=1]="MissingKey",B[B.InternalError=2]="InternalError"})(CryptorErrorReason||(CryptorErrorReason={}));var RoomEvent;(function(B){B.Connected="connected",B.Reconnecting="reconnecting",B.SignalReconnecting="signalReconnecting",B.Reconnected="reconnected",B.Disconnected="disconnected",B.ConnectionStateChanged="connectionStateChanged",B.Moved="moved",B.MediaDevicesChanged="mediaDevicesChanged",B.ParticipantConnected="participantConnected",B.ParticipantDisconnected="participantDisconnected",B.TrackPublished="trackPublished",B.TrackSubscribed="trackSubscribed",B.TrackSubscriptionFailed="trackSubscriptionFailed",B.TrackUnpublished="trackUnpublished",B.TrackUnsubscribed="trackUnsubscribed",B.TrackMuted="trackMuted",B.TrackUnmuted="trackUnmuted",B.LocalTrackPublished="localTrackPublished",B.LocalTrackUnpublished="localTrackUnpublished",B.LocalAudioSilenceDetected="localAudioSilenceDetected",B.ActiveSpeakersChanged="activeSpeakersChanged",B.ParticipantMetadataChanged="participantMetadataChanged",B.ParticipantNameChanged="participantNameChanged",B.ParticipantAttributesChanged="participantAttributesChanged",B.ParticipantActive="participantActive",B.RoomMetadataChanged="roomMetadataChanged",B.DataReceived="dataReceived",B.SipDTMFReceived="sipDTMFReceived",B.TranscriptionReceived="transcriptionReceived",B.ConnectionQualityChanged="connectionQualityChanged",B.TrackStreamStateChanged="trackStreamStateChanged",B.TrackSubscriptionPermissionChanged="trackSubscriptionPermissionChanged",B.TrackSubscriptionStatusChanged="trackSubscriptionStatusChanged",B.AudioPlaybackStatusChanged="audioPlaybackChanged",B.VideoPlaybackStatusChanged="videoPlaybackChanged",B.MediaDevicesError="mediaDevicesError",B.ParticipantPermissionsChanged="participantPermissionsChanged",B.SignalConnected="signalConnected",B.RecordingStatusChanged="recordingStatusChanged",B.ParticipantEncryptionStatusChanged="participantEncryptionStatusChanged",B.EncryptionError="encryptionError",B.DCBufferStatusChanged="dcBufferStatusChanged",B.ActiveDeviceChanged="activeDeviceChanged",B.ChatMessage="chatMessage",B.LocalTrackSubscribed="localTrackSubscribed",B.MetricsReceived="metricsReceived"})(RoomEvent||(RoomEvent={}));var ParticipantEvent;(function(B){B.TrackPublished="trackPublished",B.TrackSubscribed="trackSubscribed",B.TrackSubscriptionFailed="trackSubscriptionFailed",B.TrackUnpublished="trackUnpublished",B.TrackUnsubscribed="trackUnsubscribed",B.TrackMuted="trackMuted",B.TrackUnmuted="trackUnmuted",B.LocalTrackPublished="localTrackPublished",B.LocalTrackUnpublished="localTrackUnpublished",B.LocalTrackCpuConstrained="localTrackCpuConstrained",B.LocalSenderCreated="localSenderCreated",B.ParticipantMetadataChanged="participantMetadataChanged",B.ParticipantNameChanged="participantNameChanged",B.DataReceived="dataReceived",B.SipDTMFReceived="sipDTMFReceived",B.TranscriptionReceived="transcriptionReceived",B.IsSpeakingChanged="isSpeakingChanged",B.ConnectionQualityChanged="connectionQualityChanged",B.TrackStreamStateChanged="trackStreamStateChanged",B.TrackSubscriptionPermissionChanged="trackSubscriptionPermissionChanged",B.TrackSubscriptionStatusChanged="trackSubscriptionStatusChanged",B.TrackCpuConstrained="trackCpuConstrained",B.MediaDevicesError="mediaDevicesError",B.AudioStreamAcquired="audioStreamAcquired",B.ParticipantPermissionsChanged="participantPermissionsChanged",B.PCTrackAdded="pcTrackAdded",B.AttributesChanged="attributesChanged",B.LocalTrackSubscribed="localTrackSubscribed",B.ChatMessage="chatMessage",B.Active="active"})(ParticipantEvent||(ParticipantEvent={}));var EngineEvent;(function(B){B.TransportsCreated="transportsCreated",B.Connected="connected",B.Disconnected="disconnected",B.Resuming="resuming",B.Resumed="resumed",B.Restarting="restarting",B.Restarted="restarted",B.SignalResumed="signalResumed",B.SignalRestarted="signalRestarted",B.Closing="closing",B.MediaTrackAdded="mediaTrackAdded",B.ActiveSpeakersUpdate="activeSpeakersUpdate",B.DataPacketReceived="dataPacketReceived",B.RTPVideoMapUpdate="rtpVideoMapUpdate",B.DCBufferStatusChanged="dcBufferStatusChanged",B.ParticipantUpdate="participantUpdate",B.RoomUpdate="roomUpdate",B.SpeakersChanged="speakersChanged",B.StreamStateChanged="streamStateChanged",B.ConnectionQualityUpdate="connectionQualityUpdate",B.SubscriptionError="subscriptionError",B.SubscriptionPermissionUpdate="subscriptionPermissionUpdate",B.RemoteMute="remoteMute",B.SubscribedQualityUpdate="subscribedQualityUpdate",B.LocalTrackUnpublished="localTrackUnpublished",B.LocalTrackSubscribed="localTrackSubscribed",B.Offline="offline",B.SignalRequestResponse="signalRequestResponse",B.SignalConnected="signalConnected",B.RoomMoved="roomMoved"})(EngineEvent||(EngineEvent={}));var TrackEvent;(function(B){B.Message="message",B.Muted="muted",B.Unmuted="unmuted",B.Restarted="restarted",B.Ended="ended",B.Subscribed="subscribed",B.Unsubscribed="unsubscribed",B.CpuConstrained="cpuConstrained",B.UpdateSettings="updateSettings",B.UpdateSubscription="updateSubscription",B.AudioPlaybackStarted="audioPlaybackStarted",B.AudioPlaybackFailed="audioPlaybackFailed",B.AudioSilenceDetected="audioSilenceDetected",B.VisibilityChanged="visibilityChanged",B.VideoDimensionsChanged="videoDimensionsChanged",B.VideoPlaybackStarted="videoPlaybackStarted",B.VideoPlaybackFailed="videoPlaybackFailed",B.ElementAttached="elementAttached",B.ElementDetached="elementDetached",B.UpstreamPaused="upstreamPaused",B.UpstreamResumed="upstreamResumed",B.SubscriptionPermissionChanged="subscriptionPermissionChanged",B.SubscriptionStatusChanged="subscriptionStatusChanged",B.SubscriptionFailed="subscriptionFailed",B.TrackProcessorUpdate="trackProcessorUpdate",B.AudioTrackFeatureUpdate="audioTrackFeatureUpdate",B.TranscriptionReceived="transcriptionReceived",B.TimeSyncUpdate="timeSyncUpdate",B.PreConnectBufferFlushed="preConnectBufferFlushed"})(TrackEvent||(TrackEvent={}));function cloneDeep(B){return typeof B>"u"?B:typeof structuredClone=="function"?typeof B=="object"&&B!==null?structuredClone(Object.assign({},B)):structuredClone(B):JSON.parse(JSON.stringify(B))}const commonVersionIdentifier=/version\/(\d+(\.?_?\d+)+)/i;let browserDetails;function getBrowser(B){let $=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0;if(typeof navigator>"u")return;const U=navigator.userAgent.toLowerCase();if(browserDetails===void 0||$){const F=browsersList.find(V=>{let{test:q}=V;return q.test(U)});browserDetails=F?.describe(U)}return browserDetails}const browsersList=[{test:/firefox|iceweasel|fxios/i,describe(B){return{name:"Firefox",version:getMatch(/(?:firefox|iceweasel|fxios)[\s/](\d+(\.?_?\d+)+)/i,B),os:B.toLowerCase().includes("fxios")?"iOS":void 0,osVersion:getOSVersion(B)}}},{test:/chrom|crios|crmo/i,describe(B){return{name:"Chrome",version:getMatch(/(?:chrome|chromium|crios|crmo)\/(\d+(\.?_?\d+)+)/i,B),os:B.toLowerCase().includes("crios")?"iOS":void 0,osVersion:getOSVersion(B)}}},{test:/safari|applewebkit/i,describe(B){return{name:"Safari",version:getMatch(commonVersionIdentifier,B),os:B.includes("mobile/")?"iOS":"macOS",osVersion:getOSVersion(B)}}}];function getMatch(B,$){let U=arguments.length>2&&arguments[2]!==void 0?arguments[2]:1;const F=$.match(B);return F&&F.length>=U&&F[U]||""}function getOSVersion(B){return B.includes("mac os")?getMatch(/\(.+?(\d+_\d+(:?_\d+)?)/,B,1).replace(/_/g,"."):void 0}var version$1="2.15.7";const version=version$1,protocolVersion=16;class CriticalTimers{}CriticalTimers.setTimeout=function(){return setTimeout(...arguments)},CriticalTimers.setInterval=function(){return setInterval(...arguments)},CriticalTimers.clearTimeout=function(){return clearTimeout(...arguments)},CriticalTimers.clearInterval=function(){return clearInterval(...arguments)};const BACKGROUND_REACTION_DELAY=5e3,recycledElements=[];var VideoQuality;(function(B){B[B.LOW=0]="LOW",B[B.MEDIUM=1]="MEDIUM",B[B.HIGH=2]="HIGH"})(VideoQuality||(VideoQuality={}));class Track extends eventsExports.EventEmitter{get streamState(){return this._streamState}setStreamState($){this._streamState=$}constructor($,U){let F=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};var V;super(),this.attachedElements=[],this.isMuted=!1,this._streamState=Track.StreamState.Active,this.isInBackground=!1,this._currentBitrate=0,this.log=livekitLogger,this.appVisibilityChangedListener=()=>{this.backgroundTimeout&&clearTimeout(this.backgroundTimeout),document.visibilityState==="hidden"?this.backgroundTimeout=setTimeout(()=>this.handleAppVisibilityChanged(),BACKGROUND_REACTION_DELAY):this.handleAppVisibilityChanged()},this.log=getLogger((V=F.loggerName)!==null&&V!==void 0?V:LoggerNames.Track),this.loggerContextCb=F.loggerContextCb,this.setMaxListeners(100),this.kind=U,this._mediaStreamTrack=$,this._mediaStreamID=$.id,this.source=Track.Source.Unknown}get logContext(){var $;return Object.assign(Object.assign({},($=this.loggerContextCb)===null||$===void 0?void 0:$.call(this)),getLogContextFromTrack(this))}get currentBitrate(){return this._currentBitrate}get mediaStreamTrack(){return this._mediaStreamTrack}get mediaStreamID(){return this._mediaStreamID}attach($){let U="audio";this.kind===Track.Kind.Video&&(U="video"),this.attachedElements.length===0&&this.kind===Track.Kind.Video&&this.addAppVisibilityListener(),$||(U==="audio"&&(recycledElements.forEach(q=>{q.parentElement===null&&!$&&($=q)}),$&&recycledElements.splice(recycledElements.indexOf($),1)),$||($=document.createElement(U))),this.attachedElements.includes($)||this.attachedElements.push($),attachToElement(this.mediaStreamTrack,$);const F=$.srcObject.getTracks(),V=F.some(q=>q.kind==="audio");return $.play().then(()=>{this.emit(V?TrackEvent.AudioPlaybackStarted:TrackEvent.VideoPlaybackStarted)}).catch(q=>{q.name==="NotAllowedError"?this.emit(V?TrackEvent.AudioPlaybackFailed:TrackEvent.VideoPlaybackFailed,q):q.name==="AbortError"?livekitLogger.debug("".concat(V?"audio":"video"," playback aborted, likely due to new play request")):livekitLogger.warn("could not playback ".concat(V?"audio":"video"),q),V&&$&&F.some(j=>j.kind==="video")&&q.name==="NotAllowedError"&&($.muted=!0,$.play().catch(()=>{}))}),this.emit(TrackEvent.ElementAttached,$),$}detach($){try{if($){detachTrack(this.mediaStreamTrack,$);const F=this.attachedElements.indexOf($);return F>=0&&(this.attachedElements.splice(F,1),this.recycleElement($),this.emit(TrackEvent.ElementDetached,$)),$}const U=[];return this.attachedElements.forEach(F=>{detachTrack(this.mediaStreamTrack,F),U.push(F),this.recycleElement(F),this.emit(TrackEvent.ElementDetached,F)}),this.attachedElements=[],U}finally{this.attachedElements.length===0&&this.removeAppVisibilityListener()}}stop(){this.stopMonitor(),this._mediaStreamTrack.stop()}enable(){this._mediaStreamTrack.enabled=!0}disable(){this._mediaStreamTrack.enabled=!1}stopMonitor(){this.monitorInterval&&clearInterval(this.monitorInterval),this.timeSyncHandle&&cancelAnimationFrame(this.timeSyncHandle)}updateLoggerOptions($){$.loggerName&&(this.log=getLogger($.loggerName)),$.loggerContextCb&&(this.loggerContextCb=$.loggerContextCb)}recycleElement($){if($ instanceof HTMLAudioElement){let U=!0;$.pause(),recycledElements.forEach(F=>{F.parentElement||(U=!1)}),U&&recycledElements.push($)}}handleAppVisibilityChanged(){return __awaiter(this,void 0,void 0,function*(){this.isInBackground=document.visibilityState==="hidden",!this.isInBackground&&this.kind===Track.Kind.Video&&setTimeout(()=>this.attachedElements.forEach($=>$.play().catch(()=>{})),0)})}addAppVisibilityListener(){isWeb()?(this.isInBackground=document.visibilityState==="hidden",document.addEventListener("visibilitychange",this.appVisibilityChangedListener)):this.isInBackground=!1}removeAppVisibilityListener(){isWeb()&&document.removeEventListener("visibilitychange",this.appVisibilityChangedListener)}}function attachToElement(B,$){let U;$.srcObject instanceof MediaStream?U=$.srcObject:U=new MediaStream;let F;B.kind==="audio"?F=U.getAudioTracks():F=U.getVideoTracks(),F.includes(B)||(F.forEach(V=>{U.removeTrack(V)}),U.addTrack(B)),(!isSafari()||!($ instanceof HTMLVideoElement))&&($.autoplay=!0),$.muted=U.getAudioTracks().length===0,$ instanceof HTMLVideoElement&&($.playsInline=!0),$.srcObject!==U&&($.srcObject=U,(isSafari()||isFireFox())&&$ instanceof HTMLVideoElement&&setTimeout(()=>{$.srcObject=U,$.play().catch(()=>{})},0))}function detachTrack(B,$){if($.srcObject instanceof MediaStream){const U=$.srcObject;U.removeTrack(B),U.getTracks().length>0?$.srcObject=U:$.srcObject=null}}(function(B){let $;(function(G){G.Audio="audio",G.Video="video",G.Unknown="unknown"})($=B.Kind||(B.Kind={}));let U;(function(G){G.Camera="camera",G.Microphone="microphone",G.ScreenShare="screen_share",G.ScreenShareAudio="screen_share_audio",G.Unknown="unknown"})(U=B.Source||(B.Source={}));let F;(function(G){G.Active="active",G.Paused="paused",G.Unknown="unknown"})(F=B.StreamState||(B.StreamState={}));function V(G){switch(G){case $.Audio:return TrackType.AUDIO;case $.Video:return TrackType.VIDEO;default:return TrackType.DATA}}B.kindToProto=V;function q(G){switch(G){case TrackType.AUDIO:return $.Audio;case TrackType.VIDEO:return $.Video;default:return $.Unknown}}B.kindFromProto=q;function j(G){switch(G){case U.Camera:return TrackSource.CAMERA;case U.Microphone:return TrackSource.MICROPHONE;case U.ScreenShare:return TrackSource.SCREEN_SHARE;case U.ScreenShareAudio:return TrackSource.SCREEN_SHARE_AUDIO;default:return TrackSource.UNKNOWN}}B.sourceToProto=j;function W(G){switch(G){case TrackSource.CAMERA:return U.Camera;case TrackSource.MICROPHONE:return U.Microphone;case TrackSource.SCREEN_SHARE:return U.ScreenShare;case TrackSource.SCREEN_SHARE_AUDIO:return U.ScreenShareAudio;default:return U.Unknown}}B.sourceFromProto=W;function K(G){switch(G){case StreamState.ACTIVE:return F.Active;case StreamState.PAUSED:return F.Paused;default:return F.Unknown}}B.streamStateFromProto=K})(Track||(Track={}));class VideoPreset{constructor($,U,F,V,q){if(typeof $=="object")this.width=$.width,this.height=$.height,this.aspectRatio=$.aspectRatio,this.encoding={maxBitrate:$.maxBitrate,maxFramerate:$.maxFramerate,priority:$.priority};else if(U!==void 0&&F!==void 0)this.width=$,this.height=U,this.aspectRatio=$/U,this.encoding={maxBitrate:F,maxFramerate:V,priority:q};else throw new TypeError("Unsupported options: provide at least width, height and maxBitrate")}get resolution(){return{width:this.width,height:this.height,frameRate:this.encoding.maxFramerate,aspectRatio:this.aspectRatio}}}const backupCodecs=["vp8","h264"],videoCodecs=["vp8","h264","vp9","av1","h265"];function isBackupCodec(B){return!!backupCodecs.find($=>$===B)}var BackupCodecPolicy;(function(B){B[B.PREFER_REGRESSION=0]="PREFER_REGRESSION",B[B.SIMULCAST=1]="SIMULCAST",B[B.REGRESSION=2]="REGRESSION"})(BackupCodecPolicy||(BackupCodecPolicy={}));var AudioPresets;(function(B){B.telephone={maxBitrate:12e3},B.speech={maxBitrate:24e3},B.music={maxBitrate:48e3},B.musicStereo={maxBitrate:64e3},B.musicHighQuality={maxBitrate:96e3},B.musicHighQualityStereo={maxBitrate:128e3}})(AudioPresets||(AudioPresets={}));const VideoPresets={h90:new VideoPreset(160,90,9e4,20),h180:new VideoPreset(320,180,16e4,20),h216:new VideoPreset(384,216,18e4,20),h360:new VideoPreset(640,360,45e4,20),h540:new VideoPreset(960,540,8e5,25),h720:new VideoPreset(1280,720,17e5,30),h1080:new VideoPreset(1920,1080,3e6,30),h1440:new VideoPreset(2560,1440,5e6,30),h2160:new VideoPreset(3840,2160,8e6,30)},VideoPresets43={h120:new VideoPreset(160,120,7e4,20),h180:new VideoPreset(240,180,125e3,20),h240:new VideoPreset(320,240,14e4,20),h360:new VideoPreset(480,360,33e4,20),h480:new VideoPreset(640,480,5e5,20),h540:new VideoPreset(720,540,6e5,25),h720:new VideoPreset(960,720,13e5,30),h1080:new VideoPreset(1440,1080,23e5,30),h1440:new VideoPreset(1920,1440,38e5,30)},ScreenSharePresets={h360fps3:new VideoPreset(640,360,2e5,3,"medium"),h360fps15:new VideoPreset(640,360,4e5,15,"medium"),h720fps5:new VideoPreset(1280,720,8e5,5,"medium"),h720fps15:new VideoPreset(1280,720,15e5,15,"medium"),h720fps30:new VideoPreset(1280,720,2e6,30,"medium"),h1080fps15:new VideoPreset(1920,1080,25e5,15,"medium"),h1080fps30:new VideoPreset(1920,1080,5e6,30,"medium"),original:new VideoPreset(0,0,7e6,30,"medium")},separator="|",ddExtensionURI="https://aomediacodec.github.io/av1-rtp-spec/#dependency-descriptor-rtp-header-extension";function unpackStreamId(B){const $=B.split(separator);return $.length>1?[$[0],B.substr($[0].length+1)]:[B,""]}function sleep(B){return __awaiter(this,void 0,void 0,function*(){return new Promise($=>CriticalTimers.setTimeout($,B))})}function supportsTransceiver(){return"addTransceiver"in RTCPeerConnection.prototype}function supportsAddTrack(){return"addTrack"in RTCPeerConnection.prototype}function supportsAV1(){if(!("getCapabilities"in RTCRtpSender)||isSafari()||isFireFox())return!1;const B=RTCRtpSender.getCapabilities("video");let $=!1;if(B){for(const U of B.codecs)if(U.mimeType==="video/AV1"){$=!0;break}}return $}function supportsVP9(){if(!("getCapabilities"in RTCRtpSender)||isFireFox())return!1;if(isSafari()){const U=getBrowser();if(U?.version&&compareVersions(U.version,"16")<0||U?.os==="iOS"&&U?.osVersion&&compareVersions(U.osVersion,"16")<0)return!1}const B=RTCRtpSender.getCapabilities("video");let $=!1;if(B){for(const U of B.codecs)if(U.mimeType==="video/VP9"){$=!0;break}}return $}function isSVCCodec(B){return B==="av1"||B==="vp9"}function supportsSetSinkId(B){return!document||isSafariBased()?!1:(B||(B=document.createElement("audio")),"setSinkId"in B)}function isBrowserSupported(){return typeof RTCPeerConnection>"u"?!1:supportsTransceiver()||supportsAddTrack()}function isFireFox(){var B;return((B=getBrowser())===null||B===void 0?void 0:B.name)==="Firefox"}function isSafari(){var B;return((B=getBrowser())===null||B===void 0?void 0:B.name)==="Safari"}function isSafariBased(){const B=getBrowser();return B?.name==="Safari"||B?.os==="iOS"}function isSafari17Based(){const B=getBrowser();return B?.name==="Safari"&&B.version.startsWith("17.")||B?.os==="iOS"&&!!B?.osVersion&&compareVersions(B.osVersion,"17")>=0}function isSafariSvcApi(B){return B||(B=getBrowser()),B?.name==="Safari"&&compareVersions(B.version,"18.3")>0||B?.os==="iOS"&&!!B?.osVersion&&compareVersions(B.osVersion,"18.3")>0}function isMobile(){var B,$;return isWeb()?($=(B=navigator.userAgentData)===null||B===void 0?void 0:B.mobile)!==null&&$!==void 0?$:/Tablet|iPad|Mobile|Android|BlackBerry/.test(navigator.userAgent):!1}function isE2EESimulcastSupported(){const B=getBrowser(),$="17.2";if(B)return B.name!=="Safari"&&B.os!=="iOS"||B.os==="iOS"&&B.osVersion&&compareVersions(B.osVersion,$)>=0?!0:B.name==="Safari"&&compareVersions(B.version,$)>=0}function isWeb(){return typeof document<"u"}function isReactNative(){return navigator.product=="ReactNative"}function isCloud(B){return B.hostname.endsWith(".livekit.cloud")||B.hostname.endsWith(".livekit.run")}function getLKReactNativeInfo(){if(global&&global.LiveKitReactNativeGlobal)return global.LiveKitReactNativeGlobal}function getReactNativeOs(){if(!isReactNative())return;let B=getLKReactNativeInfo();if(B)return B.platform}function getDevicePixelRatio(){if(isWeb())return window.devicePixelRatio;if(isReactNative()){let B=getLKReactNativeInfo();if(B)return B.devicePixelRatio}return 1}function compareVersions(B,$){const U=B.split("."),F=$.split("."),V=Math.min(U.length,F.length);for(let q=0;q<V;++q){const j=parseInt(U[q],10),W=parseInt(F[q],10);if(j>W)return 1;if(j<W)return-1;if(q===V-1&&j===W)return 0}return B===""&&$!==""?-1:$===""?1:U.length==F.length?0:U.length<F.length?-1:1}function roDispatchCallback(B){for(const $ of B)$.target.handleResize($)}function ioDispatchCallback(B){for(const $ of B)$.target.handleVisibilityChanged($)}let resizeObserver=null;const getResizeObserver=()=>(resizeObserver||(resizeObserver=new ResizeObserver(roDispatchCallback)),resizeObserver);let intersectionObserver=null;const getIntersectionObserver=()=>(intersectionObserver||(intersectionObserver=new IntersectionObserver(ioDispatchCallback,{root:null,rootMargin:"0px"})),intersectionObserver);function getClientInfo(){var B;const $=new ClientInfo({sdk:ClientInfo_SDK.JS,protocol:protocolVersion,version});return isReactNative()&&($.os=(B=getReactNativeOs())!==null&&B!==void 0?B:""),$}function createDummyVideoStreamTrack(){let B=arguments.length>0&&arguments[0]!==void 0?arguments[0]:16,$=arguments.length>1&&arguments[1]!==void 0?arguments[1]:16,U=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1,F=arguments.length>3&&arguments[3]!==void 0?arguments[3]:!1;const V=document.createElement("canvas");V.width=B,V.height=$;const q=V.getContext("2d");q?.fillRect(0,0,V.width,V.height),F&&q&&(q.beginPath(),q.arc(B/2,$/2,50,0,Math.PI*2,!0),q.closePath(),q.fillStyle="grey",q.fill());const j=V.captureStream(),[W]=j.getTracks();if(!W)throw Error("Could not get empty media stream video track");return W.enabled=U,W}let emptyAudioStreamTrack;function getEmptyAudioStreamTrack(){if(!emptyAudioStreamTrack){const B=new AudioContext,$=B.createOscillator(),U=B.createGain();U.gain.setValueAtTime(0,0);const F=B.createMediaStreamDestination();if($.connect(U),U.connect(F),$.start(),[emptyAudioStreamTrack]=F.stream.getAudioTracks(),!emptyAudioStreamTrack)throw Error("Could not get empty media stream audio track");emptyAudioStreamTrack.enabled=!1}return emptyAudioStreamTrack.clone()}class Future{get isResolved(){return this._isResolved}constructor($,U){this._isResolved=!1,this.onFinally=U,this.promise=new Promise((F,V)=>__awaiter(this,void 0,void 0,function*(){this.resolve=F,this.reject=V,$&&(yield $(F,V))})).finally(()=>{var F;this._isResolved=!0,(F=this.onFinally)===null||F===void 0||F.call(this)})}}function isVideoCodec(B){return videoCodecs.includes(B)}function unwrapConstraint(B){if(typeof B=="string"||typeof B=="number")return B;if(Array.isArray(B))return B[0];if(B.exact!==void 0)return Array.isArray(B.exact)?B.exact[0]:B.exact;if(B.ideal!==void 0)return Array.isArray(B.ideal)?B.ideal[0]:B.ideal;throw Error("could not unwrap constraint")}function toWebsocketUrl(B){return B.startsWith("http")?B.replace(/^(http)/,"ws"):B}function toHttpUrl(B){return B.startsWith("ws")?B.replace(/^(ws)/,"http"):B}function extractTranscriptionSegments(B,$){return B.segments.map(U=>{let{id:F,text:V,language:q,startTime:j,endTime:W,final:K}=U;var G;const z=(G=$.get(F))!==null&&G!==void 0?G:Date.now(),H=Date.now();return K?$.delete(F):$.set(F,z),{id:F,text:V,startTime:Number.parseInt(j.toString()),endTime:Number.parseInt(W.toString()),final:K,language:q,firstReceivedTime:z,lastReceivedTime:H}})}function extractChatMessage(B){const{id:$,timestamp:U,message:F,editTimestamp:V}=B;return{id:$,timestamp:Number.parseInt(U.toString()),editTimestamp:V?Number.parseInt(V.toString()):void 0,message:F}}function getDisconnectReasonFromConnectionError(B){switch(B.reason){case ConnectionErrorReason.LeaveRequest:return B.context;case ConnectionErrorReason.Cancelled:return DisconnectReason.CLIENT_INITIATED;case ConnectionErrorReason.NotAllowed:return DisconnectReason.USER_REJECTED;case ConnectionErrorReason.ServerUnreachable:return DisconnectReason.JOIN_FAILURE;default:return DisconnectReason.UNKNOWN_REASON}}function bigIntToNumber(B){return B!==void 0?Number(B):void 0}function numberToBigInt(B){return B!==void 0?BigInt(B):void 0}function isLocalTrack(B){return!!B&&!(B instanceof MediaStreamTrack)&&B.isLocal}function isAudioTrack(B){return!!B&&B.kind==Track.Kind.Audio}function isVideoTrack(B){return!!B&&B.kind==Track.Kind.Video}function isLocalVideoTrack(B){return isLocalTrack(B)&&isVideoTrack(B)}function isLocalAudioTrack(B){return isLocalTrack(B)&&isAudioTrack(B)}function isRemoteTrack(B){return!!B&&!B.isLocal}function isRemotePub(B){return!!B&&!B.isLocal}function isRemoteVideoTrack(B){return isRemoteTrack(B)&&isVideoTrack(B)}function isLocalParticipant(B){return B.isLocal}function splitUtf8(B,$){const U=[];let F=new TextEncoder().encode(B);for(;F.length>$;){let V=$;for(;V>0;){const q=F[V];if(q!==void 0&&(q&192)!==128)break;V--}U.push(F.slice(0,V)),F=F.slice(V)}return F.length>0&&U.push(F),U}function mergeDefaultOptions(B,$,U){var F,V,q,j;const{optionsWithoutProcessor:W,audioProcessor:K,videoProcessor:G}=extractProcessorsFromOptions(B??{}),z=$?.processor,H=U?.processor,Q=W??{};return Q.audio===!0&&(Q.audio={}),Q.video===!0&&(Q.video={}),Q.audio&&(mergeObjectWithoutOverwriting(Q.audio,$),(F=(q=Q.audio).deviceId)!==null&&F!==void 0||(q.deviceId={ideal:"default"}),(K||z)&&(Q.audio.processor=K??z)),Q.video&&(mergeObjectWithoutOverwriting(Q.video,U),(V=(j=Q.video).deviceId)!==null&&V!==void 0||(j.deviceId={ideal:"default"}),(G||H)&&(Q.video.processor=G??H)),Q}function mergeObjectWithoutOverwriting(B,$){return Object.keys($).forEach(U=>{B[U]===void 0&&(B[U]=$[U])}),B}function constraintsForOptions(B){var $,U,F,V;const q={};if(B.video)if(typeof B.video=="object"){const j={},W=j,K=B.video;Object.keys(K).forEach(G=>{switch(G){case"resolution":mergeObjectWithoutOverwriting(W,K.resolution);break;default:W[G]=K[G]}}),q.video=j,($=(F=q.video).deviceId)!==null&&$!==void 0||(F.deviceId={ideal:"default"})}else q.video=B.video?{deviceId:{ideal:"default"}}:!1;else q.video=!1;return B.audio?typeof B.audio=="object"?(q.audio=B.audio,(U=(V=q.audio).deviceId)!==null&&U!==void 0||(V.deviceId={ideal:"default"})):q.audio={deviceId:{ideal:"default"}}:q.audio=!1,q}function detectSilence(B){return __awaiter(this,arguments,void 0,function($){let U=arguments.length>1&&arguments[1]!==void 0?arguments[1]:200;return(function*(){const F=getNewAudioContext();if(F){const V=F.createAnalyser();V.fftSize=2048;const q=V.frequencyBinCount,j=new Uint8Array(q);F.createMediaStreamSource(new MediaStream([$.mediaStreamTrack])).connect(V),yield sleep(U),V.getByteTimeDomainData(j);const K=j.some(G=>G!==128&&G!==0);return F.close(),!K}return!1})()})}function getNewAudioContext(){var B;const $=typeof window<"u"&&(window.AudioContext||window.webkitAudioContext);if($){const U=new $({latencyHint:"interactive"});if(U.state==="suspended"&&typeof window<"u"&&(!((B=window.document)===null||B===void 0)&&B.body)){const F=()=>__awaiter(this,void 0,void 0,function*(){var V;try{U.state==="suspended"&&(yield U.resume())}catch(q){console.warn("Error trying to auto-resume audio context",q)}(V=window.document.body)===null||V===void 0||V.removeEventListener("click",F)});window.document.body.addEventListener("click",F)}return U}}function kindToSource(B){return B==="audioinput"?Track.Source.Microphone:B==="videoinput"?Track.Source.Camera:Track.Source.Unknown}function sourceToKind(B){return B===Track.Source.Microphone?"audioinput":B===Track.Source.Camera?"videoinput":void 0}function screenCaptureToDisplayMediaStreamOptions(B){var $,U;let F=($=B.video)!==null&&$!==void 0?$:!0;return B.resolution&&B.resolution.width>0&&B.resolution.height>0&&(F=typeof F=="boolean"?{}:F,isSafari()?F=Object.assign(Object.assign({},F),{width:{max:B.resolution.width},height:{max:B.resolution.height},frameRate:B.resolution.frameRate}):F=Object.assign(Object.assign({},F),{width:{ideal:B.resolution.width},height:{ideal:B.resolution.height},frameRate:B.resolution.frameRate})),{audio:(U=B.audio)!==null&&U!==void 0?U:!1,video:F,controller:B.controller,selfBrowserSurface:B.selfBrowserSurface,surfaceSwitching:B.surfaceSwitching,systemAudio:B.systemAudio,preferCurrentTab:B.preferCurrentTab}}function mimeTypeToVideoCodecString(B){return B.split("/")[1].toLowerCase()}function getTrackPublicationInfo(B){const $=[];return B.forEach(U=>{U.track!==void 0&&$.push(new TrackPublishedResponse({cid:U.track.mediaStreamID,track:U.trackInfo}))}),$}function getLogContextFromTrack(B){return"mediaStreamTrack"in B?{trackID:B.sid,source:B.source,muted:B.isMuted,enabled:B.mediaStreamTrack.enabled,kind:B.kind,streamID:B.mediaStreamID,streamTrackID:B.mediaStreamTrack.id}:{trackID:B.trackSid,enabled:B.isEnabled,muted:B.isMuted,trackInfo:Object.assign({mimeType:B.mimeType,name:B.trackName,encrypted:B.isEncrypted,kind:B.kind,source:B.source},B.track?getLogContextFromTrack(B.track):{})}}function supportsSynchronizationSources(){return typeof RTCRtpReceiver<"u"&&"getSynchronizationSources"in RTCRtpReceiver}function diffAttributes(B,$){var U;B===void 0&&(B={}),$===void 0&&($={});const F=[...Object.keys($),...Object.keys(B)],V={};for(const q of F)B[q]!==$[q]&&(V[q]=(U=$[q])!==null&&U!==void 0?U:"");return V}function extractProcessorsFromOptions(B){const $=Object.assign({},B);let U,F;return typeof $.audio=="object"&&$.audio.processor&&(U=$.audio.processor,$.audio=Object.assign(Object.assign({},$.audio),{processor:void 0})),typeof $.video=="object"&&$.video.processor&&(F=$.video.processor,$.video=Object.assign(Object.assign({},$.video),{processor:void 0})),{audioProcessor:U,videoProcessor:F,optionsWithoutProcessor:cloneDeep($)}}function getTrackSourceFromProto(B){switch(B){case TrackSource.CAMERA:return Track.Source.Camera;case TrackSource.MICROPHONE:return Track.Source.Microphone;case TrackSource.SCREEN_SHARE:return Track.Source.ScreenShare;case TrackSource.SCREEN_SHARE_AUDIO:return Track.Source.ScreenShareAudio;default:return Track.Source.Unknown}}function areDimensionsSmaller(B,$){return B.width*B.height<$.width*$.height}function layerDimensionsFor(B,$){var U;return(U=B.layers)===null||U===void 0?void 0:U.find(F=>F.quality===$)}class E2EEManager extends eventsExports.EventEmitter{constructor($){super(),this.onWorkerMessage=U=>{var F,V;const{kind:q,data:j}=U.data;switch(q){case"error":livekitLogger.error(j.error.message),this.emit(EncryptionEvent.EncryptionError,j.error);break;case"initAck":j.enabled&&this.keyProvider.getKeys().forEach(W=>{this.postKey(W)});break;case"enable":if(j.enabled&&this.keyProvider.getKeys().forEach(W=>{this.postKey(W)}),this.encryptionEnabled!==j.enabled&&j.participantIdentity===((F=this.room)===null||F===void 0?void 0:F.localParticipant.identity))this.emit(EncryptionEvent.ParticipantEncryptionStatusChanged,j.enabled,this.room.localParticipant),this.encryptionEnabled=j.enabled;else if(j.participantIdentity){const W=(V=this.room)===null||V===void 0?void 0:V.getParticipantByIdentity(j.participantIdentity);if(!W)throw TypeError("couldn't set encryption status, participant not found".concat(j.participantIdentity));this.emit(EncryptionEvent.ParticipantEncryptionStatusChanged,j.enabled,W)}break;case"ratchetKey":this.keyProvider.emit(KeyProviderEvent.KeyRatcheted,j.ratchetResult,j.participantIdentity,j.keyIndex);break}},this.onWorkerError=U=>{livekitLogger.error("e2ee worker encountered an error:",{error:U.error}),this.emit(EncryptionEvent.EncryptionError,U.error)},this.keyProvider=$.keyProvider,this.worker=$.worker,this.encryptionEnabled=!1}setup($){if(!isE2EESupported())throw new DeviceUnsupportedError("tried to setup end-to-end encryption on an unsupported browser");if(livekitLogger.info("setting up e2ee"),$!==this.room){this.room=$,this.setupEventListeners($,this.keyProvider);const U={kind:"init",data:{keyProviderOptions:this.keyProvider.getOptions(),loglevel:workerLogger.getLevel()}};this.worker&&(livekitLogger.info("initializing worker",{worker:this.worker}),this.worker.onmessage=this.onWorkerMessage,this.worker.onerror=this.onWorkerError,this.worker.postMessage(U))}}setParticipantCryptorEnabled($,U){livekitLogger.debug("set e2ee to ".concat($," for participant ").concat(U)),this.postEnable($,U)}setSifTrailer($){!$||$.length===0?livekitLogger.warn("ignoring server sent trailer as it's empty"):this.postSifTrailer($)}setupEngine($){$.on(EngineEvent.RTPVideoMapUpdate,U=>{this.postRTPMap(U)})}setupEventListeners($,U){$.on(RoomEvent.TrackPublished,(F,V)=>this.setParticipantCryptorEnabled(F.trackInfo.encryption!==Encryption_Type.NONE,V.identity)),$.on(RoomEvent.ConnectionStateChanged,F=>{F===ConnectionState.Connected&&$.remoteParticipants.forEach(V=>{V.trackPublications.forEach(q=>{this.setParticipantCryptorEnabled(q.trackInfo.encryption!==Encryption_Type.NONE,V.identity)})})}).on(RoomEvent.TrackUnsubscribed,(F,V,q)=>{var j;const W={kind:"removeTransform",data:{participantIdentity:q.identity,trackId:F.mediaStreamID}};(j=this.worker)===null||j===void 0||j.postMessage(W)}).on(RoomEvent.TrackSubscribed,(F,V,q)=>{this.setupE2EEReceiver(F,q.identity,V.trackInfo)}).on(RoomEvent.SignalConnected,()=>{if(!this.room)throw new TypeError("expected room to be present on signal connect");U.getKeys().forEach(F=>{this.postKey(F)}),this.setParticipantCryptorEnabled(this.room.localParticipant.isE2EEEnabled,this.room.localParticipant.identity)}),$.localParticipant.on(ParticipantEvent.LocalSenderCreated,(F,V)=>__awaiter(this,void 0,void 0,function*(){this.setupE2EESender(V,F)})),$.localParticipant.on(ParticipantEvent.LocalTrackPublished,F=>{if(!isVideoTrack(F.track)||!isSafariBased())return;const V={kind:"updateCodec",data:{trackId:F.track.mediaStreamID,codec:mimeTypeToVideoCodecString(F.trackInfo.codecs[0].mimeType),participantIdentity:this.room.localParticipant.identity}};this.worker.postMessage(V)}),U.on(KeyProviderEvent.SetKey,F=>this.postKey(F)).on(KeyProviderEvent.RatchetRequest,(F,V)=>this.postRatchetRequest(F,V))}postRatchetRequest($,U){if(!this.worker)throw Error("could not ratchet key, worker is missing");const F={kind:"ratchetRequest",data:{participantIdentity:$,keyIndex:U}};this.worker.postMessage(F)}postKey($){let{key:U,participantIdentity:F,keyIndex:V}=$;var q;if(!this.worker)throw Error("could not set key, worker is missing");const j={kind:"setKey",data:{participantIdentity:F,isPublisher:F===((q=this.room)===null||q===void 0?void 0:q.localParticipant.identity),key:U,keyIndex:V}};this.worker.postMessage(j)}postEnable($,U){if(this.worker){const F={kind:"enable",data:{enabled:$,participantIdentity:U}};this.worker.postMessage(F)}else throw new ReferenceError("failed to enable e2ee, worker is not ready")}postRTPMap($){var U;if(!this.worker)throw TypeError("could not post rtp map, worker is missing");if(!(!((U=this.room)===null||U===void 0)&&U.localParticipant.identity))throw TypeError("could not post rtp map, local participant identity is missing");const F={kind:"setRTPMap",data:{map:$,participantIdentity:this.room.localParticipant.identity}};this.worker.postMessage(F)}postSifTrailer($){if(!this.worker)throw Error("could not post SIF trailer, worker is missing");const U={kind:"setSifTrailer",data:{trailer:$}};this.worker.postMessage(U)}setupE2EEReceiver($,U,F){if($.receiver){if(!F?.mimeType||F.mimeType==="")throw new TypeError("MimeType missing from trackInfo, cannot set up E2EE cryptor");this.handleReceiver($.receiver,$.mediaStreamID,U,$.kind==="video"?mimeTypeToVideoCodecString(F.mimeType):void 0)}}setupE2EESender($,U){if(!isLocalTrack($)||!U){U||livekitLogger.warn("early return because sender is not ready");return}this.handleSender(U,$.mediaStreamID,void 0)}handleReceiver($,U,F,V){return __awaiter(this,void 0,void 0,function*(){if(this.worker){if(isScriptTransformSupported()){const q={kind:"decode",participantIdentity:F,trackId:U,codec:V};$.transform=new RTCRtpScriptTransform(this.worker,q)}else{if(E2EE_FLAG in $&&V){const K={kind:"updateCodec",data:{trackId:U,codec:V,participantIdentity:F}};this.worker.postMessage(K);return}let q=$.writableStream,j=$.readableStream;if(!q||!j){const K=$.createEncodedStreams();$.writableStream=K.writable,q=K.writable,$.readableStream=K.readable,j=K.readable}const W={kind:"decode",data:{readableStream:j,writableStream:q,trackId:U,codec:V,participantIdentity:F,isReuse:E2EE_FLAG in $}};this.worker.postMessage(W,[j,q])}$[E2EE_FLAG]=!0}})}handleSender($,U,F){var V;if(!(E2EE_FLAG in $||!this.worker)){if(!(!((V=this.room)===null||V===void 0)&&V.localParticipant.identity)||this.room.localParticipant.identity==="")throw TypeError("local identity needs to be known in order to set up encrypted sender");if(isScriptTransformSupported()){livekitLogger.info("initialize script transform");const q={kind:"encode",participantIdentity:this.room.localParticipant.identity,trackId:U,codec:F};$.transform=new RTCRtpScriptTransform(this.worker,q)}else{livekitLogger.info("initialize encoded streams");const q=$.createEncodedStreams(),j={kind:"encode",data:{readableStream:q.readable,writableStream:q.writable,codec:F,trackId:U,participantIdentity:this.room.localParticipant.identity,isReuse:!1}};this.worker.postMessage(j,[q.readable,q.writable])}$[E2EE_FLAG]=!0}}}const defaultId="default";class DeviceManager{constructor(){this._previousDevices=[]}static getInstance(){return this.instance===void 0&&(this.instance=new DeviceManager),this.instance}get previousDevices(){return this._previousDevices}getDevices($){return __awaiter(this,arguments,void 0,function(U){var F=this;let V=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0;return(function*(){var q;if(((q=DeviceManager.userMediaPromiseMap)===null||q===void 0?void 0:q.size)>0){livekitLogger.debug("awaiting getUserMedia promise");try{U?yield DeviceManager.userMediaPromiseMap.get(U):yield Promise.all(DeviceManager.userMediaPromiseMap.values())}catch{livekitLogger.warn("error waiting for media permissons")}}let j=yield navigator.mediaDevices.enumerateDevices();if(V&&!(isSafari()&&F.hasDeviceInUse(U))&&(j.filter(K=>K.kind===U).length===0||j.some(K=>{const G=K.label==="",z=U?K.kind===U:!0;return G&&z}))){const K={video:U!=="audioinput"&&U!=="audiooutput",audio:U!=="videoinput"&&{deviceId:{ideal:"default"}}},G=yield navigator.mediaDevices.getUserMedia(K);j=yield navigator.mediaDevices.enumerateDevices(),G.getTracks().forEach(z=>{z.stop()})}return F._previousDevices=j,U&&(j=j.filter(W=>W.kind===U)),j})()})}normalizeDeviceId($,U,F){return __awaiter(this,void 0,void 0,function*(){if(U!==defaultId)return U;const V=yield this.getDevices($),q=V.find(W=>W.deviceId===defaultId);if(!q){livekitLogger.warn("could not reliably determine default device");return}const j=V.find(W=>W.deviceId!==defaultId&&W.groupId===(F??q.groupId));if(!j){livekitLogger.warn("could not reliably determine default device");return}return j?.deviceId})}hasDeviceInUse($){return $?DeviceManager.userMediaPromiseMap.has($):DeviceManager.userMediaPromiseMap.size>0}}DeviceManager.mediaDeviceKinds=["audioinput","audiooutput","videoinput"],DeviceManager.userMediaPromiseMap=new Map;var QueueTaskStatus;(function(B){B[B.WAITING=0]="WAITING",B[B.RUNNING=1]="RUNNING",B[B.COMPLETED=2]="COMPLETED"})(QueueTaskStatus||(QueueTaskStatus={}));class AsyncQueue{constructor(){this.pendingTasks=new Map,this.taskMutex=new _,this.nextTaskIndex=0}run($){return __awaiter(this,void 0,void 0,function*(){const U={id:this.nextTaskIndex++,enqueuedAt:Date.now(),status:QueueTaskStatus.WAITING};this.pendingTasks.set(U.id,U);const F=yield this.taskMutex.lock();try{return U.executedAt=Date.now(),U.status=QueueTaskStatus.RUNNING,yield $()}finally{U.status=QueueTaskStatus.COMPLETED,this.pendingTasks.delete(U.id),F()}})}flush(){return __awaiter(this,void 0,void 0,function*(){return this.run(()=>__awaiter(this,void 0,void 0,function*(){}))})}snapshot(){return Array.from(this.pendingTasks.values())}}function createRtcUrl(B,$){const U=new URL(toWebsocketUrl(B));return $.forEach((F,V)=>{U.searchParams.set(V,F)}),appendUrlPath(U,"rtc")}function createValidateUrl(B){const $=new URL(toHttpUrl(B));return appendUrlPath($,"validate")}function ensureTrailingSlash(B){return B.endsWith("/")?B:"".concat(B,"/")}function appendUrlPath(B,$){return B.pathname="".concat(ensureTrailingSlash(B.pathname)).concat($),B.toString()}const passThroughQueueSignals=["syncState","trickle","offer","answer","simulate","leave"];function canPassThroughQueue(B){const $=passThroughQueueSignals.indexOf(B.case)>=0;return livekitLogger.trace("request allowed to bypass queue:",{canPass:$,req:B}),$}var SignalConnectionState;(function(B){B[B.CONNECTING=0]="CONNECTING",B[B.CONNECTED=1]="CONNECTED",B[B.RECONNECTING=2]="RECONNECTING",B[B.DISCONNECTING=3]="DISCONNECTING",B[B.DISCONNECTED=4]="DISCONNECTED"})(SignalConnectionState||(SignalConnectionState={}));class SignalClient{get currentState(){return this.state}get isDisconnected(){return this.state===SignalConnectionState.DISCONNECTING||this.state===SignalConnectionState.DISCONNECTED}get isEstablishingConnection(){return this.state===SignalConnectionState.CONNECTING||this.state===SignalConnectionState.RECONNECTING}getNextRequestId(){return this._requestId+=1,this._requestId}constructor(){let $=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1,U=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};var F;this.rtt=0,this.state=SignalConnectionState.DISCONNECTED,this.log=livekitLogger,this._requestId=0,this.resetCallbacks=()=>{this.onAnswer=void 0,this.onLeave=void 0,this.onLocalTrackPublished=void 0,this.onLocalTrackUnpublished=void 0,this.onNegotiateRequested=void 0,this.onOffer=void 0,this.onRemoteMuteChanged=void 0,this.onSubscribedQualityUpdate=void 0,this.onTokenRefresh=void 0,this.onTrickle=void 0,this.onClose=void 0},this.log=getLogger((F=U.loggerName)!==null&&F!==void 0?F:LoggerNames.Signal),this.loggerContextCb=U.loggerContextCb,this.useJSON=$,this.requestQueue=new AsyncQueue,this.queuedRequests=[],this.closingLock=new _,this.connectionLock=new _,this.state=SignalConnectionState.DISCONNECTED}get logContext(){var $,U;return(U=($=this.loggerContextCb)===null||$===void 0?void 0:$.call(this))!==null&&U!==void 0?U:{}}join($,U,F,V){return __awaiter(this,void 0,void 0,function*(){return this.state=SignalConnectionState.CONNECTING,this.options=F,yield this.connect($,U,F,V)})}reconnect($,U,F,V){return __awaiter(this,void 0,void 0,function*(){if(!this.options){this.log.warn("attempted to reconnect without signal options being set, ignoring",this.logContext);return}return this.state=SignalConnectionState.RECONNECTING,this.clearPingInterval(),yield this.connect($,U,Object.assign(Object.assign({},this.options),{reconnect:!0,sid:F,reconnectReason:V}))})}connect($,U,F,V){this.connectOptions=F;const q=getClientInfo(),j=createConnectionParams(U,q,F),W=createRtcUrl($,j),K=createValidateUrl(W);return new Promise((G,z)=>__awaiter(this,void 0,void 0,function*(){const H=yield this.connectionLock.lock();try{const Q=()=>__awaiter(this,void 0,void 0,function*(){this.close(),clearTimeout(Y),z(new ConnectionError("room connection has been cancelled (signal)",ConnectionErrorReason.Cancelled))}),Y=setTimeout(()=>{this.close(),z(new ConnectionError("room connection has timed out (signal)",ConnectionErrorReason.ServerUnreachable))},F.websocketTimeout);V?.aborted&&Q(),V?.addEventListener("abort",Q);const X=new URL(W);X.searchParams.has("access_token")&&X.searchParams.set("access_token","<redacted>"),this.log.debug("connecting to ".concat(X),Object.assign({reconnect:F.reconnect,reconnectReason:F.reconnectReason},this.logContext)),this.ws&&(yield this.close(!1)),this.ws=new WebSocket(W),this.ws.binaryType="arraybuffer",this.ws.onopen=()=>{clearTimeout(Y)},this.ws.onerror=Z=>__awaiter(this,void 0,void 0,function*(){if(this.state!==SignalConnectionState.CONNECTED){this.state=SignalConnectionState.DISCONNECTED,clearTimeout(Y);try{const ne=yield fetch(K);if(ne.status.toFixed(0).startsWith("4")){const ee=yield ne.text();z(new ConnectionError(ee,ConnectionErrorReason.NotAllowed,ne.status))}else z(new ConnectionError("Encountered unknown websocket error during connection: ".concat(Z.toString()),ConnectionErrorReason.InternalError,ne.status))}catch(ne){z(new ConnectionError(ne instanceof Error?ne.message:"server was not reachable",ConnectionErrorReason.ServerUnreachable))}return}this.handleWSError(Z)}),this.ws.onmessage=Z=>__awaiter(this,void 0,void 0,function*(){var ne,ee,ie;let se;if(typeof Z.data=="string"){const te=JSON.parse(Z.data);se=SignalResponse.fromJson(te,{ignoreUnknownFields:!0})}else if(Z.data instanceof ArrayBuffer)se=SignalResponse.fromBinary(new Uint8Array(Z.data));else{this.log.error("could not decode websocket message: ".concat(typeof Z.data),this.logContext);return}if(this.state!==SignalConnectionState.CONNECTED){let te=!1;if(((ne=se.message)===null||ne===void 0?void 0:ne.case)==="join"?(this.state=SignalConnectionState.CONNECTED,V?.removeEventListener("abort",Q),this.pingTimeoutDuration=se.message.value.pingTimeout,this.pingIntervalDuration=se.message.value.pingInterval,this.pingTimeoutDuration&&this.pingTimeoutDuration>0&&(this.log.debug("ping config",Object.assign(Object.assign({},this.logContext),{timeout:this.pingTimeoutDuration,interval:this.pingIntervalDuration})),this.startPingInterval()),G(se.message.value)):this.state===SignalConnectionState.RECONNECTING&&se.message.case!=="leave"?(this.state=SignalConnectionState.CONNECTED,V?.removeEventListener("abort",Q),this.startPingInterval(),((ee=se.message)===null||ee===void 0?void 0:ee.case)==="reconnect"?G(se.message.value):(this.log.debug("declaring signal reconnected without reconnect response received",this.logContext),G(void 0),te=!0)):this.isEstablishingConnection&&se.message.case==="leave"?z(new ConnectionError("Received leave request while trying to (re)connect",ConnectionErrorReason.LeaveRequest,void 0,se.message.value.reason)):F.reconnect||z(new ConnectionError("did not receive join response, got ".concat((ie=se.message)===null||ie===void 0?void 0:ie.case," instead"),ConnectionErrorReason.InternalError)),!te)return}this.signalLatency&&(yield sleep(this.signalLatency)),this.handleSignalResponse(se)}),this.ws.onclose=Z=>{this.isEstablishingConnection&&z(new ConnectionError("Websocket got closed during a (re)connection attempt",ConnectionErrorReason.InternalError)),this.log.warn("websocket closed",Object.assign(Object.assign({},this.logContext),{reason:Z.reason,code:Z.code,wasClean:Z.wasClean,state:this.state})),this.handleOnClose(Z.reason)}}finally{H()}}))}close(){return __awaiter(this,arguments,void 0,function(){var $=this;let U=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0;return(function*(){const F=yield $.closingLock.lock();try{if($.clearPingInterval(),U&&($.state=SignalConnectionState.DISCONNECTING),$.ws){$.ws.onmessage=null,$.ws.onopen=null,$.ws.onclose=null;const V=new Promise(q=>{$.ws?$.ws.onclose=()=>{q()}:q()});$.ws.readyState<$.ws.CLOSING&&($.ws.close(),yield Promise.race([V,sleep(250)])),$.ws=void 0}}finally{U&&($.state=SignalConnectionState.DISCONNECTED),F()}})()})}sendOffer($,U){this.log.debug("sending offer",Object.assign(Object.assign({},this.logContext),{offerSdp:$.sdp})),this.sendRequest({case:"offer",value:toProtoSessionDescription($,U)})}sendAnswer($,U){return this.log.debug("sending answer",Object.assign(Object.assign({},this.logContext),{answerSdp:$.sdp})),this.sendRequest({case:"answer",value:toProtoSessionDescription($,U)})}sendIceCandidate($,U){return this.log.debug("sending ice candidate",Object.assign(Object.assign({},this.logContext),{candidate:$})),this.sendRequest({case:"trickle",value:new TrickleRequest({candidateInit:JSON.stringify($),target:U})})}sendMuteTrack($,U){return this.sendRequest({case:"mute",value:new MuteTrackRequest({sid:$,muted:U})})}sendAddTrack($){return this.sendRequest({case:"addTrack",value:$})}sendUpdateLocalMetadata($,U){return __awaiter(this,arguments,void 0,function(F,V){var q=this;let j=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};return(function*(){const W=q.getNextRequestId();return yield q.sendRequest({case:"updateMetadata",value:new UpdateParticipantMetadata({requestId:W,metadata:F,name:V,attributes:j})}),W})()})}sendUpdateTrackSettings($){this.sendRequest({case:"trackSetting",value:$})}sendUpdateSubscription($){return this.sendRequest({case:"subscription",value:$})}sendSyncState($){return this.sendRequest({case:"syncState",value:$})}sendUpdateVideoLayers($,U){return this.sendRequest({case:"updateLayers",value:new UpdateVideoLayers({trackSid:$,layers:U})})}sendUpdateSubscriptionPermissions($,U){return this.sendRequest({case:"subscriptionPermission",value:new SubscriptionPermission({allParticipants:$,trackPermissions:U})})}sendSimulateScenario($){return this.sendRequest({case:"simulate",value:$})}sendPing(){return Promise.all([this.sendRequest({case:"ping",value:protoInt64.parse(Date.now())}),this.sendRequest({case:"pingReq",value:new Ping({timestamp:protoInt64.parse(Date.now()),rtt:protoInt64.parse(this.rtt)})})])}sendUpdateLocalAudioTrack($,U){return this.sendRequest({case:"updateAudioTrack",value:new UpdateLocalAudioTrack({trackSid:$,features:U})})}sendLeave(){return this.sendRequest({case:"leave",value:new LeaveRequest({reason:DisconnectReason.CLIENT_INITIATED,action:LeaveRequest_Action.DISCONNECT})})}sendRequest($){return __awaiter(this,arguments,void 0,function(U){var F=this;let V=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;return(function*(){if(!V&&!canPassThroughQueue(U)&&F.state===SignalConnectionState.RECONNECTING){F.queuedRequests.push(()=>__awaiter(F,void 0,void 0,function*(){yield this.sendRequest(U,!0)}));return}if(V||(yield F.requestQueue.flush()),F.signalLatency&&(yield sleep(F.signalLatency)),F.isDisconnected){F.log.debug("skipping signal request (type: ".concat(U.case,") - SignalClient disconnected"));return}if(!F.ws||F.ws.readyState!==F.ws.OPEN){F.log.error("cannot send signal request before connected, type: ".concat(U?.case),F.logContext);return}const j=new SignalRequest({message:U});try{F.useJSON?F.ws.send(j.toJsonString()):F.ws.send(j.toBinary())}catch(W){F.log.error("error sending signal message",Object.assign(Object.assign({},F.logContext),{error:W}))}})()})}handleSignalResponse($){var U,F;const V=$.message;if(V==null){this.log.debug("received unsupported message",this.logContext);return}let q=!1;if(V.case==="answer"){const j=fromProtoSessionDescription(V.value);this.onAnswer&&this.onAnswer(j,V.value.id)}else if(V.case==="offer"){const j=fromProtoSessionDescription(V.value);this.onOffer&&this.onOffer(j,V.value.id)}else if(V.case==="trickle"){const j=JSON.parse(V.value.candidateInit);this.onTrickle&&this.onTrickle(j,V.value.target)}else V.case==="update"?this.onParticipantUpdate&&this.onParticipantUpdate((U=V.value.participants)!==null&&U!==void 0?U:[]):V.case==="trackPublished"?this.onLocalTrackPublished&&this.onLocalTrackPublished(V.value):V.case==="speakersChanged"?this.onSpeakersChanged&&this.onSpeakersChanged((F=V.value.speakers)!==null&&F!==void 0?F:[]):V.case==="leave"?this.onLeave&&this.onLeave(V.value):V.case==="mute"?this.onRemoteMuteChanged&&this.onRemoteMuteChanged(V.value.sid,V.value.muted):V.case==="roomUpdate"?this.onRoomUpdate&&V.value.room&&this.onRoomUpdate(V.value.room):V.case==="connectionQuality"?this.onConnectionQuality&&this.onConnectionQuality(V.value):V.case==="streamStateUpdate"?this.onStreamStateUpdate&&this.onStreamStateUpdate(V.value):V.case==="subscribedQualityUpdate"?this.onSubscribedQualityUpdate&&this.onSubscribedQualityUpdate(V.value):V.case==="subscriptionPermissionUpdate"?this.onSubscriptionPermissionUpdate&&this.onSubscriptionPermissionUpdate(V.value):V.case==="refreshToken"?this.onTokenRefresh&&this.onTokenRefresh(V.value):V.case==="trackUnpublished"?this.onLocalTrackUnpublished&&this.onLocalTrackUnpublished(V.value):V.case==="subscriptionResponse"?this.onSubscriptionError&&this.onSubscriptionError(V.value):V.case==="pong"||(V.case==="pongResp"?(this.rtt=Date.now()-Number.parseInt(V.value.lastPingTimestamp.toString()),this.resetPingTimeout(),q=!0):V.case==="requestResponse"?this.onRequestResponse&&this.onRequestResponse(V.value):V.case==="trackSubscribed"?this.onLocalTrackSubscribed&&this.onLocalTrackSubscribed(V.value.trackSid):V.case==="roomMoved"?(this.onTokenRefresh&&this.onTokenRefresh(V.value.token),this.onRoomMoved&&this.onRoomMoved(V.value)):this.log.debug("unsupported message",Object.assign(Object.assign({},this.logContext),{msgCase:V.case})));q||this.resetPingTimeout()}setReconnected(){for(;this.queuedRequests.length>0;){const $=this.queuedRequests.shift();$&&this.requestQueue.run($)}}handleOnClose($){return __awaiter(this,void 0,void 0,function*(){if(this.state===SignalConnectionState.DISCONNECTED)return;const U=this.onClose;yield this.close(),this.log.debug("websocket connection closed: ".concat($),Object.assign(Object.assign({},this.logContext),{reason:$})),U&&U($)})}handleWSError($){this.log.error("websocket error",Object.assign(Object.assign({},this.logContext),{error:$}))}resetPingTimeout(){if(this.clearPingTimeout(),!this.pingTimeoutDuration){this.log.warn("ping timeout duration not set",this.logContext);return}this.pingTimeout=CriticalTimers.setTimeout(()=>{this.log.warn("ping timeout triggered. last pong received at: ".concat(new Date(Date.now()-this.pingTimeoutDuration*1e3).toUTCString()),this.logContext),this.handleOnClose("ping timeout")},this.pingTimeoutDuration*1e3)}clearPingTimeout(){this.pingTimeout&&CriticalTimers.clearTimeout(this.pingTimeout)}startPingInterval(){if(this.clearPingInterval(),this.resetPingTimeout(),!this.pingIntervalDuration){this.log.warn("ping interval duration not set",this.logContext);return}this.log.debug("start ping interval",this.logContext),this.pingInterval=CriticalTimers.setInterval(()=>{this.sendPing()},this.pingIntervalDuration*1e3)}clearPingInterval(){this.log.debug("clearing ping interval",this.logContext),this.clearPingTimeout(),this.pingInterval&&CriticalTimers.clearInterval(this.pingInterval)}}function fromProtoSessionDescription(B){const $={type:"offer",sdp:B.sdp};switch(B.type){case"answer":case"offer":case"pranswer":case"rollback":$.type=B.type;break}return $}function toProtoSessionDescription(B,$){return new SessionDescription({sdp:B.sdp,type:B.type,id:$})}function createConnectionParams(B,$,U){var F;const V=new URLSearchParams;return V.set("access_token",B),U.reconnect&&(V.set("reconnect","1"),U.sid&&V.set("sid",U.sid)),V.set("auto_subscribe",U.autoSubscribe?"1":"0"),V.set("sdk",isReactNative()?"reactnative":"js"),V.set("version",$.version),V.set("protocol",$.protocol.toString()),$.deviceModel&&V.set("device_model",$.deviceModel),$.os&&V.set("os",$.os),$.osVersion&&V.set("os_version",$.osVersion),$.browser&&V.set("browser",$.browser),$.browserVersion&&V.set("browser_version",$.browserVersion),U.adaptiveStream&&V.set("adaptive_stream","1"),U.reconnectReason&&V.set("reconnect_reason",U.reconnectReason.toString()),!((F=navigator.connection)===null||F===void 0)&&F.type&&V.set("network",navigator.connection.type),V}class DataPacketBuffer{constructor(){this.buffer=[],this._totalSize=0}push($){this.buffer.push($),this._totalSize+=$.data.byteLength}pop(){const $=this.buffer.shift();return $&&(this._totalSize-=$.data.byteLength),$}getAll(){return this.buffer.slice()}popToSequence($){for(;this.buffer.length>0&&this.buffer[0].sequence<=$;)this.pop()}alignBufferedAmount($){for(;this.buffer.length>0;){const U=this.buffer[0];if(this._totalSize-U.data.byteLength<=$)break;this.pop()}}get length(){return this.buffer.length}}class TTLMap{constructor($){this._map=new Map,this._lastCleanup=0,this.ttl=$}set($,U){const F=Date.now();F-this._lastCleanup>this.ttl/2&&this.cleanup();const V=F+this.ttl;return this._map.set($,{value:U,expiresAt:V}),this}get($){const U=this._map.get($);if(U){if(U.expiresAt<Date.now()){this._map.delete($);return}return U.value}}has($){const U=this._map.get($);return U?U.expiresAt<Date.now()?(this._map.delete($),!1):!0:!1}delete($){return this._map.delete($)}clear(){this._map.clear()}cleanup(){const $=Date.now();for(const[U,F]of this._map.entries())F.expiresAt<$&&this._map.delete(U);this._lastCleanup=$}get size(){return this.cleanup(),this._map.size}forEach($){this.cleanup();for(const[U,F]of this._map.entries())F.expiresAt>=Date.now()&&$(F.value,U,this.asValueMap())}map($){this.cleanup();const U=[],F=this.asValueMap();for(const[V,q]of F.entries())U.push($(q,V,F));return U}asValueMap(){const $=new Map;for(const[U,F]of this._map.entries())F.expiresAt>=Date.now()&&$.set(U,F.value);return $}}var lib={},parser={},grammar={exports:{}},hasRequiredGrammar;function requireGrammar(){if(hasRequiredGrammar)return grammar.exports;hasRequiredGrammar=1;var B=grammar.exports={v:[{name:"version",reg:/^(\d*)$/}],o:[{name:"origin",reg:/^(\S*) (\d*) (\d*) (\S*) IP(\d) (\S*)/,names:["username","sessionId","sessionVersion","netType","ipVer","address"],format:"%s %s %d %s IP%d %s"}],s:[{name:"name"}],i:[{name:"description"}],u:[{name:"uri"}],e:[{name:"email"}],p:[{name:"phone"}],z:[{name:"timezones"}],r:[{name:"repeats"}],t:[{name:"timing",reg:/^(\d*) (\d*)/,names:["start","stop"],format:"%d %d"}],c:[{name:"connection",reg:/^IN IP(\d) (\S*)/,names:["version","ip"],format:"IN IP%d %s"}],b:[{push:"bandwidth",reg:/^(TIAS|AS|CT|RR|RS):(\d*)/,names:["type","limit"],format:"%s:%s"}],m:[{reg:/^(\w*) (\d*) ([\w/]*)(?: (.*))?/,names:["type","port","protocol","payloads"],format:"%s %d %s %s"}],a:[{push:"rtp",reg:/^rtpmap:(\d*) ([\w\-.]*)(?:\s*\/(\d*)(?:\s*\/(\S*))?)?/,names:["payload","codec","rate","encoding"],format:function($){return $.encoding?"rtpmap:%d %s/%s/%s":$.rate?"rtpmap:%d %s/%s":"rtpmap:%d %s"}},{push:"fmtp",reg:/^fmtp:(\d*) ([\S| ]*)/,names:["payload","config"],format:"fmtp:%d %s"},{name:"control",reg:/^control:(.*)/,format:"control:%s"},{name:"rtcp",reg:/^rtcp:(\d*)(?: (\S*) IP(\d) (\S*))?/,names:["port","netType","ipVer","address"],format:function($){return $.address!=null?"rtcp:%d %s IP%d %s":"rtcp:%d"}},{push:"rtcpFbTrrInt",reg:/^rtcp-fb:(\*|\d*) trr-int (\d*)/,names:["payload","value"],format:"rtcp-fb:%s trr-int %d"},{push:"rtcpFb",reg:/^rtcp-fb:(\*|\d*) ([\w-_]*)(?: ([\w-_]*))?/,names:["payload","type","subtype"],format:function($){return $.subtype!=null?"rtcp-fb:%s %s %s":"rtcp-fb:%s %s"}},{push:"ext",reg:/^extmap:(\d+)(?:\/(\w+))?(?: (urn:ietf:params:rtp-hdrext:encrypt))? (\S*)(?: (\S*))?/,names:["value","direction","encrypt-uri","uri","config"],format:function($){return"extmap:%d"+($.direction?"/%s":"%v")+($["encrypt-uri"]?" %s":"%v")+" %s"+($.config?" %s":"")}},{name:"extmapAllowMixed",reg:/^(extmap-allow-mixed)/},{push:"crypto",reg:/^crypto:(\d*) ([\w_]*) (\S*)(?: (\S*))?/,names:["id","suite","config","sessionConfig"],format:function($){return $.sessionConfig!=null?"crypto:%d %s %s %s":"crypto:%d %s %s"}},{name:"setup",reg:/^setup:(\w*)/,format:"setup:%s"},{name:"connectionType",reg:/^connection:(new|existing)/,format:"connection:%s"},{name:"mid",reg:/^mid:([^\s]*)/,format:"mid:%s"},{name:"msid",reg:/^msid:(.*)/,format:"msid:%s"},{name:"ptime",reg:/^ptime:(\d*(?:\.\d*)*)/,format:"ptime:%d"},{name:"maxptime",reg:/^maxptime:(\d*(?:\.\d*)*)/,format:"maxptime:%d"},{name:"direction",reg:/^(sendrecv|recvonly|sendonly|inactive)/},{name:"icelite",reg:/^(ice-lite)/},{name:"iceUfrag",reg:/^ice-ufrag:(\S*)/,format:"ice-ufrag:%s"},{name:"icePwd",reg:/^ice-pwd:(\S*)/,format:"ice-pwd:%s"},{name:"fingerprint",reg:/^fingerprint:(\S*) (\S*)/,names:["type","hash"],format:"fingerprint:%s %s"},{push:"candidates",reg:/^candidate:(\S*) (\d*) (\S*) (\d*) (\S*) (\d*) typ (\S*)(?: raddr (\S*) rport (\d*))?(?: tcptype (\S*))?(?: generation (\d*))?(?: network-id (\d*))?(?: network-cost (\d*))?/,names:["foundation","component","transport","priority","ip","port","type","raddr","rport","tcptype","generation","network-id","network-cost"],format:function($){var U="candidate:%s %d %s %d %s %d typ %s";return U+=$.raddr!=null?" raddr %s rport %d":"%v%v",U+=$.tcptype!=null?" tcptype %s":"%v",$.generation!=null&&(U+=" generation %d"),U+=$["network-id"]!=null?" network-id %d":"%v",U+=$["network-cost"]!=null?" network-cost %d":"%v",U}},{name:"endOfCandidates",reg:/^(end-of-candidates)/},{name:"remoteCandidates",reg:/^remote-candidates:(.*)/,format:"remote-candidates:%s"},{name:"iceOptions",reg:/^ice-options:(\S*)/,format:"ice-options:%s"},{push:"ssrcs",reg:/^ssrc:(\d*) ([\w_-]*)(?::(.*))?/,names:["id","attribute","value"],format:function($){var U="ssrc:%d";return $.attribute!=null&&(U+=" %s",$.value!=null&&(U+=":%s")),U}},{push:"ssrcGroups",reg:/^ssrc-group:([\x21\x23\x24\x25\x26\x27\x2A\x2B\x2D\x2E\w]*) (.*)/,names:["semantics","ssrcs"],format:"ssrc-group:%s %s"},{name:"msidSemantic",reg:/^msid-semantic:\s?(\w*) (\S*)/,names:["semantic","token"],format:"msid-semantic: %s %s"},{push:"groups",reg:/^group:(\w*) (.*)/,names:["type","mids"],format:"group:%s %s"},{name:"rtcpMux",reg:/^(rtcp-mux)/},{name:"rtcpRsize",reg:/^(rtcp-rsize)/},{name:"sctpmap",reg:/^sctpmap:([\w_/]*) (\S*)(?: (\S*))?/,names:["sctpmapNumber","app","maxMessageSize"],format:function($){return $.maxMessageSize!=null?"sctpmap:%s %s %s":"sctpmap:%s %s"}},{name:"xGoogleFlag",reg:/^x-google-flag:([^\s]*)/,format:"x-google-flag:%s"},{push:"rids",reg:/^rid:([\d\w]+) (\w+)(?: ([\S| ]*))?/,names:["id","direction","params"],format:function($){return $.params?"rid:%s %s %s":"rid:%s %s"}},{push:"imageattrs",reg:new RegExp("^imageattr:(\\d+|\\*)[\\s\\t]+(send|recv)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*)(?:[\\s\\t]+(recv|send)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*))?"),names:["pt","dir1","attrs1","dir2","attrs2"],format:function($){return"imageattr:%s %s %s"+($.dir2?" %s %s":"")}},{name:"simulcast",reg:new RegExp("^simulcast:(send|recv) ([a-zA-Z0-9\\-_~;,]+)(?:\\s?(send|recv) ([a-zA-Z0-9\\-_~;,]+))?$"),names:["dir1","list1","dir2","list2"],format:function($){return"simulcast:%s %s"+($.dir2?" %s %s":"")}},{name:"simulcast_03",reg:/^simulcast:[\s\t]+([\S+\s\t]+)$/,names:["value"],format:"simulcast: %s"},{name:"framerate",reg:/^framerate:(\d+(?:$|\.\d+))/,format:"framerate:%s"},{name:"sourceFilter",reg:/^source-filter: *(excl|incl) (\S*) (IP4|IP6|\*) (\S*) (.*)/,names:["filterMode","netType","addressTypes","destAddress","srcList"],format:"source-filter: %s %s %s %s %s"},{name:"bundleOnly",reg:/^(bundle-only)/},{name:"label",reg:/^label:(.+)/,format:"label:%s"},{name:"sctpPort",reg:/^sctp-port:(\d+)$/,format:"sctp-port:%s"},{name:"maxMessageSize",reg:/^max-message-size:(\d+)$/,format:"max-message-size:%s"},{push:"tsRefClocks",reg:/^ts-refclk:([^\s=]*)(?:=(\S*))?/,names:["clksrc","clksrcExt"],format:function($){return"ts-refclk:%s"+($.clksrcExt!=null?"=%s":"")}},{name:"mediaClk",reg:/^mediaclk:(?:id=(\S*))? *([^\s=]*)(?:=(\S*))?(?: *rate=(\d+)\/(\d+))?/,names:["id","mediaClockName","mediaClockValue","rateNumerator","rateDenominator"],format:function($){var U="mediaclk:";return U+=$.id!=null?"id=%s %s":"%v%s",U+=$.mediaClockValue!=null?"=%s":"",U+=$.rateNumerator!=null?" rate=%s":"",U+=$.rateDenominator!=null?"/%s":"",U}},{name:"keywords",reg:/^keywds:(.+)$/,format:"keywds:%s"},{name:"content",reg:/^content:(.+)/,format:"content:%s"},{name:"bfcpFloorCtrl",reg:/^floorctrl:(c-only|s-only|c-s)/,format:"floorctrl:%s"},{name:"bfcpConfId",reg:/^confid:(\d+)/,format:"confid:%s"},{name:"bfcpUserId",reg:/^userid:(\d+)/,format:"userid:%s"},{name:"bfcpFloorId",reg:/^floorid:(.+) (?:m-stream|mstrm):(.+)/,names:["id","mStream"],format:"floorid:%s mstrm:%s"},{push:"invalid",names:["value"]}]};return Object.keys(B).forEach(function($){var U=B[$];U.forEach(function(F){F.reg||(F.reg=/(.*)/),F.format||(F.format="%s")})}),grammar.exports}var hasRequiredParser;function requireParser(){return hasRequiredParser||(hasRequiredParser=1,(function(B){var $=function(W){return String(Number(W))===W?Number(W):W},U=function(W,K,G,z){if(z&&!G)K[z]=$(W[1]);else for(var H=0;H<G.length;H+=1)W[H+1]!=null&&(K[G[H]]=$(W[H+1]))},F=function(W,K,G){var z=W.name&&W.names;W.push&&!K[W.push]?K[W.push]=[]:z&&!K[W.name]&&(K[W.name]={});var H=W.push?{}:z?K[W.name]:K;U(G.match(W.reg),H,W.names,W.name),W.push&&K[W.push].push(H)},V=requireGrammar(),q=RegExp.prototype.test.bind(/^([a-z])=(.*)/);B.parse=function(W){var K={},G=[],z=K;return W.split(/(\r\n|\r|\n)/).filter(q).forEach(function(H){var Q=H[0],Y=H.slice(2);Q==="m"&&(G.push({rtp:[],fmtp:[]}),z=G[G.length-1]);for(var X=0;X<(V[Q]||[]).length;X+=1){var Z=V[Q][X];if(Z.reg.test(Y))return F(Z,z,Y)}}),K.media=G,K};var j=function(W,K){var G=K.split(/=(.+)/,2);return G.length===2?W[G[0]]=$(G[1]):G.length===1&&K.length>1&&(W[G[0]]=void 0),W};B.parseParams=function(W){return W.split(/;\s?/).reduce(j,{})},B.parseFmtpConfig=B.parseParams,B.parsePayloads=function(W){return W.toString().split(" ").map(Number)},B.parseRemoteCandidates=function(W){for(var K=[],G=W.split(" ").map($),z=0;z<G.length;z+=3)K.push({component:G[z],ip:G[z+1],port:G[z+2]});return K},B.parseImageAttributes=function(W){return W.split(" ").map(function(K){return K.substring(1,K.length-1).split(",").reduce(j,{})})},B.parseSimulcastStreamList=function(W){return W.split(";").map(function(K){return K.split(",").map(function(G){var z,H=!1;return G[0]!=="~"?z=$(G):(z=$(G.substring(1,G.length)),H=!0),{scid:z,paused:H}})})}})(parser)),parser}var writer,hasRequiredWriter;function requireWriter(){if(hasRequiredWriter)return writer;hasRequiredWriter=1;var B=requireGrammar(),$=/%[sdv%]/g,U=function(j){var W=1,K=arguments,G=K.length;return j.replace($,function(z){if(W>=G)return z;var H=K[W];switch(W+=1,z){case"%%":return"%";case"%s":return String(H);case"%d":return Number(H);case"%v":return""}})},F=function(j,W,K){var G=W.format instanceof Function?W.format(W.push?K:K[W.name]):W.format,z=[j+"="+G];if(W.names)for(var H=0;H<W.names.length;H+=1){var Q=W.names[H];W.name?z.push(K[W.name][Q]):z.push(K[W.names[H]])}else z.push(K[W.name]);return U.apply(null,z)},V=["v","o","s","i","u","e","p","c","b","t","r","z","a"],q=["i","c","b","a"];return writer=function(j,W){W=W||{},j.version==null&&(j.version=0),j.name==null&&(j.name=" "),j.media.forEach(function(H){H.payloads==null&&(H.payloads="")});var K=W.outerOrder||V,G=W.innerOrder||q,z=[];return K.forEach(function(H){B[H].forEach(function(Q){Q.name in j&&j[Q.name]!=null?z.push(F(H,Q,j)):Q.push in j&&j[Q.push]!=null&&j[Q.push].forEach(function(Y){z.push(F(H,Q,Y))})})}),j.media.forEach(function(H){z.push(F("m",B.m[0],H)),G.forEach(function(Q){B[Q].forEach(function(Y){Y.name in H&&H[Y.name]!=null?z.push(F(Q,Y,H)):Y.push in H&&H[Y.push]!=null&&H[Y.push].forEach(function(X){z.push(F(Q,Y,X))})})})}),z.join(`\r
`)+`\r
`},writer}var hasRequiredLib;function requireLib(){if(hasRequiredLib)return lib;hasRequiredLib=1;var B=requireParser(),$=requireWriter(),U=requireGrammar();return lib.grammar=U,lib.write=$,lib.parse=B.parse,lib.parseParams=B.parseParams,lib.parseFmtpConfig=B.parseFmtpConfig,lib.parsePayloads=B.parsePayloads,lib.parseRemoteCandidates=B.parseRemoteCandidates,lib.parseImageAttributes=B.parseImageAttributes,lib.parseSimulcastStreamList=B.parseSimulcastStreamList,lib}var libExports=requireLib();function r(B,$,U){var F,V,q;$===void 0&&($=50),U===void 0&&(U={});var j=(F=U.isImmediate)!=null&&F,W=(V=U.callback)!=null&&V,K=U.maxWait,G=Date.now(),z=[];function H(){if(K!==void 0){var Y=Date.now()-G;if(Y+$>=K)return K-Y}return $}var Q=function(){var Y=[].slice.call(arguments),X=this;return new Promise(function(Z,ne){var ee=j&&q===void 0;if(q!==void 0&&clearTimeout(q),q=setTimeout(function(){if(q=void 0,G=Date.now(),!j){var se=B.apply(X,Y);W&&W(se),z.forEach(function(te){return(0,te.resolve)(se)}),z=[]}},H()),ee){var ie=B.apply(X,Y);return W&&W(ie),Z(ie)}z.push({resolve:Z,reject:ne})})};return Q.cancel=function(Y){q!==void 0&&clearTimeout(q),z.forEach(function(X){return(0,X.reject)(Y)}),z=[]},Q}const startBitrateForSVC=.7,debounceInterval=20,PCEvents={NegotiationStarted:"negotiationStarted",NegotiationComplete:"negotiationComplete",RTPVideoPayloadTypes:"rtpVideoPayloadTypes"};class PCTransport extends eventsExports.EventEmitter{get pc(){return this._pc||(this._pc=this.createPC()),this._pc}constructor($){let U=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};var F;super(),this.log=livekitLogger,this.ddExtID=0,this.latestOfferId=0,this.pendingCandidates=[],this.restartingIce=!1,this.renegotiate=!1,this.trackBitrates=[],this.remoteStereoMids=[],this.remoteNackMids=[],this.negotiate=r(V=>__awaiter(this,void 0,void 0,function*(){this.emit(PCEvents.NegotiationStarted);try{yield this.createAndSendOffer()}catch(q){if(V)V(q);else throw q}}),debounceInterval),this.close=()=>{this._pc&&(this._pc.close(),this._pc.onconnectionstatechange=null,this._pc.oniceconnectionstatechange=null,this._pc.onicegatheringstatechange=null,this._pc.ondatachannel=null,this._pc.onnegotiationneeded=null,this._pc.onsignalingstatechange=null,this._pc.onicecandidate=null,this._pc.ondatachannel=null,this._pc.ontrack=null,this._pc.onconnectionstatechange=null,this._pc.oniceconnectionstatechange=null,this._pc=null)},this.log=getLogger((F=U.loggerName)!==null&&F!==void 0?F:LoggerNames.PCTransport),this.loggerOptions=U,this.config=$,this._pc=this.createPC(),this.offerLock=new _}createPC(){const $=new RTCPeerConnection(this.config);return $.onicecandidate=U=>{var F;U.candidate&&((F=this.onIceCandidate)===null||F===void 0||F.call(this,U.candidate))},$.onicecandidateerror=U=>{var F;(F=this.onIceCandidateError)===null||F===void 0||F.call(this,U)},$.oniceconnectionstatechange=()=>{var U;(U=this.onIceConnectionStateChange)===null||U===void 0||U.call(this,$.iceConnectionState)},$.onsignalingstatechange=()=>{var U;(U=this.onSignalingStatechange)===null||U===void 0||U.call(this,$.signalingState)},$.onconnectionstatechange=()=>{var U;(U=this.onConnectionStateChange)===null||U===void 0||U.call(this,$.connectionState)},$.ondatachannel=U=>{var F;(F=this.onDataChannel)===null||F===void 0||F.call(this,U)},$.ontrack=U=>{var F;(F=this.onTrack)===null||F===void 0||F.call(this,U)},$}get logContext(){var $,U;return Object.assign({},(U=($=this.loggerOptions).loggerContextCb)===null||U===void 0?void 0:U.call($))}get isICEConnected(){return this._pc!==null&&(this.pc.iceConnectionState==="connected"||this.pc.iceConnectionState==="completed")}addIceCandidate($){return __awaiter(this,void 0,void 0,function*(){if(this.pc.remoteDescription&&!this.restartingIce)return this.pc.addIceCandidate($);this.pendingCandidates.push($)})}setRemoteDescription($,U){return __awaiter(this,void 0,void 0,function*(){var F;if($.type==="answer"&&this.latestOfferId>0&&U>0&&U!==this.latestOfferId)return this.log.warn("ignoring answer for old offer",Object.assign(Object.assign({},this.logContext),{offerId:U,latestOfferId:this.latestOfferId})),!1;let V;if($.type==="offer"){let{stereoMids:q,nackMids:j}=extractStereoAndNackAudioFromOffer($);this.remoteStereoMids=q,this.remoteNackMids=j}else if($.type==="answer"){const q=libExports.parse((F=$.sdp)!==null&&F!==void 0?F:"");q.media.forEach(j=>{const W=getMidString(j.mid);j.type==="audio"&&this.trackBitrates.some(K=>{if(!K.transceiver||W!=K.transceiver.mid)return!1;let G=0;if(j.rtp.some(H=>H.codec.toUpperCase()===K.codec.toUpperCase()?(G=H.payload,!0):!1),G===0)return!0;let z=!1;for(const H of j.fmtp)if(H.payload===G){H.config=H.config.split(";").filter(Q=>!Q.includes("maxaveragebitrate")).join(";"),K.maxbr>0&&(H.config+=";maxaveragebitrate=".concat(K.maxbr*1e3)),z=!0;break}return z||K.maxbr>0&&j.fmtp.push({payload:G,config:"maxaveragebitrate=".concat(K.maxbr*1e3)}),!0})}),V=libExports.write(q)}return yield this.setMungedSDP($,V,!0),this.pendingCandidates.forEach(q=>{this.pc.addIceCandidate(q)}),this.pendingCandidates=[],this.restartingIce=!1,this.renegotiate?(this.renegotiate=!1,yield this.createAndSendOffer()):$.type==="answer"&&(this.emit(PCEvents.NegotiationComplete),$.sdp&&libExports.parse($.sdp).media.forEach(j=>{j.type==="video"&&this.emit(PCEvents.RTPVideoPayloadTypes,j.rtp)})),!0})}createAndSendOffer($){return __awaiter(this,void 0,void 0,function*(){var U;const F=yield this.offerLock.lock();try{if(this.onOffer===void 0)return;if($?.iceRestart&&(this.log.debug("restarting ICE",this.logContext),this.restartingIce=!0),this._pc&&this._pc.signalingState==="have-local-offer"){const W=this._pc.remoteDescription;if($?.iceRestart&&W)yield this._pc.setRemoteDescription(W);else{this.renegotiate=!0;return}}else if(!this._pc||this._pc.signalingState==="closed"){this.log.warn("could not createOffer with closed peer connection",this.logContext);return}this.log.debug("starting to negotiate",this.logContext);const V=this.latestOfferId+1;this.latestOfferId=V;const q=yield this.pc.createOffer($);this.log.debug("original offer",Object.assign({sdp:q.sdp},this.logContext));const j=libExports.parse((U=q.sdp)!==null&&U!==void 0?U:"");if(j.media.forEach(W=>{ensureIPAddrMatchVersion(W),W.type==="audio"?ensureAudioNackAndStereo(W,[],[]):W.type==="video"&&this.trackBitrates.some(K=>{if(!W.msid||!K.cid||!W.msid.includes(K.cid))return!1;let G=0;if(W.rtp.some(H=>H.codec.toUpperCase()===K.codec.toUpperCase()?(G=H.payload,!0):!1),G===0||(isSVCCodec(K.codec)&&!isSafari()&&this.ensureVideoDDExtensionForSVC(W,j),K.codec!=="av1"))return!0;const z=Math.round(K.maxbr*startBitrateForSVC);for(const H of W.fmtp)if(H.payload===G){H.config.includes("x-google-start-bitrate")||(H.config+=";x-google-start-bitrate=".concat(z));break}return!0})}),this.latestOfferId>V){this.log.warn("latestOfferId mismatch",Object.assign(Object.assign({},this.logContext),{latestOfferId:this.latestOfferId,offerId:V}));return}yield this.setMungedSDP(q,libExports.write(j)),this.onOffer(q,this.latestOfferId)}finally{F()}})}createAndSetAnswer(){return __awaiter(this,void 0,void 0,function*(){var $;const U=yield this.pc.createAnswer(),F=libExports.parse(($=U.sdp)!==null&&$!==void 0?$:"");return F.media.forEach(V=>{ensureIPAddrMatchVersion(V),V.type==="audio"&&ensureAudioNackAndStereo(V,this.remoteStereoMids,this.remoteNackMids)}),yield this.setMungedSDP(U,libExports.write(F)),U})}createDataChannel($,U){return this.pc.createDataChannel($,U)}addTransceiver($,U){return this.pc.addTransceiver($,U)}addTrack($){if(!this._pc)throw new UnexpectedConnectionState("PC closed, cannot add track");return this._pc.addTrack($)}setTrackCodecBitrate($){this.trackBitrates.push($)}setConfiguration($){var U;if(!this._pc)throw new UnexpectedConnectionState("PC closed, cannot configure");return(U=this._pc)===null||U===void 0?void 0:U.setConfiguration($)}canRemoveTrack(){var $;return!!(!(($=this._pc)===null||$===void 0)&&$.removeTrack)}removeTrack($){var U;return(U=this._pc)===null||U===void 0?void 0:U.removeTrack($)}getConnectionState(){var $,U;return(U=($=this._pc)===null||$===void 0?void 0:$.connectionState)!==null&&U!==void 0?U:"closed"}getICEConnectionState(){var $,U;return(U=($=this._pc)===null||$===void 0?void 0:$.iceConnectionState)!==null&&U!==void 0?U:"closed"}getSignallingState(){var $,U;return(U=($=this._pc)===null||$===void 0?void 0:$.signalingState)!==null&&U!==void 0?U:"closed"}getTransceivers(){var $,U;return(U=($=this._pc)===null||$===void 0?void 0:$.getTransceivers())!==null&&U!==void 0?U:[]}getSenders(){var $,U;return(U=($=this._pc)===null||$===void 0?void 0:$.getSenders())!==null&&U!==void 0?U:[]}getLocalDescription(){var $;return($=this._pc)===null||$===void 0?void 0:$.localDescription}getRemoteDescription(){var $;return($=this.pc)===null||$===void 0?void 0:$.remoteDescription}getStats(){return this.pc.getStats()}getConnectedAddress(){return __awaiter(this,void 0,void 0,function*(){var $;if(!this._pc)return;let U="";const F=new Map,V=new Map;if((yield this._pc.getStats()).forEach(W=>{switch(W.type){case"transport":U=W.selectedCandidatePairId;break;case"candidate-pair":U===""&&W.selected&&(U=W.id),F.set(W.id,W);break;case"remote-candidate":V.set(W.id,"".concat(W.address,":").concat(W.port));break}}),U==="")return;const j=($=F.get(U))===null||$===void 0?void 0:$.remoteCandidateId;if(j!==void 0)return V.get(j)})}setMungedSDP($,U,F){return __awaiter(this,void 0,void 0,function*(){if(U){const V=$.sdp;$.sdp=U;try{this.log.debug("setting munged ".concat(F?"remote":"local"," description"),this.logContext),F?yield this.pc.setRemoteDescription($):yield this.pc.setLocalDescription($);return}catch(q){this.log.warn("not able to set ".concat($.type,", falling back to unmodified sdp"),Object.assign(Object.assign({},this.logContext),{error:q,sdp:U})),$.sdp=V}}try{F?yield this.pc.setRemoteDescription($):yield this.pc.setLocalDescription($)}catch(V){let q="unknown error";V instanceof Error?q=V.message:typeof V=="string"&&(q=V);const j={error:q,sdp:$.sdp};throw!F&&this.pc.remoteDescription&&(j.remoteSdp=this.pc.remoteDescription),this.log.error("unable to set ".concat($.type),Object.assign(Object.assign({},this.logContext),{fields:j})),new NegotiationError(q)}})}ensureVideoDDExtensionForSVC($,U){var F,V;if(!((F=$.ext)===null||F===void 0?void 0:F.some(j=>j.uri===ddExtensionURI))){if(this.ddExtID===0){let j=0;U.media.forEach(W=>{var K;W.type==="video"&&((K=W.ext)===null||K===void 0||K.forEach(G=>{G.value>j&&(j=G.value)}))}),this.ddExtID=j+1}(V=$.ext)===null||V===void 0||V.push({value:this.ddExtID,uri:ddExtensionURI})}}}function ensureAudioNackAndStereo(B,$,U){const F=getMidString(B.mid);let V=0;B.rtp.some(q=>q.codec==="opus"?(V=q.payload,!0):!1),V>0&&(B.rtcpFb||(B.rtcpFb=[]),U.includes(F)&&!B.rtcpFb.some(q=>q.payload===V&&q.type==="nack")&&B.rtcpFb.push({payload:V,type:"nack"}),$.includes(F)&&B.fmtp.some(q=>q.payload===V?(q.config.includes("stereo=1")||(q.config+=";stereo=1"),!0):!1))}function extractStereoAndNackAudioFromOffer(B){var $;const U=[],F=[],V=libExports.parse(($=B.sdp)!==null&&$!==void 0?$:"");let q=0;return V.media.forEach(j=>{var W;const K=getMidString(j.mid);j.type==="audio"&&(j.rtp.some(G=>G.codec==="opus"?(q=G.payload,!0):!1),!((W=j.rtcpFb)===null||W===void 0)&&W.some(G=>G.payload===q&&G.type==="nack")&&F.push(K),j.fmtp.some(G=>G.payload===q?(G.config.includes("sprop-stereo=1")&&U.push(K),!0):!1))}),{stereoMids:U,nackMids:F}}function ensureIPAddrMatchVersion(B){if(B.connection){const $=B.connection.ip.indexOf(":")>=0;(B.connection.version===4&&$||B.connection.version===6&&!$)&&(B.connection.ip="0.0.0.0",B.connection.version=4)}}function getMidString(B){return typeof B=="number"?B.toFixed(0):B}const defaultVideoCodec="vp8",publishDefaults={audioPreset:AudioPresets.music,dtx:!0,red:!0,forceStereo:!1,simulcast:!0,screenShareEncoding:ScreenSharePresets.h1080fps15.encoding,stopMicTrackOnMute:!1,videoCodec:defaultVideoCodec,backupCodec:!0,preConnectBuffer:!1},audioDefaults={deviceId:{ideal:"default"},autoGainControl:!0,echoCancellation:!0,noiseSuppression:!0,voiceIsolation:!0},videoDefaults={deviceId:{ideal:"default"},resolution:VideoPresets.h720.resolution},roomOptionDefaults={adaptiveStream:!1,dynacast:!1,stopLocalTrackOnUnpublish:!0,reconnectPolicy:new DefaultReconnectPolicy,disconnectOnPageLeave:!0,webAudioMix:!1},roomConnectOptionDefaults={autoSubscribe:!0,maxRetries:1,peerConnectionTimeout:15e3,websocketTimeout:15e3};var PCTransportState;(function(B){B[B.NEW=0]="NEW",B[B.CONNECTING=1]="CONNECTING",B[B.CONNECTED=2]="CONNECTED",B[B.FAILED=3]="FAILED",B[B.CLOSING=4]="CLOSING",B[B.CLOSED=5]="CLOSED"})(PCTransportState||(PCTransportState={}));class PCTransportManager{get needsPublisher(){return this.isPublisherConnectionRequired}get needsSubscriber(){return this.isSubscriberConnectionRequired}get currentState(){return this.state}constructor($,U,F){var V;this.peerConnectionTimeout=roomConnectOptionDefaults.peerConnectionTimeout,this.log=livekitLogger,this.updateState=()=>{var q;const j=this.state,W=this.requiredTransports.map(K=>K.getConnectionState());W.every(K=>K==="connected")?this.state=PCTransportState.CONNECTED:W.some(K=>K==="failed")?this.state=PCTransportState.FAILED:W.some(K=>K==="connecting")?this.state=PCTransportState.CONNECTING:W.every(K=>K==="closed")?this.state=PCTransportState.CLOSED:W.some(K=>K==="closed")?this.state=PCTransportState.CLOSING:W.every(K=>K==="new")&&(this.state=PCTransportState.NEW),j!==this.state&&(this.log.debug("pc state change: from ".concat(PCTransportState[j]," to ").concat(PCTransportState[this.state]),this.logContext),(q=this.onStateChange)===null||q===void 0||q.call(this,this.state,this.publisher.getConnectionState(),this.subscriber.getConnectionState()))},this.log=getLogger((V=F.loggerName)!==null&&V!==void 0?V:LoggerNames.PCManager),this.loggerOptions=F,this.isPublisherConnectionRequired=!U,this.isSubscriberConnectionRequired=U,this.publisher=new PCTransport($,F),this.subscriber=new PCTransport($,F),this.publisher.onConnectionStateChange=this.updateState,this.subscriber.onConnectionStateChange=this.updateState,this.publisher.onIceConnectionStateChange=this.updateState,this.subscriber.onIceConnectionStateChange=this.updateState,this.publisher.onSignalingStatechange=this.updateState,this.subscriber.onSignalingStatechange=this.updateState,this.publisher.onIceCandidate=q=>{var j;(j=this.onIceCandidate)===null||j===void 0||j.call(this,q,SignalTarget.PUBLISHER)},this.subscriber.onIceCandidate=q=>{var j;(j=this.onIceCandidate)===null||j===void 0||j.call(this,q,SignalTarget.SUBSCRIBER)},this.subscriber.onDataChannel=q=>{var j;(j=this.onDataChannel)===null||j===void 0||j.call(this,q)},this.subscriber.onTrack=q=>{var j;(j=this.onTrack)===null||j===void 0||j.call(this,q)},this.publisher.onOffer=(q,j)=>{var W;(W=this.onPublisherOffer)===null||W===void 0||W.call(this,q,j)},this.state=PCTransportState.NEW,this.connectionLock=new _,this.remoteOfferLock=new _}get logContext(){var $,U;return Object.assign({},(U=($=this.loggerOptions).loggerContextCb)===null||U===void 0?void 0:U.call($))}requirePublisher(){let $=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0;this.isPublisherConnectionRequired=$,this.updateState()}requireSubscriber(){let $=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0;this.isSubscriberConnectionRequired=$,this.updateState()}createAndSendPublisherOffer($){return this.publisher.createAndSendOffer($)}setPublisherAnswer($,U){return this.publisher.setRemoteDescription($,U)}removeTrack($){return this.publisher.removeTrack($)}close(){return __awaiter(this,void 0,void 0,function*(){if(this.publisher&&this.publisher.getSignallingState()!=="closed"){const $=this.publisher;for(const U of $.getSenders())try{$.canRemoveTrack()&&$.removeTrack(U)}catch(F){this.log.warn("could not removeTrack",Object.assign(Object.assign({},this.logContext),{error:F}))}}yield Promise.all([this.publisher.close(),this.subscriber.close()]),this.updateState()})}triggerIceRestart(){return __awaiter(this,void 0,void 0,function*(){this.subscriber.restartingIce=!0,this.needsPublisher&&(yield this.createAndSendPublisherOffer({iceRestart:!0}))})}addIceCandidate($,U){return __awaiter(this,void 0,void 0,function*(){U===SignalTarget.PUBLISHER?yield this.publisher.addIceCandidate($):yield this.subscriber.addIceCandidate($)})}createSubscriberAnswerFromOffer($,U){return __awaiter(this,void 0,void 0,function*(){this.log.debug("received server offer",Object.assign(Object.assign({},this.logContext),{RTCSdpType:$.type,sdp:$.sdp,signalingState:this.subscriber.getSignallingState().toString()}));const F=yield this.remoteOfferLock.lock();try{return(yield this.subscriber.setRemoteDescription($,U))?yield this.subscriber.createAndSetAnswer():void 0}finally{F()}})}updateConfiguration($,U){this.publisher.setConfiguration($),this.subscriber.setConfiguration($),U&&this.triggerIceRestart()}ensurePCTransportConnection($,U){return __awaiter(this,void 0,void 0,function*(){var F;const V=yield this.connectionLock.lock();try{this.isPublisherConnectionRequired&&this.publisher.getConnectionState()!=="connected"&&this.publisher.getConnectionState()!=="connecting"&&(this.log.debug("negotiation required, start negotiating",this.logContext),this.publisher.negotiate()),yield Promise.all((F=this.requiredTransports)===null||F===void 0?void 0:F.map(q=>this.ensureTransportConnected(q,$,U)))}finally{V()}})}negotiate($){return __awaiter(this,void 0,void 0,function*(){return new Promise((U,F)=>__awaiter(this,void 0,void 0,function*(){const V=setTimeout(()=>{F("negotiation timed out")},this.peerConnectionTimeout),q=()=>{clearTimeout(V),F("negotiation aborted")};$.signal.addEventListener("abort",q),this.publisher.once(PCEvents.NegotiationStarted,()=>{$.signal.aborted||this.publisher.once(PCEvents.NegotiationComplete,()=>{clearTimeout(V),U()})}),yield this.publisher.negotiate(j=>{clearTimeout(V),F(j)})}))})}addPublisherTransceiver($,U){return this.publisher.addTransceiver($,U)}addPublisherTrack($){return this.publisher.addTrack($)}createPublisherDataChannel($,U){return this.publisher.createDataChannel($,U)}getConnectedAddress($){return $===SignalTarget.PUBLISHER?this.publisher.getConnectedAddress():$===SignalTarget.SUBSCRIBER?this.publisher.getConnectedAddress():this.requiredTransports[0].getConnectedAddress()}get requiredTransports(){const $=[];return this.isPublisherConnectionRequired&&$.push(this.publisher),this.isSubscriberConnectionRequired&&$.push(this.subscriber),$}ensureTransportConnected($,U){return __awaiter(this,arguments,void 0,function(F,V){var q=this;let j=arguments.length>2&&arguments[2]!==void 0?arguments[2]:this.peerConnectionTimeout;return(function*(){if(F.getConnectionState()!=="connected")return new Promise((K,G)=>__awaiter(q,void 0,void 0,function*(){const z=()=>{this.log.warn("abort transport connection",this.logContext),CriticalTimers.clearTimeout(H),G(new ConnectionError("room connection has been cancelled",ConnectionErrorReason.Cancelled))};V?.signal.aborted&&z(),V?.signal.addEventListener("abort",z);const H=CriticalTimers.setTimeout(()=>{V?.signal.removeEventListener("abort",z),G(new ConnectionError("could not establish pc connection",ConnectionErrorReason.InternalError))},j);for(;this.state!==PCTransportState.CONNECTED;)if(yield sleep(50),V?.signal.aborted){G(new ConnectionError("room connection has been cancelled",ConnectionErrorReason.Cancelled));return}CriticalTimers.clearTimeout(H),V?.signal.removeEventListener("abort",z),K()}))})()})}}class RpcError extends Error{constructor($,U,F){super(U),this.code=$,this.message=truncateBytes(U,RpcError.MAX_MESSAGE_BYTES),this.data=F?truncateBytes(F,RpcError.MAX_DATA_BYTES):void 0}static fromProto($){return new RpcError($.code,$.message,$.data)}toProto(){return new RpcError$1({code:this.code,message:this.message,data:this.data})}static builtIn($,U){return new RpcError(RpcError.ErrorCode[$],RpcError.ErrorMessage[$],U)}}RpcError.MAX_MESSAGE_BYTES=256,RpcError.MAX_DATA_BYTES=15360,RpcError.ErrorCode={APPLICATION_ERROR:1500,CONNECTION_TIMEOUT:1501,RESPONSE_TIMEOUT:1502,RECIPIENT_DISCONNECTED:1503,RESPONSE_PAYLOAD_TOO_LARGE:1504,SEND_FAILED:1505,UNSUPPORTED_METHOD:1400,RECIPIENT_NOT_FOUND:1401,REQUEST_PAYLOAD_TOO_LARGE:1402,UNSUPPORTED_SERVER:1403,UNSUPPORTED_VERSION:1404},RpcError.ErrorMessage={APPLICATION_ERROR:"Application error in method handler",CONNECTION_TIMEOUT:"Connection timeout",RESPONSE_TIMEOUT:"Response timeout",RECIPIENT_DISCONNECTED:"Recipient disconnected",RESPONSE_PAYLOAD_TOO_LARGE:"Response payload too large",SEND_FAILED:"Failed to send",UNSUPPORTED_METHOD:"Method not supported at destination",RECIPIENT_NOT_FOUND:"Recipient not found",REQUEST_PAYLOAD_TOO_LARGE:"Request payload too large",UNSUPPORTED_SERVER:"RPC not supported by server",UNSUPPORTED_VERSION:"Unsupported RPC version"};const MAX_PAYLOAD_BYTES=15360;function byteLength(B){return new TextEncoder().encode(B).length}function truncateBytes(B,$){if(byteLength(B)<=$)return B;let U=0,F=B.length;const V=new TextEncoder;for(;U<F;){const q=Math.floor((U+F+1)/2);V.encode(B.slice(0,q)).length<=$?U=q:F=q-1}return B.slice(0,U)}const monitorFrequency=2e3;function computeBitrate(B,$){if(!$)return 0;let U,F;return"bytesReceived"in B?(U=B.bytesReceived,F=$.bytesReceived):"bytesSent"in B&&(U=B.bytesSent,F=$.bytesSent),U===void 0||F===void 0||B.timestamp===void 0||$.timestamp===void 0?0:(U-F)*8*1e3/(B.timestamp-$.timestamp)}const isMediaRecorderAvailable=typeof MediaRecorder<"u";class FallbackRecorder{constructor(){throw new Error("MediaRecorder is not available in this environment")}}const RecorderBase=isMediaRecorderAvailable?MediaRecorder:FallbackRecorder;class LocalTrackRecorder extends RecorderBase{constructor($,U){if(!isMediaRecorderAvailable)throw new Error("MediaRecorder is not available in this environment");super(new MediaStream([$.mediaStreamTrack]),U);let F,V;const q=()=>V===void 0,j=()=>{this.removeEventListener("dataavailable",F),this.removeEventListener("stop",j),this.removeEventListener("error",W),V?.close(),V=void 0},W=K=>{V?.error(K),this.removeEventListener("dataavailable",F),this.removeEventListener("stop",j),this.removeEventListener("error",W),V=void 0};this.byteStream=new ReadableStream({start:K=>{V=K,F=G=>__awaiter(this,void 0,void 0,function*(){let z;if(G.data.arrayBuffer){const H=yield G.data.arrayBuffer();z=new Uint8Array(H)}else if(G.data.byteArray)z=G.data.byteArray;else throw new Error("no data available!");q()||K.enqueue(z)}),this.addEventListener("dataavailable",F)},cancel:()=>{j()}}),this.addEventListener("stop",j),this.addEventListener("error",W)}}function isRecordingSupported(){return isMediaRecorderAvailable}const DEFAULT_DIMENSIONS_TIMEOUT=1e3,PRE_CONNECT_BUFFER_TIMEOUT=1e4;class LocalTrack extends Track{get sender(){return this._sender}set sender($){this._sender=$}get constraints(){return this._constraints}get hasPreConnectBuffer(){return!!this.localTrackRecorder}constructor($,U,F){let V=arguments.length>3&&arguments[3]!==void 0?arguments[3]:!1,q=arguments.length>4?arguments[4]:void 0;super($,U,q),this.manuallyStopped=!1,this._isUpstreamPaused=!1,this.handleTrackMuteEvent=()=>this.debouncedTrackMuteHandler().catch(()=>this.log.debug("track mute bounce got cancelled by an unmute event",this.logContext)),this.debouncedTrackMuteHandler=r(()=>__awaiter(this,void 0,void 0,function*(){yield this.pauseUpstream()}),5e3),this.handleTrackUnmuteEvent=()=>__awaiter(this,void 0,void 0,function*(){this.debouncedTrackMuteHandler.cancel("unmute"),yield this.resumeUpstream()}),this.handleEnded=()=>{this.isInBackground&&(this.reacquireTrack=!0),this._mediaStreamTrack.removeEventListener("mute",this.handleTrackMuteEvent),this._mediaStreamTrack.removeEventListener("unmute",this.handleTrackUnmuteEvent),this.emit(TrackEvent.Ended,this)},this.reacquireTrack=!1,this.providedByUser=V,this.muteLock=new _,this.pauseUpstreamLock=new _,this.trackChangeLock=new _,this.trackChangeLock.lock().then(j=>__awaiter(this,void 0,void 0,function*(){try{yield this.setMediaStreamTrack($,!0)}finally{j()}})),this._constraints=$.getConstraints(),F&&(this._constraints=F)}get id(){return this._mediaStreamTrack.id}get dimensions(){if(this.kind!==Track.Kind.Video)return;const{width:$,height:U}=this._mediaStreamTrack.getSettings();if($&&U)return{width:$,height:U}}get isUpstreamPaused(){return this._isUpstreamPaused}get isUserProvided(){return this.providedByUser}get mediaStreamTrack(){var $,U;return(U=($=this.processor)===null||$===void 0?void 0:$.processedTrack)!==null&&U!==void 0?U:this._mediaStreamTrack}get isLocal(){return!0}getSourceTrackSettings(){return this._mediaStreamTrack.getSettings()}setMediaStreamTrack($,U){return __awaiter(this,void 0,void 0,function*(){var F;if($===this._mediaStreamTrack&&!U)return;this._mediaStreamTrack&&(this.attachedElements.forEach(q=>{detachTrack(this._mediaStreamTrack,q)}),this.debouncedTrackMuteHandler.cancel("new-track"),this._mediaStreamTrack.removeEventListener("ended",this.handleEnded),this._mediaStreamTrack.removeEventListener("mute",this.handleTrackMuteEvent),this._mediaStreamTrack.removeEventListener("unmute",this.handleTrackUnmuteEvent)),this.mediaStream=new MediaStream([$]),$&&($.addEventListener("ended",this.handleEnded),$.addEventListener("mute",this.handleTrackMuteEvent),$.addEventListener("unmute",this.handleTrackUnmuteEvent),this._constraints=$.getConstraints());let V;if(this.processor&&$){if(this.log.debug("restarting processor",this.logContext),this.kind==="unknown")throw TypeError("cannot set processor on track of unknown kind");this.processorElement&&(attachToElement($,this.processorElement),this.processorElement.muted=!0),yield this.processor.restart({track:$,kind:this.kind,element:this.processorElement}),V=this.processor.processedTrack}this.sender&&((F=this.sender.transport)===null||F===void 0?void 0:F.state)!=="closed"&&(yield this.sender.replaceTrack(V??$)),!this.providedByUser&&this._mediaStreamTrack!==$&&this._mediaStreamTrack.stop(),this._mediaStreamTrack=$,$&&(this._mediaStreamTrack.enabled=!this.isMuted,yield this.resumeUpstream(),this.attachedElements.forEach(q=>{attachToElement(V??$,q)}))})}waitForDimensions(){return __awaiter(this,arguments,void 0,function(){var $=this;let U=arguments.length>0&&arguments[0]!==void 0?arguments[0]:DEFAULT_DIMENSIONS_TIMEOUT;return(function*(){var F;if($.kind===Track.Kind.Audio)throw new Error("cannot get dimensions for audio tracks");((F=getBrowser())===null||F===void 0?void 0:F.os)==="iOS"&&(yield sleep(10));const V=Date.now();for(;Date.now()-V<U;){const q=$.dimensions;if(q)return q;yield sleep(50)}throw new TrackInvalidError("unable to get track dimensions after timeout")})()})}setDeviceId($){return __awaiter(this,void 0,void 0,function*(){return this._constraints.deviceId===$&&this._mediaStreamTrack.getSettings().deviceId===unwrapConstraint($)||(this._constraints.deviceId=$,this.isMuted)?!0:(yield this.restartTrack(),unwrapConstraint($)===this._mediaStreamTrack.getSettings().deviceId)})}getDeviceId(){return __awaiter(this,arguments,void 0,function(){var $=this;let U=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0;return(function*(){if($.source===Track.Source.ScreenShare)return;const{deviceId:F,groupId:V}=$._mediaStreamTrack.getSettings(),q=$.kind===Track.Kind.Audio?"audioinput":"videoinput";return U?DeviceManager.getInstance().normalizeDeviceId(q,F,V):F})()})}mute(){return __awaiter(this,void 0,void 0,function*(){return this.setTrackMuted(!0),this})}unmute(){return __awaiter(this,void 0,void 0,function*(){return this.setTrackMuted(!1),this})}replaceTrack($,U){return __awaiter(this,void 0,void 0,function*(){const F=yield this.trackChangeLock.lock();try{if(!this.sender)throw new TrackInvalidError("unable to replace an unpublished track");let V,q;return typeof U=="boolean"?V=U:U!==void 0&&(V=U.userProvidedTrack,q=U.stopProcessor),this.providedByUser=V??!0,this.log.debug("replace MediaStreamTrack",this.logContext),yield this.setMediaStreamTrack($),q&&this.processor&&(yield this.internalStopProcessor()),this}finally{F()}})}restart($){return __awaiter(this,void 0,void 0,function*(){this.manuallyStopped=!1;const U=yield this.trackChangeLock.lock();try{$||($=this._constraints);const{deviceId:F,facingMode:V}=$,q=__rest($,["deviceId","facingMode"]);this.log.debug("restarting track with constraints",Object.assign(Object.assign({},this.logContext),{constraints:$}));const j={audio:!1,video:!1};this.kind===Track.Kind.Video?j.video=F||V?{deviceId:F,facingMode:V}:!0:j.audio=F?Object.assign({deviceId:F},q):!0,this.attachedElements.forEach(G=>{detachTrack(this.mediaStreamTrack,G)}),this._mediaStreamTrack.removeEventListener("ended",this.handleEnded),this._mediaStreamTrack.stop();const K=(yield navigator.mediaDevices.getUserMedia(j)).getTracks()[0];return this.kind===Track.Kind.Video&&(yield K.applyConstraints(q)),K.addEventListener("ended",this.handleEnded),this.log.debug("re-acquired MediaStreamTrack",this.logContext),yield this.setMediaStreamTrack(K),this._constraints=$,this.emit(TrackEvent.Restarted,this),this.manuallyStopped&&(this.log.warn("track was stopped during a restart, stopping restarted track",this.logContext),this.stop()),this}finally{U()}})}setTrackMuted($){this.log.debug("setting ".concat(this.kind," track ").concat($?"muted":"unmuted"),this.logContext),!(this.isMuted===$&&this._mediaStreamTrack.enabled!==$)&&(this.isMuted=$,this._mediaStreamTrack.enabled=!$,this.emit($?TrackEvent.Muted:TrackEvent.Unmuted,this))}get needsReAcquisition(){return this._mediaStreamTrack.readyState!=="live"||this._mediaStreamTrack.muted||!this._mediaStreamTrack.enabled||this.reacquireTrack}handleAppVisibilityChanged(){const $=Object.create(null,{handleAppVisibilityChanged:{get:()=>super.handleAppVisibilityChanged}});return __awaiter(this,void 0,void 0,function*(){yield $.handleAppVisibilityChanged.call(this),isMobile()&&(this.log.debug("visibility changed, is in Background: ".concat(this.isInBackground),this.logContext),!this.isInBackground&&this.needsReAcquisition&&!this.isUserProvided&&!this.isMuted&&(this.log.debug("track needs to be reacquired, restarting ".concat(this.source),this.logContext),yield this.restart(),this.reacquireTrack=!1))})}stop(){var $;this.manuallyStopped=!0,super.stop(),this._mediaStreamTrack.removeEventListener("ended",this.handleEnded),this._mediaStreamTrack.removeEventListener("mute",this.handleTrackMuteEvent),this._mediaStreamTrack.removeEventListener("unmute",this.handleTrackUnmuteEvent),($=this.processor)===null||$===void 0||$.destroy(),this.processor=void 0}pauseUpstream(){return __awaiter(this,void 0,void 0,function*(){var $;const U=yield this.pauseUpstreamLock.lock();try{if(this._isUpstreamPaused===!0)return;if(!this.sender){this.log.warn("unable to pause upstream for an unpublished track",this.logContext);return}this._isUpstreamPaused=!0,this.emit(TrackEvent.UpstreamPaused,this);const F=getBrowser();if(F?.name==="Safari"&&compareVersions(F.version,"12.0")<0)throw new DeviceUnsupportedError("pauseUpstream is not supported on Safari < 12.");(($=this.sender.transport)===null||$===void 0?void 0:$.state)!=="closed"&&(yield this.sender.replaceTrack(null))}finally{U()}})}resumeUpstream(){return __awaiter(this,void 0,void 0,function*(){var $;const U=yield this.pauseUpstreamLock.lock();try{if(this._isUpstreamPaused===!1)return;if(!this.sender){this.log.warn("unable to resume upstream for an unpublished track",this.logContext);return}this._isUpstreamPaused=!1,this.emit(TrackEvent.UpstreamResumed,this),(($=this.sender.transport)===null||$===void 0?void 0:$.state)!=="closed"&&(yield this.sender.replaceTrack(this.mediaStreamTrack))}finally{U()}})}getRTCStatsReport(){return __awaiter(this,void 0,void 0,function*(){var $;return!(($=this.sender)===null||$===void 0)&&$.getStats?yield this.sender.getStats():void 0})}setProcessor($){return __awaiter(this,arguments,void 0,function(U){var F=this;let V=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0;return(function*(){var q;const j=yield F.trackChangeLock.lock();try{F.log.debug("setting up processor",F.logContext);const W=document.createElement(F.kind),K={kind:F.kind,track:F._mediaStreamTrack,element:W,audioContext:F.audioContext};if(yield U.init(K),F.log.debug("processor initialized",F.logContext),F.processor&&(yield F.internalStopProcessor()),F.kind==="unknown")throw TypeError("cannot set processor on track of unknown kind");if(attachToElement(F._mediaStreamTrack,W),W.muted=!0,W.play().catch(G=>{G instanceof DOMException&&G.name==="AbortError"?(F.log.warn("failed to play processor element, retrying",Object.assign(Object.assign({},F.logContext),{error:G})),setTimeout(()=>{W.play().catch(z=>{F.log.error("failed to play processor element",Object.assign(Object.assign({},F.logContext),{err:z}))})},100)):F.log.error("failed to play processor element",Object.assign(Object.assign({},F.logContext),{error:G}))}),F.processor=U,F.processorElement=W,F.processor.processedTrack){for(const G of F.attachedElements)G!==F.processorElement&&V&&(detachTrack(F._mediaStreamTrack,G),attachToElement(F.processor.processedTrack,G));yield(q=F.sender)===null||q===void 0?void 0:q.replaceTrack(F.processor.processedTrack)}F.emit(TrackEvent.TrackProcessorUpdate,F.processor)}finally{j()}})()})}getProcessor(){return this.processor}stopProcessor(){return __awaiter(this,arguments,void 0,function(){var $=this;let U=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0;return(function*(){const F=yield $.trackChangeLock.lock();try{yield $.internalStopProcessor(U)}finally{F()}})()})}internalStopProcessor(){return __awaiter(this,arguments,void 0,function(){var $=this;let U=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0;return(function*(){var F,V;$.processor&&($.log.debug("stopping processor",$.logContext),(F=$.processor.processedTrack)===null||F===void 0||F.stop(),yield $.processor.destroy(),$.processor=void 0,U||((V=$.processorElement)===null||V===void 0||V.remove(),$.processorElement=void 0),yield $._mediaStreamTrack.applyConstraints($._constraints),yield $.setMediaStreamTrack($._mediaStreamTrack,!0),$.emit(TrackEvent.TrackProcessorUpdate))})()})}startPreConnectBuffer(){let $=arguments.length>0&&arguments[0]!==void 0?arguments[0]:100;if(!isRecordingSupported()){this.log.warn("MediaRecorder is not available, cannot start preconnect buffer",this.logContext);return}if(this.localTrackRecorder){this.log.warn("preconnect buffer already started");return}else{let U="audio/webm;codecs=opus";MediaRecorder.isTypeSupported(U)||(U="video/mp4"),this.localTrackRecorder=new LocalTrackRecorder(this,{mimeType:U})}this.localTrackRecorder.start($),this.autoStopPreConnectBuffer=setTimeout(()=>{this.log.warn("preconnect buffer timed out, stopping recording automatically",this.logContext),this.stopPreConnectBuffer()},PRE_CONNECT_BUFFER_TIMEOUT)}stopPreConnectBuffer(){clearTimeout(this.autoStopPreConnectBuffer),this.localTrackRecorder&&(this.localTrackRecorder.stop(),this.localTrackRecorder=void 0)}getPreConnectBuffer(){var $;return($=this.localTrackRecorder)===null||$===void 0?void 0:$.byteStream}getPreConnectBufferMimeType(){var $;return($=this.localTrackRecorder)===null||$===void 0?void 0:$.mimeType}}class LocalAudioTrack extends LocalTrack{get enhancedNoiseCancellation(){return this.isKrispNoiseFilterEnabled}constructor($,U){let F=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!0,V=arguments.length>3?arguments[3]:void 0,q=arguments.length>4?arguments[4]:void 0;super($,Track.Kind.Audio,U,F,q),this.stopOnMute=!1,this.isKrispNoiseFilterEnabled=!1,this.monitorSender=()=>__awaiter(this,void 0,void 0,function*(){if(!this.sender){this._currentBitrate=0;return}let j;try{j=yield this.getSenderStats()}catch(W){this.log.error("could not get audio sender stats",Object.assign(Object.assign({},this.logContext),{error:W}));return}j&&this.prevStats&&(this._currentBitrate=computeBitrate(j,this.prevStats)),this.prevStats=j}),this.handleKrispNoiseFilterEnable=()=>{this.isKrispNoiseFilterEnabled=!0,this.log.debug("Krisp noise filter enabled",this.logContext),this.emit(TrackEvent.AudioTrackFeatureUpdate,this,AudioTrackFeature.TF_ENHANCED_NOISE_CANCELLATION,!0)},this.handleKrispNoiseFilterDisable=()=>{this.isKrispNoiseFilterEnabled=!1,this.log.debug("Krisp noise filter disabled",this.logContext),this.emit(TrackEvent.AudioTrackFeatureUpdate,this,AudioTrackFeature.TF_ENHANCED_NOISE_CANCELLATION,!1)},this.audioContext=V,this.checkForSilence()}mute(){const $=Object.create(null,{mute:{get:()=>super.mute}});return __awaiter(this,void 0,void 0,function*(){const U=yield this.muteLock.lock();try{return this.isMuted?(this.log.debug("Track already muted",this.logContext),this):(this.source===Track.Source.Microphone&&this.stopOnMute&&!this.isUserProvided&&(this.log.debug("stopping mic track",this.logContext),this._mediaStreamTrack.stop()),yield $.mute.call(this),this)}finally{U()}})}unmute(){const $=Object.create(null,{unmute:{get:()=>super.unmute}});return __awaiter(this,void 0,void 0,function*(){const U=yield this.muteLock.lock();try{if(!this.isMuted)return this.log.debug("Track already unmuted",this.logContext),this;const F=this._constraints.deviceId&&this._mediaStreamTrack.getSettings().deviceId!==unwrapConstraint(this._constraints.deviceId);return this.source===Track.Source.Microphone&&(this.stopOnMute||this._mediaStreamTrack.readyState==="ended"||F)&&!this.isUserProvided&&(this.log.debug("reacquiring mic track",this.logContext),yield this.restartTrack()),yield $.unmute.call(this),this}finally{U()}})}restartTrack($){return __awaiter(this,void 0,void 0,function*(){let U;if($){const F=constraintsForOptions({audio:$});typeof F.audio!="boolean"&&(U=F.audio)}yield this.restart(U)})}restart($){const U=Object.create(null,{restart:{get:()=>super.restart}});return __awaiter(this,void 0,void 0,function*(){const F=yield U.restart.call(this,$);return this.checkForSilence(),F})}startMonitor(){isWeb()&&(this.monitorInterval||(this.monitorInterval=setInterval(()=>{this.monitorSender()},monitorFrequency)))}setProcessor($){return __awaiter(this,void 0,void 0,function*(){var U;const F=yield this.trackChangeLock.lock();try{if(!isReactNative()&&!this.audioContext)throw Error("Audio context needs to be set on LocalAudioTrack in order to enable processors");this.processor&&(yield this.internalStopProcessor());const V={kind:this.kind,track:this._mediaStreamTrack,audioContext:this.audioContext};this.log.debug("setting up audio processor ".concat($.name),this.logContext),yield $.init(V),this.processor=$,this.processor.processedTrack&&(yield(U=this.sender)===null||U===void 0?void 0:U.replaceTrack(this.processor.processedTrack),this.processor.processedTrack.addEventListener("enable-lk-krisp-noise-filter",this.handleKrispNoiseFilterEnable),this.processor.processedTrack.addEventListener("disable-lk-krisp-noise-filter",this.handleKrispNoiseFilterDisable)),this.emit(TrackEvent.TrackProcessorUpdate,this.processor)}finally{F()}})}setAudioContext($){this.audioContext=$}getSenderStats(){return __awaiter(this,void 0,void 0,function*(){var $;if(!(!(($=this.sender)===null||$===void 0)&&$.getStats))return;const U=yield this.sender.getStats();let F;return U.forEach(V=>{V.type==="outbound-rtp"&&(F={type:"audio",streamId:V.id,packetsSent:V.packetsSent,packetsLost:V.packetsLost,bytesSent:V.bytesSent,timestamp:V.timestamp,roundTripTime:V.roundTripTime,jitter:V.jitter})}),F})}checkForSilence(){return __awaiter(this,void 0,void 0,function*(){const $=yield detectSilence(this);return $&&(this.isMuted||this.log.warn("silence detected on local audio track",this.logContext),this.emit(TrackEvent.AudioSilenceDetected)),$})}}function mediaTrackToLocalTrack(B,$,U){switch(B.kind){case"audio":return new LocalAudioTrack(B,$,!1,void 0,U);case"video":return new LocalVideoTrack(B,$,!1,U);default:throw new TrackInvalidError("unsupported track type: ".concat(B.kind))}}const presets169=Object.values(VideoPresets),presets43=Object.values(VideoPresets43),presetsScreenShare=Object.values(ScreenSharePresets),defaultSimulcastPresets169=[VideoPresets.h180,VideoPresets.h360],defaultSimulcastPresets43=[VideoPresets43.h180,VideoPresets43.h360],computeDefaultScreenShareSimulcastPresets=B=>[{scaleResolutionDownBy:2,fps:B.encoding.maxFramerate}].map(U=>{var F,V;return new VideoPreset(Math.floor(B.width/U.scaleResolutionDownBy),Math.floor(B.height/U.scaleResolutionDownBy),Math.max(15e4,Math.floor(B.encoding.maxBitrate/(Math.pow(U.scaleResolutionDownBy,2)*(((F=B.encoding.maxFramerate)!==null&&F!==void 0?F:30)/((V=U.fps)!==null&&V!==void 0?V:30))))),U.fps,B.encoding.priority)}),videoRids=["q","h","f"];function computeVideoEncodings(B,$,U,F){var V,q;let j=F?.videoEncoding;B&&(j=F?.screenShareEncoding);const W=F?.simulcast,K=F?.scalabilityMode,G=F?.videoCodec;if(!j&&!W&&!K||!$||!U)return[{}];j||(j=determineAppropriateEncoding(B,$,U,G),livekitLogger.debug("using video encoding",j));const z=j.maxFramerate,H=new VideoPreset($,U,j.maxBitrate,j.maxFramerate,j.priority);if(K&&isSVCCodec(G)){const X=new ScalabilityMode(K),Z=[];if(X.spatial>3)throw new Error("unsupported scalabilityMode: ".concat(K));const ne=getBrowser();if(isSafariBased()||isReactNative()||ne?.name==="Chrome"&&compareVersions(ne?.version,"113")<0){const ee=X.suffix=="h"?2:3,ie=isSafariSvcApi(ne);for(let se=0;se<X.spatial;se+=1)Z.push({rid:videoRids[2-se],maxBitrate:j.maxBitrate/Math.pow(ee,se),maxFramerate:H.encoding.maxFramerate,scaleResolutionDownBy:ie?Math.pow(2,se):void 0});Z[0].scalabilityMode=K}else Z.push({maxBitrate:j.maxBitrate,maxFramerate:H.encoding.maxFramerate,scalabilityMode:K});return H.encoding.priority&&(Z[0].priority=H.encoding.priority,Z[0].networkPriority=H.encoding.priority),livekitLogger.debug("using svc encoding",{encodings:Z}),Z}if(!W)return[j];let Q=[];B?Q=(V=sortPresets(F?.screenShareSimulcastLayers))!==null&&V!==void 0?V:defaultSimulcastLayers(B,H):Q=(q=sortPresets(F?.videoSimulcastLayers))!==null&&q!==void 0?q:defaultSimulcastLayers(B,H);let Y;if(Q.length>0){const X=Q[0];Q.length>1&&([,Y]=Q);const Z=Math.max($,U);if(Z>=960&&Y)return encodingsFromPresets($,U,[X,Y,H],z);if(Z>=480)return encodingsFromPresets($,U,[X,H],z)}return encodingsFromPresets($,U,[H])}function computeTrackBackupEncodings(B,$,U){var F,V,q,j;if(!U.backupCodec||U.backupCodec===!0||U.backupCodec.codec===U.videoCodec)return;$!==U.backupCodec.codec&&livekitLogger.warn("requested a different codec than specified as backup",{serverRequested:$,backup:U.backupCodec.codec}),U.videoCodec=$,U.videoEncoding=U.backupCodec.encoding;const W=B.mediaStreamTrack.getSettings(),K=(F=W.width)!==null&&F!==void 0?F:(V=B.dimensions)===null||V===void 0?void 0:V.width,G=(q=W.height)!==null&&q!==void 0?q:(j=B.dimensions)===null||j===void 0?void 0:j.height;return B.source===Track.Source.ScreenShare&&U.simulcast&&(U.simulcast=!1),computeVideoEncodings(B.source===Track.Source.ScreenShare,K,G,U)}function determineAppropriateEncoding(B,$,U,F){const V=presetsForResolution(B,$,U);let{encoding:q}=V[0];const j=Math.max($,U);for(let W=0;W<V.length;W+=1){const K=V[W];if(q=K.encoding,K.width>=j)break}if(F)switch(F){case"av1":case"h265":q=Object.assign({},q),q.maxBitrate=q.maxBitrate*.7;break;case"vp9":q=Object.assign({},q),q.maxBitrate=q.maxBitrate*.85;break}return q}function presetsForResolution(B,$,U){if(B)return presetsScreenShare;const F=$>U?$/U:U/$;return Math.abs(F-16/9)<Math.abs(F-4/3)?presets169:presets43}function defaultSimulcastLayers(B,$){if(B)return computeDefaultScreenShareSimulcastPresets($);const{width:U,height:F}=$,V=U>F?U/F:F/U;return Math.abs(V-16/9)<Math.abs(V-4/3)?defaultSimulcastPresets169:defaultSimulcastPresets43}function encodingsFromPresets(B,$,U,F){const V=[];if(U.forEach((q,j)=>{if(j>=videoRids.length)return;const W=Math.min(B,$),G={rid:videoRids[j],scaleResolutionDownBy:Math.max(1,W/Math.min(q.width,q.height)),maxBitrate:q.encoding.maxBitrate},z=F&&q.encoding.maxFramerate?Math.min(F,q.encoding.maxFramerate):q.encoding.maxFramerate;z&&(G.maxFramerate=z);const H=isFireFox()||j===0;q.encoding.priority&&H&&(G.priority=q.encoding.priority,G.networkPriority=q.encoding.priority),V.push(G)}),isReactNative()&&getReactNativeOs()==="ios"){let q;V.forEach(W=>{q?W.maxFramerate&&W.maxFramerate>q&&(q=W.maxFramerate):q=W.maxFramerate});let j=!0;V.forEach(W=>{var K;W.maxFramerate!=q&&(j&&(j=!1,livekitLogger.info("Simulcast on iOS React-Native requires all encodings to share the same framerate.")),livekitLogger.info('Setting framerate of encoding "'.concat((K=W.rid)!==null&&K!==void 0?K:"",'" to ').concat(q)),W.maxFramerate=q)})}return V}function sortPresets(B){if(B)return B.sort(($,U)=>{const{encoding:F}=$,{encoding:V}=U;return F.maxBitrate>V.maxBitrate?1:F.maxBitrate<V.maxBitrate?-1:F.maxBitrate===V.maxBitrate&&F.maxFramerate&&V.maxFramerate?F.maxFramerate>V.maxFramerate?1:-1:0})}class ScalabilityMode{constructor($){const U=$.match(/^L(\d)T(\d)(h|_KEY|_KEY_SHIFT){0,1}$/);if(!U)throw new Error("invalid scalability mode");if(this.spatial=parseInt(U[1]),this.temporal=parseInt(U[2]),U.length>3)switch(U[3]){case"h":case"_KEY":case"_KEY_SHIFT":this.suffix=U[3]}}toString(){var $;return"L".concat(this.spatial,"T").concat(this.temporal).concat(($=this.suffix)!==null&&$!==void 0?$:"")}}function getDefaultDegradationPreference(B){return B.source===Track.Source.ScreenShare||B.constraints.height&&unwrapConstraint(B.constraints.height)>=1080?"maintain-resolution":"balanced"}const refreshSubscribedCodecAfterNewCodec=5e3;class LocalVideoTrack extends LocalTrack{get sender(){return this._sender}set sender($){this._sender=$,this.degradationPreference&&this.setDegradationPreference(this.degradationPreference)}constructor($,U){let F=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!0,V=arguments.length>3?arguments[3]:void 0;super($,Track.Kind.Video,U,F,V),this.simulcastCodecs=new Map,this.degradationPreference="balanced",this.isCpuConstrained=!1,this.optimizeForPerformance=!1,this.monitorSender=()=>__awaiter(this,void 0,void 0,function*(){if(!this.sender){this._currentBitrate=0;return}let q;try{q=yield this.getSenderStats()}catch(K){this.log.error("could not get video sender stats",Object.assign(Object.assign({},this.logContext),{error:K}));return}const j=new Map(q.map(K=>[K.rid,K])),W=q.some(K=>K.qualityLimitationReason==="cpu");if(W!==this.isCpuConstrained&&(this.isCpuConstrained=W,this.isCpuConstrained&&this.emit(TrackEvent.CpuConstrained)),this.prevStats){let K=0;j.forEach((G,z)=>{var H;const Q=(H=this.prevStats)===null||H===void 0?void 0:H.get(z);K+=computeBitrate(G,Q)}),this._currentBitrate=K}this.prevStats=j}),this.senderLock=new _}get isSimulcast(){return!!(this.sender&&this.sender.getParameters().encodings.length>1)}startMonitor($){var U;if(this.signalClient=$,!isWeb())return;const F=(U=this.sender)===null||U===void 0?void 0:U.getParameters();F&&(this.encodings=F.encodings),!this.monitorInterval&&(this.monitorInterval=setInterval(()=>{this.monitorSender()},monitorFrequency))}stop(){this._mediaStreamTrack.getConstraints(),this.simulcastCodecs.forEach($=>{$.mediaStreamTrack.stop()}),super.stop()}pauseUpstream(){const $=Object.create(null,{pauseUpstream:{get:()=>super.pauseUpstream}});return __awaiter(this,void 0,void 0,function*(){var U,F,V,q,j;yield $.pauseUpstream.call(this);try{for(var W=!0,K=__asyncValues(this.simulcastCodecs.values()),G;G=yield K.next(),U=G.done,!U;W=!0)q=G.value,W=!1,yield(j=q.sender)===null||j===void 0?void 0:j.replaceTrack(null)}catch(z){F={error:z}}finally{try{!W&&!U&&(V=K.return)&&(yield V.call(K))}finally{if(F)throw F.error}}})}resumeUpstream(){const $=Object.create(null,{resumeUpstream:{get:()=>super.resumeUpstream}});return __awaiter(this,void 0,void 0,function*(){var U,F,V,q,j;yield $.resumeUpstream.call(this);try{for(var W=!0,K=__asyncValues(this.simulcastCodecs.values()),G;G=yield K.next(),U=G.done,!U;W=!0){q=G.value,W=!1;const z=q;yield(j=z.sender)===null||j===void 0?void 0:j.replaceTrack(z.mediaStreamTrack)}}catch(z){F={error:z}}finally{try{!W&&!U&&(V=K.return)&&(yield V.call(K))}finally{if(F)throw F.error}}})}mute(){const $=Object.create(null,{mute:{get:()=>super.mute}});return __awaiter(this,void 0,void 0,function*(){const U=yield this.muteLock.lock();try{return this.isMuted?(this.log.debug("Track already muted",this.logContext),this):(this.source===Track.Source.Camera&&!this.isUserProvided&&(this.log.debug("stopping camera track",this.logContext),this._mediaStreamTrack.stop()),yield $.mute.call(this),this)}finally{U()}})}unmute(){const $=Object.create(null,{unmute:{get:()=>super.unmute}});return __awaiter(this,void 0,void 0,function*(){const U=yield this.muteLock.lock();try{return this.isMuted?(this.source===Track.Source.Camera&&!this.isUserProvided&&(this.log.debug("reacquiring camera track",this.logContext),yield this.restartTrack()),yield $.unmute.call(this),this):(this.log.debug("Track already unmuted",this.logContext),this)}finally{U()}})}setTrackMuted($){super.setTrackMuted($);for(const U of this.simulcastCodecs.values())U.mediaStreamTrack.enabled=!$}getSenderStats(){return __awaiter(this,void 0,void 0,function*(){var $;if(!(!(($=this.sender)===null||$===void 0)&&$.getStats))return[];const U=[],F=yield this.sender.getStats();return F.forEach(V=>{var q;if(V.type==="outbound-rtp"){const j={type:"video",streamId:V.id,frameHeight:V.frameHeight,frameWidth:V.frameWidth,framesPerSecond:V.framesPerSecond,framesSent:V.framesSent,firCount:V.firCount,pliCount:V.pliCount,nackCount:V.nackCount,packetsSent:V.packetsSent,bytesSent:V.bytesSent,qualityLimitationReason:V.qualityLimitationReason,qualityLimitationDurations:V.qualityLimitationDurations,qualityLimitationResolutionChanges:V.qualityLimitationResolutionChanges,rid:(q=V.rid)!==null&&q!==void 0?q:V.id,retransmittedPacketsSent:V.retransmittedPacketsSent,targetBitrate:V.targetBitrate,timestamp:V.timestamp},W=F.get(V.remoteId);W&&(j.jitter=W.jitter,j.packetsLost=W.packetsLost,j.roundTripTime=W.roundTripTime),U.push(j)}}),U.sort((V,q)=>{var j,W;return((j=q.frameWidth)!==null&&j!==void 0?j:0)-((W=V.frameWidth)!==null&&W!==void 0?W:0)}),U})}setPublishingQuality($){const U=[];for(let F=VideoQuality.LOW;F<=VideoQuality.HIGH;F+=1)U.push(new SubscribedQuality({quality:F,enabled:F<=$}));this.log.debug("setting publishing quality. max quality ".concat($),this.logContext),this.setPublishingLayers(isSVCCodec(this.codec),U)}restartTrack($){return __awaiter(this,void 0,void 0,function*(){var U,F,V,q,j;let W;if($){const H=constraintsForOptions({video:$});typeof H.video!="boolean"&&(W=H.video)}yield this.restart(W),this.isCpuConstrained=!1;try{for(var K=!0,G=__asyncValues(this.simulcastCodecs.values()),z;z=yield G.next(),U=z.done,!U;K=!0){q=z.value,K=!1;const H=q;H.sender&&((j=H.sender.transport)===null||j===void 0?void 0:j.state)!=="closed"&&(H.mediaStreamTrack=this.mediaStreamTrack.clone(),yield H.sender.replaceTrack(H.mediaStreamTrack))}}catch(H){F={error:H}}finally{try{!K&&!U&&(V=G.return)&&(yield V.call(G))}finally{if(F)throw F.error}}})}setProcessor($){const U=Object.create(null,{setProcessor:{get:()=>super.setProcessor}});return __awaiter(this,arguments,void 0,function(F){var V=this;let q=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0;return(function*(){var j,W,K,G,z,H;if(yield U.setProcessor.call(V,F,q),!((z=V.processor)===null||z===void 0)&&z.processedTrack)try{for(var Q=!0,Y=__asyncValues(V.simulcastCodecs.values()),X;X=yield Y.next(),j=X.done,!j;Q=!0)G=X.value,Q=!1,yield(H=G.sender)===null||H===void 0?void 0:H.replaceTrack(V.processor.processedTrack)}catch(Z){W={error:Z}}finally{try{!Q&&!j&&(K=Y.return)&&(yield K.call(Y))}finally{if(W)throw W.error}}})()})}setDegradationPreference($){return __awaiter(this,void 0,void 0,function*(){if(this.degradationPreference=$,this.sender)try{this.log.debug("setting degradationPreference to ".concat($),this.logContext);const U=this.sender.getParameters();U.degradationPreference=$,this.sender.setParameters(U)}catch(U){this.log.warn("failed to set degradationPreference",Object.assign({error:U},this.logContext))}})}addSimulcastTrack($,U){if(this.simulcastCodecs.has($)){this.log.error("".concat($," already added, skipping adding simulcast codec"),this.logContext);return}const F={codec:$,mediaStreamTrack:this.mediaStreamTrack.clone(),sender:void 0,encodings:U};return this.simulcastCodecs.set($,F),F}setSimulcastTrackSender($,U){const F=this.simulcastCodecs.get($);F&&(F.sender=U,setTimeout(()=>{this.subscribedCodecs&&this.setPublishingCodecs(this.subscribedCodecs)},refreshSubscribedCodecAfterNewCodec))}setPublishingCodecs($){return __awaiter(this,void 0,void 0,function*(){var U,F,V,q,j,W,K;if(this.log.debug("setting publishing codecs",Object.assign(Object.assign({},this.logContext),{codecs:$,currentCodec:this.codec})),!this.codec&&$.length>0)return yield this.setPublishingLayers(isSVCCodec($[0].codec),$[0].qualities),[];this.subscribedCodecs=$;const G=[];try{for(U=!0,F=__asyncValues($);V=yield F.next(),q=V.done,!q;U=!0){K=V.value,U=!1;const z=K;if(!this.codec||this.codec===z.codec)yield this.setPublishingLayers(isSVCCodec(z.codec),z.qualities);else{const H=this.simulcastCodecs.get(z.codec);if(this.log.debug("try setPublishingCodec for ".concat(z.codec),Object.assign(Object.assign({},this.logContext),{simulcastCodecInfo:H})),!H||!H.sender){for(const Q of z.qualities)if(Q.enabled){G.push(z.codec);break}}else H.encodings&&(this.log.debug("try setPublishingLayersForSender ".concat(z.codec),this.logContext),yield setPublishingLayersForSender(H.sender,H.encodings,z.qualities,this.senderLock,isSVCCodec(z.codec),this.log,this.logContext))}}}catch(z){j={error:z}}finally{try{!U&&!q&&(W=F.return)&&(yield W.call(F))}finally{if(j)throw j.error}}return G})}setPublishingLayers($,U){return __awaiter(this,void 0,void 0,function*(){if(this.optimizeForPerformance){this.log.info("skipping setPublishingLayers due to optimized publishing performance",Object.assign(Object.assign({},this.logContext),{qualities:U}));return}this.log.debug("setting publishing layers",Object.assign(Object.assign({},this.logContext),{qualities:U})),!(!this.sender||!this.encodings)&&(yield setPublishingLayersForSender(this.sender,this.encodings,U,this.senderLock,$,this.log,this.logContext))})}prioritizePerformance(){return __awaiter(this,void 0,void 0,function*(){if(!this.sender)throw new Error("sender not found");const $=yield this.senderLock.lock();try{this.optimizeForPerformance=!0;const U=this.sender.getParameters();U.encodings=U.encodings.map((F,V)=>{var q;return Object.assign(Object.assign({},F),{active:V===0,scaleResolutionDownBy:Math.max(1,Math.ceil(((q=this.mediaStreamTrack.getSettings().height)!==null&&q!==void 0?q:360)/360)),scalabilityMode:V===0&&isSVCCodec(this.codec)?"L1T3":void 0,maxFramerate:V===0?15:0,maxBitrate:V===0?F.maxBitrate:0})}),this.log.debug("setting performance optimised encodings",Object.assign(Object.assign({},this.logContext),{encodings:U.encodings})),this.encodings=U.encodings,yield this.sender.setParameters(U)}catch(U){this.log.error("failed to set performance optimised encodings",Object.assign(Object.assign({},this.logContext),{error:U})),this.optimizeForPerformance=!1}finally{$()}})}handleAppVisibilityChanged(){const $=Object.create(null,{handleAppVisibilityChanged:{get:()=>super.handleAppVisibilityChanged}});return __awaiter(this,void 0,void 0,function*(){yield $.handleAppVisibilityChanged.call(this),isMobile()&&this.isInBackground&&this.source===Track.Source.Camera&&(this._mediaStreamTrack.enabled=!1)})}}function setPublishingLayersForSender(B,$,U,F,V,q,j){return __awaiter(this,void 0,void 0,function*(){const W=yield F.lock();q.debug("setPublishingLayersForSender",Object.assign(Object.assign({},j),{sender:B,qualities:U,senderEncodings:$}));try{const K=B.getParameters(),{encodings:G}=K;if(!G)return;if(G.length!==$.length){q.warn("cannot set publishing layers, encodings mismatch",Object.assign(Object.assign({},j),{encodings:G,senderEncodings:$}));return}let z=!1;!1&&G[0].scalabilityMode||(V&&U.some(Y=>Y.enabled)&&U.forEach(Y=>Y.enabled=!0),G.forEach((Q,Y)=>{var X;let Z=(X=Q.rid)!==null&&X!==void 0?X:"";Z===""&&(Z="q");const ne=videoQualityForRid(Z),ee=U.find(ie=>ie.quality===ne);ee&&Q.active!==ee.enabled&&(z=!0,Q.active=ee.enabled,q.debug("setting layer ".concat(ee.quality," to ").concat(Q.active?"enabled":"disabled"),j),isFireFox()&&(ee.enabled?(Q.scaleResolutionDownBy=$[Y].scaleResolutionDownBy,Q.maxBitrate=$[Y].maxBitrate,Q.maxFrameRate=$[Y].maxFrameRate):(Q.scaleResolutionDownBy=4,Q.maxBitrate=10,Q.maxFrameRate=2)))})),z&&(K.encodings=G,q.debug("setting encodings",Object.assign(Object.assign({},j),{encodings:K.encodings})),yield B.setParameters(K))}finally{W()}})}function videoQualityForRid(B){switch(B){case"f":return VideoQuality.HIGH;case"h":return VideoQuality.MEDIUM;case"q":return VideoQuality.LOW;default:return VideoQuality.HIGH}}function videoLayersFromEncodings(B,$,U,F){if(!U)return[new VideoLayer({quality:VideoQuality.HIGH,width:B,height:$,bitrate:0,ssrc:0})];if(F){const V=U[0].scalabilityMode,q=new ScalabilityMode(V),j=[],W=q.suffix=="h"?1.5:2,K=q.suffix=="h"?2:3;for(let G=0;G<q.spatial;G+=1)j.push(new VideoLayer({quality:Math.min(VideoQuality.HIGH,q.spatial-1)-G,width:Math.ceil(B/Math.pow(W,G)),height:Math.ceil($/Math.pow(W,G)),bitrate:U[0].maxBitrate?Math.ceil(U[0].maxBitrate/Math.pow(K,G)):0,ssrc:0}));return j}return U.map(V=>{var q,j,W;const K=(q=V.scaleResolutionDownBy)!==null&&q!==void 0?q:1;let G=videoQualityForRid((j=V.rid)!==null&&j!==void 0?j:"");return new VideoLayer({quality:G,width:Math.ceil(B/K),height:Math.ceil($/K),bitrate:(W=V.maxBitrate)!==null&&W!==void 0?W:0,ssrc:0})})}const lossyDataChannel="_lossy",reliableDataChannel="_reliable",minReconnectWait=2*1e3,leaveReconnect="leave-reconnect",reliabeReceiveStateTTL=3e4;var PCState;(function(B){B[B.New=0]="New",B[B.Connected=1]="Connected",B[B.Disconnected=2]="Disconnected",B[B.Reconnecting=3]="Reconnecting",B[B.Closed=4]="Closed"})(PCState||(PCState={}));class RTCEngine extends eventsExports.EventEmitter{get isClosed(){return this._isClosed}get pendingReconnect(){return!!this.reconnectTimeout}constructor($){var U;super(),this.options=$,this.rtcConfig={},this.peerConnectionTimeout=roomConnectOptionDefaults.peerConnectionTimeout,this.fullReconnectOnNext=!1,this.latestRemoteOfferId=0,this.subscriberPrimary=!1,this.pcState=PCState.New,this._isClosed=!0,this.pendingTrackResolvers={},this.reconnectAttempts=0,this.reconnectStart=0,this.attemptingReconnect=!1,this.joinAttempts=0,this.maxJoinAttempts=1,this.shouldFailNext=!1,this.log=livekitLogger,this.reliableDataSequence=1,this.reliableMessageBuffer=new DataPacketBuffer,this.reliableReceivedState=new TTLMap(reliabeReceiveStateTTL),this.handleDataChannel=F=>__awaiter(this,[F],void 0,function(V){var q=this;let{channel:j}=V;return(function*(){if(j){if(j.label===reliableDataChannel)q.reliableDCSub=j;else if(j.label===lossyDataChannel)q.lossyDCSub=j;else return;q.log.debug("on data channel ".concat(j.id,", ").concat(j.label),q.logContext),j.onmessage=q.handleDataMessage}})()}),this.handleDataMessage=F=>__awaiter(this,void 0,void 0,function*(){var V,q;const j=yield this.dataProcessLock.lock();try{let W;if(F.data instanceof ArrayBuffer)W=F.data;else if(F.data instanceof Blob)W=yield F.data.arrayBuffer();else{this.log.error("unsupported data type",Object.assign(Object.assign({},this.logContext),{data:F.data}));return}const K=DataPacket.fromBinary(new Uint8Array(W));if(K.sequence>0&&K.participantSid!==""){const G=this.reliableReceivedState.get(K.participantSid);if(G&&K.sequence<=G)return;this.reliableReceivedState.set(K.participantSid,K.sequence)}((V=K.value)===null||V===void 0?void 0:V.case)==="speaker"?this.emit(EngineEvent.ActiveSpeakersUpdate,K.value.value.speakers):(((q=K.value)===null||q===void 0?void 0:q.case)==="user"&&applyUserDataCompat(K,K.value.value),this.emit(EngineEvent.DataPacketReceived,K))}finally{j()}}),this.handleDataError=F=>{const q=F.currentTarget.maxRetransmits===0?"lossy":"reliable";if(F instanceof ErrorEvent&&F.error){const{error:j}=F.error;this.log.error("DataChannel error on ".concat(q,": ").concat(F.message),Object.assign(Object.assign({},this.logContext),{error:j}))}else this.log.error("Unknown DataChannel error on ".concat(q),Object.assign(Object.assign({},this.logContext),{event:F}))},this.handleBufferedAmountLow=F=>{const q=F.currentTarget.maxRetransmits===0?DataPacket_Kind.LOSSY:DataPacket_Kind.RELIABLE;this.updateAndEmitDCBufferStatus(q)},this.handleDisconnect=(F,V)=>{if(this._isClosed)return;this.log.warn("".concat(F," disconnected"),this.logContext),this.reconnectAttempts===0&&(this.reconnectStart=Date.now());const q=K=>{this.log.warn("could not recover connection after ".concat(this.reconnectAttempts," attempts, ").concat(K,"ms. giving up"),this.logContext),this.emit(EngineEvent.Disconnected),this.close()},j=Date.now()-this.reconnectStart;let W=this.getNextRetryDelay({elapsedMs:j,retryCount:this.reconnectAttempts});if(W===null){q(j);return}F===leaveReconnect&&(W=0),this.log.debug("reconnecting in ".concat(W,"ms"),this.logContext),this.clearReconnectTimeout(),this.token&&this.regionUrlProvider&&this.regionUrlProvider.updateToken(this.token),this.reconnectTimeout=CriticalTimers.setTimeout(()=>this.attemptReconnect(V).finally(()=>this.reconnectTimeout=void 0),W)},this.waitForRestarted=()=>new Promise((F,V)=>{this.pcState===PCState.Connected&&F();const q=()=>{this.off(EngineEvent.Disconnected,j),F()},j=()=>{this.off(EngineEvent.Restarted,q),V()};this.once(EngineEvent.Restarted,q),this.once(EngineEvent.Disconnected,j)}),this.updateAndEmitDCBufferStatus=F=>{const V=this.isBufferStatusLow(F);typeof V<"u"&&V!==this.dcBufferStatus.get(F)&&(this.dcBufferStatus.set(F,V),this.emit(EngineEvent.DCBufferStatusChanged,V,F))},this.isBufferStatusLow=F=>{const V=this.dataChannelForKind(F);if(V)return F===DataPacket_Kind.RELIABLE&&this.reliableMessageBuffer.alignBufferedAmount(V.bufferedAmount),V.bufferedAmount<=V.bufferedAmountLowThreshold},this.handleBrowserOnLine=()=>{this.client.currentState===SignalConnectionState.RECONNECTING&&(this.clearReconnectTimeout(),this.attemptReconnect(ReconnectReason.RR_SIGNAL_DISCONNECTED))},this.log=getLogger((U=$.loggerName)!==null&&U!==void 0?U:LoggerNames.Engine),this.loggerOptions={loggerName:$.loggerName,loggerContextCb:()=>this.logContext},this.client=new SignalClient(void 0,this.loggerOptions),this.client.signalLatency=this.options.expSignalLatency,this.reconnectPolicy=this.options.reconnectPolicy,this.registerOnLineListener(),this.closingLock=new _,this.dataProcessLock=new _,this.dcBufferStatus=new Map([[DataPacket_Kind.LOSSY,!0],[DataPacket_Kind.RELIABLE,!0]]),this.client.onParticipantUpdate=F=>this.emit(EngineEvent.ParticipantUpdate,F),this.client.onConnectionQuality=F=>this.emit(EngineEvent.ConnectionQualityUpdate,F),this.client.onRoomUpdate=F=>this.emit(EngineEvent.RoomUpdate,F),this.client.onSubscriptionError=F=>this.emit(EngineEvent.SubscriptionError,F),this.client.onSubscriptionPermissionUpdate=F=>this.emit(EngineEvent.SubscriptionPermissionUpdate,F),this.client.onSpeakersChanged=F=>this.emit(EngineEvent.SpeakersChanged,F),this.client.onStreamStateUpdate=F=>this.emit(EngineEvent.StreamStateChanged,F),this.client.onRequestResponse=F=>this.emit(EngineEvent.SignalRequestResponse,F)}get logContext(){var $,U,F,V,q,j;return{room:(U=($=this.latestJoinResponse)===null||$===void 0?void 0:$.room)===null||U===void 0?void 0:U.name,roomID:(V=(F=this.latestJoinResponse)===null||F===void 0?void 0:F.room)===null||V===void 0?void 0:V.sid,participant:(j=(q=this.latestJoinResponse)===null||q===void 0?void 0:q.participant)===null||j===void 0?void 0:j.identity,pID:this.participantSid}}join($,U,F,V){return __awaiter(this,void 0,void 0,function*(){this.url=$,this.token=U,this.signalOpts=F,this.maxJoinAttempts=F.maxRetries;try{this.joinAttempts+=1,this.setupSignalClientCallbacks();const q=yield this.client.join($,U,F,V);return this._isClosed=!1,this.latestJoinResponse=q,this.subscriberPrimary=q.subscriberPrimary,this.pcManager||(yield this.configure(q)),(!this.subscriberPrimary||q.fastPublish)&&this.negotiate(),this.clientConfiguration=q.clientConfiguration,this.emit(EngineEvent.SignalConnected,q),q}catch(q){if(q instanceof ConnectionError&&q.reason===ConnectionErrorReason.ServerUnreachable&&(this.log.warn("Couldn't connect to server, attempt ".concat(this.joinAttempts," of ").concat(this.maxJoinAttempts),this.logContext),this.joinAttempts<this.maxJoinAttempts))return this.join($,U,F,V);throw q}})}close(){return __awaiter(this,void 0,void 0,function*(){const $=yield this.closingLock.lock();if(this.isClosed){$();return}try{this._isClosed=!0,this.joinAttempts=0,this.emit(EngineEvent.Closing),this.removeAllListeners(),this.deregisterOnLineListener(),this.clearPendingReconnect(),yield this.cleanupPeerConnections(),yield this.cleanupClient()}finally{$()}})}cleanupPeerConnections(){return __awaiter(this,void 0,void 0,function*(){var $;yield($=this.pcManager)===null||$===void 0?void 0:$.close(),this.pcManager=void 0;const U=F=>{F&&(F.close(),F.onbufferedamountlow=null,F.onclose=null,F.onclosing=null,F.onerror=null,F.onmessage=null,F.onopen=null)};U(this.lossyDC),U(this.lossyDCSub),U(this.reliableDC),U(this.reliableDCSub),this.lossyDC=void 0,this.lossyDCSub=void 0,this.reliableDC=void 0,this.reliableDCSub=void 0,this.reliableMessageBuffer=new DataPacketBuffer,this.reliableDataSequence=1,this.reliableReceivedState.clear()})}cleanupClient(){return __awaiter(this,void 0,void 0,function*(){yield this.client.close(),this.client.resetCallbacks()})}addTrack($){if(this.pendingTrackResolvers[$.cid])throw new TrackInvalidError("a track with the same ID has already been published");return new Promise((U,F)=>{const V=setTimeout(()=>{delete this.pendingTrackResolvers[$.cid],F(new ConnectionError("publication of local track timed out, no response from server",ConnectionErrorReason.Timeout))},1e4);this.pendingTrackResolvers[$.cid]={resolve:q=>{clearTimeout(V),U(q)},reject:()=>{clearTimeout(V),F(new Error("Cancelled publication by calling unpublish"))}},this.client.sendAddTrack($)})}removeTrack($){if($.track&&this.pendingTrackResolvers[$.track.id]){const{reject:U}=this.pendingTrackResolvers[$.track.id];U&&U(),delete this.pendingTrackResolvers[$.track.id]}try{return this.pcManager.removeTrack($),!0}catch(U){this.log.warn("failed to remove track",Object.assign(Object.assign({},this.logContext),{error:U}))}return!1}updateMuteStatus($,U){this.client.sendMuteTrack($,U)}get dataSubscriberReadyState(){var $;return($=this.reliableDCSub)===null||$===void 0?void 0:$.readyState}getConnectedServerAddress(){return __awaiter(this,void 0,void 0,function*(){var $;return($=this.pcManager)===null||$===void 0?void 0:$.getConnectedAddress()})}setRegionUrlProvider($){this.regionUrlProvider=$}configure($){return __awaiter(this,void 0,void 0,function*(){var U,F;if(this.pcManager&&this.pcManager.currentState!==PCTransportState.NEW)return;this.participantSid=(U=$.participant)===null||U===void 0?void 0:U.sid;const V=this.makeRTCConfiguration($);this.pcManager=new PCTransportManager(V,$.subscriberPrimary,this.loggerOptions),this.emit(EngineEvent.TransportsCreated,this.pcManager.publisher,this.pcManager.subscriber),this.pcManager.onIceCandidate=(q,j)=>{this.client.sendIceCandidate(q,j)},this.pcManager.onPublisherOffer=(q,j)=>{this.client.sendOffer(q,j)},this.pcManager.onDataChannel=this.handleDataChannel,this.pcManager.onStateChange=(q,j,W)=>__awaiter(this,void 0,void 0,function*(){if(this.log.debug("primary PC state changed ".concat(q),this.logContext),["closed","disconnected","failed"].includes(j)&&(this.publisherConnectionPromise=void 0),q===PCTransportState.CONNECTED){const z=this.pcState===PCState.New;this.pcState=PCState.Connected,z&&this.emit(EngineEvent.Connected,$)}else q===PCTransportState.FAILED&&this.pcState===PCState.Connected&&(this.pcState=PCState.Disconnected,this.handleDisconnect("peerconnection failed",W==="failed"?ReconnectReason.RR_SUBSCRIBER_FAILED:ReconnectReason.RR_PUBLISHER_FAILED));const K=this.client.isDisconnected||this.client.currentState===SignalConnectionState.RECONNECTING,G=[PCTransportState.FAILED,PCTransportState.CLOSING,PCTransportState.CLOSED].includes(q);K&&G&&!this._isClosed&&this.emit(EngineEvent.Offline)}),this.pcManager.onTrack=q=>{this.emit(EngineEvent.MediaTrackAdded,q.track,q.streams[0],q.receiver)},supportOptionalDatachannel((F=$.serverInfo)===null||F===void 0?void 0:F.protocol)||this.createDataChannels()})}setupSignalClientCallbacks(){this.client.onAnswer=($,U)=>__awaiter(this,void 0,void 0,function*(){this.pcManager&&(this.log.debug("received server answer",Object.assign(Object.assign({},this.logContext),{RTCSdpType:$.type})),yield this.pcManager.setPublisherAnswer($,U))}),this.client.onTrickle=($,U)=>{this.pcManager&&(this.log.debug("got ICE candidate from peer",Object.assign(Object.assign({},this.logContext),{candidate:$,target:U})),this.pcManager.addIceCandidate($,U))},this.client.onOffer=($,U)=>__awaiter(this,void 0,void 0,function*(){if(this.latestRemoteOfferId=U,!this.pcManager)return;const F=yield this.pcManager.createSubscriberAnswerFromOffer($,U);F&&this.client.sendAnswer(F,U)}),this.client.onLocalTrackPublished=$=>{var U;if(this.log.debug("received trackPublishedResponse",Object.assign(Object.assign({},this.logContext),{cid:$.cid,track:(U=$.track)===null||U===void 0?void 0:U.sid})),!this.pendingTrackResolvers[$.cid]){this.log.error("missing track resolver for ".concat($.cid),Object.assign(Object.assign({},this.logContext),{cid:$.cid}));return}const{resolve:F}=this.pendingTrackResolvers[$.cid];delete this.pendingTrackResolvers[$.cid],F($.track)},this.client.onLocalTrackUnpublished=$=>{this.emit(EngineEvent.LocalTrackUnpublished,$)},this.client.onLocalTrackSubscribed=$=>{this.emit(EngineEvent.LocalTrackSubscribed,$)},this.client.onTokenRefresh=$=>{this.token=$},this.client.onRemoteMuteChanged=($,U)=>{this.emit(EngineEvent.RemoteMute,$,U)},this.client.onSubscribedQualityUpdate=$=>{this.emit(EngineEvent.SubscribedQualityUpdate,$)},this.client.onRoomMoved=$=>{var U;this.participantSid=(U=$.participant)===null||U===void 0?void 0:U.sid,this.latestJoinResponse&&(this.latestJoinResponse.room=$.room),this.emit(EngineEvent.RoomMoved,$)},this.client.onClose=()=>{this.handleDisconnect("signal",ReconnectReason.RR_SIGNAL_DISCONNECTED)},this.client.onLeave=$=>{switch(this.log.debug("client leave request",Object.assign(Object.assign({},this.logContext),{reason:$?.reason})),$.regions&&this.regionUrlProvider&&(this.log.debug("updating regions",this.logContext),this.regionUrlProvider.setServerReportedRegions($.regions)),$.action){case LeaveRequest_Action.DISCONNECT:this.emit(EngineEvent.Disconnected,$?.reason),this.close();break;case LeaveRequest_Action.RECONNECT:this.fullReconnectOnNext=!0,this.handleDisconnect(leaveReconnect);break;case LeaveRequest_Action.RESUME:this.handleDisconnect(leaveReconnect)}}}makeRTCConfiguration($){var U;const F=Object.assign({},this.rtcConfig);if(!((U=this.signalOpts)===null||U===void 0)&&U.e2eeEnabled&&(this.log.debug("E2EE - setting up transports with insertable streams",this.logContext),F.encodedInsertableStreams=!0),$.iceServers&&!F.iceServers){const V=[];$.iceServers.forEach(q=>{const j={urls:q.urls};q.username&&(j.username=q.username),q.credential&&(j.credential=q.credential),V.push(j)}),F.iceServers=V}return $.clientConfiguration&&$.clientConfiguration.forceRelay===ClientConfigSetting.ENABLED&&(F.iceTransportPolicy="relay"),F.sdpSemantics="unified-plan",F.continualGatheringPolicy="gather_continually",F}createDataChannels(){this.pcManager&&(this.lossyDC&&(this.lossyDC.onmessage=null,this.lossyDC.onerror=null),this.reliableDC&&(this.reliableDC.onmessage=null,this.reliableDC.onerror=null),this.lossyDC=this.pcManager.createPublisherDataChannel(lossyDataChannel,{ordered:!1,maxRetransmits:0}),this.reliableDC=this.pcManager.createPublisherDataChannel(reliableDataChannel,{ordered:!0}),this.lossyDC.onmessage=this.handleDataMessage,this.reliableDC.onmessage=this.handleDataMessage,this.lossyDC.onerror=this.handleDataError,this.reliableDC.onerror=this.handleDataError,this.lossyDC.bufferedAmountLowThreshold=65535,this.reliableDC.bufferedAmountLowThreshold=65535,this.lossyDC.onbufferedamountlow=this.handleBufferedAmountLow,this.reliableDC.onbufferedamountlow=this.handleBufferedAmountLow)}createSender($,U,F){return __awaiter(this,void 0,void 0,function*(){if(supportsTransceiver())return yield this.createTransceiverRTCRtpSender($,U,F);if(supportsAddTrack())return this.log.warn("using add-track fallback",this.logContext),yield this.createRTCRtpSender($.mediaStreamTrack);throw new UnexpectedConnectionState("Required webRTC APIs not supported on this device")})}createSimulcastSender($,U,F,V){return __awaiter(this,void 0,void 0,function*(){if(supportsTransceiver())return this.createSimulcastTransceiverSender($,U,F,V);if(supportsAddTrack())return this.log.debug("using add-track fallback",this.logContext),this.createRTCRtpSender($.mediaStreamTrack);throw new UnexpectedConnectionState("Cannot stream on this device")})}createTransceiverRTCRtpSender($,U,F){return __awaiter(this,void 0,void 0,function*(){if(!this.pcManager)throw new UnexpectedConnectionState("publisher is closed");const V=[];$.mediaStream&&V.push($.mediaStream),isVideoTrack($)&&($.codec=U.videoCodec);const q={direction:"sendonly",streams:V};return F&&(q.sendEncodings=F),(yield this.pcManager.addPublisherTransceiver($.mediaStreamTrack,q)).sender})}createSimulcastTransceiverSender($,U,F,V){return __awaiter(this,void 0,void 0,function*(){if(!this.pcManager)throw new UnexpectedConnectionState("publisher is closed");const q={direction:"sendonly"};V&&(q.sendEncodings=V);const j=yield this.pcManager.addPublisherTransceiver(U.mediaStreamTrack,q);if(F.videoCodec)return $.setSimulcastTrackSender(F.videoCodec,j.sender),j.sender})}createRTCRtpSender($){return __awaiter(this,void 0,void 0,function*(){if(!this.pcManager)throw new UnexpectedConnectionState("publisher is closed");return this.pcManager.addPublisherTrack($)})}attemptReconnect($){return __awaiter(this,void 0,void 0,function*(){var U,F,V;if(!this._isClosed){if(this.attemptingReconnect){livekitLogger.warn("already attempting reconnect, returning early",this.logContext);return}(((U=this.clientConfiguration)===null||U===void 0?void 0:U.resumeConnection)===ClientConfigSetting.DISABLED||((V=(F=this.pcManager)===null||F===void 0?void 0:F.currentState)!==null&&V!==void 0?V:PCTransportState.NEW)===PCTransportState.NEW)&&(this.fullReconnectOnNext=!0);try{this.attemptingReconnect=!0,this.fullReconnectOnNext?yield this.restartConnection():yield this.resumeConnection($),this.clearPendingReconnect(),this.fullReconnectOnNext=!1}catch(q){this.reconnectAttempts+=1;let j=!0;q instanceof UnexpectedConnectionState?(this.log.debug("received unrecoverable error",Object.assign(Object.assign({},this.logContext),{error:q})),j=!1):q instanceof SignalReconnectError||(this.fullReconnectOnNext=!0),j?this.handleDisconnect("reconnect",ReconnectReason.RR_UNKNOWN):(this.log.info("could not recover connection after ".concat(this.reconnectAttempts," attempts, ").concat(Date.now()-this.reconnectStart,"ms. giving up"),this.logContext),this.emit(EngineEvent.Disconnected),yield this.close())}finally{this.attemptingReconnect=!1}}})}getNextRetryDelay($){try{return this.reconnectPolicy.nextRetryDelayInMs($)}catch(U){this.log.warn("encountered error in reconnect policy",Object.assign(Object.assign({},this.logContext),{error:U}))}return null}restartConnection($){return __awaiter(this,void 0,void 0,function*(){var U,F,V;try{if(!this.url||!this.token)throw new UnexpectedConnectionState("could not reconnect, url or token not saved");this.log.info("reconnecting, attempt: ".concat(this.reconnectAttempts),this.logContext),this.emit(EngineEvent.Restarting),this.client.isDisconnected||(yield this.client.sendLeave()),yield this.cleanupPeerConnections(),yield this.cleanupClient();let q;try{if(!this.signalOpts)throw this.log.warn("attempted connection restart, without signal options present",this.logContext),new SignalReconnectError;q=yield this.join($??this.url,this.token,this.signalOpts)}catch(j){throw j instanceof ConnectionError&&j.reason===ConnectionErrorReason.NotAllowed?new UnexpectedConnectionState("could not reconnect, token might be expired"):new SignalReconnectError}if(this.shouldFailNext)throw this.shouldFailNext=!1,new Error("simulated failure");if(this.client.setReconnected(),this.emit(EngineEvent.SignalRestarted,q),yield this.waitForPCReconnected(),this.client.currentState!==SignalConnectionState.CONNECTED)throw new SignalReconnectError("Signal connection got severed during reconnect");(U=this.regionUrlProvider)===null||U===void 0||U.resetAttempts(),this.emit(EngineEvent.Restarted)}catch(q){const j=yield(F=this.regionUrlProvider)===null||F===void 0?void 0:F.getNextBestRegionUrl();if(j){yield this.restartConnection(j);return}else throw(V=this.regionUrlProvider)===null||V===void 0||V.resetAttempts(),q}})}resumeConnection($){return __awaiter(this,void 0,void 0,function*(){var U;if(!this.url||!this.token)throw new UnexpectedConnectionState("could not reconnect, url or token not saved");if(!this.pcManager)throw new UnexpectedConnectionState("publisher and subscriber connections unset");this.log.info("resuming signal connection, attempt ".concat(this.reconnectAttempts),this.logContext),this.emit(EngineEvent.Resuming);let F;try{this.setupSignalClientCallbacks(),F=yield this.client.reconnect(this.url,this.token,this.participantSid,$)}catch(V){let q="";throw V instanceof Error&&(q=V.message,this.log.error(V.message,Object.assign(Object.assign({},this.logContext),{error:V}))),V instanceof ConnectionError&&V.reason===ConnectionErrorReason.NotAllowed?new UnexpectedConnectionState("could not reconnect, token might be expired"):V instanceof ConnectionError&&V.reason===ConnectionErrorReason.LeaveRequest?V:new SignalReconnectError(q)}if(this.emit(EngineEvent.SignalResumed),F){const V=this.makeRTCConfiguration(F);this.pcManager.updateConfiguration(V),this.latestJoinResponse&&(this.latestJoinResponse.serverInfo=F.serverInfo)}else this.log.warn("Did not receive reconnect response",this.logContext);if(this.shouldFailNext)throw this.shouldFailNext=!1,new Error("simulated failure");if(yield this.pcManager.triggerIceRestart(),yield this.waitForPCReconnected(),this.client.currentState!==SignalConnectionState.CONNECTED)throw new SignalReconnectError("Signal connection got severed during reconnect");this.client.setReconnected(),((U=this.reliableDC)===null||U===void 0?void 0:U.readyState)==="open"&&this.reliableDC.id===null&&this.createDataChannels(),F?.lastMessageSeq&&this.resendReliableMessagesForResume(F.lastMessageSeq),this.emit(EngineEvent.Resumed)})}waitForPCInitialConnection($,U){return __awaiter(this,void 0,void 0,function*(){if(!this.pcManager)throw new UnexpectedConnectionState("PC manager is closed");yield this.pcManager.ensurePCTransportConnection(U,$)})}waitForPCReconnected(){return __awaiter(this,void 0,void 0,function*(){this.pcState=PCState.Reconnecting,this.log.debug("waiting for peer connection to reconnect",this.logContext);try{if(yield sleep(minReconnectWait),!this.pcManager)throw new UnexpectedConnectionState("PC manager is closed");yield this.pcManager.ensurePCTransportConnection(void 0,this.peerConnectionTimeout),this.pcState=PCState.Connected}catch($){throw this.pcState=PCState.Disconnected,new ConnectionError("could not establish PC connection, ".concat($.message),ConnectionErrorReason.InternalError)}})}publishRpcResponse($,U,F,V){return __awaiter(this,void 0,void 0,function*(){const q=new DataPacket({destinationIdentities:[$],kind:DataPacket_Kind.RELIABLE,value:{case:"rpcResponse",value:new RpcResponse({requestId:U,value:V?{case:"error",value:V.toProto()}:{case:"payload",value:F??""}})}});yield this.sendDataPacket(q,DataPacket_Kind.RELIABLE)})}publishRpcAck($,U){return __awaiter(this,void 0,void 0,function*(){const F=new DataPacket({destinationIdentities:[$],kind:DataPacket_Kind.RELIABLE,value:{case:"rpcAck",value:new RpcAck({requestId:U})}});yield this.sendDataPacket(F,DataPacket_Kind.RELIABLE)})}sendDataPacket($,U){return __awaiter(this,void 0,void 0,function*(){yield this.ensurePublisherConnected(U),U===DataPacket_Kind.RELIABLE&&($.sequence=this.reliableDataSequence,this.reliableDataSequence+=1);const F=$.toBinary(),V=this.dataChannelForKind(U);if(V){if(U===DataPacket_Kind.RELIABLE&&this.reliableMessageBuffer.push({data:F,sequence:$.sequence}),this.attemptingReconnect)return;V.send(F)}this.updateAndEmitDCBufferStatus(U)})}resendReliableMessagesForResume($){return __awaiter(this,void 0,void 0,function*(){yield this.ensurePublisherConnected(DataPacket_Kind.RELIABLE);const U=this.dataChannelForKind(DataPacket_Kind.RELIABLE);U&&(this.reliableMessageBuffer.popToSequence($),this.reliableMessageBuffer.getAll().forEach(F=>{U.send(F.data)})),this.updateAndEmitDCBufferStatus(DataPacket_Kind.RELIABLE)})}waitForBufferStatusLow($){return new Promise((U,F)=>__awaiter(this,void 0,void 0,function*(){if(this.isBufferStatusLow($))U();else{const V=()=>F("Engine closed");for(this.once(EngineEvent.Closing,V);!this.dcBufferStatus.get($);)yield sleep(10);this.off(EngineEvent.Closing,V),U()}}))}ensureDataTransportConnected($){return __awaiter(this,arguments,void 0,function(U){var F=this;let V=arguments.length>1&&arguments[1]!==void 0?arguments[1]:this.subscriberPrimary;return(function*(){var q;if(!F.pcManager)throw new UnexpectedConnectionState("PC manager is closed");const j=V?F.pcManager.subscriber:F.pcManager.publisher,W=V?"Subscriber":"Publisher";if(!j)throw new ConnectionError("".concat(W," connection not set"),ConnectionErrorReason.InternalError);let K=!1;!V&&!F.dataChannelForKind(U,V)&&(F.createDataChannels(),K=!0),!K&&!V&&!F.pcManager.publisher.isICEConnected&&F.pcManager.publisher.getICEConnectionState()!=="checking"&&(K=!0),K&&F.negotiate();const G=F.dataChannelForKind(U,V);if(G?.readyState==="open")return;const z=new Date().getTime()+F.peerConnectionTimeout;for(;new Date().getTime()<z;){if(j.isICEConnected&&((q=F.dataChannelForKind(U,V))===null||q===void 0?void 0:q.readyState)==="open")return;yield sleep(50)}throw new ConnectionError("could not establish ".concat(W," connection, state: ").concat(j.getICEConnectionState()),ConnectionErrorReason.InternalError)})()})}ensurePublisherConnected($){return __awaiter(this,void 0,void 0,function*(){this.publisherConnectionPromise||(this.publisherConnectionPromise=this.ensureDataTransportConnected($,!1)),yield this.publisherConnectionPromise})}verifyTransport(){return!(!this.pcManager||this.pcManager.currentState!==PCTransportState.CONNECTED||!this.client.ws||this.client.ws.readyState===WebSocket.CLOSED)}negotiate(){return __awaiter(this,void 0,void 0,function*(){return new Promise(($,U)=>__awaiter(this,void 0,void 0,function*(){if(!this.pcManager){U(new NegotiationError("PC manager is closed"));return}this.pcManager.requirePublisher(),this.pcManager.publisher.getTransceivers().length==0&&!this.lossyDC&&!this.reliableDC&&this.createDataChannels();const F=new AbortController,V=()=>{F.abort(),this.log.debug("engine disconnected while negotiation was ongoing",this.logContext),$()};this.isClosed&&U("cannot negotiate on closed engine"),this.on(EngineEvent.Closing,V),this.pcManager.publisher.once(PCEvents.RTPVideoPayloadTypes,q=>{const j=new Map;q.forEach(W=>{const K=W.codec.toLowerCase();isVideoCodec(K)&&j.set(W.payload,K)}),this.emit(EngineEvent.RTPVideoMapUpdate,j)});try{yield this.pcManager.negotiate(F),$()}catch(q){q instanceof NegotiationError&&(this.fullReconnectOnNext=!0),this.handleDisconnect("negotiation",ReconnectReason.RR_UNKNOWN),U(q)}finally{this.off(EngineEvent.Closing,V)}}))})}dataChannelForKind($,U){if(U){if($===DataPacket_Kind.LOSSY)return this.lossyDCSub;if($===DataPacket_Kind.RELIABLE)return this.reliableDCSub}else{if($===DataPacket_Kind.LOSSY)return this.lossyDC;if($===DataPacket_Kind.RELIABLE)return this.reliableDC}}sendSyncState($,U){var F,V;if(!this.pcManager){this.log.warn("sync state cannot be sent without peer connection setup",this.logContext);return}const q=this.pcManager.subscriber.getLocalDescription(),j=this.pcManager.subscriber.getRemoteDescription(),W=(V=(F=this.signalOpts)===null||F===void 0?void 0:F.autoSubscribe)!==null&&V!==void 0?V:!0,K=new Array,G=new Array;$.forEach(z=>{z.isDesired!==W&&K.push(z.trackSid),z.isEnabled||G.push(z.trackSid)}),this.client.sendSyncState(new SyncState({answer:q?toProtoSessionDescription({sdp:q.sdp,type:q.type}):void 0,offer:j?toProtoSessionDescription({sdp:j.sdp,type:j.type}):void 0,subscription:new UpdateSubscription({trackSids:K,subscribe:!W,participantTracks:[]}),publishTracks:getTrackPublicationInfo(U),dataChannels:this.dataChannelsInfo(),trackSidsDisabled:G,datachannelReceiveStates:this.reliableReceivedState.map((z,H)=>new DataChannelReceiveState({publisherSid:H,lastSeq:z}))}))}failNext(){this.shouldFailNext=!0}dataChannelsInfo(){const $=[],U=(F,V)=>{F?.id!==void 0&&F.id!==null&&$.push(new DataChannelInfo({label:F.label,id:F.id,target:V}))};return U(this.dataChannelForKind(DataPacket_Kind.LOSSY),SignalTarget.PUBLISHER),U(this.dataChannelForKind(DataPacket_Kind.RELIABLE),SignalTarget.PUBLISHER),U(this.dataChannelForKind(DataPacket_Kind.LOSSY,!0),SignalTarget.SUBSCRIBER),U(this.dataChannelForKind(DataPacket_Kind.RELIABLE,!0),SignalTarget.SUBSCRIBER),$}clearReconnectTimeout(){this.reconnectTimeout&&CriticalTimers.clearTimeout(this.reconnectTimeout)}clearPendingReconnect(){this.clearReconnectTimeout(),this.reconnectAttempts=0}registerOnLineListener(){isWeb()&&window.addEventListener("online",this.handleBrowserOnLine)}deregisterOnLineListener(){isWeb()&&window.removeEventListener("online",this.handleBrowserOnLine)}}class SignalReconnectError extends Error{}function supportOptionalDatachannel(B){return B!==void 0&&B>13}function applyUserDataCompat(B,$){const U=B.participantIdentity?B.participantIdentity:$.participantIdentity;B.participantIdentity=U,$.participantIdentity=U;const F=B.destinationIdentities.length!==0?B.destinationIdentities:$.destinationIdentities;B.destinationIdentities=F,$.destinationIdentities=F}class RegionUrlProvider{constructor($,U){this.lastUpdateAt=0,this.settingsCacheTime=3e3,this.attemptedRegions=[],this.serverUrl=new URL($),this.token=U}updateToken($){this.token=$}isCloud(){return isCloud(this.serverUrl)}getServerUrl(){return this.serverUrl}getNextBestRegionUrl($){return __awaiter(this,void 0,void 0,function*(){if(!this.isCloud())throw Error("region availability is only supported for LiveKit Cloud domains");(!this.regionSettings||Date.now()-this.lastUpdateAt>this.settingsCacheTime)&&(this.regionSettings=yield this.fetchRegionSettings($));const U=this.regionSettings.regions.filter(F=>!this.attemptedRegions.find(V=>V.url===F.url));if(U.length>0){const F=U[0];return this.attemptedRegions.push(F),livekitLogger.debug("next region: ".concat(F.region)),F.url}else return null})}resetAttempts(){this.attemptedRegions=[]}fetchRegionSettings($){return __awaiter(this,void 0,void 0,function*(){const U=yield fetch("".concat(getCloudConfigUrl(this.serverUrl),"/regions"),{headers:{authorization:"Bearer ".concat(this.token)},signal:$});if(U.ok){const F=yield U.json();return this.lastUpdateAt=Date.now(),F}else throw new ConnectionError("Could not fetch region settings: ".concat(U.statusText),U.status===401?ConnectionErrorReason.NotAllowed:ConnectionErrorReason.InternalError,U.status)})}setServerReportedRegions($){this.regionSettings=$,this.lastUpdateAt=Date.now()}}function getCloudConfigUrl(B){return"".concat(B.protocol.replace("ws","http"),"//").concat(B.host,"/settings")}class BaseStreamReader{get info(){return this._info}validateBytesReceived(){let $=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1;if(!(typeof this.totalByteSize!="number"||this.totalByteSize===0)){if($&&this.bytesReceived<this.totalByteSize)throw new DataStreamError("Not enough chunk(s) received - expected ".concat(this.totalByteSize," bytes of data total, only received ").concat(this.bytesReceived," bytes"),DataStreamErrorReason.Incomplete);if(this.bytesReceived>this.totalByteSize)throw new DataStreamError("Extra chunk(s) received - expected ".concat(this.totalByteSize," bytes of data total, received ").concat(this.bytesReceived," bytes"),DataStreamErrorReason.LengthExceeded)}}constructor($,U,F,V){this.reader=U,this.totalByteSize=F,this._info=$,this.bytesReceived=0,this.outOfBandFailureRejectingFuture=V}}class ByteStreamReader extends BaseStreamReader{handleChunkReceived($){var U;this.bytesReceived+=$.content.byteLength,this.validateBytesReceived();const F=this.totalByteSize?this.bytesReceived/this.totalByteSize:void 0;(U=this.onProgress)===null||U===void 0||U.call(this,F)}[Symbol.asyncIterator](){const $=this.reader.getReader();let U=new Future,F=null,V=null;if(this.signal){const j=this.signal;V=()=>{var W;(W=U.reject)===null||W===void 0||W.call(U,j.reason)},j.addEventListener("abort",V),F=j}const q=()=>{$.releaseLock(),F&&V&&F.removeEventListener("abort",V),this.signal=void 0};return{next:()=>__awaiter(this,void 0,void 0,function*(){var j,W;try{const{done:K,value:G}=yield Promise.race([$.read(),U.promise,(W=(j=this.outOfBandFailureRejectingFuture)===null||j===void 0?void 0:j.promise)!==null&&W!==void 0?W:new Promise(()=>{})]);return K?(this.validateBytesReceived(!0),{done:!0,value:void 0}):(this.handleChunkReceived(G),{done:!1,value:G.content})}catch(K){throw q(),K}}),return(){return __awaiter(this,void 0,void 0,function*(){return q(),{done:!0,value:void 0}})}}}withAbortSignal($){return this.signal=$,this}readAll(){return __awaiter(this,arguments,void 0,function(){var $=this;let U=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return(function*(){var F,V,q,j;let W=new Set;const K=U.signal?$.withAbortSignal(U.signal):$;try{for(var G=!0,z=__asyncValues(K),H;H=yield z.next(),F=H.done,!F;G=!0){j=H.value,G=!1;const Q=j;W.add(Q)}}catch(Q){V={error:Q}}finally{try{!G&&!F&&(q=z.return)&&(yield q.call(z))}finally{if(V)throw V.error}}return Array.from(W)})()})}}class TextStreamReader extends BaseStreamReader{constructor($,U,F,V){super($,U,F,V),this.receivedChunks=new Map}handleChunkReceived($){var U;const F=bigIntToNumber($.chunkIndex),V=this.receivedChunks.get(F);if(V&&V.version>$.version)return;this.receivedChunks.set(F,$),this.bytesReceived+=$.content.byteLength,this.validateBytesReceived();const q=this.totalByteSize?this.bytesReceived/this.totalByteSize:void 0;(U=this.onProgress)===null||U===void 0||U.call(this,q)}[Symbol.asyncIterator](){const $=this.reader.getReader(),U=new TextDecoder("utf-8",{fatal:!0});let F=new Future,V=null,q=null;if(this.signal){const W=this.signal;q=()=>{var K;(K=F.reject)===null||K===void 0||K.call(F,W.reason)},W.addEventListener("abort",q),V=W}const j=()=>{$.releaseLock(),V&&q&&V.removeEventListener("abort",q),this.signal=void 0};return{next:()=>__awaiter(this,void 0,void 0,function*(){var W,K;try{const{done:G,value:z}=yield Promise.race([$.read(),F.promise,(K=(W=this.outOfBandFailureRejectingFuture)===null||W===void 0?void 0:W.promise)!==null&&K!==void 0?K:new Promise(()=>{})]);if(G)return this.validateBytesReceived(!0),{done:!0,value:void 0};{this.handleChunkReceived(z);let H;try{H=U.decode(z.content)}catch(Q){throw new DataStreamError("Cannot decode datastream chunk ".concat(z.chunkIndex," as text: ").concat(Q),DataStreamErrorReason.DecodeFailed)}return{done:!1,value:H}}}catch(G){throw j(),G}}),return(){return __awaiter(this,void 0,void 0,function*(){return j(),{done:!0,value:void 0}})}}}withAbortSignal($){return this.signal=$,this}readAll(){return __awaiter(this,arguments,void 0,function(){var $=this;let U=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return(function*(){var F,V,q,j;let W="";const K=U.signal?$.withAbortSignal(U.signal):$;try{for(var G=!0,z=__asyncValues(K),H;H=yield z.next(),F=H.done,!F;G=!0)j=H.value,G=!1,W+=j}catch(Q){V={error:Q}}finally{try{!G&&!F&&(q=z.return)&&(yield q.call(z))}finally{if(V)throw V.error}}return W})()})}}class IncomingDataStreamManager{constructor(){this.log=livekitLogger,this.byteStreamControllers=new Map,this.textStreamControllers=new Map,this.byteStreamHandlers=new Map,this.textStreamHandlers=new Map}registerTextStreamHandler($,U){if(this.textStreamHandlers.has($))throw new DataStreamError('A text stream handler for topic "'.concat($,'" has already been set.'),DataStreamErrorReason.HandlerAlreadyRegistered);this.textStreamHandlers.set($,U)}unregisterTextStreamHandler($){this.textStreamHandlers.delete($)}registerByteStreamHandler($,U){if(this.byteStreamHandlers.has($))throw new DataStreamError('A byte stream handler for topic "'.concat($,'" has already been set.'),DataStreamErrorReason.HandlerAlreadyRegistered);this.byteStreamHandlers.set($,U)}unregisterByteStreamHandler($){this.byteStreamHandlers.delete($)}clearHandlersAndControllers(){this.byteStreamControllers.clear(),this.textStreamControllers.clear(),this.byteStreamHandlers.clear(),this.textStreamHandlers.clear()}validateParticipantHasNoActiveDataStreams($){var U,F,V,q;const j=Array.from(this.textStreamControllers.entries()).filter(K=>K[1].sendingParticipantIdentity===$),W=Array.from(this.byteStreamControllers.entries()).filter(K=>K[1].sendingParticipantIdentity===$);if(j.length>0||W.length>0){const K=new DataStreamError("Participant ".concat($," unexpectedly disconnected in the middle of sending data"),DataStreamErrorReason.AbnormalEnd);for(const[G,z]of W)(F=(U=z.outOfBandFailureRejectingFuture).reject)===null||F===void 0||F.call(U,K),this.byteStreamControllers.delete(G);for(const[G,z]of j)(q=(V=z.outOfBandFailureRejectingFuture).reject)===null||q===void 0||q.call(V,K),this.textStreamControllers.delete(G)}}handleDataStreamPacket($){return __awaiter(this,void 0,void 0,function*(){switch($.value.case){case"streamHeader":return this.handleStreamHeader($.value.value,$.participantIdentity);case"streamChunk":return this.handleStreamChunk($.value.value);case"streamTrailer":return this.handleStreamTrailer($.value.value);default:throw new Error('DataPacket of value "'.concat($.value.case,'" is not data stream related!'))}})}handleStreamHeader($,U){return __awaiter(this,void 0,void 0,function*(){var F;if($.contentHeader.case==="byteHeader"){const V=this.byteStreamHandlers.get($.topic);if(!V){this.log.debug("ignoring incoming byte stream due to no handler for topic",$.topic);return}let q;const j=new Future,W={id:$.streamId,name:(F=$.contentHeader.value.name)!==null&&F!==void 0?F:"unknown",mimeType:$.mimeType,size:$.totalLength?Number($.totalLength):void 0,topic:$.topic,timestamp:bigIntToNumber($.timestamp),attributes:$.attributes},K=new ReadableStream({start:G=>{if(q=G,this.textStreamControllers.has($.streamId))throw new DataStreamError("A data stream read is already in progress for a stream with id ".concat($.streamId,"."),DataStreamErrorReason.AlreadyOpened);this.byteStreamControllers.set($.streamId,{info:W,controller:q,startTime:Date.now(),sendingParticipantIdentity:U,outOfBandFailureRejectingFuture:j})}});V(new ByteStreamReader(W,K,bigIntToNumber($.totalLength),j),{identity:U})}else if($.contentHeader.case==="textHeader"){const V=this.textStreamHandlers.get($.topic);if(!V){this.log.debug("ignoring incoming text stream due to no handler for topic",$.topic);return}let q;const j=new Future,W={id:$.streamId,mimeType:$.mimeType,size:$.totalLength?Number($.totalLength):void 0,topic:$.topic,timestamp:Number($.timestamp),attributes:$.attributes},K=new ReadableStream({start:G=>{if(q=G,this.textStreamControllers.has($.streamId))throw new DataStreamError("A data stream read is already in progress for a stream with id ".concat($.streamId,"."),DataStreamErrorReason.AlreadyOpened);this.textStreamControllers.set($.streamId,{info:W,controller:q,startTime:Date.now(),sendingParticipantIdentity:U,outOfBandFailureRejectingFuture:j})}});V(new TextStreamReader(W,K,bigIntToNumber($.totalLength),j),{identity:U})}})}handleStreamChunk($){const U=this.byteStreamControllers.get($.streamId);U&&$.content.length>0&&U.controller.enqueue($);const F=this.textStreamControllers.get($.streamId);F&&$.content.length>0&&F.controller.enqueue($)}handleStreamTrailer($){const U=this.textStreamControllers.get($.streamId);U&&(U.info.attributes=Object.assign(Object.assign({},U.info.attributes),$.attributes),U.controller.close(),this.textStreamControllers.delete($.streamId));const F=this.byteStreamControllers.get($.streamId);F&&(F.info.attributes=Object.assign(Object.assign({},F.info.attributes),$.attributes),F.controller.close(),this.byteStreamControllers.delete($.streamId))}}class BaseStreamWriter{constructor($,U,F){this.writableStream=$,this.defaultWriter=$.getWriter(),this.onClose=F,this.info=U}write($){return this.defaultWriter.write($)}close(){return __awaiter(this,void 0,void 0,function*(){var $;yield this.defaultWriter.close(),this.defaultWriter.releaseLock(),($=this.onClose)===null||$===void 0||$.call(this)})}}class TextStreamWriter extends BaseStreamWriter{}class ByteStreamWriter extends BaseStreamWriter{}const STREAM_CHUNK_SIZE=15e3;class OutgoingDataStreamManager{constructor($,U){this.engine=$,this.log=U}setupEngine($){this.engine=$}sendText($,U){return __awaiter(this,void 0,void 0,function*(){var F;const V=crypto.randomUUID(),j=new TextEncoder().encode($).byteLength,W=(F=U?.attachments)===null||F===void 0?void 0:F.map(()=>crypto.randomUUID()),K=new Array(W?W.length+1:1).fill(0),G=(H,Q)=>{var Y;K[Q]=H;const X=K.reduce((Z,ne)=>Z+ne,0);(Y=U?.onProgress)===null||Y===void 0||Y.call(U,X)},z=yield this.streamText({streamId:V,totalSize:j,destinationIdentities:U?.destinationIdentities,topic:U?.topic,attachedStreamIds:W,attributes:U?.attributes});return yield z.write($),G(1,0),yield z.close(),U?.attachments&&W&&(yield Promise.all(U.attachments.map((H,Q)=>__awaiter(this,void 0,void 0,function*(){return this._sendFile(W[Q],H,{topic:U.topic,mimeType:H.type,onProgress:Y=>{G(Y,Q+1)}})})))),z.info})}streamText($){return __awaiter(this,void 0,void 0,function*(){var U,F;const V=(U=$?.streamId)!==null&&U!==void 0?U:crypto.randomUUID(),q={id:V,mimeType:"text/plain",timestamp:Date.now(),topic:(F=$?.topic)!==null&&F!==void 0?F:"",size:$?.totalSize,attributes:$?.attributes},j=new DataStream_Header({streamId:V,mimeType:q.mimeType,topic:q.topic,timestamp:numberToBigInt(q.timestamp),totalLength:numberToBigInt($?.totalSize),attributes:q.attributes,contentHeader:{case:"textHeader",value:new DataStream_TextHeader({version:$?.version,attachedStreamIds:$?.attachedStreamIds,replyToStreamId:$?.replyToStreamId,operationType:$?.type==="update"?DataStream_OperationType.UPDATE:DataStream_OperationType.CREATE})}}),W=$?.destinationIdentities,K=new DataPacket({destinationIdentities:W,value:{case:"streamHeader",value:j}});yield this.engine.sendDataPacket(K,DataPacket_Kind.RELIABLE);let G=0;const z=this.engine,H=new WritableStream({write(X){return __awaiter(this,void 0,void 0,function*(){for(const Z of splitUtf8(X,STREAM_CHUNK_SIZE)){yield z.waitForBufferStatusLow(DataPacket_Kind.RELIABLE);const ne=new DataStream_Chunk({content:Z,streamId:V,chunkIndex:numberToBigInt(G)}),ee=new DataPacket({destinationIdentities:W,value:{case:"streamChunk",value:ne}});yield z.sendDataPacket(ee,DataPacket_Kind.RELIABLE),G+=1}})},close(){return __awaiter(this,void 0,void 0,function*(){const X=new DataStream_Trailer({streamId:V}),Z=new DataPacket({destinationIdentities:W,value:{case:"streamTrailer",value:X}});yield z.sendDataPacket(Z,DataPacket_Kind.RELIABLE)})},abort(X){console.log("Sink error:",X)}});let Q=()=>__awaiter(this,void 0,void 0,function*(){yield Y.close()});z.once(EngineEvent.Closing,Q);const Y=new TextStreamWriter(H,q,()=>this.engine.off(EngineEvent.Closing,Q));return Y})}sendFile($,U){return __awaiter(this,void 0,void 0,function*(){const F=crypto.randomUUID();return yield this._sendFile(F,$,U),{id:F}})}_sendFile($,U,F){return __awaiter(this,void 0,void 0,function*(){var V;const q=yield this.streamBytes({streamId:$,totalSize:U.size,name:U.name,mimeType:(V=F?.mimeType)!==null&&V!==void 0?V:U.type,topic:F?.topic,destinationIdentities:F?.destinationIdentities}),j=U.stream().getReader();for(;;){const{done:W,value:K}=yield j.read();if(W)break;yield q.write(K)}return yield q.close(),q.info})}streamBytes($){return __awaiter(this,void 0,void 0,function*(){var U,F,V,q,j;const W=(U=$?.streamId)!==null&&U!==void 0?U:crypto.randomUUID(),K=$?.destinationIdentities,G={id:W,mimeType:(F=$?.mimeType)!==null&&F!==void 0?F:"application/octet-stream",topic:(V=$?.topic)!==null&&V!==void 0?V:"",timestamp:Date.now(),attributes:$?.attributes,size:$?.totalSize,name:(q=$?.name)!==null&&q!==void 0?q:"unknown"},z=new DataStream_Header({totalLength:numberToBigInt((j=G.size)!==null&&j!==void 0?j:0),mimeType:G.mimeType,streamId:W,topic:G.topic,timestamp:numberToBigInt(Date.now()),attributes:G.attributes,contentHeader:{case:"byteHeader",value:new DataStream_ByteHeader({name:G.name})}}),H=new DataPacket({destinationIdentities:K,value:{case:"streamHeader",value:z}});yield this.engine.sendDataPacket(H,DataPacket_Kind.RELIABLE);let Q=0;const Y=new _,X=this.engine,Z=this.log,ne=new WritableStream({write(ie){return __awaiter(this,void 0,void 0,function*(){const se=yield Y.lock();let te=0;try{for(;te<ie.byteLength;){const re=ie.slice(te,te+STREAM_CHUNK_SIZE);yield X.waitForBufferStatusLow(DataPacket_Kind.RELIABLE);const ae=new DataPacket({destinationIdentities:K,value:{case:"streamChunk",value:new DataStream_Chunk({content:re,streamId:W,chunkIndex:numberToBigInt(Q)})}});yield X.sendDataPacket(ae,DataPacket_Kind.RELIABLE),Q+=1,te+=re.byteLength}}finally{se()}})},close(){return __awaiter(this,void 0,void 0,function*(){const ie=new DataStream_Trailer({streamId:W}),se=new DataPacket({destinationIdentities:K,value:{case:"streamTrailer",value:ie}});yield X.sendDataPacket(se,DataPacket_Kind.RELIABLE)})},abort(ie){Z.error("Sink error:",ie)}});return new ByteStreamWriter(ne,G)})}}class RemoteTrack extends Track{constructor($,U,F,V,q){super($,F,q),this.sid=U,this.receiver=V}get isLocal(){return!1}setMuted($){this.isMuted!==$&&(this.isMuted=$,this._mediaStreamTrack.enabled=!$,this.emit($?TrackEvent.Muted:TrackEvent.Unmuted,this))}setMediaStream($){this.mediaStream=$;const U=F=>{F.track===this._mediaStreamTrack&&($.removeEventListener("removetrack",U),this.receiver&&"playoutDelayHint"in this.receiver&&(this.receiver.playoutDelayHint=void 0),this.receiver=void 0,this._currentBitrate=0,this.emit(TrackEvent.Ended,this))};$.addEventListener("removetrack",U)}start(){this.startMonitor(),super.enable()}stop(){this.stopMonitor(),super.disable()}getRTCStatsReport(){return __awaiter(this,void 0,void 0,function*(){var $;return!(($=this.receiver)===null||$===void 0)&&$.getStats?yield this.receiver.getStats():void 0})}setPlayoutDelay($){this.receiver?"playoutDelayHint"in this.receiver?this.receiver.playoutDelayHint=$:this.log.warn("Playout delay not supported in this browser"):this.log.warn("Cannot set playout delay, track already ended")}getPlayoutDelay(){if(this.receiver){if("playoutDelayHint"in this.receiver)return this.receiver.playoutDelayHint;this.log.warn("Playout delay not supported in this browser")}else this.log.warn("Cannot get playout delay, track already ended");return 0}startMonitor(){this.monitorInterval||(this.monitorInterval=setInterval(()=>this.monitorReceiver(),monitorFrequency)),supportsSynchronizationSources()&&this.registerTimeSyncUpdate()}registerTimeSyncUpdate(){const $=()=>{var U;this.timeSyncHandle=requestAnimationFrame(()=>$());const F=(U=this.receiver)===null||U===void 0?void 0:U.getSynchronizationSources()[0];if(F){const{timestamp:V,rtpTimestamp:q}=F;q&&this.rtpTimestamp!==q&&(this.emit(TrackEvent.TimeSyncUpdate,{timestamp:V,rtpTimestamp:q}),this.rtpTimestamp=q)}};$()}}class RemoteAudioTrack extends RemoteTrack{constructor($,U,F,V,q,j){super($,U,Track.Kind.Audio,F,j),this.monitorReceiver=()=>__awaiter(this,void 0,void 0,function*(){if(!this.receiver){this._currentBitrate=0;return}const W=yield this.getReceiverStats();W&&this.prevStats&&this.receiver&&(this._currentBitrate=computeBitrate(W,this.prevStats)),this.prevStats=W}),this.audioContext=V,this.webAudioPluginNodes=[],q&&(this.sinkId=q.deviceId)}setVolume($){var U;for(const F of this.attachedElements)this.audioContext?(U=this.gainNode)===null||U===void 0||U.gain.setTargetAtTime($,0,.1):F.volume=$;isReactNative()&&this._mediaStreamTrack._setVolume($),this.elementVolume=$}getVolume(){if(this.elementVolume)return this.elementVolume;if(isReactNative())return 1;let $=0;return this.attachedElements.forEach(U=>{U.volume>$&&($=U.volume)}),$}setSinkId($){return __awaiter(this,void 0,void 0,function*(){this.sinkId=$,yield Promise.all(this.attachedElements.map(U=>{if(supportsSetSinkId(U))return U.setSinkId($)}))})}attach($){const U=this.attachedElements.length===0;return $?super.attach($):$=super.attach(),this.sinkId&&supportsSetSinkId($)&&$.setSinkId(this.sinkId).catch(F=>{this.log.error("Failed to set sink id on remote audio track",F,this.logContext)}),this.audioContext&&U&&(this.log.debug("using audio context mapping",this.logContext),this.connectWebAudio(this.audioContext,$),$.volume=0,$.muted=!0),this.elementVolume&&this.setVolume(this.elementVolume),$}detach($){let U;return $?(U=super.detach($),this.audioContext&&(this.attachedElements.length>0?this.connectWebAudio(this.audioContext,this.attachedElements[0]):this.disconnectWebAudio())):(U=super.detach(),this.disconnectWebAudio()),U}setAudioContext($){this.audioContext=$,$&&this.attachedElements.length>0?this.connectWebAudio($,this.attachedElements[0]):$||this.disconnectWebAudio()}setWebAudioPlugins($){this.webAudioPluginNodes=$,this.attachedElements.length>0&&this.audioContext&&this.connectWebAudio(this.audioContext,this.attachedElements[0])}connectWebAudio($,U){this.disconnectWebAudio(),this.sourceNode=$.createMediaStreamSource(U.srcObject);let F=this.sourceNode;this.webAudioPluginNodes.forEach(V=>{F.connect(V),F=V}),this.gainNode=$.createGain(),F.connect(this.gainNode),this.gainNode.connect($.destination),this.elementVolume&&this.gainNode.gain.setTargetAtTime(this.elementVolume,0,.1),$.state!=="running"&&$.resume().then(()=>{$.state!=="running"&&this.emit(TrackEvent.AudioPlaybackFailed,new Error("Audio Context couldn't be started automatically"))}).catch(V=>{this.emit(TrackEvent.AudioPlaybackFailed,V)})}disconnectWebAudio(){var $,U;($=this.gainNode)===null||$===void 0||$.disconnect(),(U=this.sourceNode)===null||U===void 0||U.disconnect(),this.gainNode=void 0,this.sourceNode=void 0}getReceiverStats(){return __awaiter(this,void 0,void 0,function*(){if(!this.receiver||!this.receiver.getStats)return;const $=yield this.receiver.getStats();let U;return $.forEach(F=>{F.type==="inbound-rtp"&&(U={type:"audio",streamId:F.id,timestamp:F.timestamp,jitter:F.jitter,bytesReceived:F.bytesReceived,concealedSamples:F.concealedSamples,concealmentEvents:F.concealmentEvents,silentConcealedSamples:F.silentConcealedSamples,silentConcealmentEvents:F.silentConcealmentEvents,totalAudioEnergy:F.totalAudioEnergy,totalSamplesDuration:F.totalSamplesDuration})}),U})}}const REACTION_DELAY=100;class RemoteVideoTrack extends RemoteTrack{constructor($,U,F,V,q){super($,U,Track.Kind.Video,F,q),this.elementInfos=[],this.monitorReceiver=()=>__awaiter(this,void 0,void 0,function*(){if(!this.receiver){this._currentBitrate=0;return}const j=yield this.getReceiverStats();j&&this.prevStats&&this.receiver&&(this._currentBitrate=computeBitrate(j,this.prevStats)),this.prevStats=j}),this.debouncedHandleResize=r(()=>{this.updateDimensions()},REACTION_DELAY),this.adaptiveStreamSettings=V}get isAdaptiveStream(){return this.adaptiveStreamSettings!==void 0}setStreamState($){super.setStreamState($),console.log("setStreamState",$),$===Track.StreamState.Active&&this.updateVisibility()}get mediaStreamTrack(){return this._mediaStreamTrack}setMuted($){super.setMuted($),this.attachedElements.forEach(U=>{$?detachTrack(this._mediaStreamTrack,U):attachToElement(this._mediaStreamTrack,U)})}attach($){if($?super.attach($):$=super.attach(),this.adaptiveStreamSettings&&this.elementInfos.find(U=>U.element===$)===void 0){const U=new HTMLElementInfo($);this.observeElementInfo(U)}return $}observeElementInfo($){this.adaptiveStreamSettings&&this.elementInfos.find(U=>U===$)===void 0?($.handleResize=()=>{this.debouncedHandleResize()},$.handleVisibilityChanged=()=>{this.updateVisibility()},this.elementInfos.push($),$.observe(),this.debouncedHandleResize(),this.updateVisibility()):this.log.warn("visibility resize observer not triggered",this.logContext)}stopObservingElementInfo($){if(!this.isAdaptiveStream){this.log.warn("stopObservingElementInfo ignored",this.logContext);return}const U=this.elementInfos.filter(F=>F===$);for(const F of U)F.stopObserving();this.elementInfos=this.elementInfos.filter(F=>F!==$),this.updateVisibility(),this.debouncedHandleResize()}detach($){let U=[];if($)return this.stopObservingElement($),super.detach($);U=super.detach();for(const F of U)this.stopObservingElement(F);return U}getDecoderImplementation(){var $;return($=this.prevStats)===null||$===void 0?void 0:$.decoderImplementation}getReceiverStats(){return __awaiter(this,void 0,void 0,function*(){if(!this.receiver||!this.receiver.getStats)return;const $=yield this.receiver.getStats();let U,F="",V=new Map;return $.forEach(q=>{q.type==="inbound-rtp"?(F=q.codecId,U={type:"video",streamId:q.id,framesDecoded:q.framesDecoded,framesDropped:q.framesDropped,framesReceived:q.framesReceived,packetsReceived:q.packetsReceived,packetsLost:q.packetsLost,frameWidth:q.frameWidth,frameHeight:q.frameHeight,pliCount:q.pliCount,firCount:q.firCount,nackCount:q.nackCount,jitter:q.jitter,timestamp:q.timestamp,bytesReceived:q.bytesReceived,decoderImplementation:q.decoderImplementation}):q.type==="codec"&&V.set(q.id,q)}),U&&F!==""&&V.get(F)&&(U.mimeType=V.get(F).mimeType),U})}stopObservingElement($){const U=this.elementInfos.filter(F=>F.element===$);for(const F of U)this.stopObservingElementInfo(F)}handleAppVisibilityChanged(){const $=Object.create(null,{handleAppVisibilityChanged:{get:()=>super.handleAppVisibilityChanged}});return __awaiter(this,void 0,void 0,function*(){yield $.handleAppVisibilityChanged.call(this),this.isAdaptiveStream&&this.updateVisibility()})}updateVisibility($){var U,F;const V=this.elementInfos.reduce((K,G)=>Math.max(K,G.visibilityChangedAt||0),0),q=!((F=(U=this.adaptiveStreamSettings)===null||U===void 0?void 0:U.pauseVideoInBackground)!==null&&F!==void 0)||F?this.isInBackground:!1,j=this.elementInfos.some(K=>K.pictureInPicture),W=this.elementInfos.some(K=>K.visible)&&!q||j;if(!(this.lastVisible===W&&!$)){if(!W&&Date.now()-V<REACTION_DELAY){CriticalTimers.setTimeout(()=>{this.updateVisibility()},REACTION_DELAY);return}this.lastVisible=W,this.emit(TrackEvent.VisibilityChanged,W,this)}}updateDimensions(){var $,U;let F=0,V=0;const q=this.getPixelDensity();for(const j of this.elementInfos){const W=j.width()*q,K=j.height()*q;W+K>F+V&&(F=W,V=K)}(($=this.lastDimensions)===null||$===void 0?void 0:$.width)===F&&((U=this.lastDimensions)===null||U===void 0?void 0:U.height)===V||(this.lastDimensions={width:F,height:V},this.emit(TrackEvent.VideoDimensionsChanged,this.lastDimensions,this))}getPixelDensity(){var $;const U=($=this.adaptiveStreamSettings)===null||$===void 0?void 0:$.pixelDensity;return U==="screen"?getDevicePixelRatio():U||(getDevicePixelRatio()>2?2:1)}}class HTMLElementInfo{get visible(){return this.isPiP||this.isIntersecting}get pictureInPicture(){return this.isPiP}constructor($,U){this.onVisibilityChanged=F=>{var V;const{target:q,isIntersecting:j}=F;q===this.element&&(this.isIntersecting=j,this.isPiP=isElementInPiP(this.element),this.visibilityChangedAt=Date.now(),(V=this.handleVisibilityChanged)===null||V===void 0||V.call(this))},this.onEnterPiP=()=>{var F,V,q;(V=(F=window.documentPictureInPicture)===null||F===void 0?void 0:F.window)===null||V===void 0||V.addEventListener("pagehide",this.onLeavePiP),this.isPiP=isElementInPiP(this.element),(q=this.handleVisibilityChanged)===null||q===void 0||q.call(this)},this.onLeavePiP=()=>{var F;this.isPiP=isElementInPiP(this.element),(F=this.handleVisibilityChanged)===null||F===void 0||F.call(this)},this.element=$,this.isIntersecting=U??isElementInViewport($),this.isPiP=isWeb()&&isElementInPiP($),this.visibilityChangedAt=0}width(){return this.element.clientWidth}height(){return this.element.clientHeight}observe(){var $,U,F;this.isIntersecting=isElementInViewport(this.element),this.isPiP=isElementInPiP(this.element),this.element.handleResize=()=>{var V;(V=this.handleResize)===null||V===void 0||V.call(this)},this.element.handleVisibilityChanged=this.onVisibilityChanged,getIntersectionObserver().observe(this.element),getResizeObserver().observe(this.element),this.element.addEventListener("enterpictureinpicture",this.onEnterPiP),this.element.addEventListener("leavepictureinpicture",this.onLeavePiP),($=window.documentPictureInPicture)===null||$===void 0||$.addEventListener("enter",this.onEnterPiP),(F=(U=window.documentPictureInPicture)===null||U===void 0?void 0:U.window)===null||F===void 0||F.addEventListener("pagehide",this.onLeavePiP)}stopObserving(){var $,U,F,V,q;($=getIntersectionObserver())===null||$===void 0||$.unobserve(this.element),(U=getResizeObserver())===null||U===void 0||U.unobserve(this.element),this.element.removeEventListener("enterpictureinpicture",this.onEnterPiP),this.element.removeEventListener("leavepictureinpicture",this.onLeavePiP),(F=window.documentPictureInPicture)===null||F===void 0||F.removeEventListener("enter",this.onEnterPiP),(q=(V=window.documentPictureInPicture)===null||V===void 0?void 0:V.window)===null||q===void 0||q.removeEventListener("pagehide",this.onLeavePiP)}}function isElementInPiP(B){var $,U;return document.pictureInPictureElement===B?!0:!(($=window.documentPictureInPicture)===null||$===void 0)&&$.window?isElementInViewport(B,(U=window.documentPictureInPicture)===null||U===void 0?void 0:U.window):!1}function isElementInViewport(B,$){const U=$||window;let F=B.offsetTop,V=B.offsetLeft;const q=B.offsetWidth,j=B.offsetHeight,{hidden:W}=B,{display:K}=getComputedStyle(B);for(;B.offsetParent;)B=B.offsetParent,F+=B.offsetTop,V+=B.offsetLeft;return F<U.pageYOffset+U.innerHeight&&V<U.pageXOffset+U.innerWidth&&F+j>U.pageYOffset&&V+q>U.pageXOffset&&!W&&K!=="none"}class TrackPublication extends eventsExports.EventEmitter{constructor($,U,F,V){var q;super(),this.metadataMuted=!1,this.encryption=Encryption_Type.NONE,this.log=livekitLogger,this.handleMuted=()=>{this.emit(TrackEvent.Muted)},this.handleUnmuted=()=>{this.emit(TrackEvent.Unmuted)},this.log=getLogger((q=V?.loggerName)!==null&&q!==void 0?q:LoggerNames.Publication),this.loggerContextCb=this.loggerContextCb,this.setMaxListeners(100),this.kind=$,this.trackSid=U,this.trackName=F,this.source=Track.Source.Unknown}setTrack($){this.track&&(this.track.off(TrackEvent.Muted,this.handleMuted),this.track.off(TrackEvent.Unmuted,this.handleUnmuted)),this.track=$,$&&($.on(TrackEvent.Muted,this.handleMuted),$.on(TrackEvent.Unmuted,this.handleUnmuted))}get logContext(){var $;return Object.assign(Object.assign({},($=this.loggerContextCb)===null||$===void 0?void 0:$.call(this)),getLogContextFromTrack(this))}get isMuted(){return this.metadataMuted}get isEnabled(){return!0}get isSubscribed(){return this.track!==void 0}get isEncrypted(){return this.encryption!==Encryption_Type.NONE}get audioTrack(){if(isAudioTrack(this.track))return this.track}get videoTrack(){if(isVideoTrack(this.track))return this.track}updateInfo($){this.trackSid=$.sid,this.trackName=$.name,this.source=Track.sourceFromProto($.source),this.mimeType=$.mimeType,this.kind===Track.Kind.Video&&$.width>0&&(this.dimensions={width:$.width,height:$.height},this.simulcasted=$.simulcast),this.encryption=$.encryption,this.trackInfo=$,this.log.debug("update publication info",Object.assign(Object.assign({},this.logContext),{info:$}))}}(function(B){(function($){$.Desired="desired",$.Subscribed="subscribed",$.Unsubscribed="unsubscribed"})(B.SubscriptionStatus||(B.SubscriptionStatus={})),(function($){$.Allowed="allowed",$.NotAllowed="not_allowed"})(B.PermissionStatus||(B.PermissionStatus={}))})(TrackPublication||(TrackPublication={}));class LocalTrackPublication extends TrackPublication{get isUpstreamPaused(){var $;return($=this.track)===null||$===void 0?void 0:$.isUpstreamPaused}constructor($,U,F,V){super($,U.sid,U.name,V),this.track=void 0,this.handleTrackEnded=()=>{this.emit(TrackEvent.Ended)},this.handleCpuConstrained=()=>{this.track&&isVideoTrack(this.track)&&this.emit(TrackEvent.CpuConstrained,this.track)},this.updateInfo(U),this.setTrack(F)}setTrack($){this.track&&(this.track.off(TrackEvent.Ended,this.handleTrackEnded),this.track.off(TrackEvent.CpuConstrained,this.handleCpuConstrained)),super.setTrack($),$&&($.on(TrackEvent.Ended,this.handleTrackEnded),$.on(TrackEvent.CpuConstrained,this.handleCpuConstrained))}get isMuted(){return this.track?this.track.isMuted:super.isMuted}get audioTrack(){return super.audioTrack}get videoTrack(){return super.videoTrack}get isLocal(){return!0}mute(){return __awaiter(this,void 0,void 0,function*(){var $;return($=this.track)===null||$===void 0?void 0:$.mute()})}unmute(){return __awaiter(this,void 0,void 0,function*(){var $;return($=this.track)===null||$===void 0?void 0:$.unmute()})}pauseUpstream(){return __awaiter(this,void 0,void 0,function*(){var $;yield($=this.track)===null||$===void 0?void 0:$.pauseUpstream()})}resumeUpstream(){return __awaiter(this,void 0,void 0,function*(){var $;yield($=this.track)===null||$===void 0?void 0:$.resumeUpstream()})}getTrackFeatures(){var $;if(isAudioTrack(this.track)){const U=this.track.getSourceTrackSettings(),F=new Set;return U.autoGainControl&&F.add(AudioTrackFeature.TF_AUTO_GAIN_CONTROL),U.echoCancellation&&F.add(AudioTrackFeature.TF_ECHO_CANCELLATION),U.noiseSuppression&&F.add(AudioTrackFeature.TF_NOISE_SUPPRESSION),U.channelCount&&U.channelCount>1&&F.add(AudioTrackFeature.TF_STEREO),!(($=this.options)===null||$===void 0)&&$.dtx||F.add(AudioTrackFeature.TF_NO_DTX),this.track.enhancedNoiseCancellation&&F.add(AudioTrackFeature.TF_ENHANCED_NOISE_CANCELLATION),Array.from(F.values())}else return[]}}function createLocalTracks(B,$){return __awaiter(this,void 0,void 0,function*(){B??(B={});let U=!1;const{audioProcessor:F,videoProcessor:V,optionsWithoutProcessor:q}=extractProcessorsFromOptions(B);let j=q.audio,W=q.video;if(F&&typeof q.audio=="object"&&(q.audio.processor=F),V&&typeof q.video=="object"&&(q.video.processor=V),B.audio&&typeof q.audio=="object"&&typeof q.audio.deviceId=="string"){const H=q.audio.deviceId;q.audio.deviceId={exact:H},U=!0,j=Object.assign(Object.assign({},q.audio),{deviceId:{ideal:H}})}if(q.video&&typeof q.video=="object"&&typeof q.video.deviceId=="string"){const H=q.video.deviceId;q.video.deviceId={exact:H},U=!0,W=Object.assign(Object.assign({},q.video),{deviceId:{ideal:H}})}(q.audio===!0||typeof q.audio=="object"&&!q.audio.deviceId)&&(q.audio={deviceId:"default"}),q.video===!0?q.video={deviceId:"default"}:typeof q.video=="object"&&!q.video.deviceId&&(q.video.deviceId="default");const K=mergeDefaultOptions(q,audioDefaults,videoDefaults),G=constraintsForOptions(K),z=navigator.mediaDevices.getUserMedia(G);q.audio&&(DeviceManager.userMediaPromiseMap.set("audioinput",z),z.catch(()=>DeviceManager.userMediaPromiseMap.delete("audioinput"))),q.video&&(DeviceManager.userMediaPromiseMap.set("videoinput",z),z.catch(()=>DeviceManager.userMediaPromiseMap.delete("videoinput")));try{const H=yield z;return yield Promise.all(H.getTracks().map(Q=>__awaiter(this,void 0,void 0,function*(){const Y=Q.kind==="audio";let X=Y?K.audio:K.video;(typeof X=="boolean"||!X)&&(X={});let Z;const ne=Y?G.audio:G.video;typeof ne!="boolean"&&(Z=ne);const ee=Q.getSettings().deviceId;Z?.deviceId&&unwrapConstraint(Z.deviceId)!==ee?Z.deviceId=ee:Z||(Z={deviceId:ee});const ie=mediaTrackToLocalTrack(Q,Z,$);return ie.kind===Track.Kind.Video?ie.source=Track.Source.Camera:ie.kind===Track.Kind.Audio&&(ie.source=Track.Source.Microphone),ie.mediaStream=H,isAudioTrack(ie)&&F?yield ie.setProcessor(F):isVideoTrack(ie)&&V&&(yield ie.setProcessor(V)),ie})))}catch(H){if(!U)throw H;return createLocalTracks(Object.assign(Object.assign({},B),{audio:j,video:W}),$)}})}function createLocalVideoTrack(B){return __awaiter(this,void 0,void 0,function*(){return(yield createLocalTracks({audio:!1,video:!0}))[0]})}function createLocalAudioTrack(B){return __awaiter(this,void 0,void 0,function*(){return(yield createLocalTracks({audio:!0,video:!1}))[0]})}var ConnectionQuality;(function(B){B.Excellent="excellent",B.Good="good",B.Poor="poor",B.Lost="lost",B.Unknown="unknown"})(ConnectionQuality||(ConnectionQuality={}));function qualityFromProto(B){switch(B){case ConnectionQuality$1.EXCELLENT:return ConnectionQuality.Excellent;case ConnectionQuality$1.GOOD:return ConnectionQuality.Good;case ConnectionQuality$1.POOR:return ConnectionQuality.Poor;case ConnectionQuality$1.LOST:return ConnectionQuality.Lost;default:return ConnectionQuality.Unknown}}class Participant extends eventsExports.EventEmitter{get logContext(){var $,U;return Object.assign({},(U=($=this.loggerOptions)===null||$===void 0?void 0:$.loggerContextCb)===null||U===void 0?void 0:U.call($))}get isEncrypted(){return this.trackPublications.size>0&&Array.from(this.trackPublications.values()).every($=>$.isEncrypted)}get isAgent(){var $;return(($=this.permissions)===null||$===void 0?void 0:$.agent)||this.kind===ParticipantInfo_Kind.AGENT}get isActive(){var $;return(($=this.participantInfo)===null||$===void 0?void 0:$.state)===ParticipantInfo_State.ACTIVE}get kind(){return this._kind}get attributes(){return Object.freeze(Object.assign({},this._attributes))}constructor($,U,F,V,q,j){let W=arguments.length>6&&arguments[6]!==void 0?arguments[6]:ParticipantInfo_Kind.STANDARD;var K;super(),this.audioLevel=0,this.isSpeaking=!1,this._connectionQuality=ConnectionQuality.Unknown,this.log=livekitLogger,this.log=getLogger((K=j?.loggerName)!==null&&K!==void 0?K:LoggerNames.Participant),this.loggerOptions=j,this.setMaxListeners(100),this.sid=$,this.identity=U,this.name=F,this.metadata=V,this.audioTrackPublications=new Map,this.videoTrackPublications=new Map,this.trackPublications=new Map,this._kind=W,this._attributes=q??{}}getTrackPublications(){return Array.from(this.trackPublications.values())}getTrackPublication($){for(const[,U]of this.trackPublications)if(U.source===$)return U}getTrackPublicationByName($){for(const[,U]of this.trackPublications)if(U.trackName===$)return U}waitUntilActive(){return this.isActive?Promise.resolve():this.activeFuture?this.activeFuture.promise:(this.activeFuture=new Future,this.once(ParticipantEvent.Active,()=>{var $,U;(U=($=this.activeFuture)===null||$===void 0?void 0:$.resolve)===null||U===void 0||U.call($),this.activeFuture=void 0}),this.activeFuture.promise)}get connectionQuality(){return this._connectionQuality}get isCameraEnabled(){var $;const U=this.getTrackPublication(Track.Source.Camera);return!(!(($=U?.isMuted)!==null&&$!==void 0)||$)}get isMicrophoneEnabled(){var $;const U=this.getTrackPublication(Track.Source.Microphone);return!(!(($=U?.isMuted)!==null&&$!==void 0)||$)}get isScreenShareEnabled(){return!!this.getTrackPublication(Track.Source.ScreenShare)}get isLocal(){return!1}get joinedAt(){return this.participantInfo?new Date(Number.parseInt(this.participantInfo.joinedAt.toString())*1e3):new Date}updateInfo($){var U;return this.participantInfo&&this.participantInfo.sid===$.sid&&this.participantInfo.version>$.version?!1:(this.identity=$.identity,this.sid=$.sid,this._setName($.name),this._setMetadata($.metadata),this._setAttributes($.attributes),$.state===ParticipantInfo_State.ACTIVE&&((U=this.participantInfo)===null||U===void 0?void 0:U.state)!==ParticipantInfo_State.ACTIVE&&this.emit(ParticipantEvent.Active),$.permission&&this.setPermissions($.permission),this.participantInfo=$,!0)}_setMetadata($){const U=this.metadata!==$,F=this.metadata;this.metadata=$,U&&this.emit(ParticipantEvent.ParticipantMetadataChanged,F)}_setName($){const U=this.name!==$;this.name=$,U&&this.emit(ParticipantEvent.ParticipantNameChanged,$)}_setAttributes($){const U=diffAttributes(this.attributes,$);this._attributes=$,Object.keys(U).length>0&&this.emit(ParticipantEvent.AttributesChanged,U)}setPermissions($){var U,F,V,q,j,W;const K=this.permissions,G=$.canPublish!==((U=this.permissions)===null||U===void 0?void 0:U.canPublish)||$.canSubscribe!==((F=this.permissions)===null||F===void 0?void 0:F.canSubscribe)||$.canPublishData!==((V=this.permissions)===null||V===void 0?void 0:V.canPublishData)||$.hidden!==((q=this.permissions)===null||q===void 0?void 0:q.hidden)||$.recorder!==((j=this.permissions)===null||j===void 0?void 0:j.recorder)||$.canPublishSources.length!==this.permissions.canPublishSources.length||$.canPublishSources.some((z,H)=>{var Q;return z!==((Q=this.permissions)===null||Q===void 0?void 0:Q.canPublishSources[H])})||$.canSubscribeMetrics!==((W=this.permissions)===null||W===void 0?void 0:W.canSubscribeMetrics);return this.permissions=$,G&&this.emit(ParticipantEvent.ParticipantPermissionsChanged,K),G}setIsSpeaking($){$!==this.isSpeaking&&(this.isSpeaking=$,$&&(this.lastSpokeAt=new Date),this.emit(ParticipantEvent.IsSpeakingChanged,$))}setConnectionQuality($){const U=this._connectionQuality;this._connectionQuality=qualityFromProto($),U!==this._connectionQuality&&this.emit(ParticipantEvent.ConnectionQualityChanged,this._connectionQuality)}setDisconnected(){var $,U;this.activeFuture&&((U=($=this.activeFuture).reject)===null||U===void 0||U.call($,new Error("Participant disconnected")),this.activeFuture=void 0)}setAudioContext($){this.audioContext=$,this.audioTrackPublications.forEach(U=>isAudioTrack(U.track)&&U.track.setAudioContext($))}addTrackPublication($){$.on(TrackEvent.Muted,()=>{this.emit(ParticipantEvent.TrackMuted,$)}),$.on(TrackEvent.Unmuted,()=>{this.emit(ParticipantEvent.TrackUnmuted,$)});const U=$;switch(U.track&&(U.track.sid=$.trackSid),this.trackPublications.set($.trackSid,$),$.kind){case Track.Kind.Audio:this.audioTrackPublications.set($.trackSid,$);break;case Track.Kind.Video:this.videoTrackPublications.set($.trackSid,$);break}}}function trackPermissionToProto(B){var $,U,F;if(!B.participantSid&&!B.participantIdentity)throw new Error("Invalid track permission, must provide at least one of participantIdentity and participantSid");return new TrackPermission({participantIdentity:($=B.participantIdentity)!==null&&$!==void 0?$:"",participantSid:(U=B.participantSid)!==null&&U!==void 0?U:"",allTracks:(F=B.allowAll)!==null&&F!==void 0?F:!1,trackSids:B.allowedTrackSids||[]})}class LocalParticipant extends Participant{constructor($,U,F,V,q,j){super($,U,void 0,void 0,void 0,{loggerName:V.loggerName,loggerContextCb:()=>this.engine.logContext}),this.pendingPublishing=new Set,this.pendingPublishPromises=new Map,this.participantTrackPermissions=[],this.allParticipantsAllowedToSubscribe=!0,this.encryptionType=Encryption_Type.NONE,this.enabledPublishVideoCodecs=[],this.pendingAcks=new Map,this.pendingResponses=new Map,this.handleReconnecting=()=>{this.reconnectFuture||(this.reconnectFuture=new Future)},this.handleReconnected=()=>{var W,K;(K=(W=this.reconnectFuture)===null||W===void 0?void 0:W.resolve)===null||K===void 0||K.call(W),this.reconnectFuture=void 0,this.updateTrackSubscriptionPermissions()},this.handleClosing=()=>{var W,K,G,z,H,Q;this.reconnectFuture&&(this.reconnectFuture.promise.catch(Y=>this.log.warn(Y.message,this.logContext)),(K=(W=this.reconnectFuture)===null||W===void 0?void 0:W.reject)===null||K===void 0||K.call(W,"Got disconnected during reconnection attempt"),this.reconnectFuture=void 0),this.signalConnectedFuture&&((z=(G=this.signalConnectedFuture).reject)===null||z===void 0||z.call(G,"Got disconnected without signal connected"),this.signalConnectedFuture=void 0),(Q=(H=this.activeAgentFuture)===null||H===void 0?void 0:H.reject)===null||Q===void 0||Q.call(H,"Got disconnected without active agent present"),this.activeAgentFuture=void 0,this.firstActiveAgent=void 0},this.handleSignalConnected=W=>{var K,G;W.participant&&this.updateInfo(W.participant),this.signalConnectedFuture||(this.signalConnectedFuture=new Future),(G=(K=this.signalConnectedFuture).resolve)===null||G===void 0||G.call(K)},this.handleSignalRequestResponse=W=>{const{requestId:K,reason:G,message:z}=W,H=this.pendingSignalRequests.get(K);H&&(G!==RequestResponse_Reason.OK&&H.reject(new SignalRequestError(z,G)),this.pendingSignalRequests.delete(K))},this.handleDataPacket=W=>{switch(W.value.case){case"rpcResponse":let K=W.value.value,G=null,z=null;K.value.case==="payload"?G=K.value.value:K.value.case==="error"&&(z=RpcError.fromProto(K.value.value)),this.handleIncomingRpcResponse(K.requestId,G,z);break;case"rpcAck":let H=W.value.value;this.handleIncomingRpcAck(H.requestId);break}},this.updateTrackSubscriptionPermissions=()=>{this.log.debug("updating track subscription permissions",Object.assign(Object.assign({},this.logContext),{allParticipantsAllowed:this.allParticipantsAllowedToSubscribe,participantTrackPermissions:this.participantTrackPermissions})),this.engine.client.sendUpdateSubscriptionPermissions(this.allParticipantsAllowedToSubscribe,this.participantTrackPermissions.map(W=>trackPermissionToProto(W)))},this.onTrackUnmuted=W=>{this.onTrackMuted(W,W.isUpstreamPaused)},this.onTrackMuted=(W,K)=>{if(K===void 0&&(K=!0),!W.sid){this.log.error("could not update mute status for unpublished track",Object.assign(Object.assign({},this.logContext),getLogContextFromTrack(W)));return}this.engine.updateMuteStatus(W.sid,K)},this.onTrackUpstreamPaused=W=>{this.log.debug("upstream paused",Object.assign(Object.assign({},this.logContext),getLogContextFromTrack(W))),this.onTrackMuted(W,!0)},this.onTrackUpstreamResumed=W=>{this.log.debug("upstream resumed",Object.assign(Object.assign({},this.logContext),getLogContextFromTrack(W))),this.onTrackMuted(W,W.isMuted)},this.onTrackFeatureUpdate=W=>{const K=this.audioTrackPublications.get(W.sid);if(!K){this.log.warn("Could not update local audio track settings, missing publication for track ".concat(W.sid),this.logContext);return}this.engine.client.sendUpdateLocalAudioTrack(K.trackSid,K.getTrackFeatures())},this.onTrackCpuConstrained=(W,K)=>{this.log.debug("track cpu constrained",Object.assign(Object.assign({},this.logContext),getLogContextFromTrack(K))),this.emit(ParticipantEvent.LocalTrackCpuConstrained,W,K)},this.handleSubscribedQualityUpdate=W=>__awaiter(this,void 0,void 0,function*(){var K,G,z,H,Q;if(!(!((Q=this.roomOptions)===null||Q===void 0)&&Q.dynacast))return;const Y=this.videoTrackPublications.get(W.trackSid);if(!Y){this.log.warn("received subscribed quality update for unknown track",Object.assign(Object.assign({},this.logContext),{trackSid:W.trackSid}));return}if(!Y.videoTrack)return;const X=yield Y.videoTrack.setPublishingCodecs(W.subscribedCodecs);try{for(var Z=!0,ne=__asyncValues(X),ee;ee=yield ne.next(),K=ee.done,!K;Z=!0){H=ee.value,Z=!1;const ie=H;isBackupCodec(ie)&&(this.log.debug("publish ".concat(ie," for ").concat(Y.videoTrack.sid),Object.assign(Object.assign({},this.logContext),getLogContextFromTrack(Y))),yield this.publishAdditionalCodecForTrack(Y.videoTrack,ie,Y.options))}}catch(ie){G={error:ie}}finally{try{!Z&&!K&&(z=ne.return)&&(yield z.call(ne))}finally{if(G)throw G.error}}}),this.handleLocalTrackUnpublished=W=>{const K=this.trackPublications.get(W.trackSid);if(!K){this.log.warn("received unpublished event for unknown track",Object.assign(Object.assign({},this.logContext),{trackSid:W.trackSid}));return}this.unpublishTrack(K.track)},this.handleTrackEnded=W=>__awaiter(this,void 0,void 0,function*(){if(W.source===Track.Source.ScreenShare||W.source===Track.Source.ScreenShareAudio)this.log.debug("unpublishing local track due to TrackEnded",Object.assign(Object.assign({},this.logContext),getLogContextFromTrack(W))),this.unpublishTrack(W);else if(W.isUserProvided)yield W.mute();else if(isLocalAudioTrack(W)||isLocalVideoTrack(W))try{if(isWeb())try{const K=yield navigator?.permissions.query({name:W.source===Track.Source.Camera?"camera":"microphone"});if(K&&K.state==="denied")throw this.log.warn("user has revoked access to ".concat(W.source),Object.assign(Object.assign({},this.logContext),getLogContextFromTrack(W))),K.onchange=()=>{K.state!=="denied"&&(W.isMuted||W.restartTrack(),K.onchange=null)},new Error("GetUserMedia Permission denied")}catch{}W.isMuted||(this.log.debug("track ended, attempting to use a different device",Object.assign(Object.assign({},this.logContext),getLogContextFromTrack(W))),isLocalAudioTrack(W)?yield W.restartTrack({deviceId:"default"}):yield W.restartTrack())}catch{this.log.warn("could not restart track, muting instead",Object.assign(Object.assign({},this.logContext),getLogContextFromTrack(W))),yield W.mute()}}),this.audioTrackPublications=new Map,this.videoTrackPublications=new Map,this.trackPublications=new Map,this.engine=F,this.roomOptions=V,this.setupEngine(F),this.activeDeviceMap=new Map([["audioinput","default"],["videoinput","default"],["audiooutput","default"]]),this.pendingSignalRequests=new Map,this.rpcHandlers=q,this.roomOutgoingDataStreamManager=j}get lastCameraError(){return this.cameraError}get lastMicrophoneError(){return this.microphoneError}get isE2EEEnabled(){return this.encryptionType!==Encryption_Type.NONE}getTrackPublication($){const U=super.getTrackPublication($);if(U)return U}getTrackPublicationByName($){const U=super.getTrackPublicationByName($);if(U)return U}setupEngine($){var U;this.engine=$,this.engine.on(EngineEvent.RemoteMute,(F,V)=>{const q=this.trackPublications.get(F);!q||!q.track||(V?q.mute():q.unmute())}),!((U=this.signalConnectedFuture)===null||U===void 0)&&U.isResolved&&(this.signalConnectedFuture=void 0),this.engine.on(EngineEvent.Connected,this.handleReconnected).on(EngineEvent.SignalConnected,this.handleSignalConnected).on(EngineEvent.SignalRestarted,this.handleReconnected).on(EngineEvent.SignalResumed,this.handleReconnected).on(EngineEvent.Restarting,this.handleReconnecting).on(EngineEvent.Resuming,this.handleReconnecting).on(EngineEvent.LocalTrackUnpublished,this.handleLocalTrackUnpublished).on(EngineEvent.SubscribedQualityUpdate,this.handleSubscribedQualityUpdate).on(EngineEvent.Closing,this.handleClosing).on(EngineEvent.SignalRequestResponse,this.handleSignalRequestResponse).on(EngineEvent.DataPacketReceived,this.handleDataPacket)}setMetadata($){return __awaiter(this,void 0,void 0,function*(){yield this.requestMetadataUpdate({metadata:$})})}setName($){return __awaiter(this,void 0,void 0,function*(){yield this.requestMetadataUpdate({name:$})})}setAttributes($){return __awaiter(this,void 0,void 0,function*(){yield this.requestMetadataUpdate({attributes:$})})}requestMetadataUpdate($){return __awaiter(this,arguments,void 0,function(U){var F=this;let{metadata:V,name:q,attributes:j}=U;return(function*(){return new Promise((W,K)=>__awaiter(F,void 0,void 0,function*(){var G,z;try{let H=!1;const Q=yield this.engine.client.sendUpdateLocalMetadata((G=V??this.metadata)!==null&&G!==void 0?G:"",(z=q??this.name)!==null&&z!==void 0?z:"",j),Y=performance.now();for(this.pendingSignalRequests.set(Q,{resolve:W,reject:X=>{K(X),H=!0},values:{name:q,metadata:V,attributes:j}});performance.now()-Y<5e3&&!H;){if((!q||this.name===q)&&(!V||this.metadata===V)&&(!j||Object.entries(j).every(X=>{let[Z,ne]=X;return this.attributes[Z]===ne||ne===""&&!this.attributes[Z]}))){this.pendingSignalRequests.delete(Q),W();return}yield sleep(50)}K(new SignalRequestError("Request to update local metadata timed out","TimeoutError"))}catch(H){H instanceof Error&&K(H)}}))})()})}setCameraEnabled($,U,F){return this.setTrackEnabled(Track.Source.Camera,$,U,F)}setMicrophoneEnabled($,U,F){return this.setTrackEnabled(Track.Source.Microphone,$,U,F)}setScreenShareEnabled($,U,F){return this.setTrackEnabled(Track.Source.ScreenShare,$,U,F)}setE2EEEnabled($){return __awaiter(this,void 0,void 0,function*(){this.encryptionType=$?Encryption_Type.GCM:Encryption_Type.NONE,yield this.republishAllTracks(void 0,!1)})}setTrackEnabled($,U,F,V){return __awaiter(this,void 0,void 0,function*(){var q,j;this.log.debug("setTrackEnabled",Object.assign(Object.assign({},this.logContext),{source:$,enabled:U})),this.republishPromise&&(yield this.republishPromise);let W=this.getTrackPublication($);if(U)if(W)yield W.unmute();else{let K;if(this.pendingPublishing.has($)){const G=yield this.waitForPendingPublicationOfSource($);return G||this.log.info("waiting for pending publication promise timed out",Object.assign(Object.assign({},this.logContext),{source:$})),yield G?.unmute(),G}this.pendingPublishing.add($);try{switch($){case Track.Source.Camera:K=yield this.createTracks({video:(q=F)!==null&&q!==void 0?q:!0});break;case Track.Source.Microphone:K=yield this.createTracks({audio:(j=F)!==null&&j!==void 0?j:!0});break;case Track.Source.ScreenShare:K=yield this.createScreenTracks(Object.assign({},F));break;default:throw new TrackInvalidError($)}}catch(G){throw K?.forEach(z=>{z.stop()}),G instanceof Error&&this.emit(ParticipantEvent.MediaDevicesError,G,sourceToKind($)),this.pendingPublishing.delete($),G}for(const G of K){const z=Object.assign(Object.assign({},this.roomOptions.publishDefaults),F);$===Track.Source.Microphone&&isAudioTrack(G)&&z.preConnectBuffer&&(this.log.info("starting preconnect buffer for microphone",Object.assign({},this.logContext)),G.startPreConnectBuffer())}try{const G=[];for(const H of K)this.log.info("publishing track",Object.assign(Object.assign({},this.logContext),getLogContextFromTrack(H))),G.push(this.publishTrack(H,V));[W]=yield Promise.all(G)}catch(G){throw K?.forEach(z=>{z.stop()}),G}finally{this.pendingPublishing.delete($)}}else if(!W?.track&&this.pendingPublishing.has($)&&(W=yield this.waitForPendingPublicationOfSource($),W||this.log.info("waiting for pending publication promise timed out",Object.assign(Object.assign({},this.logContext),{source:$}))),W&&W.track)if($===Track.Source.ScreenShare){W=yield this.unpublishTrack(W.track);const K=this.getTrackPublication(Track.Source.ScreenShareAudio);K&&K.track&&this.unpublishTrack(K.track)}else yield W.mute();return W})}enableCameraAndMicrophone(){return __awaiter(this,void 0,void 0,function*(){if(!(this.pendingPublishing.has(Track.Source.Camera)||this.pendingPublishing.has(Track.Source.Microphone))){this.pendingPublishing.add(Track.Source.Camera),this.pendingPublishing.add(Track.Source.Microphone);try{const $=yield this.createTracks({audio:!0,video:!0});yield Promise.all($.map(U=>this.publishTrack(U)))}finally{this.pendingPublishing.delete(Track.Source.Camera),this.pendingPublishing.delete(Track.Source.Microphone)}}})}createTracks($){return __awaiter(this,void 0,void 0,function*(){var U,F;$??($={});const V=mergeDefaultOptions($,(U=this.roomOptions)===null||U===void 0?void 0:U.audioCaptureDefaults,(F=this.roomOptions)===null||F===void 0?void 0:F.videoCaptureDefaults);try{return(yield createLocalTracks(V,{loggerName:this.roomOptions.loggerName,loggerContextCb:()=>this.logContext})).map(W=>(isAudioTrack(W)&&(this.microphoneError=void 0,W.setAudioContext(this.audioContext),W.source=Track.Source.Microphone,this.emit(ParticipantEvent.AudioStreamAcquired)),isVideoTrack(W)&&(this.cameraError=void 0,W.source=Track.Source.Camera),W))}catch(q){throw q instanceof Error&&($.audio&&(this.microphoneError=q),$.video&&(this.cameraError=q)),q}})}createScreenTracks($){return __awaiter(this,void 0,void 0,function*(){if($===void 0&&($={}),navigator.mediaDevices.getDisplayMedia===void 0)throw new DeviceUnsupportedError("getDisplayMedia not supported");$.resolution===void 0&&!isSafari17Based()&&($.resolution=ScreenSharePresets.h1080fps30.resolution);const U=screenCaptureToDisplayMediaStreamOptions($),F=yield navigator.mediaDevices.getDisplayMedia(U),V=F.getVideoTracks();if(V.length===0)throw new TrackInvalidError("no video track found");const q=new LocalVideoTrack(V[0],void 0,!1,{loggerName:this.roomOptions.loggerName,loggerContextCb:()=>this.logContext});q.source=Track.Source.ScreenShare,$.contentHint&&(q.mediaStreamTrack.contentHint=$.contentHint);const j=[q];if(F.getAudioTracks().length>0){this.emit(ParticipantEvent.AudioStreamAcquired);const W=new LocalAudioTrack(F.getAudioTracks()[0],void 0,!1,this.audioContext,{loggerName:this.roomOptions.loggerName,loggerContextCb:()=>this.logContext});W.source=Track.Source.ScreenShareAudio,j.push(W)}return j})}publishTrack($,U){return __awaiter(this,void 0,void 0,function*(){return this.publishOrRepublishTrack($,U)})}publishOrRepublishTrack($,U){return __awaiter(this,arguments,void 0,function(F,V){var q=this;let j=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1;return(function*(){var W,K,G,z;isLocalAudioTrack(F)&&F.setAudioContext(q.audioContext),yield(W=q.reconnectFuture)===null||W===void 0?void 0:W.promise,q.republishPromise&&!j&&(yield q.republishPromise),isLocalTrack(F)&&q.pendingPublishPromises.has(F)&&(yield q.pendingPublishPromises.get(F));let H;if(F instanceof MediaStreamTrack)H=F.getConstraints();else{H=F.constraints;let ee;switch(F.source){case Track.Source.Microphone:ee="audioinput";break;case Track.Source.Camera:ee="videoinput"}ee&&q.activeDeviceMap.has(ee)&&(H=Object.assign(Object.assign({},H),{deviceId:q.activeDeviceMap.get(ee)}))}if(F instanceof MediaStreamTrack)switch(F.kind){case"audio":F=new LocalAudioTrack(F,H,!0,q.audioContext,{loggerName:q.roomOptions.loggerName,loggerContextCb:()=>q.logContext});break;case"video":F=new LocalVideoTrack(F,H,!0,{loggerName:q.roomOptions.loggerName,loggerContextCb:()=>q.logContext});break;default:throw new TrackInvalidError("unsupported MediaStreamTrack kind ".concat(F.kind))}else F.updateLoggerOptions({loggerName:q.roomOptions.loggerName,loggerContextCb:()=>q.logContext});let Q;if(q.trackPublications.forEach(ee=>{ee.track&&ee.track===F&&(Q=ee)}),Q)return q.log.warn("track has already been published, skipping",Object.assign(Object.assign({},q.logContext),getLogContextFromTrack(Q))),Q;const Y=Object.assign(Object.assign({},q.roomOptions.publishDefaults),V),X="channelCount"in F.mediaStreamTrack.getSettings()&&F.mediaStreamTrack.getSettings().channelCount===2||F.mediaStreamTrack.getConstraints().channelCount===2,Z=(K=Y.forceStereo)!==null&&K!==void 0?K:X;Z&&(Y.dtx===void 0&&q.log.info("Opus DTX will be disabled for stereo tracks by default. Enable them explicitly to make it work.",Object.assign(Object.assign({},q.logContext),getLogContextFromTrack(F))),Y.red===void 0&&q.log.info("Opus RED will be disabled for stereo tracks by default. Enable them explicitly to make it work."),(G=Y.dtx)!==null&&G!==void 0||(Y.dtx=!1),(z=Y.red)!==null&&z!==void 0||(Y.red=!1)),!isE2EESimulcastSupported()&&q.roomOptions.e2ee&&(q.log.info("End-to-end encryption is set up, simulcast publishing will be disabled on Safari versions and iOS browsers running iOS < v17.2",Object.assign({},q.logContext)),Y.simulcast=!1),Y.source&&(F.source=Y.source);const ne=new Promise((ee,ie)=>__awaiter(q,void 0,void 0,function*(){try{if(this.engine.client.currentState!==SignalConnectionState.CONNECTED){this.log.debug("deferring track publication until signal is connected",Object.assign(Object.assign({},this.logContext),{track:getLogContextFromTrack(F)}));const se=setTimeout(()=>{ie(new PublishTrackError("publishing rejected as engine not connected within timeout",408))},15e3);yield this.waitUntilEngineConnected(),clearTimeout(se);const te=yield this.publish(F,Y,Z);ee(te)}else try{const se=yield this.publish(F,Y,Z);ee(se)}catch(se){ie(se)}}catch(se){ie(se)}}));q.pendingPublishPromises.set(F,ne);try{return yield ne}catch(ee){throw ee}finally{q.pendingPublishPromises.delete(F)}})()})}waitUntilEngineConnected(){return this.signalConnectedFuture||(this.signalConnectedFuture=new Future),this.signalConnectedFuture.promise}hasPermissionsToPublish($){if(!this.permissions)return this.log.warn("no permissions present for publishing track",Object.assign(Object.assign({},this.logContext),getLogContextFromTrack($))),!1;const{canPublish:U,canPublishSources:F}=this.permissions;return U&&(F.length===0||F.map(V=>getTrackSourceFromProto(V)).includes($.source))?!0:(this.log.warn("insufficient permissions to publish",Object.assign(Object.assign({},this.logContext),getLogContextFromTrack($))),!1)}publish($,U,F){return __awaiter(this,void 0,void 0,function*(){var V,q,j,W,K,G,z,H,Q,Y;if(!this.hasPermissionsToPublish($))throw new PublishTrackError("failed to publish track, insufficient permissions",403);Array.from(this.trackPublications.values()).find(de=>isLocalTrack($)&&de.source===$.source)&&$.source!==Track.Source.Unknown&&this.log.info("publishing a second track with the same source: ".concat($.source),Object.assign(Object.assign({},this.logContext),getLogContextFromTrack($))),U.stopMicTrackOnMute&&isAudioTrack($)&&($.stopOnMute=!0),$.source===Track.Source.ScreenShare&&isFireFox()&&(U.simulcast=!1),U.videoCodec==="av1"&&!supportsAV1()&&(U.videoCodec=void 0),U.videoCodec==="vp9"&&!supportsVP9()&&(U.videoCodec=void 0),U.videoCodec===void 0&&(U.videoCodec=defaultVideoCodec),this.enabledPublishVideoCodecs.length>0&&(this.enabledPublishVideoCodecs.some(de=>U.videoCodec===mimeTypeToVideoCodecString(de.mime))||(U.videoCodec=mimeTypeToVideoCodecString(this.enabledPublishVideoCodecs[0].mime)));const Z=U.videoCodec;$.on(TrackEvent.Muted,this.onTrackMuted),$.on(TrackEvent.Unmuted,this.onTrackUnmuted),$.on(TrackEvent.Ended,this.handleTrackEnded),$.on(TrackEvent.UpstreamPaused,this.onTrackUpstreamPaused),$.on(TrackEvent.UpstreamResumed,this.onTrackUpstreamResumed),$.on(TrackEvent.AudioTrackFeatureUpdate,this.onTrackFeatureUpdate);const ne=[],ee=!(!((V=U.dtx)!==null&&V!==void 0)||V),ie=$.getSourceTrackSettings();ie.autoGainControl&&ne.push(AudioTrackFeature.TF_AUTO_GAIN_CONTROL),ie.echoCancellation&&ne.push(AudioTrackFeature.TF_ECHO_CANCELLATION),ie.noiseSuppression&&ne.push(AudioTrackFeature.TF_NOISE_SUPPRESSION),ie.channelCount&&ie.channelCount>1&&ne.push(AudioTrackFeature.TF_STEREO),ee&&ne.push(AudioTrackFeature.TF_NO_DTX),isLocalAudioTrack($)&&$.hasPreConnectBuffer&&ne.push(AudioTrackFeature.TF_PRECONNECT_BUFFER);const se=new AddTrackRequest({cid:$.mediaStreamTrack.id,name:U.name,type:Track.kindToProto($.kind),muted:$.isMuted,source:Track.sourceToProto($.source),disableDtx:ee,encryption:this.encryptionType,stereo:F,disableRed:this.isE2EEEnabled||!(!((q=U.red)!==null&&q!==void 0)||q),stream:U?.stream,backupCodecPolicy:U?.backupCodecPolicy,audioFeatures:ne});let te;if($.kind===Track.Kind.Video){let de={width:0,height:0};try{de=yield $.waitForDimensions()}catch{const oe=(W=(j=this.roomOptions.videoCaptureDefaults)===null||j===void 0?void 0:j.resolution)!==null&&W!==void 0?W:VideoPresets.h720.resolution;de={width:oe.width,height:oe.height},this.log.error("could not determine track dimensions, using defaults",Object.assign(Object.assign(Object.assign({},this.logContext),getLogContextFromTrack($)),{dims:de}))}se.width=de.width,se.height=de.height,isLocalVideoTrack($)&&(isSVCCodec(Z)&&($.source===Track.Source.ScreenShare&&(U.scalabilityMode="L1T3","contentHint"in $.mediaStreamTrack&&($.mediaStreamTrack.contentHint="motion",this.log.info("forcing contentHint to motion for screenshare with SVC codecs",Object.assign(Object.assign({},this.logContext),getLogContextFromTrack($))))),U.scalabilityMode=(K=U.scalabilityMode)!==null&&K!==void 0?K:"L3T3_KEY"),se.simulcastCodecs=[new SimulcastCodec({codec:Z,cid:$.mediaStreamTrack.id})],U.backupCodec===!0&&(U.backupCodec={codec:defaultVideoCodec}),U.backupCodec&&Z!==U.backupCodec.codec&&se.encryption===Encryption_Type.NONE&&(this.roomOptions.dynacast||(this.roomOptions.dynacast=!0),se.simulcastCodecs.push(new SimulcastCodec({codec:U.backupCodec.codec,cid:""})))),te=computeVideoEncodings($.source===Track.Source.ScreenShare,se.width,se.height,U),se.layers=videoLayersFromEncodings(se.width,se.height,te,isSVCCodec(U.videoCodec))}else $.kind===Track.Kind.Audio&&(te=[{maxBitrate:(G=U.audioPreset)===null||G===void 0?void 0:G.maxBitrate,priority:(H=(z=U.audioPreset)===null||z===void 0?void 0:z.priority)!==null&&H!==void 0?H:"high",networkPriority:(Y=(Q=U.audioPreset)===null||Q===void 0?void 0:Q.priority)!==null&&Y!==void 0?Y:"high"}]);if(!this.engine||this.engine.isClosed)throw new UnexpectedConnectionState("cannot publish track when not connected");const re=()=>__awaiter(this,void 0,void 0,function*(){var de,ue,oe;if(!this.engine.pcManager)throw new UnexpectedConnectionState("pcManager is not ready");if($.sender=yield this.engine.createSender($,U,te),this.emit(ParticipantEvent.LocalSenderCreated,$.sender,$),isLocalVideoTrack($)&&((de=U.degradationPreference)!==null&&de!==void 0||(U.degradationPreference=getDefaultDegradationPreference($)),$.setDegradationPreference(U.degradationPreference)),te)if(isFireFox()&&$.kind===Track.Kind.Audio){let me;for(const be of this.engine.pcManager.publisher.getTransceivers())if(be.sender===$.sender){me=be;break}me&&this.engine.pcManager.publisher.setTrackCodecBitrate({transceiver:me,codec:"opus",maxbr:!((ue=te[0])===null||ue===void 0)&&ue.maxBitrate?te[0].maxBitrate/1e3:0})}else $.codec&&isSVCCodec($.codec)&&(!((oe=te[0])===null||oe===void 0)&&oe.maxBitrate)&&this.engine.pcManager.publisher.setTrackCodecBitrate({cid:se.cid,codec:$.codec,maxbr:te[0].maxBitrate/1e3});yield this.engine.negotiate()});let ae;const ce=new Promise((de,ue)=>__awaiter(this,void 0,void 0,function*(){var oe;try{ae=yield this.engine.addTrack(se),de(ae)}catch(me){$.sender&&(!((oe=this.engine.pcManager)===null||oe===void 0)&&oe.publisher)&&(this.engine.pcManager.publisher.removeTrack($.sender),yield this.engine.negotiate().catch(be=>{this.log.error("failed to negotiate after removing track due to failed add track request",Object.assign(Object.assign(Object.assign({},this.logContext),getLogContextFromTrack($)),{error:be}))})),ue(me)}}));if(this.enabledPublishVideoCodecs.length>0)ae=(yield Promise.all([ce,re()]))[0];else{ae=yield ce;let de;if(ae.codecs.forEach(ue=>{de===void 0&&(de=ue.mimeType)}),de&&$.kind===Track.Kind.Video){const ue=mimeTypeToVideoCodecString(de);ue!==Z&&(this.log.debug("falling back to server selected codec",Object.assign(Object.assign(Object.assign({},this.logContext),getLogContextFromTrack($)),{codec:ue})),U.videoCodec=ue,te=computeVideoEncodings($.source===Track.Source.ScreenShare,se.width,se.height,U))}yield re()}const le=new LocalTrackPublication($.kind,ae,$,{loggerName:this.roomOptions.loggerName,loggerContextCb:()=>this.logContext});if(le.on(TrackEvent.CpuConstrained,de=>this.onTrackCpuConstrained(de,le)),le.options=U,$.sid=ae.sid,this.log.debug("publishing ".concat($.kind," with encodings"),Object.assign(Object.assign({},this.logContext),{encodings:te,trackInfo:ae})),isLocalVideoTrack($)?$.startMonitor(this.engine.client):isLocalAudioTrack($)&&$.startMonitor(),this.addTrackPublication(le),this.emit(ParticipantEvent.LocalTrackPublished,le),isLocalAudioTrack($)&&ae.audioFeatures.includes(AudioTrackFeature.TF_PRECONNECT_BUFFER)){const de=$.getPreConnectBuffer(),ue=$.getPreConnectBufferMimeType();this.on(ParticipantEvent.LocalTrackSubscribed,oe=>{if(oe.trackSid===ae.sid){if(!$.hasPreConnectBuffer){this.log.warn("subscribe event came to late, buffer already closed",this.logContext);return}this.log.debug("finished recording preconnect buffer",Object.assign(Object.assign({},this.logContext),getLogContextFromTrack($))),$.stopPreConnectBuffer()}}),de&&new Promise((me,be)=>__awaiter(this,void 0,void 0,function*(){var ge,ke,_e,Ce,Re,$e;try{this.log.debug("waiting for agent",Object.assign(Object.assign({},this.logContext),getLogContextFromTrack($)));const Ie=setTimeout(()=>{be(new Error("agent not active within 10 seconds"))},1e4),je=yield this.waitUntilActiveAgentPresent();clearTimeout(Ie),this.log.debug("sending preconnect buffer",Object.assign(Object.assign({},this.logContext),getLogContextFromTrack($)));const Ke=yield this.streamBytes({name:"preconnect-buffer",mimeType:ue,topic:"lk.agent.pre-connect-audio-buffer",destinationIdentities:[je.identity],attributes:{trackId:le.trackSid,sampleRate:String((Re=ie.sampleRate)!==null&&Re!==void 0?Re:"48000"),channels:String(($e=ie.channelCount)!==null&&$e!==void 0?$e:"1")}});try{for(var Ee=!0,we=__asyncValues(de),De;De=yield we.next(),ge=De.done,!ge;Ee=!0){Ce=De.value,Ee=!1;const Te=Ce;yield Ke.write(Te)}}catch(Te){ke={error:Te}}finally{try{!Ee&&!ge&&(_e=we.return)&&(yield _e.call(we))}finally{if(ke)throw ke.error}}yield Ke.close(),me()}catch(Ie){be(Ie)}})).then(()=>{this.log.debug("preconnect buffer sent successfully",Object.assign(Object.assign({},this.logContext),getLogContextFromTrack($)))}).catch(me=>{this.log.error("error sending preconnect buffer",Object.assign(Object.assign(Object.assign({},this.logContext),getLogContextFromTrack($)),{error:me}))})}return le})}get isLocal(){return!0}publishAdditionalCodecForTrack($,U,F){return __awaiter(this,void 0,void 0,function*(){var V;if(this.encryptionType!==Encryption_Type.NONE)return;let q;if(this.trackPublications.forEach(Y=>{Y.track&&Y.track===$&&(q=Y)}),!q)throw new TrackInvalidError("track is not published");if(!isLocalVideoTrack($))throw new TrackInvalidError("track is not a video track");const j=Object.assign(Object.assign({},(V=this.roomOptions)===null||V===void 0?void 0:V.publishDefaults),F),W=computeTrackBackupEncodings($,U,j);if(!W){this.log.info("backup codec has been disabled, ignoring request to add additional codec for track",Object.assign(Object.assign({},this.logContext),getLogContextFromTrack($)));return}const K=$.addSimulcastTrack(U,W);if(!K)return;const G=new AddTrackRequest({cid:K.mediaStreamTrack.id,type:Track.kindToProto($.kind),muted:$.isMuted,source:Track.sourceToProto($.source),sid:$.sid,simulcastCodecs:[{codec:j.videoCodec,cid:K.mediaStreamTrack.id}]});if(G.layers=videoLayersFromEncodings(G.width,G.height,W),!this.engine||this.engine.isClosed)throw new UnexpectedConnectionState("cannot publish track when not connected");const z=()=>__awaiter(this,void 0,void 0,function*(){yield this.engine.createSimulcastSender($,K,j,W),yield this.engine.negotiate()}),Q=(yield Promise.all([this.engine.addTrack(G),z()]))[0];this.log.debug("published ".concat(U," for track ").concat($.sid),Object.assign(Object.assign({},this.logContext),{encodings:W,trackInfo:Q}))})}unpublishTrack($,U){return __awaiter(this,void 0,void 0,function*(){var F,V;if(isLocalTrack($)){const G=this.pendingPublishPromises.get($);G&&(this.log.info("awaiting publish promise before attempting to unpublish",Object.assign(Object.assign({},this.logContext),getLogContextFromTrack($))),yield G)}const q=this.getPublicationForTrack($),j=q?getLogContextFromTrack(q):void 0;if(this.log.debug("unpublishing track",Object.assign(Object.assign({},this.logContext),j)),!q||!q.track){this.log.warn("track was not unpublished because no publication was found",Object.assign(Object.assign({},this.logContext),j));return}$=q.track,$.off(TrackEvent.Muted,this.onTrackMuted),$.off(TrackEvent.Unmuted,this.onTrackUnmuted),$.off(TrackEvent.Ended,this.handleTrackEnded),$.off(TrackEvent.UpstreamPaused,this.onTrackUpstreamPaused),$.off(TrackEvent.UpstreamResumed,this.onTrackUpstreamResumed),$.off(TrackEvent.AudioTrackFeatureUpdate,this.onTrackFeatureUpdate),U===void 0&&(U=(V=(F=this.roomOptions)===null||F===void 0?void 0:F.stopLocalTrackOnUnpublish)!==null&&V!==void 0?V:!0),U?$.stop():$.stopMonitor();let W=!1;const K=$.sender;if($.sender=void 0,this.engine.pcManager&&this.engine.pcManager.currentState<PCTransportState.FAILED&&K)try{for(const G of this.engine.pcManager.publisher.getTransceivers())G.sender===K&&(G.direction="inactive",W=!0);if(this.engine.removeTrack(K)&&(W=!0),isLocalVideoTrack($)){for(const[,G]of $.simulcastCodecs)G.sender&&(this.engine.removeTrack(G.sender)&&(W=!0),G.sender=void 0);$.simulcastCodecs.clear()}}catch(G){this.log.warn("failed to unpublish track",Object.assign(Object.assign(Object.assign({},this.logContext),j),{error:G}))}switch(this.trackPublications.delete(q.trackSid),q.kind){case Track.Kind.Audio:this.audioTrackPublications.delete(q.trackSid);break;case Track.Kind.Video:this.videoTrackPublications.delete(q.trackSid);break}return this.emit(ParticipantEvent.LocalTrackUnpublished,q),q.setTrack(void 0),W&&(yield this.engine.negotiate()),q})}unpublishTracks($){return __awaiter(this,void 0,void 0,function*(){return(yield Promise.all($.map(F=>this.unpublishTrack(F)))).filter(F=>!!F)})}republishAllTracks($){return __awaiter(this,arguments,void 0,function(U){var F=this;let V=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0;return(function*(){F.republishPromise&&(yield F.republishPromise),F.republishPromise=new Promise((q,j)=>__awaiter(F,void 0,void 0,function*(){try{const W=[];this.trackPublications.forEach(K=>{K.track&&(U&&(K.options=Object.assign(Object.assign({},K.options),U)),W.push(K))}),yield Promise.all(W.map(K=>__awaiter(this,void 0,void 0,function*(){const G=K.track;yield this.unpublishTrack(G,!1),V&&!G.isMuted&&G.source!==Track.Source.ScreenShare&&G.source!==Track.Source.ScreenShareAudio&&(isLocalAudioTrack(G)||isLocalVideoTrack(G))&&!G.isUserProvided&&(this.log.debug("restarting existing track",Object.assign(Object.assign({},this.logContext),{track:K.trackSid})),yield G.restartTrack()),yield this.publishOrRepublishTrack(G,K.options,!0)}))),q()}catch(W){j(W)}finally{this.republishPromise=void 0}})),yield F.republishPromise})()})}publishData($){return __awaiter(this,arguments,void 0,function(U){var F=this;let V=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};return(function*(){const q=V.reliable?DataPacket_Kind.RELIABLE:DataPacket_Kind.LOSSY,j=V.destinationIdentities,W=V.topic,K=new DataPacket({kind:q,value:{case:"user",value:new UserPacket({participantIdentity:F.identity,payload:U,destinationIdentities:j,topic:W})}});yield F.engine.sendDataPacket(K,q)})()})}publishDtmf($,U){return __awaiter(this,void 0,void 0,function*(){const F=new DataPacket({kind:DataPacket_Kind.RELIABLE,value:{case:"sipDtmf",value:new SipDTMF({code:$,digit:U})}});yield this.engine.sendDataPacket(F,DataPacket_Kind.RELIABLE)})}sendChatMessage($,U){return __awaiter(this,void 0,void 0,function*(){const F={id:crypto.randomUUID(),message:$,timestamp:Date.now(),attachedFiles:U?.attachments},V=new DataPacket({value:{case:"chatMessage",value:new ChatMessage(Object.assign(Object.assign({},F),{timestamp:protoInt64.parse(F.timestamp)}))}});return yield this.engine.sendDataPacket(V,DataPacket_Kind.RELIABLE),this.emit(ParticipantEvent.ChatMessage,F),F})}editChatMessage($,U){return __awaiter(this,void 0,void 0,function*(){const F=Object.assign(Object.assign({},U),{message:$,editTimestamp:Date.now()}),V=new DataPacket({value:{case:"chatMessage",value:new ChatMessage(Object.assign(Object.assign({},F),{timestamp:protoInt64.parse(F.timestamp),editTimestamp:protoInt64.parse(F.editTimestamp)}))}});return yield this.engine.sendDataPacket(V,DataPacket_Kind.RELIABLE),this.emit(ParticipantEvent.ChatMessage,F),F})}sendText($,U){return __awaiter(this,void 0,void 0,function*(){return this.roomOutgoingDataStreamManager.sendText($,U)})}streamText($){return __awaiter(this,void 0,void 0,function*(){return this.roomOutgoingDataStreamManager.streamText($)})}sendFile($,U){return __awaiter(this,void 0,void 0,function*(){return this.roomOutgoingDataStreamManager.sendFile($,U)})}streamBytes($){return __awaiter(this,void 0,void 0,function*(){return this.roomOutgoingDataStreamManager.streamBytes($)})}performRpc($){return __awaiter(this,arguments,void 0,function(U){var F=this;let{destinationIdentity:V,method:q,payload:j,responseTimeout:W=1e4}=U;return(function*(){return new Promise((G,z)=>__awaiter(F,void 0,void 0,function*(){var H,Q,Y,X;if(byteLength(j)>MAX_PAYLOAD_BYTES){z(RpcError.builtIn("REQUEST_PAYLOAD_TOO_LARGE"));return}if(!((Q=(H=this.engine.latestJoinResponse)===null||H===void 0?void 0:H.serverInfo)===null||Q===void 0)&&Q.version&&compareVersions((X=(Y=this.engine.latestJoinResponse)===null||Y===void 0?void 0:Y.serverInfo)===null||X===void 0?void 0:X.version,"1.8.0")<0){z(RpcError.builtIn("UNSUPPORTED_SERVER"));return}const Z=crypto.randomUUID();yield this.publishRpcRequest(V,Z,q,j,W-2e3);const ne=setTimeout(()=>{this.pendingAcks.delete(Z),z(RpcError.builtIn("CONNECTION_TIMEOUT")),this.pendingResponses.delete(Z),clearTimeout(ee)},2e3);this.pendingAcks.set(Z,{resolve:()=>{clearTimeout(ne)},participantIdentity:V});const ee=setTimeout(()=>{this.pendingResponses.delete(Z),z(RpcError.builtIn("RESPONSE_TIMEOUT"))},W);this.pendingResponses.set(Z,{resolve:(ie,se)=>{clearTimeout(ee),this.pendingAcks.has(Z)&&(console.warn("RPC response received before ack",Z),this.pendingAcks.delete(Z),clearTimeout(ne)),se?z(se):G(ie??"")},participantIdentity:V})}))})()})}registerRpcMethod($,U){this.rpcHandlers.has($)&&this.log.warn("you're overriding the RPC handler for method ".concat($,", in the future this will throw an error")),this.rpcHandlers.set($,U)}unregisterRpcMethod($){this.rpcHandlers.delete($)}setTrackSubscriptionPermissions($){let U=arguments.length>1&&arguments[1]!==void 0?arguments[1]:[];this.participantTrackPermissions=U,this.allParticipantsAllowedToSubscribe=$,this.engine.client.isDisconnected||this.updateTrackSubscriptionPermissions()}handleIncomingRpcAck($){const U=this.pendingAcks.get($);U?(U.resolve(),this.pendingAcks.delete($)):console.error("Ack received for unexpected RPC request",$)}handleIncomingRpcResponse($,U,F){const V=this.pendingResponses.get($);V?(V.resolve(U,F),this.pendingResponses.delete($)):console.error("Response received for unexpected RPC request",$)}publishRpcRequest($,U,F,V,q){return __awaiter(this,void 0,void 0,function*(){const j=new DataPacket({destinationIdentities:[$],kind:DataPacket_Kind.RELIABLE,value:{case:"rpcRequest",value:new RpcRequest({id:U,method:F,payload:V,responseTimeoutMs:q,version:1})}});yield this.engine.sendDataPacket(j,DataPacket_Kind.RELIABLE)})}handleParticipantDisconnected($){for(const[U,{participantIdentity:F}]of this.pendingAcks)F===$&&this.pendingAcks.delete(U);for(const[U,{participantIdentity:F,resolve:V}]of this.pendingResponses)F===$&&(V(null,RpcError.builtIn("RECIPIENT_DISCONNECTED")),this.pendingResponses.delete(U))}setEnabledPublishCodecs($){this.enabledPublishVideoCodecs=$.filter(U=>U.mime.split("/")[0].toLowerCase()==="video")}updateInfo($){return super.updateInfo($)?($.tracks.forEach(U=>{var F,V;const q=this.trackPublications.get(U.sid);if(q){const j=q.isMuted||((V=(F=q.track)===null||F===void 0?void 0:F.isUpstreamPaused)!==null&&V!==void 0?V:!1);j!==U.muted&&(this.log.debug("updating server mute state after reconcile",Object.assign(Object.assign(Object.assign({},this.logContext),getLogContextFromTrack(q)),{mutedOnServer:j})),this.engine.client.sendMuteTrack(U.sid,j))}}),!0):!1}setActiveAgent($){var U,F,V,q;this.firstActiveAgent=$,$&&!this.firstActiveAgent&&(this.firstActiveAgent=$),$?(F=(U=this.activeAgentFuture)===null||U===void 0?void 0:U.resolve)===null||F===void 0||F.call(U,$):(q=(V=this.activeAgentFuture)===null||V===void 0?void 0:V.reject)===null||q===void 0||q.call(V,"Agent disconnected"),this.activeAgentFuture=void 0}waitUntilActiveAgentPresent(){return this.firstActiveAgent?Promise.resolve(this.firstActiveAgent):(this.activeAgentFuture||(this.activeAgentFuture=new Future),this.activeAgentFuture.promise)}getPublicationForTrack($){let U;return this.trackPublications.forEach(F=>{const V=F.track;V&&($ instanceof MediaStreamTrack?(isLocalAudioTrack(V)||isLocalVideoTrack(V))&&V.mediaStreamTrack===$&&(U=F):$===V&&(U=F))}),U}waitForPendingPublicationOfSource($){return __awaiter(this,void 0,void 0,function*(){const F=Date.now();for(;Date.now()<F+1e4;){const V=Array.from(this.pendingPublishPromises.entries()).find(q=>{let[j]=q;return j.source===$});if(V)return V[1];yield sleep(20)}})}}class RemoteTrackPublication extends TrackPublication{constructor($,U,F,V){super($,U.sid,U.name,V),this.track=void 0,this.allowed=!0,this.requestedDisabled=void 0,this.visible=!0,this.handleEnded=q=>{this.setTrack(void 0),this.emit(TrackEvent.Ended,q)},this.handleVisibilityChange=q=>{this.log.debug("adaptivestream video visibility ".concat(this.trackSid,", visible=").concat(q),this.logContext),this.visible=q,this.emitTrackUpdate()},this.handleVideoDimensionsChange=q=>{this.log.debug("adaptivestream video dimensions ".concat(q.width,"x").concat(q.height),this.logContext),this.videoDimensionsAdaptiveStream=q,this.emitTrackUpdate()},this.subscribed=F,this.updateInfo(U)}setSubscribed($){const U=this.subscriptionStatus,F=this.permissionStatus;this.subscribed=$,$&&(this.allowed=!0);const V=new UpdateSubscription({trackSids:[this.trackSid],subscribe:this.subscribed,participantTracks:[new ParticipantTracks({participantSid:"",trackSids:[this.trackSid]})]});this.emit(TrackEvent.UpdateSubscription,V),this.emitSubscriptionUpdateIfChanged(U),this.emitPermissionUpdateIfChanged(F)}get subscriptionStatus(){return this.subscribed===!1?TrackPublication.SubscriptionStatus.Unsubscribed:super.isSubscribed?TrackPublication.SubscriptionStatus.Subscribed:TrackPublication.SubscriptionStatus.Desired}get permissionStatus(){return this.allowed?TrackPublication.PermissionStatus.Allowed:TrackPublication.PermissionStatus.NotAllowed}get isSubscribed(){return this.subscribed===!1?!1:super.isSubscribed}get isDesired(){return this.subscribed!==!1}get isEnabled(){return this.requestedDisabled!==void 0?!this.requestedDisabled:this.isAdaptiveStream?this.visible:!0}get isLocal(){return!1}setEnabled($){!this.isManualOperationAllowed()||this.requestedDisabled===!$||(this.requestedDisabled=!$,this.emitTrackUpdate())}setVideoQuality($){!this.isManualOperationAllowed()||this.requestedMaxQuality===$||(this.requestedMaxQuality=$,this.requestedVideoDimensions=void 0,this.emitTrackUpdate())}setVideoDimensions($){var U,F;this.isManualOperationAllowed()&&(((U=this.requestedVideoDimensions)===null||U===void 0?void 0:U.width)===$.width&&((F=this.requestedVideoDimensions)===null||F===void 0?void 0:F.height)===$.height||(isRemoteVideoTrack(this.track)&&(this.requestedVideoDimensions=$),this.requestedMaxQuality=void 0,this.emitTrackUpdate()))}setVideoFPS($){this.isManualOperationAllowed()&&isRemoteVideoTrack(this.track)&&this.fps!==$&&(this.fps=$,this.emitTrackUpdate())}get videoQuality(){var $;return($=this.requestedMaxQuality)!==null&&$!==void 0?$:VideoQuality.HIGH}setTrack($){const U=this.subscriptionStatus,F=this.permissionStatus,V=this.track;V!==$&&(V&&(V.off(TrackEvent.VideoDimensionsChanged,this.handleVideoDimensionsChange),V.off(TrackEvent.VisibilityChanged,this.handleVisibilityChange),V.off(TrackEvent.Ended,this.handleEnded),V.detach(),V.stopMonitor(),this.emit(TrackEvent.Unsubscribed,V)),super.setTrack($),$&&($.sid=this.trackSid,$.on(TrackEvent.VideoDimensionsChanged,this.handleVideoDimensionsChange),$.on(TrackEvent.VisibilityChanged,this.handleVisibilityChange),$.on(TrackEvent.Ended,this.handleEnded),this.emit(TrackEvent.Subscribed,$)),this.emitPermissionUpdateIfChanged(F),this.emitSubscriptionUpdateIfChanged(U))}setAllowed($){const U=this.subscriptionStatus,F=this.permissionStatus;this.allowed=$,this.emitPermissionUpdateIfChanged(F),this.emitSubscriptionUpdateIfChanged(U)}setSubscriptionError($){this.emit(TrackEvent.SubscriptionFailed,$)}updateInfo($){super.updateInfo($);const U=this.metadataMuted;this.metadataMuted=$.muted,this.track?this.track.setMuted($.muted):U!==$.muted&&this.emit($.muted?TrackEvent.Muted:TrackEvent.Unmuted)}emitSubscriptionUpdateIfChanged($){const U=this.subscriptionStatus;$!==U&&this.emit(TrackEvent.SubscriptionStatusChanged,U,$)}emitPermissionUpdateIfChanged($){this.permissionStatus!==$&&this.emit(TrackEvent.SubscriptionPermissionChanged,this.permissionStatus,$)}isManualOperationAllowed(){return this.isDesired?!0:(this.log.warn("cannot update track settings when not subscribed",this.logContext),!1)}get isAdaptiveStream(){return isRemoteVideoTrack(this.track)&&this.track.isAdaptiveStream}emitTrackUpdate(){const $=new UpdateTrackSettings({trackSids:[this.trackSid],disabled:!this.isEnabled,fps:this.fps});if(this.kind===Track.Kind.Video){let U=this.requestedVideoDimensions;if(this.videoDimensionsAdaptiveStream!==void 0)if(U)areDimensionsSmaller(this.videoDimensionsAdaptiveStream,U)&&(this.log.debug("using adaptive stream dimensions instead of requested",Object.assign(Object.assign({},this.logContext),this.videoDimensionsAdaptiveStream)),U=this.videoDimensionsAdaptiveStream);else if(this.requestedMaxQuality!==void 0&&this.trackInfo){const F=layerDimensionsFor(this.trackInfo,this.requestedMaxQuality);F&&areDimensionsSmaller(this.videoDimensionsAdaptiveStream,F)&&(this.log.debug("using adaptive stream dimensions instead of max quality layer",Object.assign(Object.assign({},this.logContext),this.videoDimensionsAdaptiveStream)),U=this.videoDimensionsAdaptiveStream)}else this.log.debug("using adaptive stream dimensions",Object.assign(Object.assign({},this.logContext),this.videoDimensionsAdaptiveStream)),U=this.videoDimensionsAdaptiveStream;U?($.width=Math.ceil(U.width),$.height=Math.ceil(U.height)):this.requestedMaxQuality!==void 0?(this.log.debug("using requested max quality",Object.assign(Object.assign({},this.logContext),{quality:this.requestedMaxQuality})),$.quality=this.requestedMaxQuality):(this.log.debug("using default quality",Object.assign(Object.assign({},this.logContext),{quality:VideoQuality.HIGH})),$.quality=VideoQuality.HIGH)}this.emit(TrackEvent.UpdateSettings,$)}}class RemoteParticipant extends Participant{static fromParticipantInfo($,U,F){return new RemoteParticipant($,U.sid,U.identity,U.name,U.metadata,U.attributes,F,U.kind)}get logContext(){return Object.assign(Object.assign({},super.logContext),{rpID:this.sid,remoteParticipant:this.identity})}constructor($,U,F,V,q,j,W){let K=arguments.length>7&&arguments[7]!==void 0?arguments[7]:ParticipantInfo_Kind.STANDARD;super(U,F||"",V,q,j,W,K),this.signalClient=$,this.trackPublications=new Map,this.audioTrackPublications=new Map,this.videoTrackPublications=new Map,this.volumeMap=new Map}addTrackPublication($){super.addTrackPublication($),$.on(TrackEvent.UpdateSettings,U=>{this.log.debug("send update settings",Object.assign(Object.assign(Object.assign({},this.logContext),getLogContextFromTrack($)),{settings:U})),this.signalClient.sendUpdateTrackSettings(U)}),$.on(TrackEvent.UpdateSubscription,U=>{U.participantTracks.forEach(F=>{F.participantSid=this.sid}),this.signalClient.sendUpdateSubscription(U)}),$.on(TrackEvent.SubscriptionPermissionChanged,U=>{this.emit(ParticipantEvent.TrackSubscriptionPermissionChanged,$,U)}),$.on(TrackEvent.SubscriptionStatusChanged,U=>{this.emit(ParticipantEvent.TrackSubscriptionStatusChanged,$,U)}),$.on(TrackEvent.Subscribed,U=>{this.emit(ParticipantEvent.TrackSubscribed,U,$)}),$.on(TrackEvent.Unsubscribed,U=>{this.emit(ParticipantEvent.TrackUnsubscribed,U,$)}),$.on(TrackEvent.SubscriptionFailed,U=>{this.emit(ParticipantEvent.TrackSubscriptionFailed,$.trackSid,U)})}getTrackPublication($){const U=super.getTrackPublication($);if(U)return U}getTrackPublicationByName($){const U=super.getTrackPublicationByName($);if(U)return U}setVolume($){let U=arguments.length>1&&arguments[1]!==void 0?arguments[1]:Track.Source.Microphone;this.volumeMap.set(U,$);const F=this.getTrackPublication(U);F&&F.track&&F.track.setVolume($)}getVolume(){let $=arguments.length>0&&arguments[0]!==void 0?arguments[0]:Track.Source.Microphone;const U=this.getTrackPublication($);return U&&U.track?U.track.getVolume():this.volumeMap.get($)}addSubscribedMediaTrack($,U,F,V,q,j){let W=this.getTrackPublicationBySid(U);if(W||U.startsWith("TR")||this.trackPublications.forEach(z=>{!W&&$.kind===z.kind.toString()&&(W=z)}),!W){if(j===0){this.log.error("could not find published track",Object.assign(Object.assign({},this.logContext),{trackSid:U})),this.emit(ParticipantEvent.TrackSubscriptionFailed,U);return}j===void 0&&(j=20),setTimeout(()=>{this.addSubscribedMediaTrack($,U,F,V,q,j-1)},150);return}if($.readyState==="ended"){this.log.error("unable to subscribe because MediaStreamTrack is ended. Do not call MediaStreamTrack.stop()",Object.assign(Object.assign({},this.logContext),getLogContextFromTrack(W))),this.emit(ParticipantEvent.TrackSubscriptionFailed,U);return}const K=$.kind==="video";let G;return K?G=new RemoteVideoTrack($,U,V,q):G=new RemoteAudioTrack($,U,V,this.audioContext,this.audioOutput),G.source=W.source,G.isMuted=W.isMuted,G.setMediaStream(F),G.start(),W.setTrack(G),this.volumeMap.has(W.source)&&isRemoteTrack(G)&&isAudioTrack(G)&&G.setVolume(this.volumeMap.get(W.source)),W}get hasMetadata(){return!!this.participantInfo}getTrackPublicationBySid($){return this.trackPublications.get($)}updateInfo($){if(!super.updateInfo($))return!1;const U=new Map,F=new Map;return $.tracks.forEach(V=>{var q,j;let W=this.getTrackPublicationBySid(V.sid);if(W)W.updateInfo(V);else{const K=Track.kindFromProto(V.type);if(!K)return;W=new RemoteTrackPublication(K,V,(q=this.signalClient.connectOptions)===null||q===void 0?void 0:q.autoSubscribe,{loggerContextCb:()=>this.logContext,loggerName:(j=this.loggerOptions)===null||j===void 0?void 0:j.loggerName}),W.updateInfo(V),F.set(V.sid,W);const G=Array.from(this.trackPublications.values()).find(z=>z.source===W?.source);G&&W.source!==Track.Source.Unknown&&this.log.debug("received a second track publication for ".concat(this.identity," with the same source: ").concat(W.source),Object.assign(Object.assign({},this.logContext),{oldTrack:getLogContextFromTrack(G),newTrack:getLogContextFromTrack(W)})),this.addTrackPublication(W)}U.set(V.sid,W)}),this.trackPublications.forEach(V=>{U.has(V.trackSid)||(this.log.trace("detected removed track on remote participant, unpublishing",Object.assign(Object.assign({},this.logContext),getLogContextFromTrack(V))),this.unpublishTrack(V.trackSid,!0))}),F.forEach(V=>{this.emit(ParticipantEvent.TrackPublished,V)}),!0}unpublishTrack($,U){const F=this.trackPublications.get($);if(!F)return;const{track:V}=F;switch(V&&(V.stop(),F.setTrack(void 0)),this.trackPublications.delete($),F.kind){case Track.Kind.Audio:this.audioTrackPublications.delete($);break;case Track.Kind.Video:this.videoTrackPublications.delete($);break}U&&this.emit(ParticipantEvent.TrackUnpublished,F)}setAudioOutput($){return __awaiter(this,void 0,void 0,function*(){this.audioOutput=$;const U=[];this.audioTrackPublications.forEach(F=>{var V;isAudioTrack(F.track)&&isRemoteTrack(F.track)&&U.push(F.track.setSinkId((V=$.deviceId)!==null&&V!==void 0?V:"default"))}),yield Promise.all(U)})}emit($){for(var U=arguments.length,F=new Array(U>1?U-1:0),V=1;V<U;V++)F[V-1]=arguments[V];return this.log.trace("participant event",Object.assign(Object.assign({},this.logContext),{event:$,args:F})),super.emit($,...F)}}var ConnectionState;(function(B){B.Disconnected="disconnected",B.Connecting="connecting",B.Connected="connected",B.Reconnecting="reconnecting",B.SignalReconnecting="signalReconnecting"})(ConnectionState||(ConnectionState={}));const connectionReconcileFrequency=4*1e3;class Room extends eventsExports.EventEmitter{constructor($){var U,F,V,q;if(super(),U=this,this.state=ConnectionState.Disconnected,this.activeSpeakers=[],this.isE2EEEnabled=!1,this.audioEnabled=!0,this.isVideoPlaybackBlocked=!1,this.log=livekitLogger,this.bufferedEvents=[],this.isResuming=!1,this.rpcHandlers=new Map,this.connect=(j,W,K)=>__awaiter(this,void 0,void 0,function*(){var G;if(!isBrowserSupported())throw isReactNative()?Error("WebRTC isn't detected, have you called registerGlobals?"):Error("LiveKit doesn't seem to be supported on this browser. Try to update your browser and make sure no browser extensions are disabling webRTC.");const z=yield this.disconnectLock.lock();if(this.state===ConnectionState.Connected)return this.log.info("already connected to room ".concat(this.name),this.logContext),z(),Promise.resolve();if(this.connectFuture)return z(),this.connectFuture.promise;this.setAndEmitConnectionState(ConnectionState.Connecting),((G=this.regionUrlProvider)===null||G===void 0?void 0:G.getServerUrl().toString())!==j&&(this.regionUrl=void 0,this.regionUrlProvider=void 0),isCloud(new URL(j))&&(this.regionUrlProvider===void 0?this.regionUrlProvider=new RegionUrlProvider(j,W):this.regionUrlProvider.updateToken(W),this.regionUrlProvider.fetchRegionSettings().then(Y=>{var X;(X=this.regionUrlProvider)===null||X===void 0||X.setServerReportedRegions(Y)}).catch(Y=>{this.log.warn("could not fetch region settings",Object.assign(Object.assign({},this.logContext),{error:Y}))}));const H=(Y,X,Z)=>__awaiter(this,void 0,void 0,function*(){var ne,ee;this.abortController&&this.abortController.abort();const ie=new AbortController;this.abortController=ie,z?.();try{yield this.attemptConnection(Z??j,W,K,ie),this.abortController=void 0,Y()}catch(se){if(this.regionUrlProvider&&se instanceof ConnectionError&&se.reason!==ConnectionErrorReason.Cancelled&&se.reason!==ConnectionErrorReason.NotAllowed){let te=null;try{te=yield this.regionUrlProvider.getNextBestRegionUrl((ne=this.abortController)===null||ne===void 0?void 0:ne.signal)}catch(re){if(re instanceof ConnectionError&&(re.status===401||re.reason===ConnectionErrorReason.Cancelled)){this.handleDisconnect(this.options.stopLocalTrackOnUnpublish),X(re);return}}te&&!(!((ee=this.abortController)===null||ee===void 0)&&ee.signal.aborted)?(this.log.info("Initial connection failed with ConnectionError: ".concat(se.message,". Retrying with another region: ").concat(te),this.logContext),this.recreateEngine(),yield H(Y,X,te)):(this.handleDisconnect(this.options.stopLocalTrackOnUnpublish,getDisconnectReasonFromConnectionError(se)),X(se))}else{let te=DisconnectReason.UNKNOWN_REASON;se instanceof ConnectionError&&(te=getDisconnectReasonFromConnectionError(se)),this.handleDisconnect(this.options.stopLocalTrackOnUnpublish,te),X(se)}}}),Q=this.regionUrl;return this.regionUrl=void 0,this.connectFuture=new Future((Y,X)=>{H(Y,X,Q)},()=>{this.clearConnectionFutures()}),this.connectFuture.promise}),this.connectSignal=(j,W,K,G,z,H)=>__awaiter(this,void 0,void 0,function*(){var Q,Y,X;const Z=yield K.join(j,W,{autoSubscribe:G.autoSubscribe,adaptiveStream:typeof z.adaptiveStream=="object"?!0:z.adaptiveStream,maxRetries:G.maxRetries,e2eeEnabled:!!this.e2eeManager,websocketTimeout:G.websocketTimeout},H.signal);let ne=Z.serverInfo;if(ne||(ne={version:Z.serverVersion,region:Z.serverRegion}),this.serverInfo=ne,this.log.debug("connected to Livekit Server ".concat(Object.entries(ne).map(ee=>{let[ie,se]=ee;return"".concat(ie,": ").concat(se)}).join(", ")),{room:(Q=Z.room)===null||Q===void 0?void 0:Q.name,roomSid:(Y=Z.room)===null||Y===void 0?void 0:Y.sid,identity:(X=Z.participant)===null||X===void 0?void 0:X.identity}),!ne.version)throw new UnsupportedServer("unknown server version");return ne.version==="0.15.1"&&this.options.dynacast&&(this.log.debug("disabling dynacast due to server version",this.logContext),z.dynacast=!1),Z}),this.applyJoinResponse=j=>{const W=j.participant;if(this.localParticipant.sid=W.sid,this.localParticipant.identity=W.identity,this.localParticipant.setEnabledPublishCodecs(j.enabledPublishCodecs),this.options.e2ee&&this.e2eeManager)try{this.e2eeManager.setSifTrailer(j.sifTrailer)}catch(K){this.log.error(K instanceof Error?K.message:"Could not set SifTrailer",Object.assign(Object.assign({},this.logContext),{error:K}))}this.handleParticipantUpdates([W,...j.otherParticipants]),j.room&&this.handleRoomUpdate(j.room)},this.attemptConnection=(j,W,K,G)=>__awaiter(this,void 0,void 0,function*(){var z,H;this.state===ConnectionState.Reconnecting||this.isResuming||!((z=this.engine)===null||z===void 0)&&z.pendingReconnect?(this.log.info("Reconnection attempt replaced by new connection attempt",this.logContext),this.recreateEngine()):this.maybeCreateEngine(),!((H=this.regionUrlProvider)===null||H===void 0)&&H.isCloud()&&this.engine.setRegionUrlProvider(this.regionUrlProvider),this.acquireAudioContext(),this.connOptions=Object.assign(Object.assign({},roomConnectOptionDefaults),K),this.connOptions.rtcConfig&&(this.engine.rtcConfig=this.connOptions.rtcConfig),this.connOptions.peerConnectionTimeout&&(this.engine.peerConnectionTimeout=this.connOptions.peerConnectionTimeout);try{const Q=yield this.connectSignal(j,W,this.engine,this.connOptions,this.options,G);this.applyJoinResponse(Q),this.setupLocalParticipantEvents(),this.emit(RoomEvent.SignalConnected)}catch(Q){yield this.engine.close(),this.recreateEngine();const Y=new ConnectionError("could not establish signal connection",ConnectionErrorReason.ServerUnreachable);throw Q instanceof Error&&(Y.message="".concat(Y.message,": ").concat(Q.message)),Q instanceof ConnectionError&&(Y.reason=Q.reason,Y.status=Q.status),this.log.debug("error trying to establish signal connection",Object.assign(Object.assign({},this.logContext),{error:Q})),Y}if(G.signal.aborted)throw yield this.engine.close(),this.recreateEngine(),new ConnectionError("Connection attempt aborted",ConnectionErrorReason.Cancelled);try{yield this.engine.waitForPCInitialConnection(this.connOptions.peerConnectionTimeout,G)}catch(Q){throw yield this.engine.close(),this.recreateEngine(),Q}isWeb()&&this.options.disconnectOnPageLeave&&(window.addEventListener("pagehide",this.onPageLeave),window.addEventListener("beforeunload",this.onPageLeave)),isWeb()&&document.addEventListener("freeze",this.onPageLeave),this.setAndEmitConnectionState(ConnectionState.Connected),this.emit(RoomEvent.Connected),this.registerConnectionReconcile()}),this.disconnect=function(){for(var j=arguments.length,W=new Array(j),K=0;K<j;K++)W[K]=arguments[K];return __awaiter(U,[...W],void 0,function(){var G=this;let z=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0;return(function*(){var H,Q,Y,X;const Z=yield G.disconnectLock.lock();try{if(G.state===ConnectionState.Disconnected){G.log.debug("already disconnected",G.logContext);return}G.log.info("disconnect from room",Object.assign({},G.logContext)),(G.state===ConnectionState.Connecting||G.state===ConnectionState.Reconnecting||G.isResuming)&&(G.log.warn("abort connection attempt",G.logContext),(H=G.abortController)===null||H===void 0||H.abort(),(Y=(Q=G.connectFuture)===null||Q===void 0?void 0:Q.reject)===null||Y===void 0||Y.call(Q,new ConnectionError("Client initiated disconnect",ConnectionErrorReason.Cancelled)),G.connectFuture=void 0),!((X=G.engine)===null||X===void 0)&&X.client.isDisconnected||(yield G.engine.client.sendLeave()),G.engine&&(yield G.engine.close()),G.handleDisconnect(z,DisconnectReason.CLIENT_INITIATED),G.engine=void 0}finally{Z()}})()})},this.onPageLeave=()=>__awaiter(this,void 0,void 0,function*(){this.log.info("Page leave detected, disconnecting",this.logContext),yield this.disconnect()}),this.startAudio=()=>__awaiter(this,void 0,void 0,function*(){const j=[],W=getBrowser();if(W&&W.os==="iOS"){const K="livekit-dummy-audio-el";let G=document.getElementById(K);if(!G){G=document.createElement("audio"),G.id=K,G.autoplay=!0,G.hidden=!0;const z=getEmptyAudioStreamTrack();z.enabled=!0;const H=new MediaStream([z]);G.srcObject=H,document.addEventListener("visibilitychange",()=>{G&&(G.srcObject=document.hidden?null:H,document.hidden||(this.log.debug("page visible again, triggering startAudio to resume playback and update playback status",this.logContext),this.startAudio()))}),document.body.append(G),this.once(RoomEvent.Disconnected,()=>{G?.remove(),G=null})}j.push(G)}this.remoteParticipants.forEach(K=>{K.audioTrackPublications.forEach(G=>{G.track&&G.track.attachedElements.forEach(z=>{j.push(z)})})});try{yield Promise.all([this.acquireAudioContext(),...j.map(K=>(K.muted=!1,K.play()))]),this.handleAudioPlaybackStarted()}catch(K){throw this.handleAudioPlaybackFailed(K),K}}),this.startVideo=()=>__awaiter(this,void 0,void 0,function*(){const j=[];for(const W of this.remoteParticipants.values())W.videoTrackPublications.forEach(K=>{var G;(G=K.track)===null||G===void 0||G.attachedElements.forEach(z=>{j.includes(z)||j.push(z)})});yield Promise.all(j.map(W=>W.play())).then(()=>{this.handleVideoPlaybackStarted()}).catch(W=>{W.name==="NotAllowedError"?this.handleVideoPlaybackFailed():this.log.warn("Resuming video playback failed, make sure you call `startVideo` directly in a user gesture handler",this.logContext)})}),this.handleRestarting=()=>{this.clearConnectionReconcile(),this.isResuming=!1;for(const j of this.remoteParticipants.values())this.handleParticipantDisconnected(j.identity,j);this.setAndEmitConnectionState(ConnectionState.Reconnecting)&&this.emit(RoomEvent.Reconnecting)},this.handleSignalRestarted=j=>__awaiter(this,void 0,void 0,function*(){this.log.debug("signal reconnected to server, region ".concat(j.serverRegion),Object.assign(Object.assign({},this.logContext),{region:j.serverRegion})),this.bufferedEvents=[],this.applyJoinResponse(j);try{yield this.localParticipant.republishAllTracks(void 0,!0)}catch(W){this.log.error("error trying to re-publish tracks after reconnection",Object.assign(Object.assign({},this.logContext),{error:W}))}try{yield this.engine.waitForRestarted(),this.log.debug("fully reconnected to server",Object.assign(Object.assign({},this.logContext),{region:j.serverRegion}))}catch{return}this.setAndEmitConnectionState(ConnectionState.Connected),this.emit(RoomEvent.Reconnected),this.registerConnectionReconcile(),this.emitBufferedEvents()}),this.handleParticipantUpdates=j=>{j.forEach(W=>{var K;if(W.identity===this.localParticipant.identity){this.localParticipant.updateInfo(W);return}W.identity===""&&(W.identity=(K=this.sidToIdentity.get(W.sid))!==null&&K!==void 0?K:"");let G=this.remoteParticipants.get(W.identity);W.state===ParticipantInfo_State.DISCONNECTED?this.handleParticipantDisconnected(W.identity,G):G=this.getOrCreateParticipant(W.identity,W)})},this.handleActiveSpeakersUpdate=j=>{const W=[],K={};j.forEach(G=>{if(K[G.sid]=!0,G.sid===this.localParticipant.sid)this.localParticipant.audioLevel=G.level,this.localParticipant.setIsSpeaking(!0),W.push(this.localParticipant);else{const z=this.getRemoteParticipantBySid(G.sid);z&&(z.audioLevel=G.level,z.setIsSpeaking(!0),W.push(z))}}),K[this.localParticipant.sid]||(this.localParticipant.audioLevel=0,this.localParticipant.setIsSpeaking(!1)),this.remoteParticipants.forEach(G=>{K[G.sid]||(G.audioLevel=0,G.setIsSpeaking(!1))}),this.activeSpeakers=W,this.emitWhenConnected(RoomEvent.ActiveSpeakersChanged,W)},this.handleSpeakersChanged=j=>{const W=new Map;this.activeSpeakers.forEach(G=>{const z=this.remoteParticipants.get(G.identity);z&&z.sid!==G.sid||W.set(G.sid,G)}),j.forEach(G=>{let z=this.getRemoteParticipantBySid(G.sid);G.sid===this.localParticipant.sid&&(z=this.localParticipant),z&&(z.audioLevel=G.level,z.setIsSpeaking(G.active),G.active?W.set(G.sid,z):W.delete(G.sid))});const K=Array.from(W.values());K.sort((G,z)=>z.audioLevel-G.audioLevel),this.activeSpeakers=K,this.emitWhenConnected(RoomEvent.ActiveSpeakersChanged,K)},this.handleStreamStateUpdate=j=>{j.streamStates.forEach(W=>{const K=this.getRemoteParticipantBySid(W.participantSid);if(!K)return;const G=K.getTrackPublicationBySid(W.trackSid);if(!G||!G.track)return;const z=Track.streamStateFromProto(W.state);G.track.setStreamState(z),z!==G.track.streamState&&(K.emit(ParticipantEvent.TrackStreamStateChanged,G,G.track.streamState),this.emitWhenConnected(RoomEvent.TrackStreamStateChanged,G,G.track.streamState,K))})},this.handleSubscriptionPermissionUpdate=j=>{const W=this.getRemoteParticipantBySid(j.participantSid);if(!W)return;const K=W.getTrackPublicationBySid(j.trackSid);K&&K.setAllowed(j.allowed)},this.handleSubscriptionError=j=>{const W=Array.from(this.remoteParticipants.values()).find(G=>G.trackPublications.has(j.trackSid));if(!W)return;const K=W.getTrackPublicationBySid(j.trackSid);K&&K.setSubscriptionError(j.err)},this.handleDataPacket=j=>{const W=this.remoteParticipants.get(j.participantIdentity);if(j.value.case==="user")this.handleUserPacket(W,j.value.value,j.kind);else if(j.value.case==="transcription")this.handleTranscription(W,j.value.value);else if(j.value.case==="sipDtmf")this.handleSipDtmf(W,j.value.value);else if(j.value.case==="chatMessage")this.handleChatMessage(W,j.value.value);else if(j.value.case==="metrics")this.handleMetrics(j.value.value,W);else if(j.value.case==="streamHeader"||j.value.case==="streamChunk"||j.value.case==="streamTrailer")this.handleDataStream(j);else if(j.value.case==="rpcRequest"){const K=j.value.value;this.handleIncomingRpcRequest(j.participantIdentity,K.id,K.method,K.payload,K.responseTimeoutMs,K.version)}},this.handleUserPacket=(j,W,K)=>{this.emit(RoomEvent.DataReceived,W.payload,j,K,W.topic),j?.emit(ParticipantEvent.DataReceived,W.payload,K)},this.handleSipDtmf=(j,W)=>{this.emit(RoomEvent.SipDTMFReceived,W,j),j?.emit(ParticipantEvent.SipDTMFReceived,W)},this.handleTranscription=(j,W)=>{const K=W.transcribedParticipantIdentity===this.localParticipant.identity?this.localParticipant:this.getParticipantByIdentity(W.transcribedParticipantIdentity),G=K?.trackPublications.get(W.trackId),z=extractTranscriptionSegments(W,this.transcriptionReceivedTimes);G?.emit(TrackEvent.TranscriptionReceived,z),K?.emit(ParticipantEvent.TranscriptionReceived,z,G),this.emit(RoomEvent.TranscriptionReceived,z,K,G)},this.handleChatMessage=(j,W)=>{const K=extractChatMessage(W);this.emit(RoomEvent.ChatMessage,K,j)},this.handleMetrics=(j,W)=>{this.emit(RoomEvent.MetricsReceived,j,W)},this.handleDataStream=j=>{this.incomingDataStreamManager.handleDataStreamPacket(j)},this.bufferedSegments=new Map,this.handleAudioPlaybackStarted=()=>{this.canPlaybackAudio||(this.audioEnabled=!0,this.emit(RoomEvent.AudioPlaybackStatusChanged,!0))},this.handleAudioPlaybackFailed=j=>{this.log.warn("could not playback audio",Object.assign(Object.assign({},this.logContext),{error:j})),this.canPlaybackAudio&&(this.audioEnabled=!1,this.emit(RoomEvent.AudioPlaybackStatusChanged,!1))},this.handleVideoPlaybackStarted=()=>{this.isVideoPlaybackBlocked&&(this.isVideoPlaybackBlocked=!1,this.emit(RoomEvent.VideoPlaybackStatusChanged,!0))},this.handleVideoPlaybackFailed=()=>{this.isVideoPlaybackBlocked||(this.isVideoPlaybackBlocked=!0,this.emit(RoomEvent.VideoPlaybackStatusChanged,!1))},this.handleDeviceChange=()=>__awaiter(this,void 0,void 0,function*(){var j;((j=getBrowser())===null||j===void 0?void 0:j.os)!=="iOS"&&(yield this.selectDefaultDevices()),this.emit(RoomEvent.MediaDevicesChanged)}),this.handleRoomUpdate=j=>{const W=this.roomInfo;this.roomInfo=j,W&&W.metadata!==j.metadata&&this.emitWhenConnected(RoomEvent.RoomMetadataChanged,j.metadata),W?.activeRecording!==j.activeRecording&&this.emitWhenConnected(RoomEvent.RecordingStatusChanged,j.activeRecording)},this.handleConnectionQualityUpdate=j=>{j.updates.forEach(W=>{if(W.participantSid===this.localParticipant.sid){this.localParticipant.setConnectionQuality(W.quality);return}const K=this.getRemoteParticipantBySid(W.participantSid);K&&K.setConnectionQuality(W.quality)})},this.onLocalParticipantMetadataChanged=j=>{this.emit(RoomEvent.ParticipantMetadataChanged,j,this.localParticipant)},this.onLocalParticipantNameChanged=j=>{this.emit(RoomEvent.ParticipantNameChanged,j,this.localParticipant)},this.onLocalAttributesChanged=j=>{this.emit(RoomEvent.ParticipantAttributesChanged,j,this.localParticipant)},this.onLocalTrackMuted=j=>{this.emit(RoomEvent.TrackMuted,j,this.localParticipant)},this.onLocalTrackUnmuted=j=>{this.emit(RoomEvent.TrackUnmuted,j,this.localParticipant)},this.onTrackProcessorUpdate=j=>{var W;(W=j?.onPublish)===null||W===void 0||W.call(j,this)},this.onLocalTrackPublished=j=>__awaiter(this,void 0,void 0,function*(){var W,K,G,z,H,Q;(W=j.track)===null||W===void 0||W.on(TrackEvent.TrackProcessorUpdate,this.onTrackProcessorUpdate),(K=j.track)===null||K===void 0||K.on(TrackEvent.Restarted,this.onLocalTrackRestarted),(H=(z=(G=j.track)===null||G===void 0?void 0:G.getProcessor())===null||z===void 0?void 0:z.onPublish)===null||H===void 0||H.call(z,this),this.emit(RoomEvent.LocalTrackPublished,j,this.localParticipant),isLocalAudioTrack(j.track)&&(yield j.track.checkForSilence())&&this.emit(RoomEvent.LocalAudioSilenceDetected,j);const Y=yield(Q=j.track)===null||Q===void 0?void 0:Q.getDeviceId(!1),X=sourceToKind(j.source);X&&Y&&Y!==this.localParticipant.activeDeviceMap.get(X)&&(this.localParticipant.activeDeviceMap.set(X,Y),this.emit(RoomEvent.ActiveDeviceChanged,X,Y))}),this.onLocalTrackUnpublished=j=>{var W,K;(W=j.track)===null||W===void 0||W.off(TrackEvent.TrackProcessorUpdate,this.onTrackProcessorUpdate),(K=j.track)===null||K===void 0||K.off(TrackEvent.Restarted,this.onLocalTrackRestarted),this.emit(RoomEvent.LocalTrackUnpublished,j,this.localParticipant)},this.onLocalTrackRestarted=j=>__awaiter(this,void 0,void 0,function*(){const W=yield j.getDeviceId(!1),K=sourceToKind(j.source);K&&W&&W!==this.localParticipant.activeDeviceMap.get(K)&&(this.log.debug("local track restarted, setting ".concat(K," ").concat(W," active"),this.logContext),this.localParticipant.activeDeviceMap.set(K,W),this.emit(RoomEvent.ActiveDeviceChanged,K,W))}),this.onLocalConnectionQualityChanged=j=>{this.emit(RoomEvent.ConnectionQualityChanged,j,this.localParticipant)},this.onMediaDevicesError=(j,W)=>{this.emit(RoomEvent.MediaDevicesError,j,W)},this.onLocalParticipantPermissionsChanged=j=>{this.emit(RoomEvent.ParticipantPermissionsChanged,j,this.localParticipant)},this.onLocalChatMessageSent=j=>{this.emit(RoomEvent.ChatMessage,j,this.localParticipant)},this.setMaxListeners(100),this.remoteParticipants=new Map,this.sidToIdentity=new Map,this.options=Object.assign(Object.assign({},roomOptionDefaults),$),this.log=getLogger((F=this.options.loggerName)!==null&&F!==void 0?F:LoggerNames.Room),this.transcriptionReceivedTimes=new Map,this.options.audioCaptureDefaults=Object.assign(Object.assign({},audioDefaults),$?.audioCaptureDefaults),this.options.videoCaptureDefaults=Object.assign(Object.assign({},videoDefaults),$?.videoCaptureDefaults),this.options.publishDefaults=Object.assign(Object.assign({},publishDefaults),$?.publishDefaults),this.maybeCreateEngine(),this.incomingDataStreamManager=new IncomingDataStreamManager,this.outgoingDataStreamManager=new OutgoingDataStreamManager(this.engine,this.log),this.disconnectLock=new _,this.localParticipant=new LocalParticipant("","",this.engine,this.options,this.rpcHandlers,this.outgoingDataStreamManager),this.options.videoCaptureDefaults.deviceId&&this.localParticipant.activeDeviceMap.set("videoinput",unwrapConstraint(this.options.videoCaptureDefaults.deviceId)),this.options.audioCaptureDefaults.deviceId&&this.localParticipant.activeDeviceMap.set("audioinput",unwrapConstraint(this.options.audioCaptureDefaults.deviceId)),!((V=this.options.audioOutput)===null||V===void 0)&&V.deviceId&&this.switchActiveDevice("audiooutput",unwrapConstraint(this.options.audioOutput.deviceId)).catch(j=>this.log.warn("Could not set audio output: ".concat(j.message),this.logContext)),this.options.e2ee&&this.setupE2EE(),isWeb()){const j=new AbortController;(q=navigator.mediaDevices)===null||q===void 0||q.addEventListener("devicechange",this.handleDeviceChange,{signal:j.signal}),Room.cleanupRegistry&&Room.cleanupRegistry.register(this,()=>{j.abort()})}}registerTextStreamHandler($,U){return this.incomingDataStreamManager.registerTextStreamHandler($,U)}unregisterTextStreamHandler($){return this.incomingDataStreamManager.unregisterTextStreamHandler($)}registerByteStreamHandler($,U){return this.incomingDataStreamManager.registerByteStreamHandler($,U)}unregisterByteStreamHandler($){return this.incomingDataStreamManager.unregisterByteStreamHandler($)}registerRpcMethod($,U){if(this.rpcHandlers.has($))throw Error("RPC handler already registered for method ".concat($,", unregisterRpcMethod before trying to register again"));this.rpcHandlers.set($,U)}unregisterRpcMethod($){this.rpcHandlers.delete($)}setE2EEEnabled($){return __awaiter(this,void 0,void 0,function*(){if(this.e2eeManager)yield Promise.all([this.localParticipant.setE2EEEnabled($)]),this.localParticipant.identity!==""&&this.e2eeManager.setParticipantCryptorEnabled($,this.localParticipant.identity);else throw Error("e2ee not configured, please set e2ee settings within the room options")})}setupE2EE(){var $;this.options.e2ee&&("e2eeManager"in this.options.e2ee?this.e2eeManager=this.options.e2ee.e2eeManager:this.e2eeManager=new E2EEManager(this.options.e2ee),this.e2eeManager.on(EncryptionEvent.ParticipantEncryptionStatusChanged,(U,F)=>{isLocalParticipant(F)&&(this.isE2EEEnabled=U),this.emit(RoomEvent.ParticipantEncryptionStatusChanged,U,F)}),this.e2eeManager.on(EncryptionEvent.EncryptionError,U=>this.emit(RoomEvent.EncryptionError,U)),($=this.e2eeManager)===null||$===void 0||$.setup(this))}get logContext(){var $;return{room:this.name,roomID:($=this.roomInfo)===null||$===void 0?void 0:$.sid,participant:this.localParticipant.identity,pID:this.localParticipant.sid}}get isRecording(){var $,U;return(U=($=this.roomInfo)===null||$===void 0?void 0:$.activeRecording)!==null&&U!==void 0?U:!1}getSid(){return __awaiter(this,void 0,void 0,function*(){return this.state===ConnectionState.Disconnected?"":this.roomInfo&&this.roomInfo.sid!==""?this.roomInfo.sid:new Promise(($,U)=>{const F=V=>{V.sid!==""&&(this.engine.off(EngineEvent.RoomUpdate,F),$(V.sid))};this.engine.on(EngineEvent.RoomUpdate,F),this.once(RoomEvent.Disconnected,()=>{this.engine.off(EngineEvent.RoomUpdate,F),U("Room disconnected before room server id was available")})})})}get name(){var $,U;return(U=($=this.roomInfo)===null||$===void 0?void 0:$.name)!==null&&U!==void 0?U:""}get metadata(){var $;return($=this.roomInfo)===null||$===void 0?void 0:$.metadata}get numParticipants(){var $,U;return(U=($=this.roomInfo)===null||$===void 0?void 0:$.numParticipants)!==null&&U!==void 0?U:0}get numPublishers(){var $,U;return(U=($=this.roomInfo)===null||$===void 0?void 0:$.numPublishers)!==null&&U!==void 0?U:0}maybeCreateEngine(){this.engine&&!this.engine.isClosed||(this.engine=new RTCEngine(this.options),this.engine.on(EngineEvent.ParticipantUpdate,this.handleParticipantUpdates).on(EngineEvent.RoomUpdate,this.handleRoomUpdate).on(EngineEvent.SpeakersChanged,this.handleSpeakersChanged).on(EngineEvent.StreamStateChanged,this.handleStreamStateUpdate).on(EngineEvent.ConnectionQualityUpdate,this.handleConnectionQualityUpdate).on(EngineEvent.SubscriptionError,this.handleSubscriptionError).on(EngineEvent.SubscriptionPermissionUpdate,this.handleSubscriptionPermissionUpdate).on(EngineEvent.MediaTrackAdded,($,U,F)=>{this.onTrackAdded($,U,F)}).on(EngineEvent.Disconnected,$=>{this.handleDisconnect(this.options.stopLocalTrackOnUnpublish,$)}).on(EngineEvent.ActiveSpeakersUpdate,this.handleActiveSpeakersUpdate).on(EngineEvent.DataPacketReceived,this.handleDataPacket).on(EngineEvent.Resuming,()=>{this.clearConnectionReconcile(),this.isResuming=!0,this.log.info("Resuming signal connection",this.logContext),this.setAndEmitConnectionState(ConnectionState.SignalReconnecting)&&this.emit(RoomEvent.SignalReconnecting)}).on(EngineEvent.Resumed,()=>{this.registerConnectionReconcile(),this.isResuming=!1,this.log.info("Resumed signal connection",this.logContext),this.updateSubscriptions(),this.emitBufferedEvents(),this.setAndEmitConnectionState(ConnectionState.Connected)&&this.emit(RoomEvent.Reconnected)}).on(EngineEvent.SignalResumed,()=>{this.bufferedEvents=[],(this.state===ConnectionState.Reconnecting||this.isResuming)&&this.sendSyncState()}).on(EngineEvent.Restarting,this.handleRestarting).on(EngineEvent.SignalRestarted,this.handleSignalRestarted).on(EngineEvent.Offline,()=>{this.setAndEmitConnectionState(ConnectionState.Reconnecting)&&this.emit(RoomEvent.Reconnecting)}).on(EngineEvent.DCBufferStatusChanged,($,U)=>{this.emit(RoomEvent.DCBufferStatusChanged,$,U)}).on(EngineEvent.LocalTrackSubscribed,$=>{const U=this.localParticipant.getTrackPublications().find(F=>{let{trackSid:V}=F;return V===$});if(!U){this.log.warn("could not find local track subscription for subscribed event",this.logContext);return}this.localParticipant.emit(ParticipantEvent.LocalTrackSubscribed,U),this.emitWhenConnected(RoomEvent.LocalTrackSubscribed,U,this.localParticipant)}).on(EngineEvent.RoomMoved,$=>{this.log.debug("room moved",$),$.room&&this.handleRoomUpdate($.room),this.remoteParticipants.forEach((U,F)=>{this.handleParticipantDisconnected(F,U)}),this.emit(RoomEvent.Moved,$.room.name),$.participant?this.handleParticipantUpdates([$.participant,...$.otherParticipants]):this.handleParticipantUpdates($.otherParticipants)}),this.localParticipant&&this.localParticipant.setupEngine(this.engine),this.e2eeManager&&this.e2eeManager.setupEngine(this.engine),this.outgoingDataStreamManager&&this.outgoingDataStreamManager.setupEngine(this.engine))}static getLocalDevices($){let U=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0;return DeviceManager.getInstance().getDevices($,U)}prepareConnection($,U){return __awaiter(this,void 0,void 0,function*(){if(this.state===ConnectionState.Disconnected){this.log.debug("prepareConnection to ".concat($),this.logContext);try{if(isCloud(new URL($))&&U){this.regionUrlProvider=new RegionUrlProvider($,U);const F=yield this.regionUrlProvider.getNextBestRegionUrl();F&&this.state===ConnectionState.Disconnected&&(this.regionUrl=F,yield fetch(toHttpUrl(F),{method:"HEAD"}),this.log.debug("prepared connection to ".concat(F),this.logContext))}else yield fetch(toHttpUrl($),{method:"HEAD"})}catch(F){this.log.warn("could not prepare connection",Object.assign(Object.assign({},this.logContext),{error:F}))}}})}getParticipantByIdentity($){return this.localParticipant.identity===$?this.localParticipant:this.remoteParticipants.get($)}clearConnectionFutures(){this.connectFuture=void 0}simulateScenario($,U){return __awaiter(this,void 0,void 0,function*(){let F=()=>__awaiter(this,void 0,void 0,function*(){}),V;switch($){case"signal-reconnect":yield this.engine.client.handleOnClose("simulate disconnect");break;case"speaker":V=new SimulateScenario({scenario:{case:"speakerUpdate",value:3}});break;case"node-failure":V=new SimulateScenario({scenario:{case:"nodeFailure",value:!0}});break;case"server-leave":V=new SimulateScenario({scenario:{case:"serverLeave",value:!0}});break;case"migration":V=new SimulateScenario({scenario:{case:"migration",value:!0}});break;case"resume-reconnect":this.engine.failNext(),yield this.engine.client.handleOnClose("simulate resume-disconnect");break;case"disconnect-signal-on-resume":F=()=>__awaiter(this,void 0,void 0,function*(){yield this.engine.client.handleOnClose("simulate resume-disconnect")}),V=new SimulateScenario({scenario:{case:"disconnectSignalOnResume",value:!0}});break;case"disconnect-signal-on-resume-no-messages":F=()=>__awaiter(this,void 0,void 0,function*(){yield this.engine.client.handleOnClose("simulate resume-disconnect")}),V=new SimulateScenario({scenario:{case:"disconnectSignalOnResumeNoMessages",value:!0}});break;case"full-reconnect":this.engine.fullReconnectOnNext=!0,yield this.engine.client.handleOnClose("simulate full-reconnect");break;case"force-tcp":case"force-tls":V=new SimulateScenario({scenario:{case:"switchCandidateProtocol",value:$==="force-tls"?2:1}}),F=()=>__awaiter(this,void 0,void 0,function*(){const q=this.engine.client.onLeave;q&&q(new LeaveRequest({reason:DisconnectReason.CLIENT_INITIATED,action:LeaveRequest_Action.RECONNECT}))});break;case"subscriber-bandwidth":if(U===void 0||typeof U!="number")throw new Error("subscriber-bandwidth requires a number as argument");V=new SimulateScenario({scenario:{case:"subscriberBandwidth",value:numberToBigInt(U)}});break;case"leave-full-reconnect":V=new SimulateScenario({scenario:{case:"leaveRequestFullReconnect",value:!0}})}V&&(yield this.engine.client.sendSimulateScenario(V),yield F())})}get canPlaybackAudio(){return this.audioEnabled}get canPlaybackVideo(){return!this.isVideoPlaybackBlocked}getActiveDevice($){return this.localParticipant.activeDeviceMap.get($)}switchActiveDevice($,U){return __awaiter(this,arguments,void 0,function(F,V){var q=this;let j=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!0;return(function*(){var W,K,G,z,H,Q,Y;let X=!0,Z=!1;const ne=j?{exact:V}:V;if(F==="audioinput"){Z=q.localParticipant.audioTrackPublications.size===0;const ee=(W=q.getActiveDevice(F))!==null&&W!==void 0?W:q.options.audioCaptureDefaults.deviceId;q.options.audioCaptureDefaults.deviceId=ne;const ie=Array.from(q.localParticipant.audioTrackPublications.values()).filter(te=>te.source===Track.Source.Microphone);try{X=(yield Promise.all(ie.map(te=>{var re;return(re=te.audioTrack)===null||re===void 0?void 0:re.setDeviceId(ne)}))).every(te=>te===!0)}catch(te){throw q.options.audioCaptureDefaults.deviceId=ee,te}const se=ie.some(te=>{var re,ae;return(ae=(re=te.track)===null||re===void 0?void 0:re.isMuted)!==null&&ae!==void 0?ae:!1});X&&se&&(Z=!0)}else if(F==="videoinput"){Z=q.localParticipant.videoTrackPublications.size===0;const ee=(K=q.getActiveDevice(F))!==null&&K!==void 0?K:q.options.videoCaptureDefaults.deviceId;q.options.videoCaptureDefaults.deviceId=ne;const ie=Array.from(q.localParticipant.videoTrackPublications.values()).filter(te=>te.source===Track.Source.Camera);try{X=(yield Promise.all(ie.map(te=>{var re;return(re=te.videoTrack)===null||re===void 0?void 0:re.setDeviceId(ne)}))).every(te=>te===!0)}catch(te){throw q.options.videoCaptureDefaults.deviceId=ee,te}const se=ie.some(te=>{var re,ae;return(ae=(re=te.track)===null||re===void 0?void 0:re.isMuted)!==null&&ae!==void 0?ae:!1});X&&se&&(Z=!0)}else if(F==="audiooutput"){if(Z=!0,!supportsSetSinkId()&&!q.options.webAudioMix||q.options.webAudioMix&&q.audioContext&&!("setSinkId"in q.audioContext))throw new Error("cannot switch audio output, the current browser does not support it");q.options.webAudioMix&&(V=(G=yield DeviceManager.getInstance().normalizeDeviceId("audiooutput",V))!==null&&G!==void 0?G:""),(z=(Y=q.options).audioOutput)!==null&&z!==void 0||(Y.audioOutput={});const ee=(H=q.getActiveDevice(F))!==null&&H!==void 0?H:q.options.audioOutput.deviceId;q.options.audioOutput.deviceId=V;try{q.options.webAudioMix&&((Q=q.audioContext)===null||Q===void 0||Q.setSinkId(V)),yield Promise.all(Array.from(q.remoteParticipants.values()).map(ie=>ie.setAudioOutput({deviceId:V})))}catch(ie){throw q.options.audioOutput.deviceId=ee,ie}}return Z&&(q.localParticipant.activeDeviceMap.set(F,V),q.emit(RoomEvent.ActiveDeviceChanged,F,V)),X})()})}setupLocalParticipantEvents(){this.localParticipant.on(ParticipantEvent.ParticipantMetadataChanged,this.onLocalParticipantMetadataChanged).on(ParticipantEvent.ParticipantNameChanged,this.onLocalParticipantNameChanged).on(ParticipantEvent.AttributesChanged,this.onLocalAttributesChanged).on(ParticipantEvent.TrackMuted,this.onLocalTrackMuted).on(ParticipantEvent.TrackUnmuted,this.onLocalTrackUnmuted).on(ParticipantEvent.LocalTrackPublished,this.onLocalTrackPublished).on(ParticipantEvent.LocalTrackUnpublished,this.onLocalTrackUnpublished).on(ParticipantEvent.ConnectionQualityChanged,this.onLocalConnectionQualityChanged).on(ParticipantEvent.MediaDevicesError,this.onMediaDevicesError).on(ParticipantEvent.AudioStreamAcquired,this.startAudio).on(ParticipantEvent.ChatMessage,this.onLocalChatMessageSent).on(ParticipantEvent.ParticipantPermissionsChanged,this.onLocalParticipantPermissionsChanged)}recreateEngine(){var $;($=this.engine)===null||$===void 0||$.close(),this.engine=void 0,this.isResuming=!1,this.remoteParticipants.clear(),this.sidToIdentity.clear(),this.bufferedEvents=[],this.maybeCreateEngine()}onTrackAdded($,U,F){if(this.state===ConnectionState.Connecting||this.state===ConnectionState.Reconnecting){const H=()=>{this.onTrackAdded($,U,F),Q()},Q=()=>{this.off(RoomEvent.Reconnected,H),this.off(RoomEvent.Connected,H),this.off(RoomEvent.Disconnected,Q)};this.once(RoomEvent.Reconnected,H),this.once(RoomEvent.Connected,H),this.once(RoomEvent.Disconnected,Q);return}if(this.state===ConnectionState.Disconnected){this.log.warn("skipping incoming track after Room disconnected",this.logContext);return}if($.readyState==="ended"){this.log.info("skipping incoming track as it already ended",this.logContext);return}const V=unpackStreamId(U.id),q=V[0];let j=V[1],W=$.id;if(j&&j.startsWith("TR")&&(W=j),q===this.localParticipant.sid){this.log.warn("tried to create RemoteParticipant for local participant",this.logContext);return}const K=Array.from(this.remoteParticipants.values()).find(H=>H.sid===q);if(!K){this.log.error("Tried to add a track for a participant, that's not present. Sid: ".concat(q),this.logContext);return}let G;this.options.adaptiveStream&&(typeof this.options.adaptiveStream=="object"?G=this.options.adaptiveStream:G={});const z=K.addSubscribedMediaTrack($,W,U,F,G);z?.isEncrypted&&!this.e2eeManager&&this.emit(RoomEvent.EncryptionError,new Error("Encrypted ".concat(z.source," track received from participant ").concat(K.sid,", but room does not have encryption enabled!")))}handleDisconnect(){let $=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0,U=arguments.length>1?arguments[1]:void 0;var F;if(this.clearConnectionReconcile(),this.isResuming=!1,this.bufferedEvents=[],this.transcriptionReceivedTimes.clear(),this.incomingDataStreamManager.clearHandlersAndControllers(),this.state!==ConnectionState.Disconnected){this.regionUrl=void 0;try{this.remoteParticipants.forEach(V=>{V.trackPublications.forEach(q=>{V.unpublishTrack(q.trackSid)})}),this.localParticipant.trackPublications.forEach(V=>{var q,j,W;V.track&&this.localParticipant.unpublishTrack(V.track,$),$?((q=V.track)===null||q===void 0||q.detach(),(j=V.track)===null||j===void 0||j.stop()):(W=V.track)===null||W===void 0||W.stopMonitor()}),this.localParticipant.off(ParticipantEvent.ParticipantMetadataChanged,this.onLocalParticipantMetadataChanged).off(ParticipantEvent.ParticipantNameChanged,this.onLocalParticipantNameChanged).off(ParticipantEvent.AttributesChanged,this.onLocalAttributesChanged).off(ParticipantEvent.TrackMuted,this.onLocalTrackMuted).off(ParticipantEvent.TrackUnmuted,this.onLocalTrackUnmuted).off(ParticipantEvent.LocalTrackPublished,this.onLocalTrackPublished).off(ParticipantEvent.LocalTrackUnpublished,this.onLocalTrackUnpublished).off(ParticipantEvent.ConnectionQualityChanged,this.onLocalConnectionQualityChanged).off(ParticipantEvent.MediaDevicesError,this.onMediaDevicesError).off(ParticipantEvent.AudioStreamAcquired,this.startAudio).off(ParticipantEvent.ChatMessage,this.onLocalChatMessageSent).off(ParticipantEvent.ParticipantPermissionsChanged,this.onLocalParticipantPermissionsChanged),this.localParticipant.trackPublications.clear(),this.localParticipant.videoTrackPublications.clear(),this.localParticipant.audioTrackPublications.clear(),this.remoteParticipants.clear(),this.sidToIdentity.clear(),this.activeSpeakers=[],this.audioContext&&typeof this.options.webAudioMix=="boolean"&&(this.audioContext.close(),this.audioContext=void 0),isWeb()&&(window.removeEventListener("beforeunload",this.onPageLeave),window.removeEventListener("pagehide",this.onPageLeave),window.removeEventListener("freeze",this.onPageLeave),(F=navigator.mediaDevices)===null||F===void 0||F.removeEventListener("devicechange",this.handleDeviceChange))}finally{this.setAndEmitConnectionState(ConnectionState.Disconnected),this.emit(RoomEvent.Disconnected,U)}}}handleParticipantDisconnected($,U){var F;this.remoteParticipants.delete($),U&&(this.incomingDataStreamManager.validateParticipantHasNoActiveDataStreams($),U.trackPublications.forEach(V=>{U.unpublishTrack(V.trackSid,!0)}),this.emit(RoomEvent.ParticipantDisconnected,U),U.setDisconnected(),(F=this.localParticipant)===null||F===void 0||F.handleParticipantDisconnected(U.identity))}handleIncomingRpcRequest($,U,F,V,q,j){return __awaiter(this,void 0,void 0,function*(){if(yield this.engine.publishRpcAck($,U),j!==1){yield this.engine.publishRpcResponse($,U,null,RpcError.builtIn("UNSUPPORTED_VERSION"));return}const W=this.rpcHandlers.get(F);if(!W){yield this.engine.publishRpcResponse($,U,null,RpcError.builtIn("UNSUPPORTED_METHOD"));return}let K=null,G=null;try{const z=yield W({requestId:U,callerIdentity:$,payload:V,responseTimeout:q});byteLength(z)>MAX_PAYLOAD_BYTES?(K=RpcError.builtIn("RESPONSE_PAYLOAD_TOO_LARGE"),console.warn("RPC Response payload too large for ".concat(F))):G=z}catch(z){z instanceof RpcError?K=z:(console.warn("Uncaught error returned by RPC handler for ".concat(F,". Returning APPLICATION_ERROR instead."),z),K=RpcError.builtIn("APPLICATION_ERROR"))}yield this.engine.publishRpcResponse($,U,G,K)})}selectDefaultDevices(){return __awaiter(this,void 0,void 0,function*(){var $,U,F;const V=DeviceManager.getInstance().previousDevices,q=yield DeviceManager.getInstance().getDevices(void 0,!1),j=getBrowser();if(j?.name==="Chrome"&&j.os!=="iOS")for(let K of q){const G=V.find(z=>z.deviceId===K.deviceId);G&&G.label!==""&&G.kind===K.kind&&G.label!==K.label&&this.getActiveDevice(K.kind)==="default"&&this.emit(RoomEvent.ActiveDeviceChanged,K.kind,K.deviceId)}const W=["audiooutput","audioinput","videoinput"];for(let K of W){const G=kindToSource(K),z=this.localParticipant.getTrackPublication(G);if(z&&(!(($=z.track)===null||$===void 0)&&$.isUserProvided))continue;const H=q.filter(Y=>Y.kind===K),Q=this.getActiveDevice(K);if(Q===((U=V.filter(Y=>Y.kind===K)[0])===null||U===void 0?void 0:U.deviceId)&&H.length>0&&((F=H[0])===null||F===void 0?void 0:F.deviceId)!==Q){yield this.switchActiveDevice(K,H[0].deviceId);continue}K==="audioinput"&&!isSafariBased()||K==="videoinput"||H.length>0&&!H.find(Y=>Y.deviceId===this.getActiveDevice(K))&&(K!=="audiooutput"||!isSafariBased())&&(yield this.switchActiveDevice(K,H[0].deviceId))}})}acquireAudioContext(){return __awaiter(this,void 0,void 0,function*(){var $,U;if(typeof this.options.webAudioMix!="boolean"&&this.options.webAudioMix.audioContext?this.audioContext=this.options.webAudioMix.audioContext:(!this.audioContext||this.audioContext.state==="closed")&&(this.audioContext=($=getNewAudioContext())!==null&&$!==void 0?$:void 0),this.options.webAudioMix&&this.remoteParticipants.forEach(V=>V.setAudioContext(this.audioContext)),this.localParticipant.setAudioContext(this.audioContext),this.audioContext&&this.audioContext.state==="suspended")try{yield Promise.race([this.audioContext.resume(),sleep(200)])}catch(V){this.log.warn("Could not resume audio context",Object.assign(Object.assign({},this.logContext),{error:V}))}const F=((U=this.audioContext)===null||U===void 0?void 0:U.state)==="running";F!==this.canPlaybackAudio&&(this.audioEnabled=F,this.emit(RoomEvent.AudioPlaybackStatusChanged,F))})}createParticipant($,U){var F;let V;return U?V=RemoteParticipant.fromParticipantInfo(this.engine.client,U,{loggerContextCb:()=>this.logContext,loggerName:this.options.loggerName}):V=new RemoteParticipant(this.engine.client,"",$,void 0,void 0,void 0,{loggerContextCb:()=>this.logContext,loggerName:this.options.loggerName}),this.options.webAudioMix&&V.setAudioContext(this.audioContext),!((F=this.options.audioOutput)===null||F===void 0)&&F.deviceId&&V.setAudioOutput(this.options.audioOutput).catch(q=>this.log.warn("Could not set audio output: ".concat(q.message),this.logContext)),V}getOrCreateParticipant($,U){if(this.remoteParticipants.has($)){const V=this.remoteParticipants.get($);return U&&V.updateInfo(U)&&this.sidToIdentity.set(U.sid,U.identity),V}const F=this.createParticipant($,U);return this.remoteParticipants.set($,F),this.sidToIdentity.set(U.sid,U.identity),this.emitWhenConnected(RoomEvent.ParticipantConnected,F),F.on(ParticipantEvent.TrackPublished,V=>{this.emitWhenConnected(RoomEvent.TrackPublished,V,F)}).on(ParticipantEvent.TrackSubscribed,(V,q)=>{V.kind===Track.Kind.Audio?(V.on(TrackEvent.AudioPlaybackStarted,this.handleAudioPlaybackStarted),V.on(TrackEvent.AudioPlaybackFailed,this.handleAudioPlaybackFailed)):V.kind===Track.Kind.Video&&(V.on(TrackEvent.VideoPlaybackFailed,this.handleVideoPlaybackFailed),V.on(TrackEvent.VideoPlaybackStarted,this.handleVideoPlaybackStarted)),this.emit(RoomEvent.TrackSubscribed,V,q,F)}).on(ParticipantEvent.TrackUnpublished,V=>{this.emit(RoomEvent.TrackUnpublished,V,F)}).on(ParticipantEvent.TrackUnsubscribed,(V,q)=>{this.emit(RoomEvent.TrackUnsubscribed,V,q,F)}).on(ParticipantEvent.TrackMuted,V=>{this.emitWhenConnected(RoomEvent.TrackMuted,V,F)}).on(ParticipantEvent.TrackUnmuted,V=>{this.emitWhenConnected(RoomEvent.TrackUnmuted,V,F)}).on(ParticipantEvent.ParticipantMetadataChanged,V=>{this.emitWhenConnected(RoomEvent.ParticipantMetadataChanged,V,F)}).on(ParticipantEvent.ParticipantNameChanged,V=>{this.emitWhenConnected(RoomEvent.ParticipantNameChanged,V,F)}).on(ParticipantEvent.AttributesChanged,V=>{this.emitWhenConnected(RoomEvent.ParticipantAttributesChanged,V,F)}).on(ParticipantEvent.ConnectionQualityChanged,V=>{this.emitWhenConnected(RoomEvent.ConnectionQualityChanged,V,F)}).on(ParticipantEvent.ParticipantPermissionsChanged,V=>{this.emitWhenConnected(RoomEvent.ParticipantPermissionsChanged,V,F)}).on(ParticipantEvent.TrackSubscriptionStatusChanged,(V,q)=>{this.emitWhenConnected(RoomEvent.TrackSubscriptionStatusChanged,V,q,F)}).on(ParticipantEvent.TrackSubscriptionFailed,(V,q)=>{this.emit(RoomEvent.TrackSubscriptionFailed,V,F,q)}).on(ParticipantEvent.TrackSubscriptionPermissionChanged,(V,q)=>{this.emitWhenConnected(RoomEvent.TrackSubscriptionPermissionChanged,V,q,F)}).on(ParticipantEvent.Active,()=>{this.emitWhenConnected(RoomEvent.ParticipantActive,F),F.kind===ParticipantInfo_Kind.AGENT&&this.localParticipant.setActiveAgent(F)}),U&&F.updateInfo(U),F}sendSyncState(){const $=Array.from(this.remoteParticipants.values()).reduce((F,V)=>(F.push(...V.getTrackPublications()),F),[]),U=this.localParticipant.getTrackPublications();this.engine.sendSyncState($,U)}updateSubscriptions(){for(const $ of this.remoteParticipants.values())for(const U of $.videoTrackPublications.values())U.isSubscribed&&isRemotePub(U)&&U.emitTrackUpdate()}getRemoteParticipantBySid($){const U=this.sidToIdentity.get($);if(U)return this.remoteParticipants.get(U)}registerConnectionReconcile(){this.clearConnectionReconcile();let $=0;this.connectionReconcileInterval=CriticalTimers.setInterval(()=>{!this.engine||this.engine.isClosed||!this.engine.verifyTransport()?($++,this.log.warn("detected connection state mismatch",Object.assign(Object.assign({},this.logContext),{numFailures:$,engine:this.engine?{closed:this.engine.isClosed,transportsConnected:this.engine.verifyTransport()}:void 0})),$>=3&&(this.recreateEngine(),this.handleDisconnect(this.options.stopLocalTrackOnUnpublish,DisconnectReason.STATE_MISMATCH))):$=0},connectionReconcileFrequency)}clearConnectionReconcile(){this.connectionReconcileInterval&&CriticalTimers.clearInterval(this.connectionReconcileInterval)}setAndEmitConnectionState($){return $===this.state?!1:(this.state=$,this.emit(RoomEvent.ConnectionStateChanged,this.state),!0)}emitBufferedEvents(){this.bufferedEvents.forEach($=>{let[U,F]=$;this.emit(U,...F)}),this.bufferedEvents=[]}emitWhenConnected($){for(var U=arguments.length,F=new Array(U>1?U-1:0),V=1;V<U;V++)F[V-1]=arguments[V];if(this.state===ConnectionState.Reconnecting||this.isResuming||!this.engine||this.engine.pendingReconnect)this.bufferedEvents.push([$,F]);else if(this.state===ConnectionState.Connected)return this.emit($,...F);return!1}simulateParticipants($){return __awaiter(this,void 0,void 0,function*(){var U,F;const V=Object.assign({audio:!0,video:!0,useRealTracks:!1},$.publish),q=Object.assign({count:9,audio:!1,video:!0,aspectRatios:[1.66,1.7,1.3]},$.participants);if(this.handleDisconnect(),this.roomInfo=new Room$1({sid:"RM_SIMULATED",name:"simulated-room",emptyTimeout:0,maxParticipants:0,creationTime:protoInt64.parse(new Date().getTime()),metadata:"",numParticipants:1,numPublishers:1,turnPassword:"",enabledCodecs:[],activeRecording:!1}),this.localParticipant.updateInfo(new ParticipantInfo({identity:"simulated-local",name:"local-name"})),this.setupLocalParticipantEvents(),this.emit(RoomEvent.SignalConnected),this.emit(RoomEvent.Connected),this.setAndEmitConnectionState(ConnectionState.Connected),V.video){const j=new LocalTrackPublication(Track.Kind.Video,new TrackInfo({source:TrackSource.CAMERA,sid:Math.floor(Math.random()*1e4).toString(),type:TrackType.AUDIO,name:"video-dummy"}),new LocalVideoTrack(V.useRealTracks?(yield window.navigator.mediaDevices.getUserMedia({video:!0})).getVideoTracks()[0]:createDummyVideoStreamTrack(160*((U=q.aspectRatios[0])!==null&&U!==void 0?U:1),160,!0,!0),void 0,!1,{loggerName:this.options.loggerName,loggerContextCb:()=>this.logContext}),{loggerName:this.options.loggerName,loggerContextCb:()=>this.logContext});this.localParticipant.addTrackPublication(j),this.localParticipant.emit(ParticipantEvent.LocalTrackPublished,j)}if(V.audio){const j=new LocalTrackPublication(Track.Kind.Audio,new TrackInfo({source:TrackSource.MICROPHONE,sid:Math.floor(Math.random()*1e4).toString(),type:TrackType.AUDIO}),new LocalAudioTrack(V.useRealTracks?(yield navigator.mediaDevices.getUserMedia({audio:!0})).getAudioTracks()[0]:getEmptyAudioStreamTrack(),void 0,!1,this.audioContext,{loggerName:this.options.loggerName,loggerContextCb:()=>this.logContext}),{loggerName:this.options.loggerName,loggerContextCb:()=>this.logContext});this.localParticipant.addTrackPublication(j),this.localParticipant.emit(ParticipantEvent.LocalTrackPublished,j)}for(let j=0;j<q.count-1;j+=1){let W=new ParticipantInfo({sid:Math.floor(Math.random()*1e4).toString(),identity:"simulated-".concat(j),state:ParticipantInfo_State.ACTIVE,tracks:[],joinedAt:protoInt64.parse(Date.now())});const K=this.getOrCreateParticipant(W.identity,W);if(q.video){const G=createDummyVideoStreamTrack(160*((F=q.aspectRatios[j%q.aspectRatios.length])!==null&&F!==void 0?F:1),160,!1,!0),z=new TrackInfo({source:TrackSource.CAMERA,sid:Math.floor(Math.random()*1e4).toString(),type:TrackType.AUDIO});K.addSubscribedMediaTrack(G,z.sid,new MediaStream([G]),new RTCRtpReceiver),W.tracks=[...W.tracks,z]}if(q.audio){const G=getEmptyAudioStreamTrack(),z=new TrackInfo({source:TrackSource.MICROPHONE,sid:Math.floor(Math.random()*1e4).toString(),type:TrackType.AUDIO});K.addSubscribedMediaTrack(G,z.sid,new MediaStream([G]),new RTCRtpReceiver),W.tracks=[...W.tracks,z]}K.updateInfo(W)}})}emit($){for(var U=arguments.length,F=new Array(U>1?U-1:0),V=1;V<U;V++)F[V-1]=arguments[V];if($!==RoomEvent.ActiveSpeakersChanged&&$!==RoomEvent.TranscriptionReceived){const q=mapArgs(F).filter(j=>j!==void 0);this.log.debug("room event ".concat($),Object.assign(Object.assign({},this.logContext),{event:$,args:q}))}return super.emit($,...F)}}Room.cleanupRegistry=typeof FinalizationRegistry<"u"&&new FinalizationRegistry(B=>{B()});function mapArgs(B){return B.map($=>{if($)return Array.isArray($)?mapArgs($):typeof $=="object"?"logContext"in $?$.logContext:void 0:$})}var CheckStatus;(function(B){B[B.IDLE=0]="IDLE",B[B.RUNNING=1]="RUNNING",B[B.SKIPPED=2]="SKIPPED",B[B.SUCCESS=3]="SUCCESS",B[B.FAILED=4]="FAILED"})(CheckStatus||(CheckStatus={}));class Checker extends eventsExports.EventEmitter{constructor($,U){let F=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};super(),this.status=CheckStatus.IDLE,this.logs=[],this.options={},this.url=$,this.token=U,this.name=this.constructor.name,this.room=new Room(F.roomOptions),this.connectOptions=F.connectOptions,this.options=F}run($){return __awaiter(this,void 0,void 0,function*(){if(this.status!==CheckStatus.IDLE)throw Error("check is running already");this.setStatus(CheckStatus.RUNNING);try{yield this.perform()}catch(U){U instanceof Error&&(this.options.errorsAsWarnings?this.appendWarning(U.message):this.appendError(U.message))}return yield this.disconnect(),yield new Promise(U=>setTimeout(U,500)),this.status!==CheckStatus.SKIPPED&&this.setStatus(this.isSuccess()?CheckStatus.SUCCESS:CheckStatus.FAILED),$&&$(),this.getInfo()})}isSuccess(){return!this.logs.some($=>$.level==="error")}connect($){return __awaiter(this,void 0,void 0,function*(){return this.room.state===ConnectionState.Connected?this.room:($||($=this.url),yield this.room.connect($,this.token,this.connectOptions),this.room)})}disconnect(){return __awaiter(this,void 0,void 0,function*(){this.room&&this.room.state!==ConnectionState.Disconnected&&(yield this.room.disconnect(),yield new Promise($=>setTimeout($,500)))})}skip(){this.setStatus(CheckStatus.SKIPPED)}switchProtocol($){return __awaiter(this,void 0,void 0,function*(){let U=!1,F=!1;if(this.room.on(RoomEvent.Reconnecting,()=>{U=!0}),this.room.once(RoomEvent.Reconnected,()=>{F=!0}),this.room.simulateScenario("force-".concat($)),yield new Promise(q=>setTimeout(q,1e3)),!U)return;const V=Date.now()+1e4;for(;Date.now()<V;){if(F)return;yield sleep(100)}throw new Error("Could not reconnect using ".concat($," protocol after 10 seconds"))})}appendMessage($){this.logs.push({level:"info",message:$}),this.emit("update",this.getInfo())}appendWarning($){this.logs.push({level:"warning",message:$}),this.emit("update",this.getInfo())}appendError($){this.logs.push({level:"error",message:$}),this.emit("update",this.getInfo())}setStatus($){this.status=$,this.emit("update",this.getInfo())}get engine(){var $;return($=this.room)===null||$===void 0?void 0:$.engine}getInfo(){return{logs:this.logs,name:this.name,status:this.status,description:this.description}}}class CloudRegionCheck extends Checker{get description(){return"Cloud regions"}perform(){return __awaiter(this,void 0,void 0,function*(){const $=new RegionUrlProvider(this.url,this.token);if(!$.isCloud()){this.skip();return}const U=[],F=new Set;for(let q=0;q<3;q++){const j=yield $.getNextBestRegionUrl();if(!j)break;if(F.has(j))continue;F.add(j);const W=yield this.checkCloudRegion(j);this.appendMessage("".concat(W.region," RTT: ").concat(W.rtt,"ms, duration: ").concat(W.duration,"ms")),U.push(W)}U.sort((q,j)=>(q.duration-j.duration)*.5+(q.rtt-j.rtt)*.5);const V=U[0];this.bestStats=V,this.appendMessage("best Cloud region: ".concat(V.region))})}getInfo(){const $=super.getInfo();return $.data=this.bestStats,$}checkCloudRegion($){return __awaiter(this,void 0,void 0,function*(){var U,F;yield this.connect($),this.options.protocol==="tcp"&&(yield this.switchProtocol("tcp"));const V=(U=this.room.serverInfo)===null||U===void 0?void 0:U.region;if(!V)throw new Error("Region not found");const q=yield this.room.localParticipant.streamText({topic:"test"}),j=1e3,K=1e6/j,G="A".repeat(j),z=Date.now();for(let X=0;X<K;X++)yield q.write(G);yield q.close();const H=Date.now(),Q=yield(F=this.room.engine.pcManager)===null||F===void 0?void 0:F.publisher.getStats(),Y={region:V,rtt:1e4,duration:H-z};return Q?.forEach(X=>{X.type==="candidate-pair"&&X.nominated&&(Y.rtt=X.currentRoundTripTime*1e3)}),yield this.disconnect(),Y})}}const TEST_DURATION=1e4;class ConnectionProtocolCheck extends Checker{get description(){return"Connection via UDP vs TCP"}perform(){return __awaiter(this,void 0,void 0,function*(){const $=yield this.checkConnectionProtocol("udp"),U=yield this.checkConnectionProtocol("tcp");this.bestStats=$,$.qualityLimitationDurations.bandwidth-U.qualityLimitationDurations.bandwidth>.5||($.packetsLost-U.packetsLost)/$.packetsSent>.01?(this.appendMessage("best connection quality via tcp"),this.bestStats=U):this.appendMessage("best connection quality via udp");const F=this.bestStats;this.appendMessage("upstream bitrate: ".concat((F.bitrateTotal/F.count/1e3/1e3).toFixed(2)," mbps")),this.appendMessage("RTT: ".concat((F.rttTotal/F.count*1e3).toFixed(2)," ms")),this.appendMessage("jitter: ".concat((F.jitterTotal/F.count*1e3).toFixed(2)," ms")),F.packetsLost>0&&this.appendWarning("packets lost: ".concat((F.packetsLost/F.packetsSent*100).toFixed(2),"%")),F.qualityLimitationDurations.bandwidth>1&&this.appendWarning("bandwidth limited ".concat((F.qualityLimitationDurations.bandwidth/(TEST_DURATION/1e3)*100).toFixed(2),"%")),F.qualityLimitationDurations.cpu>0&&this.appendWarning("cpu limited ".concat((F.qualityLimitationDurations.cpu/(TEST_DURATION/1e3)*100).toFixed(2),"%"))})}getInfo(){const $=super.getInfo();return $.data=this.bestStats,$}checkConnectionProtocol($){return __awaiter(this,void 0,void 0,function*(){yield this.connect(),$==="tcp"?yield this.switchProtocol("tcp"):yield this.switchProtocol("udp");const U=document.createElement("canvas");U.width=1280,U.height=720;const F=U.getContext("2d");if(!F)throw new Error("Could not get canvas context");let V=0;const q=()=>{V=(V+1)%360,F.fillStyle="hsl(".concat(V,", 100%, 50%)"),F.fillRect(0,0,U.width,U.height),requestAnimationFrame(q)};q();const W=U.captureStream(30).getVideoTracks()[0],G=(yield this.room.localParticipant.publishTrack(W,{simulcast:!1,degradationPreference:"maintain-resolution",videoEncoding:{maxBitrate:2e6}})).track,z={protocol:$,packetsLost:0,packetsSent:0,qualityLimitationDurations:{},rttTotal:0,jitterTotal:0,bitrateTotal:0,count:0},H=setInterval(()=>__awaiter(this,void 0,void 0,function*(){const Q=yield G.getRTCStatsReport();Q?.forEach(Y=>{Y.type==="outbound-rtp"?(z.packetsSent=Y.packetsSent,z.qualityLimitationDurations=Y.qualityLimitationDurations,z.bitrateTotal+=Y.targetBitrate,z.count++):Y.type==="remote-inbound-rtp"&&(z.packetsLost=Y.packetsLost,z.rttTotal+=Y.roundTripTime,z.jitterTotal+=Y.jitter)})}),1e3);return yield new Promise(Q=>setTimeout(Q,TEST_DURATION)),clearInterval(H),W.stop(),U.remove(),yield this.disconnect(),z})}}class PublishAudioCheck extends Checker{get description(){return"Can publish audio"}perform(){return __awaiter(this,void 0,void 0,function*(){var $;const U=yield this.connect(),F=yield createLocalAudioTrack();if(yield detectSilence(F,1e3))throw new Error("unable to detect audio from microphone");this.appendMessage("detected audio from microphone"),U.localParticipant.publishTrack(F),yield new Promise(W=>setTimeout(W,3e3));const q=yield($=F.sender)===null||$===void 0?void 0:$.getStats();if(!q)throw new Error("Could not get RTCStats");let j=0;if(q.forEach(W=>{W.type==="outbound-rtp"&&(W.kind==="audio"||!W.kind&&W.mediaType==="audio")&&(j=W.packetsSent)}),j===0)throw new Error("Could not determine packets are sent");this.appendMessage("published ".concat(j," audio packets"))})}}class PublishVideoCheck extends Checker{get description(){return"Can publish video"}perform(){return __awaiter(this,void 0,void 0,function*(){var $;const U=yield this.connect(),F=yield createLocalVideoTrack();yield this.checkForVideo(F.mediaStreamTrack),U.localParticipant.publishTrack(F),yield new Promise(j=>setTimeout(j,5e3));const V=yield($=F.sender)===null||$===void 0?void 0:$.getStats();if(!V)throw new Error("Could not get RTCStats");let q=0;if(V.forEach(j=>{j.type==="outbound-rtp"&&(j.kind==="video"||!j.kind&&j.mediaType==="video")&&(q+=j.packetsSent)}),q===0)throw new Error("Could not determine packets are sent");this.appendMessage("published ".concat(q," video packets"))})}checkForVideo($){return __awaiter(this,void 0,void 0,function*(){const U=new MediaStream;U.addTrack($.clone());const F=document.createElement("video");F.srcObject=U,F.muted=!0,yield new Promise(V=>{F.onplay=()=>{setTimeout(()=>{var q,j,W,K;const G=document.createElement("canvas"),z=$.getSettings(),H=(j=(q=z.width)!==null&&q!==void 0?q:F.videoWidth)!==null&&j!==void 0?j:1280,Q=(K=(W=z.height)!==null&&W!==void 0?W:F.videoHeight)!==null&&K!==void 0?K:720;G.width=H,G.height=Q;const Y=G.getContext("2d");Y.drawImage(F,0,0);const Z=Y.getImageData(0,0,G.width,G.height).data;let ne=!0;for(let ee=0;ee<Z.length;ee+=4)if(Z[ee]!==0||Z[ee+1]!==0||Z[ee+2]!==0){ne=!1;break}ne?this.appendError("camera appears to be producing only black frames"):this.appendMessage("received video frames"),V()},1e3)},F.play()}),U.getTracks().forEach(V=>V.stop()),F.remove()})}}class ReconnectCheck extends Checker{get description(){return"Resuming connection after interruption"}perform(){return __awaiter(this,void 0,void 0,function*(){var $;const U=yield this.connect();let F=!1,V=!1,q;const j=new Promise(G=>{setTimeout(G,5e3),q=G}),W=()=>{F=!0};U.on(RoomEvent.SignalReconnecting,W).on(RoomEvent.Reconnecting,W).on(RoomEvent.Reconnected,()=>{V=!0,q(!0)}),($=U.engine.client.ws)===null||$===void 0||$.close();const K=U.engine.client.onClose;if(K&&K(""),yield j,F){if(!V||U.state!==ConnectionState.Connected)throw this.appendWarning("reconnection is only possible in Redis-based configurations"),new Error("Not able to reconnect")}else throw new Error("Did not attempt to reconnect")})}}class TURNCheck extends Checker{get description(){return"Can connect via TURN"}perform(){return __awaiter(this,void 0,void 0,function*(){var $,U;const F=new SignalClient,V=yield F.join(this.url,this.token,{autoSubscribe:!0,maxRetries:0,e2eeEnabled:!1,websocketTimeout:15e3});let q=!1,j=!1,W=!1;for(let K of V.iceServers)for(let G of K.urls)G.startsWith("turn:")?(j=!0,W=!0):G.startsWith("turns:")&&(j=!0,W=!0,q=!0),G.startsWith("stun:")&&(W=!0);W?j&&!q&&this.appendWarning("TURN is configured server side, but TURN/TLS is unavailable."):this.appendWarning("No STUN servers configured on server side."),yield F.close(),!((U=($=this.connectOptions)===null||$===void 0?void 0:$.rtcConfig)===null||U===void 0)&&U.iceServers||j?yield this.room.connect(this.url,this.token,{rtcConfig:{iceTransportPolicy:"relay"}}):(this.appendWarning("No TURN servers configured."),this.skip(),yield new Promise(K=>setTimeout(K,0)))})}}class WebRTCCheck extends Checker{get description(){return"Establishing WebRTC connection"}perform(){return __awaiter(this,void 0,void 0,function*(){let $=!1,U=!1;this.room.on(RoomEvent.SignalConnected,()=>{const F=this.room.engine.client.onTrickle;this.room.engine.client.onTrickle=(V,q)=>{if(V.candidate){const j=new RTCIceCandidate(V);let W="".concat(j.protocol," ").concat(j.address,":").concat(j.port," ").concat(j.type);j.address&&(isIPPrivate(j.address)?W+=" (private)":j.protocol==="tcp"&&j.tcpType==="passive"?($=!0,W+=" (passive)"):j.protocol==="udp"&&(U=!0)),this.appendMessage(W)}F&&F(V,q)},this.room.engine.pcManager&&(this.room.engine.pcManager.subscriber.onIceCandidateError=V=>{V instanceof RTCPeerConnectionIceErrorEvent&&this.appendWarning("error with ICE candidate: ".concat(V.errorCode," ").concat(V.errorText," ").concat(V.url))})});try{yield this.connect(),livekitLogger.info("now the room is connected")}catch(F){throw this.appendWarning("ports need to be open on firewall in order to connect."),F}$||this.appendWarning("Server is not configured for ICE/TCP"),U||this.appendWarning("No public IPv4 UDP candidates were found. Your server is likely not configured correctly")})}}function isIPPrivate(B){const $=B.split(".");if($.length===4){if($[0]==="10")return!0;if($[0]==="192"&&$[1]==="168")return!0;if($[0]==="172"){const U=parseInt($[1],10);if(U>=16&&U<=31)return!0}}return!1}class WebSocketCheck extends Checker{get description(){return"Connecting to signal connection via WebSocket"}perform(){return __awaiter(this,void 0,void 0,function*(){var $,U,F;(this.url.startsWith("ws:")||this.url.startsWith("http:"))&&this.appendWarning("Server is insecure, clients may block connections to it");let V=new SignalClient;const q=yield V.join(this.url,this.token,{autoSubscribe:!0,maxRetries:0,e2eeEnabled:!1,websocketTimeout:15e3});this.appendMessage("Connected to server, version ".concat(q.serverVersion,".")),(($=q.serverInfo)===null||$===void 0?void 0:$.edition)===ServerInfo_Edition.Cloud&&(!((U=q.serverInfo)===null||U===void 0)&&U.region)&&this.appendMessage("LiveKit Cloud: ".concat((F=q.serverInfo)===null||F===void 0?void 0:F.region)),yield V.close()})}}class ConnectionCheck extends eventsExports.EventEmitter{constructor($,U){let F=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};super(),this.options={},this.checkResults=new Map,this.url=$,this.token=U,this.options=F}getNextCheckId(){const $=this.checkResults.size;return this.checkResults.set($,{logs:[],status:CheckStatus.IDLE,name:"",description:""}),$}updateCheck($,U){this.checkResults.set($,U),this.emit("checkUpdate",$,U)}isSuccess(){return Array.from(this.checkResults.values()).every($=>$.status!==CheckStatus.FAILED)}getResults(){return Array.from(this.checkResults.values())}createAndRunCheck($){return __awaiter(this,void 0,void 0,function*(){const U=this.getNextCheckId(),F=new $(this.url,this.token,this.options),V=j=>{this.updateCheck(U,j)};F.on("update",V);const q=yield F.run();return F.off("update",V),q})}checkWebsocket(){return __awaiter(this,void 0,void 0,function*(){return this.createAndRunCheck(WebSocketCheck)})}checkWebRTC(){return __awaiter(this,void 0,void 0,function*(){return this.createAndRunCheck(WebRTCCheck)})}checkTURN(){return __awaiter(this,void 0,void 0,function*(){return this.createAndRunCheck(TURNCheck)})}checkReconnect(){return __awaiter(this,void 0,void 0,function*(){return this.createAndRunCheck(ReconnectCheck)})}checkPublishAudio(){return __awaiter(this,void 0,void 0,function*(){return this.createAndRunCheck(PublishAudioCheck)})}checkPublishVideo(){return __awaiter(this,void 0,void 0,function*(){return this.createAndRunCheck(PublishVideoCheck)})}checkConnectionProtocol(){return __awaiter(this,void 0,void 0,function*(){const $=yield this.createAndRunCheck(ConnectionProtocolCheck);if($.data&&"protocol"in $.data){const U=$.data;this.options.protocol=U.protocol}return $})}checkCloudRegion(){return __awaiter(this,void 0,void 0,function*(){return this.createAndRunCheck(CloudRegionCheck)})}}window.HeyGenPlayer={create:async({token:B,avatarName:$,kbId:U,container:F})=>{const V=new StreamingAvatar({token:B});return await V.createStartAvatar({avatarName:$,knowledgeId:U,voiceChatTransport:VoiceChatTransport.LIVEKIT}),V.on("stream_ready",q=>{const j=q.detail,W=document.createElement("video");W.autoplay=!0,W.srcObject=j,F.appendChild(W)}),V}}}));
