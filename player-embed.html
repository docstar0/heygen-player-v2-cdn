<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>HeyGen Player Embed</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    #playerContainer { width: 640px; height: 360px; border: 1px solid #ccc; }
  </style>
</head>
<body>
  <h2>HeyGen Player Embed Test</h2>
  <div id="playerContainer"></div>
  <p id="status">Waiting for sessionâ€¦</p>

  <!-- âœ… Load your UMD bundle -->
  <script src="https://docstar0.github.io/heygen-player-v3-cdn/dist/heygen-player-v3.umd.js"></script>

  <script>
    console.log("[embed] Bootingâ€¦");
    console.log("[debug] window.HeyGenPlayer =", window.HeyGenPlayer);

    const container = document.getElementById("playerContainer");
    const status = document.getElementById("status");

    // ğŸ”‘ Listen for messages from Wix page
    window.addEventListener("message", async (event) => {
      const { token, avatarId, kbId, sessionId, rtcUrl } = event.data;
      console.log("[embed] ğŸ“© received from Wix:", event.data);

      try {
        if (!window.HeyGenPlayer) {
          throw new Error("window.HeyGenPlayer is undefined. UMD did not load properly.");
        }

        let player;

        // Case A: full LiveKit session provided (v2/v3)
        if (sessionId && rtcUrl) {
          console.log("[embed] ğŸš€ creating player with session + rtcUrlâ€¦");
          player = await window.HeyGenPlayer.create({
            token,
            avatarId,
            kbId,
            sessionId,
            rtcUrl,
            container,
          });
        } 
        // Case B: simple token-only flow (SDK handles newSession)
        else if (token) {
          console.log("[embed] ğŸš€ creating player with token onlyâ€¦");
          player = await window.HeyGenPlayer.create({
            token,
            avatarId,
            kbId,
            container,
          });
        } else {
          throw new Error("No token/session info provided from Wix");
        }

        console.log("[embed] ğŸ‰ player created:", player);
        status.textContent = "Player created successfully!";

        // Start avatar
        await player.startAvatar();
        console.log("[embed] âœ… avatar started");
      } catch (err) {
        console.error("[embed] âŒ failed:", err);
        status.textContent = "Error: " + err.message;
      }
    });
  </script>
</body>
</html>
